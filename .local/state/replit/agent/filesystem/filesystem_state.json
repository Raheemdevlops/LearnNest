{"file_contents":{"utils/pdf_generator.py":{"content":"\"\"\"\nPDF Generator with Beautiful Design for LearnNest LMS\nGenerates professional, stylish PDF documents with LearnNest branding\nSupports Unicode languages: English, Arabic, Urdu, Sindhi, and more\n\"\"\"\n\nfrom reportlab.lib.pagesizes import letter, A4\nfrom reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle\nfrom reportlab.lib.units import inch\nfrom reportlab.lib.enums import TA_CENTER, TA_LEFT, TA_JUSTIFY, TA_RIGHT\nfrom reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, PageBreak, Table, TableStyle\nfrom reportlab.lib import colors\nfrom reportlab.pdfgen import canvas\nfrom reportlab.pdfbase import pdfmetrics\nfrom reportlab.pdfbase.ttfonts import TTFont\nfrom datetime import datetime\nimport os\n\n# Register Unicode fonts for multi-language support\ntry:\n    # Get the absolute path to fonts directory\n    FONTS_DIR = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'static', 'fonts')\n    \n    # Register Noto Sans (for Latin, numbers, symbols)\n    noto_sans_path = os.path.join(FONTS_DIR, 'NotoSans.ttf')\n    if os.path.exists(noto_sans_path):\n        pdfmetrics.registerFont(TTFont('NotoSans', noto_sans_path))\n    \n    # Register Noto Sans Arabic (for Arabic, Urdu, Sindhi)\n    noto_arabic_path = os.path.join(FONTS_DIR, 'NotoSansArabic.ttf')\n    if os.path.exists(noto_arabic_path):\n        pdfmetrics.registerFont(TTFont('NotoSansArabic', noto_arabic_path))\n    \n    UNICODE_FONTS_AVAILABLE = True\nexcept Exception as e:\n    print(f\"Warning: Could not register Unicode fonts: {e}\")\n    UNICODE_FONTS_AVAILABLE = False\n\ndef get_font_for_text(text):\n    \"\"\"\n    Detect if text contains Arabic/Urdu/Sindhi characters and return appropriate font\n    \"\"\"\n    if not UNICODE_FONTS_AVAILABLE:\n        return 'Helvetica'\n    \n    # Check for Arabic/Urdu/Sindhi characters (Unicode range)\n    for char in text:\n        if '\\u0600' <= char <= '\\u06FF' or '\\u0750' <= char <= '\\u077F':\n            return 'NotoSansArabic'\n    \n    # Default to NotoSans for better Unicode support (including math symbols)\n    return 'NotoSans'\n\n\nclass BeautifulWatermarkedCanvas(canvas.Canvas):\n    \"\"\"Custom canvas with beautiful LearnNest branding and watermark\"\"\"\n    \n    def __init__(self, *args, add_watermark=True, custom_watermark=None, **kwargs):\n        canvas.Canvas.__init__(self, *args, **kwargs)\n        self.pages = []\n        self.add_watermark = add_watermark\n        self.custom_watermark = custom_watermark\n        \n    def showPage(self):\n        self.pages.append(dict(self.__dict__))\n        self._startPage()\n        \n    def save(self):\n        page_count = len(self.pages)\n        for page_num, page in enumerate(self.pages, start=1):\n            self.__dict__.update(page)\n            self.draw_page_design(page_num, page_count)\n            canvas.Canvas.showPage(self)\n        canvas.Canvas.save(self)\n        \n    def draw_page_design(self, page_num, total_pages):\n        \"\"\"Draw beautiful page design with watermark and branding - Enhanced with modern design\"\"\"\n        page_width, page_height = letter\n        \n        # Save the state\n        self.saveState()\n        \n        # === ENHANCED WATERMARK (Diagonal) ===\n        if self.add_watermark:\n            watermark_font = 'NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica-Bold'\n            try:\n                self.setFont(watermark_font, 80)\n            except:\n                self.setFont('Helvetica-Bold', 80)\n            \n            # Blue watermark with transparency\n            self.setFillColor(colors.HexColor(\"#0A84FF\"), alpha=0.12)\n            self.translate(page_width / 2, page_height / 2)\n            self.rotate(48)\n            watermark_text = \"LearnNest\"\n            self.drawCentredString(0, 0, watermark_text)\n            self.restoreState()\n            self.saveState()\n        \n        # === CUSTOM WATERMARK (Diagonal) - Student's Personal Watermark ===\n        if self.custom_watermark:\n            watermark_font = 'NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica-Bold'\n            try:\n                self.setFont(watermark_font, 60)\n            except:\n                self.setFont('Helvetica-Bold', 60)\n            \n            # Student's custom watermark in white with transparency\n            self.setFillColor(colors.white, alpha=0.08)\n            self.translate(page_width / 2, page_height / 2 - 100)\n            self.rotate(48)\n            self.drawCentredString(0, 0, self.custom_watermark)\n            self.restoreState()\n            self.saveState()\n        \n        # === PREMIUM HEADER DESIGN ===\n        # Gradient-effect header (dark to light purple)\n        self.setFillColor(colors.HexColor(\"#1a0033\"))\n        self.rect(0, page_height - 0.18 * inch, page_width, 0.18 * inch, fill=1, stroke=0)\n        \n        # Accent line\n        self.setFillColor(colors.HexColor(\"#00d4ff\"))\n        self.rect(0, page_height - 0.2 * inch, page_width, 0.02 * inch, fill=1, stroke=0)\n        \n        # LearnNest branding with modern font\n        brand_font = 'NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica-Bold'\n        try:\n            self.setFont(brand_font, 16)\n        except:\n            self.setFont('Helvetica-Bold', 16)\n        self.setFillColor(colors.white)\n        self.drawString(0.75 * inch, page_height - 0.14 * inch, \"LearnNest\")\n        \n        # Tagline with sky blue accent\n        try:\n            self.setFont('NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica', 8)\n        except:\n            self.setFont('Helvetica', 8)\n        self.setFillColor(colors.HexColor(\"#00d4ff\"))\n        self.drawString(0.75 * inch, page_height - 0.32 * inch, \"Empowering Learning Through AI\")\n        \n        # === PREMIUM FOOTER DESIGN ===\n        # Footer gradient bar\n        self.setFillColor(colors.HexColor(\"#1a0033\"))\n        self.rect(0, 0, page_width, 0.55 * inch, fill=1, stroke=0)\n        \n        # Sky blue accent line\n        self.setFillColor(colors.HexColor(\"#00d4ff\"))\n        self.rect(0, 0.55 * inch, page_width, 0.02 * inch, fill=1, stroke=0)\n        \n        # Page number with modern styling\n        try:\n            self.setFont('NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica', 10)\n        except:\n            self.setFont('Helvetica', 10)\n        self.setFillColor(colors.white)\n        footer_text = f\"Page {page_num} of {total_pages}\"\n        self.drawCentredString(page_width / 2, 0.35 * inch, footer_text)\n        \n        # Copyright text with sky blue\n        try:\n            self.setFont('NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica', 7)\n        except:\n            self.setFont('Helvetica', 7)\n        self.setFillColor(colors.HexColor(\"#00d4ff\"))\n        self.drawCentredString(page_width / 2, 0.2 * inch, \"Â© LearnNest LMS - AI Generated Content\")\n\n\ndef generate_transcript_pdf(transcript_text, video_title, course_name, student_name, output_path, add_watermark=True, custom_watermark=None):\n    \"\"\"\n    Generate a stunning, professional PDF transcript with LearnNest branding and modern design\n    \n    Args:\n        transcript_text (str): The AI-generated transcript content\n        video_title (str): Title of the video\n        course_name (str): Name of the course\n        student_name (str): Name of the student downloading the transcript\n        output_path (str): Full path where the PDF should be saved\n        add_watermark (bool): Whether to add LearnNest watermark (default: True)\n    \n    Returns:\n        bool: True if successful, False otherwise\n    \"\"\"\n    try:\n        # Ensure directory exists\n        os.makedirs(os.path.dirname(output_path), exist_ok=True)\n        \n        # Create the PDF document with custom canvas and enhanced margins\n        doc = SimpleDocTemplate(\n            output_path,\n            pagesize=letter,\n            rightMargin=0.8*inch,\n            leftMargin=0.8*inch,\n            topMargin=1.0*inch,\n            bottomMargin=1.0*inch\n        )\n        \n        # Container for the 'Flowable' objects\n        story = []\n        \n        # Define custom styles\n        styles = getSampleStyleSheet()\n        \n        # Detect language for font selection\n        content_font = get_font_for_text(transcript_text + video_title)\n        \n        # === STUNNING TITLE STYLE ===\n        title_style = ParagraphStyle(\n            'BeautifulTitle',\n            parent=styles['Heading1'],\n            fontSize=28,\n            textColor=colors.HexColor(\"#1a0033\"),\n            spaceAfter=12,\n            spaceBefore=6,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=32,\n            borderPadding=12,\n            borderColor=colors.HexColor(\"#00d4ff\"),\n            borderWidth=0.5\n        )\n        \n        # === MODERN SUBTITLE STYLE ===\n        subtitle_style = ParagraphStyle(\n            'SubtitleStyle',\n            parent=styles['Normal'],\n            fontSize=13,\n            textColor=colors.HexColor(\"#555555\"),\n            spaceAfter=24,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=16\n        )\n        \n        # === INFO BOX STYLE ===\n        info_label_style = ParagraphStyle(\n            'InfoLabel',\n            parent=styles['Normal'],\n            fontSize=10,\n            textColor=colors.HexColor(\"#00d4ff\"),\n            fontName=content_font,\n            spaceAfter=2\n        )\n        \n        info_value_style = ParagraphStyle(\n            'InfoValue',\n            parent=styles['Normal'],\n            fontSize=11,\n            textColor=colors.HexColor(\"#1a0033\"),\n            fontName=content_font,\n            spaceAfter=8\n        )\n        \n        # === VVIP PROFESSIONAL HEADING STYLE (CENTERED) ===\n        heading_style = ParagraphStyle(\n            'VVIPHeading',\n            parent=styles['Heading2'],\n            fontSize=16,\n            textColor=colors.HexColor(\"#FFFFFF\"),\n            spaceAfter=16,\n            spaceBefore=20,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            borderPadding=12,\n            borderColor=colors.HexColor(\"#0A84FF\"),\n            borderWidth=2,\n            backColor=colors.HexColor(\"#1a0033\"),\n            leading=20,\n            borderRadius=8\n        )\n        \n        # === PREMIUM BODY STYLE ===\n        body_style = ParagraphStyle(\n            'BeautifulBody',\n            parent=styles['BodyText'],\n            fontSize=10.5,\n            alignment=TA_JUSTIFY,\n            spaceAfter=12,\n            leading=20,\n            textColor=colors.HexColor(\"#1a1a1a\"),\n            fontName=content_font,\n            borderPadding=6\n        )\n        \n        # === DOCUMENT HEADER ===\n        story.append(Spacer(1, 0.2*inch))\n        \n        # Main Title with modern styling\n        title = Paragraph(f'<b>{video_title}</b>', title_style)\n        story.append(title)\n        \n        # Document Type Subtitle\n        subtitle_text = 'Study Notes & Transcript'\n        if 'Study Notes' in video_title or 'notes' in video_title.lower():\n            subtitle_text = 'AI-Generated Study Notes'\n        elif 'transcript' in video_title.lower():\n            subtitle_text = 'AI-Generated Transcript'\n        \n        subtitle = Paragraph(subtitle_text, subtitle_style)\n        story.append(subtitle)\n        \n        story.append(Spacer(1, 0.25*inch))\n        \n        # === INFORMATION BOX ===\n        # Create a beautiful info table\n        info_data = [\n            [Paragraph('<b>Student Name:</b>', info_label_style), Paragraph(student_name, info_value_style)],\n            [Paragraph('<b>Course:</b>', info_label_style), Paragraph(course_name, info_value_style)],\n            [Paragraph('<b>Generated On:</b>', info_label_style), \n             Paragraph(datetime.now().strftime(\"%B %d, %Y at %I:%M %p\"), info_value_style)]\n        ]\n        \n        info_table = Table(info_data, colWidths=[1.5*inch, 4.5*inch])\n        info_table.setStyle(TableStyle([\n            ('BACKGROUND', (0, 0), (0, -1), colors.HexColor(\"#e6f7ff\")),\n            ('BACKGROUND', (1, 0), (-1, -1), colors.HexColor(\"#f0f8ff\")),\n            ('BOX', (0, 0), (-1, -1), 1.5, colors.HexColor(\"#00d4ff\")),\n            ('LEFTPADDING', (0, 0), (-1, -1), 12),\n            ('RIGHTPADDING', (0, 0), (-1, -1), 12),\n            ('TOPPADDING', (0, 0), (-1, -1), 12),\n            ('BOTTOMPADDING', (0, 0), (-1, -1), 12),\n            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),\n            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),\n            ('FONTNAME', (0, 0), (-1, -1), content_font),\n            ('FONTSIZE', (0, 0), (-1, -1), 10),\n            ('ROWBACKGROUNDS', (0, 0), (-1, -1), [colors.white, colors.HexColor(\"#f0f8ff\")]),\n        ]))\n        \n        story.append(info_table)\n        story.append(Spacer(1, 0.4*inch))\n        \n        # === CONTENT DIVIDER ===\n        story.append(Spacer(1, 0.15*inch))\n        \n        # === TRANSCRIPT CONTENT HEADER ===\n        content_header = Paragraph(\n            '<b>ðŸ“š  CONTENT  ðŸ“š</b>',\n            ParagraphStyle(\n                'ContentHeader',\n                parent=styles['Normal'],\n                fontSize=13,\n                textColor=colors.HexColor(\"#FFFFFF\"),\n                alignment=TA_CENTER,\n                spaceAfter=20,\n                fontName=content_font,\n                borderColor=colors.HexColor(\"#00d4ff\"),\n                borderWidth=1.5,\n                backColor=colors.HexColor(\"#1a0033\"),\n                borderPadding=8,\n                leading=16\n            )\n        )\n        story.append(content_header)\n        story.append(Spacer(1, 0.15*inch))\n        \n        # === PROCESS TRANSCRIPT TEXT ===\n        sections = transcript_text.split('\\n\\n')\n        \n        for section in sections:\n            section = section.strip()\n            if not section:\n                continue\n            \n            lines = section.split('\\n')\n            first_line = lines[0].strip()\n            \n            # Check if this is a header\n            if (first_line.isupper() and len(first_line) < 60) or \\\n               (first_line and first_line[0].isdigit() and '.' in first_line[:5]):\n                # This is a VVIP heading - centered with elegant decorations\n                heading_text = f'âœ¦  {first_line}  âœ¦'\n                heading = Paragraph(heading_text, heading_style)\n                story.append(heading)\n                \n                # Add the rest as body text\n                if len(lines) > 1:\n                    body_text = '\\n'.join(lines[1:])\n                    para = Paragraph(body_text.replace('\\n', '<br/>'), body_style)\n                    story.append(para)\n            else:\n                # Regular paragraph\n                para = Paragraph(section.replace('\\n', '<br/>'), body_style)\n                story.append(para)\n            \n            story.append(Spacer(1, 0.1*inch))\n        \n        # === FOOTER NOTE ===\n        story.append(Spacer(1, 0.4*inch))\n        \n        # === PREMIUM FOOTER NOTE ===\n        story.append(Spacer(1, 0.4*inch))\n        \n        footer_note_style = ParagraphStyle(\n            'FooterNote',\n            parent=styles['Normal'],\n            fontSize=9,\n            textColor=colors.HexColor(\"#1a1a1a\"),\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=14,\n            borderWidth=2,\n            borderColor=colors.HexColor(\"#00d4ff\"),\n            borderPadding=12,\n            backColor=colors.HexColor(\"#e6f7ff\")\n        )\n        \n        footer_note = Paragraph(\n            '<b>âœ“ Quality Assurance:</b> This document was generated using advanced Gemini AI technology. '\n            'For best results, cross-reference key concepts with original video content. '\n            '<br/><b>ðŸŽ“ Use This For:</b> Study reference, exam preparation, knowledge review, and learning reinforcement.'\n            '<br/><i>LearnNest - Empowering Learning Through AI Technology</i>',\n            footer_note_style\n        )\n        story.append(footer_note)\n        \n        # Build PDF with beautiful watermarked canvas\n        def make_canvas(*args, **kwargs):\n            return BeautifulWatermarkedCanvas(*args, add_watermark=add_watermark, custom_watermark=custom_watermark, **kwargs)\n        \n        doc.build(story, canvasmaker=make_canvas)\n        \n        return True\n        \n    except Exception as e:\n        print(f\"Error generating beautiful PDF: {e}\")\n        return False\n\n\ndef generate_notes_pdf(notes_content, topic, teacher_name, output_path, add_watermark=True, custom_watermark=None):\n    \"\"\"\n    Generate a stunning, professional PDF for AI-generated notes with LearnNest branding\n    \n    Args:\n        notes_content (str): The AI-generated notes content (can be markdown formatted)\n        topic (str): The topic/subject of the notes\n        teacher_name (str): Name of the instructor/teacher\n        output_path (str): Full path where the PDF should be saved\n        add_watermark (bool): Whether to add LearnNest watermark (default: True)\n        custom_watermark (str): Custom watermark text from student (optional)\n    \n    Returns:\n        bool: True if successful, False otherwise\n    \"\"\"\n    try:\n        # Ensure directory exists\n        os.makedirs(os.path.dirname(output_path), exist_ok=True)\n        \n        # Create the PDF document with custom canvas\n        doc = SimpleDocTemplate(\n            output_path,\n            pagesize=letter,\n            rightMargin=0.8*inch,\n            leftMargin=0.8*inch,\n            topMargin=1.0*inch,\n            bottomMargin=1.0*inch\n        )\n        \n        # Container for the 'Flowable' objects\n        story = []\n        \n        # Define custom styles\n        styles = getSampleStyleSheet()\n        \n        # Detect language for font selection\n        content_font = get_font_for_text(notes_content + topic)\n        \n        # === TITLE STYLE ===\n        title_style = ParagraphStyle(\n            'NotesTitle',\n            parent=styles['Heading1'],\n            fontSize=28,\n            textColor=colors.HexColor(\"#1a0033\"),\n            spaceAfter=12,\n            spaceBefore=6,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=32,\n            borderPadding=12,\n            borderColor=colors.HexColor(\"#00d4ff\"),\n            borderWidth=0.5\n        )\n        \n        # === SUBTITLE STYLE ===\n        subtitle_style = ParagraphStyle(\n            'NotesSubtitle',\n            parent=styles['Normal'],\n            fontSize=13,\n            textColor=colors.HexColor(\"#555555\"),\n            spaceAfter=20,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=16\n        )\n        \n        # === TEACHER NAME STYLE ===\n        teacher_style = ParagraphStyle(\n            'TeacherName',\n            parent=styles['Normal'],\n            fontSize=14,\n            textColor=colors.HexColor(\"#00d4ff\"),\n            spaceAfter=24,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=16\n        )\n        \n        # === VVIP HEADING STYLE (CENTERED) ===\n        heading_style = ParagraphStyle(\n            'VVIPNotesHeading',\n            parent=styles['Heading2'],\n            fontSize=16,\n            textColor=colors.HexColor(\"#FFFFFF\"),\n            spaceAfter=16,\n            spaceBefore=20,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            borderPadding=12,\n            borderColor=colors.HexColor(\"#0A84FF\"),\n            borderWidth=2,\n            backColor=colors.HexColor(\"#1a0033\"),\n            leading=20,\n            borderRadius=8\n        )\n        \n        # === BODY STYLE ===\n        body_style = ParagraphStyle(\n            'NotesBody',\n            parent=styles['BodyText'],\n            fontSize=10.5,\n            alignment=TA_JUSTIFY,\n            spaceAfter=12,\n            leading=20,\n            textColor=colors.HexColor(\"#1a1a1a\"),\n            fontName=content_font,\n            borderPadding=6\n        )\n        \n        # === DOCUMENT HEADER ===\n        story.append(Spacer(1, 0.2*inch))\n        \n        # Main Title\n        title = Paragraph(f'<b>{topic}</b>', title_style)\n        story.append(title)\n        \n        # Subtitle\n        subtitle = Paragraph('AI-Generated Study Notes', subtitle_style)\n        story.append(subtitle)\n        \n        # Teacher Name\n        if teacher_name:\n            teacher_para = Paragraph(f'<b>By: {teacher_name}</b>', teacher_style)\n            story.append(teacher_para)\n        \n        story.append(Spacer(1, 0.3*inch))\n        \n        # === INFO BOX ===\n        info_data = [\n            [Paragraph('<b>Generated On:</b>', subtitle_style), \n             Paragraph(datetime.now().strftime(\"%B %d, %Y at %I:%M %p\"), subtitle_style)]\n        ]\n        \n        info_table = Table(info_data, colWidths=[1.5*inch, 4.5*inch])\n        info_table.setStyle(TableStyle([\n            ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor(\"#e6f7ff\")),\n            ('BOX', (0, 0), (-1, -1), 1.5, colors.HexColor(\"#00d4ff\")),\n            ('LEFTPADDING', (0, 0), (-1, -1), 12),\n            ('RIGHTPADDING', (0, 0), (-1, -1), 12),\n            ('TOPPADDING', (0, 0), (-1, -1), 10),\n            ('BOTTOMPADDING', (0, 0), (-1, -1), 10),\n            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),\n            ('FONTNAME', (0, 0), (-1, -1), content_font),\n        ]))\n        \n        story.append(info_table)\n        story.append(Spacer(1, 0.4*inch))\n        \n        # === CONTENT DIVIDER ===\n        content_header = Paragraph(\n            '<b>ðŸ“š  STUDY NOTES  ðŸ“š</b>',\n            ParagraphStyle(\n                'ContentHeader',\n                parent=styles['Normal'],\n                fontSize=13,\n                textColor=colors.HexColor(\"#FFFFFF\"),\n                alignment=TA_CENTER,\n                spaceAfter=20,\n                fontName=content_font,\n                borderColor=colors.HexColor(\"#00d4ff\"),\n                borderWidth=1.5,\n                backColor=colors.HexColor(\"#1a0033\"),\n                borderPadding=8,\n                leading=16\n            )\n        )\n        story.append(content_header)\n        story.append(Spacer(1, 0.15*inch))\n        \n        # === PROCESS NOTES CONTENT ===\n        # Handle markdown-style formatting\n        sections = notes_content.split('\\n\\n')\n        \n        for section in sections:\n            section = section.strip()\n            if not section:\n                continue\n            \n            lines = section.split('\\n')\n            first_line = lines[0].strip()\n            \n            # Check for markdown headers\n            if first_line.startswith('# '):\n                heading_text = f'âœ¦  {first_line[2:]}  âœ¦'\n                heading = Paragraph(heading_text, heading_style)\n                story.append(heading)\n                \n                if len(lines) > 1:\n                    body_text = '\\n'.join(lines[1:])\n                    para = Paragraph(body_text.replace('\\n', '<br/>'), body_style)\n                    story.append(para)\n            elif first_line.startswith('## '):\n                heading_text = f'âœ¦  {first_line[3:]}  âœ¦'\n                heading = Paragraph(heading_text, heading_style)\n                story.append(heading)\n                \n                if len(lines) > 1:\n                    body_text = '\\n'.join(lines[1:])\n                    para = Paragraph(body_text.replace('\\n', '<br/>'), body_style)\n                    story.append(para)\n            elif first_line.startswith('### '):\n                heading_text = f'âœ¦  {first_line[4:]}  âœ¦'\n                heading = Paragraph(heading_text, heading_style)\n                story.append(heading)\n                \n                if len(lines) > 1:\n                    body_text = '\\n'.join(lines[1:])\n                    para = Paragraph(body_text.replace('\\n', '<br/>'), body_style)\n                    story.append(para)\n            else:\n                # Process regular content with bold markers - properly handle markdown\n                content = section\n                # Replace **text** with <b>text</b>\n                import re\n                content = re.sub(r'\\*\\*(.+?)\\*\\*', r'<b>\\1</b>', content)\n                # Escape any remaining asterisks\n                content = content.replace('*', 'â€¢')\n                para = Paragraph(content.replace('\\n', '<br/>'), body_style)\n                story.append(para)\n            \n            story.append(Spacer(1, 0.1*inch))\n        \n        # === FOOTER NOTE ===\n        story.append(Spacer(1, 0.4*inch))\n        \n        footer_note_style = ParagraphStyle(\n            'FooterNote',\n            parent=styles['Normal'],\n            fontSize=9,\n            textColor=colors.HexColor(\"#1a1a1a\"),\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=14,\n            borderWidth=2,\n            borderColor=colors.HexColor(\"#00d4ff\"),\n            borderPadding=12,\n            backColor=colors.HexColor(\"#e6f7ff\")\n        )\n        \n        footer_note = Paragraph(\n            '<b>âœ“ AI-Generated Content:</b> These notes were created using advanced Gemini AI technology. '\n            'Review and supplement with additional resources for comprehensive understanding. '\n            '<br/><b>ðŸŽ“ Use This For:</b> Study reference, exam preparation, concept review, and knowledge reinforcement.'\n            '<br/><i>LearnNest - Empowering Learning Through AI Technology</i>',\n            footer_note_style\n        )\n        story.append(footer_note)\n        \n        # Build PDF with beautiful watermarked canvas\n        def make_canvas(*args, **kwargs):\n            return BeautifulWatermarkedCanvas(*args, add_watermark=add_watermark, custom_watermark=custom_watermark, **kwargs)\n        \n        doc.build(story, canvasmaker=make_canvas)\n        \n        return True\n        \n    except Exception as e:\n        print(f\"Error generating notes PDF: {e}\")\n        return False\n","size_bytes":25870},"LearnNestGemini/weather-app-abdulwaheed/static/js/dashboard.js":{"content":"<script>\nfunction enrollInCourse(courseCode, courseTitle) {\n    document.getElementById('modalCourseTitle').textContent = courseTitle;\n    document.getElementById('modalCourseCode').textContent = courseCode;\n    document.getElementById('modalCourseCodeInput').value = courseCode;\n    document.getElementById('modalEnrollmentKey').value = '';\n    document.getElementById('enrollmentModal').style.display = 'block';\n    document.getElementById('modalEnrollmentKey').focus();\n}\n\nfunction closeEnrollmentModal() {\n    document.getElementById('enrollmentModal').style.display = 'none';\n}\n\nfunction viewCourseDetails(courseId) {\n    window.location.href = '{{ url_for(\"student_browse_courses\") }}#course-' + courseId;\n}\n\n// Set current date\ndocument.addEventListener('DOMContentLoaded', function() {\n    const now = new Date();\n    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };\n    document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);\n    \n    // Initialize progress animations\n    initializeProgressAnimations();\n});\n\n// Function to initialize progress animations\nfunction initializeProgressAnimations() {\n    const progressBars = document.querySelectorAll('.progress-fill');\n    \n    progressBars.forEach(bar => {\n        // Add a slight delay to make the animation more noticeable\n        setTimeout(() => {\n            const width = bar.style.width;\n            bar.style.width = '0%';\n            \n            // Animate to the actual width\n            setTimeout(() => {\n                bar.style.width = width;\n            }, 300);\n        }, 500);\n    });\n}\n\n// Function to simulate progress update\nfunction simulateProgressUpdate(courseCode, newProgress) {\n    const courseItems = document.querySelectorAll('.course-item');\n    \n    courseItems.forEach(item => {\n        const codeElement = item.querySelector('.course-code');\n        if (codeElement && codeElement.textContent === courseCode) {\n            const progressFill = item.querySelector('.progress-fill');\n            const progressPercentage = item.querySelector('.progress-percentage');\n            \n            if (progressFill) {\n                progressFill.style.width = `${newProgress}%`;\n                \n                // Add a glow effect\n                progressFill.style.animation = 'progress-glow 1s ease';\n                \n                // Remove animation after it completes\n                setTimeout(() => {\n                    progressFill.style.animation = '';\n                }, 1000);\n            }\n        }\n    });\n}\n\n// Close modal when clicking outside\nwindow.addEventListener('click', function(event) {\n    const modal = document.getElementById('enrollmentModal');\n    if (event.target === modal) {\n        closeEnrollmentModal();\n    }\n});\n\n// Close modal on escape key\ndocument.addEventListener('keydown', function(event) {\n    if (event.key === 'Escape') {\n        closeEnrollmentModal();\n    }\n});\n\n// Demo function to show progress animation (remove in production)\nfunction demoProgressAnimation() {\n    setTimeout(() => {\n        simulateProgressUpdate('CS101', 75);\n    }, 2000);\n    \n    setTimeout(() => {\n        simulateProgressUpdate('MATH201', 45);\n    }, 4000);\n}\n\n// Initialize demo on page load (remove in production)\ndocument.addEventListener('DOMContentLoaded', function() {\n    // Uncomment the line below to see demo progress animations\n    // demoProgressAnimation();\n});\n</script>\n","size_bytes":3479},"zsam/pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"eventlet>=0.40.3\",\n    \"flask>=3.1.2\",\n    \"flask-caching>=2.3.1\",\n    \"flask-login>=0.6.3\",\n    \"flask-mail>=0.10.0\",\n    \"flask-socketio>=5.5.1\",\n    \"google-genai>=1.36.0\",\n    \"gunicorn>=23.0.0\",\n    \"nltk>=3.9.1\",\n    \"numpy>=2.3.3\",\n    \"pandas>=2.3.2\",\n    \"pillow>=11.3.0\",\n    \"pypdf2>=3.0.1\",\n    \"python-dotenv>=1.1.1\",\n    \"sift-stack-py>=0.8.5\",\n    \"werkzeug>=3.1.3\",\n]\n","size_bytes":531},"LearnNestGemini/weather-app-abdulwaheed/templates/student/video_download/app.sh":{"content":"python app.py\n","size_bytes":14},"templates/student/video_download/static/css/output.css":{"content":"/*\n! tailwindcss v3.3.2 | MIT License | https://tailwindcss.com\n*/\n\n/*\n1. Prevent padding and border from affecting element width. (https://github.com/mozdevs/cssremedy/issues/4)\n2. Allow adding a border to an element by just adding a border-width. (https://github.com/tailwindcss/tailwindcss/pull/116)\n*/\n\n*,\n::before,\n::after {\n  box-sizing: border-box;\n  /* 1 */\n  border-width: 0;\n  /* 2 */\n  border-style: solid;\n  /* 2 */\n  border-color: #e5e7eb;\n  /* 2 */\n}\n\n::before,\n::after {\n  --tw-content: '';\n}\n\n/*\n1. Use a consistent sensible line-height in all browsers.\n2. Prevent adjustments of font size after orientation changes in iOS.\n3. Use a more readable tab size.\n4. Use the user's configured `sans` font-family by default.\n5. Use the user's configured `sans` font-feature-settings by default.\n6. Use the user's configured `sans` font-variation-settings by default.\n*/\n\nhtml {\n  line-height: 1.5;\n  /* 1 */\n  -webkit-text-size-adjust: 100%;\n  /* 2 */\n  -moz-tab-size: 4;\n  /* 3 */\n  -o-tab-size: 4;\n     tab-size: 4;\n  /* 3 */\n  font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, \"Noto Sans\", sans-serif, \"Apple Color Emoji\", \"Segoe UI Emoji\", \"Segoe UI Symbol\", \"Noto Color Emoji\";\n  /* 4 */\n  font-feature-settings: normal;\n  /* 5 */\n  font-variation-settings: normal;\n  /* 6 */\n}\n\n/*\n1. Remove the margin in all browsers.\n2. Inherit line-height from `html` so users can set them as a class directly on the `html` element.\n*/\n\nbody {\n  margin: 0;\n  /* 1 */\n  line-height: inherit;\n  /* 2 */\n}\n\n/*\n1. Add the correct height in Firefox.\n2. Correct the inheritance of border color in Firefox. (https://bugzilla.mozilla.org/show_bug.cgi?id=190655)\n3. Ensure horizontal rules are visible by default.\n*/\n\nhr {\n  height: 0;\n  /* 1 */\n  color: inherit;\n  /* 2 */\n  border-top-width: 1px;\n  /* 3 */\n}\n\n/*\nAdd the correct text decoration in Chrome, Edge, and Safari.\n*/\n\nabbr:where([title]) {\n  -webkit-text-decoration: underline dotted;\n          text-decoration: underline dotted;\n}\n\n/*\nRemove the default font size and weight for headings.\n*/\n\nh1,\nh2,\nh3,\nh4,\nh5,\nh6 {\n  font-size: inherit;\n  font-weight: inherit;\n}\n\n/*\nReset links to optimize for opt-in styling instead of opt-out.\n*/\n\na {\n  color: inherit;\n  text-decoration: inherit;\n}\n\n/*\nAdd the correct font weight in Edge and Safari.\n*/\n\nb,\nstrong {\n  font-weight: bolder;\n}\n\n/*\n1. Use the user's configured `mono` font family by default.\n2. Correct the odd `em` font sizing in all browsers.\n*/\n\ncode,\nkbd,\nsamp,\npre {\n  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;\n  /* 1 */\n  font-size: 1em;\n  /* 2 */\n}\n\n/*\nAdd the correct font size in all browsers.\n*/\n\nsmall {\n  font-size: 80%;\n}\n\n/*\nPrevent `sub` and `sup` elements from affecting the line height in all browsers.\n*/\n\nsub,\nsup {\n  font-size: 75%;\n  line-height: 0;\n  position: relative;\n  vertical-align: baseline;\n}\n\nsub {\n  bottom: -0.25em;\n}\n\nsup {\n  top: -0.5em;\n}\n\n/*\n1. Remove text indentation from table contents in Chrome and Safari. (https://bugs.chromium.org/p/chromium/issues/detail?id=999088, https://bugs.webkit.org/show_bug.cgi?id=201297)\n2. Correct table border color inheritance in all Chrome and Safari. (https://bugs.chromium.org/p/chromium/issues/detail?id=935729, https://bugs.webkit.org/show_bug.cgi?id=195016)\n3. Remove gaps between table borders by default.\n*/\n\ntable {\n  text-indent: 0;\n  /* 1 */\n  border-color: inherit;\n  /* 2 */\n  border-collapse: collapse;\n  /* 3 */\n}\n\n/*\n1. Change the font styles in all browsers.\n2. Remove the margin in Firefox and Safari.\n3. Remove default padding in all browsers.\n*/\n\nbutton,\ninput,\noptgroup,\nselect,\ntextarea {\n  font-family: inherit;\n  /* 1 */\n  font-size: 100%;\n  /* 1 */\n  font-weight: inherit;\n  /* 1 */\n  line-height: inherit;\n  /* 1 */\n  color: inherit;\n  /* 1 */\n  margin: 0;\n  /* 2 */\n  padding: 0;\n  /* 3 */\n}\n\n/*\nRemove the inheritance of text transform in Edge and Firefox.\n*/\n\nbutton,\nselect {\n  text-transform: none;\n}\n\n/*\n1. Correct the inability to style clickable types in iOS and Safari.\n2. Remove default button styles.\n*/\n\nbutton,\n[type='button'],\n[type='reset'],\n[type='submit'] {\n  -webkit-appearance: button;\n  /* 1 */\n  background-color: transparent;\n  /* 2 */\n  background-image: none;\n  /* 2 */\n}\n\n/*\nUse the modern Firefox focus style for all focusable elements.\n*/\n\n:-moz-focusring {\n  outline: auto;\n}\n\n/*\nRemove the additional `:invalid` styles in Firefox. (https://github.com/mozilla/gecko-dev/blob/2f9eacd9d3d995c937b4251a5557d95d494c9be1/layout/style/res/forms.css#L728-L737)\n*/\n\n:-moz-ui-invalid {\n  box-shadow: none;\n}\n\n/*\nAdd the correct vertical alignment in Chrome and Firefox.\n*/\n\nprogress {\n  vertical-align: baseline;\n}\n\n/*\nCorrect the cursor style of increment and decrement buttons in Safari.\n*/\n\n::-webkit-inner-spin-button,\n::-webkit-outer-spin-button {\n  height: auto;\n}\n\n/*\n1. Correct the odd appearance in Chrome and Safari.\n2. Correct the outline style in Safari.\n*/\n\n[type='search'] {\n  -webkit-appearance: textfield;\n  /* 1 */\n  outline-offset: -2px;\n  /* 2 */\n}\n\n/*\nRemove the inner padding in Chrome and Safari on macOS.\n*/\n\n::-webkit-search-decoration {\n  -webkit-appearance: none;\n}\n\n/*\n1. Correct the inability to style clickable types in iOS and Safari.\n2. Change font properties to `inherit` in Safari.\n*/\n\n::-webkit-file-upload-button {\n  -webkit-appearance: button;\n  /* 1 */\n  font: inherit;\n  /* 2 */\n}\n\n/*\nAdd the correct display in Chrome and Safari.\n*/\n\nsummary {\n  display: list-item;\n}\n\n/*\nRemoves the default spacing and border for appropriate elements.\n*/\n\nblockquote,\ndl,\ndd,\nh1,\nh2,\nh3,\nh4,\nh5,\nh6,\nhr,\nfigure,\np,\npre {\n  margin: 0;\n}\n\nfieldset {\n  margin: 0;\n  padding: 0;\n}\n\nlegend {\n  padding: 0;\n}\n\nol,\nul,\nmenu {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n\n/*\nPrevent resizing textareas horizontally by default.\n*/\n\ntextarea {\n  resize: vertical;\n}\n\n/*\n1. Reset the default placeholder opacity in Firefox. (https://github.com/tailwindlabs/tailwindcss/issues/3300)\n2. Set the default placeholder color to the user's configured gray 400 color.\n*/\n\ninput::-moz-placeholder, textarea::-moz-placeholder {\n  opacity: 1;\n  /* 1 */\n  color: #9ca3af;\n  /* 2 */\n}\n\ninput::placeholder,\ntextarea::placeholder {\n  opacity: 1;\n  /* 1 */\n  color: #9ca3af;\n  /* 2 */\n}\n\n/*\nSet the default cursor for buttons.\n*/\n\nbutton,\n[role=\"button\"] {\n  cursor: pointer;\n}\n\n/*\nMake sure disabled buttons don't get the pointer cursor.\n*/\n\n:disabled {\n  cursor: default;\n}\n\n/*\n1. Make replaced elements `display: block` by default. (https://github.com/mozdevs/cssremedy/issues/14)\n2. Add `vertical-align: middle` to align replaced elements more sensibly by default. (https://github.com/jensimmons/cssremedy/issues/14#issuecomment-634934210)\n   This can trigger a poorly considered lint error in some tools but is included by design.\n*/\n\nimg,\nsvg,\nvideo,\ncanvas,\naudio,\niframe,\nembed,\nobject {\n  display: block;\n  /* 1 */\n  vertical-align: middle;\n  /* 2 */\n}\n\n/*\nConstrain images and videos to the parent width and preserve their intrinsic aspect ratio. (https://github.com/mozdevs/cssremedy/issues/14)\n*/\n\nimg,\nvideo {\n  max-width: 100%;\n  height: auto;\n}\n\n/* Make elements with the HTML hidden attribute stay hidden by default */\n\n[hidden] {\n  display: none;\n}\n\n*, ::before, ::after {\n  --tw-border-spacing-x: 0;\n  --tw-border-spacing-y: 0;\n  --tw-translate-x: 0;\n  --tw-translate-y: 0;\n  --tw-rotate: 0;\n  --tw-skew-x: 0;\n  --tw-skew-y: 0;\n  --tw-scale-x: 1;\n  --tw-scale-y: 1;\n  --tw-pan-x:  ;\n  --tw-pan-y:  ;\n  --tw-pinch-zoom:  ;\n  --tw-scroll-snap-strictness: proximity;\n  --tw-gradient-from-position:  ;\n  --tw-gradient-via-position:  ;\n  --tw-gradient-to-position:  ;\n  --tw-ordinal:  ;\n  --tw-slashed-zero:  ;\n  --tw-numeric-figure:  ;\n  --tw-numeric-spacing:  ;\n  --tw-numeric-fraction:  ;\n  --tw-ring-inset:  ;\n  --tw-ring-offset-width: 0px;\n  --tw-ring-offset-color: #fff;\n  --tw-ring-color: rgb(59 130 246 / 0.5);\n  --tw-ring-offset-shadow: 0 0 #0000;\n  --tw-ring-shadow: 0 0 #0000;\n  --tw-shadow: 0 0 #0000;\n  --tw-shadow-colored: 0 0 #0000;\n  --tw-blur:  ;\n  --tw-brightness:  ;\n  --tw-contrast:  ;\n  --tw-grayscale:  ;\n  --tw-hue-rotate:  ;\n  --tw-invert:  ;\n  --tw-saturate:  ;\n  --tw-sepia:  ;\n  --tw-drop-shadow:  ;\n  --tw-backdrop-blur:  ;\n  --tw-backdrop-brightness:  ;\n  --tw-backdrop-contrast:  ;\n  --tw-backdrop-grayscale:  ;\n  --tw-backdrop-hue-rotate:  ;\n  --tw-backdrop-invert:  ;\n  --tw-backdrop-opacity:  ;\n  --tw-backdrop-saturate:  ;\n  --tw-backdrop-sepia:  ;\n}\n\n::backdrop {\n  --tw-border-spacing-x: 0;\n  --tw-border-spacing-y: 0;\n  --tw-translate-x: 0;\n  --tw-translate-y: 0;\n  --tw-rotate: 0;\n  --tw-skew-x: 0;\n  --tw-skew-y: 0;\n  --tw-scale-x: 1;\n  --tw-scale-y: 1;\n  --tw-pan-x:  ;\n  --tw-pan-y:  ;\n  --tw-pinch-zoom:  ;\n  --tw-scroll-snap-strictness: proximity;\n  --tw-gradient-from-position:  ;\n  --tw-gradient-via-position:  ;\n  --tw-gradient-to-position:  ;\n  --tw-ordinal:  ;\n  --tw-slashed-zero:  ;\n  --tw-numeric-figure:  ;\n  --tw-numeric-spacing:  ;\n  --tw-numeric-fraction:  ;\n  --tw-ring-inset:  ;\n  --tw-ring-offset-width: 0px;\n  --tw-ring-offset-color: #fff;\n  --tw-ring-color: rgb(59 130 246 / 0.5);\n  --tw-ring-offset-shadow: 0 0 #0000;\n  --tw-ring-shadow: 0 0 #0000;\n  --tw-shadow: 0 0 #0000;\n  --tw-shadow-colored: 0 0 #0000;\n  --tw-blur:  ;\n  --tw-brightness:  ;\n  --tw-contrast:  ;\n  --tw-grayscale:  ;\n  --tw-hue-rotate:  ;\n  --tw-invert:  ;\n  --tw-saturate:  ;\n  --tw-sepia:  ;\n  --tw-drop-shadow:  ;\n  --tw-backdrop-blur:  ;\n  --tw-backdrop-brightness:  ;\n  --tw-backdrop-contrast:  ;\n  --tw-backdrop-grayscale:  ;\n  --tw-backdrop-hue-rotate:  ;\n  --tw-backdrop-invert:  ;\n  --tw-backdrop-opacity:  ;\n  --tw-backdrop-saturate:  ;\n  --tw-backdrop-sepia:  ;\n}\n\n.container {\n  width: 100%;\n}\n\n@media (min-width: 640px) {\n  .container {\n    max-width: 640px;\n  }\n}\n\n@media (min-width: 768px) {\n  .container {\n    max-width: 768px;\n  }\n}\n\n@media (min-width: 1024px) {\n  .container {\n    max-width: 1024px;\n  }\n}\n\n@media (min-width: 1280px) {\n  .container {\n    max-width: 1280px;\n  }\n}\n\n@media (min-width: 1536px) {\n  .container {\n    max-width: 1536px;\n  }\n}\n\n.static {\n  position: static;\n}\n\n.mx-auto {\n  margin-left: auto;\n  margin-right: auto;\n}\n\n.mb-12 {\n  margin-bottom: 3rem;\n}\n\n.mb-4 {\n  margin-bottom: 1rem;\n}\n\n.mb-5 {\n  margin-bottom: 1.25rem;\n}\n\n.mb-8 {\n  margin-bottom: 2rem;\n}\n\n.ml-1 {\n  margin-left: 0.25rem;\n}\n\n.ml-3 {\n  margin-left: 0.75rem;\n}\n\n.mr-3 {\n  margin-right: 0.75rem;\n}\n\n.mt-4 {\n  margin-top: 1rem;\n}\n\n.flex {\n  display: flex;\n}\n\n.inline-flex {\n  display: inline-flex;\n}\n\n.h-10 {\n  height: 2.5rem;\n}\n\n.h-5 {\n  height: 1.25rem;\n}\n\n.w-1\\/2 {\n  width: 50%;\n}\n\n.w-10 {\n  width: 2.5rem;\n}\n\n.w-5 {\n  width: 1.25rem;\n}\n\n.w-full {\n  width: 100%;\n}\n\n.w-5\\/6 {\n  width: 83.333333%;\n}\n\n.flex-shrink-0 {\n  flex-shrink: 0;\n}\n\n.appearance-none {\n  -webkit-appearance: none;\n     -moz-appearance: none;\n          appearance: none;\n}\n\n.flex-col {\n  flex-direction: column;\n}\n\n.flex-wrap {\n  flex-wrap: wrap;\n}\n\n.items-center {\n  align-items: center;\n}\n\n.justify-center {\n  justify-content: center;\n}\n\n.rounded {\n  border-radius: 0.25rem;\n}\n\n.rounded-full {\n  border-radius: 9999px;\n}\n\n.border-0 {\n  border-width: 0px;\n}\n\n.border-4 {\n  border-width: 4px;\n}\n\n.border-b {\n  border-bottom-width: 1px;\n}\n\n.border-none {\n  border-style: none;\n}\n\n.border-teal-500 {\n  --tw-border-opacity: 1;\n  border-color: rgb(20 184 166 / var(--tw-border-opacity));\n}\n\n.bg-gray-800 {\n  --tw-bg-opacity: 1;\n  background-color: rgb(31 41 55 / var(--tw-bg-opacity));\n}\n\n.bg-gray-900 {\n  --tw-bg-opacity: 1;\n  background-color: rgb(17 24 39 / var(--tw-bg-opacity));\n}\n\n.bg-indigo-500 {\n  --tw-bg-opacity: 1;\n  background-color: rgb(99 102 241 / var(--tw-bg-opacity));\n}\n\n.bg-teal-500 {\n  --tw-bg-opacity: 1;\n  background-color: rgb(20 184 166 / var(--tw-bg-opacity));\n}\n\n.bg-transparent {\n  background-color: transparent;\n}\n\n.object-cover {\n  -o-object-fit: cover;\n     object-fit: cover;\n}\n\n.object-center {\n  -o-object-position: center;\n     object-position: center;\n}\n\n.p-2 {\n  padding: 0.5rem;\n}\n\n.p-5 {\n  padding: 1.25rem;\n}\n\n.px-2 {\n  padding-left: 0.5rem;\n  padding-right: 0.5rem;\n}\n\n.px-3 {\n  padding-left: 0.75rem;\n  padding-right: 0.75rem;\n}\n\n.px-5 {\n  padding-left: 1.25rem;\n  padding-right: 1.25rem;\n}\n\n.py-1 {\n  padding-top: 0.25rem;\n  padding-bottom: 0.25rem;\n}\n\n.py-2 {\n  padding-top: 0.5rem;\n  padding-bottom: 0.5rem;\n}\n\n.py-24 {\n  padding-top: 6rem;\n  padding-bottom: 6rem;\n}\n\n.py-8 {\n  padding-top: 2rem;\n  padding-bottom: 2rem;\n}\n\n.text-center {\n  text-align: center;\n}\n\n.text-2xl {\n  font-size: 1.5rem;\n  line-height: 2rem;\n}\n\n.text-3xl {\n  font-size: 1.875rem;\n  line-height: 2.25rem;\n}\n\n.text-base {\n  font-size: 1rem;\n  line-height: 1.5rem;\n}\n\n.text-sm {\n  font-size: 0.875rem;\n  line-height: 1.25rem;\n}\n\n.text-xl {\n  font-size: 1.25rem;\n  line-height: 1.75rem;\n}\n\n.font-medium {\n  font-weight: 500;\n}\n\n.leading-relaxed {\n  line-height: 1.625;\n}\n\n.leading-tight {\n  line-height: 1.25;\n}\n\n.text-gray-400 {\n  --tw-text-opacity: 1;\n  color: rgb(156 163 175 / var(--tw-text-opacity));\n}\n\n.text-gray-500 {\n  --tw-text-opacity: 1;\n  color: rgb(107 114 128 / var(--tw-text-opacity));\n}\n\n.text-gray-600 {\n  --tw-text-opacity: 1;\n  color: rgb(75 85 99 / var(--tw-text-opacity));\n}\n\n.text-gray-700 {\n  --tw-text-opacity: 1;\n  color: rgb(55 65 81 / var(--tw-text-opacity));\n}\n\n.text-gray-900 {\n  --tw-text-opacity: 1;\n  color: rgb(17 24 39 / var(--tw-text-opacity));\n}\n\n.text-white {\n  --tw-text-opacity: 1;\n  color: rgb(255 255 255 / var(--tw-text-opacity));\n}\n\n.hover\\:border-teal-700:hover {\n  --tw-border-opacity: 1;\n  border-color: rgb(15 118 110 / var(--tw-border-opacity));\n}\n\n.hover\\:bg-gray-700:hover {\n  --tw-bg-opacity: 1;\n  background-color: rgb(55 65 81 / var(--tw-bg-opacity));\n}\n\n.hover\\:bg-teal-700:hover {\n  --tw-bg-opacity: 1;\n  background-color: rgb(15 118 110 / var(--tw-bg-opacity));\n}\n\n.focus\\:outline-none:focus {\n  outline: 2px solid transparent;\n  outline-offset: 2px;\n}\n\n@media (min-width: 640px) {\n  .sm\\:ml-4 {\n    margin-left: 1rem;\n  }\n\n  .sm\\:ml-auto {\n    margin-left: auto;\n  }\n\n  .sm\\:mt-0 {\n    margin-top: 0px;\n  }\n\n  .sm\\:flex-row {\n    flex-direction: row;\n  }\n\n  .sm\\:justify-start {\n    justify-content: flex-start;\n  }\n\n  .sm\\:border-l-2 {\n    border-left-width: 2px;\n  }\n\n  .sm\\:border-gray-800 {\n    --tw-border-opacity: 1;\n    border-color: rgb(31 41 55 / var(--tw-border-opacity));\n  }\n\n  .sm\\:py-2 {\n    padding-top: 0.5rem;\n    padding-bottom: 0.5rem;\n  }\n\n  .sm\\:pl-4 {\n    padding-left: 1rem;\n  }\n\n  .sm\\:text-3xl {\n    font-size: 1.875rem;\n    line-height: 2.25rem;\n  }\n\n  .sm\\:text-4xl {\n    font-size: 2.25rem;\n    line-height: 2.5rem;\n  }\n}\n\n@media (min-width: 768px) {\n  .md\\:mb-0 {\n    margin-bottom: 0px;\n  }\n\n  .md\\:ml-auto {\n    margin-left: auto;\n  }\n\n  .md\\:mt-0 {\n    margin-top: 0px;\n  }\n\n  .md\\:w-3\\/6 {\n    width: 50%;\n  }\n\n  .md\\:w-1\\/2 {\n    width: 50%;\n  }\n\n  .md\\:flex-row {\n    flex-direction: row;\n  }\n\n  .md\\:justify-start {\n    justify-content: flex-start;\n  }\n}\n\n@media (min-width: 1024px) {\n  .lg\\:w-2\\/3 {\n    width: 66.666667%;\n  }\n\n  .lg\\:w-2\\/6 {\n    width: 33.333333%;\n  }\n\n  .lg\\:w-1\\/2 {\n    width: 50%;\n  }\n}","size_bytes":15213},"LearnNestGemini/weather-app-abdulwaheed/templates/student/video_download/app.py":{"content":"\nfrom flask import *\nfrom pytubefix import YouTube\nimport os\nfrom datetime import datetime\nimport shutil\n\napp = Flask(__name__)\n\ni = 0  # rotating index for file naming\n\n# Create required folders\nif not os.path.exists('audios'):\n    os.mkdir('audios')\nif not os.path.exists('videos'):\n    os.mkdir('videos')\n\n\ndef clean_url(link: str) -> str:\n    \"\"\"Cleans YouTube URL by removing ?si= and other parameters.\"\"\"\n    return link.split(\"&\")[0].split(\"?\")[0]\n\n\ndef download_audio(link):\n    global i\n\n    clean = clean_url(link)\n\n    if len(os.listdir('audios')) > 5:\n        shutil.rmtree('audios')\n        os.mkdir('audios')\n\n    yt = YouTube(clean)\n\n    audio_stream = yt.streams.filter(only_audio=True).first()\n    out_file = audio_stream.download(output_path=\"audios\", filename=f\"{i}.mp3\")\n\n    os.system(\n        f'ffmpeg -y -loop 1 -r 1 -i static/images/flyer.jpg -i audios/{i}.mp3 '\n        f'-c:a copy -shortest -c:v libx264 audios/{i}.mp4'\n    )\n\n    os.remove(out_file)\n\n    ret_file = f\"audios/{i}.mp4\"\n\n    i = (i + 1) % 5\n\n    with open(\"history.txt\", \"a\") as myfile:\n        myfile.write(f\"\\n{datetime.now().strftime('%d/%m/%y__%H:%M:%S')} --> {link}\\n\")\n\n    return ret_file\n\n\ndef download_video(link):\n    global i\n\n    clean = clean_url(link)\n\n    if len(os.listdir('videos')) > 2:\n        shutil.rmtree('videos')\n        os.mkdir('videos')\n\n    yt = YouTube(clean)\n\n    stream = yt.streams.get_lowest_resolution()\n    out_file = stream.download(output_path=\"videos\", filename=f\"{i}.mp4\")\n\n    ret_file = f\"videos/{i}.mp4\"\n\n    i = (i + 1) % 2\n\n    with open(\"history.txt\", \"a\") as myfile:\n        myfile.write(f\"\\n{datetime.now().strftime('%d/%m/%y__%H:%M:%S')} --> {link}\\n\")\n\n    return ret_file\n\n\n@app.route('/')\ndef home():\n    return render_template('index.html')\n\n\n@app.route('/submit_audio', methods=['POST'])\ndef submit_audio():\n    link = request.form.get('link')\n    path = download_audio(link)\n    return send_file(path, as_attachment=True)\n\n\n@app.route('/submit', methods=['POST'])\ndef submit():\n    link = request.form.get('link')\n    path = download_video(link)\n    return send_file(path, as_attachment=True)\n\n\nif __name__ == \"__main__\":\n    app.run(debug=False, port=5000, host=\"0.0.0.0\")\n","size_bytes":2219},"ghalib/static/css/dashboard.css":{"content":"/* iOS Dark Theme Variables - Override base.html vars for this page */\n:root {\n    /* iOS Dark Theme Colors */\n    --black: #000000;\n    --white: #ffffff;\n    --gray-100: #1c1c1e;\n    --gray-200: #2c2c2e;\n    --gray-300: #3a3a3c;\n    --gray-400: #48484a;\n    --gray-500: #636366;\n    --gray-600: #8e8e93;\n    \n    /* iOS Vibrant Accent Colors */\n    --primary: #0a84ff;\n    --success: #30d158;\n    --warning: #ff9f0a;\n    --danger: #ff453a;\n    --info: #64d2ff;\n    --purple: #bf5af2;\n    \n    /* Text Colors */\n    --text-primary: #ffffff;\n    --text-secondary: #ebebf5;\n    --text-light: #8e8e93;\n    \n    /* Background & Cards */\n    --background: var(--black);\n    --card-bg: #121212;\n    --card-hover: #1c1c1e;\n    --border: #2c2c2e;\n    \n    /* Shadows */\n    --shadow: 0 2px 8px rgba(0, 0, 0, 0.6);\n    --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.7);\n    --shadow-xl: 0 8px 32px rgba(0, 0, 0, 0.8);\n    \n    /* Gradients */\n    --gradient-primary: linear-gradient(135deg, #0a84ff 0%, #0066cc 100%);\n    --gradient-success: linear-gradient(135deg, #30d158 0%, #28a745 100%);\n    --gradient-warning: linear-gradient(135deg, #ff9f0a 0%, #ff8c00 100%);\n    --gradient-info: linear-gradient(135deg, #64d2ff 0%, #0891b2 100%);\n    \n    /* Border Radius */\n    --radius: 8px;\n    --radius-lg: 12px;\n    --radius-xl: 16px;\n}\n\n* {\n    box-sizing: border-box;\n    margin: 0;\n    padding: 0;\n}\n\nbody {\n    background: var(--black);\n    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', system-ui, sans-serif;\n    color: var(--text-primary);\n    line-height: 1.6;\n    min-height: 100vh;\n}\n\n/* Dashboard Layout */\n.dashboard-container {\n    max-width: 1400px;\n    margin: 0 auto;\n    padding: 2rem;\n    animation: fadeIn 0.8s ease-out;\n}\n\n@keyframes fadeIn {\n    from {\n        opacity: 0;\n        transform: translateY(20px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n.dashboard-header {\n    margin-bottom: 2.5rem;\n    background: var(--card-bg);\n    border-radius: var(--radius-xl);\n    padding: 2.5rem;\n    box-shadow: var(--shadow-lg);\n    border: 1px solid var(--border);\n    position: relative;\n    overflow: hidden;\n}\n\n.dashboard-header::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 3px;\n    background: var(--gradient-primary);\n    box-shadow: 0 0 10px var(--primary);\n}\n\n.welcome-section {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n}\n\n.welcome-content h1 {\n    margin-bottom: 0.75rem;\n    font-size: 2.5rem;\n    font-weight: 800;\n    background: var(--gradient-primary);\n    -webkit-background-clip: text;\n    -webkit-text-fill-color: transparent;\n    background-clip: text;\n    letter-spacing: -0.025em;\n}\n\n.welcome-message {\n    font-size: 1.2rem;\n    color: var(--text-secondary);\n    margin-bottom: 1.5rem;\n    font-weight: 500;\n}\n\n.date-badge {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.5rem;\n    background: var(--gray-100);\n    color: var(--text-secondary);\n    padding: 0.75rem 1.5rem;\n    border-radius: 1rem;\n    font-weight: 600;\n    font-size: 0.95rem;\n    border: 1px solid var(--border);\n    backdrop-filter: blur(10px);\n}\n\n.user-avatar {\n    display: flex;\n    align-items: center;\n}\n\n.avatar-container {\n    width: 90px;\n    height: 90px;\n    border-radius: 50%;\n    background: var(--gradient-primary);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 2.5rem;\n    border: 4px solid var(--primary);\n    box-shadow: var(--shadow-xl);\n    transition: transform 0.3s ease, box-shadow 0.3s ease;\n}\n\n.avatar-container:hover {\n    transform: scale(1.05);\n    box-shadow: var(--shadow-2xl);\n}\n\n/* Stats Grid */\n.stats-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));\n    gap: 1.75rem;\n    margin-bottom: 3rem;\n}\n\n.stat-card {\n    background: var(--card-bg);\n    border-radius: 1.25rem;\n    padding: 2rem;\n    display: flex;\n    align-items: center;\n    gap: 1.25rem;\n    box-shadow: var(--shadow-md);\n    border: 1px solid var(--border);\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n    overflow: hidden;\n}\n\n.stat-card::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 3px;\n    opacity: 0;\n    transition: opacity 0.3s ease;\n}\n\n.stat-card:hover {\n    box-shadow: var(--shadow-xl);\n    transform: translateY(-8px);\n    border-color: var(--gray-300);\n}\n\n.stat-card:hover::before {\n    opacity: 1;\n}\n\n.stat-primary::before { background: var(--gradient-primary); }\n.stat-success::before { background: var(--gradient-success); }\n.stat-warning::before { background: var(--gradient-warning); }\n.stat-info::before { background: var(--gradient-info); }\n\n.stat-icon {\n    width: 70px;\n    height: 70px;\n    border-radius: 1rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1.75rem;\n    flex-shrink: 0;\n    transition: transform 0.3s ease;\n}\n\n.stat-card:hover .stat-icon {\n    transform: scale(1.1);\n}\n\n.stat-primary .stat-icon { \n    background: rgba(10, 132, 255, 0.15);\n    color: var(--primary);\n    border: 1px solid rgba(10, 132, 255, 0.3);\n}\n.stat-success .stat-icon { \n    background: rgba(48, 209, 88, 0.15);\n    color: var(--success);\n    border: 1px solid rgba(48, 209, 88, 0.3);\n}\n.stat-warning .stat-icon { \n    background: rgba(255, 159, 10, 0.15);\n    color: var(--warning);\n    border: 1px solid rgba(255, 159, 10, 0.3);\n}\n.stat-info .stat-icon { \n    background: rgba(100, 210, 255, 0.15);\n    color: var(--info);\n    border: 1px solid rgba(100, 210, 255, 0.3);\n}\n\n.stat-content {\n    flex: 1;\n}\n\n.stat-number {\n    display: block;\n    font-size: 2.5rem;\n    font-weight: 900;\n    line-height: 1;\n    margin-bottom: 0.5rem;\n    color: var(--text-primary);\n    letter-spacing: -0.025em;\n}\n\n.stat-label {\n    color: var(--text-secondary);\n    font-weight: 600;\n    font-size: 0.95rem;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n}\n\n/* Dashboard Grid */\n.dashboard-grid {\n    display: grid;\n    grid-template-columns: 2fr 1fr;\n    gap: 2.5rem;\n    align-items: start;\n}\n\n/* Cards */\n.card {\n    background: var(--card-bg);\n    border-radius: 1.5rem;\n    box-shadow: var(--shadow-md);\n    border: 1px solid var(--border);\n    overflow: hidden;\n    display: flex;\n    flex-direction: column;\n    height: fit-content;\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n}\n\n.card::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 4px;\n    background: var(--gradient-primary);\n    opacity: 0;\n    transition: opacity 0.3s ease;\n}\n\n.card:hover::before {\n    opacity: 1;\n}\n\n.card:hover {\n    box-shadow: var(--shadow-xl);\n    transform: translateY(-4px);\n}\n\n.card-highlight {\n    border-left: 6px solid var(--primary);\n}\n\n.card-header {\n    padding: 2rem;\n    border-bottom: 1px solid var(--border);\n    background: var(--gray-100);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    flex-wrap: wrap;\n    gap: 1rem;\n}\n\n.card-title {\n    margin: 0;\n    font-size: 1.5rem;\n    color: var(--text-primary);\n    font-weight: 700;\n    letter-spacing: -0.025em;\n}\n\n.header-actions {\n    display: flex;\n    gap: 0.75rem;\n}\n\n.card-content {\n    padding: 2rem;\n    flex: 1;\n}\n\n/* Course Items */\n.course-list {\n    display: flex;\n    flex-direction: column;\n    gap: 1.25rem;\n}\n\n.course-item {\n    border: 1px solid var(--border);\n    border-radius: var(--radius-lg);\n    padding: 1.5rem;\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    display: flex;\n    gap: 1.25rem;\n    align-items: flex-start;\n    background: var(--card-bg);\n    position: relative;\n    overflow: hidden;\n}\n\n.course-item::before {\n    content: '';\n    position: absolute;\n    left: 0;\n    top: 0;\n    bottom: 0;\n    width: 4px;\n    transition: all 0.3s ease;\n}\n\n.course-item:hover {\n    box-shadow: var(--shadow-lg);\n    transform: translateY(-4px);\n    border-color: var(--gray-300);\n}\n\n.course-item.pending::before {\n    background: var(--warning);\n}\n\n.course-item.active::before {\n    background: var(--success);\n}\n\n.course-item.pending {\n    background: var(--card-bg);\n    border-color: var(--warning);\n}\n\n.course-item.active {\n    background: var(--card-bg);\n    border-color: var(--success);\n}\n\n.course-badge {\n    width: 60px;\n    height: 60px;\n    border-radius: 0.75rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1.5rem;\n    flex-shrink: 0;\n    transition: all 0.3s ease;\n}\n\n.course-item:hover .course-badge {\n    transform: scale(1.1);\n}\n\n.course-item.active .course-badge { \n    background: var(--gradient-success);\n    animation: pulse 2s infinite;\n}\n.course-item.pending .course-badge { \n    background: var(--gradient-warning);\n}\n\n.course-content {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    gap: 1rem;\n}\n\n.course-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: flex-start;\n    flex-wrap: wrap;\n    gap: 0.75rem;\n}\n\n.course-header h4 {\n    margin: 0;\n    color: var(--text-primary);\n    flex: 1;\n    min-width: 250px;\n    font-weight: 700;\n    font-size: 1.2rem;\n    line-height: 1.4;\n}\n\n.course-meta {\n    display: flex;\n    gap: 1rem;\n    align-items: center;\n    flex-wrap: wrap;\n}\n\n.course-code {\n    background: var(--gray-200);\n    padding: 0.5rem 1rem;\n    border-radius: var(--radius);\n    font-size: 0.85rem;\n    color: var(--text-secondary);\n    font-weight: 600;\n    border: 1px solid var(--border);\n    font-family: 'Monaco', 'Consolas', monospace;\n}\n\n.status-badge {\n    padding: 0.5rem 1rem;\n    border-radius: 1.25rem;\n    font-size: 0.85rem;\n    font-weight: 700;\n    white-space: nowrap;\n    border: 1px solid;\n}\n\n.status-badge.approved {\n    background-color: #d1fae5;\n    color: #065f46;\n    border-color: #a7f3d0;\n}\n\n.status-badge.pending {\n    background-color: #fef3c7;\n    color: #92400e;\n    border-color: #fde68a;\n}\n\n.course-details {\n    display: flex;\n    flex-direction: column;\n    gap: 1rem;\n}\n\n.instructor, .enrolled-date {\n    margin: 0;\n    color: var(--text-secondary);\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    font-size: 0.95rem;\n    font-weight: 500;\n}\n\n/* Learning Status - iOS Dark Theme */\n.learning-status {\n    background: linear-gradient(135deg, rgba(48, 209, 88, 0.08) 0%, rgba(10, 132, 255, 0.08) 100%);\n    padding: 1.5rem;\n    border-radius: var(--radius-lg);\n    border: 1px solid var(--border);\n    margin: 1rem 0;\n    box-shadow: var(--shadow);\n    position: relative;\n    overflow: hidden;\n}\n\n.status-badge-container {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n    padding: 1rem 0;\n}\n\n.pulse-ring {\n    position: absolute;\n    width: 80px;\n    height: 80px;\n    border: 2px solid var(--success);\n    border-radius: 50%;\n    animation: pulseRing 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;\n    opacity: 0;\n}\n\n.pulse-ring.delay-1 {\n    animation-delay: 0.5s;\n}\n\n.pulse-ring.delay-2 {\n    animation-delay: 1s;\n}\n\n@keyframes pulseRing {\n    0% {\n        transform: scale(0.5);\n        opacity: 1;\n    }\n    100% {\n        transform: scale(1.3);\n        opacity: 0;\n    }\n}\n\n.status-badge {\n    display: flex;\n    align-items: center;\n    gap: 0.75rem;\n    background: linear-gradient(135deg, var(--success) 0%, #28a745 100%);\n    padding: 0.75rem 1.5rem;\n    border-radius: 50px;\n    box-shadow: 0 0 30px rgba(48, 209, 88, 0.6), \n                0 4px 12px rgba(48, 209, 88, 0.4);\n    position: relative;\n    z-index: 2;\n    animation: statusFloat 3s ease-in-out infinite;\n}\n\n.badge-icon {\n    font-size: 1.25rem;\n    animation: rotateIcon 4s linear infinite;\n}\n\n.badge-text {\n    font-size: 0.95rem;\n    font-weight: 700;\n    color: #000000;\n    letter-spacing: 0.5px;\n}\n\n@keyframes statusFloat {\n    0%, 100% {\n        transform: translateY(0);\n    }\n    50% {\n        transform: translateY(-5px);\n    }\n}\n\n@keyframes rotateIcon {\n    0%, 90% {\n        transform: rotate(0deg);\n    }\n    95% {\n        transform: rotate(-10deg);\n    }\n    100% {\n        transform: rotate(0deg);\n    }\n}\n\n.learning-bars {\n    display: flex;\n    gap: 8px;\n    justify-content: center;\n    align-items: flex-end;\n    height: 40px;\n    margin-top: 1rem;\n}\n\n.learning-bars .bar {\n    width: 6px;\n    background: linear-gradient(180deg, var(--primary) 0%, var(--success) 100%);\n    border-radius: 3px;\n    animation: barWave 1.2s ease-in-out infinite;\n    box-shadow: 0 0 10px rgba(10, 132, 255, 0.5);\n}\n\n.learning-bars .bar:nth-child(1) {\n    animation-delay: 0s;\n}\n\n.learning-bars .bar:nth-child(2) {\n    animation-delay: 0.1s;\n}\n\n.learning-bars .bar:nth-child(3) {\n    animation-delay: 0.2s;\n}\n\n.learning-bars .bar:nth-child(4) {\n    animation-delay: 0.3s;\n}\n\n.learning-bars .bar:nth-child(5) {\n    animation-delay: 0.4s;\n}\n\n@keyframes barWave {\n    0%, 100% {\n        height: 15px;\n        opacity: 0.5;\n    }\n    50% {\n        height: 35px;\n        opacity: 1;\n    }\n}\n\n.course-actions {\n    display: flex;\n    gap: 0.75rem;\n    flex-wrap: wrap;\n}\n\n.pending-notice {\n    color: var(--warning);\n    font-size: 0.95rem;\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    font-weight: 500;\n    font-style: italic;\n}\n\n/* Discover Courses */\n.discover-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n    gap: 1.25rem;\n}\n\n.discover-item {\n    background: var(--card-bg);\n    border: 1px solid var(--border);\n    border-radius: var(--radius-lg);\n    padding: 1.5rem;\n    display: flex;\n    align-items: center;\n    gap: 1.25rem;\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n    overflow: hidden;\n}\n\n.discover-item::before {\n    content: '';\n    position: absolute;\n    left: 0;\n    top: 0;\n    bottom: 0;\n    width: 3px;\n    background: var(--gradient-primary);\n    opacity: 0;\n    transition: opacity 0.3s ease;\n}\n\n.discover-item:hover::before {\n    opacity: 1;\n}\n\n.discover-item:hover {\n    box-shadow: var(--shadow-lg);\n    transform: translateY(-4px);\n    border-color: var(--gray-300);\n}\n\n.discover-icon {\n    width: 50px;\n    height: 50px;\n    border-radius: 0.75rem;\n    background: var(--gradient-primary);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1.25rem;\n    flex-shrink: 0;\n    transition: transform 0.3s ease;\n}\n\n.discover-item:hover .discover-icon {\n    transform: scale(1.1) rotate(5deg);\n}\n\n.discover-content {\n    flex: 1;\n    min-width: 0;\n}\n\n.discover-content h4 {\n    margin: 0 0 0.5rem 0;\n    font-size: 1.1rem;\n    font-weight: 700;\n    color: var(--text-primary);\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    line-height: 1.4;\n}\n\n.discover-instructor {\n    margin: 0 0 0.75rem 0;\n    font-size: 0.9rem;\n    color: var(--text-light);\n    display: flex;\n    align-items: center;\n    gap: 0.25rem;\n    font-weight: 500;\n}\n\n.discover-meta {\n    display: flex;\n    gap: 0.75rem;\n    align-items: center;\n    flex-wrap: wrap;\n}\n\n.discover-code {\n    background: var(--gray-100);\n    padding: 0.375rem 0.75rem;\n    border-radius: 0.5rem;\n    font-size: 0.8rem;\n    color: var(--text-secondary);\n    font-weight: 600;\n    border: 1px solid var(--border);\n    font-family: 'Monaco', 'Consolas', monospace;\n}\n\n.discover-category {\n    background: var(--gray-200);\n    padding: 0.375rem 0.75rem;\n    border-radius: 0.5rem;\n    font-size: 0.8rem;\n    color: var(--text-secondary);\n    font-weight: 600;\n}\n\n.discover-actions {\n    display: flex;\n    gap: 0.5rem;\n    flex-shrink: 0;\n}\n\n.btn-enroll, .btn-info {\n    width: 42px;\n    height: 42px;\n    border-radius: 0.75rem;\n    border: none;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1rem;\n    cursor: pointer;\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n    overflow: hidden;\n}\n\n.btn-enroll::before, .btn-info::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: -100%;\n    width: 100%;\n    height: 100%;\n    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);\n    transition: left 0.5s;\n}\n\n.btn-enroll:hover::before, .btn-info:hover::before {\n    left: 100%;\n}\n\n.btn-enroll {\n    background: var(--gradient-primary);\n    color: white;\n}\n\n.btn-enroll:hover {\n    transform: scale(1.1);\n    box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);\n}\n\n.btn-info {\n    background: var(--gray-200);\n    color: var(--text-primary);\n}\n\n.btn-info:hover {\n    background: var(--gray-300);\n    transform: scale(1.1);\n}\n\n.view-all-section {\n    text-align: center;\n    padding-top: 2rem;\n    margin-top: 1.5rem;\n    border-top: 1px solid var(--border);\n}\n\n/* Empty States */\n.empty-state {\n    text-align: center;\n    padding: 3rem 2rem;\n    color: var(--text-secondary);\n}\n\n.empty-icon {\n    margin-bottom: 1.5rem;\n    font-size: 3rem;\n    opacity: 0.7;\n}\n\n.empty-state h3 {\n    color: var(--text-primary);\n    margin-bottom: 1rem;\n    font-weight: 700;\n    font-size: 1.5rem;\n}\n\n.empty-state p {\n    margin-bottom: 2rem;\n    max-width: 300px;\n    margin-left: auto;\n    margin-right: auto;\n    line-height: 1.6;\n    font-size: 1.05rem;\n}\n\n/* Buttons */\n.btn {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.875rem 1.5rem;\n    border-radius: 0.75rem;\n    font-weight: 600;\n    text-decoration: none;\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    border: none;\n    cursor: pointer;\n    font-size: 0.95rem;\n    white-space: nowrap;\n    justify-content: center;\n    position: relative;\n    overflow: hidden;\n}\n\n.btn::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: -100%;\n    width: 100%;\n    height: 100%;\n    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);\n    transition: left 0.5s;\n}\n\n.btn:hover::before {\n    left: 100%;\n}\n\n.btn-sm {\n    padding: 0.75rem 1.25rem;\n    font-size: 0.9rem;\n}\n\n.btn-primary {\n    background: var(--gradient-primary);\n    color: white;\n}\n\n.btn-primary:hover {\n    transform: translateY(-2px);\n    box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);\n}\n\n.btn-secondary {\n    background: var(--gray-600);\n    color: white;\n}\n\n.btn-secondary:hover {\n    background: var(--gray-700);\n    transform: translateY(-2px);\n    box-shadow: var(--shadow-md);\n}\n\n.btn-success {\n    background: var(--gradient-success);\n    color: white;\n}\n\n.btn-success:hover {\n    transform: translateY(-2px);\n    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);\n}\n\n.btn-outline {\n    background: transparent;\n    color: var(--text-primary);\n    border: 1px solid var(--border);\n}\n\n.btn-outline:hover {\n    background: var(--gray-50);\n    transform: translateY(-2px);\n    box-shadow: var(--shadow-sm);\n    border-color: var(--gray-300);\n}\n\n/* Animations */\n@keyframes pulse {\n    0% {\n        transform: scale(0.95);\n        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);\n    }\n    \n    70% {\n        transform: scale(1);\n        box-shadow: 0 0 0 12px rgba(16, 185, 129, 0);\n    }\n    \n    100% {\n        transform: scale(0.95);\n        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);\n    }\n}\n\n@keyframes shine {\n    0% {\n        left: -100%;\n    }\n    100% {\n        left: 100%;\n    }\n}\n\n@keyframes progress-glow {\n    0% {\n        box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);\n    }\n    50% {\n        box-shadow: 0 0 20px rgba(16, 185, 129, 0.8);\n    }\n    100% {\n        box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);\n    }\n}\n\n/* Modal Styling */\n.modal {\n    display: none;\n    position: fixed;\n    z-index: 1000;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 100%;\n    background-color: rgba(0, 0, 0, 0.6);\n    backdrop-filter: blur(8px);\n}\n\n.modal-content {\n    background-color: var(--card-bg);\n    margin: 10% auto;\n    padding: 0;\n    border-radius: var(--radius-xl);\n    width: 90%;\n    max-width: 500px;\n    box-shadow: var(--shadow-xl);\n    overflow: hidden;\n    border: 1px solid var(--border);\n    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n@keyframes modalSlideIn {\n    from {\n        opacity: 0;\n        transform: translateY(-60px) scale(0.9);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0) scale(1);\n    }\n}\n\n.modal-header {\n    padding: 2rem;\n    border-bottom: 1px solid var(--border);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    background: var(--gradient-primary);\n    color: var(--white);\n}\n\n.modal-header h3 {\n    margin: 0;\n    font-weight: 700;\n    font-size: 1.5rem;\n}\n\n.close {\n    color: white;\n    font-size: 28px;\n    font-weight: bold;\n    cursor: pointer;\n    line-height: 1;\n    transition: transform 0.2s ease;\n    width: 32px;\n    height: 32px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: 50%;\n}\n\n.close:hover {\n    transform: scale(1.1);\n    background: rgba(255,255,255,0.1);\n}\n\n.modal-body {\n    padding: 2.5rem;\n}\n\n.course-info-display {\n    margin-bottom: 2rem;\n    padding-bottom: 2rem;\n    border-bottom: 1px solid var(--border-light);\n}\n\n.course-info-display h4 {\n    margin: 0 0 0.75rem 0;\n    color: var(--text-primary);\n    font-weight: 700;\n    font-size: 1.3rem;\n}\n\n.course-info-display span {\n    color: var(--text-secondary);\n    font-size: 1rem;\n    font-weight: 500;\n}\n\n.form-group {\n    margin-bottom: 2rem;\n}\n\n.form-group label {\n    display: block;\n    margin-bottom: 0.75rem;\n    font-weight: 600;\n    color: var(--text-primary);\n    font-size: 1rem;\n}\n\n.form-group input {\n    width: 100%;\n    padding: 1rem 1.25rem;\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    font-size: 1rem;\n    box-sizing: border-box;\n    background: var(--gray-200);\n    color: var(--text-primary);\n    transition: all 0.3s ease;\n    font-family: inherit;\n}\n\n.form-group input:focus {\n    outline: none;\n    border-color: var(--primary);\n    background: var(--gray-300);\n    box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);\n    transform: translateY(-1px);\n}\n\n.modal-actions {\n    display: flex;\n    gap: 1rem;\n    justify-content: center;\n    margin-top: 2.5rem;\n}\n\n/* Responsive Design */\n@media (max-width: 1200px) {\n    .dashboard-grid {\n        grid-template-columns: 1fr;\n    }\n    \n    .stats-grid {\n        grid-template-columns: repeat(2, 1fr);\n    }\n}\n\n@media (max-width: 768px) {\n    .dashboard-container {\n        padding: 1.25rem;\n    }\n    \n    .dashboard-header {\n        padding: 2rem;\n    }\n    \n    .welcome-section {\n        flex-direction: column;\n        text-align: center;\n        gap: 1.5rem;\n    }\n    \n    .welcome-content h1 {\n        font-size: 2rem;\n    }\n    \n    .avatar-container {\n        width: 70px;\n        height: 70px;\n        font-size: 2rem;\n    }\n    \n    .stats-grid {\n        grid-template-columns: 1fr;\n        gap: 1.25rem;\n    }\n    \n    .stat-card {\n        padding: 1.75rem;\n    }\n    \n    .card-header {\n        flex-direction: column;\n        align-items: flex-start;\n        gap: 1rem;\n    }\n    \n    .course-header {\n        flex-direction: column;\n        align-items: flex-start;\n        gap: 1rem;\n    }\n    \n    .course-header h4 {\n        min-width: auto;\n    }\n    \n    .course-item {\n        flex-direction: column;\n        text-align: center;\n        gap: 1.25rem;\n    }\n    \n    .course-badge {\n        align-self: center;\n    }\n    \n    .discover-grid {\n        grid-template-columns: 1fr;\n    }\n    \n    .discover-item {\n        flex-direction: column;\n        text-align: center;\n        gap: 1.25rem;\n    }\n    \n    .discover-actions {\n        align-self: stretch;\n        justify-content: center;\n    }\n    \n    .modal-content {\n        width: 95%;\n        margin: 5% auto;\n    }\n    \n    .modal-body {\n        padding: 2rem;\n    }\n    \n    .modal-actions {\n        flex-direction: column;\n    }\n}\n\n@media (max-width: 480px) {\n    .dashboard-header h1 {\n        font-size: 1.75rem;\n    }\n    \n    .card-content {\n        padding: 1.5rem;\n    }\n    \n    .course-item {\n        padding: 1.25rem;\n    }\n    \n    .course-actions {\n        flex-direction: column;\n        align-items: stretch;\n    }\n    \n    .modal-header {\n        padding: 1.5rem;\n    }\n    \n    .modal-body {\n        padding: 1.5rem;\n    }\n    \n    .stat-number {\n        font-size: 2rem;\n    }\n    \n    .stat-icon {\n        width: 60px;\n        height: 60px;\n        font-size: 1.5rem;\n    }\n    \n    .btn {\n        padding: 0.75rem 1.25rem;\n        font-size: 0.9rem;\n    }\n}\n</style>\n\n<!-- Enrollment Modal -->\n<div id=\"enrollmentModal\" class=\"modal\">\n    <div class=\"modal-content\">\n        <div class=\"modal-header\">\n            <h3>Enroll in Course</h3>\n            <span class=\"close\" onclick=\"closeEnrollmentModal()\">&times;</span>\n        </div>\n        <div class=\"modal-body\">\n            <div class=\"course-info-display\">\n                <h4 id=\"modalCourseTitle\"></h4>\n                <span id=\"modalCourseCode\"></span>\n            </div>\n            <form method=\"POST\" action=\"{{ url_for('student_enroll') }}\" id=\"modalEnrollForm\">\n                <input type=\"hidden\" name=\"csrf_token\" value=\"{{ csrf_token }}\">\n                <input type=\"hidden\" id=\"modalCourseCodeInput\" name=\"course_code\">\n                <div class=\"form-group\">\n                    <label for=\"modalEnrollmentKey\">Enrollment Key</label>\n                    <input type=\"password\" \n                           id=\"modalEnrollmentKey\" \n                           name=\"enrollment_key\" \n                           required\n                           placeholder=\"Enter the enrollment key provided by your instructor\">\n                    <small style=\"color: var(--text-light); margin-top: 0.5rem; display: block; font-size: 0.8rem;\">\n                        Get the enrollment key from your instructor to complete enrollment.\n                    </small>\n                </div>\n                <div class=\"modal-actions\">\n                    <button type=\"submit\" class=\"btn btn-primary\">\n                        Confirm Enrollment\n                    </button>\n                    <button type=\"button\" class=\"btn btn-outline\" onclick=\"closeEnrollmentModal()\">\n                        Cancel\n                    </button>\n                </div>\n            </form>\n        </div>\n    </div>\n</div>\n\n<script>\nfunction enrollInCourse(courseCode, courseTitle) {\n    document.getElementById('modalCourseTitle').textContent = courseTitle;\n    document.getElementById('modalCourseCode').textContent = courseCode;\n    document.getElementById('modalCourseCodeInput').value = courseCode;\n    document.getElementById('modalEnrollmentKey').value = '';\n    document.getElementById('enrollmentModal').style.display = 'block';\n    document.getElementById('modalEnrollmentKey').focus();\n}\n\nfunction closeEnrollmentModal() {\n    document.getElementById('enrollmentModal').style.display = 'none';\n}\n\nfunction viewCourseDetails(courseId) {\n    window.location.href = '{{ url_for(\"student_browse_courses\") }}#course-' + courseId;\n}\n\n// Set current date\ndocument.addEventListener('DOMContentLoaded', function() {\n    const now = new Date();\n    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };\n    document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);\n    \n    // Initialize progress animations\n    initializeProgressAnimations();\n});\n\n// Function to initialize progress animations\nfunction initializeProgressAnimations() {\n    const progressBars = document.querySelectorAll('.progress-fill');\n    \n    progressBars.forEach(bar => {\n        // Add a slight delay to make the animation more noticeable\n        setTimeout(() => {\n            const width = bar.style.width;\n            bar.style.width = '0%';\n            \n            // Animate to the actual width\n            setTimeout(() => {\n                bar.style.width = width;\n            }, 300);\n        }, 500);\n    });\n}\n\n// Function to simulate progress update\nfunction simulateProgressUpdate(courseCode, newProgress) {\n    const courseItems = document.querySelectorAll('.course-item');\n    \n    courseItems.forEach(item => {\n        const codeElement = item.querySelector('.course-code');\n        if (codeElement && codeElement.textContent === courseCode) {\n            const progressFill = item.querySelector('.progress-fill');\n            const progressPercentage = item.querySelector('.progress-percentage');\n            \n            if (progressFill) {\n                progressFill.style.width = `${newProgress}%`;\n                \n                // Add a glow effect\n                progressFill.style.animation = 'progress-glow 1s ease';\n                \n                // Remove animation after it completes\n                setTimeout(() => {\n                    progressFill.style.animation = '';\n                }, 1000);\n            }\n        }\n    });\n}\n\n// Close modal when clicking outside\nwindow.addEventListener('click', function(event) {\n    const modal = document.getElementById('enrollmentModal');\n    if (event.target === modal) {\n        closeEnrollmentModal();\n    }\n});\n\n// Close modal on escape key\ndocument.addEventListener('keydown', function(event) {\n    if (event.key === 'Escape') {\n        closeEnrollmentModal();\n    }\n});\n\n// Demo function to show progress animation (remove in production)\nfunction demoProgressAnimation() {\n    setTimeout(() => {\n        simulateProgressUpdate('CS101', 75);\n    }, 2000);\n    \n    setTimeout(() => {\n        simulateProgressUpdate('MATH201', 45);\n    }, 4000);\n}\n\n// Initialize demo on page load (remove in production)\ndocument.addEventListener('DOMContentLoaded', function() {\n    // Uncomment the line below to see demo progress animations\n    // demoProgressAnimation();\n});\n</script>\n","size_bytes":29854},"ghalib/README.md":{"content":"# LearnNest - AI-Powered Learning Management System\n\n## ðŸŽ“ Complete Working Version\n\nThis is the fully functional LearnNest Learning Management System with Google Gemini AI integration and quiz ranking features.\n\n## âœ¨ Features\n\n### Core Features\n- **User Role Management**: Admin, Instructor, and Student roles with specific permissions\n- **Course Management**: Create, edit, and manage courses with video playlists\n- **Video Playlist Management**: YouTube integration with AI transcript generation\n- **Quiz System**: MCQ quizzes with AI-powered auto-grading\n- **Quiz Rankings/Leaderboard**: Students can view course rankings based on quiz performance\n- **Discussion Forums**: Course-specific forums for student interaction\n- **Real-time Messaging**: Socket.IO powered chat system\n- **Notifications**: Real-time notifications for course activities\n\n### AI-Powered Features (Google Gemini)\n- **Automated Quiz Grading**: AI evaluates quiz submissions with detailed feedback\n- **MCQ Auto-Correction**: Instructors don't need to manually select correct answers\n- **AI Study Notes Generation**: Generate comprehensive notes from video content\n- **Video Transcript Analysis**: Automatic transcript generation from YouTube videos\n- **Intelligent Answer Detection**: AI detects correct answers in MCQ questions\n\n### UI/UX\n- **iOS-Inspired Dark Theme**: Modern, sleek interface with glassmorphism effects\n- **Cyberpunk Course View**: Futuristic design for course content pages\n- **Responsive Design**: Works on all devices and screen sizes\n- **Interactive Animations**: Smooth transitions and engaging visual effects\n\n## ðŸ“ Project Structure\n\n```\nghalib/\nâ”œâ”€â”€ app.py                  # Main Flask application\nâ”œâ”€â”€ gemini_ai.py           # Google Gemini AI integration\nâ”œâ”€â”€ pyproject.toml         # Python dependencies\nâ”œâ”€â”€ requirements.txt       # Alternative dependencies file\nâ”œâ”€â”€ uv.lock               # Dependency lock file\nâ”œâ”€â”€ start.sh              # Startup script\nâ”œâ”€â”€ templates/            # Jinja2 HTML templates\nâ”‚   â”œâ”€â”€ admin/           # Admin dashboard templates\nâ”‚   â”œâ”€â”€ instructor/      # Instructor interface templates\nâ”‚   â”œâ”€â”€ student/         # Student interface templates\nâ”‚   â”‚   â”œâ”€â”€ course_view.html        # Course content view\nâ”‚   â”‚   â”œâ”€â”€ course_rankings.html   # Quiz leaderboard\nâ”‚   â”‚   â”œâ”€â”€ take_quiz.html         # Quiz taking interface\nâ”‚   â”‚   â””â”€â”€ ...\nâ”‚   â”œâ”€â”€ auth/            # Login/Register pages\nâ”‚   â”œâ”€â”€ errors/          # Error pages\nâ”‚   â””â”€â”€ base.html        # Base template\nâ”œâ”€â”€ static/              # Static assets\nâ”‚   â”œâ”€â”€ css/            # Stylesheets\nâ”‚   â”œâ”€â”€ js/             # JavaScript files\nâ”‚   â”œâ”€â”€ images/         # Image assets\nâ”‚   â””â”€â”€ fonts/          # Custom fonts\nâ”œâ”€â”€ sir_rafique/        # Data directory\nâ”‚   â”œâ”€â”€ learnnest.db    # SQLite database\nâ”‚   â””â”€â”€ uploads/        # Uploaded files\nâ”‚       â”œâ”€â”€ assignments/\nâ”‚       â”œâ”€â”€ resources/\nâ”‚       â”œâ”€â”€ transcripts/\nâ”‚       â”œâ”€â”€ profile_pictures/\nâ”‚       â””â”€â”€ chat_files/\nâ””â”€â”€ utils/              # Utility modules\n    â”œâ”€â”€ __init__.py\n    â””â”€â”€ pdf_generator.py\n```\n\n## ðŸš€ Installation & Setup\n\n### Prerequisites\n- Python 3.11+\n- Google Gemini API Key\n\n### Environment Variables\nCreate a `.env` file or set these in Replit Secrets:\n```env\nSESSION_SECRET=your-session-secret-key\nGEMINI_API_KEY=your-google-gemini-api-key\n```\n\n### Install Dependencies\n```bash\npip install -r requirements.txt\n```\n\n### Run the Application\n```bash\npython app.py\n```\n\nThe application will run on `http://0.0.0.0:5000`\n\n## ðŸŽ¯ Key Features Added\n\n### Quiz Rankings Feature\n- Added \"QUIZ RANKINGS\" action card in course view\n- Students can view leaderboard based on quiz performance\n- Rankings show:\n  - Top 3 podium display\n  - Complete rankings table\n  - Performance metrics (average score, quizzes completed)\n  - Performance insights and class statistics\n\n### Enhanced Quiz Styling\n- Modern glassmorphism effects\n- Smooth animations and transitions\n- Interactive option selection\n- Progress indicators\n- Responsive design\n\n## ðŸ“Š Database\n\nThe application uses SQLite database (`sir_rafique/learnnest.db`) with the following main tables:\n- `users` - User accounts (admin, instructor, student)\n- `courses` - Course information\n- `enrollments` - Student course enrollments\n- `quizzes` - Quiz definitions\n- `quiz_submissions` - Student quiz attempts\n- `video_playlist` - Course video content\n- `discussion_forums` - Forum topics and posts\n- `messages` - Direct messaging\n- `notifications` - User notifications\n\n## ðŸŽ¨ UI Theme\n\nThe application uses a modern dark theme with:\n- iOS-inspired color palette\n- Glassmorphism effects\n- Smooth animations\n- Neon accents for important elements\n- Cyberpunk aesthetic for course views\n\n## ðŸ” Default Access\n\nThe database includes pre-configured user accounts for testing. Check the database for credentials or create new accounts through the registration page.\n\n## ðŸ¤– AI Integration\n\nGoogle Gemini AI is used for:\n1. **Quiz Grading**: Automatic evaluation of student answers\n2. **MCQ Generation**: AI suggests correct answers\n3. **Transcript Generation**: Convert YouTube videos to text\n4. **Study Notes**: Generate comprehensive study materials\n\n## ðŸ“ Notes\n\n- All AI features require a valid GEMINI_API_KEY\n- The application uses Flask-SocketIO for real-time features\n- File uploads are stored in `sir_rafique/uploads/`\n- The system supports multiple file types (PDF, images, videos, etc.)\n\n## ðŸ› ï¸ Technology Stack\n\n- **Backend**: Flask, Flask-SocketIO, Flask-Login\n- **Database**: SQLite\n- **AI**: Google Gemini API\n- **Frontend**: HTML5, CSS3, JavaScript\n- **Real-time**: Socket.IO\n- **PDF Generation**: ReportLab\n- **Video Processing**: PyTubeFix, yt-dlp\n\n## ðŸ“„ License\n\nEducational project for learning management.\n\n---\n\n**Developed with â¤ï¸ for modern education**\n","size_bytes":6025},"LearnNestGemini/pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"flask>=3.1.2\",\n    \"flask-caching>=2.3.1\",\n    \"flask-login>=0.6.3\",\n    \"flask-mail>=0.10.0\",\n    \"flask-socketio>=5.5.1\",\n    \"google-genai>=1.52.0\",\n    \"pillow>=12.0.0\",\n    \"python-dotenv>=1.2.1\",\n    \"python-engineio>=4.12.3\",\n    \"python-socketio>=5.15.0\",\n    \"pytubefix>=10.3.5\",\n    \"reportlab>=4.4.5\",\n    \"requests>=2.32.5\",\n    \"werkzeug>=3.1.3\",\n]\n","size_bytes":509},"start.sh":{"content":"#!/bin/bash\ncd /home/runner/weather-app-abdulwaheed\npython3 app.py\n","size_bytes":67},"templates/student/video_download/tailwind.config.js":{"content":"/** @type {import('tailwindcss').Config} */\nmodule.exports = {\n  content: [\"./templates/*\"],\n  theme: {\n    extend: {},\n  },\n  plugins: [],\n}\n\n","size_bytes":143},"LearnNestGemini/weather-app-abdulwaheed/templates/student/video_download/static/src/input.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;","size_bytes":58},"LearnNestGemini/replit.md":{"content":"# LearnNest - Learning Management System\n\n## Overview\n\nLearnNest is a comprehensive Learning Management System (LMS) built with Flask that facilitates online education through course management, real-time communication, AI-powered features, and interactive assessments. The platform supports three user roles: students, instructors, and administrators, each with distinct capabilities and interfaces.\n\nThe system enables instructors to create and manage courses, upload educational content (videos, documents), create quizzes, track student progress, and engage with students through discussion forums and live chat. Students can browse and enroll in courses, view content, take quizzes, participate in discussions, and track their learning progress. Administrators oversee the platform, managing user accounts and approving instructor applications.\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Frontend Architecture\n\n**Technology Stack**: The frontend uses server-side rendering with Jinja2 templates, styled with custom CSS featuring a dark iOS-inspired design system. Real-time interactivity is achieved through Socket.IO for WebSocket connections.\n\n**Design System**: LearnNest implements a comprehensive dark theme with iOS-style aesthetics, featuring:\n- Custom CSS variables for consistent theming across all pages\n- Gradient accents and neon effects for a modern cyberpunk aesthetic\n- Responsive design patterns for mobile and desktop experiences\n- Reusable component styles for cards, buttons, forms, and navigation elements\n\n**Template Structure**: The application uses a base template (`base.html`) that provides:\n- Common navigation bar with role-based menu items\n- Flash message system for user feedback\n- Socket.IO initialization for real-time features\n- Global CSS variables and styling framework\n\nRole-specific templates extend this base to provide specialized dashboards and functionality for students, instructors, and administrators.\n\n### Backend Architecture\n\n**Framework**: Flask web framework with the following key extensions:\n- **Flask-Login**: User session management and authentication\n- **Flask-SocketIO**: Real-time bidirectional communication for chat and notifications\n- **Flask-Caching**: Simple in-memory caching for performance optimization\n- **Flask-Mail**: Email functionality for notifications\n\n**Application Structure**: The main application logic resides in `app.py`, which handles:\n- Route definitions for all user-facing endpoints\n- Authentication and authorization logic\n- Real-time event handlers for Socket.IO\n- Business logic for course management, enrollment, quizzes, and discussions\n\n**Authentication & Authorization**: \n- Password hashing using Werkzeug's security utilities\n- Session-based authentication through Flask-Login\n- Role-based access control (RBAC) with decorators for route protection\n- Three-tier user system: student, instructor, admin\n\n**File Upload Management**: Supports multiple content types (videos, PDFs, images) with:\n- Secure filename handling via Werkzeug utilities\n- Organized storage in role-specific upload directories\n- No file size limits for video content\n- YouTube video download capability via pytubefix\n\n### Data Storage\n\n**Database**: SQLite database (`learnnest.db`) for persistent data storage.\n\n**Schema Design** (inferred from application logic):\n- **Users**: Authentication credentials, profile information, role designation, approval status\n- **Courses**: Course metadata, enrollment keys, instructor associations, approval status\n- **Enrollments**: Student-course relationships with approval workflow and progress tracking\n- **Content**: Course materials with file references, content types, and metadata\n- **Quizzes**: Quiz definitions with point values, due dates, and associated courses\n- **Quiz Submissions**: Student responses, scores, grading status, and AI-generated feedback\n- **Discussion Forums**: Hierarchical structure with forums, topics, and replies\n- **Messages**: Real-time chat messages for direct messaging and course discussions\n- **Notifications**: User notification system for platform events\n- **AI Notes**: Generated study materials with PDF storage\n\n**Data Relationships**:\n- One-to-many: Instructors to Courses, Courses to Content/Quizzes/Forums\n- Many-to-many: Students to Courses (through Enrollments)\n- Hierarchical: Forums â†’ Topics â†’ Replies\n\n### External Dependencies\n\n**AI Integration - Google Gemini**:\n- **Purpose**: Powers intelligent features including quiz grading, note generation, and content analysis\n- **API**: Google GenAI SDK (google-genai v0.3.0)\n- **Key Features**:\n  - Automated assignment grading with detailed feedback\n  - AI-generated study notes from course content\n  - Quiz generation from course materials\n  - JSON-structured responses for consistent data handling\n- **Configuration**: Requires `GEMINI_API_KEY` or `GOOGLE_GENAI_API_KEY` environment variable\n- **Model**: Uses Gemini 2.5 Flash/Pro series for optimal performance\n\n**Real-time Communication - Socket.IO**:\n- **Purpose**: Enables live chat, notifications, and real-time updates\n- **Implementation**: Flask-SocketIO with threading async mode\n- **Features**:\n  - Course discussion forums with live message delivery\n  - Direct messaging between users\n  - Community-wide chat functionality\n  - Real-time notification system\n  - User presence tracking (online/offline status)\n- **CORS**: Configured to allow all origins for development flexibility\n\n**PDF Generation - ReportLab**:\n- **Purpose**: Creates professional PDF documents for certificates, reports, and AI-generated notes\n- **Features**:\n  - Unicode font support (Noto Sans, Noto Sans Arabic) for multi-language content\n  - Support for English, Arabic, Urdu, Sindhi, and other Unicode languages\n  - Custom styling with LearnNest branding\n  - Professional document layouts\n- **Font Management**: Registers custom TTF fonts from static/fonts directory\n\n**Video Processing - PyTubeFix**:\n- **Purpose**: Downloads YouTube videos for course content\n- **Version**: 6.0.5\n- **Use Case**: Allows instructors to add YouTube videos to course materials\n\n**Email Service - Flask-Mail**:\n- **Purpose**: Sends notifications and system emails to users\n- **Configuration**: Requires SMTP settings (not yet configured in visible code)\n\n**Environment Configuration**:\n- **python-dotenv**: Loads environment variables from `.env` file\n- **Critical Variables**:\n  - `SESSION_SECRET`: Flask session encryption key\n  - `GEMINI_API_KEY`: Google Gemini API authentication\n  - Email server credentials (for Flask-Mail)\n\n**Image Processing - Pillow**:\n- **Purpose**: Image manipulation for user avatars and course thumbnails\n- **Version**: 10.0.0\n\n**HTTP Client - Requests**:\n- **Purpose**: External API calls and content fetching\n- **Version**: 2.31.0\n\n### Key Architectural Decisions\n\n**Monolithic Application Design**:\n- **Rationale**: All functionality consolidated in a single Flask application for simplicity and easier deployment\n- **Trade-offs**: Easier to develop and maintain for small-to-medium scale, but may require refactoring for horizontal scaling\n\n**SQLite Database Choice**:\n- **Rationale**: Lightweight, serverless database ideal for development and small-to-medium deployments\n- **Alternatives Considered**: PostgreSQL for production scalability\n- **Migration Path**: Database logic is abstracted enough to allow future migration to PostgreSQL or other RDBMS\n\n**Real-time Features via WebSockets**:\n- **Rationale**: Socket.IO provides reliable bidirectional communication for chat and live updates\n- **Implementation**: Threading async mode chosen for compatibility with standard WSGI servers\n- **Benefits**: Enhanced user engagement through instant messaging and notifications\n\n**AI Integration Strategy**:\n- **Rationale**: Gemini AI selected for advanced language understanding and structured output capabilities\n- **Use Cases**: Automated grading reduces instructor workload while providing detailed feedback; note generation enhances student learning resources\n- **Design Pattern**: Lazy client initialization prevents application crashes when API keys are missing during development\n\n**Role-Based Access Control**:\n- **Implementation**: Three-tier system (student/instructor/admin) with decorator-based route protection\n- **Workflow**: Instructor accounts require admin approval before activation, preventing unauthorized teaching accounts\n- **Security**: Enrollment requires both course code and enrollment key, ensuring controlled access to course materials\n\n**File Storage Approach**:\n- **Organization**: Hierarchical directory structure under `uploads/` organized by content type and course\n- **Security**: Werkzeug's secure_filename prevents directory traversal attacks\n- **Scalability Consideration**: Local filesystem storage is suitable for current scale; cloud storage (S3, GCS) would be recommended for larger deployments\n\n**PDF Generation with Multi-language Support**:\n- **Rationale**: ReportLab with custom Unicode fonts enables global accessibility\n- **Implementation**: Automatic font selection based on character detection (Arabic/Urdu detection triggers NotoSansArabic)\n- **Benefit**: Supports diverse student populations with native language materials\n\n**Session Management**:\n- **Approach**: Server-side sessions with Flask-Login for stateful authentication\n- **Security**: Sessions encrypted with SECRET_KEY, remember-me functionality optional\n- **User Experience**: Persistent login reduces friction while maintaining security","size_bytes":9572},"ghalib/utils/pdf_generator.py":{"content":"\"\"\"\nPDF Generator with Beautiful Design for LearnNest LMS\nGenerates professional, stylish PDF documents with LearnNest branding\nSupports Unicode languages: English, Arabic, Urdu, Sindhi, and more\n\"\"\"\n\nfrom reportlab.lib.pagesizes import letter, A4\nfrom reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle\nfrom reportlab.lib.units import inch\nfrom reportlab.lib.enums import TA_CENTER, TA_LEFT, TA_JUSTIFY, TA_RIGHT\nfrom reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, PageBreak, Table, TableStyle\nfrom reportlab.lib import colors\nfrom reportlab.pdfgen import canvas\nfrom reportlab.pdfbase import pdfmetrics\nfrom reportlab.pdfbase.ttfonts import TTFont\nfrom datetime import datetime\nimport os\n\n# Register Unicode fonts for multi-language support\ntry:\n    # Get the absolute path to fonts directory\n    FONTS_DIR = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'static', 'fonts')\n    \n    # Register Noto Sans (for Latin, numbers, symbols)\n    noto_sans_path = os.path.join(FONTS_DIR, 'NotoSans.ttf')\n    if os.path.exists(noto_sans_path):\n        pdfmetrics.registerFont(TTFont('NotoSans', noto_sans_path))\n    \n    # Register Noto Sans Arabic (for Arabic, Urdu, Sindhi)\n    noto_arabic_path = os.path.join(FONTS_DIR, 'NotoSansArabic.ttf')\n    if os.path.exists(noto_arabic_path):\n        pdfmetrics.registerFont(TTFont('NotoSansArabic', noto_arabic_path))\n    \n    UNICODE_FONTS_AVAILABLE = True\nexcept Exception as e:\n    print(f\"Warning: Could not register Unicode fonts: {e}\")\n    UNICODE_FONTS_AVAILABLE = False\n\ndef get_font_for_text(text):\n    \"\"\"\n    Detect if text contains Arabic/Urdu/Sindhi characters and return appropriate font\n    \"\"\"\n    if not UNICODE_FONTS_AVAILABLE:\n        return 'Helvetica'\n    \n    # Check for Arabic/Urdu/Sindhi characters (Unicode range)\n    for char in text:\n        if '\\u0600' <= char <= '\\u06FF' or '\\u0750' <= char <= '\\u077F':\n            return 'NotoSansArabic'\n    \n    # Default to NotoSans for better Unicode support (including math symbols)\n    return 'NotoSans'\n\n\nclass BeautifulWatermarkedCanvas(canvas.Canvas):\n    \"\"\"Custom canvas with beautiful LearnNest branding and watermark\"\"\"\n    \n    def __init__(self, *args, add_watermark=True, custom_watermark=None, **kwargs):\n        canvas.Canvas.__init__(self, *args, **kwargs)\n        self.pages = []\n        self.add_watermark = add_watermark\n        self.custom_watermark = custom_watermark\n        \n    def showPage(self):\n        self.pages.append(dict(self.__dict__))\n        self._startPage()\n        \n    def save(self):\n        page_count = len(self.pages)\n        for page_num, page in enumerate(self.pages, start=1):\n            self.__dict__.update(page)\n            self.draw_page_design(page_num, page_count)\n            canvas.Canvas.showPage(self)\n        canvas.Canvas.save(self)\n        \n    def draw_page_design(self, page_num, total_pages):\n        \"\"\"Draw beautiful page design with watermark and branding - Enhanced with modern design\"\"\"\n        page_width, page_height = letter\n        \n        # Save the state\n        self.saveState()\n        \n        # === ENHANCED WATERMARK (Diagonal) ===\n        if self.add_watermark:\n            watermark_font = 'NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica-Bold'\n            try:\n                self.setFont(watermark_font, 80)\n            except:\n                self.setFont('Helvetica-Bold', 80)\n            \n            # Blue watermark with transparency\n            self.setFillColor(colors.HexColor(\"#0A84FF\"), alpha=0.12)\n            self.translate(page_width / 2, page_height / 2)\n            self.rotate(48)\n            watermark_text = \"LearnNest\"\n            self.drawCentredString(0, 0, watermark_text)\n            self.restoreState()\n            self.saveState()\n        \n        # === CUSTOM WATERMARK (Diagonal) - Student's Personal Watermark ===\n        if self.custom_watermark:\n            watermark_font = 'NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica-Bold'\n            try:\n                self.setFont(watermark_font, 60)\n            except:\n                self.setFont('Helvetica-Bold', 60)\n            \n            # Student's custom watermark in white with transparency\n            self.setFillColor(colors.white, alpha=0.08)\n            self.translate(page_width / 2, page_height / 2 - 100)\n            self.rotate(48)\n            self.drawCentredString(0, 0, self.custom_watermark)\n            self.restoreState()\n            self.saveState()\n        \n        # === PREMIUM HEADER DESIGN ===\n        # Gradient-effect header (dark to light purple)\n        self.setFillColor(colors.HexColor(\"#1a0033\"))\n        self.rect(0, page_height - 0.18 * inch, page_width, 0.18 * inch, fill=1, stroke=0)\n        \n        # Accent line\n        self.setFillColor(colors.HexColor(\"#00d4ff\"))\n        self.rect(0, page_height - 0.2 * inch, page_width, 0.02 * inch, fill=1, stroke=0)\n        \n        # LearnNest branding with modern font\n        brand_font = 'NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica-Bold'\n        try:\n            self.setFont(brand_font, 16)\n        except:\n            self.setFont('Helvetica-Bold', 16)\n        self.setFillColor(colors.white)\n        self.drawString(0.75 * inch, page_height - 0.14 * inch, \"LearnNest\")\n        \n        # Tagline with sky blue accent\n        try:\n            self.setFont('NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica', 8)\n        except:\n            self.setFont('Helvetica', 8)\n        self.setFillColor(colors.HexColor(\"#00d4ff\"))\n        self.drawString(0.75 * inch, page_height - 0.32 * inch, \"Empowering Learning Through AI\")\n        \n        # === PREMIUM FOOTER DESIGN ===\n        # Footer gradient bar\n        self.setFillColor(colors.HexColor(\"#1a0033\"))\n        self.rect(0, 0, page_width, 0.55 * inch, fill=1, stroke=0)\n        \n        # Sky blue accent line\n        self.setFillColor(colors.HexColor(\"#00d4ff\"))\n        self.rect(0, 0.55 * inch, page_width, 0.02 * inch, fill=1, stroke=0)\n        \n        # Page number with modern styling\n        try:\n            self.setFont('NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica', 10)\n        except:\n            self.setFont('Helvetica', 10)\n        self.setFillColor(colors.white)\n        footer_text = f\"Page {page_num} of {total_pages}\"\n        self.drawCentredString(page_width / 2, 0.35 * inch, footer_text)\n        \n        # Copyright text with sky blue\n        try:\n            self.setFont('NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica', 7)\n        except:\n            self.setFont('Helvetica', 7)\n        self.setFillColor(colors.HexColor(\"#00d4ff\"))\n        self.drawCentredString(page_width / 2, 0.2 * inch, \"Â© LearnNest LMS - AI Generated Content\")\n\n\ndef generate_transcript_pdf(transcript_text, video_title, course_name, student_name, output_path, add_watermark=True, custom_watermark=None):\n    \"\"\"\n    Generate a stunning, professional PDF transcript with LearnNest branding and modern design\n    \n    Args:\n        transcript_text (str): The AI-generated transcript content\n        video_title (str): Title of the video\n        course_name (str): Name of the course\n        student_name (str): Name of the student downloading the transcript\n        output_path (str): Full path where the PDF should be saved\n        add_watermark (bool): Whether to add LearnNest watermark (default: True)\n    \n    Returns:\n        bool: True if successful, False otherwise\n    \"\"\"\n    try:\n        # Ensure directory exists\n        os.makedirs(os.path.dirname(output_path), exist_ok=True)\n        \n        # Create the PDF document with custom canvas and enhanced margins\n        doc = SimpleDocTemplate(\n            output_path,\n            pagesize=letter,\n            rightMargin=0.8*inch,\n            leftMargin=0.8*inch,\n            topMargin=1.0*inch,\n            bottomMargin=1.0*inch\n        )\n        \n        # Container for the 'Flowable' objects\n        story = []\n        \n        # Define custom styles\n        styles = getSampleStyleSheet()\n        \n        # Detect language for font selection\n        content_font = get_font_for_text(transcript_text + video_title)\n        \n        # === STUNNING TITLE STYLE ===\n        title_style = ParagraphStyle(\n            'BeautifulTitle',\n            parent=styles['Heading1'],\n            fontSize=28,\n            textColor=colors.HexColor(\"#1a0033\"),\n            spaceAfter=12,\n            spaceBefore=6,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=32,\n            borderPadding=12,\n            borderColor=colors.HexColor(\"#00d4ff\"),\n            borderWidth=0.5\n        )\n        \n        # === MODERN SUBTITLE STYLE ===\n        subtitle_style = ParagraphStyle(\n            'SubtitleStyle',\n            parent=styles['Normal'],\n            fontSize=13,\n            textColor=colors.HexColor(\"#555555\"),\n            spaceAfter=24,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=16\n        )\n        \n        # === INFO BOX STYLE ===\n        info_label_style = ParagraphStyle(\n            'InfoLabel',\n            parent=styles['Normal'],\n            fontSize=10,\n            textColor=colors.HexColor(\"#00d4ff\"),\n            fontName=content_font,\n            spaceAfter=2\n        )\n        \n        info_value_style = ParagraphStyle(\n            'InfoValue',\n            parent=styles['Normal'],\n            fontSize=11,\n            textColor=colors.HexColor(\"#1a0033\"),\n            fontName=content_font,\n            spaceAfter=8\n        )\n        \n        # === VVIP PROFESSIONAL HEADING STYLE (CENTERED) ===\n        heading_style = ParagraphStyle(\n            'VVIPHeading',\n            parent=styles['Heading2'],\n            fontSize=16,\n            textColor=colors.HexColor(\"#FFFFFF\"),\n            spaceAfter=16,\n            spaceBefore=20,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            borderPadding=12,\n            borderColor=colors.HexColor(\"#0A84FF\"),\n            borderWidth=2,\n            backColor=colors.HexColor(\"#1a0033\"),\n            leading=20,\n            borderRadius=8\n        )\n        \n        # === PREMIUM BODY STYLE ===\n        body_style = ParagraphStyle(\n            'BeautifulBody',\n            parent=styles['BodyText'],\n            fontSize=10.5,\n            alignment=TA_JUSTIFY,\n            spaceAfter=12,\n            leading=20,\n            textColor=colors.HexColor(\"#1a1a1a\"),\n            fontName=content_font,\n            borderPadding=6\n        )\n        \n        # === DOCUMENT HEADER ===\n        story.append(Spacer(1, 0.2*inch))\n        \n        # Main Title with modern styling\n        title = Paragraph(f'<b>{video_title}</b>', title_style)\n        story.append(title)\n        \n        # Document Type Subtitle\n        subtitle_text = 'Study Notes & Transcript'\n        if 'Study Notes' in video_title or 'notes' in video_title.lower():\n            subtitle_text = 'AI-Generated Study Notes'\n        elif 'transcript' in video_title.lower():\n            subtitle_text = 'AI-Generated Transcript'\n        \n        subtitle = Paragraph(subtitle_text, subtitle_style)\n        story.append(subtitle)\n        \n        story.append(Spacer(1, 0.25*inch))\n        \n        # === INFORMATION BOX ===\n        # Create a beautiful info table\n        info_data = [\n            [Paragraph('<b>Student Name:</b>', info_label_style), Paragraph(student_name, info_value_style)],\n            [Paragraph('<b>Course:</b>', info_label_style), Paragraph(course_name, info_value_style)],\n            [Paragraph('<b>Generated On:</b>', info_label_style), \n             Paragraph(datetime.now().strftime(\"%B %d, %Y at %I:%M %p\"), info_value_style)]\n        ]\n        \n        info_table = Table(info_data, colWidths=[1.5*inch, 4.5*inch])\n        info_table.setStyle(TableStyle([\n            ('BACKGROUND', (0, 0), (0, -1), colors.HexColor(\"#e6f7ff\")),\n            ('BACKGROUND', (1, 0), (-1, -1), colors.HexColor(\"#f0f8ff\")),\n            ('BOX', (0, 0), (-1, -1), 1.5, colors.HexColor(\"#00d4ff\")),\n            ('LEFTPADDING', (0, 0), (-1, -1), 12),\n            ('RIGHTPADDING', (0, 0), (-1, -1), 12),\n            ('TOPPADDING', (0, 0), (-1, -1), 12),\n            ('BOTTOMPADDING', (0, 0), (-1, -1), 12),\n            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),\n            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),\n            ('FONTNAME', (0, 0), (-1, -1), content_font),\n            ('FONTSIZE', (0, 0), (-1, -1), 10),\n            ('ROWBACKGROUNDS', (0, 0), (-1, -1), [colors.white, colors.HexColor(\"#f0f8ff\")]),\n        ]))\n        \n        story.append(info_table)\n        story.append(Spacer(1, 0.4*inch))\n        \n        # === CONTENT DIVIDER ===\n        story.append(Spacer(1, 0.15*inch))\n        \n        # === TRANSCRIPT CONTENT HEADER ===\n        content_header = Paragraph(\n            '<b>ðŸ“š  CONTENT  ðŸ“š</b>',\n            ParagraphStyle(\n                'ContentHeader',\n                parent=styles['Normal'],\n                fontSize=13,\n                textColor=colors.HexColor(\"#FFFFFF\"),\n                alignment=TA_CENTER,\n                spaceAfter=20,\n                fontName=content_font,\n                borderColor=colors.HexColor(\"#00d4ff\"),\n                borderWidth=1.5,\n                backColor=colors.HexColor(\"#1a0033\"),\n                borderPadding=8,\n                leading=16\n            )\n        )\n        story.append(content_header)\n        story.append(Spacer(1, 0.15*inch))\n        \n        # === PROCESS TRANSCRIPT TEXT ===\n        sections = transcript_text.split('\\n\\n')\n        \n        for section in sections:\n            section = section.strip()\n            if not section:\n                continue\n            \n            lines = section.split('\\n')\n            first_line = lines[0].strip()\n            \n            # Check if this is a header\n            if (first_line.isupper() and len(first_line) < 60) or \\\n               (first_line and first_line[0].isdigit() and '.' in first_line[:5]):\n                # This is a VVIP heading - centered with elegant decorations\n                heading_text = f'âœ¦  {first_line}  âœ¦'\n                heading = Paragraph(heading_text, heading_style)\n                story.append(heading)\n                \n                # Add the rest as body text\n                if len(lines) > 1:\n                    body_text = '\\n'.join(lines[1:])\n                    para = Paragraph(body_text.replace('\\n', '<br/>'), body_style)\n                    story.append(para)\n            else:\n                # Regular paragraph\n                para = Paragraph(section.replace('\\n', '<br/>'), body_style)\n                story.append(para)\n            \n            story.append(Spacer(1, 0.1*inch))\n        \n        # === FOOTER NOTE ===\n        story.append(Spacer(1, 0.4*inch))\n        \n        # === PREMIUM FOOTER NOTE ===\n        story.append(Spacer(1, 0.4*inch))\n        \n        footer_note_style = ParagraphStyle(\n            'FooterNote',\n            parent=styles['Normal'],\n            fontSize=9,\n            textColor=colors.HexColor(\"#1a1a1a\"),\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=14,\n            borderWidth=2,\n            borderColor=colors.HexColor(\"#00d4ff\"),\n            borderPadding=12,\n            backColor=colors.HexColor(\"#e6f7ff\")\n        )\n        \n        footer_note = Paragraph(\n            '<b>âœ“ Quality Assurance:</b> This document was generated using advanced Gemini AI technology. '\n            'For best results, cross-reference key concepts with original video content. '\n            '<br/><b>ðŸŽ“ Use This For:</b> Study reference, exam preparation, knowledge review, and learning reinforcement.'\n            '<br/><i>LearnNest - Empowering Learning Through AI Technology</i>',\n            footer_note_style\n        )\n        story.append(footer_note)\n        \n        # Build PDF with beautiful watermarked canvas\n        def make_canvas(*args, **kwargs):\n            return BeautifulWatermarkedCanvas(*args, add_watermark=add_watermark, custom_watermark=custom_watermark, **kwargs)\n        \n        doc.build(story, canvasmaker=make_canvas)\n        \n        return True\n        \n    except Exception as e:\n        print(f\"Error generating beautiful PDF: {e}\")\n        return False\n\n\ndef generate_notes_pdf(notes_content, topic, teacher_name, output_path, add_watermark=True, custom_watermark=None):\n    \"\"\"\n    Generate a stunning, professional PDF for AI-generated notes with LearnNest branding\n    \n    Args:\n        notes_content (str): The AI-generated notes content (can be markdown formatted)\n        topic (str): The topic/subject of the notes\n        teacher_name (str): Name of the instructor/teacher\n        output_path (str): Full path where the PDF should be saved\n        add_watermark (bool): Whether to add LearnNest watermark (default: True)\n        custom_watermark (str): Custom watermark text from student (optional)\n    \n    Returns:\n        bool: True if successful, False otherwise\n    \"\"\"\n    try:\n        # Ensure directory exists\n        os.makedirs(os.path.dirname(output_path), exist_ok=True)\n        \n        # Create the PDF document with custom canvas\n        doc = SimpleDocTemplate(\n            output_path,\n            pagesize=letter,\n            rightMargin=0.8*inch,\n            leftMargin=0.8*inch,\n            topMargin=1.0*inch,\n            bottomMargin=1.0*inch\n        )\n        \n        # Container for the 'Flowable' objects\n        story = []\n        \n        # Define custom styles\n        styles = getSampleStyleSheet()\n        \n        # Detect language for font selection\n        content_font = get_font_for_text(notes_content + topic)\n        \n        # === TITLE STYLE ===\n        title_style = ParagraphStyle(\n            'NotesTitle',\n            parent=styles['Heading1'],\n            fontSize=28,\n            textColor=colors.HexColor(\"#1a0033\"),\n            spaceAfter=12,\n            spaceBefore=6,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=32,\n            borderPadding=12,\n            borderColor=colors.HexColor(\"#00d4ff\"),\n            borderWidth=0.5\n        )\n        \n        # === SUBTITLE STYLE ===\n        subtitle_style = ParagraphStyle(\n            'NotesSubtitle',\n            parent=styles['Normal'],\n            fontSize=13,\n            textColor=colors.HexColor(\"#555555\"),\n            spaceAfter=20,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=16\n        )\n        \n        # === TEACHER NAME STYLE ===\n        teacher_style = ParagraphStyle(\n            'TeacherName',\n            parent=styles['Normal'],\n            fontSize=14,\n            textColor=colors.HexColor(\"#00d4ff\"),\n            spaceAfter=24,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=16\n        )\n        \n        # === VVIP HEADING STYLE (CENTERED) ===\n        heading_style = ParagraphStyle(\n            'VVIPNotesHeading',\n            parent=styles['Heading2'],\n            fontSize=16,\n            textColor=colors.HexColor(\"#FFFFFF\"),\n            spaceAfter=16,\n            spaceBefore=20,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            borderPadding=12,\n            borderColor=colors.HexColor(\"#0A84FF\"),\n            borderWidth=2,\n            backColor=colors.HexColor(\"#1a0033\"),\n            leading=20,\n            borderRadius=8\n        )\n        \n        # === BODY STYLE ===\n        body_style = ParagraphStyle(\n            'NotesBody',\n            parent=styles['BodyText'],\n            fontSize=10.5,\n            alignment=TA_JUSTIFY,\n            spaceAfter=12,\n            leading=20,\n            textColor=colors.HexColor(\"#1a1a1a\"),\n            fontName=content_font,\n            borderPadding=6\n        )\n        \n        # === DOCUMENT HEADER ===\n        story.append(Spacer(1, 0.2*inch))\n        \n        # Main Title\n        title = Paragraph(f'<b>{topic}</b>', title_style)\n        story.append(title)\n        \n        # Subtitle\n        subtitle = Paragraph('AI-Generated Study Notes', subtitle_style)\n        story.append(subtitle)\n        \n        # Teacher Name\n        if teacher_name:\n            teacher_para = Paragraph(f'<b>By: {teacher_name}</b>', teacher_style)\n            story.append(teacher_para)\n        \n        story.append(Spacer(1, 0.3*inch))\n        \n        # === INFO BOX ===\n        info_data = [\n            [Paragraph('<b>Generated On:</b>', subtitle_style), \n             Paragraph(datetime.now().strftime(\"%B %d, %Y at %I:%M %p\"), subtitle_style)]\n        ]\n        \n        info_table = Table(info_data, colWidths=[1.5*inch, 4.5*inch])\n        info_table.setStyle(TableStyle([\n            ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor(\"#e6f7ff\")),\n            ('BOX', (0, 0), (-1, -1), 1.5, colors.HexColor(\"#00d4ff\")),\n            ('LEFTPADDING', (0, 0), (-1, -1), 12),\n            ('RIGHTPADDING', (0, 0), (-1, -1), 12),\n            ('TOPPADDING', (0, 0), (-1, -1), 10),\n            ('BOTTOMPADDING', (0, 0), (-1, -1), 10),\n            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),\n            ('FONTNAME', (0, 0), (-1, -1), content_font),\n        ]))\n        \n        story.append(info_table)\n        story.append(Spacer(1, 0.4*inch))\n        \n        # === CONTENT DIVIDER ===\n        content_header = Paragraph(\n            '<b>ðŸ“š  STUDY NOTES  ðŸ“š</b>',\n            ParagraphStyle(\n                'ContentHeader',\n                parent=styles['Normal'],\n                fontSize=13,\n                textColor=colors.HexColor(\"#FFFFFF\"),\n                alignment=TA_CENTER,\n                spaceAfter=20,\n                fontName=content_font,\n                borderColor=colors.HexColor(\"#00d4ff\"),\n                borderWidth=1.5,\n                backColor=colors.HexColor(\"#1a0033\"),\n                borderPadding=8,\n                leading=16\n            )\n        )\n        story.append(content_header)\n        story.append(Spacer(1, 0.15*inch))\n        \n        # === PROCESS NOTES CONTENT ===\n        # Handle markdown-style formatting\n        sections = notes_content.split('\\n\\n')\n        \n        for section in sections:\n            section = section.strip()\n            if not section:\n                continue\n            \n            lines = section.split('\\n')\n            first_line = lines[0].strip()\n            \n            # Check for markdown headers\n            if first_line.startswith('# '):\n                heading_text = f'âœ¦  {first_line[2:]}  âœ¦'\n                heading = Paragraph(heading_text, heading_style)\n                story.append(heading)\n                \n                if len(lines) > 1:\n                    body_text = '\\n'.join(lines[1:])\n                    para = Paragraph(body_text.replace('\\n', '<br/>'), body_style)\n                    story.append(para)\n            elif first_line.startswith('## '):\n                heading_text = f'âœ¦  {first_line[3:]}  âœ¦'\n                heading = Paragraph(heading_text, heading_style)\n                story.append(heading)\n                \n                if len(lines) > 1:\n                    body_text = '\\n'.join(lines[1:])\n                    para = Paragraph(body_text.replace('\\n', '<br/>'), body_style)\n                    story.append(para)\n            elif first_line.startswith('### '):\n                heading_text = f'âœ¦  {first_line[4:]}  âœ¦'\n                heading = Paragraph(heading_text, heading_style)\n                story.append(heading)\n                \n                if len(lines) > 1:\n                    body_text = '\\n'.join(lines[1:])\n                    para = Paragraph(body_text.replace('\\n', '<br/>'), body_style)\n                    story.append(para)\n            else:\n                # Process regular content with bold markers - properly handle markdown\n                content = section\n                # Replace **text** with <b>text</b>\n                import re\n                content = re.sub(r'\\*\\*(.+?)\\*\\*', r'<b>\\1</b>', content)\n                # Escape any remaining asterisks\n                content = content.replace('*', 'â€¢')\n                para = Paragraph(content.replace('\\n', '<br/>'), body_style)\n                story.append(para)\n            \n            story.append(Spacer(1, 0.1*inch))\n        \n        # === FOOTER NOTE ===\n        story.append(Spacer(1, 0.4*inch))\n        \n        footer_note_style = ParagraphStyle(\n            'FooterNote',\n            parent=styles['Normal'],\n            fontSize=9,\n            textColor=colors.HexColor(\"#1a1a1a\"),\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=14,\n            borderWidth=2,\n            borderColor=colors.HexColor(\"#00d4ff\"),\n            borderPadding=12,\n            backColor=colors.HexColor(\"#e6f7ff\")\n        )\n        \n        footer_note = Paragraph(\n            '<b>âœ“ AI-Generated Content:</b> These notes were created using advanced Gemini AI technology. '\n            'Review and supplement with additional resources for comprehensive understanding. '\n            '<br/><b>ðŸŽ“ Use This For:</b> Study reference, exam preparation, concept review, and knowledge reinforcement.'\n            '<br/><i>LearnNest - Empowering Learning Through AI Technology</i>',\n            footer_note_style\n        )\n        story.append(footer_note)\n        \n        # Build PDF with beautiful watermarked canvas\n        def make_canvas(*args, **kwargs):\n            return BeautifulWatermarkedCanvas(*args, add_watermark=add_watermark, custom_watermark=custom_watermark, **kwargs)\n        \n        doc.build(story, canvasmaker=make_canvas)\n        \n        return True\n        \n    except Exception as e:\n        print(f\"Error generating notes PDF: {e}\")\n        return False\n","size_bytes":25870},"LearnNestGemini/main.py":{"content":"def main():\n    print(\"Hello from repl-nix-workspace!\")\n\n\nif __name__ == \"__main__\":\n    main()\n","size_bytes":96},"ghalib/start.sh":{"content":"#!/bin/bash\ncd /home/runner/weather-app-abdulwaheed\npython3 app.py\n","size_bytes":67},"LearnNestGemini/weather-app-abdulwaheed/pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"eventlet>=0.40.3\",\n    \"flask>=3.1.2\",\n    \"flask-caching>=2.3.1\",\n    \"flask-login>=0.6.3\",\n    \"flask-mail>=0.10.0\",\n    \"flask-socketio>=5.5.1\",\n    \"google-genai>=1.36.0\",\n    \"gunicorn>=23.0.0\",\n    \"nltk>=3.9.1\",\n    \"numpy>=2.3.3\",\n    \"pandas>=2.3.2\",\n    \"pillow>=11.3.0\",\n    \"pypdf2>=3.0.1\",\n    \"python-dotenv>=1.1.1\",\n    \"pytubefix>=10.3.5\",\n    \"reportlab>=4.4.5\",\n    \"sift-stack-py>=0.8.5\",\n    \"werkzeug>=3.1.3\",\n    \"yt-dlp>=2024.12.23\",\n]\n","size_bytes":606},"LearnNestGemini/weather-app-abdulwaheed/static/css/dashboard.css":{"content":"/* iOS Dark Theme Variables - Override base.html vars for this page */\n:root {\n    /* iOS Dark Theme Colors */\n    --black: #000000;\n    --white: #ffffff;\n    --gray-100: #1c1c1e;\n    --gray-200: #2c2c2e;\n    --gray-300: #3a3a3c;\n    --gray-400: #48484a;\n    --gray-500: #636366;\n    --gray-600: #8e8e93;\n    \n    /* iOS Vibrant Accent Colors */\n    --primary: #0a84ff;\n    --success: #30d158;\n    --warning: #ff9f0a;\n    --danger: #ff453a;\n    --info: #64d2ff;\n    --purple: #bf5af2;\n    \n    /* Text Colors */\n    --text-primary: #ffffff;\n    --text-secondary: #ebebf5;\n    --text-light: #8e8e93;\n    \n    /* Background & Cards */\n    --background: var(--black);\n    --card-bg: #121212;\n    --card-hover: #1c1c1e;\n    --border: #2c2c2e;\n    \n    /* Shadows */\n    --shadow: 0 2px 8px rgba(0, 0, 0, 0.6);\n    --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.7);\n    --shadow-xl: 0 8px 32px rgba(0, 0, 0, 0.8);\n    \n    /* Gradients */\n    --gradient-primary: linear-gradient(135deg, #0a84ff 0%, #0066cc 100%);\n    --gradient-success: linear-gradient(135deg, #30d158 0%, #28a745 100%);\n    --gradient-warning: linear-gradient(135deg, #ff9f0a 0%, #ff8c00 100%);\n    --gradient-info: linear-gradient(135deg, #64d2ff 0%, #0891b2 100%);\n    \n    /* Border Radius */\n    --radius: 8px;\n    --radius-lg: 12px;\n    --radius-xl: 16px;\n}\n\n* {\n    box-sizing: border-box;\n    margin: 0;\n    padding: 0;\n}\n\nbody {\n    background: var(--black);\n    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', system-ui, sans-serif;\n    color: var(--text-primary);\n    line-height: 1.6;\n    min-height: 100vh;\n}\n\n/* Dashboard Layout */\n.dashboard-container {\n    max-width: 1400px;\n    margin: 0 auto;\n    padding: 2rem;\n    animation: fadeIn 0.8s ease-out;\n}\n\n@keyframes fadeIn {\n    from {\n        opacity: 0;\n        transform: translateY(20px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n.dashboard-header {\n    margin-bottom: 2.5rem;\n    background: var(--card-bg);\n    border-radius: var(--radius-xl);\n    padding: 2.5rem;\n    box-shadow: var(--shadow-lg);\n    border: 1px solid var(--border);\n    position: relative;\n    overflow: hidden;\n}\n\n.dashboard-header::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 3px;\n    background: var(--gradient-primary);\n    box-shadow: 0 0 10px var(--primary);\n}\n\n.welcome-section {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n}\n\n.welcome-content h1 {\n    margin-bottom: 0.75rem;\n    font-size: 2.5rem;\n    font-weight: 800;\n    background: var(--gradient-primary);\n    -webkit-background-clip: text;\n    -webkit-text-fill-color: transparent;\n    background-clip: text;\n    letter-spacing: -0.025em;\n}\n\n.welcome-message {\n    font-size: 1.2rem;\n    color: var(--text-secondary);\n    margin-bottom: 1.5rem;\n    font-weight: 500;\n}\n\n.date-badge {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.5rem;\n    background: var(--gray-100);\n    color: var(--text-secondary);\n    padding: 0.75rem 1.5rem;\n    border-radius: 1rem;\n    font-weight: 600;\n    font-size: 0.95rem;\n    border: 1px solid var(--border);\n    backdrop-filter: blur(10px);\n}\n\n.user-avatar {\n    display: flex;\n    align-items: center;\n}\n\n.avatar-container {\n    width: 90px;\n    height: 90px;\n    border-radius: 50%;\n    background: var(--gradient-primary);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 2.5rem;\n    border: 4px solid var(--primary);\n    box-shadow: var(--shadow-xl);\n    transition: transform 0.3s ease, box-shadow 0.3s ease;\n}\n\n.avatar-container:hover {\n    transform: scale(1.05);\n    box-shadow: var(--shadow-2xl);\n}\n\n/* Stats Grid */\n.stats-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));\n    gap: 1.75rem;\n    margin-bottom: 3rem;\n}\n\n.stat-card {\n    background: var(--card-bg);\n    border-radius: 1.25rem;\n    padding: 2rem;\n    display: flex;\n    align-items: center;\n    gap: 1.25rem;\n    box-shadow: var(--shadow-md);\n    border: 1px solid var(--border);\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n    overflow: hidden;\n}\n\n.stat-card::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 3px;\n    opacity: 0;\n    transition: opacity 0.3s ease;\n}\n\n.stat-card:hover {\n    box-shadow: var(--shadow-xl);\n    transform: translateY(-8px);\n    border-color: var(--gray-300);\n}\n\n.stat-card:hover::before {\n    opacity: 1;\n}\n\n.stat-primary::before { background: var(--gradient-primary); }\n.stat-success::before { background: var(--gradient-success); }\n.stat-warning::before { background: var(--gradient-warning); }\n.stat-info::before { background: var(--gradient-info); }\n\n.stat-icon {\n    width: 70px;\n    height: 70px;\n    border-radius: 1rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1.75rem;\n    flex-shrink: 0;\n    transition: transform 0.3s ease;\n}\n\n.stat-card:hover .stat-icon {\n    transform: scale(1.1);\n}\n\n.stat-primary .stat-icon { \n    background: rgba(10, 132, 255, 0.15);\n    color: var(--primary);\n    border: 1px solid rgba(10, 132, 255, 0.3);\n}\n.stat-success .stat-icon { \n    background: rgba(48, 209, 88, 0.15);\n    color: var(--success);\n    border: 1px solid rgba(48, 209, 88, 0.3);\n}\n.stat-warning .stat-icon { \n    background: rgba(255, 159, 10, 0.15);\n    color: var(--warning);\n    border: 1px solid rgba(255, 159, 10, 0.3);\n}\n.stat-info .stat-icon { \n    background: rgba(100, 210, 255, 0.15);\n    color: var(--info);\n    border: 1px solid rgba(100, 210, 255, 0.3);\n}\n\n.stat-content {\n    flex: 1;\n}\n\n.stat-number {\n    display: block;\n    font-size: 2.5rem;\n    font-weight: 900;\n    line-height: 1;\n    margin-bottom: 0.5rem;\n    color: var(--text-primary);\n    letter-spacing: -0.025em;\n}\n\n.stat-label {\n    color: var(--text-secondary);\n    font-weight: 600;\n    font-size: 0.95rem;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n}\n\n/* Dashboard Grid */\n.dashboard-grid {\n    display: grid;\n    grid-template-columns: 2fr 1fr;\n    gap: 2.5rem;\n    align-items: start;\n}\n\n/* Cards */\n.card {\n    background: var(--card-bg);\n    border-radius: 1.5rem;\n    box-shadow: var(--shadow-md);\n    border: 1px solid var(--border);\n    overflow: hidden;\n    display: flex;\n    flex-direction: column;\n    height: fit-content;\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n}\n\n.card::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 4px;\n    background: var(--gradient-primary);\n    opacity: 0;\n    transition: opacity 0.3s ease;\n}\n\n.card:hover::before {\n    opacity: 1;\n}\n\n.card:hover {\n    box-shadow: var(--shadow-xl);\n    transform: translateY(-4px);\n}\n\n.card-highlight {\n    border-left: 6px solid var(--primary);\n}\n\n.card-header {\n    padding: 2rem;\n    border-bottom: 1px solid var(--border);\n    background: var(--gray-100);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    flex-wrap: wrap;\n    gap: 1rem;\n}\n\n.card-title {\n    margin: 0;\n    font-size: 1.5rem;\n    color: var(--text-primary);\n    font-weight: 700;\n    letter-spacing: -0.025em;\n}\n\n.header-actions {\n    display: flex;\n    gap: 0.75rem;\n}\n\n.card-content {\n    padding: 2rem;\n    flex: 1;\n}\n\n/* Course Items */\n.course-list {\n    display: flex;\n    flex-direction: column;\n    gap: 1.25rem;\n}\n\n.course-item {\n    border: 1px solid var(--border);\n    border-radius: var(--radius-lg);\n    padding: 1.5rem;\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    display: flex;\n    gap: 1.25rem;\n    align-items: flex-start;\n    background: var(--card-bg);\n    position: relative;\n    overflow: hidden;\n}\n\n.course-item::before {\n    content: '';\n    position: absolute;\n    left: 0;\n    top: 0;\n    bottom: 0;\n    width: 4px;\n    transition: all 0.3s ease;\n}\n\n.course-item:hover {\n    box-shadow: var(--shadow-lg);\n    transform: translateY(-4px);\n    border-color: var(--gray-300);\n}\n\n.course-item.pending::before {\n    background: var(--warning);\n}\n\n.course-item.active::before {\n    background: var(--success);\n}\n\n.course-item.pending {\n    background: var(--card-bg);\n    border-color: var(--warning);\n}\n\n.course-item.active {\n    background: var(--card-bg);\n    border-color: var(--success);\n}\n\n.course-badge {\n    width: 60px;\n    height: 60px;\n    border-radius: 0.75rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1.5rem;\n    flex-shrink: 0;\n    transition: all 0.3s ease;\n}\n\n.course-item:hover .course-badge {\n    transform: scale(1.1);\n}\n\n.course-item.active .course-badge { \n    background: var(--gradient-success);\n    animation: pulse 2s infinite;\n}\n.course-item.pending .course-badge { \n    background: var(--gradient-warning);\n}\n\n.course-content {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    gap: 1rem;\n}\n\n.course-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: flex-start;\n    flex-wrap: wrap;\n    gap: 0.75rem;\n}\n\n.course-header h4 {\n    margin: 0;\n    color: var(--text-primary);\n    flex: 1;\n    min-width: 250px;\n    font-weight: 700;\n    font-size: 1.2rem;\n    line-height: 1.4;\n}\n\n.course-meta {\n    display: flex;\n    gap: 1rem;\n    align-items: center;\n    flex-wrap: wrap;\n}\n\n.course-code {\n    background: var(--gray-200);\n    padding: 0.5rem 1rem;\n    border-radius: var(--radius);\n    font-size: 0.85rem;\n    color: var(--text-secondary);\n    font-weight: 600;\n    border: 1px solid var(--border);\n    font-family: 'Monaco', 'Consolas', monospace;\n}\n\n.status-badge {\n    padding: 0.5rem 1rem;\n    border-radius: 1.25rem;\n    font-size: 0.85rem;\n    font-weight: 700;\n    white-space: nowrap;\n    border: 1px solid;\n}\n\n.status-badge.approved {\n    background-color: #d1fae5;\n    color: #065f46;\n    border-color: #a7f3d0;\n}\n\n.status-badge.pending {\n    background-color: #fef3c7;\n    color: #92400e;\n    border-color: #fde68a;\n}\n\n.course-details {\n    display: flex;\n    flex-direction: column;\n    gap: 1rem;\n}\n\n.instructor, .enrolled-date {\n    margin: 0;\n    color: var(--text-secondary);\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    font-size: 0.95rem;\n    font-weight: 500;\n}\n\n/* Learning Status - iOS Dark Theme */\n.learning-status {\n    background: linear-gradient(135deg, rgba(48, 209, 88, 0.08) 0%, rgba(10, 132, 255, 0.08) 100%);\n    padding: 1.5rem;\n    border-radius: var(--radius-lg);\n    border: 1px solid var(--border);\n    margin: 1rem 0;\n    box-shadow: var(--shadow);\n    position: relative;\n    overflow: hidden;\n}\n\n.status-badge-container {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n    padding: 1rem 0;\n}\n\n.pulse-ring {\n    position: absolute;\n    width: 80px;\n    height: 80px;\n    border: 2px solid var(--success);\n    border-radius: 50%;\n    animation: pulseRing 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;\n    opacity: 0;\n}\n\n.pulse-ring.delay-1 {\n    animation-delay: 0.5s;\n}\n\n.pulse-ring.delay-2 {\n    animation-delay: 1s;\n}\n\n@keyframes pulseRing {\n    0% {\n        transform: scale(0.5);\n        opacity: 1;\n    }\n    100% {\n        transform: scale(1.3);\n        opacity: 0;\n    }\n}\n\n.status-badge {\n    display: flex;\n    align-items: center;\n    gap: 0.75rem;\n    background: linear-gradient(135deg, var(--success) 0%, #28a745 100%);\n    padding: 0.75rem 1.5rem;\n    border-radius: 50px;\n    box-shadow: 0 0 30px rgba(48, 209, 88, 0.6), \n                0 4px 12px rgba(48, 209, 88, 0.4);\n    position: relative;\n    z-index: 2;\n    animation: statusFloat 3s ease-in-out infinite;\n}\n\n.badge-icon {\n    font-size: 1.25rem;\n    animation: rotateIcon 4s linear infinite;\n}\n\n.badge-text {\n    font-size: 0.95rem;\n    font-weight: 700;\n    color: #000000;\n    letter-spacing: 0.5px;\n}\n\n@keyframes statusFloat {\n    0%, 100% {\n        transform: translateY(0);\n    }\n    50% {\n        transform: translateY(-5px);\n    }\n}\n\n@keyframes rotateIcon {\n    0%, 90% {\n        transform: rotate(0deg);\n    }\n    95% {\n        transform: rotate(-10deg);\n    }\n    100% {\n        transform: rotate(0deg);\n    }\n}\n\n.learning-bars {\n    display: flex;\n    gap: 8px;\n    justify-content: center;\n    align-items: flex-end;\n    height: 40px;\n    margin-top: 1rem;\n}\n\n.learning-bars .bar {\n    width: 6px;\n    background: linear-gradient(180deg, var(--primary) 0%, var(--success) 100%);\n    border-radius: 3px;\n    animation: barWave 1.2s ease-in-out infinite;\n    box-shadow: 0 0 10px rgba(10, 132, 255, 0.5);\n}\n\n.learning-bars .bar:nth-child(1) {\n    animation-delay: 0s;\n}\n\n.learning-bars .bar:nth-child(2) {\n    animation-delay: 0.1s;\n}\n\n.learning-bars .bar:nth-child(3) {\n    animation-delay: 0.2s;\n}\n\n.learning-bars .bar:nth-child(4) {\n    animation-delay: 0.3s;\n}\n\n.learning-bars .bar:nth-child(5) {\n    animation-delay: 0.4s;\n}\n\n@keyframes barWave {\n    0%, 100% {\n        height: 15px;\n        opacity: 0.5;\n    }\n    50% {\n        height: 35px;\n        opacity: 1;\n    }\n}\n\n.course-actions {\n    display: flex;\n    gap: 0.75rem;\n    flex-wrap: wrap;\n}\n\n.pending-notice {\n    color: var(--warning);\n    font-size: 0.95rem;\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    font-weight: 500;\n    font-style: italic;\n}\n\n/* Discover Courses */\n.discover-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n    gap: 1.25rem;\n}\n\n.discover-item {\n    background: var(--card-bg);\n    border: 1px solid var(--border);\n    border-radius: var(--radius-lg);\n    padding: 1.5rem;\n    display: flex;\n    align-items: center;\n    gap: 1.25rem;\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n    overflow: hidden;\n}\n\n.discover-item::before {\n    content: '';\n    position: absolute;\n    left: 0;\n    top: 0;\n    bottom: 0;\n    width: 3px;\n    background: var(--gradient-primary);\n    opacity: 0;\n    transition: opacity 0.3s ease;\n}\n\n.discover-item:hover::before {\n    opacity: 1;\n}\n\n.discover-item:hover {\n    box-shadow: var(--shadow-lg);\n    transform: translateY(-4px);\n    border-color: var(--gray-300);\n}\n\n.discover-icon {\n    width: 50px;\n    height: 50px;\n    border-radius: 0.75rem;\n    background: var(--gradient-primary);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1.25rem;\n    flex-shrink: 0;\n    transition: transform 0.3s ease;\n}\n\n.discover-item:hover .discover-icon {\n    transform: scale(1.1) rotate(5deg);\n}\n\n.discover-content {\n    flex: 1;\n    min-width: 0;\n}\n\n.discover-content h4 {\n    margin: 0 0 0.5rem 0;\n    font-size: 1.1rem;\n    font-weight: 700;\n    color: var(--text-primary);\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    line-height: 1.4;\n}\n\n.discover-instructor {\n    margin: 0 0 0.75rem 0;\n    font-size: 0.9rem;\n    color: var(--text-light);\n    display: flex;\n    align-items: center;\n    gap: 0.25rem;\n    font-weight: 500;\n}\n\n.discover-meta {\n    display: flex;\n    gap: 0.75rem;\n    align-items: center;\n    flex-wrap: wrap;\n}\n\n.discover-code {\n    background: var(--gray-100);\n    padding: 0.375rem 0.75rem;\n    border-radius: 0.5rem;\n    font-size: 0.8rem;\n    color: var(--text-secondary);\n    font-weight: 600;\n    border: 1px solid var(--border);\n    font-family: 'Monaco', 'Consolas', monospace;\n}\n\n.discover-category {\n    background: var(--gray-200);\n    padding: 0.375rem 0.75rem;\n    border-radius: 0.5rem;\n    font-size: 0.8rem;\n    color: var(--text-secondary);\n    font-weight: 600;\n}\n\n.discover-actions {\n    display: flex;\n    gap: 0.5rem;\n    flex-shrink: 0;\n}\n\n.btn-enroll, .btn-info {\n    width: 42px;\n    height: 42px;\n    border-radius: 0.75rem;\n    border: none;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1rem;\n    cursor: pointer;\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n    overflow: hidden;\n}\n\n.btn-enroll::before, .btn-info::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: -100%;\n    width: 100%;\n    height: 100%;\n    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);\n    transition: left 0.5s;\n}\n\n.btn-enroll:hover::before, .btn-info:hover::before {\n    left: 100%;\n}\n\n.btn-enroll {\n    background: var(--gradient-primary);\n    color: white;\n}\n\n.btn-enroll:hover {\n    transform: scale(1.1);\n    box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);\n}\n\n.btn-info {\n    background: var(--gray-200);\n    color: var(--text-primary);\n}\n\n.btn-info:hover {\n    background: var(--gray-300);\n    transform: scale(1.1);\n}\n\n.view-all-section {\n    text-align: center;\n    padding-top: 2rem;\n    margin-top: 1.5rem;\n    border-top: 1px solid var(--border);\n}\n\n/* Empty States */\n.empty-state {\n    text-align: center;\n    padding: 3rem 2rem;\n    color: var(--text-secondary);\n}\n\n.empty-icon {\n    margin-bottom: 1.5rem;\n    font-size: 3rem;\n    opacity: 0.7;\n}\n\n.empty-state h3 {\n    color: var(--text-primary);\n    margin-bottom: 1rem;\n    font-weight: 700;\n    font-size: 1.5rem;\n}\n\n.empty-state p {\n    margin-bottom: 2rem;\n    max-width: 300px;\n    margin-left: auto;\n    margin-right: auto;\n    line-height: 1.6;\n    font-size: 1.05rem;\n}\n\n/* Buttons */\n.btn {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.875rem 1.5rem;\n    border-radius: 0.75rem;\n    font-weight: 600;\n    text-decoration: none;\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    border: none;\n    cursor: pointer;\n    font-size: 0.95rem;\n    white-space: nowrap;\n    justify-content: center;\n    position: relative;\n    overflow: hidden;\n}\n\n.btn::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: -100%;\n    width: 100%;\n    height: 100%;\n    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);\n    transition: left 0.5s;\n}\n\n.btn:hover::before {\n    left: 100%;\n}\n\n.btn-sm {\n    padding: 0.75rem 1.25rem;\n    font-size: 0.9rem;\n}\n\n.btn-primary {\n    background: var(--gradient-primary);\n    color: white;\n}\n\n.btn-primary:hover {\n    transform: translateY(-2px);\n    box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);\n}\n\n.btn-secondary {\n    background: var(--gray-600);\n    color: white;\n}\n\n.btn-secondary:hover {\n    background: var(--gray-700);\n    transform: translateY(-2px);\n    box-shadow: var(--shadow-md);\n}\n\n.btn-success {\n    background: var(--gradient-success);\n    color: white;\n}\n\n.btn-success:hover {\n    transform: translateY(-2px);\n    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);\n}\n\n.btn-outline {\n    background: transparent;\n    color: var(--text-primary);\n    border: 1px solid var(--border);\n}\n\n.btn-outline:hover {\n    background: var(--gray-50);\n    transform: translateY(-2px);\n    box-shadow: var(--shadow-sm);\n    border-color: var(--gray-300);\n}\n\n/* Animations */\n@keyframes pulse {\n    0% {\n        transform: scale(0.95);\n        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);\n    }\n    \n    70% {\n        transform: scale(1);\n        box-shadow: 0 0 0 12px rgba(16, 185, 129, 0);\n    }\n    \n    100% {\n        transform: scale(0.95);\n        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);\n    }\n}\n\n@keyframes shine {\n    0% {\n        left: -100%;\n    }\n    100% {\n        left: 100%;\n    }\n}\n\n@keyframes progress-glow {\n    0% {\n        box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);\n    }\n    50% {\n        box-shadow: 0 0 20px rgba(16, 185, 129, 0.8);\n    }\n    100% {\n        box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);\n    }\n}\n\n/* Modal Styling */\n.modal {\n    display: none;\n    position: fixed;\n    z-index: 1000;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 100%;\n    background-color: rgba(0, 0, 0, 0.6);\n    backdrop-filter: blur(8px);\n}\n\n.modal-content {\n    background-color: var(--card-bg);\n    margin: 10% auto;\n    padding: 0;\n    border-radius: var(--radius-xl);\n    width: 90%;\n    max-width: 500px;\n    box-shadow: var(--shadow-xl);\n    overflow: hidden;\n    border: 1px solid var(--border);\n    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n@keyframes modalSlideIn {\n    from {\n        opacity: 0;\n        transform: translateY(-60px) scale(0.9);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0) scale(1);\n    }\n}\n\n.modal-header {\n    padding: 2rem;\n    border-bottom: 1px solid var(--border);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    background: var(--gradient-primary);\n    color: var(--white);\n}\n\n.modal-header h3 {\n    margin: 0;\n    font-weight: 700;\n    font-size: 1.5rem;\n}\n\n.close {\n    color: white;\n    font-size: 28px;\n    font-weight: bold;\n    cursor: pointer;\n    line-height: 1;\n    transition: transform 0.2s ease;\n    width: 32px;\n    height: 32px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: 50%;\n}\n\n.close:hover {\n    transform: scale(1.1);\n    background: rgba(255,255,255,0.1);\n}\n\n.modal-body {\n    padding: 2.5rem;\n}\n\n.course-info-display {\n    margin-bottom: 2rem;\n    padding-bottom: 2rem;\n    border-bottom: 1px solid var(--border-light);\n}\n\n.course-info-display h4 {\n    margin: 0 0 0.75rem 0;\n    color: var(--text-primary);\n    font-weight: 700;\n    font-size: 1.3rem;\n}\n\n.course-info-display span {\n    color: var(--text-secondary);\n    font-size: 1rem;\n    font-weight: 500;\n}\n\n.form-group {\n    margin-bottom: 2rem;\n}\n\n.form-group label {\n    display: block;\n    margin-bottom: 0.75rem;\n    font-weight: 600;\n    color: var(--text-primary);\n    font-size: 1rem;\n}\n\n.form-group input {\n    width: 100%;\n    padding: 1rem 1.25rem;\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    font-size: 1rem;\n    box-sizing: border-box;\n    background: var(--gray-200);\n    color: var(--text-primary);\n    transition: all 0.3s ease;\n    font-family: inherit;\n}\n\n.form-group input:focus {\n    outline: none;\n    border-color: var(--primary);\n    background: var(--gray-300);\n    box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);\n    transform: translateY(-1px);\n}\n\n.modal-actions {\n    display: flex;\n    gap: 1rem;\n    justify-content: center;\n    margin-top: 2.5rem;\n}\n\n/* Responsive Design */\n@media (max-width: 1200px) {\n    .dashboard-grid {\n        grid-template-columns: 1fr;\n    }\n    \n    .stats-grid {\n        grid-template-columns: repeat(2, 1fr);\n    }\n}\n\n@media (max-width: 768px) {\n    .dashboard-container {\n        padding: 1.25rem;\n    }\n    \n    .dashboard-header {\n        padding: 2rem;\n    }\n    \n    .welcome-section {\n        flex-direction: column;\n        text-align: center;\n        gap: 1.5rem;\n    }\n    \n    .welcome-content h1 {\n        font-size: 2rem;\n    }\n    \n    .avatar-container {\n        width: 70px;\n        height: 70px;\n        font-size: 2rem;\n    }\n    \n    .stats-grid {\n        grid-template-columns: 1fr;\n        gap: 1.25rem;\n    }\n    \n    .stat-card {\n        padding: 1.75rem;\n    }\n    \n    .card-header {\n        flex-direction: column;\n        align-items: flex-start;\n        gap: 1rem;\n    }\n    \n    .course-header {\n        flex-direction: column;\n        align-items: flex-start;\n        gap: 1rem;\n    }\n    \n    .course-header h4 {\n        min-width: auto;\n    }\n    \n    .course-item {\n        flex-direction: column;\n        text-align: center;\n        gap: 1.25rem;\n    }\n    \n    .course-badge {\n        align-self: center;\n    }\n    \n    .discover-grid {\n        grid-template-columns: 1fr;\n    }\n    \n    .discover-item {\n        flex-direction: column;\n        text-align: center;\n        gap: 1.25rem;\n    }\n    \n    .discover-actions {\n        align-self: stretch;\n        justify-content: center;\n    }\n    \n    .modal-content {\n        width: 95%;\n        margin: 5% auto;\n    }\n    \n    .modal-body {\n        padding: 2rem;\n    }\n    \n    .modal-actions {\n        flex-direction: column;\n    }\n}\n\n@media (max-width: 480px) {\n    .dashboard-header h1 {\n        font-size: 1.75rem;\n    }\n    \n    .card-content {\n        padding: 1.5rem;\n    }\n    \n    .course-item {\n        padding: 1.25rem;\n    }\n    \n    .course-actions {\n        flex-direction: column;\n        align-items: stretch;\n    }\n    \n    .modal-header {\n        padding: 1.5rem;\n    }\n    \n    .modal-body {\n        padding: 1.5rem;\n    }\n    \n    .stat-number {\n        font-size: 2rem;\n    }\n    \n    .stat-icon {\n        width: 60px;\n        height: 60px;\n        font-size: 1.5rem;\n    }\n    \n    .btn {\n        padding: 0.75rem 1.25rem;\n        font-size: 0.9rem;\n    }\n}\n</style>\n\n<!-- Enrollment Modal -->\n<div id=\"enrollmentModal\" class=\"modal\">\n    <div class=\"modal-content\">\n        <div class=\"modal-header\">\n            <h3>Enroll in Course</h3>\n            <span class=\"close\" onclick=\"closeEnrollmentModal()\">&times;</span>\n        </div>\n        <div class=\"modal-body\">\n            <div class=\"course-info-display\">\n                <h4 id=\"modalCourseTitle\"></h4>\n                <span id=\"modalCourseCode\"></span>\n            </div>\n            <form method=\"POST\" action=\"{{ url_for('student_enroll') }}\" id=\"modalEnrollForm\">\n                <input type=\"hidden\" name=\"csrf_token\" value=\"{{ csrf_token }}\">\n                <input type=\"hidden\" id=\"modalCourseCodeInput\" name=\"course_code\">\n                <div class=\"form-group\">\n                    <label for=\"modalEnrollmentKey\">Enrollment Key</label>\n                    <input type=\"password\" \n                           id=\"modalEnrollmentKey\" \n                           name=\"enrollment_key\" \n                           required\n                           placeholder=\"Enter the enrollment key provided by your instructor\">\n                    <small style=\"color: var(--text-light); margin-top: 0.5rem; display: block; font-size: 0.8rem;\">\n                        Get the enrollment key from your instructor to complete enrollment.\n                    </small>\n                </div>\n                <div class=\"modal-actions\">\n                    <button type=\"submit\" class=\"btn btn-primary\">\n                        Confirm Enrollment\n                    </button>\n                    <button type=\"button\" class=\"btn btn-outline\" onclick=\"closeEnrollmentModal()\">\n                        Cancel\n                    </button>\n                </div>\n            </form>\n        </div>\n    </div>\n</div>\n\n<script>\nfunction enrollInCourse(courseCode, courseTitle) {\n    document.getElementById('modalCourseTitle').textContent = courseTitle;\n    document.getElementById('modalCourseCode').textContent = courseCode;\n    document.getElementById('modalCourseCodeInput').value = courseCode;\n    document.getElementById('modalEnrollmentKey').value = '';\n    document.getElementById('enrollmentModal').style.display = 'block';\n    document.getElementById('modalEnrollmentKey').focus();\n}\n\nfunction closeEnrollmentModal() {\n    document.getElementById('enrollmentModal').style.display = 'none';\n}\n\nfunction viewCourseDetails(courseId) {\n    window.location.href = '{{ url_for(\"student_browse_courses\") }}#course-' + courseId;\n}\n\n// Set current date\ndocument.addEventListener('DOMContentLoaded', function() {\n    const now = new Date();\n    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };\n    document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);\n    \n    // Initialize progress animations\n    initializeProgressAnimations();\n});\n\n// Function to initialize progress animations\nfunction initializeProgressAnimations() {\n    const progressBars = document.querySelectorAll('.progress-fill');\n    \n    progressBars.forEach(bar => {\n        // Add a slight delay to make the animation more noticeable\n        setTimeout(() => {\n            const width = bar.style.width;\n            bar.style.width = '0%';\n            \n            // Animate to the actual width\n            setTimeout(() => {\n                bar.style.width = width;\n            }, 300);\n        }, 500);\n    });\n}\n\n// Function to simulate progress update\nfunction simulateProgressUpdate(courseCode, newProgress) {\n    const courseItems = document.querySelectorAll('.course-item');\n    \n    courseItems.forEach(item => {\n        const codeElement = item.querySelector('.course-code');\n        if (codeElement && codeElement.textContent === courseCode) {\n            const progressFill = item.querySelector('.progress-fill');\n            const progressPercentage = item.querySelector('.progress-percentage');\n            \n            if (progressFill) {\n                progressFill.style.width = `${newProgress}%`;\n                \n                // Add a glow effect\n                progressFill.style.animation = 'progress-glow 1s ease';\n                \n                // Remove animation after it completes\n                setTimeout(() => {\n                    progressFill.style.animation = '';\n                }, 1000);\n            }\n        }\n    });\n}\n\n// Close modal when clicking outside\nwindow.addEventListener('click', function(event) {\n    const modal = document.getElementById('enrollmentModal');\n    if (event.target === modal) {\n        closeEnrollmentModal();\n    }\n});\n\n// Close modal on escape key\ndocument.addEventListener('keydown', function(event) {\n    if (event.key === 'Escape') {\n        closeEnrollmentModal();\n    }\n});\n\n// Demo function to show progress animation (remove in production)\nfunction demoProgressAnimation() {\n    setTimeout(() => {\n        simulateProgressUpdate('CS101', 75);\n    }, 2000);\n    \n    setTimeout(() => {\n        simulateProgressUpdate('MATH201', 45);\n    }, 4000);\n}\n\n// Initialize demo on page load (remove in production)\ndocument.addEventListener('DOMContentLoaded', function() {\n    // Uncomment the line below to see demo progress animations\n    // demoProgressAnimation();\n});\n</script>\n","size_bytes":29854},"ghalib/templates/student/video_download/app.sh":{"content":"python app.py\n","size_bytes":14},"app.py":{"content":"import os\nimport sqlite3\nimport logging\nfrom datetime import datetime, timedelta\nfrom functools import wraps\nfrom werkzeug.security import generate_password_hash, check_password_hash\nfrom werkzeug.utils import secure_filename\nfrom flask import Flask, render_template, request, redirect, url_for, flash, jsonify, session, send_from_directory, send_file\nfrom flask_login import LoginManager, UserMixin, login_user, login_required, logout_user, current_user\nfrom flask_socketio import SocketIO, emit, join_room, leave_room, rooms\nfrom flask_caching import Cache\nfrom flask_mail import Mail, Message\nfrom threading import Lock\nimport json\nimport uuid\nfrom dotenv import load_dotenv\nimport gemini_ai\nfrom pytubefix import YouTube\nimport shutil\n\n# Load environment variables\nload_dotenv()\n\n# Initialize Flask app\napp = Flask(__name__)\napp.config['SECRET_KEY'] = os.environ.get('SESSION_SECRET') or 'dev-secret-key-change-in-production'\n# Use paths relative to the app file location\nBASE_DIR = os.path.dirname(os.path.abspath(__file__))\napp.config['UPLOAD_FOLDER'] = os.path.join(BASE_DIR, 'sir_rafique', 'uploads')\napp.config['MAX_CONTENT_LENGTH'] = None  # No file size limit for videos\n\n# Database configuration\nDATABASE = os.path.join(BASE_DIR, 'sir_rafique', 'learnnest.db')\n\n# Initialize extensions\nlogin_manager = LoginManager()\nlogin_manager.init_app(app)\nlogin_manager.login_view = 'login'  # type: ignore\nlogin_manager.login_message = 'Please log in to access this page.'\n\nsocketio = SocketIO(app, cors_allowed_origins=\"*\", async_mode='threading')\n\n# Initialize caching\ncache = Cache(app, config={'CACHE_TYPE': 'simple'})\n\n# Initialize mail\nmail = Mail(app)\n\n# Register custom Jinja filters and globals\n@app.template_filter('nl2br')\ndef nl2br_filter(s):\n    \"\"\"Convert newlines to HTML line breaks\"\"\"\n    if s is None:\n        return ''\n    return str(s).replace('\\n', '<br>\\n')\n\n# Add custom Jinja2 global functions\n@app.template_global()\ndef max_func(*args):\n    \"\"\"Max function for Jinja2 templates\"\"\"\n    return max(args)\n\n@app.template_global()\ndef min_func(*args):\n    \"\"\"Min function for Jinja2 templates\"\"\"\n    return min(args)\n\n# CSRF protection helpers\nimport secrets\nimport hashlib\n\ndef generate_csrf_token():\n    \"\"\"Generate a CSRF token for forms\"\"\"\n    token = secrets.token_urlsafe(32)\n    session['csrf_token'] = token\n    return token\n\ndef validate_csrf_token(token):\n    \"\"\"Validate CSRF token\"\"\"\n    if not token or token != session.get('csrf_token'):\n        return False\n    return True\n\n@app.context_processor\ndef inject_csrf_token():\n    \"\"\"Make CSRF token available in all templates\"\"\"\n    if 'csrf_token' not in session:\n        session['csrf_token'] = secrets.token_urlsafe(32)\n    return dict(csrf_token=session['csrf_token'])\n\n# Thread lock for database operations\ndb_lock = Lock()\n\n# Create uploads directory\nos.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'assignments'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'resources'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'payments'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'instructor_screenshots'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'transcripts'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'chat_files'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'chat_images'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'direct_messages'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'forum_media'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'profile_pictures'), exist_ok=True)\n\n# File size limits (in bytes)\nMAX_CHAT_FILE_SIZE = 100 * 1024 * 1024  # 100 MB per file\nMAX_TOTAL_STORAGE_PER_USER = 5 * 1024 * 1024 * 1024  # 5 GB per user\nALLOWED_FILE_TYPES = {\n    'pdf', 'doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx', 'txt', \n    'jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg',\n    'zip', 'rar', '7z', 'tar', 'gz',\n    'mp4', 'mov', 'avi', 'mkv', 'webm', 'flv',\n    'mp3', 'wav', 'ogg', 'm4a',\n    'csv', 'json', 'xml', 'html', 'css', 'js', 'py', 'java', 'cpp', 'c', 'h'\n}\n\n# Database connection helper\ndef get_db_connection():\n    conn = sqlite3.connect(DATABASE, timeout=30)\n    conn.execute('PRAGMA journal_mode=WAL;')\n    conn.execute('PRAGMA synchronous=NORMAL;')\n    conn.execute('PRAGMA cache_size=10000;')\n    conn.execute('PRAGMA temp_store=MEMORY;')\n    conn.row_factory = sqlite3.Row\n    return conn\n\ndef send_notification(user_id, title, message, notification_type='info', related_id=None):\n    \"\"\"Helper function to send notifications to students\"\"\"\n    try:\n        conn = get_db_connection()\n        conn.execute('''\n            INSERT INTO notifications (user_id, title, message, type, related_id, created_at)\n            VALUES (?, ?, ?, ?, ?, ?)\n        ''', (user_id, title, message, notification_type, related_id, datetime.now()))\n        conn.commit()\n        conn.close()\n        \n        # Emit real-time notification via SocketIO\n        socketio.emit('notification', {\n            'title': title,\n            'message': message,\n            'type': notification_type\n        }, to=f'user_{user_id}')\n        \n        return True\n    except Exception as e:\n        logging.error(f\"Error sending notification: {e}\")\n        return False\n\ndef update_student_progress(conn, student_id, course_id):\n    \"\"\"\n    Calculate and update student progress for a course based on quiz completions\n    Progress = (Number of Submitted Quizzes / Total Quizzes) * 100\n    Note: If manual_progress_override is set by instructor, automatic progress is still calculated and stored\n          but the manual override value takes precedence for display\n    \"\"\"\n    try:\n        # Check if instructor has set manual progress override\n        enrollment = conn.execute('''\n            SELECT manual_progress_override\n            FROM enrollments\n            WHERE student_id = ? AND course_id = ?\n        ''', (student_id, course_id)).fetchone()\n        \n        has_manual_override = enrollment and enrollment['manual_progress_override'] is not None\n        \n        # Get total number of quizzes for this course\n        total_quizzes = conn.execute('''\n            SELECT COUNT(*) as count\n            FROM assignments\n            WHERE course_id = ? AND assignment_type = 'quiz' AND is_active = 1\n        ''', (course_id,)).fetchone()['count']\n        \n        if total_quizzes == 0:\n            # No quizzes, set progress to 0\n            auto_progress = 0\n        else:\n            # Get number of submitted quizzes by student\n            submitted_quizzes = conn.execute('''\n                SELECT COUNT(DISTINCT a.id) as count\n                FROM assignments a\n                INNER JOIN assignment_submissions sub ON a.id = sub.assignment_id\n                WHERE a.course_id = ? \n                AND a.assignment_type = 'quiz'\n                AND a.is_active = 1\n                AND sub.student_id = ?\n            ''', (course_id, student_id)).fetchone()['count']\n            \n            # Calculate progress percentage\n            auto_progress = (submitted_quizzes / total_quizzes) * 100\n        \n        # Always update progress_percentage with automatic calculation\n        # This keeps it in sync even when manual override is active\n        conn.execute('''\n            UPDATE enrollments\n            SET progress_percentage = ?\n            WHERE student_id = ? AND course_id = ?\n        ''', (auto_progress, student_id, course_id))\n        \n        conn.commit()\n        \n        # Return manual override if set, otherwise return automatic progress\n        if has_manual_override:\n            return enrollment['manual_progress_override']\n        else:\n            return auto_progress\n        \n    except Exception as e:\n        print(f\"Error updating student progress: {e}\")\n        return 0\n\n# User class for Flask-Login\nclass User(UserMixin):\n    def __init__(self, id, username, email, role, full_name, created_at, active_status=True, \n                 instructor_approval_status='approved', approved_by=None, approved_at=None, profile_picture=None):\n        self.id = id\n        self.username = username\n        self.email = email\n        self.role = role\n        self.full_name = full_name\n        self.created_at = created_at\n        self._is_active = active_status\n        self.instructor_approval_status = instructor_approval_status\n        self.approved_by = approved_by\n        self.approved_at = approved_at\n        self.profile_picture = profile_picture\n\n    def get_id(self):\n        return str(self.id)\n\n    def is_admin(self):\n        return self.role == 'admin'\n    \n    def is_instructor(self):\n        return self.role == 'instructor'\n    \n    def is_student(self):\n        return self.role == 'student'\n    \n    def is_instructor_approved(self):\n        \"\"\"Check if instructor is approved to access instructor features\"\"\"\n        if not self.is_instructor():\n            return True  # Non-instructors don't need approval\n        return self.instructor_approval_status == 'approved'\n    \n    def is_instructor_pending(self):\n        \"\"\"Check if instructor is pending approval\"\"\"\n        return self.is_instructor() and self.instructor_approval_status == 'pending'\n    \n    def is_instructor_rejected(self):\n        \"\"\"Check if instructor was rejected\"\"\"\n        return self.is_instructor() and self.instructor_approval_status == 'rejected'\n\n@login_manager.user_loader\ndef load_user(user_id):\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            user = conn.execute(\n                'SELECT * FROM users WHERE id = ? AND is_active = 1', (user_id,)\n            ).fetchone()\n            conn.close()\n        \n        if user:\n            profile_pic = user['profile_picture'] if 'profile_picture' in user.keys() else None\n            return User(user['id'], user['username'], user['email'], user['role'], \n                       user['full_name'], user['created_at'], user['is_active'],\n                       user['instructor_approval_status'] if user['instructor_approval_status'] else 'approved',\n                       user['approved_by'],\n                       user['approved_at'],\n                       profile_pic)\n    except sqlite3.OperationalError:\n        # Database not yet initialized\n        pass\n    return None\n\n# Role-based access control decorators\ndef admin_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if not current_user.is_authenticated or not current_user.is_admin():\n            flash('Access denied. Admin privileges required.', 'error')\n            return redirect(url_for('dashboard'))\n        return f(*args, **kwargs)\n    return decorated_function\n\ndef instructor_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if not current_user.is_authenticated:\n            flash('Access denied. Please log in.', 'error')\n            return redirect(url_for('login'))\n        \n        # Admins always have access to instructor features\n        if current_user.is_admin():\n            return f(*args, **kwargs)\n        \n        # Check if user is instructor\n        if not current_user.is_instructor():\n            flash('Access denied. Instructor privileges required.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Check if instructor is approved\n        if not current_user.is_instructor_approved():\n            flash('Your instructor account is pending approval. Please wait for admin approval.', 'warning')\n            return redirect(url_for('dashboard'))\n        \n        return f(*args, **kwargs)\n    return decorated_function\n\n# Database initialization\ndef init_db():\n    print(\"ðŸ”„ Initializing database...\")\n    with db_lock:\n        try:\n            conn = get_db_connection()\n            \n            # Users table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS users (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    username TEXT UNIQUE NOT NULL,\n                    email TEXT UNIQUE NOT NULL,\n                    password_hash TEXT NOT NULL,\n                    role TEXT NOT NULL DEFAULT 'student',\n                    full_name TEXT NOT NULL,\n                    bio TEXT,\n                    profile_image TEXT,\n                    instructor_approval_status TEXT DEFAULT 'approved',\n                    approved_by INTEGER,\n                    approved_at TIMESTAMP,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    last_login TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (approved_by) REFERENCES users (id)\n                )\n            ''')\n            \n            # Add columns if they don't exist\n            try:\n                conn.execute('ALTER TABLE users ADD COLUMN instructor_approval_status TEXT DEFAULT \"approved\"')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE users ADD COLUMN approved_by INTEGER')\n            except sqlite3.OperationalError:\n                pass\n                \n            try:\n                conn.execute('ALTER TABLE users ADD COLUMN approved_at TIMESTAMP')\n            except sqlite3.OperationalError:\n                pass\n                \n            try:\n                conn.execute('ALTER TABLE courses ADD COLUMN enrollment_key_hash TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE users ADD COLUMN instructor_screenshot TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            # Courses table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS courses (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_code TEXT UNIQUE NOT NULL,\n                    title TEXT NOT NULL,\n                    description TEXT,\n                    syllabus TEXT,\n                    instructor_id INTEGER NOT NULL,\n                    category TEXT,\n                    max_students INTEGER DEFAULT 50,\n                    start_date DATE,\n                    end_date DATE,\n                    enrollment_key_hash TEXT,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (instructor_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # Enrollments table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS enrollments (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    student_id INTEGER NOT NULL,\n                    course_id INTEGER NOT NULL,\n                    status TEXT NOT NULL DEFAULT 'pending',\n                    payment_screenshot TEXT,\n                    enrolled_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    approved_at TIMESTAMP,\n                    progress_percentage REAL DEFAULT 0,\n                    manual_progress_override REAL DEFAULT NULL,\n                    FOREIGN KEY (student_id) REFERENCES users (id),\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    UNIQUE(student_id, course_id)\n                )\n            ''')\n            \n            # Add manual_progress_override column if it doesn't exist\n            try:\n                conn.execute('ALTER TABLE enrollments ADD COLUMN manual_progress_override REAL DEFAULT NULL')\n            except sqlite3.OperationalError:\n                pass\n            \n            # Assignments table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS assignments (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    description TEXT,\n                    instructions TEXT,\n                    due_date DATETIME,\n                    max_points INTEGER DEFAULT 100,\n                    allow_late_submission BOOLEAN DEFAULT 0,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    FOREIGN KEY (course_id) REFERENCES courses (id)\n                )\n            ''')\n            \n            # Assignment submissions table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS assignment_submissions (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    assignment_id INTEGER NOT NULL,\n                    student_id INTEGER NOT NULL,\n                    submission_text TEXT,\n                    file_path TEXT,\n                    submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    grade REAL,\n                    ai_feedback TEXT,\n                    instructor_feedback TEXT,\n                    graded_at TIMESTAMP,\n                    FOREIGN KEY (assignment_id) REFERENCES assignments (id),\n                    FOREIGN KEY (student_id) REFERENCES users (id),\n                    UNIQUE(assignment_id, student_id)\n                )\n            ''')\n            \n            # Quiz questions table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS quiz_questions (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    assignment_id INTEGER NOT NULL,\n                    question_text TEXT NOT NULL,\n                    question_type TEXT NOT NULL DEFAULT 'mcq',\n                    points INTEGER DEFAULT 1,\n                    correct_answer TEXT,\n                    explanation TEXT,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    FOREIGN KEY (assignment_id) REFERENCES assignments (id)\n                )\n            ''')\n            \n            # Question options table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS question_options (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    question_id INTEGER NOT NULL,\n                    option_letter TEXT NOT NULL,\n                    option_text TEXT NOT NULL,\n                    is_correct BOOLEAN DEFAULT 0,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    FOREIGN KEY (question_id) REFERENCES quiz_questions (id)\n                )\n            ''')\n            \n            # Student MCQ answers table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS student_mcq_answers (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    submission_id INTEGER NOT NULL,\n                    question_id INTEGER NOT NULL,\n                    selected_option TEXT,\n                    is_correct BOOLEAN,\n                    points_earned REAL DEFAULT 0,\n                    answered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    FOREIGN KEY (submission_id) REFERENCES assignment_submissions (id),\n                    FOREIGN KEY (question_id) REFERENCES quiz_questions (id),\n                    UNIQUE(submission_id, question_id)\n                )\n            ''')\n            \n            # Forums table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS forums (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    description TEXT,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (course_id) REFERENCES courses (id)\n                )\n            ''')\n            \n            # Forum topics table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS forum_topics (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    forum_id INTEGER NOT NULL,\n                    user_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    content TEXT NOT NULL,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_pinned BOOLEAN DEFAULT 0,\n                    view_count INTEGER DEFAULT 0,\n                    FOREIGN KEY (forum_id) REFERENCES forums (id),\n                    FOREIGN KEY (user_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # Forum replies table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS forum_replies (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    topic_id INTEGER NOT NULL,\n                    user_id INTEGER NOT NULL,\n                    content TEXT NOT NULL,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_ai_generated BOOLEAN DEFAULT 0,\n                    FOREIGN KEY (topic_id) REFERENCES forum_topics (id),\n                    FOREIGN KEY (user_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # Chat messages table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS chat_messages (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER,\n                    sender_id INTEGER NOT NULL,\n                    recipient_id INTEGER,\n                    message TEXT NOT NULL,\n                    message_type TEXT DEFAULT 'text',\n                    file_path TEXT,\n                    file_name TEXT,\n                    file_size INTEGER DEFAULT 0,\n                    is_image BOOLEAN DEFAULT 0,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_read BOOLEAN DEFAULT 0,\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    FOREIGN KEY (sender_id) REFERENCES users (id),\n                    FOREIGN KEY (recipient_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # Direct messages table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS direct_messages (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    sender_id INTEGER NOT NULL,\n                    recipient_id INTEGER NOT NULL,\n                    message TEXT NOT NULL,\n                    message_type TEXT DEFAULT 'text',\n                    file_path TEXT,\n                    file_name TEXT,\n                    is_image BOOLEAN DEFAULT 0,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_read BOOLEAN DEFAULT 0,\n                    FOREIGN KEY (sender_id) REFERENCES users (id),\n                    FOREIGN KEY (recipient_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # File uploads table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS file_uploads (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    uploader_id INTEGER NOT NULL,\n                    file_name TEXT NOT NULL,\n                    file_path TEXT NOT NULL,\n                    file_size INTEGER,\n                    file_type TEXT,\n                    message_id INTEGER,\n                    direct_message_id INTEGER,\n                    forum_reply_id INTEGER,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    FOREIGN KEY (uploader_id) REFERENCES users (id),\n                    FOREIGN KEY (message_id) REFERENCES chat_messages (id),\n                    FOREIGN KEY (direct_message_id) REFERENCES direct_messages (id),\n                    FOREIGN KEY (forum_reply_id) REFERENCES forum_replies (id)\n                )\n            ''')\n            \n            # Notifications table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS notifications (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    user_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    message TEXT NOT NULL,\n                    type TEXT DEFAULT 'info',\n                    related_id INTEGER,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_read BOOLEAN DEFAULT 0,\n                    FOREIGN KEY (user_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # Course resources table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS course_resources (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    description TEXT,\n                    file_path TEXT,\n                    file_type TEXT,\n                    upload_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    uploaded_by INTEGER NOT NULL,\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    FOREIGN KEY (uploaded_by) REFERENCES users (id)\n                )\n            ''')\n            \n            # Course meeting links table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS course_meeting_links (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    meeting_link TEXT NOT NULL,\n                    description TEXT,\n                    scheduled_time TIMESTAMP,\n                    created_by INTEGER NOT NULL,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    FOREIGN KEY (created_by) REFERENCES users (id)\n                )\n            ''')\n            \n            # Course video playlists table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS course_video_playlists (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    video_url TEXT NOT NULL,\n                    description TEXT,\n                    thumbnail_url TEXT,\n                    duration TEXT,\n                    notes_file_path TEXT,\n                    order_index INTEGER DEFAULT 0,\n                    created_by INTEGER NOT NULL,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    FOREIGN KEY (created_by) REFERENCES users (id)\n                )\n            ''')\n            \n            # Add transcript column if needed\n            try:\n                conn.execute('ALTER TABLE course_video_playlists ADD COLUMN transcript_file_path TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            # Student video playlists table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS student_video_playlists (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    student_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    video_url TEXT NOT NULL,\n                    description TEXT,\n                    thumbnail_url TEXT,\n                    duration TEXT,\n                    order_index INTEGER DEFAULT 0,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (student_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # AI Notes table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS ai_notes (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    topic TEXT NOT NULL,\n                    content TEXT NOT NULL,\n                    pdf_path TEXT,\n                    created_by INTEGER NOT NULL,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_instructor_note BOOLEAN DEFAULT 0,\n                    sent_to_students BOOLEAN DEFAULT 0,\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    FOREIGN KEY (created_by) REFERENCES users (id)\n                )\n            ''')\n            \n            # Add media columns to forum_topics if needed\n            try:\n                conn.execute('ALTER TABLE forum_topics ADD COLUMN media_type TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE forum_topics ADD COLUMN media_path TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE forum_topics ADD COLUMN media_filename TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            # Add media columns to forum_replies if needed\n            try:\n                conn.execute('ALTER TABLE forum_replies ADD COLUMN media_type TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE forum_replies ADD COLUMN media_path TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE forum_replies ADD COLUMN media_filename TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            # Create indexes\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_users_email ON users(email)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_users_role ON users(role)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_users_approval_status ON users(instructor_approval_status)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_enrollments_student ON enrollments(student_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_enrollments_course ON enrollments(course_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_assignments_course ON assignments(course_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_submissions_assignment ON assignment_submissions(assignment_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_quiz_questions_assignment ON quiz_questions(assignment_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_question_options_question ON question_options(question_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_student_answers_submission ON student_mcq_answers(submission_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_student_answers_question ON student_mcq_answers(question_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_chat_course ON chat_messages(course_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_notifications_user ON notifications(user_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_meeting_links_course ON course_meeting_links(course_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_video_playlists_course ON course_video_playlists(course_id)')\n            \n            # Create default admin user\n            admin_exists = conn.execute('SELECT id FROM users WHERE role = \"admin\"').fetchone()\n            if not admin_exists:\n                admin_password = generate_password_hash('admin123')\n                conn.execute('''\n                    INSERT INTO users (username, email, password_hash, role, full_name, bio)\n                    VALUES (?, ?, ?, ?, ?, ?)\n                ''', ('admin', 'admin@learnnest.com', admin_password, 'admin', \n                     'System Administrator', 'Default system administrator account'))\n            \n            conn.commit()\n            conn.close()\n            print(\"âœ… Database initialized successfully!\")\n            return True\n        except Exception as e:\n            print(f\"âŒ Database initialization error: {e}\")\n            import traceback\n            traceback.print_exc()\n            return False\n\n# Routes\n@app.route('/')\ndef index():\n    if current_user.is_authenticated:\n        return redirect(url_for('dashboard'))\n    return redirect(url_for('login'))\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    if current_user.is_authenticated:\n        return redirect(url_for('dashboard'))\n    \n    if request.method == 'POST':\n        # Validate CSRF token\n        csrf_token = request.form.get('csrf_token')\n        if not validate_csrf_token(csrf_token):\n            flash('Invalid security token. Please try again.', 'error')\n            return render_template('auth/login.html')\n            \n        email = request.form['email'].lower().strip()\n        password = request.form['password']\n        remember = bool(request.form.get('remember'))\n        \n        with db_lock:\n            conn = get_db_connection()\n            user = conn.execute(\n                'SELECT * FROM users WHERE email = ? AND is_active = 1', (email,)\n            ).fetchone()\n            conn.close()\n        \n        if user and check_password_hash(user['password_hash'], password):\n            # Update last login\n            with db_lock:\n                conn = get_db_connection()\n                conn.execute(\n                    'UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = ?', (user['id'],)\n                )\n                conn.commit()\n                conn.close()\n            \n            user_obj = User(user['id'], user['username'], user['email'], user['role'], \n                          user['full_name'], user['created_at'], user['is_active'],\n                          user['instructor_approval_status'] if user['instructor_approval_status'] else 'approved',\n                          user['approved_by'],\n                          user['approved_at'])\n            login_user(user_obj, remember=remember)\n            flash(f'Welcome back, {user[\"full_name\"]}!', 'success')\n            \n            next_page = request.args.get('next')\n            return redirect(next_page) if next_page else redirect(url_for('dashboard'))\n        else:\n            flash('Invalid email or password', 'error')\n    \n    return render_template('auth/login.html')\n\n@app.route('/register', methods=['GET', 'POST'])\ndef register():\n    if current_user.is_authenticated:\n        return redirect(url_for('dashboard'))\n    \n    if request.method == 'POST':\n        # Validate CSRF token\n        csrf_token = request.form.get('csrf_token')\n        if not validate_csrf_token(csrf_token):\n            flash('Invalid security token. Please try again.', 'error')\n            return render_template('auth/register.html')\n            \n        username = request.form['username'].strip()\n        email = request.form['email'].lower().strip()\n        password = request.form['password']\n        confirm_password = request.form['confirm_password']\n        full_name = request.form['full_name'].strip()\n        role = request.form.get('role', 'student')\n        \n        # Handle instructor screenshot upload\n        screenshot_filename = None\n        if role == 'instructor' and 'instructor_screenshot' in request.files:\n            screenshot = request.files['instructor_screenshot']\n            if screenshot and screenshot.filename:\n                # Create instructor_screenshots directory if it doesn't exist\n                screenshots_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'instructor_screenshots')\n                os.makedirs(screenshots_dir, exist_ok=True)\n                \n                # Validate file type\n                allowed_extensions = {'png', 'jpg', 'jpeg', 'gif', 'webp'}\n                file_ext = screenshot.filename.rsplit('.', 1)[1].lower() if '.' in screenshot.filename else ''\n                \n                if file_ext not in allowed_extensions:\n                    flash('Invalid file type. Please upload PNG, JPG, JPEG, GIF, or WebP images only.', 'error')\n                    return render_template('auth/register.html')\n                \n                # Validate file size (max 5MB)\n                screenshot.seek(0, 2)  # Seek to end\n                file_size = screenshot.tell()\n                screenshot.seek(0)  # Reset seek position\n                \n                if file_size > 5 * 1024 * 1024:\n                    flash('File size too large. Please upload images smaller than 5MB.', 'error')\n                    return render_template('auth/register.html')\n                \n                # Generate secure filename and save\n                filename = secure_filename(f\"{username}_{datetime.now().strftime('%Y%m%d_%H%M%S')}_{screenshot.filename}\")\n                screenshot_path = os.path.join(screenshots_dir, filename)\n                \n                try:\n                    screenshot.save(screenshot_path)\n                    screenshot_filename = filename\n                except Exception as e:\n                    flash('Error saving screenshot. Please try again.', 'error')\n                    return render_template('auth/register.html')\n        \n        # Validation\n        if password != confirm_password:\n            flash('Passwords do not match', 'error')\n            return render_template('auth/register.html')\n        \n        if len(password) < 6:\n            flash('Password must be at least 6 characters long', 'error')\n            return render_template('auth/register.html')\n        \n        # Validate instructor screenshot\n        if role == 'instructor' and not screenshot_filename:\n            flash('Screenshot upload is required for instructor accounts', 'error')\n            return render_template('auth/register.html')\n        \n        with db_lock:\n            conn = get_db_connection()\n            \n            # Check if user already exists\n            existing_user = conn.execute(\n                'SELECT id FROM users WHERE email = ? OR username = ?', (email, username)\n            ).fetchone()\n            \n            if existing_user:\n                flash('User with this email or username already exists', 'error')\n                conn.close()\n                return render_template('auth/register.html')\n            \n            # Create new user\n            password_hash = generate_password_hash(password)\n            \n            # Set instructor approval status based on role\n            instructor_approval_status = 'pending' if role == 'instructor' else 'approved'\n            \n            conn.execute('''\n                INSERT INTO users (username, email, password_hash, role, full_name, instructor_approval_status, instructor_screenshot)\n                VALUES (?, ?, ?, ?, ?, ?, ?)\n            ''', (username, email, password_hash, role, full_name, instructor_approval_status, screenshot_filename))\n            \n            conn.commit()\n            conn.close()\n        \n        # Flash appropriate message based on role\n        if role == 'instructor':\n            flash('Registration successful! Your instructor account is pending admin approval. You will be notified once approved.', 'info')\n        else:\n            flash('Registration successful! Please log in.', 'success')\n        return redirect(url_for('login'))\n    \n    return render_template('auth/register.html')\n\n@app.route('/logout')\n@login_required\ndef logout():\n    logout_user()\n    flash('You have been logged out successfully.', 'info')\n    return redirect(url_for('login'))\n\n@app.route('/dashboard')\n@login_required\ndef dashboard():\n    with db_lock:\n        conn = get_db_connection()\n        \n        if current_user.is_admin():\n            # Admin dashboard data\n            stats = {\n                'total_users': conn.execute('SELECT COUNT(*) FROM users WHERE is_active = 1').fetchone()[0],\n                'total_students': conn.execute('SELECT COUNT(*) FROM users WHERE role = \"student\" AND is_active = 1').fetchone()[0],\n                'total_courses': conn.execute('SELECT COUNT(*) FROM courses WHERE is_active = 1').fetchone()[0],\n                'total_enrollments': conn.execute('SELECT COUNT(*) FROM enrollments WHERE status = \"approved\"').fetchone()[0],\n                'pending_enrollments': conn.execute('SELECT COUNT(*) FROM enrollments WHERE status = \"pending\"').fetchone()[0],\n                'pending_instructors': conn.execute('SELECT COUNT(*) FROM users WHERE role = \"instructor\" AND instructor_approval_status = \"pending\" AND is_active = 1').fetchone()[0],\n                'total_instructors': conn.execute('SELECT COUNT(*) FROM users WHERE role = \"instructor\" AND is_active = 1').fetchone()[0]\n            }\n            \n            # Recent enrollments\n            recent_enrollments = conn.execute('''\n                SELECT e.*, u.full_name as student_name, c.title as course_title\n                FROM enrollments e\n                JOIN users u ON e.student_id = u.id\n                JOIN courses c ON e.course_id = c.id\n                ORDER BY e.enrolled_at DESC\n                LIMIT 10\n            ''').fetchall()\n            \n            conn.close()\n            return render_template('admin/dashboard.html', stats=stats, recent_enrollments=recent_enrollments)\n        \n        elif current_user.is_instructor() and current_user.is_instructor_approved():\n            # Redirect to dedicated instructor dashboard only if instructor is approved\n            conn.close()\n            return redirect(url_for('instructor_dashboard'))\n        \n        else:\n            # Student dashboard data - Use COALESCE to prioritize manual progress override\n            my_enrollments_raw = conn.execute('''\n                SELECT e.*, c.title, c.course_code, c.description, u.full_name as instructor_name,\n                       COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n                FROM enrollments e\n                JOIN courses c ON e.course_id = c.id\n                JOIN users u ON c.instructor_id = u.id\n                WHERE e.student_id = ?\n                ORDER BY e.enrolled_at DESC\n            ''', (current_user.id,)).fetchall()\n            \n            # Convert Row objects to dictionaries for JSON serialization\n            my_enrollments = [dict(row) for row in my_enrollments_raw]\n            \n            # Available courses (not enrolled)\n            available_courses = conn.execute('''\n                SELECT c.*, u.full_name as instructor_name\n                FROM courses c\n                JOIN users u ON c.instructor_id = u.id\n                LEFT JOIN enrollments e ON c.id = e.course_id AND e.student_id = ?\n                WHERE c.is_active = 1 AND e.id IS NULL\n                ORDER BY c.created_at DESC\n            ''', (current_user.id,)).fetchall()\n            \n            conn.close()\n            return render_template('student/dashboard.html', enrollments=my_enrollments, available_courses=available_courses)\n\n@app.route('/update_profile', methods=['POST'])\n@login_required\ndef update_profile():\n    \"\"\"Update user profile (name and picture)\"\"\"\n    try:\n        full_name = request.form.get('full_name', '').strip()\n        \n        if not full_name:\n            flash('Name cannot be empty.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        with db_lock:\n            conn = get_db_connection()\n            \n            # Update full name\n            conn.execute('''\n                UPDATE users SET full_name = ? WHERE id = ?\n            ''', (full_name, current_user.id))\n            \n            # Handle profile picture upload\n            if 'profile_picture' in request.files:\n                file = request.files['profile_picture']\n                if file and file.filename:\n                    try:\n                        # Validate file type\n                        allowed_extensions = {'png', 'jpg', 'jpeg', 'gif', 'webp'}\n                        filename = secure_filename(file.filename)\n                        file_ext = filename.rsplit('.', 1)[-1].lower() if '.' in filename else ''\n                        \n                        if file_ext not in allowed_extensions:\n                            logging.warning(f\"Invalid file type: {file_ext}\")\n                            conn.close()\n                            flash('Invalid file type. Please upload PNG, JPG, JPEG, GIF, or WebP images only.', 'error')\n                            return redirect(url_for('dashboard'))\n                        \n                        # Create profile pictures directory\n                        profile_pics_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'profile_pictures')\n                        os.makedirs(profile_pics_dir, exist_ok=True)\n                        \n                        # Generate secure filename\n                        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n                        filename = f\"{current_user.id}_{timestamp}_{filename}\"\n                        filepath = os.path.join(profile_pics_dir, filename)\n                        \n                        # Save file\n                        file.save(filepath)\n                        logging.info(f\"Profile picture saved: {filepath}\")\n                        \n                        # Update database with relative path\n                        relative_path = os.path.join('profile_pictures', filename).replace('\\\\', '/')\n                        conn.execute('''\n                            UPDATE users SET profile_picture = ? WHERE id = ?\n                        ''', (relative_path, current_user.id))\n                    except Exception as file_error:\n                        logging.error(f\"Error processing file upload: {file_error}\")\n                        conn.close()\n                        flash('Error processing file upload. Please try again.', 'error')\n                        return redirect(url_for('dashboard'))\n            \n            conn.commit()\n            \n            # Reload the updated user data from database\n            user_data = conn.execute('SELECT * FROM users WHERE id = ?', (current_user.id,)).fetchone()\n            conn.close()\n        \n        # Update current_user object with new data\n        current_user.full_name = full_name\n        if user_data and 'profile_picture' in user_data.keys():\n            current_user.profile_picture = user_data['profile_picture']\n        \n        flash('Profile updated successfully!', 'success')\n        \n    except Exception as e:\n        logging.error(f\"Error updating profile: {e}\")\n        flash('Error updating profile. Please try again.', 'error')\n    \n    return redirect(url_for('dashboard'))\n\n# Admin instructor management routes\n@app.route('/admin/instructors')\n@admin_required\ndef admin_instructors():\n    \"\"\"Main instructor management page\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get all instructors with their approval status\n        instructors_raw = conn.execute('''\n            SELECT u.*, \n                   (SELECT full_name FROM users WHERE id = u.approved_by) as approved_by_name,\n                   (SELECT COUNT(*) FROM courses WHERE instructor_id = u.id AND is_active = 1) as course_count\n            FROM users u\n            WHERE u.role = 'instructor' AND u.is_active = 1\n            ORDER BY \n                CASE u.instructor_approval_status \n                    WHEN 'pending' THEN 1\n                    WHEN 'rejected' THEN 2\n                    WHEN 'approved' THEN 3\n                END,\n                u.created_at DESC\n        ''').fetchall()\n        \n        # Convert Row objects to dictionaries for JSON serialization\n        instructors = [dict(row) for row in instructors_raw]\n        \n        # Get counts for stats\n        stats = {\n            'total_instructors': len(instructors),\n            'pending_instructors': len([i for i in instructors if i['instructor_approval_status'] == 'pending']),\n            'approved_instructors': len([i for i in instructors if i['instructor_approval_status'] == 'approved']),\n            'rejected_instructors': len([i for i in instructors if i['instructor_approval_status'] == 'rejected'])\n        }\n        \n        conn.close()\n    \n    return render_template('admin/instructors.html', instructors=instructors, stats=stats)\n\n@app.route('/admin/instructors/pending')\n@admin_required\ndef admin_instructors_pending():\n    \"\"\"View pending instructor applications\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        pending_instructors_raw = conn.execute('''\n            SELECT u.*\n            FROM users u\n            WHERE u.role = 'instructor' \n              AND u.instructor_approval_status = 'pending' \n              AND u.is_active = 1\n            ORDER BY u.created_at ASC\n        ''').fetchall()\n        \n        # Convert Row objects to dictionaries for JSON serialization\n        pending_instructors = [dict(row) for row in pending_instructors_raw]\n        \n        conn.close()\n    \n    return render_template('admin/instructors.html', \n                         instructors=pending_instructors, \n                         view_type='pending',\n                         stats={'pending_instructors': len(pending_instructors)})\n\n@app.route('/admin/instructors/approve/<int:instructor_id>', methods=['POST'])\n@admin_required\ndef admin_approve_instructor(instructor_id):\n    \"\"\"Approve an instructor\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify instructor exists and is pending\n        instructor = conn.execute('''\n            SELECT * FROM users \n            WHERE id = ? AND role = 'instructor' AND instructor_approval_status = 'pending'\n        ''', (instructor_id,)).fetchone()\n        \n        if not instructor:\n            flash('Instructor not found or already processed.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        # Approve the instructor\n        conn.execute('''\n            UPDATE users \n            SET instructor_approval_status = 'approved',\n                approved_by = ?,\n                approved_at = CURRENT_TIMESTAMP\n            WHERE id = ?\n        ''', (current_user.id, instructor_id))\n        \n        # Create notification for the instructor\n        conn.execute('''\n            INSERT INTO notifications (user_id, title, message, type)\n            VALUES (?, ?, ?, ?)\n        ''', (instructor_id, \n              'Instructor Account Approved',\n              'Congratulations! Your instructor account has been approved. You can now create courses and access all instructor features.',\n              'success'))\n        \n        conn.commit()\n        conn.close()\n    \n    flash(f'Instructor {instructor[\"full_name\"]} has been approved successfully.', 'success')\n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/instructors/reject/<int:instructor_id>', methods=['POST'])\n@admin_required\ndef admin_reject_instructor(instructor_id):\n    \"\"\"Reject an instructor\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify instructor exists and is pending\n        instructor = conn.execute('''\n            SELECT * FROM users \n            WHERE id = ? AND role = 'instructor' AND instructor_approval_status = 'pending'\n        ''', (instructor_id,)).fetchone()\n        \n        if not instructor:\n            flash('Instructor not found or already processed.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        # Reject the instructor\n        conn.execute('''\n            UPDATE users \n            SET instructor_approval_status = 'rejected',\n                approved_by = ?,\n                approved_at = CURRENT_TIMESTAMP\n            WHERE id = ?\n        ''', (current_user.id, instructor_id))\n        \n        # Create notification for the instructor\n        conn.execute('''\n            INSERT INTO notifications (user_id, title, message, type)\n            VALUES (?, ?, ?, ?)\n        ''', (instructor_id,\n              'Instructor Application Rejected',\n              'We regret to inform you that your instructor application has been rejected. Please contact the administrator for more information.',\n              'error'))\n        \n        conn.commit()\n        conn.close()\n    \n    flash(f'Instructor {instructor[\"full_name\"]} has been rejected.', 'warning')\n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/instructors/create', methods=['POST'])\n@admin_required\ndef admin_create_instructor():\n    \"\"\"Create a new instructor account\"\"\"\n    username = request.form.get('username', '').strip().lower()\n    email = request.form.get('email', '').strip().lower()\n    full_name = request.form.get('full_name', '').strip()\n    password = request.form.get('password', '').strip()\n    \n    if not all([username, email, full_name, password]):\n        flash('All fields are required.', 'error')\n        return redirect(url_for('admin_instructors'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Check if user already exists\n        existing = conn.execute(\n            'SELECT id FROM users WHERE username = ? OR email = ?',\n            (username, email)\n        ).fetchone()\n        \n        if existing:\n            flash('Username or email already exists.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        try:\n            conn.execute('''\n                INSERT INTO users (username, email, password, full_name, role, instructor_approval_status, is_active)\n                VALUES (?, ?, ?, ?, 'instructor', 'approved', 1)\n            ''', (username, email, generate_password_hash(password), full_name))\n            \n            conn.commit()\n            flash(f'Instructor {full_name} created successfully!', 'success')\n        except Exception as e:\n            conn.rollback()\n            flash('Error creating instructor. Please try again.', 'error')\n        finally:\n            conn.close()\n    \n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/instructors/<int:instructor_id>/edit', methods=['POST'])\n@admin_required\ndef admin_edit_instructor(instructor_id):\n    \"\"\"Edit instructor details\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        instructor = conn.execute(\n            'SELECT * FROM users WHERE id = ? AND role = \"instructor\"',\n            (instructor_id,)\n        ).fetchone()\n        \n        if not instructor:\n            flash('Instructor not found.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        email = request.form.get('email', '').strip().lower()\n        full_name = request.form.get('full_name', '').strip()\n        \n        # Check if new email is already taken\n        if email != instructor['email']:\n            existing = conn.execute(\n                'SELECT id FROM users WHERE email = ? AND id != ?',\n                (email, instructor_id)\n            ).fetchone()\n            if existing:\n                flash('Email already in use.', 'error')\n                conn.close()\n                return redirect(url_for('admin_instructors'))\n        \n        try:\n            conn.execute('''\n                UPDATE users \n                SET email = ?, full_name = ?\n                WHERE id = ?\n            ''', (email, full_name, instructor_id))\n            \n            conn.commit()\n            flash(f'Instructor {full_name} updated successfully!', 'success')\n        except Exception as e:\n            conn.rollback()\n            flash('Error updating instructor.', 'error')\n        finally:\n            conn.close()\n    \n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/instructors/<int:instructor_id>/delete', methods=['POST'])\n@admin_required\ndef admin_delete_instructor(instructor_id):\n    \"\"\"Delete (deactivate) an instructor\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        instructor = conn.execute(\n            'SELECT * FROM users WHERE id = ? AND role = \"instructor\"',\n            (instructor_id,)\n        ).fetchone()\n        \n        if not instructor:\n            flash('Instructor not found.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        try:\n            conn.execute(\n                'UPDATE users SET is_active = 0 WHERE id = ?',\n                (instructor_id,)\n            )\n            conn.commit()\n            flash(f'Instructor {instructor[\"full_name\"]} has been removed.', 'success')\n        except Exception as e:\n            conn.rollback()\n            flash('Error removing instructor.', 'error')\n        finally:\n            conn.close()\n    \n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/instructors/<int:instructor_id>/toggle-block', methods=['POST'])\n@admin_required\ndef admin_toggle_instructor_block(instructor_id):\n    \"\"\"Block or unblock an instructor\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        instructor = conn.execute(\n            'SELECT * FROM users WHERE id = ? AND role = \"instructor\"',\n            (instructor_id,)\n        ).fetchone()\n        \n        if not instructor:\n            flash('Instructor not found.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        new_status = 0 if instructor['is_active'] else 1\n        action = 'unblocked' if new_status else 'blocked'\n        \n        try:\n            conn.execute(\n                'UPDATE users SET is_active = ? WHERE id = ?',\n                (new_status, instructor_id)\n            )\n            conn.commit()\n            flash(f'Instructor {instructor[\"full_name\"]} has been {action}.', 'success')\n        except Exception as e:\n            conn.rollback()\n            flash(f'Error {action} instructor.', 'error')\n        finally:\n            conn.close()\n    \n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/students')\n@login_required\n@admin_required\ndef admin_students():\n    \"\"\"View all students\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            students_raw = conn.execute('''\n                SELECT u.*, COUNT(DISTINCT e.id) as enrollment_count\n                FROM users u\n                LEFT JOIN enrollments e ON u.id = e.student_id AND e.status = 'approved'\n                WHERE u.role = 'student'\n                GROUP BY u.id\n                ORDER BY u.created_at DESC\n            ''').fetchall()\n            \n            # Convert Row objects to dictionaries for JSON serialization\n            students = [dict(row) for row in students_raw]\n            conn.close()\n        \n        return render_template('admin/students.html', students=students)\n    except Exception as e:\n        logging.error(f\"Error fetching students: {e}\")\n        flash('Error loading students', 'error')\n        return redirect(url_for('dashboard'))\n\n@app.route('/admin/student/<int:student_id>/enrollments', methods=['GET'])\n@admin_required\ndef admin_student_enrollments(student_id):\n    \"\"\"Get student's course enrollments for viewing\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            enrollments_raw = conn.execute('''\n                SELECT e.id, e.status, e.enrolled_at, e.progress_percentage,\n                       c.title, c.course_code, u.full_name as instructor_name\n                FROM enrollments e\n                JOIN courses c ON e.course_id = c.id\n                JOIN users u ON c.instructor_id = u.id\n                WHERE e.student_id = ?\n                ORDER BY e.enrolled_at DESC\n            ''', (student_id,)).fetchall()\n            \n            enrollments = [dict(row) for row in enrollments_raw]\n            conn.close()\n        \n        return jsonify({'success': True, 'enrollments': enrollments})\n    except Exception as e:\n        logging.error(f\"Error fetching enrollments: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n@app.route('/admin/students/<int:student_id>/delete', methods=['POST'])\n@login_required\n@admin_required\ndef admin_delete_student(student_id):\n    \"\"\"Delete a student account\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            student = conn.execute('SELECT * FROM users WHERE id = ? AND role = \"student\"', (student_id,)).fetchone()\n            \n            if not student:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Student not found'}), 404\n            \n            # Delete student's enrollments\n            conn.execute('DELETE FROM enrollments WHERE student_id = ?', (student_id,))\n            \n            # Delete student's notes\n            conn.execute('DELETE FROM student_notes WHERE student_id = ?', (student_id,))\n            \n            # Delete student account\n            conn.execute('DELETE FROM users WHERE id = ?', (student_id,))\n            conn.commit()\n            conn.close()\n            \n        return jsonify({'success': True, 'message': 'Student deleted successfully'})\n    except Exception as e:\n        logging.error(f\"Error deleting student: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n@app.route('/admin/students/<int:student_id>/toggle-block', methods=['POST'])\n@login_required\n@admin_required\ndef admin_toggle_student_block(student_id):\n    \"\"\"Toggle student block status\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            student = conn.execute('SELECT * FROM users WHERE id = ? AND role = \"student\"', (student_id,)).fetchone()\n            \n            if not student:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Student not found'}), 404\n            \n            # Toggle is_active status\n            new_status = 0 if student['is_active'] else 1\n            conn.execute('UPDATE users SET is_active = ? WHERE id = ?', (new_status, student_id))\n            conn.commit()\n            conn.close()\n            \n        return jsonify({'success': True, 'message': f'Student {\"unblocked\" if new_status else \"blocked\"} successfully'})\n    except Exception as e:\n        logging.error(f\"Error toggling student block: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n# INSTRUCTOR ROUTES\n@app.route('/instructor/dashboard')\n@instructor_required\ndef instructor_dashboard():\n    \"\"\"Enhanced instructor dashboard with course management\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # My courses\n        my_courses = conn.execute('''\n            SELECT c.*, \n                   COUNT(CASE WHEN e.status = 'approved' THEN 1 END) as approved_count,\n                   COUNT(CASE WHEN e.status = 'pending' THEN 1 END) as pending_count,\n                   COUNT(e.id) as total_enrollments\n            FROM courses c\n            LEFT JOIN enrollments e ON c.id = e.course_id\n            WHERE c.instructor_id = ? AND c.is_active = 1\n            GROUP BY c.id\n            ORDER BY c.created_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Pending enrollments for all my courses\n        pending_enrollments = conn.execute('''\n            SELECT e.*, u.full_name as student_name, u.email as student_email, \n                   c.title as course_title, c.course_code\n            FROM enrollments e\n            JOIN users u ON e.student_id = u.id\n            JOIN courses c ON e.course_id = c.id\n            WHERE c.instructor_id = ? AND e.status = 'pending'\n            ORDER BY e.enrolled_at ASC\n        ''', (current_user.id,)).fetchall()\n        \n        # Statistics\n        stats = {\n            'total_courses': len(my_courses),\n            'total_students': sum([course['approved_count'] for course in my_courses]),\n            'pending_enrollments': len(pending_enrollments),\n            'active_courses': len([c for c in my_courses if c['approved_count'] > 0])\n        }\n        \n        conn.close()\n    \n    return render_template('instructor/dashboard.html', \n                         courses=my_courses, \n                         pending_enrollments=pending_enrollments,\n                         stats=stats)\n\n@app.route('/instructor/courses/<int:course_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_course(course_id):\n    \"\"\"Delete a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ?\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        try:\n            # Delete related data - only from tables that exist\n            conn.execute('DELETE FROM enrollments WHERE course_id = ?', (course_id,))\n            \n            # Try to delete from optional tables if they exist\n            try:\n                conn.execute('DELETE FROM course_video_playlists WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            try:\n                conn.execute('DELETE FROM course_resources WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            try:\n                conn.execute('DELETE FROM course_meeting_links WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            try:\n                conn.execute('DELETE FROM quizzes WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            try:\n                conn.execute('DELETE FROM ai_notes WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            try:\n                conn.execute('DELETE FROM discussion_forums WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            # Delete the course itself\n            conn.execute('DELETE FROM courses WHERE id = ?', (course_id,))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Course \"{course[\"title\"]}\" has been deleted successfully.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            logging.error(f\"Error deleting course: {e}\")\n            flash('Error deleting course. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_courses'))\n\n\n@app.route('/instructor/courses')\n@instructor_required\ndef instructor_courses():\n    \"\"\"View and manage all instructor courses\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        courses = conn.execute('''\n            SELECT c.*, \n                   COUNT(CASE WHEN e.status = 'approved' THEN 1 END) as approved_count,\n                   COUNT(CASE WHEN e.status = 'pending' THEN 1 END) as pending_count\n            FROM courses c\n            LEFT JOIN enrollments e ON c.id = e.course_id\n            WHERE c.instructor_id = ? AND c.is_active = 1\n            GROUP BY c.id\n            ORDER BY c.created_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Fetch AI Notes PDFs for each course\n        courses_list = []\n        for course in courses:\n            course_dict = dict(course)\n            ai_notes = conn.execute('''\n                SELECT * FROM ai_notes \n                WHERE course_id = ? AND created_by = ? AND is_instructor_note = 1 AND pdf_path IS NOT NULL\n                ORDER BY created_at DESC LIMIT 5\n            ''', (course['id'], current_user.id)).fetchall()\n            course_dict['ai_notes'] = ai_notes\n            courses_list.append(course_dict)\n        \n        conn.close()\n    \n    return render_template('instructor/courses.html', courses=courses_list)\n\n@app.route('/instructor/courses/create', methods=['GET', 'POST'])\n@instructor_required\ndef instructor_create_course():\n    \"\"\"Create a new course with enrollment key\"\"\"\n    if request.method == 'POST':\n        # Get and validate required fields\n        course_code = request.form.get('course_code', '').strip().upper()\n        title = request.form.get('title', '').strip()\n        enrollment_key = request.form.get('enrollment_key', '').strip()\n        \n        # Validate required fields\n        if not course_code:\n            flash('Course Code is required.', 'error')\n            return render_template('instructor/create_course.html')\n        if not title:\n            flash('Course Title is required.', 'error')\n            return render_template('instructor/create_course.html')\n        if not enrollment_key:\n            flash('Enrollment Key is required.', 'error')\n            return render_template('instructor/create_course.html')\n        \n        # Get optional fields\n        description = request.form.get('description', '').strip()\n        syllabus = request.form.get('syllabus', '').strip()\n        category = request.form.get('category', '').strip()\n        max_students = int(request.form.get('max_students', 50))\n        start_date = request.form.get('start_date') or None\n        end_date = request.form.get('end_date') or None\n        \n        # Validate enrollment key\n        if len(enrollment_key) < 6:\n            flash('Enrollment key must be at least 6 characters long.', 'error')\n            return render_template('instructor/create_course.html')\n        \n        # Hash the enrollment key for security\n        enrollment_key_hash = generate_password_hash(enrollment_key)\n        \n        with db_lock:\n            conn = get_db_connection()\n            \n            # Check if course code already exists\n            existing_course = conn.execute(\n                'SELECT id FROM courses WHERE course_code = ?', (course_code,)\n            ).fetchone()\n            \n            if existing_course:\n                flash('Course code already exists. Please choose a different one.', 'error')\n                conn.close()\n                return render_template('instructor/create_course.html')\n            \n            try:\n                conn.execute('''\n                    INSERT INTO courses (\n                        course_code, title, description, syllabus, instructor_id, \n                        category, max_students, start_date, end_date, enrollment_key_hash\n                    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n                ''', (course_code, title, description, syllabus, current_user.id,\n                     category, max_students, start_date, end_date, enrollment_key_hash))\n                \n                conn.commit()\n                conn.close()\n                \n                flash(f'Course \"{title}\" created successfully!', 'success')\n                return redirect(url_for('instructor_courses'))\n                \n            except Exception as e:\n                conn.rollback()\n                conn.close()\n                flash('Error creating course. Please try again.', 'error')\n    \n    return render_template('instructor/create_course.html')\n\n@app.route('/instructor/courses/edit/<int:course_id>', methods=['GET', 'POST'])\n@instructor_required\ndef instructor_edit_course(course_id):\n    \"\"\"Edit an existing course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to current instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        if request.method == 'POST':\n            title = request.form['title'].strip()\n            description = request.form.get('description', '').strip()\n            syllabus = request.form.get('syllabus', '').strip()\n            category = request.form.get('category', '').strip()\n            max_students = int(request.form.get('max_students', 50))\n            start_date = request.form.get('start_date') or None\n            end_date = request.form.get('end_date') or None\n            \n            # Handle enrollment key update\n            enrollment_key = request.form.get('enrollment_key', '').strip()\n            if enrollment_key:\n                if len(enrollment_key) < 6:\n                    flash('Enrollment key must be at least 6 characters long.', 'error')\n                    conn.close()\n                    return render_template('instructor/edit_course.html', course=course)\n                enrollment_key_hash = generate_password_hash(enrollment_key)\n            else:\n                enrollment_key_hash = course['enrollment_key_hash']  # Keep existing\n            \n            try:\n                conn.execute('''\n                    UPDATE courses \n                    SET title = ?, description = ?, syllabus = ?, category = ?, \n                        max_students = ?, start_date = ?, end_date = ?, enrollment_key_hash = ?\n                    WHERE id = ?\n                ''', (title, description, syllabus, category, max_students, \n                     start_date, end_date, enrollment_key_hash, course_id))\n                \n                conn.commit()\n                conn.close()\n                \n                flash(f'Course \"{title}\" updated successfully!', 'success')\n                return redirect(url_for('instructor_courses'))\n                \n            except Exception as e:\n                conn.rollback()\n                conn.close()\n                flash('Error updating course. Please try again.', 'error')\n        \n        conn.close()\n    \n    return render_template('instructor/edit_course.html', course=course)\n\n@app.route('/instructor/enrollments')\n@instructor_required \ndef instructor_enrollments():\n    \"\"\"View all student enrollments for instructor's courses\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        enrollments = conn.execute('''\n            SELECT e.*, u.full_name as student_name, u.email as student_email,\n                   c.title as course_title, c.course_code,\n                   COALESCE(e.progress_percentage, 0) as progress_percentage\n            FROM enrollments e\n            JOIN users u ON e.student_id = u.id\n            JOIN courses c ON e.course_id = c.id\n            WHERE c.instructor_id = ?\n            ORDER BY \n                CASE e.status \n                    WHEN 'pending' THEN 1\n                    WHEN 'approved' THEN 2\n                    WHEN 'rejected' THEN 3\n                END,\n                e.enrolled_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Statistics\n        stats = {\n            'total_enrollments': len(enrollments),\n            'pending_enrollments': len([e for e in enrollments if e['status'] == 'pending']),\n            'approved_enrollments': len([e for e in enrollments if e['status'] == 'approved']),\n            'rejected_enrollments': len([e for e in enrollments if e['status'] == 'rejected'])\n        }\n        \n        conn.close()\n    \n    return render_template('instructor/enrollments.html', enrollments=enrollments, stats=stats)\n\n@app.route('/instructor/enrollments/approve/<int:enrollment_id>', methods=['POST'])\n@instructor_required\ndef instructor_approve_enrollment(enrollment_id):\n    \"\"\"Approve a student enrollment\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify enrollment belongs to instructor's course and is pending\n        enrollment = conn.execute('''\n            SELECT e.*, c.title as course_title, u.full_name as student_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON e.student_id = u.id\n            WHERE e.id = ? AND c.instructor_id = ? AND e.status = 'pending'\n        ''', (enrollment_id, current_user.id)).fetchone()\n        \n        if not enrollment:\n            flash('Enrollment not found or already processed.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_enrollments'))\n        \n        try:\n            # Approve the enrollment\n            conn.execute('''\n                UPDATE enrollments \n                SET status = 'approved', approved_at = CURRENT_TIMESTAMP\n                WHERE id = ?\n            ''', (enrollment_id,))\n            \n            # Create notification for the student\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (enrollment['student_id'],\n                  'Enrollment Approved',\n                  f'Great news! Your enrollment in \"{enrollment[\"course_title\"]}\" has been approved. You now have full access to the course.',\n                  'success',\n                  enrollment['course_id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Approved enrollment for {enrollment[\"student_name\"]} in {enrollment[\"course_title\"]}.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error approving enrollment. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_enrollments'))\n\n@app.route('/instructor/enrollments/reject/<int:enrollment_id>', methods=['POST'])\n@instructor_required\ndef instructor_reject_enrollment(enrollment_id):\n    \"\"\"Reject a student enrollment\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify enrollment belongs to instructor's course and is pending\n        enrollment = conn.execute('''\n            SELECT e.*, c.title as course_title, u.full_name as student_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON e.student_id = u.id\n            WHERE e.id = ? AND c.instructor_id = ? AND e.status = 'pending'\n        ''', (enrollment_id, current_user.id)).fetchone()\n        \n        if not enrollment:\n            flash('Enrollment not found or already processed.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_enrollments'))\n        \n        try:\n            # Reject the enrollment\n            conn.execute('''\n                UPDATE enrollments \n                SET status = 'rejected'\n                WHERE id = ?\n            ''', (enrollment_id,))\n            \n            # Create notification for the student\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (enrollment['student_id'],\n                  'Enrollment Not Approved',\n                  f'Your enrollment request for \"{enrollment[\"course_title\"]}\" was not approved. Please contact the instructor for more information.',\n                  'warning',\n                  enrollment['course_id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Rejected enrollment for {enrollment[\"student_name\"]} in {enrollment[\"course_title\"]}.', 'warning')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error rejecting enrollment. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_enrollments'))\n\n\n@app.route('/instructor/enrollments/block/<int:enrollment_id>', methods=['POST'])\n@instructor_required\ndef instructor_block_student(enrollment_id):\n    \"\"\"Block a student from a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify enrollment belongs to instructor's course and is approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.title as course_title, u.full_name as student_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON e.student_id = u.id\n            WHERE e.id = ? AND c.instructor_id = ? AND e.status = 'approved'\n        ''', (enrollment_id, current_user.id)).fetchone()\n        \n        if not enrollment:\n            flash('Enrollment not found or cannot be blocked.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_enrollments'))\n        \n        try:\n            # Block the enrollment\n            conn.execute('''\n                UPDATE enrollments \n                SET status = 'blocked'\n                WHERE id = ?\n            ''', (enrollment_id,))\n            \n            # Create notification for the student\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (enrollment['student_id'],\n                  'Course Access Blocked',\n                  f'Your access to \"{enrollment[\"course_title\"]}\" has been blocked by the instructor.',\n                  'warning',\n                  enrollment['course_id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Blocked {enrollment[\"student_name\"]} from {enrollment[\"course_title\"]}.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error blocking student. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_enrollments'))\n\n\n@app.route('/instructor/enrollments/remove/<int:enrollment_id>', methods=['POST'])\n@instructor_required\ndef instructor_remove_student(enrollment_id):\n    \"\"\"Remove a student from a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify enrollment belongs to instructor's course and is approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.title as course_title, u.full_name as student_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON e.student_id = u.id\n            WHERE e.id = ? AND c.instructor_id = ? AND e.status = 'approved'\n        ''', (enrollment_id, current_user.id)).fetchone()\n        \n        if not enrollment:\n            flash('Enrollment not found or cannot be removed.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_enrollments'))\n        \n        try:\n            # Delete the enrollment\n            conn.execute('DELETE FROM enrollments WHERE id = ?', (enrollment_id,))\n            \n            # Create notification for the student\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (enrollment['student_id'],\n                  'Removed from Course',\n                  f'You have been removed from \"{enrollment[\"course_title\"]}\" by the instructor.',\n                  'warning',\n                  enrollment['course_id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Removed {enrollment[\"student_name\"]} from {enrollment[\"course_title\"]}.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error removing student. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_enrollments'))\n\n\n@app.route('/instructor/enrollments/unblock/<int:enrollment_id>', methods=['POST'])\n@instructor_required\ndef instructor_unblock_student(enrollment_id):\n    \"\"\"Unblock a student from a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify enrollment belongs to instructor's course and is blocked\n        enrollment = conn.execute('''\n            SELECT e.*, c.title as course_title, u.full_name as student_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON e.student_id = u.id\n            WHERE e.id = ? AND c.instructor_id = ? AND e.status = 'blocked'\n        ''', (enrollment_id, current_user.id)).fetchone()\n        \n        if not enrollment:\n            flash('Enrollment not found or cannot be unblocked.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_enrollments'))\n        \n        try:\n            # Unblock the enrollment\n            conn.execute('''\n                UPDATE enrollments \n                SET status = 'approved'\n                WHERE id = ?\n            ''', (enrollment_id,))\n            \n            # Create notification for the student\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (enrollment['student_id'],\n                  'Course Access Restored',\n                  f'Your access to \"{enrollment[\"course_title\"]}\" has been restored by the instructor.',\n                  'success',\n                  enrollment['course_id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Unblocked {enrollment[\"student_name\"]} for {enrollment[\"course_title\"]}.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error unblocking student. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_enrollments'))\n\n# STUDENT PROGRESS MANAGEMENT ROUTES\n@app.route('/instructor/courses/<int:course_id>/students')\n@instructor_required\ndef instructor_course_students(course_id):\n    \"\"\"View and manage student progress for a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get all students enrolled in the course with their progress\n        students = conn.execute('''\n            SELECT \n                e.id as enrollment_id,\n                e.student_id,\n                u.full_name as student_name,\n                u.email as student_email,\n                e.status,\n                e.enrolled_at,\n                e.progress_percentage,\n                e.manual_progress_override,\n                COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n            FROM enrollments e\n            JOIN users u ON e.student_id = u.id\n            WHERE e.course_id = ? AND e.status = 'approved'\n            ORDER BY u.full_name\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/course_students.html', course=course, students=students)\n\n@app.route('/instructor/courses/<int:course_id>/set-progress-bulk', methods=['POST'])\n@instructor_required\ndef instructor_set_progress_bulk(course_id):\n    \"\"\"Set manual progress override for all students in a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ?\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            conn.close()\n            return jsonify({'success': False, 'error': 'Course not found or access denied'}), 403\n        \n        # Get progress value from request\n        progress = request.form.get('progress')\n        \n        if progress is None or progress == '':\n            conn.close()\n            return jsonify({'success': False, 'error': 'Please enter a progress value'}), 400\n        \n        # Validate progress value\n        try:\n            progress = float(progress)\n            if progress < 0 or progress > 100:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Progress must be between 0 and 100'}), 400\n        except ValueError:\n            conn.close()\n            return jsonify({'success': False, 'error': 'Invalid progress value'}), 400\n        \n        # Get all students in the course\n        try:\n            students = conn.execute('''\n                SELECT e.student_id, u.full_name\n                FROM enrollments e\n                JOIN users u ON e.student_id = u.id\n                WHERE e.course_id = ? AND e.status = 'approved'\n            ''', (course_id,)).fetchall()\n            \n            # Update progress for all students\n            for student in students:\n                conn.execute('''\n                    UPDATE enrollments\n                    SET manual_progress_override = ?, progress_percentage = ?\n                    WHERE course_id = ? AND student_id = ?\n                ''', (progress, progress, course_id, student['student_id']))\n                \n                # Send notification to each student\n                send_notification(\n                    student['student_id'],\n                    'Course Progress Updated',\n                    f'Your instructor has updated your progress in \"{course[\"title\"]}\" to {progress:.0f}%',\n                    'info',\n                    course_id\n                )\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({\n                'success': True, \n                'message': f'Progress set to {progress:.0f}% for all {len(students)} students',\n                'count': len(students)\n            })\n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            return jsonify({'success': False, 'error': str(e)}), 500\n\n@app.route('/instructor/courses/<int:course_id>/students/<int:student_id>/set-progress', methods=['POST'])\n@instructor_required\ndef instructor_set_student_progress(course_id, student_id):\n    \"\"\"Set manual progress override for a student\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ?\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            conn.close()\n            return jsonify({'success': False, 'error': 'Course not found or access denied'}), 403\n        \n        # Get progress value from request\n        progress = request.form.get('progress')\n        \n        if progress is None or progress == '':\n            # Clear manual override (reset to automatic calculation)\n            try:\n                conn.execute('''\n                    UPDATE enrollments\n                    SET manual_progress_override = NULL\n                    WHERE course_id = ? AND student_id = ?\n                ''', (course_id, student_id))\n                conn.commit()\n                \n                # Immediately recalculate automatic progress to get current quiz-based progress\n                auto_progress = update_student_progress(conn, student_id, course_id)\n                \n                # Get student info for notification\n                student = conn.execute('SELECT full_name FROM users WHERE id = ?', (student_id,)).fetchone()\n                \n                # Send notification to student\n                send_notification(\n                    student_id,\n                    'Course Progress Updated',\n                    f'Your progress in \"{course[\"title\"]}\" has been reset to automatic tracking ({auto_progress:.0f}%)',\n                    'info',\n                    course_id\n                )\n                \n                conn.close()\n                return jsonify({\n                    'success': True, \n                    'message': f'Manual progress cleared. Automatic progress is {auto_progress:.0f}%',\n                    'progress': auto_progress,\n                    'is_manual': False\n                })\n            except Exception as e:\n                conn.rollback()\n                conn.close()\n                return jsonify({'success': False, 'error': str(e)}), 500\n        \n        # Validate progress value\n        try:\n            progress = float(progress)\n            if progress < 0 or progress > 100:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Progress must be between 0 and 100'}), 400\n        except ValueError:\n            conn.close()\n            return jsonify({'success': False, 'error': 'Invalid progress value'}), 400\n        \n        # Set manual progress override\n        try:\n            conn.execute('''\n                UPDATE enrollments\n                SET manual_progress_override = ?, progress_percentage = ?\n                WHERE course_id = ? AND student_id = ?\n            ''', (progress, progress, course_id, student_id))\n            \n            # Get student info for notification\n            student = conn.execute('SELECT full_name FROM users WHERE id = ?', (student_id,)).fetchone()\n            \n            # Send notification to student\n            send_notification(\n                student_id,\n                'Course Progress Updated',\n                f'Your instructor has updated your progress in \"{course[\"title\"]}\" to {progress:.0f}%',\n                'info',\n                course_id\n            )\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({\n                'success': True, \n                'message': f'Progress set to {progress:.0f}% for {student[\"full_name\"]}',\n                'progress': progress,\n                'is_manual': True\n            })\n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            return jsonify({'success': False, 'error': str(e)}), 500\n\n# COURSE CONTENT MANAGEMENT ROUTES\n@app.route('/instructor/courses/<int:course_id>/content')\n@instructor_required\ndef instructor_course_content(course_id):\n    \"\"\"Manage course content - videos, notes, resources\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get course resources\n        resources = conn.execute('''\n            SELECT * FROM course_resources \n            WHERE course_id = ?\n            ORDER BY upload_date DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get meeting links\n        meeting_links = conn.execute('''\n            SELECT * FROM course_meeting_links \n            WHERE course_id = ? AND is_active = 1\n            ORDER BY created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get video playlist\n        video_playlist = conn.execute('''\n            SELECT * FROM course_video_playlists \n            WHERE course_id = ? AND is_active = 1\n            ORDER BY order_index ASC\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/course_content.html', course=course, resources=resources, \n                         meeting_links=meeting_links, video_playlist=video_playlist)\n\n@app.route('/instructor/courses/<int:course_id>/content/upload', methods=['POST'])\n@instructor_required\ndef instructor_upload_content(course_id):\n    \"\"\"Upload course content - videos, notes, resources\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        description = request.form.get('description', '').strip()\n        content_type = request.form.get('content_type', 'document')\n        \n        if 'file' in request.files:\n            file = request.files['file']\n            if file and file.filename:\n                filename = secure_filename(file.filename)\n                file_path = os.path.join(app.config['UPLOAD_FOLDER'], 'resources', f\"{course_id}_{uuid.uuid4().hex}_{filename}\")\n                file.save(file_path)\n                \n                try:\n                    conn.execute('''\n                        INSERT INTO course_resources (course_id, title, description, file_path, file_type, uploaded_by)\n                        VALUES (?, ?, ?, ?, ?, ?)\n                    ''', (course_id, title, description, file_path, content_type, current_user.id))\n                    \n                    conn.commit()\n                    flash(f'Content \"{title}\" uploaded successfully!', 'success')\n                    \n                except Exception as e:\n                    conn.rollback()\n                    flash('Error uploading content. Please try again.', 'error')\n        else:\n            flash('No file selected for upload.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n# MEETING LINKS MANAGEMENT ROUTES\n@app.route('/instructor/courses/<int:course_id>/meeting-links/add', methods=['POST'])\n@instructor_required\ndef instructor_add_meeting_link(course_id):\n    \"\"\"Add a meeting link to the course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        meeting_link = request.form.get('meeting_link', '').strip()\n        description = request.form.get('description', '').strip()\n        scheduled_time = request.form.get('scheduled_time') or None\n        \n        if not title or not meeting_link:\n            flash('Meeting title and link are required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_content', course_id=course_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO course_meeting_links (course_id, title, meeting_link, description, scheduled_time, created_by)\n                VALUES (?, ?, ?, ?, ?, ?)\n            ''', (course_id, title, meeting_link, description, scheduled_time, current_user.id))\n            \n            conn.commit()\n            flash(f'Meeting link \"{title}\" added successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error adding meeting link. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n@app.route('/instructor/courses/<int:course_id>/meeting-links/<int:link_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_meeting_link(course_id, link_id):\n    \"\"\"Delete a meeting link\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        try:\n            conn.execute('''\n                DELETE FROM course_meeting_links \n                WHERE id = ? AND course_id = ? AND created_by = ?\n            ''', (link_id, course_id, current_user.id))\n            \n            conn.commit()\n            flash('Meeting link deleted successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error deleting meeting link. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n# VIDEO PLAYLIST MANAGEMENT ROUTES\n@app.route('/instructor/courses/<int:course_id>/video-playlist/add', methods=['POST'])\n@instructor_required\ndef instructor_add_video_playlist(course_id):\n    \"\"\"Add a video to the course playlist\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        video_url = request.form.get('video_url', '').strip()\n        description = request.form.get('description', '').strip()\n        duration = request.form.get('duration', '').strip()\n        thumbnail_url = request.form.get('thumbnail_url', '').strip()\n        \n        if not title or not video_url:\n            flash('Video title and URL are required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_content', course_id=course_id))\n        \n        # Handle notes file upload with validation\n        notes_file_path = None\n        ALLOWED_NOTES_EXTENSIONS = {'pdf', 'doc', 'docx', 'txt', 'ppt', 'pptx', 'odt', 'rtf'}\n        MAX_NOTES_SIZE = 50 * 1024 * 1024  # 50MB\n        \n        if 'notes_file' in request.files:\n            notes_file = request.files['notes_file']\n            if notes_file and notes_file.filename:\n                filename = secure_filename(notes_file.filename)\n                file_ext = filename.rsplit('.', 1)[1].lower() if '.' in filename else ''\n                \n                # Validate file extension\n                if file_ext not in ALLOWED_NOTES_EXTENSIONS:\n                    flash(f'Invalid file type. Allowed: {\", \".join(ALLOWED_NOTES_EXTENSIONS)}', 'error')\n                    conn.close()\n                    return redirect(url_for('instructor_course_content', course_id=course_id))\n                \n                # Check file size\n                notes_file.seek(0, 2)  # Seek to end\n                file_size = notes_file.tell()\n                notes_file.seek(0)  # Reset to beginning\n                \n                if file_size > MAX_NOTES_SIZE:\n                    flash('Notes file too large. Maximum size is 50MB.', 'error')\n                    conn.close()\n                    return redirect(url_for('instructor_course_content', course_id=course_id))\n                \n                # Save the file\n                notes_file_path = os.path.join(app.config['UPLOAD_FOLDER'], 'resources', f\"notes_{course_id}_{uuid.uuid4().hex}_{filename}\")\n                os.makedirs(os.path.dirname(notes_file_path), exist_ok=True)\n                notes_file.save(notes_file_path)\n        \n        try:\n            # Get the next order index\n            max_order = conn.execute('''\n                SELECT MAX(order_index) FROM course_video_playlists \n                WHERE course_id = ?\n            ''', (course_id,)).fetchone()[0]\n            \n            next_order = (max_order or 0) + 1\n            \n            conn.execute('''\n                INSERT INTO course_video_playlists (course_id, title, video_url, description, duration, thumbnail_url, notes_file_path, order_index, created_by)\n                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n            ''', (course_id, title, video_url, description, duration, thumbnail_url, notes_file_path, next_order, current_user.id))\n            \n            conn.commit()\n            flash(f'Video \"{title}\" added to playlist successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error adding video to playlist. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n@app.route('/download-notes/<int:video_id>')\n@login_required\ndef download_video_notes(video_id):\n    \"\"\"Download notes for a video\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id \n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video or not video['notes_file_path']:\n            conn.close()\n            flash('Notes not found.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                flash('Access denied.', 'error')\n                return redirect(url_for('dashboard'))\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            flash('Access denied.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        stored_path = video['notes_file_path']\n        conn.close()\n        \n        # Try to find the actual file - handle incorrect paths from different systems\n        file_path = None\n        filename = os.path.basename(stored_path)\n        \n        # Try multiple possible locations\n        possible_paths = [\n            stored_path,  # Original path\n            os.path.join(app.config['UPLOAD_FOLDER'], 'resources', filename),  # Current system path\n            os.path.join('sir_rafique', 'uploads', 'resources', filename),  # Relative path\n        ]\n        \n        for path in possible_paths:\n            if os.path.exists(path):\n                file_path = path\n                break\n        \n        if not file_path:\n            logging.error(f\"Notes file not found. Tried paths: {possible_paths}\")\n            flash('Notes file not found on server. Please contact your instructor.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Send the file\n        try:\n            directory = os.path.dirname(file_path)\n            filename = os.path.basename(file_path)\n            \n            # Get original extension for proper MIME type\n            file_ext = filename.rsplit('.', 1)[1].lower() if '.' in filename else 'pdf'\n            mime_types = {\n                'pdf': 'application/pdf',\n                'doc': 'application/msword',\n                'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n                'txt': 'text/plain',\n                'ppt': 'application/vnd.ms-powerpoint',\n                'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation'\n            }\n            \n            return send_from_directory(\n                directory, \n                filename, \n                as_attachment=True,\n                mimetype=mime_types.get(file_ext, 'application/octet-stream')\n            )\n        except Exception as e:\n            logging.error(f\"Error downloading notes: {e}\")\n            flash('Unable to download notes. Please try again.', 'error')\n            return redirect(url_for('dashboard'))\n\n@app.route('/instructor/courses/<int:course_id>/content/video/<int:video_id>/edit', methods=['POST'])\n@instructor_required\ndef instructor_edit_video_playlist(course_id, video_id):\n    \"\"\"Edit a video in playlist\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify video belongs to instructor's course\n        video = conn.execute('''\n            SELECT v.* FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.course_id = ? AND c.instructor_id = ? AND v.is_active = 1\n        ''', (video_id, course_id, current_user.id)).fetchone()\n        \n        if not video:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Video not found or access denied.'}), 404\n        \n        try:\n            title = request.form.get('title', '').strip()\n            video_url = request.form.get('video_url', '').strip()\n            duration = request.form.get('duration', '').strip()\n            description = request.form.get('description', '').strip()\n            \n            if not title or not video_url:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Title and URL are required.'}), 400\n            \n            # Update the video\n            conn.execute('''\n                UPDATE course_video_playlists\n                SET title = ?, video_url = ?, duration = ?, description = ?\n                WHERE id = ? AND course_id = ? AND is_active = 1\n            ''', (title, video_url, duration or None, description or None, video_id, course_id))\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({'success': True, 'message': 'Video updated successfully!'}), 200\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            logging.error(f\"Error updating video: {e}\")\n            return jsonify({'success': False, 'message': 'Error updating video. Please try again.'}), 500\n\n@app.route('/instructor/courses/<int:course_id>/video-playlist/<int:video_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_video_playlist(course_id, video_id):\n    \"\"\"Delete a video from playlist\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        try:\n            conn.execute('''\n                DELETE FROM course_video_playlists \n                WHERE id = ? AND course_id = ? AND created_by = ?\n            ''', (video_id, course_id, current_user.id))\n            \n            conn.commit()\n            flash('Video deleted from playlist successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error deleting video. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n# STUDENT VIDEO PLAYLIST ROUTES\n@app.route('/student/my-playlist')\n@login_required\ndef student_my_playlist():\n    \"\"\"View student's personal video playlist\"\"\"\n    if not current_user.is_student():\n        flash('Access denied.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        rows = conn.execute('''\n            SELECT * FROM student_video_playlists \n            WHERE student_id = ? AND is_active = 1\n            ORDER BY order_index ASC\n        ''', (current_user.id,)).fetchall()\n        # Convert Row objects to dictionaries for JSON serialization\n        videos = [dict(row) for row in rows]\n        conn.close()\n    \n    return render_template('student/my_playlist.html', videos=videos)\n\n@app.route('/student/playlist/add', methods=['POST'])\n@login_required\ndef student_add_playlist_video():\n    \"\"\"Add video to student playlist\"\"\"\n    if not current_user.is_student():\n        return jsonify({'success': False, 'message': 'Access denied.'}), 403\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        title = request.form.get('title', '').strip()\n        video_url = request.form.get('video_url', '').strip()\n        description = request.form.get('description', '').strip()\n        duration = request.form.get('duration', '').strip()\n        \n        if not title or not video_url:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Title and URL are required.'}), 400\n        \n        try:\n            conn.execute('''\n                INSERT INTO student_video_playlists \n                (student_id, title, video_url, description, duration, order_index)\n                VALUES (?, ?, ?, ?, ?, (SELECT COUNT(*) FROM student_video_playlists WHERE student_id = ?))\n            ''', (current_user.id, title, video_url, description or None, duration or None, current_user.id))\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({'success': True, 'message': 'Video added to playlist!'}), 200\n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            logging.error(f\"Error adding playlist video: {e}\")\n            return jsonify({'success': False, 'message': 'Error adding video. Please try again.'}), 500\n\n@app.route('/student/playlist/<int:video_id>/edit', methods=['POST'])\n@login_required\ndef student_edit_playlist_video(video_id):\n    \"\"\"Edit student playlist video\"\"\"\n    if not current_user.is_student():\n        return jsonify({'success': False, 'message': 'Access denied.'}), 403\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        video = conn.execute('''\n            SELECT * FROM student_video_playlists \n            WHERE id = ? AND student_id = ? AND is_active = 1\n        ''', (video_id, current_user.id)).fetchone()\n        \n        if not video:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Video not found.'}), 404\n        \n        title = request.form.get('title', '').strip()\n        video_url = request.form.get('video_url', '').strip()\n        description = request.form.get('description', '').strip()\n        duration = request.form.get('duration', '').strip()\n        \n        if not title or not video_url:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Title and URL are required.'}), 400\n        \n        try:\n            conn.execute('''\n                UPDATE student_video_playlists\n                SET title = ?, video_url = ?, description = ?, duration = ?\n                WHERE id = ? AND student_id = ? AND is_active = 1\n            ''', (title, video_url, description or None, duration or None, video_id, current_user.id))\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({'success': True, 'message': 'Video updated successfully!'}), 200\n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            logging.error(f\"Error updating playlist video: {e}\")\n            return jsonify({'success': False, 'message': 'Error updating video.'}), 500\n\n@app.route('/student/playlist/<int:video_id>/delete', methods=['POST'])\n@login_required\ndef student_delete_playlist_video(video_id):\n    \"\"\"Delete video from student playlist\"\"\"\n    if not current_user.is_student():\n        return jsonify({'success': False, 'message': 'Access denied.'}), 403\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        try:\n            conn.execute('''\n                DELETE FROM student_video_playlists \n                WHERE id = ? AND student_id = ?\n            ''', (video_id, current_user.id))\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({'success': True, 'message': 'Video deleted!'}), 200\n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            logging.error(f\"Error deleting playlist video: {e}\")\n            return jsonify({'success': False, 'message': 'Error deleting video.'}), 500\n\n@app.route('/generate-transcript/<int:video_id>', methods=['POST'])\n@login_required\ndef generate_video_transcript(video_id):\n    \"\"\"Generate AI transcript for a video and save as PDF with watermark\"\"\"\n    try:\n        from utils.pdf_generator import generate_transcript_pdf\n    except ImportError:\n        logging.error(\"PDF generator not available\")\n        return jsonify({'success': False, 'message': 'PDF generation service not available. Please check system configuration.'}), 500\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id, c.title as course_title, c.course_code\n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Video not found.'}), 404\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Access denied.'}), 403\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Access denied.'}), 403\n        \n        try:\n            # Generate transcript using Gemini AI from actual YouTube video\n            transcript_text = gemini_ai.generate_video_transcript(\n                video['title'],\n                video['description'] or '',\n                video['duration'] or '',\n                video['video_url'] or ''\n            )\n            \n            if not transcript_text or len(transcript_text) < 10:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Failed to generate transcript. Please check your Gemini API key.'}), 500\n            \n            # Generate PDF filename\n            safe_filename = secure_filename(video['title'])\n            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n            pdf_filename = f\"transcript_{video_id}_{timestamp}.pdf\"\n            transcript_folder = os.path.join(app.config['UPLOAD_FOLDER'], 'transcripts')\n            os.makedirs(transcript_folder, exist_ok=True)\n            pdf_path = os.path.join(transcript_folder, pdf_filename)\n            \n            # Generate PDF with watermark\n            success = generate_transcript_pdf(\n                transcript_text=transcript_text,\n                video_title=video['title'],\n                course_name=f\"{video['course_code']} - {video['course_title']}\",\n                student_name=current_user.full_name,\n                output_path=pdf_path\n            )\n            \n            if success:\n                # Save relative path to database (not absolute)\n                relative_path = os.path.join('sir_rafique', 'uploads', 'transcripts', pdf_filename)\n                \n                # Update database with transcript path\n                conn.execute('''\n                    UPDATE course_video_playlists \n                    SET transcript_file_path = ?\n                    WHERE id = ?\n                ''', (relative_path, video_id))\n                conn.commit()\n                conn.close()\n                \n                logging.info(f\"Transcript generated successfully for video {video_id}\")\n                return jsonify({\n                    'success': True,\n                    'message': 'Transcript generated successfully!',\n                    'download_url': url_for('download_video_transcript', video_id=video_id)\n                })\n            else:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Error generating PDF. Please try again.'}), 500\n                \n        except ValueError as ve:\n            conn.close()\n            logging.error(f\"Gemini API Key Error: {ve}\")\n            return jsonify({'success': False, 'message': 'Gemini API is not configured. Please set GEMINI_API_KEY environment variable.'}), 500\n        except Exception as e:\n            conn.close()\n            logging.error(f\"Error generating transcript: {e}\")\n            return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500\n\n@app.route('/generate-student-notes', methods=['POST'])\n@login_required\ndef generate_student_notes_route():\n    \"\"\"Generate AI-enhanced notes from student input and save as PDF with LearnNest watermark\"\"\"\n    try:\n        from utils.pdf_generator import generate_transcript_pdf\n    except ImportError:\n        logging.error(\"PDF generator not available\")\n        return jsonify({'success': False, 'message': 'PDF generation service not available.'}), 500\n    \n    try:\n        data = request.get_json()\n        student_notes_input = data.get('topic', '').strip()\n        course_id = data.get('course_id')\n        add_watermark = data.get('add_watermark', True)  # Default to True\n        \n        if not student_notes_input or len(student_notes_input) < 3:\n            return jsonify({'success': False, 'message': 'Please enter a topic.'}), 400\n        \n        with db_lock:\n            conn = get_db_connection()\n            \n            # Get course details\n            course = conn.execute('''\n                SELECT * FROM courses WHERE id = ?\n            ''', (course_id,)).fetchone()\n            \n            if not course:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Course not found.'}), 404\n            \n            # Check student has access\n            if current_user.is_student():\n                enrollment = conn.execute('''\n                    SELECT * FROM enrollments \n                    WHERE student_id = ? AND course_id = ? AND status = 'approved'\n                ''', (current_user.id, course_id)).fetchone()\n                if not enrollment:\n                    conn.close()\n                    return jsonify({'success': False, 'message': 'Access denied.'}), 403\n            \n            # Generate enhanced notes using Gemini AI\n            enhanced_notes = gemini_ai.generate_student_notes(\n                student_notes_input,\n                course['title'],\n                course['course_code']\n            )\n            \n            if not enhanced_notes or len(enhanced_notes) < 10:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Failed to enhance notes. Please try again.'}), 500\n            \n            # Generate PDF filename\n            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n            pdf_filename = f\"student_notes_{current_user.id}_{timestamp}.pdf\"\n            notes_folder = os.path.join(app.config['UPLOAD_FOLDER'], 'student_notes')\n            os.makedirs(notes_folder, exist_ok=True)\n            pdf_path = os.path.join(notes_folder, pdf_filename)\n            \n            # Generate PDF with optional watermark\n            success = generate_transcript_pdf(\n                transcript_text=enhanced_notes,\n                video_title=f\"Study Notes - {course['title']}\",\n                course_name=f\"{course['course_code']} - {course['title']}\",\n                student_name=current_user.full_name,\n                output_path=pdf_path,\n                add_watermark=add_watermark\n            )\n            \n            if success:\n                # Save to database\n                conn.execute('''\n                    INSERT INTO student_notes (student_id, course_id, original_input, enhanced_notes, file_path, created_at)\n                    VALUES (?, ?, ?, ?, ?, ?)\n                ''', (\n                    current_user.id,\n                    course_id,\n                    student_notes_input,\n                    enhanced_notes,\n                    os.path.join('sir_rafique', 'uploads', 'student_notes', pdf_filename),\n                    datetime.now()\n                ))\n                conn.commit()\n                \n                # Get the inserted note ID\n                note_id = conn.execute('SELECT last_insert_rowid()').fetchone()[0]\n                conn.close()\n                \n                # Send notification to student\n                socketio.emit('notification', {\n                    'title': 'ðŸ“š Study Notes Generated!',\n                    'message': f'Your AI-generated study notes for \"{student_notes_input}\" are ready!',\n                    'type': 'success',\n                    'icon': 'fa-book'\n                }, to=f'user_{current_user.id}')\n                \n                logging.info(f\"Student notes generated for student {current_user.id}\")\n                return jsonify({\n                    'success': True,\n                    'message': 'Enhanced study notes generated successfully!',\n                    'note_id': note_id,\n                    'enhanced_notes': enhanced_notes,\n                    'download_url': url_for('download_student_notes', note_id=note_id)\n                })\n            else:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Error generating PDF.'}), 500\n                \n    except ValueError as ve:\n        logging.error(f\"Gemini API Key Error: {ve}\")\n        return jsonify({'success': False, 'message': 'Gemini API not configured.'}), 500\n    except Exception as e:\n        logging.error(f\"Error generating student notes: {e}\")\n        return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500\n\n@app.route('/download-student-notes/<int:note_id>')\n@login_required\ndef download_student_notes(note_id):\n    \"\"\"Download student's enhanced notes PDF\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            note = conn.execute('''\n                SELECT * FROM student_notes WHERE id = ? AND student_id = ?\n            ''', (note_id, current_user.id)).fetchone()\n            conn.close()\n        \n        if not note:\n            logging.warning(f\"Note {note_id} not found for student {current_user.id}\")\n            return jsonify({'error': 'Note not found'}), 404\n        \n        stored_path = note['file_path']\n        filename = os.path.basename(stored_path)\n        \n        # Try multiple possible locations\n        possible_paths = [\n            stored_path,  # Original path as stored\n            os.path.join(app.config['UPLOAD_FOLDER'], filename),  # In uploads folder\n            os.path.join(app.config['UPLOAD_FOLDER'], 'student_notes', filename),  # In student_notes subfolder\n            os.path.join('sir_rafique', 'uploads', filename),  # Relative path from project root\n            os.path.join('sir_rafique', 'uploads', 'student_notes', filename),  # With subfolder\n        ]\n        \n        file_path = None\n        for path in possible_paths:\n            if os.path.exists(path):\n                file_path = path\n                logging.info(f\"Found notes file at: {path}\")\n                break\n        \n        if not file_path:\n            logging.error(f\"Student notes file not found. Note ID: {note_id}, Stored path: {stored_path}, Tried paths: {possible_paths}\")\n            return jsonify({'error': 'File not found on server'}), 404\n        \n        # Send the file\n        try:\n            directory = os.path.dirname(file_path)\n            filename = os.path.basename(file_path)\n            return send_file(file_path, as_attachment=True, download_name=f\"study_notes_{note_id}.pdf\")\n        except Exception as send_error:\n            logging.error(f\"Error sending file: {send_error}\")\n            return jsonify({'error': 'Error sending file'}), 500\n            \n    except Exception as e:\n        logging.error(f\"Error downloading student notes: {e}\")\n        return jsonify({'error': 'Download error'}), 500\n\n@app.route('/api/ai-assistant', methods=['POST'])\n@login_required\ndef ai_assistant():\n    \"\"\"AI Study Assistant - Answer student questions instantly using Gemini AI with visual generation\"\"\"\n    try:\n        data = request.get_json()\n        question = data.get('question', '').strip()\n        \n        if not question or len(question) < 3:\n            return jsonify({'success': False, 'message': 'Please enter a valid question.'}), 400\n        \n        try:\n            # Use Gemini AI to answer the question with visual capability\n            result = gemini_ai.answer_student_question(question)\n            \n            # Handle both dict and string responses for backward compatibility\n            if isinstance(result, dict):\n                answer_text = result.get('answer', '')\n                needs_visual = result.get('needs_visual', False)\n                visual_prompt = result.get('visual_prompt', None)\n            else:\n                answer_text = result\n                needs_visual = False\n                visual_prompt = None\n            \n            if answer_text and \"error\" not in answer_text.lower():\n                response_data = {\n                    'success': True,\n                    'answer': answer_text,\n                    'has_visual': needs_visual\n                }\n                \n                # If visual is needed, generate it using Gemini's Imagen\n                if needs_visual and visual_prompt:\n                    try:\n                        from google import genai\n                        client = genai.Client(api_key=os.environ.get(\"GEMINI_API_KEY\"))\n                        \n                        # Generate image using Imagen 3\n                        image_response = client.models.generate_images(\n                            model='imagen-3.0-generate-001',\n                            prompt=visual_prompt,\n                            config=types.GenerateImagesConfig(\n                                number_of_images=1,\n                                aspect_ratio='1:1',\n                                safety_filter_level='block_some',\n                                person_generation='allow_adult'\n                            )\n                        )\n                        \n                        if image_response and image_response.generated_images:\n                            # Save the generated image\n                            import base64\n                            image_data = image_response.generated_images[0].image.image_bytes\n                            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n                            filename = f\"ai_visual_{current_user.id}_{timestamp}.png\"\n                            visual_folder = os.path.join(app.config['UPLOAD_FOLDER'], 'ai_visuals')\n                            os.makedirs(visual_folder, exist_ok=True)\n                            image_path = os.path.join(visual_folder, filename)\n                            \n                            with open(image_path, 'wb') as f:\n                                f.write(image_data)\n                            \n                            response_data['visual_url'] = f\"/uploads/ai_visuals/{filename}\"\n                            logging.info(f\"Generated visual for question: {question[:50]}...\")\n                    except Exception as img_error:\n                        logging.warning(f\"Could not generate visual: {img_error}\")\n                        # Continue without visual if generation fails\n                \n                logging.info(f\"AI Assistant answered question for user {current_user.id}\")\n                return jsonify(response_data)\n            else:\n                return jsonify({\n                    'success': False,\n                    'message': 'Unable to generate answer at this time. Please try again.'\n                }), 500\n                \n        except Exception as e:\n            logging.error(f\"Error in AI Assistant: {e}\")\n            return jsonify({\n                'success': False,\n                'message': 'Error processing your question. Please try again.'\n            }), 500\n            \n    except Exception as e:\n        logging.error(f\"AI Assistant request error: {e}\")\n        return jsonify({'success': False, 'message': 'Invalid request.'}), 400\n\n@app.route('/generate-notes/<int:video_id>', methods=['POST'])\n@login_required\ndef generate_video_notes_route(video_id):\n    \"\"\"Generate AI study notes for a video and save as PDF\"\"\"\n    try:\n        from utils.pdf_generator import generate_transcript_pdf\n    except ImportError:\n        logging.error(\"PDF generator not available\")\n        return jsonify({'success': False, 'message': 'PDF generation service not available. Please check system configuration.'}), 500\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id, c.title as course_title, c.course_code\n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Video not found.'}), 404\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Access denied.'}), 403\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Access denied.'}), 403\n        \n        try:\n            # Generate AI notes using Gemini AI\n            notes_text = gemini_ai.generate_video_notes(\n                video['title'],\n                video['description'] or '',\n                video['duration'] or '',\n                video['video_url'] or ''\n            )\n            \n            if not notes_text or len(notes_text) < 10:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Failed to generate notes. Please check your Gemini API key.'}), 500\n            \n            # Generate PDF filename\n            safe_filename = secure_filename(video['title'])\n            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n            pdf_filename = f\"ai_notes_{video_id}_{timestamp}.pdf\"\n            notes_folder = os.path.join(app.config['UPLOAD_FOLDER'], 'resources')\n            os.makedirs(notes_folder, exist_ok=True)\n            pdf_path = os.path.join(notes_folder, pdf_filename)\n            \n            # Generate PDF with watermark (reuse transcript PDF function with different title)\n            success = generate_transcript_pdf(\n                transcript_text=notes_text,\n                video_title=f\"Study Notes: {video['title']}\",\n                course_name=f\"{video['course_code']} - {video['course_title']}\",\n                student_name=current_user.full_name,\n                output_path=pdf_path\n            )\n            \n            if success:\n                # Save relative path to database (not absolute)\n                relative_path = os.path.join('sir_rafique', 'uploads', 'resources', pdf_filename)\n                \n                # Update database with AI notes path\n                conn.execute('''\n                    UPDATE course_video_playlists \n                    SET notes_file_path = ?\n                    WHERE id = ?\n                ''', (relative_path, video_id))\n                conn.commit()\n                conn.close()\n                \n                logging.info(f\"AI notes generated successfully for video {video_id}\")\n                return jsonify({\n                    'success': True,\n                    'message': 'AI Study Notes generated successfully!',\n                    'download_url': url_for('download_video_notes', video_id=video_id)\n                })\n            else:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Error generating PDF. Please try again.'}), 500\n                \n        except ValueError as ve:\n            conn.close()\n            logging.error(f\"Gemini API Key Error: {ve}\")\n            return jsonify({'success': False, 'message': 'Gemini API is not configured. Please set GEMINI_API_KEY environment variable.'}), 500\n        except Exception as e:\n            conn.close()\n            logging.error(f\"Error generating notes: {e}\")\n            return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500\n\n@app.route('/download-transcript/<int:video_id>')\n@login_required\ndef download_video_transcript(video_id):\n    \"\"\"Download AI-generated transcript PDF for a video\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id \n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video or not video['transcript_file_path']:\n            conn.close()\n            flash('Transcript not found. Please generate it first.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                flash('Access denied.', 'error')\n                return redirect(url_for('dashboard'))\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            flash('Access denied.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        stored_path = video['transcript_file_path']\n        conn.close()\n        \n        # Try to find the actual file - handle incorrect paths from different systems\n        file_path = None\n        filename = os.path.basename(stored_path)\n        \n        # Try multiple possible locations\n        possible_paths = [\n            stored_path,  # Original path\n            os.path.join(app.config['UPLOAD_FOLDER'], 'transcripts', filename),  # Current system path\n            os.path.join('sir_rafique', 'uploads', 'transcripts', filename),  # Relative path\n        ]\n        \n        for path in possible_paths:\n            if os.path.exists(path):\n                file_path = path\n                break\n        \n        if not file_path:\n            logging.error(f\"Transcript file not found. Tried paths: {possible_paths}\")\n            flash('Transcript file not found. Please generate it again.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Send the transcript PDF file\n        try:\n            directory = os.path.dirname(file_path)\n            filename = os.path.basename(file_path)\n            \n            # Create a clean download filename\n            safe_title = \"\".join(c for c in video['title'] if c.isalnum() or c in (' ', '-', '_')).rstrip()\n            download_filename = f\"transcript_{safe_title}.pdf\"\n            \n            return send_from_directory(\n                directory, \n                filename, \n                as_attachment=True, \n                download_name=download_filename,\n                mimetype='application/pdf'\n            )\n        except Exception as e:\n            logging.error(f\"Error downloading transcript: {e}\")\n            flash(f'Unable to download transcript. Please try again.', 'error')\n            return redirect(url_for('dashboard'))\n\n@app.route('/download-video/<int:video_id>')\n@login_required\ndef download_video(video_id):\n    \"\"\"Download YouTube video for a course using yt-dlp\"\"\"\n    import subprocess\n    import tempfile\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id \n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video:\n            conn.close()\n            flash('Video not found.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                flash('Access denied.', 'error')\n                return redirect(url_for('dashboard'))\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            flash('Access denied.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        video_url = video['video_url']\n        conn.close()\n        \n        # Render download page with embedded downloader\n        return render_template('student/video_download.html', video=video)\n\n# VIDEO DOWNLOADER ROUTES (PyTubeFix Integration)\n@app.route('/video-downloader')\n@login_required\ndef video_downloader_home():\n    \"\"\"Main video downloader page\"\"\"\n    return render_template('student/video_download.html', video=None)\n\ndef clean_youtube_url(link: str) -> str:\n    \"\"\"Cleans YouTube URL by removing tracking parameters while preserving the video ID.\"\"\"\n    from urllib.parse import urlparse, parse_qs, urlencode, urlunparse\n    \n    parsed = urlparse(link)\n    query_params = parse_qs(parsed.query)\n    \n    # Keep only the 'v' parameter (video ID) if it exists\n    if 'v' in query_params:\n        cleaned_query = urlencode({'v': query_params['v'][0]})\n        cleaned_url = urlunparse((\n            parsed.scheme,\n            parsed.netloc,\n            parsed.path,\n            parsed.params,\n            cleaned_query,\n            ''  # Remove fragment\n        ))\n        return cleaned_url\n    \n    # If no 'v' parameter, return original (might be a youtu.be short link)\n    return link\n\n@app.route('/submit', methods=['GET', 'POST'])\n@login_required\ndef submit_video_download():\n    \"\"\"Download YouTube video using PyTubeFix\"\"\"\n    try:\n        # Get link from either query parameter (GET) or form data (POST)\n        link = request.args.get('link') or request.form.get('link', '')\n        link = link.strip()\n        \n        if not link:\n            flash('Please provide a valid YouTube URL', 'error')\n            return redirect(url_for('video_downloader_home'))\n        \n        # Create downloads directory\n        downloads_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'video_downloads')\n        os.makedirs(downloads_dir, exist_ok=True)\n        \n        # Clean old downloads (keep only last 3 files)\n        existing_files = os.listdir(downloads_dir)\n        if len(existing_files) > 3:\n            for f in existing_files:\n                os.remove(os.path.join(downloads_dir, f))\n        \n        clean = clean_youtube_url(link)\n        yt = YouTube(clean)\n        \n        stream = yt.streams.get_lowest_resolution()\n        filename = f\"video_{datetime.now().strftime('%Y%m%d_%H%M%S')}.mp4\"\n        out_file = stream.download(output_path=downloads_dir, filename=filename)\n        \n        return send_from_directory(downloads_dir, filename, as_attachment=True)\n    \n    except Exception as e:\n        logging.error(f\"Error downloading video: {e}\")\n        flash(f'Error downloading video: {str(e)}', 'error')\n        return redirect(url_for('video_downloader_home'))\n\n@app.route('/submit_audio', methods=['GET', 'POST'])\n@login_required\ndef submit_audio_download():\n    \"\"\"Download YouTube audio using PyTubeFix\"\"\"\n    try:\n        # Get link from either query parameter (GET) or form data (POST)\n        link = request.args.get('link') or request.form.get('link', '')\n        link = link.strip()\n        \n        if not link:\n            flash('Please provide a valid YouTube URL', 'error')\n            return redirect(url_for('video_downloader_home'))\n        \n        # Create downloads directory\n        downloads_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'audio_downloads')\n        os.makedirs(downloads_dir, exist_ok=True)\n        \n        # Clean old downloads (keep only last 5 files)\n        existing_files = os.listdir(downloads_dir)\n        if len(existing_files) > 5:\n            for f in existing_files:\n                os.remove(os.path.join(downloads_dir, f))\n        \n        clean = clean_youtube_url(link)\n        yt = YouTube(clean)\n        \n        audio_stream = yt.streams.filter(only_audio=True).first()\n        filename = f\"audio_{datetime.now().strftime('%Y%m%d_%H%M%S')}.mp3\"\n        out_file = audio_stream.download(output_path=downloads_dir, filename=filename)\n        \n        # If ffmpeg is available, convert to proper MP3\n        # Otherwise, just rename the file\n        try:\n            import subprocess\n            final_file = out_file.replace('.mp3', '_final.mp3')\n            subprocess.run(['ffmpeg', '-y', '-i', out_file, '-c:a', 'libmp3lame', final_file], \n                         check=True, capture_output=True)\n            os.remove(out_file)\n            out_file = final_file\n            filename = os.path.basename(final_file)\n        except:\n            # ffmpeg not available, use original file\n            pass\n        \n        return send_from_directory(downloads_dir, filename, as_attachment=True)\n    \n    except Exception as e:\n        logging.error(f\"Error downloading audio: {e}\")\n        flash(f'Error downloading audio: {str(e)}', 'error')\n        return redirect(url_for('video_downloader_home'))\n\n# QUIZ SYSTEM ROUTES - API ENDPOINT FOR AI MCQ GENERATION\n@app.route('/api/generate-mcq-options', methods=['POST'])\n@login_required\ndef generate_mcq_options():\n    \"\"\"Generate MCQ options and correct answer using AI Gemini\"\"\"\n    try:\n        data = request.get_json()\n        question = data.get('question', '').strip()\n        context = data.get('context', '').strip()\n        \n        if not question or len(question) < 5:\n            return jsonify({'success': False, 'error': 'Question too short'}), 400\n        \n        # Generate MCQ options using Gemini AI\n        result = gemini_ai.generate_mcq_options(question, context)\n        \n        if result and 'options' in result:\n            return jsonify({\n                'success': True,\n                'options': {\n                    'option_a': result['options'].get('A', ''),\n                    'option_b': result['options'].get('B', ''),\n                    'option_c': result['options'].get('C', ''),\n                    'option_d': result['options'].get('D', ''),\n                    'correct_answer': result.get('correct_answer', 'A'),\n                    'explanation': result.get('explanation', '')\n                }\n            })\n        else:\n            return jsonify({'success': False, 'error': 'Failed to generate options'}), 500\n            \n    except Exception as e:\n        logging.error(f\"Error generating MCQ options: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/generate-ai', methods=['POST'])\n@instructor_required\ndef instructor_generate_ai_quiz(course_id):\n    \"\"\"Generate MCQ quiz questions using AI from a topic and save directly to database\"\"\"\n    try:\n        data = request.get_json()\n        title = data.get('title', '').strip()\n        topic = data.get('topic', '').strip()\n        num_questions = int(data.get('num_questions', 5))\n        difficulty = data.get('difficulty', 'medium')\n        \n        if not title or len(title) < 3:\n            return jsonify({'success': False, 'message': 'Please enter a quiz title.'}), 400\n        \n        if not topic or len(topic) < 3:\n            return jsonify({'success': False, 'message': 'Please enter a topic.'}), 400\n        \n        # Support up to 100 questions per quiz\n        if num_questions < 1 or num_questions > 100:\n            num_questions = min(max(num_questions, 1), 100)\n        \n        # Generate questions using Gemini AI\n        try:\n            questions = gemini_ai.generate_mcq_quiz(topic, num_questions, difficulty)\n        except ValueError as ve:\n            logging.error(f\"Gemini API configuration error: {ve}\")\n            return jsonify({'success': False, 'message': f'Configuration Error: {str(ve)}'}), 500\n        except Exception as e:\n            logging.error(f\"Error generating quiz: {e}\")\n            return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500\n        \n        if not questions or len(questions) == 0:\n            return jsonify({'success': False, 'message': 'No questions were generated. Please try a different topic or try again.'}), 500\n        \n        # Create quiz directly in database\n        with db_lock:\n            conn = get_db_connection()\n            \n            # Verify course belongs to instructor\n            course = conn.execute('SELECT * FROM courses WHERE id = ? AND instructor_id = ?', \n                                (course_id, current_user.id)).fetchone()\n            \n            if not course:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Course not found or access denied.'}), 403\n            \n            try:\n                # Create the quiz/assignment\n                total_points = len(questions)  # 1 point per question by default\n                cursor = conn.execute('''\n                    INSERT INTO assignments (course_id, title, description, instructions, max_points)\n                    VALUES (?, ?, ?, ?, ?)\n                ''', (\n                    course_id, \n                    title,\n                    f\"AI-generated quiz on {topic} ({difficulty} difficulty)\",\n                    \"Answer all multiple choice questions. Each question is worth 1 point.\",\n                    total_points\n                ))\n                \n                assignment_id = cursor.lastrowid\n                \n                # Save all generated questions\n                for q in questions:\n                    # Insert question\n                    cursor = conn.execute('''\n                        INSERT INTO quiz_questions (assignment_id, question_text, question_type, points, correct_answer, explanation)\n                        VALUES (?, ?, 'mcq', ?, ?, ?)\n                    ''', (assignment_id, q['question'], 1, q['correct_answer'], q.get('explanation', '')))\n                    \n                    question_id = cursor.lastrowid\n                    \n                    # Insert options\n                    for option_letter, option_text in q['options'].items():\n                        is_correct = (option_letter == q['correct_answer'])\n                        conn.execute('''\n                            INSERT INTO question_options (question_id, option_letter, option_text, is_correct)\n                            VALUES (?, ?, ?, ?)\n                        ''', (question_id, option_letter, option_text, is_correct))\n                \n                conn.commit()\n                \n                logging.info(f\"AI Quiz '{topic}' created with {len(questions)} questions (ID: {assignment_id})\")\n                \n                conn.close()\n                \n                return jsonify({\n                    'success': True,\n                    'message': f'Quiz created with {len(questions)} questions! You can now edit and submit to students.',\n                    'quiz_id': assignment_id,\n                    'redirect_url': url_for('instructor_edit_quiz', course_id=course_id, quiz_id=assignment_id)\n                })\n                \n            except Exception as e:\n                conn.rollback()\n                conn.close()\n                logging.error(f\"Error saving AI quiz: {e}\")\n                return jsonify({'success': False, 'message': f'Error saving quiz: {str(e)}'}), 500\n        \n    except ValueError as ve:\n        logging.error(f\"Gemini API Key Error: {ve}\")\n        return jsonify({'success': False, 'message': 'Gemini API not configured. Please set GEMINI_API_KEY.'}), 500\n    except Exception as e:\n        logging.error(f\"Error generating AI quiz: {e}\")\n        return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500\n\n@app.route('/instructor/courses/<int:course_id>/quizzes')\n@instructor_required\ndef instructor_course_quizzes(course_id):\n    \"\"\"Manage course quizzes\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get quizzes (using assignments table)\n        quizzes = conn.execute('''\n            SELECT a.*, COUNT(s.id) as submission_count\n            FROM assignments a\n            LEFT JOIN assignment_submissions s ON a.id = s.assignment_id\n            WHERE a.course_id = ?\n            GROUP BY a.id\n            ORDER BY a.created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/course_quizzes.html', course=course, quizzes=quizzes)\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/create', methods=['GET', 'POST'])\n@instructor_required\ndef instructor_create_quiz(course_id):\n    \"\"\"Create a new quiz\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        if request.method == 'POST':\n            # Validate CSRF token\n            csrf_token = request.form.get('csrf_token')\n            if not validate_csrf_token(csrf_token):\n                flash('Invalid security token. Please try again.', 'error')\n                conn.close()\n                return redirect(url_for('instructor_create_quiz', course_id=course_id))\n            \n            title = request.form.get('title', '').strip()\n            description = request.form.get('description', '').strip()\n            instructions = request.form.get('instructions', '').strip()\n            due_date = request.form.get('due_date') or None\n            max_points = int(request.form.get('max_points', 100))\n            \n            try:\n                # Create the quiz/assignment\n                cursor = conn.execute('''\n                    INSERT INTO assignments (course_id, title, description, instructions, due_date, max_points)\n                    VALUES (?, ?, ?, ?, ?, ?)\n                ''', (course_id, title, description, instructions, due_date, max_points))\n                \n                assignment_id = cursor.lastrowid\n                total_points = 0\n                \n                # Process MCQ questions\n                questions_data = {}\n                for key in request.form.keys():\n                    if key.startswith('questions[') and '][text]' in key:\n                        # Extract question number\n                        question_num = key.split('[')[1].split(']')[0]\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        questions_data[question_num]['text'] = request.form.get(key, '').strip()\n                    elif key.startswith('questions[') and '][correct]' in key:\n                        question_num = key.split('[')[1].split(']')[0]\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        questions_data[question_num]['correct'] = request.form.get(key)\n                    elif key.startswith('questions[') and '][explanation]' in key:\n                        question_num = key.split('[')[1].split(']')[0]\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        questions_data[question_num]['explanation'] = request.form.get(key, '').strip()\n                    elif key.startswith('questions[') and '][points]' in key:\n                        question_num = key.split('[')[1].split(']')[0]\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        questions_data[question_num]['points'] = int(request.form.get(key, 1))\n                    elif key.startswith('questions[') and '][option_' in key:\n                        question_num = key.split('[')[1].split(']')[0]\n                        option_letter = key.split('option_')[1].split(']')[0].upper()\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        if 'options' not in questions_data[question_num]:\n                            questions_data[question_num]['options'] = {}\n                        questions_data[question_num]['options'][option_letter] = request.form.get(key, '').strip()\n                \n                # Save questions and options\n                questions_saved = 0\n                for question_num, question_data in questions_data.items():\n                    if 'text' in question_data and question_data['text']:\n                        # Use instructor-selected correct answer\n                        correct_answer = question_data.get('correct', 'A')\n                        \n                        # Insert question with instructor-selected or AI-generated correct answer\n                        cursor = conn.execute('''\n                            INSERT INTO quiz_questions (assignment_id, question_text, question_type, points, correct_answer, explanation)\n                            VALUES (?, ?, 'mcq', ?, ?, ?)\n                        ''', (assignment_id, question_data['text'], question_data.get('points', 1), \n                             correct_answer, question_data.get('explanation', '')))\n                        \n                        question_id = cursor.lastrowid\n                        total_points += question_data.get('points', 1)\n                        questions_saved += 1\n                        \n                        # Insert options with instructor-selected correct answer\n                        for option_letter, option_text in question_data.get('options', {}).items():\n                            if option_text:\n                                is_correct = (option_letter == correct_answer)\n                                conn.execute('''\n                                    INSERT INTO question_options (question_id, option_letter, option_text, is_correct)\n                                    VALUES (?, ?, ?, ?)\n                                ''', (question_id, option_letter, option_text, is_correct))\n                \n                # Update assignment with calculated total points\n                conn.execute('''\n                    UPDATE assignments SET max_points = ? WHERE id = ?\n                ''', (total_points, assignment_id))\n                \n                conn.commit()\n                \n                if questions_saved > 0:\n                    flash(f'âœ… MCQ Quiz \"{title}\" created successfully with {questions_saved} questions and submitted to all enrolled students!', 'success')\n                    logging.info(f\"Quiz '{title}' created with {questions_saved} questions for course {course_id}\")\n                else:\n                    flash('âš ï¸ Quiz created but no questions were saved. Please add questions and try again.', 'warning')\n                \n                return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n                \n            except Exception as e:\n                conn.rollback()\n                flash('Error creating quiz. Please try again.', 'error')\n        \n        conn.close()\n    \n    return render_template('instructor/create_quiz.html', course=course)\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/<int:quiz_id>/results')\n@instructor_required\ndef instructor_quiz_results(course_id, quiz_id):\n    \"\"\"View quiz results and submissions\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course ownership and quiz\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            WHERE a.id = ? AND a.course_id = ? AND c.instructor_id = ?\n        ''', (quiz_id, course_id, current_user.id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n        \n        # Get all submissions for this quiz\n        submissions = conn.execute('''\n            SELECT s.*, u.full_name as student_name, u.username\n            FROM assignment_submissions s\n            JOIN users u ON s.student_id = u.id\n            WHERE s.assignment_id = ?\n            ORDER BY s.submitted_at DESC\n        ''', (quiz_id,)).fetchall()\n        \n        # Get basic stats\n        stats = {\n            'total_submissions': len(submissions),\n            'graded_count': len([s for s in submissions if s['grade'] is not None]),\n            'average_grade': sum(s['grade'] for s in submissions if s['grade'] is not None) / max(1, len([s for s in submissions if s['grade'] is not None])) if submissions else 0\n        }\n        \n        conn.close()\n    \n    return render_template('instructor/quiz_results.html', quiz=quiz, submissions=submissions, stats=stats)\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/<int:quiz_id>/edit', methods=['GET', 'POST'])\n@instructor_required\ndef instructor_edit_quiz(course_id, quiz_id):\n    \"\"\"Edit existing quiz\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course ownership and quiz\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            WHERE a.id = ? AND a.course_id = ? AND c.instructor_id = ?\n        ''', (quiz_id, course_id, current_user.id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n        \n        if request.method == 'POST':\n            title = request.form.get('title', '').strip()\n            description = request.form.get('description', '').strip()\n            instructions = request.form.get('instructions', '').strip()\n            due_date = request.form.get('due_date') or None\n            max_points = int(request.form.get('max_points', 100))\n            \n            try:\n                conn.execute('''\n                    UPDATE assignments \n                    SET title = ?, description = ?, instructions = ?, due_date = ?, max_points = ?\n                    WHERE id = ?\n                ''', (title, description, instructions, due_date, max_points, quiz_id))\n                \n                # Update MCQ questions if provided\n                questions = conn.execute('SELECT id FROM quiz_questions WHERE assignment_id = ?', (quiz_id,)).fetchall()\n                for idx, q in enumerate(questions):\n                    q_id = q['id']\n                    q_text = request.form.get(f'question_{idx}_text', '').strip()\n                    explanation = request.form.get(f'question_{idx}_explanation', '').strip()\n                    correct = request.form.get(f'question_{idx}_correct', 'A')\n                    \n                    if q_text:\n                        conn.execute('''\n                            UPDATE quiz_questions \n                            SET question_text = ?, explanation = ?, correct_answer = ?\n                            WHERE id = ?\n                        ''', (q_text, explanation, correct, q_id))\n                        \n                        # Update options\n                        for letter in ['A', 'B', 'C', 'D']:\n                            option_text = request.form.get(f'question_{idx}_option_{letter}', '').strip()\n                            if option_text:\n                                conn.execute('''\n                                    UPDATE question_options \n                                    SET option_text = ?, is_correct = ?\n                                    WHERE question_id = ? AND option_letter = ?\n                                ''', (option_text, (letter == correct), q_id, letter))\n                \n                conn.commit()\n                flash(f'Quiz \"{title}\" updated successfully!', 'success')\n                return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n                \n            except Exception as e:\n                conn.rollback()\n                flash('Error updating quiz. Please try again.', 'error')\n        \n        # Fetch questions for editing\n        questions = conn.execute('''\n            SELECT q.id, q.question_text, q.correct_answer, q.explanation,\n                   q.points FROM quiz_questions q\n            WHERE q.assignment_id = ?\n            ORDER BY q.id\n        ''', (quiz_id,)).fetchall()\n        \n        # Fetch options for each question\n        questions_list = []\n        for q in questions:\n            options = conn.execute('''\n                SELECT option_letter, option_text FROM question_options\n                WHERE question_id = ? ORDER BY option_letter\n            ''', (q['id'],)).fetchall()\n            questions_list.append({\n                'id': q['id'],\n                'text': q['question_text'],\n                'correct': q['correct_answer'],\n                'explanation': q['explanation'],\n                'points': q['points'],\n                'options': {opt['option_letter']: opt['option_text'] for opt in options}\n            })\n        \n        conn.close()\n    \n    return render_template('instructor/edit_quiz.html', quiz=quiz, questions=questions_list)\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/<int:quiz_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_quiz(course_id, quiz_id):\n    \"\"\"Delete a quiz and all associated data\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course ownership and quiz\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            WHERE a.id = ? AND a.course_id = ? AND c.instructor_id = ?\n        ''', (quiz_id, course_id, current_user.id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n        \n        try:\n            # Delete quiz questions first\n            conn.execute('DELETE FROM quiz_questions WHERE assignment_id = ?', (quiz_id,))\n            \n            # Delete student MCQ answers\n            conn.execute('''\n                DELETE FROM student_mcq_answers \n                WHERE submission_id IN (\n                    SELECT id FROM assignment_submissions WHERE assignment_id = ?\n                )\n            ''', (quiz_id,))\n            \n            # Delete submissions\n            conn.execute('DELETE FROM assignment_submissions WHERE assignment_id = ?', (quiz_id,))\n            \n            # Delete the quiz itself\n            conn.execute('DELETE FROM assignments WHERE id = ?', (quiz_id,))\n            \n            conn.commit()\n            flash(f'Quiz \"{quiz[\"title\"]}\" and all associated data deleted successfully.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error deleting quiz. Please try again.', 'error')\n            print(f\"Delete quiz error: {e}\")\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/<int:quiz_id>/analytics')\n@instructor_required\ndef instructor_quiz_analytics(course_id, quiz_id):\n    \"\"\"Basic quiz analytics\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course ownership and quiz\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            WHERE a.id = ? AND a.course_id = ? AND c.instructor_id = ?\n        ''', (quiz_id, course_id, current_user.id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n        \n        # Get enrollment count for completion rate\n        enrolled_students = conn.execute('''\n            SELECT COUNT(*) as count FROM enrollments \n            WHERE course_id = ? AND status = 'approved'\n        ''', (course_id,)).fetchone()['count']\n        \n        # Get submission analytics\n        submissions = conn.execute('''\n            SELECT grade FROM assignment_submissions \n            WHERE assignment_id = ? AND grade IS NOT NULL\n        ''', (quiz_id,)).fetchall()\n        \n        grades = [s['grade'] for s in submissions]\n        analytics = {\n            'enrolled_students': enrolled_students,\n            'submission_count': len(submissions),\n            'completion_rate': (len(submissions) / max(1, enrolled_students)) * 100,\n            'average_grade': sum(grades) / max(1, len(grades)) if grades else 0,\n            'highest_grade': max(grades) if grades else 0,\n            'lowest_grade': min(grades) if grades else 0,\n            'grade_distribution': {\n                'A (90-100)': len([g for g in grades if g >= 90]),\n                'B (80-89)': len([g for g in grades if 80 <= g < 90]),\n                'C (70-79)': len([g for g in grades if 70 <= g < 80]),\n                'D (60-69)': len([g for g in grades if 60 <= g < 70]),\n                'F (0-59)': len([g for g in grades if g < 60])\n            }\n        }\n        \n        conn.close()\n    \n    return render_template('instructor/quiz_analytics.html', quiz=quiz, analytics=analytics)\n\n# DISCUSSION FORUMS ROUTES\n@app.route('/instructor/courses/<int:course_id>/discussions')\n@instructor_required\ndef instructor_course_discussions(course_id):\n    \"\"\"Manage course discussion forums\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get course forums and recent topics\n        forums = conn.execute('''\n            SELECT f.*, COUNT(t.id) as topic_count\n            FROM forums f\n            LEFT JOIN forum_topics t ON f.id = t.forum_id\n            WHERE f.course_id = ? AND f.is_active = 1\n            GROUP BY f.id\n            ORDER BY f.created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get recent forum activity\n        recent_topics = conn.execute('''\n            SELECT t.*, u.full_name as author_name, f.title as forum_title,\n                   COUNT(r.id) as reply_count\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            JOIN forums f ON t.forum_id = f.id\n            LEFT JOIN forum_replies r ON t.id = r.topic_id\n            WHERE f.course_id = ?\n            GROUP BY t.id\n            ORDER BY t.created_at DESC\n            LIMIT 10\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/course_discussions.html', \n                         course=course, forums=forums, recent_topics=recent_topics)\n\n@app.route('/instructor/courses/<int:course_id>/forums/create', methods=['POST'])\n@instructor_required\ndef instructor_create_forum(course_id):\n    \"\"\"Create a new discussion forum\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        description = request.form.get('description', '').strip()\n        \n        if not title:\n            flash('Forum title is required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forums (course_id, title, description)\n                VALUES (?, ?, ?)\n            ''', (course_id, title, description))\n            \n            conn.commit()\n            flash(f'Discussion forum \"{title}\" created successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error creating forum. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_discussions', course_id=course_id))\n\n@app.route('/instructor/courses/<int:course_id>/topics/create', methods=['POST'])\n@instructor_required\ndef instructor_create_topic(course_id):\n    \"\"\"Create a new discussion topic\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        forum_id = request.form.get('forum_id')\n        title = request.form.get('title', '').strip()\n        content = request.form.get('content', '').strip()\n        is_pinned = bool(request.form.get('is_pinned'))\n        \n        if not title or not content or not forum_id:\n            flash('Topic title, content, and forum selection are required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forum_topics (forum_id, user_id, title, content, is_pinned)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (forum_id, current_user.id, title, content, is_pinned))\n            \n            conn.commit()\n            flash(f'Discussion topic \"{title}\" created successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error creating topic. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_discussions', course_id=course_id))\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/topics')\n@instructor_required\ndef instructor_forum_topics(course_id, forum_id):\n    \"\"\"View all topics in a forum\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor or admin\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND (instructor_id = ? OR ? = 1) AND is_active = 1\n        ''', (course_id, current_user.id, current_user.is_admin())).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        # Get all topics in this forum\n        topics = conn.execute('''\n            SELECT t.*, u.full_name as author_name, COUNT(r.id) as reply_count,\n                   MAX(COALESCE(r.created_at, t.created_at)) as last_activity\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            LEFT JOIN forum_replies r ON t.id = r.topic_id\n            WHERE t.forum_id = ?\n            GROUP BY t.id\n            ORDER BY t.is_pinned DESC, last_activity DESC\n        ''', (forum_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/forum_topics.html', \n                         course=course, forum=forum, topics=topics)\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/topics/<int:topic_id>')\n@instructor_required\ndef instructor_topic_detail(course_id, forum_id, topic_id):\n    \"\"\"View topic details with replies\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor or admin\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND (instructor_id = ? OR ? = 1) AND is_active = 1\n        ''', (course_id, current_user.id, current_user.is_admin())).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        # Get topic details\n        topic = conn.execute('''\n            SELECT t.*, u.full_name as author_name, u.role as author_role\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            WHERE t.id = ? AND t.forum_id = ?\n        ''', (topic_id, forum_id)).fetchone()\n        \n        if not topic:\n            flash('Topic not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_forum_topics', course_id=course_id, forum_id=forum_id))\n        \n        # Get replies\n        replies = conn.execute('''\n            SELECT r.*, u.full_name as author_name, u.role as author_role\n            FROM forum_replies r\n            JOIN users u ON r.user_id = u.id\n            WHERE r.topic_id = ?\n            ORDER BY r.created_at ASC\n        ''', (topic_id,)).fetchall()\n        \n        # Update view count\n        conn.execute('UPDATE forum_topics SET view_count = view_count + 1 WHERE id = ?', (topic_id,))\n        conn.commit()\n        \n        conn.close()\n    \n    return render_template('instructor/topic_detail.html', \n                         course=course, forum=forum, topic=topic, replies=replies)\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/edit')\n@instructor_required\ndef instructor_edit_forum(course_id, forum_id):\n    \"\"\"Edit forum form\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get forum details\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        conn.close()\n    \n    return render_template('instructor/edit_forum.html', course=course, forum=forum)\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/update', methods=['POST'])\n@instructor_required\ndef instructor_update_forum(course_id, forum_id):\n    \"\"\"Update forum details\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        description = request.form.get('description', '').strip()\n        \n        if not title:\n            flash('Forum title is required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_edit_forum', course_id=course_id, forum_id=forum_id))\n        \n        try:\n            conn.execute('''\n                UPDATE forums \n                SET title = ?, description = ?\n                WHERE id = ? AND course_id = ?\n            ''', (title, description, forum_id, course_id))\n            \n            conn.commit()\n            flash(f'Forum \"{title}\" updated successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error updating forum. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_discussions', course_id=course_id))\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_forum(course_id, forum_id):\n    \"\"\"Delete forum (soft delete)\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        try:\n            # Soft delete forum\n            conn.execute('''\n                UPDATE forums \n                SET is_active = 0\n                WHERE id = ? AND course_id = ?\n            ''', (forum_id, course_id))\n            \n            conn.commit()\n            flash('Forum deleted successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error deleting forum. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_discussions', course_id=course_id))\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/topics/<int:topic_id>/reply', methods=['POST'])\n@instructor_required\ndef instructor_create_reply(course_id, forum_id, topic_id):\n    \"\"\"Create a reply to a discussion topic\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor or admin\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND (instructor_id = ? OR ? = 1) AND is_active = 1\n        ''', (course_id, current_user.id, current_user.is_admin())).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Verify forum and topic exist\n        topic = conn.execute('''\n            SELECT t.*, f.course_id\n            FROM forum_topics t\n            JOIN forums f ON t.forum_id = f.id\n            WHERE t.id = ? AND t.forum_id = ? AND f.course_id = ? AND f.is_active = 1\n        ''', (topic_id, forum_id, course_id)).fetchone()\n        \n        if not topic:\n            flash('Topic not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        content = request.form.get('content', '').strip()\n        \n        if not content:\n            flash('Reply content is required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_topic_detail', course_id=course_id, forum_id=forum_id, topic_id=topic_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forum_replies (topic_id, user_id, content)\n                VALUES (?, ?, ?)\n            ''', (topic_id, current_user.id, content))\n            \n            conn.commit()\n            flash('Reply posted successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error posting reply. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_topic_detail', course_id=course_id, forum_id=forum_id, topic_id=topic_id))\n\n\n# STUDENT CONTENT ACCESS ROUTES\n@app.route('/student/courses/<int:course_id>')\n@login_required\ndef student_course_view(course_id):\n    \"\"\"View course content as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.*, u.full_name as instructor_name,\n                   COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get course content\n        resources = conn.execute('''\n            SELECT * FROM course_resources \n            WHERE course_id = ?\n            ORDER BY upload_date DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get meeting links\n        meeting_links = conn.execute('''\n            SELECT * FROM course_meeting_links \n            WHERE course_id = ? AND is_active = 1\n            ORDER BY created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get video playlist\n        video_playlist = conn.execute('''\n            SELECT * FROM course_video_playlists \n            WHERE course_id = ? AND is_active = 1\n            ORDER BY order_index ASC\n        ''', (course_id,)).fetchall()\n        \n        # Get quizzes\n        quizzes = conn.execute('''\n            SELECT a.*, s.grade, s.submitted_at\n            FROM assignments a\n            LEFT JOIN assignment_submissions s ON a.id = s.assignment_id AND s.student_id = ?\n            WHERE a.course_id = ?\n            ORDER BY a.created_at DESC\n        ''', (current_user.id, course_id)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/course_view.html', \n                         enrollment=enrollment, course=enrollment, resources=resources, quizzes=quizzes,\n                         meeting_links=meeting_links, video_playlist=video_playlist)\n\n# STUDENT FORUM ACCESS ROUTES\n@app.route('/student/courses/<int:course_id>/forums')\n@login_required\ndef student_course_forums(course_id):\n    \"\"\"View course forums as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.*, u.full_name as instructor_name,\n                   COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get course forums and recent topics\n        forums = conn.execute('''\n            SELECT f.*, COUNT(t.id) as topic_count\n            FROM forums f\n            LEFT JOIN forum_topics t ON f.id = t.forum_id\n            WHERE f.course_id = ? AND f.is_active = 1\n            GROUP BY f.id\n            ORDER BY f.created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get recent forum activity\n        recent_topics = conn.execute('''\n            SELECT t.*, u.full_name as author_name, f.title as forum_title,\n                   COUNT(r.id) as reply_count\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            JOIN forums f ON t.forum_id = f.id\n            LEFT JOIN forum_replies r ON t.id = r.topic_id\n            WHERE f.course_id = ?\n            GROUP BY t.id\n            ORDER BY t.created_at DESC\n            LIMIT 10\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/course_forums.html', \n                         course=enrollment, forums=forums, recent_topics=recent_topics)\n\n@app.route('/student/courses/<int:course_id>/forums/<int:forum_id>/topics')\n@login_required\ndef student_forum_topics(course_id, forum_id):\n    \"\"\"View all topics in a forum as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.*, u.full_name as instructor_name,\n                   COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        \n        # Get all topics in this forum\n        topics = conn.execute('''\n            SELECT t.*, u.full_name as author_name, COUNT(r.id) as reply_count,\n                   MAX(COALESCE(r.created_at, t.created_at)) as last_activity\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            LEFT JOIN forum_replies r ON t.id = r.topic_id\n            WHERE t.forum_id = ?\n            GROUP BY t.id\n            ORDER BY t.is_pinned DESC, last_activity DESC\n        ''', (forum_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/forum_topics.html', \n                         course=enrollment, forum=forum, topics=topics)\n\n@app.route('/student/courses/<int:course_id>/forums/<int:forum_id>/topics/<int:topic_id>')\n@login_required\ndef student_topic_detail(course_id, forum_id, topic_id):\n    \"\"\"View topic details with replies as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.*, u.full_name as instructor_name,\n                   COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        \n        # Get topic details\n        topic = conn.execute('''\n            SELECT t.*, u.full_name as author_name, u.role as author_role\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            WHERE t.id = ? AND t.forum_id = ?\n        ''', (topic_id, forum_id)).fetchone()\n        \n        if not topic:\n            flash('Topic not found.', 'error')\n            conn.close()\n            return redirect(url_for('student_forum_topics', course_id=course_id, forum_id=forum_id))\n        \n        # Get replies\n        replies = conn.execute('''\n            SELECT r.*, u.full_name as author_name, u.role as author_role\n            FROM forum_replies r\n            JOIN users u ON r.user_id = u.id\n            WHERE r.topic_id = ?\n            ORDER BY r.created_at ASC\n        ''', (topic_id,)).fetchall()\n        \n        # Update view count\n        conn.execute('UPDATE forum_topics SET view_count = view_count + 1 WHERE id = ?', (topic_id,))\n        conn.commit()\n        \n        conn.close()\n    \n    return render_template('student/topic_detail.html', \n                         course=enrollment, forum=forum, topic=topic, replies=replies)\n\n@app.route('/student/courses/<int:course_id>/forums/<int:forum_id>/topics/<int:topic_id>/reply', methods=['POST'])\n@login_required\ndef student_create_reply(course_id, forum_id, topic_id):\n    \"\"\"Create a reply to a discussion topic as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.status FROM enrollments e\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Verify forum and topic exist\n        topic = conn.execute('''\n            SELECT t.*, f.course_id\n            FROM forum_topics t\n            JOIN forums f ON t.forum_id = f.id\n            WHERE t.id = ? AND t.forum_id = ? AND f.course_id = ? AND f.is_active = 1\n        ''', (topic_id, forum_id, course_id)).fetchone()\n        \n        if not topic:\n            flash('Topic not found.', 'error')\n            conn.close()\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        \n        content = request.form.get('content', '').strip()\n        \n        if not content:\n            flash('Reply content is required.', 'error')\n            conn.close()\n            return redirect(url_for('student_topic_detail', course_id=course_id, forum_id=forum_id, topic_id=topic_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forum_replies (topic_id, user_id, content)\n                VALUES (?, ?, ?)\n            ''', (topic_id, current_user.id, content))\n            \n            conn.commit()\n            flash('Reply posted successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error posting reply. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('student_topic_detail', course_id=course_id, forum_id=forum_id, topic_id=topic_id))\n\n@app.route('/student/courses/<int:course_id>/forums/<int:forum_id>/topics/create', methods=['POST'])\n@login_required\ndef student_create_topic(course_id, forum_id):\n    \"\"\"Create a new discussion topic as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.status FROM enrollments e\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        \n        title = request.form.get('title', '').strip()\n        content = request.form.get('content', '').strip()\n        \n        if not title or not content:\n            flash('Topic title and content are required.', 'error')\n            conn.close()\n            return redirect(url_for('student_forum_topics', course_id=course_id, forum_id=forum_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forum_topics (forum_id, user_id, title, content, is_pinned)\n                VALUES (?, ?, ?, ?, 0)\n            ''', (forum_id, current_user.id, title, content))\n            \n            conn.commit()\n            flash(f'Discussion topic \"{title}\" created successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error creating topic. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('student_forum_topics', course_id=course_id, forum_id=forum_id))\n\n@app.route('/uploads/instructor_screenshots/<filename>')\n@login_required\n@admin_required\ndef instructor_screenshot(filename):\n    \"\"\"Serve instructor screenshot files (admin only)\"\"\"\n    screenshots_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'instructor_screenshots')\n    return send_from_directory(screenshots_dir, filename)\n\n@app.route('/student/courses/<int:course_id>/resource/<int:resource_id>')\n@login_required\ndef student_download_resource(course_id, resource_id):\n    \"\"\"Secure file download for enrolled students\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved in the course\n        enrollment = conn.execute('''\n            SELECT e.status FROM enrollments e\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Access denied. You are not enrolled in this course.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get the resource and verify it belongs to this course\n        resource = conn.execute('''\n            SELECT * FROM course_resources \n            WHERE id = ? AND course_id = ?\n        ''', (resource_id, course_id)).fetchone()\n        \n        conn.close()\n        \n        if not resource:\n            flash('Resource not found.', 'error')\n            return redirect(url_for('student_course_view', course_id=course_id))\n        \n        # Serve the file securely\n        try:\n            return send_from_directory(\n                os.path.dirname(resource['file_path']),\n                os.path.basename(resource['file_path']),\n                as_attachment=False\n            )\n        except FileNotFoundError:\n            flash('File not found on server.', 'error')\n            return redirect(url_for('student_course_view', course_id=course_id))\n\n@app.route('/student/quiz/<int:quiz_id>')\n@login_required\ndef student_take_quiz(quiz_id):\n    \"\"\"Take a quiz with MCQ questions\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled in the course\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title, e.status as enrollment_status\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            LEFT JOIN enrollments e ON c.id = e.course_id AND e.student_id = ?\n            WHERE a.id = ? AND e.status = 'approved'\n        ''', (current_user.id, quiz_id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Check if already submitted\n        submission = conn.execute('''\n            SELECT * FROM assignment_submissions \n            WHERE assignment_id = ? AND student_id = ?\n        ''', (quiz_id, current_user.id)).fetchone()\n        \n        # Get MCQ questions and options\n        questions = conn.execute('''\n            SELECT q.*, GROUP_CONCAT(\n                o.option_letter || '|' || o.option_text || '|' || o.is_correct, ':'\n            ) as options_data\n            FROM quiz_questions q\n            LEFT JOIN question_options o ON q.id = o.question_id\n            WHERE q.assignment_id = ?\n            GROUP BY q.id\n            ORDER BY q.id\n        ''', (quiz_id,)).fetchall()\n        \n        # Process questions and options\n        processed_questions = []\n        for question in questions:\n            question_dict = dict(question)\n            question_dict['options'] = {}\n            \n            if question['options_data']:\n                for option_data in question['options_data'].split(':'):\n                    if option_data:\n                        parts = option_data.split('|')\n                        if len(parts) >= 3:\n                            letter = parts[0]\n                            text = parts[1]\n                            is_correct = parts[2] == '1'\n                            question_dict['options'][letter] = {\n                                'text': text,\n                                'is_correct': is_correct\n                            }\n            \n            processed_questions.append(question_dict)\n        \n        # Get student's previous answers if any\n        student_answers = {}\n        if submission:\n            answers = conn.execute('''\n                SELECT question_id, selected_option \n                FROM student_mcq_answers \n                WHERE submission_id = ?\n            ''', (submission['id'],)).fetchall()\n            \n            for answer in answers:\n                student_answers[answer['question_id']] = answer['selected_option']\n        \n        conn.close()\n    \n    return render_template('student/take_quiz.html', \n                         quiz=quiz, \n                         submission=submission, \n                         questions=processed_questions,\n                         student_answers=student_answers)\n\n@app.route('/student/quiz/<int:quiz_id>/submit', methods=['POST'])\n@login_required\ndef student_submit_quiz(quiz_id):\n    \"\"\"Submit MCQ quiz answers\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify access\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title, e.status as enrollment_status\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            LEFT JOIN enrollments e ON c.id = e.course_id AND e.student_id = ?\n            WHERE a.id = ? AND e.status = 'approved'\n        ''', (current_user.id, quiz_id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get quiz questions for grading\n        questions = conn.execute('''\n            SELECT q.id, q.points, q.correct_answer\n            FROM quiz_questions q\n            WHERE q.assignment_id = ?\n            ORDER BY q.id\n        ''', (quiz_id,)).fetchall()\n        \n        try:\n            # Check if already submitted\n            existing = conn.execute('''\n                SELECT id FROM assignment_submissions \n                WHERE assignment_id = ? AND student_id = ?\n            ''', (quiz_id, current_user.id)).fetchone()\n            \n            # Calculate score from MCQ answers\n            total_score = 0\n            total_possible = 0\n            mcq_answers = []\n            \n            for question in questions:\n                question_key = f'question_{question[\"id\"]}'\n                selected_answer = request.form.get(question_key, '').strip()\n                \n                if selected_answer:\n                    is_correct = (selected_answer == question['correct_answer'])\n                    points_earned = question['points'] if is_correct else 0\n                    total_score += points_earned\n                    \n                    mcq_answers.append({\n                        'question_id': question['id'],\n                        'selected_option': selected_answer,\n                        'is_correct': is_correct,\n                        'points_earned': points_earned\n                    })\n                \n                total_possible += question['points']\n            \n            # Create submission text summary\n            submission_text = f\"MCQ Quiz Submission - {len(mcq_answers)} questions answered\"\n            \n            if existing:\n                # Update existing submission\n                conn.execute('''\n                    UPDATE assignment_submissions \n                    SET submission_text = ?, submitted_at = CURRENT_TIMESTAMP, grade = ?\n                    WHERE assignment_id = ? AND student_id = ?\n                ''', (submission_text, total_score, quiz_id, current_user.id))\n                \n                submission_id = existing['id']\n                \n                # Delete old MCQ answers\n                conn.execute('DELETE FROM student_mcq_answers WHERE submission_id = ?', (submission_id,))\n            else:\n                # Create new submission\n                cursor = conn.execute('''\n                    INSERT INTO assignment_submissions (assignment_id, student_id, submission_text, grade)\n                    VALUES (?, ?, ?, ?)\n                ''', (quiz_id, current_user.id, submission_text, total_score))\n                \n                submission_id = cursor.lastrowid\n            \n            # Save MCQ answers\n            for answer in mcq_answers:\n                conn.execute('''\n                    INSERT INTO student_mcq_answers \n                    (submission_id, question_id, selected_option, is_correct, points_earned)\n                    VALUES (?, ?, ?, ?, ?)\n                ''', (submission_id, answer['question_id'], answer['selected_option'], \n                     answer['is_correct'], answer['points_earned']))\n            \n            # Generate AI feedback\n            try:\n                ai_feedback = f\"Quiz completed! You scored {total_score}/{total_possible} ({(total_score / total_possible * 100) if total_possible > 0 else 0:.1f}%). You answered {sum(1 for ans in mcq_answers if ans['is_correct'])} out of {len(questions)} questions correctly.\"\n                \n                conn.execute('''\n                    UPDATE assignment_submissions \n                    SET ai_feedback = ?, graded_at = CURRENT_TIMESTAMP\n                    WHERE id = ?\n                ''', (ai_feedback, submission_id))\n                \n            except Exception as ai_error:\n                print(f\"AI feedback error: {ai_error}\")\n            \n            conn.commit()\n            \n            # Update student progress for this course\n            update_student_progress(conn, current_user.id, quiz['course_id'])\n            \n            percentage = (total_score / total_possible * 100) if total_possible > 0 else 0\n            flash(f'Quiz submitted successfully! Your score: {total_score}/{total_possible} ({percentage:.1f}%)', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error submitting quiz. Please try again.', 'error')\n            print(f\"Quiz submission error: {e}\")\n        \n        conn.close()\n    \n    return redirect(url_for('student_take_quiz', quiz_id=quiz_id))\n\n# RANKINGS ROUTES\n@app.route('/student/courses/<int:course_id>/rankings')\n@login_required\ndef student_course_rankings(course_id):\n    \"\"\"View course rankings based on quiz scores\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled\n        enrollment = conn.execute('''\n            SELECT * FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get rankings based on quiz scores\n        rankings = conn.execute('''\n            SELECT u.full_name, AVG(s.grade) as avg_score, COUNT(s.id) as quiz_count,\n                   RANK() OVER (ORDER BY AVG(s.grade) DESC) as rank\n            FROM users u\n            JOIN enrollments e ON u.id = e.student_id\n            JOIN assignment_submissions s ON u.id = s.student_id\n            JOIN assignments a ON s.assignment_id = a.id\n            WHERE e.course_id = ? AND e.status = 'approved' AND s.grade IS NOT NULL AND a.course_id = ?\n            GROUP BY u.id, u.full_name\n            HAVING quiz_count > 0\n            ORDER BY avg_score DESC\n        ''', (course_id, course_id)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/course_rankings.html', \n                         course=enrollment, rankings=rankings)\n\n# STUDENT ENROLLMENT ROUTES\n@app.route('/student/courses')\n@login_required\ndef student_browse_courses():\n    \"\"\"Browse available courses for enrollment\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get available courses (not already enrolled in)\n        available_courses = conn.execute('''\n            SELECT c.*, u.full_name as instructor_name,\n                   COUNT(e.id) as enrollment_count\n            FROM courses c\n            JOIN users u ON c.instructor_id = u.id\n            LEFT JOIN enrollments e ON c.id = e.course_id AND e.status = 'approved'\n            LEFT JOIN enrollments student_e ON c.id = student_e.course_id AND student_e.student_id = ?\n            WHERE c.is_active = 1 AND student_e.id IS NULL\n            GROUP BY c.id\n            ORDER BY c.created_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Get my enrollment requests\n        my_enrollments = conn.execute('''\n            SELECT e.*, c.title as course_title, c.course_code,\n                   u.full_name as instructor_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ?\n            ORDER BY e.enrolled_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/browse_courses.html', \n                         available_courses=available_courses,\n                         my_enrollments=my_enrollments)\n\n@app.route('/student/enroll', methods=['POST'])\n@login_required\ndef student_enroll():\n    \"\"\"Enroll in a course with enrollment key\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    course_code = request.form.get('course_code', '').strip().upper()\n    enrollment_key = request.form.get('enrollment_key', '').strip()\n    \n    if not course_code or not enrollment_key:\n        flash('Course code and enrollment key are required.', 'error')\n        return redirect(url_for('student_browse_courses'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Find the course\n        course = conn.execute('''\n            SELECT c.*, u.full_name as instructor_name\n            FROM courses c\n            JOIN users u ON c.instructor_id = u.id\n            WHERE c.course_code = ? AND c.is_active = 1\n        ''', (course_code,)).fetchone()\n        \n        if not course:\n            flash(f'Course with code \"{course_code}\" not found or is inactive.', 'error')\n            conn.close()\n            return redirect(url_for('student_browse_courses'))\n        \n        # Check if enrollment key is correct\n        if not course['enrollment_key_hash'] or not check_password_hash(course['enrollment_key_hash'], enrollment_key):\n            flash('Invalid enrollment key. Please check with your instructor.', 'error')\n            conn.close()\n            return redirect(url_for('student_browse_courses'))\n        \n        # Check if already enrolled\n        existing_enrollment = conn.execute('''\n            SELECT id FROM enrollments \n            WHERE student_id = ? AND course_id = ?\n        ''', (current_user.id, course['id'])).fetchone()\n        \n        if existing_enrollment:\n            flash('You have already requested enrollment for this course.', 'warning')\n            conn.close()\n            return redirect(url_for('student_browse_courses'))\n        \n        # Check course capacity\n        current_enrollments = conn.execute('''\n            SELECT COUNT(*) as count FROM enrollments \n            WHERE course_id = ? AND status = 'approved'\n        ''', (course['id'],)).fetchone()\n        \n        if current_enrollments['count'] >= course['max_students']:\n            flash('Course is full. No more enrollments accepted.', 'warning')\n            conn.close()\n            return redirect(url_for('student_browse_courses'))\n        \n        try:\n            # Create enrollment request\n            conn.execute('''\n                INSERT INTO enrollments (student_id, course_id, status)\n                VALUES (?, ?, 'pending')\n            ''', (current_user.id, course['id']))\n            \n            # Create notification for the instructor\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (course['instructor_id'],\n                  'New Enrollment Request',\n                  f'{current_user.full_name} has requested enrollment in \"{course[\"title\"]}\" ({course_code}). Please review and approve.',\n                  'info',\n                  course['id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Enrollment request submitted for \"{course[\"title\"]}\"! Your instructor ({course[\"instructor_name\"]}) will review and approve your request.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error submitting enrollment request. Please try again.', 'error')\n    \n    return redirect(url_for('student_browse_courses'))\n\n@app.route('/student/enrollments')\n@login_required\ndef student_my_enrollments():\n    \"\"\"View my enrollment status\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        enrollments = conn.execute('''\n            SELECT e.*, c.title as course_title, c.course_code, c.description,\n                   u.full_name as instructor_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ?\n            ORDER BY \n                CASE e.status \n                    WHEN 'pending' THEN 1\n                    WHEN 'approved' THEN 2\n                    WHEN 'rejected' THEN 3\n                END,\n                e.enrolled_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Statistics\n        stats = {\n            'total_enrollments': len(enrollments),\n            'pending_enrollments': len([e for e in enrollments if e['status'] == 'pending']),\n            'approved_enrollments': len([e for e in enrollments if e['status'] == 'approved']),\n            'rejected_enrollments': len([e for e in enrollments if e['status'] == 'rejected'])\n        }\n        \n        conn.close()\n    \n    return render_template('student/my_enrollments.html', \n                         enrollments=enrollments, \n                         stats=stats)\n\n# NEW FEATURE: Real-Time Discussion Forum (SMS-like messaging)\n@app.route('/course/<int:course_id>/discussion')\n@login_required\ndef course_discussion_forum(course_id):\n    \"\"\"Real-time discussion forum for course - SMS-like messaging between students and teachers\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify user has access to this course\n        course = conn.execute('SELECT * FROM courses WHERE id = ?', (course_id,)).fetchone()\n        \n        if not course:\n            flash('Course not found.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Check access\n        access = conn.execute('''\n            SELECT 1 FROM enrollments \n            WHERE student_id = ? AND course_id = ? AND status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        is_instructor = (current_user.id == course['instructor_id'])\n        \n        if not access and not is_instructor and not current_user.is_admin():\n            flash('You do not have access to this course.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get existing messages\n        messages = conn.execute('''\n            SELECT cm.*, u.full_name as sender_name, u.role as sender_role\n            FROM chat_messages cm\n            JOIN users u ON cm.sender_id = u.id\n            WHERE cm.course_id = ?\n            ORDER BY cm.created_at ASC\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('course_discussion.html', course=course, messages=messages)\n\n# Error handlers\n@app.errorhandler(404)\ndef not_found_error(error):\n    return render_template('errors/404.html'), 404\n\n@app.errorhandler(500)\ndef internal_error(error):\n    return render_template('errors/500.html'), 500\n\n# SocketIO events for real-time chat\n@socketio.on('connect')\ndef on_connect():\n    if not current_user.is_authenticated:\n        return False\n    join_room(f'user_{current_user.id}')\n    emit('status', {'msg': f'{current_user.full_name} has connected'})\n\n# NOTIFICATIONS ROUTES\n@app.route('/notifications')\n@login_required\ndef notifications():\n    \"\"\"View all notifications for current user\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        notifications = conn.execute('''\n            SELECT * FROM notifications \n            WHERE user_id = ? \n            ORDER BY created_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Mark all as read\n        conn.execute('''\n            UPDATE notifications \n            SET is_read = 1 \n            WHERE user_id = ? AND is_read = 0\n        ''', (current_user.id,))\n        \n        conn.commit()\n        conn.close()\n    \n    return render_template('notifications.html', notifications=notifications)\n\n@app.route('/api/notifications/unread-count')\n@login_required\ndef get_unread_notifications_count():\n    \"\"\"Get count of unread notifications\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            \n            result = conn.execute('''\n                SELECT COUNT(*) as count FROM notifications \n                WHERE user_id = ? AND is_read = 0\n            ''', (current_user.id,)).fetchone()\n            \n            count = result['count'] if result else 0\n            conn.close()\n        \n        return jsonify({'count': count})\n    except Exception as e:\n        print(f\"Error getting unread notifications: {e}\")\n        return jsonify({'count': 0, 'error': str(e)}), 200\n\n@app.route('/api/unread-messages/count')\n@login_required\ndef get_unread_messages_count():\n    \"\"\"Get count of unread messages in all courses\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            \n            # Count unread messages in courses where user is enrolled\n            result = conn.execute('''\n                SELECT COUNT(*) as count FROM chat_messages cm\n                JOIN enrollments e ON cm.course_id = e.course_id\n                WHERE e.student_id = ? AND cm.sender_id != ? AND cm.created_at > (\n                    SELECT COALESCE(MAX(viewed_at), '2020-01-01') FROM chat_messages\n                    WHERE course_id = cm.course_id AND sender_id = ?\n                )\n            ''', (current_user.id, current_user.id, current_user.id)).fetchone()\n            \n            count = result['count'] if result else 0\n            conn.close()\n        \n        return jsonify({'count': count})\n    except Exception as e:\n        print(f\"Error getting unread messages: {e}\")\n        return jsonify({'count': 0, 'error': str(e)}), 200\n\n@app.route('/api/generate-mcq-options', methods=['POST'])\n@instructor_required\ndef api_generate_mcq_options():\n    \"\"\"API endpoint to generate MCQ options using AI\"\"\"\n    data = request.get_json()\n    question_text = data.get('question', '').strip()\n    context = data.get('context', '').strip()\n    \n    if not question_text:\n        return jsonify({'error': 'Question text is required'}), 400\n    \n    try:\n        options = gemini_ai.generate_mcq_options(question_text, context)\n        \n        if options:\n            return jsonify({\n                'success': True,\n                'options': options\n            })\n        else:\n            return jsonify({\n                'success': False,\n                'error': 'Failed to generate options. Please try again.'\n            }), 500\n            \n    except Exception as e:\n        print(f\"Error generating MCQ options: {e}\")\n        return jsonify({\n            'success': False,\n            'error': 'An error occurred while generating options'\n        }), 500\n\n@app.route('/api/submissions/<int:submission_id>')\n@login_required\ndef api_get_submission(submission_id):\n    \"\"\"API endpoint to get detailed submission data for instructors\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get submission with student and quiz info\n        submission = conn.execute('''\n            SELECT s.*, u.full_name as student_name, u.username, u.email,\n                   a.title as quiz_title, a.course_id, c.instructor_id\n            FROM assignment_submissions s\n            JOIN users u ON s.student_id = u.id\n            JOIN assignments a ON s.assignment_id = a.id\n            JOIN courses c ON a.course_id = c.id\n            WHERE s.id = ?\n        ''', (submission_id,)).fetchone()\n        \n        if not submission:\n            conn.close()\n            return jsonify({'error': 'Submission not found'}), 404\n        \n        # Check if user has access (instructor of the course)\n        if not current_user.is_admin() and submission['instructor_id'] != current_user.id:\n            conn.close()\n            return jsonify({'error': 'Access denied'}), 403\n        \n        # Get MCQ answers\n        answers = conn.execute('''\n            SELECT ma.*, q.question_text, q.option_a, q.option_b, q.option_c, q.option_d,\n                   q.correct_answer, q.points\n            FROM student_mcq_answers ma\n            JOIN quiz_questions q ON ma.question_id = q.id\n            WHERE ma.submission_id = ?\n            ORDER BY q.id\n        ''', (submission_id,)).fetchall()\n        \n        conn.close()\n        \n        # Format response\n        response = {\n            'submission_id': submission['id'],\n            'student_name': submission['student_name'],\n            'username': submission['username'],\n            'email': submission['email'],\n            'quiz_title': submission['quiz_title'],\n            'submitted_at': submission['submitted_at'],\n            'grade': submission['grade'],\n            'ai_feedback': submission['ai_feedback'],\n            'answers': []\n        }\n        \n        for answer in answers:\n            response['answers'].append({\n                'question_id': answer['question_id'],\n                'question_text': answer['question_text'],\n                'options': {\n                    'A': answer['option_a'],\n                    'B': answer['option_b'],\n                    'C': answer['option_c'],\n                    'D': answer['option_d']\n                },\n                'selected_option': answer['selected_option'],\n                'correct_answer': answer['correct_answer'],\n                'is_correct': answer['is_correct'],\n                'points_earned': answer['points_earned'],\n                'points_possible': answer['points']\n            })\n        \n        return jsonify(response)\n\n@app.route('/notifications/<int:notification_id>/mark-read', methods=['POST'])\n@login_required  \ndef mark_notification_read(notification_id):\n    \"\"\"Mark specific notification as read\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        conn.execute('''\n            UPDATE notifications \n            SET is_read = 1 \n            WHERE id = ? AND user_id = ?\n        ''', (notification_id, current_user.id))\n        \n        conn.commit()\n        conn.close()\n    \n    return jsonify({'success': True})\n\n@app.route('/notifications/<int:notification_id>/redirect')\n@login_required\ndef handle_notification_redirect(notification_id):\n    \"\"\"Redirect user to relevant page based on notification type and mark as read\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        notification = conn.execute('''\n            SELECT * FROM notifications WHERE id = ? AND user_id = ?\n        ''', (notification_id, current_user.id)).fetchone()\n        \n        if notification:\n            conn.execute('UPDATE notifications SET is_read = 1 WHERE id = ?', (notification_id,))\n            conn.commit()\n        \n        conn.close()\n    \n    if not notification:\n        return redirect(url_for('dashboard'))\n    \n    # Route based on notification type and content\n    message_lower = notification['message'].lower()\n    course_id = notification['related_id']\n    \n    # Check what type of notification this is\n    if 'forum' in message_lower or 'discussion' in message_lower or 'topic' in message_lower:\n        # Redirect to course forums if we have a course ID\n        if course_id:\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        else:\n            return redirect(url_for('dashboard'))\n    \n    elif 'message' in message_lower or 'chat' in message_lower or 'community' in message_lower:\n        # Redirect to course discussion\n        if course_id:\n            return redirect(url_for('course_discussion_forum', course_id=course_id))\n        else:\n            return redirect(url_for('dashboard'))\n    \n    elif 'quiz' in message_lower or 'assignment' in message_lower or 'grade' in message_lower:\n        # Redirect to course page for quiz/assignment notifications\n        if course_id:\n            return redirect(url_for('student_course_view', course_id=course_id))\n        else:\n            return redirect(url_for('dashboard'))\n    \n    elif 'enrollment' in message_lower or 'course' in message_lower or 'approved' in message_lower:\n        # Redirect to course if available\n        if course_id:\n            return redirect(url_for('student_course_view', course_id=course_id))\n        else:\n            return redirect(url_for('dashboard'))\n    \n    elif 'progress' in message_lower:\n        # Redirect to course for progress updates\n        if course_id:\n            return redirect(url_for('student_course_view', course_id=course_id))\n        else:\n            return redirect(url_for('dashboard'))\n    \n    # Default fallback\n    if course_id:\n        return redirect(url_for('student_course_view', course_id=course_id))\n    \n    return redirect(url_for('dashboard'))\n\n# API ENDPOINTS FOR FETCHING MESSAGES\n@app.route('/api/course/<int:course_id>/messages')\n@login_required\ndef get_course_messages(course_id):\n    \"\"\"Get all messages for a course\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            \n            # Verify access\n            access = conn.execute('''\n                SELECT 1 FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, course_id)).fetchone()\n            \n            is_instructor = conn.execute('''\n                SELECT 1 FROM courses WHERE id = ? AND instructor_id = ?\n            ''', (course_id, current_user.id)).fetchone()\n            \n            if not (access or is_instructor or current_user.is_admin()):\n                conn.close()\n                return jsonify({'error': 'Access denied'}), 403\n            \n            messages = conn.execute('''\n                SELECT cm.*, u.full_name, u.role \n                FROM chat_messages cm\n                JOIN users u ON cm.sender_id = u.id\n                WHERE cm.course_id = ?\n                ORDER BY cm.created_at ASC\n            ''', (course_id,)).fetchall()\n            \n            conn.close()\n        \n        return jsonify({\n            'success': True,\n            'messages': [dict(m) for m in messages] if messages else []\n        })\n    except Exception as e:\n        print(f\"Error fetching course messages: {e}\")\n        return jsonify({'success': False, 'messages': [], 'error': str(e)}), 200\n\n# SOCKETIO CHAT HANDLERS\n@socketio.on('disconnect')\ndef on_disconnect():\n    if current_user.is_authenticated:\n        leave_room(f'user_{current_user.id}')\n\n@socketio.on('join_course_chat')\ndef on_join_course(data):\n    if not current_user.is_authenticated:\n        return\n    \n    course_id = data['course_id']\n    \n    # Verify user has access to this course\n    with db_lock:\n        conn = get_db_connection()\n        access = conn.execute('''\n            SELECT 1 FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            WHERE (e.student_id = ? OR c.instructor_id = ?) AND c.id = ? AND e.status = 'approved'\n        ''', (current_user.id, current_user.id, course_id)).fetchone()\n        conn.close()\n    \n    if access or current_user.is_admin():\n        join_room(f'course_{course_id}')\n        socketio.emit('status', {'msg': f'{current_user.full_name} joined the course chat'}, to=f'course_{course_id}')\n\n@socketio.on('send_course_message')\ndef handle_course_message(data):\n    if not current_user.is_authenticated:\n        return\n    \n    course_id = data['course_id']\n    message = data['message'].strip()\n    sender_role = data.get('sender_role', current_user.role)\n    \n    if not message:\n        return\n    \n    # Save message to database\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Insert message\n        conn.execute('''\n            INSERT INTO chat_messages (course_id, sender_id, message)\n            VALUES (?, ?, ?)\n        ''', (course_id, current_user.id, message))\n        \n        # Get all students in the course to send notifications\n        students = conn.execute('''\n            SELECT student_id FROM enrollments \n            WHERE course_id = ? AND status = 'approved' AND student_id != ?\n        ''', (course_id, current_user.id)).fetchall()\n        \n        conn.commit()\n        conn.close()\n    \n    # Emit message to course room\n    socketio.emit('new_course_message', {\n        'message': message,\n        'sender_name': current_user.full_name,\n        'sender_id': current_user.id,\n        'sender_role': sender_role,\n        'course_id': course_id,\n        'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n    }, to=f'course_{course_id}')\n    \n    # Send notifications to all other students in the course\n    for student in students:\n        socketio.emit('new_message_notification', {\n            'title': f'ðŸ’¬ New Message in Course',\n            'message': f'{current_user.full_name}: {message[:50]}{\"...\" if len(message) > 50 else \"\"}',\n            'type': 'info',\n            'icon': 'fa-comments',\n            'course_id': course_id,\n            'action_url': f'/discussions/{course_id}'\n        }, to=f'user_{student[\"student_id\"]}')\n\n# COMMUNITY CHAT HANDLERS\n@socketio.on('join_community_chat')\ndef on_join_community(data):\n    if not current_user.is_authenticated:\n        return\n    join_room('community_chat')\n\n@socketio.on('send_community_message')\ndef handle_community_message(data):\n    if not current_user.is_authenticated:\n        return\n    \n    message = data.get('message', '').strip()\n    sender_role = data.get('sender_role', current_user.role)\n    file_path = data.get('file_path')\n    file_name = data.get('file_name')\n    is_image = data.get('is_image', 0)\n    is_video = data.get('is_video', 0)\n    profile_picture = data.get('profile_picture', current_user.profile_picture)\n    \n    if not message:\n        return\n    \n    # Save to database\n    message_id = None\n    with db_lock:\n        conn = get_db_connection()\n        cursor = conn.execute('''\n            INSERT INTO chat_messages (course_id, sender_id, message, message_type, file_path, file_name, is_image)\n            VALUES (NULL, ?, ?, ?, ?, ?, ?)\n        ''', (current_user.id, message, 'file' if file_path else 'text', file_path, file_name, is_image or is_video))\n        message_id = cursor.lastrowid\n        conn.commit()\n        conn.close()\n    \n    socketio.emit('new_community_message', {\n        'id': message_id,\n        'message': message,\n        'sender_name': current_user.full_name,\n        'sender_id': current_user.id,\n        'sender_role': sender_role,\n        'profile_picture': profile_picture,\n        'file_path': file_path,\n        'file_name': file_name,\n        'is_image': is_image,\n        'is_video': is_video,\n        'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n    }, to='community_chat')\n\n# DIRECT MESSAGE HANDLERS (Admin/Instructor Chat)\n@socketio.on('join_direct_chat')\ndef on_join_direct_chat(data):\n    if not current_user.is_authenticated:\n        return\n    \n    recipient_id = data.get('recipient_id')\n    room = f'direct_{min(current_user.id, recipient_id)}_{max(current_user.id, recipient_id)}'\n    join_room(room)\n\n@socketio.on('send_direct_message')\ndef handle_direct_message(data):\n    if not current_user.is_authenticated:\n        return\n    \n    recipient_id = data.get('recipient_id')\n    message = data.get('message', '').strip()\n    \n    if not message or not recipient_id:\n        return\n    \n    # Save to database\n    with db_lock:\n        conn = get_db_connection()\n        conn.execute('''\n            INSERT INTO direct_messages (sender_id, recipient_id, message)\n            VALUES (?, ?, ?)\n        ''', (current_user.id, recipient_id, message))\n        conn.commit()\n        conn.close()\n    \n    room = f'direct_{min(current_user.id, recipient_id)}_{max(current_user.id, recipient_id)}'\n    socketio.emit('new_direct_message', {\n        'sender_name': current_user.full_name,\n        'sender_id': current_user.id,\n        'message': message,\n        'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n    }, to=room)\n    \n    # Send notification to recipient\n    socketio.emit('direct_message_notification', {\n        'title': f'ðŸ’Œ Direct Message from {current_user.full_name}',\n        'message': message[:50],\n        'type': 'warning',\n        'icon': 'fa-envelope'\n    }, to=f'user_{recipient_id}')\n\n# FILE UPLOAD HANDLER\n@app.route('/api/upload-chat-file', methods=['POST'])\n@login_required\ndef upload_chat_file():\n    \"\"\"Upload file to chat\"\"\"\n    try:\n        if 'file' not in request.files:\n            return jsonify({'error': 'No file provided'}), 400\n        \n        file = request.files['file']\n        course_id = request.form.get('course_id')\n        message_text = request.form.get('message', '')\n        \n        if not file.filename:\n            return jsonify({'error': 'No file selected'}), 400\n        \n        # Check file extension\n        file_ext = file.filename.rsplit('.', 1)[-1].lower()\n        if file_ext not in ALLOWED_FILE_TYPES:\n            return jsonify({'error': f'File type .{file_ext} not allowed'}), 400\n        \n        # Check file size\n        file.seek(0, 2)\n        file_size = file.tell()\n        file.seek(0)\n        \n        if file_size > MAX_CHAT_FILE_SIZE:\n            return jsonify({'error': f'File size exceeds {MAX_CHAT_FILE_SIZE / (1024*1024):.0f} MB limit'}), 400\n        \n        # Check user storage\n        with db_lock:\n            conn = get_db_connection()\n            user_storage = conn.execute('''\n                SELECT SUM(file_size) as total FROM file_uploads \n                WHERE uploader_id = ?\n            ''', (current_user.id,)).fetchone()\n            total_used = user_storage['total'] or 0\n            conn.close()\n        \n        if total_used + file_size > MAX_TOTAL_STORAGE_PER_USER:\n            return jsonify({'error': 'Storage limit exceeded (5 GB per user)'}), 400\n        \n        # Save file\n        unique_filename = f\"{current_user.id}_{uuid.uuid4().hex}_{secure_filename(file.filename)}\"\n        original_filename = file.filename\n        upload_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'chat_files')\n        filepath = os.path.join(upload_dir, unique_filename)\n        file.save(filepath)\n        \n        # Determine if image\n        is_image = file_ext in {'jpg', 'jpeg', 'png', 'gif'}\n        \n        # Save to database\n        with db_lock:\n            conn = get_db_connection()\n            conn.execute('''\n                INSERT INTO chat_messages \n                (course_id, sender_id, message, message_type, file_path, file_name, file_size, is_image)\n                VALUES (?, ?, ?, ?, ?, ?, ?, ?)\n            ''', (course_id, current_user.id, message_text or original_filename, 'file', unique_filename, original_filename, file_size, is_image))\n            \n            message_id = conn.execute('SELECT last_insert_rowid()').fetchone()[0]\n            \n            conn.execute('''\n                INSERT INTO file_uploads (uploader_id, file_name, file_path, file_size, file_type, message_id)\n                VALUES (?, ?, ?, ?, ?, ?)\n            ''', (current_user.id, original_filename, unique_filename, file_size, file_ext, message_id))\n            \n            conn.commit()\n            conn.close()\n        \n        return jsonify({\n            'success': True,\n            'file_path': f'/uploads/chat_files/{unique_filename}',\n            'file_name': original_filename,\n            'file_type': file_ext\n        })\n        \n    except Exception as e:\n        logging.error(f\"File upload error: {e}\")\n        return jsonify({'error': str(e)}), 500\n\n@app.route('/download-chat-file/<filename>')\n@login_required\ndef download_chat_file(filename):\n    \"\"\"Download uploaded chat file\"\"\"\n    try:\n        filepath = os.path.join(app.config['UPLOAD_FOLDER'], 'chat_files', filename)\n        if os.path.exists(filepath):\n            return send_from_directory(os.path.dirname(filepath), filename, as_attachment=True)\n        return jsonify({'error': 'File not found'}), 404\n    except Exception as e:\n        return jsonify({'error': str(e)}), 500\n\n@app.route('/uploads/chat_files/<filename>')\n@login_required\ndef serve_chat_file(filename):\n    \"\"\"Serve uploaded chat files\"\"\"\n    return send_from_directory(os.path.join(app.config['UPLOAD_FOLDER'], 'chat_files'), filename)\n\n# MESSAGING HUB ROUTE\n@app.route('/forum')\n@login_required\ndef messaging_hub():\n    \"\"\"Central messaging hub showing all chat options\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get user's courses if student\n        my_courses = []\n        if current_user.role == 'student':\n            my_courses = conn.execute('''\n                SELECT c.id, c.title, c.course_code \n                FROM courses c\n                JOIN enrollments e ON c.id = e.course_id\n                WHERE e.student_id = ? AND e.status = 'approved'\n                ORDER BY c.title\n            ''', (current_user.id,)).fetchall()\n        \n        # Get instructor's courses\n        instructor_courses = []\n        if current_user.is_instructor() or current_user.is_admin():\n            instructor_courses = conn.execute('''\n                SELECT id, title, course_code FROM courses \n                WHERE instructor_id = ?\n                ORDER BY title\n            ''', (current_user.id,)).fetchall()\n        \n        # Get all courses for admin\n        all_courses = []\n        if current_user.is_admin():\n            all_courses = conn.execute('''\n                SELECT c.id, c.title, c.course_code, u.full_name as instructor_name\n                FROM courses c\n                LEFT JOIN users u ON c.instructor_id = u.id\n                ORDER BY c.title\n            ''', ).fetchall()\n        \n        conn.close()\n    \n    return render_template('messaging_hub.html', \n                         my_courses=my_courses,\n                         instructor_courses=instructor_courses,\n                         all_courses=all_courses)\n\n# COMMUNITY CHAT ROUTE\n@app.route('/community-chat')\n@login_required\ndef community_chat():\n    \"\"\"Display community chat (all users)\"\"\"\n    return render_template('community_chat.html')\n\n# DIRECT MESSAGES CRUD ROUTES\n@app.route('/direct-messages')\n@login_required\ndef direct_messages_page():\n    \"\"\"Display direct messages page\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        # Get all students for instructor/admin, or instructors for students\n        if current_user.is_admin() or current_user.is_instructor():\n            users = conn.execute('''\n                SELECT DISTINCT u.id, u.full_name, u.role FROM users u\n                WHERE u.role = 'student' AND u.id != ?\n                ORDER BY u.full_name\n            ''', (current_user.id,)).fetchall()\n        else:\n            users = conn.execute('''\n                SELECT DISTINCT u.id, u.full_name, u.role FROM users u\n                WHERE (u.role = 'instructor' OR u.role = 'admin') AND u.id != ?\n                ORDER BY u.full_name\n            ''', (current_user.id,)).fetchall()\n        conn.close()\n    \n    return render_template('direct_messages.html', users=users)\n\n@app.route('/api/direct-messages/<int:user_id>')\n@login_required\ndef get_direct_messages(user_id):\n    \"\"\"Get direct messages with a specific user\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            messages = conn.execute('''\n                SELECT id, sender_id, recipient_id, message, created_at \n                FROM direct_messages \n                WHERE (sender_id = ? AND recipient_id = ?) OR (sender_id = ? AND recipient_id = ?)\n                ORDER BY created_at ASC\n                LIMIT 100\n            ''', (current_user.id, user_id, user_id, current_user.id)).fetchall()\n            \n            # Mark as read\n            conn.execute('''\n                UPDATE direct_messages SET is_read = 1 \n                WHERE recipient_id = ? AND sender_id = ? AND is_read = 0\n            ''', (current_user.id, user_id))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'messages': [dict(m) for m in messages]})\n    except Exception as e:\n        print(f\"Error loading direct messages: {e}\")\n        return jsonify({'messages': [], 'error': str(e)}), 200\n\n@app.route('/api/direct-messages/<int:message_id>', methods=['DELETE'])\n@login_required\ndef delete_direct_message(message_id):\n    \"\"\"Delete a direct message\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            # Verify ownership\n            msg = conn.execute('SELECT sender_id FROM direct_messages WHERE id = ?', (message_id,)).fetchone()\n            \n            if not msg or msg['sender_id'] != current_user.id:\n                conn.close()\n                return jsonify({'error': 'Unauthorized'}), 403\n            \n            conn.execute('DELETE FROM direct_messages WHERE id = ?', (message_id,))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        print(f\"Error deleting message: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 200\n\n@app.route('/api/direct-messages/<int:message_id>', methods=['PATCH'])\n@login_required\ndef edit_direct_message(message_id):\n    \"\"\"Edit a direct message\"\"\"\n    try:\n        data = request.get_json()\n        message = data.get('message', '').strip() if data else ''\n        \n        if not message:\n            return jsonify({'error': 'Message cannot be empty'}), 400\n        \n        with db_lock:\n            conn = get_db_connection()\n            # Verify ownership\n            msg = conn.execute('SELECT sender_id FROM direct_messages WHERE id = ?', (message_id,)).fetchone()\n            \n            if not msg or msg['sender_id'] != current_user.id:\n                conn.close()\n                return jsonify({'error': 'Unauthorized'}), 403\n            \n            conn.execute('UPDATE direct_messages SET message = ? WHERE id = ?', (message, message_id))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        print(f\"Error editing message: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 200\n\n# USER PROFILE ENDPOINTS\n@app.route('/api/profile/bio', methods=['POST'])\n@login_required\ndef update_bio():\n    \"\"\"Update user bio\"\"\"\n    try:\n        data = request.get_json()\n        bio = data.get('bio', '').strip()[:500]\n        \n        with db_lock:\n            conn = get_db_connection()\n            conn.execute('UPDATE users SET bio = ? WHERE id = ?', (bio, current_user.id))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        return jsonify({'success': False, 'error': str(e)}), 200\n\n@app.route('/api/profile/phone', methods=['POST'])\n@login_required\ndef update_phone():\n    \"\"\"Update phone number\"\"\"\n    try:\n        data = request.get_json()\n        phone = data.get('phone', '').strip()\n        \n        with db_lock:\n            conn = get_db_connection()\n            conn.execute('''INSERT OR REPLACE INTO user_profiles (user_id, phone_number)\n                VALUES (?, ?)''', (current_user.id, phone))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        return jsonify({'success': False, 'error': str(e)}), 200\n\n@app.route('/api/contacts')\n@login_required\ndef get_contacts():\n    \"\"\"Get user contacts\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            contacts = conn.execute('''SELECT u.id, u.full_name FROM contacts c\n                JOIN users u ON c.contact_id = u.id WHERE c.user_id = ?\n                ORDER BY u.full_name''', (current_user.id,)).fetchall()\n            conn.close()\n        \n        return jsonify({'contacts': [dict(c) for c in contacts]})\n    except Exception as e:\n        return jsonify({'contacts': [], 'error': str(e)}), 200\n\n@app.route('/api/messages/<int:message_id>/react', methods=['POST'])\n@login_required\ndef add_reaction(message_id):\n    \"\"\"Add emoji reaction to message\"\"\"\n    try:\n        data = request.get_json()\n        emoji = data.get('emoji', '').strip()[:2]\n        \n        if not emoji:\n            return jsonify({'error': 'Invalid emoji'}), 400\n        \n        with db_lock:\n            conn = get_db_connection()\n            conn.execute('''INSERT OR IGNORE INTO message_reactions (message_id, user_id, emoji)\n                VALUES (?, ?, ?)''', (message_id, current_user.id, emoji))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        return jsonify({'success': False}), 200\n\n# CRUD OPERATIONS FOR CHAT MESSAGES\n@app.route('/api/chat-messages/<int:message_id>', methods=['PATCH'])\n@login_required\ndef edit_chat_message(message_id):\n    \"\"\"Edit a chat message (community or course)\"\"\"\n    try:\n        data = request.get_json()\n        message = data.get('message', '').strip()\n        \n        if not message:\n            return jsonify({'error': 'Message cannot be empty'}), 400\n        \n        with db_lock:\n            conn = get_db_connection()\n            # Verify ownership\n            msg = conn.execute('SELECT sender_id FROM chat_messages WHERE id = ?', (message_id,)).fetchone()\n            \n            if not msg or msg['sender_id'] != current_user.id:\n                conn.close()\n                return jsonify({'error': 'Unauthorized'}), 403\n            \n            conn.execute('UPDATE chat_messages SET message = ? WHERE id = ?', (message, message_id))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True, 'message': message})\n    except Exception as e:\n        logging.error(f\"Error editing message: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n@app.route('/api/chat-messages/<int:message_id>', methods=['DELETE'])\n@login_required\ndef delete_chat_message(message_id):\n    \"\"\"Delete a chat message (community or course)\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            # Verify ownership\n            msg = conn.execute('SELECT sender_id FROM chat_messages WHERE id = ?', (message_id,)).fetchone()\n            \n            if not msg or msg['sender_id'] != current_user.id:\n                conn.close()\n                return jsonify({'error': 'Unauthorized'}), 403\n            \n            conn.execute('DELETE FROM chat_messages WHERE id = ?', (message_id,))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        logging.error(f\"Error deleting message: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n@socketio.on('user_typing')\ndef handle_typing(data):\n    \"\"\"Broadcast typing indicator\"\"\"\n    if not current_user.is_authenticated:\n        return\n    \n    socketio.emit('user_typing', {\n        'user_id': current_user.id,\n        'user_name': current_user.full_name,\n        'room': data.get('room')\n    }, to=data.get('room'))\n\n@socketio.on('update_status')\ndef update_status(data):\n    \"\"\"Update user online/offline status\"\"\"\n    if not current_user.is_authenticated:\n        return\n    \n    with db_lock:\n        conn = get_db_connection()\n        status = data.get('status', 'online')\n        conn.execute('''INSERT OR REPLACE INTO user_profiles (user_id, status, last_seen)\n            VALUES (?, ?, CURRENT_TIMESTAMP)''', (current_user.id, status))\n        conn.commit()\n        conn.close()\n    \n    socketio.emit('user_status_changed', {\n        'user_id': current_user.id,\n        'status': status\n    }, broadcast=True)\n\n\n@app.route('/course/<int:course_id>/ai_notes')\n@login_required\ndef ai_notes_page(course_id):\n    \"\"\"AI Notes page for instructors and students\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        course = conn.execute('SELECT * FROM courses WHERE id = ?', (course_id,)).fetchone()\n        \n        if not course:\n            conn.close()\n            flash('Course not found', 'error')\n            return redirect(url_for('dashboard'))\n        \n        if current_user.role == 'instructor':\n            if course['instructor_id'] != current_user.id:\n                conn.close()\n                flash('You do not have permission to access this course', 'error')\n                return redirect(url_for('dashboard'))\n            \n            my_notes = conn.execute('''SELECT * FROM ai_notes WHERE course_id = ? AND created_by = ? \n                AND is_instructor_note = 1 ORDER BY created_at DESC''', \n                (course_id, current_user.id)).fetchall()\n            conn.close()\n            return render_template('ai_notes_instructor.html', course=course, notes=my_notes)\n        else:\n            enrollment = conn.execute('''SELECT * FROM enrollments WHERE course_id = ? AND student_id = ? \n                AND status = 'approved' ''', (course_id, current_user.id)).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                flash('You are not enrolled in this course', 'error')\n                return redirect(url_for('dashboard'))\n            \n            instructor_notes = conn.execute('''SELECT an.*, u.full_name as instructor_name FROM ai_notes an \n                JOIN users u ON an.created_by = u.id \n                WHERE an.course_id = ? AND an.is_instructor_note = 1 AND an.sent_to_students = 1 \n                ORDER BY an.created_at DESC''', (course_id,)).fetchall()\n            my_notes = conn.execute('''SELECT * FROM ai_notes WHERE course_id = ? AND created_by = ? \n                AND is_instructor_note = 0 ORDER BY created_at DESC''', \n                (course_id, current_user.id)).fetchall()\n            conn.close()\n            return render_template('ai_notes_student.html', course=course, \n                instructor_notes=instructor_notes, my_notes=my_notes)\n\n\n@app.route('/course/<int:course_id>/ai_notes/generate', methods=['POST'])\n@login_required\n@instructor_required\ndef generate_ai_notes(course_id):\n    \"\"\"Generate AI notes for a topic\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            course = conn.execute('SELECT * FROM courses WHERE id = ? AND instructor_id = ?', \n                (course_id, current_user.id)).fetchone()\n            conn.close()\n        \n        if not course:\n            return jsonify({'success': False, 'error': 'You do not own this course'}), 403\n        \n        topic = request.form.get('topic', '').strip()\n        additional_context = request.form.get('additional_context', '').strip()\n        \n        if not topic:\n            return jsonify({'success': False, 'error': 'Topic is required'}), 400\n        \n        result = gemini_ai.generate_ai_notes(topic, current_user.full_name, additional_context)\n        \n        if result.get('success'):\n            with db_lock:\n                conn = get_db_connection()\n                conn.execute('''INSERT INTO ai_notes (course_id, topic, content, created_by, is_instructor_note)\n                    VALUES (?, ?, ?, ?, 1)''', (course_id, topic, result['content'], current_user.id))\n                note_id = conn.execute('SELECT last_insert_rowid()').fetchone()[0]\n                conn.commit()\n                conn.close()\n            \n            return jsonify({'success': True, 'note_id': note_id, 'content': result['content']})\n        else:\n            return jsonify({'success': False, 'error': result.get('error', 'Failed to generate notes')}), 500\n    \n    except Exception as e:\n        logging.error(f\"Error generating AI notes: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/course/<int:course_id>/ai_notes/<int:note_id>/edit', methods=['POST'])\n@login_required\n@instructor_required\ndef edit_ai_notes(course_id, note_id):\n    \"\"\"Edit AI notes content\"\"\"\n    try:\n        content = request.form.get('content', '').strip()\n        \n        if not content:\n            return jsonify({'success': False, 'error': 'Content is required'}), 400\n        \n        with db_lock:\n            conn = get_db_connection()\n            conn.execute('UPDATE ai_notes SET content = ? WHERE id = ? AND created_by = ? AND course_id = ?',\n                (content, note_id, current_user.id, course_id))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    \n    except Exception as e:\n        logging.error(f\"Error editing AI notes: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/course/<int:course_id>/ai_notes/<int:note_id>/create_pdf', methods=['POST'])\n@login_required\n@instructor_required\ndef create_notes_pdf(course_id, note_id):\n    \"\"\"Create PDF from AI notes\"\"\"\n    try:\n        from utils.pdf_generator import generate_notes_pdf\n        \n        with db_lock:\n            conn = get_db_connection()\n            note = conn.execute('SELECT * FROM ai_notes WHERE id = ? AND created_by = ? AND course_id = ?',\n                (note_id, current_user.id, course_id)).fetchone()\n            conn.close()\n        \n        if not note:\n            return jsonify({'success': False, 'error': 'Note not found'}), 404\n        \n        notes_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'ai_notes')\n        os.makedirs(notes_dir, exist_ok=True)\n        \n        filename = f'notes_{note_id}_{int(datetime.now().timestamp())}.pdf'\n        pdf_path = os.path.join(notes_dir, filename)\n        \n        success = generate_notes_pdf(note['content'], note['topic'], current_user.full_name, pdf_path)\n        \n        if success:\n            relative_path = f'ai_notes/{filename}'\n            \n            with db_lock:\n                conn = get_db_connection()\n                conn.execute('UPDATE ai_notes SET pdf_path = ? WHERE id = ?', (relative_path, note_id))\n                conn.commit()\n                conn.close()\n            \n            return jsonify({'success': True, 'pdf_path': relative_path})\n        else:\n            return jsonify({'success': False, 'error': 'Failed to create PDF'}), 500\n    \n    except Exception as e:\n        logging.error(f\"Error creating PDF: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/course/<int:course_id>/ai_notes/<int:note_id>/send', methods=['POST'])\n@login_required\n@instructor_required\ndef send_notes_to_students(course_id, note_id):\n    \"\"\"Send AI notes to all enrolled students\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            note = conn.execute('SELECT * FROM ai_notes WHERE id = ? AND created_by = ? AND course_id = ?',\n                (note_id, current_user.id, course_id)).fetchone()\n            \n            if not note:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Note not found'}), 404\n            \n            if not note['pdf_path']:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Please create PDF first'}), 400\n            \n            conn.execute('UPDATE ai_notes SET sent_to_students = 1 WHERE id = ?', (note_id,))\n            \n            students = conn.execute('''SELECT student_id FROM enrollments WHERE course_id = ? \n                AND status = 'approved' ''', (course_id,)).fetchall()\n            \n            for student in students:\n                conn.execute('''INSERT INTO notifications (user_id, title, message, type, related_id)\n                    VALUES (?, ?, ?, ?, ?)''',\n                    (student['student_id'], 'New AI Notes Available', \n                    f'New AI notes available for {note[\"topic\"]}', 'ai_notes', note_id))\n            \n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    \n    except Exception as e:\n        logging.error(f\"Error sending notes: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/course/<int:course_id>/ai_notes/<int:note_id>/delete', methods=['POST'])\n@login_required\ndef delete_ai_notes(course_id, note_id):\n    \"\"\"Delete AI notes\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            note = conn.execute('SELECT * FROM ai_notes WHERE id = ? AND created_by = ? AND course_id = ?',\n                (note_id, current_user.id, course_id)).fetchone()\n            \n            if not note:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Note not found'}), 404\n            \n            # Delete PDF file if it exists\n            if note['pdf_path']:\n                pdf_file = os.path.join(app.config['UPLOAD_FOLDER'], note['pdf_path'])\n                if os.path.exists(pdf_file):\n                    try:\n                        os.remove(pdf_file)\n                    except Exception as e:\n                        logging.warning(f\"Could not delete PDF file: {e}\")\n            \n            conn.execute('DELETE FROM ai_notes WHERE id = ?', (note_id,))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    \n    except Exception as e:\n        logging.error(f\"Error deleting AI notes: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/course/<int:course_id>/ai_notes/student/create', methods=['POST'])\n@login_required\ndef student_create_notes(course_id):\n    \"\"\"Student create their own AI notes\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            enrollment = conn.execute('''SELECT * FROM enrollments WHERE course_id = ? AND student_id = ? \n                AND status = 'approved' ''', (course_id, current_user.id)).fetchone()\n            conn.close()\n        \n        if not enrollment:\n            return jsonify({'success': False, 'error': 'You are not enrolled in this course'}), 403\n        \n        topic = request.form.get('topic', '').strip()\n        additional_context = request.form.get('additional_context', '').strip()\n        add_watermark = request.form.get('add_watermark') == 'on'\n        custom_watermark = request.form.get('custom_watermark', '').strip()\n        \n        if not topic:\n            return jsonify({'success': False, 'error': 'Topic is required'}), 400\n        \n        result = gemini_ai.generate_ai_notes(topic, '', additional_context)\n        \n        if result.get('success'):\n            from utils.pdf_generator import generate_notes_pdf\n            \n            with db_lock:\n                conn = get_db_connection()\n                conn.execute('''INSERT INTO ai_notes (course_id, topic, content, created_by, is_instructor_note)\n                    VALUES (?, ?, ?, ?, 0)''', (course_id, topic, result['content'], current_user.id))\n                note_id = conn.execute('SELECT last_insert_rowid()').fetchone()[0]\n                conn.commit()\n                conn.close()\n            \n            notes_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'ai_notes')\n            os.makedirs(notes_dir, exist_ok=True)\n            \n            filename = f'notes_{note_id}_{int(datetime.now().timestamp())}.pdf'\n            pdf_path = os.path.join(notes_dir, filename)\n            \n            success = generate_notes_pdf(result['content'], topic, current_user.full_name, pdf_path, \n                                        add_watermark=add_watermark, custom_watermark=custom_watermark)\n            \n            relative_path = None\n            if success:\n                relative_path = f'ai_notes/{filename}'\n                \n                with db_lock:\n                    conn = get_db_connection()\n                    conn.execute('UPDATE ai_notes SET pdf_path = ? WHERE id = ?', (relative_path, note_id))\n                    conn.commit()\n                    conn.close()\n            \n            return jsonify({'success': True, 'note_id': note_id, 'pdf_path': relative_path})\n        else:\n            return jsonify({'success': False, 'error': result.get('error', 'Failed to generate notes')}), 500\n    \n    except Exception as e:\n        logging.error(f\"Error creating student notes: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/uploads/<path:filename>')\ndef serve_upload(filename):\n    \"\"\"Serve uploaded files\"\"\"\n    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)\n\n\nif __name__ == '__main__':\n    # Initialize database before starting Flask\n    db_ready = init_db()\n    if not db_ready:\n        print(\"âš ï¸  Database initialization incomplete, but continuing with Flask startup...\")\n    \n    socketio.run(app, host='0.0.0.0', port=5000, debug=True, use_reloader=False, log_output=True, allow_unsafe_werkzeug=True)","size_bytes":269778},"zsam/gemini_ai.py":{"content":"# IMPORTANT: KEEP THIS COMMENT\n# Follow these instructions when using this blueprint:\n# - Note that the newest Gemini model series is \"gemini-2.5-flash\" or gemini-2.5-pro\"\n#   - do not change this unless explicitly requested by the user\n# - Sometimes the google genai SDK has occasional type errors. You might need to run to validate, at time.  \n# The SDK was recently renamed from google-generativeai to google-genai. This file reflects the new name and the new APIs.\n\nimport json\nimport logging\nimport os\nfrom google import genai\nfrom google.genai import types\n\n# This API key is from Gemini Developer API Key, not vertex AI API Key\nclient = genai.Client(api_key=os.environ.get(\"GOOGLE_GENAI_API_KEY\", \"AIzaSyA6HBwd_66hfcflHlTSZDB_qxpUUSiOXDg\"))\n\ndef grade_assignment(assignment_text, rubric=\"\", max_points=100):\n    \"\"\"Grade an assignment using Gemini AI with detailed feedback\"\"\"\n    try:\n        prompt = f\"\"\"\n        Please grade this assignment and provide detailed feedback.\n        \n        Assignment Text:\n        {assignment_text}\n        \n        Grading Rubric:\n        {rubric if rubric else \"Standard academic grading criteria focusing on content accuracy, clarity, organization, and completeness.\"}\n        \n        Maximum Points: {max_points}\n        \n        Please provide your response in the following JSON format:\n        {{\n            \"grade\": <numeric_grade>,\n            \"percentage\": <percentage_score>,\n            \"feedback\": \"Detailed feedback explaining strengths and areas for improvement\",\n            \"suggestions\": \"Specific suggestions for improvement\"\n        }}\n        \"\"\"\n        \n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        if response.text:\n            result = json.loads(response.text)\n            return {\n                'grade': min(float(result.get('grade', 0)), max_points),\n                'percentage': min(float(result.get('percentage', 0)), 100),\n                'feedback': result.get('feedback', 'No feedback provided'),\n                'suggestions': result.get('suggestions', 'No suggestions provided')\n            }\n        else:\n            return {\n                'grade': 0,\n                'percentage': 0,\n                'feedback': 'Unable to grade assignment automatically',\n                'suggestions': 'Please have instructor review manually'\n            }\n            \n    except Exception as e:\n        logging.error(f\"Error grading assignment: {e}\")\n        return {\n            'grade': 0,\n            'percentage': 0,\n            'feedback': 'Error occurred during automated grading',\n            'suggestions': 'Please have instructor review manually'\n        }\n\ndef generate_mcq_options(question_text, context=\"\"):\n    \"\"\"Generate 4 MCQ options for a given question using AI\"\"\"\n    try:\n        prompt = f\"\"\"\n        Generate 4 multiple choice options (A, B, C, D) for the following question.\n        Make sure one option is correct and the other three are plausible but incorrect.\n        \n        Question: {question_text}\n        {f\"Context/Topic: {context}\" if context else \"\"}\n        \n        Provide your response in the following JSON format:\n        {{\n            \"option_a\": \"First option text\",\n            \"option_b\": \"Second option text\",\n            \"option_c\": \"Third option text\",\n            \"option_d\": \"Fourth option text\",\n            \"correct_answer\": \"A\",\n            \"explanation\": \"Brief explanation of why the correct answer is right\"\n        }}\n        \n        Make the options clear, concise, and educational.\n        \"\"\"\n        \n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        if response.text:\n            result = json.loads(response.text)\n            return {\n                'option_a': result.get('option_a', ''),\n                'option_b': result.get('option_b', ''),\n                'option_c': result.get('option_c', ''),\n                'option_d': result.get('option_d', ''),\n                'correct_answer': result.get('correct_answer', 'A'),\n                'explanation': result.get('explanation', '')\n            }\n        else:\n            return None\n            \n    except Exception as e:\n        logging.error(f\"Error generating MCQ options: {e}\")\n        return None\n\ndef generate_forum_response(topic_title, topic_content, existing_replies=\"\"):\n    \"\"\"Generate an AI response for forum discussions\"\"\"\n    try:\n        prompt = f\"\"\"\n        Generate a helpful and educational response to this forum discussion topic.\n        \n        Topic: {topic_title}\n        Content: {topic_content}\n        \n        Existing Replies: {existing_replies if existing_replies else \"None\"}\n        \n        Please provide a constructive, educational response that:\n        1. Addresses the main points raised\n        2. Provides additional insights or clarifications\n        3. Encourages further discussion\n        4. Maintains a supportive learning environment\n        \n        Keep the response conversational and academic in tone.\n        \"\"\"\n        \n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt\n        )\n        \n        return response.text if response.text else \"Unable to generate AI response at this time.\"\n        \n    except Exception as e:\n        logging.error(f\"Error generating forum response: {e}\")\n        return \"Unable to generate AI response at this time.\"\n\ndef determine_correct_answer(question_text, options):\n    \"\"\"\n    NEW FEATURE: AI Auto-Correction for MCQ\n    Gemini AI automatically determines which option is correct based on the question and available options.\n    Instructor does NOT need to select the correct answer manually.\n    \n    Args:\n        question_text (str): The MCQ question\n        options (dict): Dictionary of options like {'A': 'text', 'B': 'text', 'C': 'text', 'D': 'text'}\n    \n    Returns:\n        str: The letter of the correct answer (A, B, C, or D)\n    \"\"\"\n    try:\n        options_text = \"\\n\".join([f\"{letter}. {text}\" for letter, text in options.items()])\n        \n        prompt = f\"\"\"\n        You are an educational AI assistant. Given the following multiple-choice question and options, \n        determine which option (A, B, C, or D) is the CORRECT answer.\n        \n        Question:\n        {question_text}\n        \n        Options:\n        {options_text}\n        \n        Analyze the question carefully and respond with ONLY the letter (A, B, C, or D) of the correct answer.\n        Do not include any explanation, just the single letter.\n        \"\"\"\n        \n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt\n        )\n        \n        if response.text:\n            answer = response.text.strip().upper()\n            if answer in ['A', 'B', 'C', 'D']:\n                logging.info(f\"AI determined correct answer: {answer} for question: {question_text[:50]}...\")\n                return answer\n            else:\n                logging.warning(f\"AI response '{answer}' is not valid. Defaulting to 'A'\")\n                return 'A'\n        else:\n            logging.warning(\"No AI response received. Defaulting to 'A'\")\n            return 'A'\n            \n    except Exception as e:\n        logging.error(f\"Error determining correct answer with AI: {e}\")\n        return 'A'\n\ndef analyze_student_progress(assignment_history, participation_data):\n    \"\"\"Analyze student progress and provide recommendations\"\"\"\n    try:\n        prompt = f\"\"\"\n        Analyze this student's academic progress and provide recommendations.\n        \n        Assignment History: {assignment_history}\n        Participation Data: {participation_data}\n        \n        Please provide analysis in JSON format:\n        {{\n            \"overall_performance\": \"assessment of overall performance\",\n            \"strengths\": [\"list of strengths\"],\n            \"areas_for_improvement\": [\"list of areas to improve\"],\n            \"recommendations\": [\"specific recommendations for student\"],\n            \"engagement_level\": \"high/medium/low\"\n        }}\n        \"\"\"\n        \n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        if response.text:\n            return json.loads(response.text)\n        else:\n            return {\n                \"overall_performance\": \"Unable to analyze\",\n                \"strengths\": [],\n                \"areas_for_improvement\": [],\n                \"recommendations\": [],\n                \"engagement_level\": \"unknown\"\n            }\n            \n    except Exception as e:\n        logging.error(f\"Error analyzing student progress: {e}\")\n        return {\n            \"overall_performance\": \"Analysis unavailable\",\n            \"strengths\": [],\n            \"areas_for_improvement\": [],\n            \"recommendations\": [],\n            \"engagement_level\": \"unknown\"\n        }\n\ndef generate_video_transcript(video_title, video_description=\"\", video_duration=\"\", video_url=\"\"):\n    \"\"\"\n    NEW FEATURE: AI-Powered Video Transcript Generation\n    Generate a comprehensive educational transcript for a video using Gemini AI.\n    This analyzes the actual YouTube video content to create detailed transcripts.\n    \n    Args:\n        video_title (str): The title of the video\n        video_description (str): Optional description of the video content\n        video_duration (str): Optional duration of the video\n        video_url (str): YouTube video URL for analysis\n    \n    Returns:\n        str: A comprehensive transcript/notes for the video\n    \"\"\"\n    try:\n        duration_text = f\"Video Duration: {video_duration}\" if video_duration else \"\"\n        description_text = f\"\\nVideo Description:\\n{video_description}\" if video_description else \"\"\n        \n        # If video URL is provided, use Gemini's video understanding\n        if video_url and ('youtube.com' in video_url or 'youtu.be' in video_url):\n            prompt = f\"\"\"\n            You are an expert educational content creator. Analyze this YouTube educational video and generate a comprehensive, \n            detailed transcript and lecture notes.\n            \n            Video Title: {video_title}\n            {description_text}\n            {duration_text}\n            Video URL: {video_url}\n            \n            Please watch/analyze the video and create a detailed educational transcript that includes:\n            \n            1. INTRODUCTION\n               - Brief overview of what the video covers\n               - Learning objectives from the actual video content\n            \n            2. MAIN CONTENT (based on actual video)\n               - Comprehensive coverage of topics discussed in the video\n               - Key concepts and definitions mentioned\n               - Important points and explanations from the lecture\n               - Examples and demonstrations shown\n               - Visual content described\n            \n            3. KEY TAKEAWAYS\n               - Summary of main points from the video\n               - Important concepts to remember\n            \n            4. TIMESTAMPS & TOPICS (if applicable)\n               - Major sections of the video with approximate timestamps\n            \n            5. ADDITIONAL RESOURCES\n               - Suggested topics for further study based on video content\n               - Related concepts mentioned in the video\n            \n            Format the transcript in a clear, professional manner with proper headings and structure.\n            Make it comprehensive enough to serve as standalone study material for students.\n            The transcript should be detailed (1000-2000 words) to provide substantial educational value.\n            \"\"\"\n        else:\n            # Fallback to title and description if no valid YouTube URL\n            prompt = f\"\"\"\n            You are an expert educational content creator. Generate a comprehensive, detailed transcript and lecture notes \n            for an educational video based on the following information:\n            \n            Video Title: {video_title}\n            {description_text}\n            {duration_text}\n            \n            Please create a detailed educational transcript that includes:\n            \n            1. INTRODUCTION\n               - Brief overview of the topic\n               - Learning objectives\n            \n            2. MAIN CONTENT\n               - Comprehensive coverage of the topic\n               - Key concepts and definitions\n               - Important points and explanations\n               - Examples where applicable\n            \n            3. KEY TAKEAWAYS\n               - Summary of main points\n               - Important concepts to remember\n            \n            4. ADDITIONAL RESOURCES\n               - Suggested topics for further study\n               - Related concepts to explore\n            \n            Format the transcript in a clear, professional manner with proper headings and structure.\n            Make it comprehensive enough to serve as standalone study material for students.\n            The transcript should be 800-1500 words to provide substantial educational value.\n            \"\"\"\n        \n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt\n        )\n        \n        if response.text:\n            logging.info(f\"Successfully generated transcript for video: {video_title[:50]}...\")\n            return response.text\n        else:\n            logging.warning(\"No AI response received for transcript generation\")\n            return f\"Transcript for: {video_title}\\n\\nUnable to generate detailed transcript at this time. Please try again later.\"\n            \n    except Exception as e:\n        logging.error(f\"Error generating video transcript: {e}\")\n        return f\"Transcript for: {video_title}\\n\\nError occurred while generating transcript. Please try again later.\"","size_bytes":14427},"replit.md":{"content":"# LearnNest - AI-Powered Learning Management System\n\n## Overview\n\nLearnNest is a comprehensive Learning Management System (LMS) built with Flask that enables online education through course management, real-time communication, and AI-powered features. The platform supports three user roles (Admin, Instructor, Student) with role-based access control and approval workflows.\n\nThe system facilitates course creation, enrollment management, content delivery (videos, documents), quiz creation with AI-powered grading, discussion forums, real-time messaging, and progress tracking. Integration with Google Gemini AI provides automated assignment grading, quiz generation, and intelligent feedback systems.\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Frontend Architecture\n\n**Template System**: Server-side rendering using Jinja2 templates with a modular structure:\n- Base template (`base.html`) provides common navigation, flash messaging, and Socket.IO initialization\n- Role-specific templates (admin/, instructor/, student/) extend the base for specialized dashboards\n- Component-based approach with reusable card styles, forms, buttons, and navigation elements\n\n**Design System**: Dark iOS-inspired aesthetic with:\n- CSS custom properties for consistent theming (--black, --gray-*, --primary, --success, etc.)\n- Gradient accents and glassmorphism effects for modern UI\n- Responsive grid layouts using CSS Grid and Flexbox\n- Mobile-first design patterns with breakpoints for different screen sizes\n\n**Real-time UI**: Socket.IO client-side integration for:\n- Live chat message updates\n- Real-time notifications\n- Discussion forum updates\n- User presence indicators\n\n### Backend Architecture\n\n**Web Framework**: Flask application with monolithic architecture in `app.py`:\n- All route handlers, business logic, and database operations in a single file\n- Decorator-based route protection using Flask-Login\n- Role-based access control through custom decorator functions\n- CSRF protection for form submissions\n\n**Authentication & Authorization**:\n- Session-based authentication via Flask-Login with UserMixin pattern\n- Password hashing using Werkzeug's `generate_password_hash` and `check_password_hash`\n- Role-based permissions: admin (full access), instructor (course management, requires approval), student (course enrollment)\n- Instructor approval workflow: new instructors must be approved by admin before accessing features\n\n**File Upload System**:\n- Secure filename handling using `werkzeug.utils.secure_filename`\n- Upload directory: `sir_rafique/uploads/` relative to application base\n- No file size limits configured (`MAX_CONTENT_LENGTH = None`)\n- Support for videos, documents, images via content_type classification\n\n**Real-time Communication**:\n- Flask-SocketIO with threading async mode for WebSocket connections\n- Room-based messaging for course discussions and direct messages\n- Event handlers for join_room, leave_room, message broadcasting\n- Thread-safe operations using Lock objects for concurrent updates\n\n### Data Storage\n\n**Database**: SQLite3 (file-based at `sir_rafique/learnnest.db`)\n- Direct SQL queries using sqlite3 module (no ORM)\n- Connection management with context managers\n- Key tables: users, courses, enrollments, assignments, quizzes, messages, notifications, forum_posts\n\n**Caching**: Flask-Caching with simple in-memory backend\n- Decorator-based caching for expensive operations\n- Cache invalidation on data updates\n\n**Session Storage**: Flask sessions with SECRET_KEY configuration\n- Environment variable `SESSION_SECRET` or fallback to development key\n- Cookie-based session management\n\n### AI Integration (Google Gemini)\n\n**Gemini AI Module** (`gemini_ai.py`):\n- Uses google-genai SDK (version 0.3.0) with lazy client initialization\n- Model: gemini-2.5-pro or gemini-2.5-flash\n- API key from environment variables: GEMINI_API_KEY or GOOGLE_GENAI_API_KEY\n\n**AI Features**:\n- Assignment grading with structured JSON responses (grade, percentage, feedback, suggestions)\n- Automatic quiz generation from prompts\n- MCQ auto-correction (AI detects correct answers without manual selection)\n- Study notes generation from video transcripts\n- Discussion forum response suggestions\n\n**Error Handling**: Lazy client initialization prevents crashes when API key is missing, allowing application to start without AI features\n\n## External Dependencies\n\n### Third-Party Services\n\n**Google Gemini AI**:\n- Purpose: Automated grading, quiz generation, content analysis\n- Integration: REST API via google-genai Python SDK\n- Authentication: API key-based\n- Note: Application functions without API key but AI features are disabled\n\n**YouTube Integration**:\n- Library: pytubefix (version 6.0.5)\n- Purpose: Video playlist management, transcript extraction\n- Used for course content delivery and AI note generation\n\n### Email Service\n\n**Flask-Mail**:\n- SMTP configuration for notifications (not fully configured in codebase)\n- Used for enrollment notifications, assignment submissions, grade notifications\n- Requires mail server configuration in production\n\n### Real-time Communication\n\n**Socket.IO**:\n- Client: CDN-hosted socket.io.min.js (version 4.5.4)\n- Server: Flask-SocketIO with python-socketio backend\n- CORS enabled for all origins (`cors_allowed_origins=\"*\"`)\n- Async mode: threading (supports concurrent connections)\n\n### PDF Generation\n\n**ReportLab**:\n- Purpose: Generate professional PDF documents (certificates, reports, notes)\n- Unicode font support: Noto Sans for Latin text, Noto Sans Arabic for RTL languages\n- Fonts directory: `static/fonts/`\n\n### Python Packages\n\nCore dependencies (requirements.txt):\n- Flask 2.3.0 - Web framework\n- Flask-Login 0.6.2 - User session management\n- Flask-SocketIO 5.3.4 - WebSocket support\n- Werkzeug 2.3.0 - Security utilities\n- google-genai 0.3.0 - Gemini AI integration\n- pytubefix 6.0.5 - YouTube video handling\n- reportlab 4.0.7 - PDF generation\n- python-dotenv 1.0.0 - Environment variable management\n\n### Static Assets\n\n**CDN Resources**:\n- Font Awesome 6.4.0 - Icon library\n- Socket.IO Client 4.5.4 - Real-time communication\n- Google Fonts (Inter family) - Typography\n\n### Development Tools\n\n**Environment Configuration**:\n- .env file for secrets (SESSION_SECRET, GEMINI_API_KEY, GOOGLE_GENAI_API_KEY)\n- Fallback values for development mode\n\n**File Structure**:\n- Multiple app instances across subdirectories (ghalib/, zsam/, LearnNestGemini/) suggest development/testing environments\n- Production deployment should consolidate to single application instance","size_bytes":6592},"static/css/dashboard.css":{"content":"/* iOS Dark Theme Variables - Override base.html vars for this page */\n:root {\n    /* iOS Dark Theme Colors */\n    --black: #000000;\n    --white: #ffffff;\n    --gray-100: #1c1c1e;\n    --gray-200: #2c2c2e;\n    --gray-300: #3a3a3c;\n    --gray-400: #48484a;\n    --gray-500: #636366;\n    --gray-600: #8e8e93;\n    \n    /* iOS Vibrant Accent Colors */\n    --primary: #0a84ff;\n    --success: #30d158;\n    --warning: #ff9f0a;\n    --danger: #ff453a;\n    --info: #64d2ff;\n    --purple: #bf5af2;\n    \n    /* Text Colors */\n    --text-primary: #ffffff;\n    --text-secondary: #ebebf5;\n    --text-light: #8e8e93;\n    \n    /* Background & Cards */\n    --background: var(--black);\n    --card-bg: #121212;\n    --card-hover: #1c1c1e;\n    --border: #2c2c2e;\n    \n    /* Shadows */\n    --shadow: 0 2px 8px rgba(0, 0, 0, 0.6);\n    --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.7);\n    --shadow-xl: 0 8px 32px rgba(0, 0, 0, 0.8);\n    \n    /* Gradients */\n    --gradient-primary: linear-gradient(135deg, #0a84ff 0%, #0066cc 100%);\n    --gradient-success: linear-gradient(135deg, #30d158 0%, #28a745 100%);\n    --gradient-warning: linear-gradient(135deg, #ff9f0a 0%, #ff8c00 100%);\n    --gradient-info: linear-gradient(135deg, #64d2ff 0%, #0891b2 100%);\n    \n    /* Border Radius */\n    --radius: 8px;\n    --radius-lg: 12px;\n    --radius-xl: 16px;\n}\n\n* {\n    box-sizing: border-box;\n    margin: 0;\n    padding: 0;\n}\n\nbody {\n    background: var(--black);\n    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', system-ui, sans-serif;\n    color: var(--text-primary);\n    line-height: 1.6;\n    min-height: 100vh;\n}\n\n/* Dashboard Layout */\n.dashboard-container {\n    max-width: 1400px;\n    margin: 0 auto;\n    padding: 2rem;\n    animation: fadeIn 0.8s ease-out;\n}\n\n@keyframes fadeIn {\n    from {\n        opacity: 0;\n        transform: translateY(20px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n.dashboard-header {\n    margin-bottom: 2.5rem;\n    background: var(--card-bg);\n    border-radius: var(--radius-xl);\n    padding: 2.5rem;\n    box-shadow: var(--shadow-lg);\n    border: 1px solid var(--border);\n    position: relative;\n    overflow: hidden;\n}\n\n.dashboard-header::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 3px;\n    background: var(--gradient-primary);\n    box-shadow: 0 0 10px var(--primary);\n}\n\n.welcome-section {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n}\n\n.welcome-content h1 {\n    margin-bottom: 0.75rem;\n    font-size: 2.5rem;\n    font-weight: 800;\n    background: var(--gradient-primary);\n    -webkit-background-clip: text;\n    -webkit-text-fill-color: transparent;\n    background-clip: text;\n    letter-spacing: -0.025em;\n}\n\n.welcome-message {\n    font-size: 1.2rem;\n    color: var(--text-secondary);\n    margin-bottom: 1.5rem;\n    font-weight: 500;\n}\n\n.date-badge {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.5rem;\n    background: var(--gray-100);\n    color: var(--text-secondary);\n    padding: 0.75rem 1.5rem;\n    border-radius: 1rem;\n    font-weight: 600;\n    font-size: 0.95rem;\n    border: 1px solid var(--border);\n    backdrop-filter: blur(10px);\n}\n\n.user-avatar {\n    display: flex;\n    align-items: center;\n}\n\n.avatar-container {\n    width: 90px;\n    height: 90px;\n    border-radius: 50%;\n    background: var(--gradient-primary);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 2.5rem;\n    border: 4px solid var(--primary);\n    box-shadow: var(--shadow-xl);\n    transition: transform 0.3s ease, box-shadow 0.3s ease;\n}\n\n.avatar-container:hover {\n    transform: scale(1.05);\n    box-shadow: var(--shadow-2xl);\n}\n\n/* Stats Grid */\n.stats-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));\n    gap: 1.75rem;\n    margin-bottom: 3rem;\n}\n\n.stat-card {\n    background: var(--card-bg);\n    border-radius: 1.25rem;\n    padding: 2rem;\n    display: flex;\n    align-items: center;\n    gap: 1.25rem;\n    box-shadow: var(--shadow-md);\n    border: 1px solid var(--border);\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n    overflow: hidden;\n}\n\n.stat-card::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 3px;\n    opacity: 0;\n    transition: opacity 0.3s ease;\n}\n\n.stat-card:hover {\n    box-shadow: var(--shadow-xl);\n    transform: translateY(-8px);\n    border-color: var(--gray-300);\n}\n\n.stat-card:hover::before {\n    opacity: 1;\n}\n\n.stat-primary::before { background: var(--gradient-primary); }\n.stat-success::before { background: var(--gradient-success); }\n.stat-warning::before { background: var(--gradient-warning); }\n.stat-info::before { background: var(--gradient-info); }\n\n.stat-icon {\n    width: 70px;\n    height: 70px;\n    border-radius: 1rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1.75rem;\n    flex-shrink: 0;\n    transition: transform 0.3s ease;\n}\n\n.stat-card:hover .stat-icon {\n    transform: scale(1.1);\n}\n\n.stat-primary .stat-icon { \n    background: rgba(10, 132, 255, 0.15);\n    color: var(--primary);\n    border: 1px solid rgba(10, 132, 255, 0.3);\n}\n.stat-success .stat-icon { \n    background: rgba(48, 209, 88, 0.15);\n    color: var(--success);\n    border: 1px solid rgba(48, 209, 88, 0.3);\n}\n.stat-warning .stat-icon { \n    background: rgba(255, 159, 10, 0.15);\n    color: var(--warning);\n    border: 1px solid rgba(255, 159, 10, 0.3);\n}\n.stat-info .stat-icon { \n    background: rgba(100, 210, 255, 0.15);\n    color: var(--info);\n    border: 1px solid rgba(100, 210, 255, 0.3);\n}\n\n.stat-content {\n    flex: 1;\n}\n\n.stat-number {\n    display: block;\n    font-size: 2.5rem;\n    font-weight: 900;\n    line-height: 1;\n    margin-bottom: 0.5rem;\n    color: var(--text-primary);\n    letter-spacing: -0.025em;\n}\n\n.stat-label {\n    color: var(--text-secondary);\n    font-weight: 600;\n    font-size: 0.95rem;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n}\n\n/* Dashboard Grid */\n.dashboard-grid {\n    display: grid;\n    grid-template-columns: 2fr 1fr;\n    gap: 2.5rem;\n    align-items: start;\n}\n\n/* Cards */\n.card {\n    background: var(--card-bg);\n    border-radius: 1.5rem;\n    box-shadow: var(--shadow-md);\n    border: 1px solid var(--border);\n    overflow: hidden;\n    display: flex;\n    flex-direction: column;\n    height: fit-content;\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n}\n\n.card::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 4px;\n    background: var(--gradient-primary);\n    opacity: 0;\n    transition: opacity 0.3s ease;\n}\n\n.card:hover::before {\n    opacity: 1;\n}\n\n.card:hover {\n    box-shadow: var(--shadow-xl);\n    transform: translateY(-4px);\n}\n\n.card-highlight {\n    border-left: 6px solid var(--primary);\n}\n\n.card-header {\n    padding: 2rem;\n    border-bottom: 1px solid var(--border);\n    background: var(--gray-100);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    flex-wrap: wrap;\n    gap: 1rem;\n}\n\n.card-title {\n    margin: 0;\n    font-size: 1.5rem;\n    color: var(--text-primary);\n    font-weight: 700;\n    letter-spacing: -0.025em;\n}\n\n.header-actions {\n    display: flex;\n    gap: 0.75rem;\n}\n\n.card-content {\n    padding: 2rem;\n    flex: 1;\n}\n\n/* Course Items */\n.course-list {\n    display: flex;\n    flex-direction: column;\n    gap: 1.25rem;\n}\n\n.course-item {\n    border: 1px solid var(--border);\n    border-radius: var(--radius-lg);\n    padding: 1.5rem;\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    display: flex;\n    gap: 1.25rem;\n    align-items: flex-start;\n    background: var(--card-bg);\n    position: relative;\n    overflow: hidden;\n}\n\n.course-item::before {\n    content: '';\n    position: absolute;\n    left: 0;\n    top: 0;\n    bottom: 0;\n    width: 4px;\n    transition: all 0.3s ease;\n}\n\n.course-item:hover {\n    box-shadow: var(--shadow-lg);\n    transform: translateY(-4px);\n    border-color: var(--gray-300);\n}\n\n.course-item.pending::before {\n    background: var(--warning);\n}\n\n.course-item.active::before {\n    background: var(--success);\n}\n\n.course-item.pending {\n    background: var(--card-bg);\n    border-color: var(--warning);\n}\n\n.course-item.active {\n    background: var(--card-bg);\n    border-color: var(--success);\n}\n\n.course-badge {\n    width: 60px;\n    height: 60px;\n    border-radius: 0.75rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1.5rem;\n    flex-shrink: 0;\n    transition: all 0.3s ease;\n}\n\n.course-item:hover .course-badge {\n    transform: scale(1.1);\n}\n\n.course-item.active .course-badge { \n    background: var(--gradient-success);\n    animation: pulse 2s infinite;\n}\n.course-item.pending .course-badge { \n    background: var(--gradient-warning);\n}\n\n.course-content {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    gap: 1rem;\n}\n\n.course-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: flex-start;\n    flex-wrap: wrap;\n    gap: 0.75rem;\n}\n\n.course-header h4 {\n    margin: 0;\n    color: var(--text-primary);\n    flex: 1;\n    min-width: 250px;\n    font-weight: 700;\n    font-size: 1.2rem;\n    line-height: 1.4;\n}\n\n.course-meta {\n    display: flex;\n    gap: 1rem;\n    align-items: center;\n    flex-wrap: wrap;\n}\n\n.course-code {\n    background: var(--gray-200);\n    padding: 0.5rem 1rem;\n    border-radius: var(--radius);\n    font-size: 0.85rem;\n    color: var(--text-secondary);\n    font-weight: 600;\n    border: 1px solid var(--border);\n    font-family: 'Monaco', 'Consolas', monospace;\n}\n\n.status-badge {\n    padding: 0.5rem 1rem;\n    border-radius: 1.25rem;\n    font-size: 0.85rem;\n    font-weight: 700;\n    white-space: nowrap;\n    border: 1px solid;\n}\n\n.status-badge.approved {\n    background-color: #d1fae5;\n    color: #065f46;\n    border-color: #a7f3d0;\n}\n\n.status-badge.pending {\n    background-color: #fef3c7;\n    color: #92400e;\n    border-color: #fde68a;\n}\n\n.course-details {\n    display: flex;\n    flex-direction: column;\n    gap: 1rem;\n}\n\n.instructor, .enrolled-date {\n    margin: 0;\n    color: var(--text-secondary);\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    font-size: 0.95rem;\n    font-weight: 500;\n}\n\n/* Learning Status - iOS Dark Theme */\n.learning-status {\n    background: linear-gradient(135deg, rgba(48, 209, 88, 0.08) 0%, rgba(10, 132, 255, 0.08) 100%);\n    padding: 1.5rem;\n    border-radius: var(--radius-lg);\n    border: 1px solid var(--border);\n    margin: 1rem 0;\n    box-shadow: var(--shadow);\n    position: relative;\n    overflow: hidden;\n}\n\n.status-badge-container {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n    padding: 1rem 0;\n}\n\n.pulse-ring {\n    position: absolute;\n    width: 80px;\n    height: 80px;\n    border: 2px solid var(--success);\n    border-radius: 50%;\n    animation: pulseRing 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;\n    opacity: 0;\n}\n\n.pulse-ring.delay-1 {\n    animation-delay: 0.5s;\n}\n\n.pulse-ring.delay-2 {\n    animation-delay: 1s;\n}\n\n@keyframes pulseRing {\n    0% {\n        transform: scale(0.5);\n        opacity: 1;\n    }\n    100% {\n        transform: scale(1.3);\n        opacity: 0;\n    }\n}\n\n.status-badge {\n    display: flex;\n    align-items: center;\n    gap: 0.75rem;\n    background: linear-gradient(135deg, var(--success) 0%, #28a745 100%);\n    padding: 0.75rem 1.5rem;\n    border-radius: 50px;\n    box-shadow: 0 0 30px rgba(48, 209, 88, 0.6), \n                0 4px 12px rgba(48, 209, 88, 0.4);\n    position: relative;\n    z-index: 2;\n    animation: statusFloat 3s ease-in-out infinite;\n}\n\n.badge-icon {\n    font-size: 1.25rem;\n    animation: rotateIcon 4s linear infinite;\n}\n\n.badge-text {\n    font-size: 0.95rem;\n    font-weight: 700;\n    color: #000000;\n    letter-spacing: 0.5px;\n}\n\n@keyframes statusFloat {\n    0%, 100% {\n        transform: translateY(0);\n    }\n    50% {\n        transform: translateY(-5px);\n    }\n}\n\n@keyframes rotateIcon {\n    0%, 90% {\n        transform: rotate(0deg);\n    }\n    95% {\n        transform: rotate(-10deg);\n    }\n    100% {\n        transform: rotate(0deg);\n    }\n}\n\n.learning-bars {\n    display: flex;\n    gap: 8px;\n    justify-content: center;\n    align-items: flex-end;\n    height: 40px;\n    margin-top: 1rem;\n}\n\n.learning-bars .bar {\n    width: 6px;\n    background: linear-gradient(180deg, var(--primary) 0%, var(--success) 100%);\n    border-radius: 3px;\n    animation: barWave 1.2s ease-in-out infinite;\n    box-shadow: 0 0 10px rgba(10, 132, 255, 0.5);\n}\n\n.learning-bars .bar:nth-child(1) {\n    animation-delay: 0s;\n}\n\n.learning-bars .bar:nth-child(2) {\n    animation-delay: 0.1s;\n}\n\n.learning-bars .bar:nth-child(3) {\n    animation-delay: 0.2s;\n}\n\n.learning-bars .bar:nth-child(4) {\n    animation-delay: 0.3s;\n}\n\n.learning-bars .bar:nth-child(5) {\n    animation-delay: 0.4s;\n}\n\n@keyframes barWave {\n    0%, 100% {\n        height: 15px;\n        opacity: 0.5;\n    }\n    50% {\n        height: 35px;\n        opacity: 1;\n    }\n}\n\n.course-actions {\n    display: flex;\n    gap: 0.75rem;\n    flex-wrap: wrap;\n}\n\n.pending-notice {\n    color: var(--warning);\n    font-size: 0.95rem;\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    font-weight: 500;\n    font-style: italic;\n}\n\n/* Discover Courses */\n.discover-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n    gap: 1.25rem;\n}\n\n.discover-item {\n    background: var(--card-bg);\n    border: 1px solid var(--border);\n    border-radius: var(--radius-lg);\n    padding: 1.5rem;\n    display: flex;\n    align-items: center;\n    gap: 1.25rem;\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n    overflow: hidden;\n}\n\n.discover-item::before {\n    content: '';\n    position: absolute;\n    left: 0;\n    top: 0;\n    bottom: 0;\n    width: 3px;\n    background: var(--gradient-primary);\n    opacity: 0;\n    transition: opacity 0.3s ease;\n}\n\n.discover-item:hover::before {\n    opacity: 1;\n}\n\n.discover-item:hover {\n    box-shadow: var(--shadow-lg);\n    transform: translateY(-4px);\n    border-color: var(--gray-300);\n}\n\n.discover-icon {\n    width: 50px;\n    height: 50px;\n    border-radius: 0.75rem;\n    background: var(--gradient-primary);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1.25rem;\n    flex-shrink: 0;\n    transition: transform 0.3s ease;\n}\n\n.discover-item:hover .discover-icon {\n    transform: scale(1.1) rotate(5deg);\n}\n\n.discover-content {\n    flex: 1;\n    min-width: 0;\n}\n\n.discover-content h4 {\n    margin: 0 0 0.5rem 0;\n    font-size: 1.1rem;\n    font-weight: 700;\n    color: var(--text-primary);\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    line-height: 1.4;\n}\n\n.discover-instructor {\n    margin: 0 0 0.75rem 0;\n    font-size: 0.9rem;\n    color: var(--text-light);\n    display: flex;\n    align-items: center;\n    gap: 0.25rem;\n    font-weight: 500;\n}\n\n.discover-meta {\n    display: flex;\n    gap: 0.75rem;\n    align-items: center;\n    flex-wrap: wrap;\n}\n\n.discover-code {\n    background: var(--gray-100);\n    padding: 0.375rem 0.75rem;\n    border-radius: 0.5rem;\n    font-size: 0.8rem;\n    color: var(--text-secondary);\n    font-weight: 600;\n    border: 1px solid var(--border);\n    font-family: 'Monaco', 'Consolas', monospace;\n}\n\n.discover-category {\n    background: var(--gray-200);\n    padding: 0.375rem 0.75rem;\n    border-radius: 0.5rem;\n    font-size: 0.8rem;\n    color: var(--text-secondary);\n    font-weight: 600;\n}\n\n.discover-actions {\n    display: flex;\n    gap: 0.5rem;\n    flex-shrink: 0;\n}\n\n.btn-enroll, .btn-info {\n    width: 42px;\n    height: 42px;\n    border-radius: 0.75rem;\n    border: none;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1rem;\n    cursor: pointer;\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    position: relative;\n    overflow: hidden;\n}\n\n.btn-enroll::before, .btn-info::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: -100%;\n    width: 100%;\n    height: 100%;\n    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);\n    transition: left 0.5s;\n}\n\n.btn-enroll:hover::before, .btn-info:hover::before {\n    left: 100%;\n}\n\n.btn-enroll {\n    background: var(--gradient-primary);\n    color: white;\n}\n\n.btn-enroll:hover {\n    transform: scale(1.1);\n    box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);\n}\n\n.btn-info {\n    background: var(--gray-200);\n    color: var(--text-primary);\n}\n\n.btn-info:hover {\n    background: var(--gray-300);\n    transform: scale(1.1);\n}\n\n.view-all-section {\n    text-align: center;\n    padding-top: 2rem;\n    margin-top: 1.5rem;\n    border-top: 1px solid var(--border);\n}\n\n/* Empty States */\n.empty-state {\n    text-align: center;\n    padding: 3rem 2rem;\n    color: var(--text-secondary);\n}\n\n.empty-icon {\n    margin-bottom: 1.5rem;\n    font-size: 3rem;\n    opacity: 0.7;\n}\n\n.empty-state h3 {\n    color: var(--text-primary);\n    margin-bottom: 1rem;\n    font-weight: 700;\n    font-size: 1.5rem;\n}\n\n.empty-state p {\n    margin-bottom: 2rem;\n    max-width: 300px;\n    margin-left: auto;\n    margin-right: auto;\n    line-height: 1.6;\n    font-size: 1.05rem;\n}\n\n/* Buttons */\n.btn {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.875rem 1.5rem;\n    border-radius: 0.75rem;\n    font-weight: 600;\n    text-decoration: none;\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    border: none;\n    cursor: pointer;\n    font-size: 0.95rem;\n    white-space: nowrap;\n    justify-content: center;\n    position: relative;\n    overflow: hidden;\n}\n\n.btn::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: -100%;\n    width: 100%;\n    height: 100%;\n    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);\n    transition: left 0.5s;\n}\n\n.btn:hover::before {\n    left: 100%;\n}\n\n.btn-sm {\n    padding: 0.75rem 1.25rem;\n    font-size: 0.9rem;\n}\n\n.btn-primary {\n    background: var(--gradient-primary);\n    color: white;\n}\n\n.btn-primary:hover {\n    transform: translateY(-2px);\n    box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);\n}\n\n.btn-secondary {\n    background: var(--gray-600);\n    color: white;\n}\n\n.btn-secondary:hover {\n    background: var(--gray-700);\n    transform: translateY(-2px);\n    box-shadow: var(--shadow-md);\n}\n\n.btn-success {\n    background: var(--gradient-success);\n    color: white;\n}\n\n.btn-success:hover {\n    transform: translateY(-2px);\n    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);\n}\n\n.btn-outline {\n    background: transparent;\n    color: var(--text-primary);\n    border: 1px solid var(--border);\n}\n\n.btn-outline:hover {\n    background: var(--gray-50);\n    transform: translateY(-2px);\n    box-shadow: var(--shadow-sm);\n    border-color: var(--gray-300);\n}\n\n/* Animations */\n@keyframes pulse {\n    0% {\n        transform: scale(0.95);\n        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);\n    }\n    \n    70% {\n        transform: scale(1);\n        box-shadow: 0 0 0 12px rgba(16, 185, 129, 0);\n    }\n    \n    100% {\n        transform: scale(0.95);\n        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);\n    }\n}\n\n@keyframes shine {\n    0% {\n        left: -100%;\n    }\n    100% {\n        left: 100%;\n    }\n}\n\n@keyframes progress-glow {\n    0% {\n        box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);\n    }\n    50% {\n        box-shadow: 0 0 20px rgba(16, 185, 129, 0.8);\n    }\n    100% {\n        box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);\n    }\n}\n\n/* Modal Styling */\n.modal {\n    display: none;\n    position: fixed;\n    z-index: 1000;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 100%;\n    background-color: rgba(0, 0, 0, 0.6);\n    backdrop-filter: blur(8px);\n}\n\n.modal-content {\n    background-color: var(--card-bg);\n    margin: 10% auto;\n    padding: 0;\n    border-radius: var(--radius-xl);\n    width: 90%;\n    max-width: 500px;\n    box-shadow: var(--shadow-xl);\n    overflow: hidden;\n    border: 1px solid var(--border);\n    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n@keyframes modalSlideIn {\n    from {\n        opacity: 0;\n        transform: translateY(-60px) scale(0.9);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0) scale(1);\n    }\n}\n\n.modal-header {\n    padding: 2rem;\n    border-bottom: 1px solid var(--border);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    background: var(--gradient-primary);\n    color: var(--white);\n}\n\n.modal-header h3 {\n    margin: 0;\n    font-weight: 700;\n    font-size: 1.5rem;\n}\n\n.close {\n    color: white;\n    font-size: 28px;\n    font-weight: bold;\n    cursor: pointer;\n    line-height: 1;\n    transition: transform 0.2s ease;\n    width: 32px;\n    height: 32px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: 50%;\n}\n\n.close:hover {\n    transform: scale(1.1);\n    background: rgba(255,255,255,0.1);\n}\n\n.modal-body {\n    padding: 2.5rem;\n}\n\n.course-info-display {\n    margin-bottom: 2rem;\n    padding-bottom: 2rem;\n    border-bottom: 1px solid var(--border-light);\n}\n\n.course-info-display h4 {\n    margin: 0 0 0.75rem 0;\n    color: var(--text-primary);\n    font-weight: 700;\n    font-size: 1.3rem;\n}\n\n.course-info-display span {\n    color: var(--text-secondary);\n    font-size: 1rem;\n    font-weight: 500;\n}\n\n.form-group {\n    margin-bottom: 2rem;\n}\n\n.form-group label {\n    display: block;\n    margin-bottom: 0.75rem;\n    font-weight: 600;\n    color: var(--text-primary);\n    font-size: 1rem;\n}\n\n.form-group input {\n    width: 100%;\n    padding: 1rem 1.25rem;\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    font-size: 1rem;\n    box-sizing: border-box;\n    background: var(--gray-200);\n    color: var(--text-primary);\n    transition: all 0.3s ease;\n    font-family: inherit;\n}\n\n.form-group input:focus {\n    outline: none;\n    border-color: var(--primary);\n    background: var(--gray-300);\n    box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);\n    transform: translateY(-1px);\n}\n\n.modal-actions {\n    display: flex;\n    gap: 1rem;\n    justify-content: center;\n    margin-top: 2.5rem;\n}\n\n/* Responsive Design */\n@media (max-width: 1200px) {\n    .dashboard-grid {\n        grid-template-columns: 1fr;\n    }\n    \n    .stats-grid {\n        grid-template-columns: repeat(2, 1fr);\n    }\n}\n\n@media (max-width: 768px) {\n    .dashboard-container {\n        padding: 1.25rem;\n    }\n    \n    .dashboard-header {\n        padding: 2rem;\n    }\n    \n    .welcome-section {\n        flex-direction: column;\n        text-align: center;\n        gap: 1.5rem;\n    }\n    \n    .welcome-content h1 {\n        font-size: 2rem;\n    }\n    \n    .avatar-container {\n        width: 70px;\n        height: 70px;\n        font-size: 2rem;\n    }\n    \n    .stats-grid {\n        grid-template-columns: 1fr;\n        gap: 1.25rem;\n    }\n    \n    .stat-card {\n        padding: 1.75rem;\n    }\n    \n    .card-header {\n        flex-direction: column;\n        align-items: flex-start;\n        gap: 1rem;\n    }\n    \n    .course-header {\n        flex-direction: column;\n        align-items: flex-start;\n        gap: 1rem;\n    }\n    \n    .course-header h4 {\n        min-width: auto;\n    }\n    \n    .course-item {\n        flex-direction: column;\n        text-align: center;\n        gap: 1.25rem;\n    }\n    \n    .course-badge {\n        align-self: center;\n    }\n    \n    .discover-grid {\n        grid-template-columns: 1fr;\n    }\n    \n    .discover-item {\n        flex-direction: column;\n        text-align: center;\n        gap: 1.25rem;\n    }\n    \n    .discover-actions {\n        align-self: stretch;\n        justify-content: center;\n    }\n    \n    .modal-content {\n        width: 95%;\n        margin: 5% auto;\n    }\n    \n    .modal-body {\n        padding: 2rem;\n    }\n    \n    .modal-actions {\n        flex-direction: column;\n    }\n}\n\n@media (max-width: 480px) {\n    .dashboard-header h1 {\n        font-size: 1.75rem;\n    }\n    \n    .card-content {\n        padding: 1.5rem;\n    }\n    \n    .course-item {\n        padding: 1.25rem;\n    }\n    \n    .course-actions {\n        flex-direction: column;\n        align-items: stretch;\n    }\n    \n    .modal-header {\n        padding: 1.5rem;\n    }\n    \n    .modal-body {\n        padding: 1.5rem;\n    }\n    \n    .stat-number {\n        font-size: 2rem;\n    }\n    \n    .stat-icon {\n        width: 60px;\n        height: 60px;\n        font-size: 1.5rem;\n    }\n    \n    .btn {\n        padding: 0.75rem 1.25rem;\n        font-size: 0.9rem;\n    }\n}\n</style>\n\n<!-- Enrollment Modal -->\n<div id=\"enrollmentModal\" class=\"modal\">\n    <div class=\"modal-content\">\n        <div class=\"modal-header\">\n            <h3>Enroll in Course</h3>\n            <span class=\"close\" onclick=\"closeEnrollmentModal()\">&times;</span>\n        </div>\n        <div class=\"modal-body\">\n            <div class=\"course-info-display\">\n                <h4 id=\"modalCourseTitle\"></h4>\n                <span id=\"modalCourseCode\"></span>\n            </div>\n            <form method=\"POST\" action=\"{{ url_for('student_enroll') }}\" id=\"modalEnrollForm\">\n                <input type=\"hidden\" name=\"csrf_token\" value=\"{{ csrf_token }}\">\n                <input type=\"hidden\" id=\"modalCourseCodeInput\" name=\"course_code\">\n                <div class=\"form-group\">\n                    <label for=\"modalEnrollmentKey\">Enrollment Key</label>\n                    <input type=\"password\" \n                           id=\"modalEnrollmentKey\" \n                           name=\"enrollment_key\" \n                           required\n                           placeholder=\"Enter the enrollment key provided by your instructor\">\n                    <small style=\"color: var(--text-light); margin-top: 0.5rem; display: block; font-size: 0.8rem;\">\n                        Get the enrollment key from your instructor to complete enrollment.\n                    </small>\n                </div>\n                <div class=\"modal-actions\">\n                    <button type=\"submit\" class=\"btn btn-primary\">\n                        Confirm Enrollment\n                    </button>\n                    <button type=\"button\" class=\"btn btn-outline\" onclick=\"closeEnrollmentModal()\">\n                        Cancel\n                    </button>\n                </div>\n            </form>\n        </div>\n    </div>\n</div>\n\n<script>\nfunction enrollInCourse(courseCode, courseTitle) {\n    document.getElementById('modalCourseTitle').textContent = courseTitle;\n    document.getElementById('modalCourseCode').textContent = courseCode;\n    document.getElementById('modalCourseCodeInput').value = courseCode;\n    document.getElementById('modalEnrollmentKey').value = '';\n    document.getElementById('enrollmentModal').style.display = 'block';\n    document.getElementById('modalEnrollmentKey').focus();\n}\n\nfunction closeEnrollmentModal() {\n    document.getElementById('enrollmentModal').style.display = 'none';\n}\n\nfunction viewCourseDetails(courseId) {\n    window.location.href = '{{ url_for(\"student_browse_courses\") }}#course-' + courseId;\n}\n\n// Set current date\ndocument.addEventListener('DOMContentLoaded', function() {\n    const now = new Date();\n    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };\n    document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);\n    \n    // Initialize progress animations\n    initializeProgressAnimations();\n});\n\n// Function to initialize progress animations\nfunction initializeProgressAnimations() {\n    const progressBars = document.querySelectorAll('.progress-fill');\n    \n    progressBars.forEach(bar => {\n        // Add a slight delay to make the animation more noticeable\n        setTimeout(() => {\n            const width = bar.style.width;\n            bar.style.width = '0%';\n            \n            // Animate to the actual width\n            setTimeout(() => {\n                bar.style.width = width;\n            }, 300);\n        }, 500);\n    });\n}\n\n// Function to simulate progress update\nfunction simulateProgressUpdate(courseCode, newProgress) {\n    const courseItems = document.querySelectorAll('.course-item');\n    \n    courseItems.forEach(item => {\n        const codeElement = item.querySelector('.course-code');\n        if (codeElement && codeElement.textContent === courseCode) {\n            const progressFill = item.querySelector('.progress-fill');\n            const progressPercentage = item.querySelector('.progress-percentage');\n            \n            if (progressFill) {\n                progressFill.style.width = `${newProgress}%`;\n                \n                // Add a glow effect\n                progressFill.style.animation = 'progress-glow 1s ease';\n                \n                // Remove animation after it completes\n                setTimeout(() => {\n                    progressFill.style.animation = '';\n                }, 1000);\n            }\n        }\n    });\n}\n\n// Close modal when clicking outside\nwindow.addEventListener('click', function(event) {\n    const modal = document.getElementById('enrollmentModal');\n    if (event.target === modal) {\n        closeEnrollmentModal();\n    }\n});\n\n// Close modal on escape key\ndocument.addEventListener('keydown', function(event) {\n    if (event.key === 'Escape') {\n        closeEnrollmentModal();\n    }\n});\n\n// Demo function to show progress animation (remove in production)\nfunction demoProgressAnimation() {\n    setTimeout(() => {\n        simulateProgressUpdate('CS101', 75);\n    }, 2000);\n    \n    setTimeout(() => {\n        simulateProgressUpdate('MATH201', 45);\n    }, 4000);\n}\n\n// Initialize demo on page load (remove in production)\ndocument.addEventListener('DOMContentLoaded', function() {\n    // Uncomment the line below to see demo progress animations\n    // demoProgressAnimation();\n});\n</script>\n","size_bytes":29854},"LearnNestGemini/weather-app-abdulwaheed/app.py":{"content":"import os\nimport sqlite3\nimport logging\nfrom datetime import datetime, timedelta\nfrom functools import wraps\nfrom werkzeug.security import generate_password_hash, check_password_hash\nfrom werkzeug.utils import secure_filename\nfrom flask import Flask, render_template, request, redirect, url_for, flash, jsonify, session, send_from_directory, send_file\nfrom flask_login import LoginManager, UserMixin, login_user, login_required, logout_user, current_user\nfrom flask_socketio import SocketIO, emit, join_room, leave_room, rooms\nfrom flask_caching import Cache\nfrom flask_mail import Mail, Message\nfrom threading import Lock\nimport json\nimport uuid\nfrom dotenv import load_dotenv\nimport gemini_ai\nfrom pytubefix import YouTube\nimport shutil\n\n# Load environment variables\nload_dotenv()\n\n# Initialize Flask app\napp = Flask(__name__)\napp.config['SECRET_KEY'] = os.environ.get('SESSION_SECRET') or 'dev-secret-key-change-in-production'\n# Use paths relative to the app file location\nBASE_DIR = os.path.dirname(os.path.abspath(__file__))\napp.config['UPLOAD_FOLDER'] = os.path.join(BASE_DIR, 'sir_rafique', 'uploads')\napp.config['MAX_CONTENT_LENGTH'] = None  # No file size limit for videos\n\n# Database configuration\nDATABASE = os.path.join(BASE_DIR, 'sir_rafique', 'learnnest.db')\n\n# Initialize extensions\nlogin_manager = LoginManager()\nlogin_manager.init_app(app)\nlogin_manager.login_view = 'login'  # type: ignore\nlogin_manager.login_message = 'Please log in to access this page.'\n\nsocketio = SocketIO(app, cors_allowed_origins=\"*\", async_mode='threading')\n\n# Initialize caching\ncache = Cache(app, config={'CACHE_TYPE': 'simple'})\n\n# Initialize mail\nmail = Mail(app)\n\n# Register custom Jinja filters and globals\n@app.template_filter('nl2br')\ndef nl2br_filter(s):\n    \"\"\"Convert newlines to HTML line breaks\"\"\"\n    if s is None:\n        return ''\n    return str(s).replace('\\n', '<br>\\n')\n\n# Add custom Jinja2 global functions\n@app.template_global()\ndef max_func(*args):\n    \"\"\"Max function for Jinja2 templates\"\"\"\n    return max(args)\n\n@app.template_global()\ndef min_func(*args):\n    \"\"\"Min function for Jinja2 templates\"\"\"\n    return min(args)\n\n# CSRF protection helpers\nimport secrets\nimport hashlib\n\ndef generate_csrf_token():\n    \"\"\"Generate a CSRF token for forms\"\"\"\n    token = secrets.token_urlsafe(32)\n    session['csrf_token'] = token\n    return token\n\ndef validate_csrf_token(token):\n    \"\"\"Validate CSRF token\"\"\"\n    if not token or token != session.get('csrf_token'):\n        return False\n    return True\n\n@app.context_processor\ndef inject_csrf_token():\n    \"\"\"Make CSRF token available in all templates\"\"\"\n    if 'csrf_token' not in session:\n        session['csrf_token'] = secrets.token_urlsafe(32)\n    return dict(csrf_token=session['csrf_token'])\n\n# Thread lock for database operations\ndb_lock = Lock()\n\n# Create uploads directory\nos.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'assignments'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'resources'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'payments'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'instructor_screenshots'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'transcripts'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'chat_files'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'chat_images'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'direct_messages'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'forum_media'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'profile_pictures'), exist_ok=True)\n\n# File size limits (in bytes)\nMAX_CHAT_FILE_SIZE = 100 * 1024 * 1024  # 100 MB per file\nMAX_TOTAL_STORAGE_PER_USER = 5 * 1024 * 1024 * 1024  # 5 GB per user\nALLOWED_FILE_TYPES = {\n    'pdf', 'doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx', 'txt', \n    'jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg',\n    'zip', 'rar', '7z', 'tar', 'gz',\n    'mp4', 'mov', 'avi', 'mkv', 'webm', 'flv',\n    'mp3', 'wav', 'ogg', 'm4a',\n    'csv', 'json', 'xml', 'html', 'css', 'js', 'py', 'java', 'cpp', 'c', 'h'\n}\n\n# Database connection helper\ndef get_db_connection():\n    conn = sqlite3.connect(DATABASE, timeout=30)\n    conn.execute('PRAGMA journal_mode=WAL;')\n    conn.execute('PRAGMA synchronous=NORMAL;')\n    conn.execute('PRAGMA cache_size=10000;')\n    conn.execute('PRAGMA temp_store=MEMORY;')\n    conn.row_factory = sqlite3.Row\n    return conn\n\ndef send_notification(user_id, title, message, notification_type='info', related_id=None):\n    \"\"\"Helper function to send notifications to students\"\"\"\n    try:\n        conn = get_db_connection()\n        conn.execute('''\n            INSERT INTO notifications (user_id, title, message, type, related_id, created_at)\n            VALUES (?, ?, ?, ?, ?, ?)\n        ''', (user_id, title, message, notification_type, related_id, datetime.now()))\n        conn.commit()\n        conn.close()\n        \n        # Emit real-time notification via SocketIO\n        socketio.emit('notification', {\n            'title': title,\n            'message': message,\n            'type': notification_type\n        }, to=f'user_{user_id}')\n        \n        return True\n    except Exception as e:\n        logging.error(f\"Error sending notification: {e}\")\n        return False\n\ndef update_student_progress(conn, student_id, course_id):\n    \"\"\"\n    Calculate and update student progress for a course based on quiz completions\n    Progress = (Number of Submitted Quizzes / Total Quizzes) * 100\n    Note: If manual_progress_override is set by instructor, automatic progress is still calculated and stored\n          but the manual override value takes precedence for display\n    \"\"\"\n    try:\n        # Check if instructor has set manual progress override\n        enrollment = conn.execute('''\n            SELECT manual_progress_override\n            FROM enrollments\n            WHERE student_id = ? AND course_id = ?\n        ''', (student_id, course_id)).fetchone()\n        \n        has_manual_override = enrollment and enrollment['manual_progress_override'] is not None\n        \n        # Get total number of quizzes for this course\n        total_quizzes = conn.execute('''\n            SELECT COUNT(*) as count\n            FROM assignments\n            WHERE course_id = ? AND assignment_type = 'quiz' AND is_active = 1\n        ''', (course_id,)).fetchone()['count']\n        \n        if total_quizzes == 0:\n            # No quizzes, set progress to 0\n            auto_progress = 0\n        else:\n            # Get number of submitted quizzes by student\n            submitted_quizzes = conn.execute('''\n                SELECT COUNT(DISTINCT a.id) as count\n                FROM assignments a\n                INNER JOIN assignment_submissions sub ON a.id = sub.assignment_id\n                WHERE a.course_id = ? \n                AND a.assignment_type = 'quiz'\n                AND a.is_active = 1\n                AND sub.student_id = ?\n            ''', (course_id, student_id)).fetchone()['count']\n            \n            # Calculate progress percentage\n            auto_progress = (submitted_quizzes / total_quizzes) * 100\n        \n        # Always update progress_percentage with automatic calculation\n        # This keeps it in sync even when manual override is active\n        conn.execute('''\n            UPDATE enrollments\n            SET progress_percentage = ?\n            WHERE student_id = ? AND course_id = ?\n        ''', (auto_progress, student_id, course_id))\n        \n        conn.commit()\n        \n        # Return manual override if set, otherwise return automatic progress\n        if has_manual_override:\n            return enrollment['manual_progress_override']\n        else:\n            return auto_progress\n        \n    except Exception as e:\n        print(f\"Error updating student progress: {e}\")\n        return 0\n\n# User class for Flask-Login\nclass User(UserMixin):\n    def __init__(self, id, username, email, role, full_name, created_at, active_status=True, \n                 instructor_approval_status='approved', approved_by=None, approved_at=None, profile_picture=None):\n        self.id = id\n        self.username = username\n        self.email = email\n        self.role = role\n        self.full_name = full_name\n        self.created_at = created_at\n        self._is_active = active_status\n        self.instructor_approval_status = instructor_approval_status\n        self.approved_by = approved_by\n        self.approved_at = approved_at\n        self.profile_picture = profile_picture\n\n    def get_id(self):\n        return str(self.id)\n\n    def is_admin(self):\n        return self.role == 'admin'\n    \n    def is_instructor(self):\n        return self.role == 'instructor'\n    \n    def is_student(self):\n        return self.role == 'student'\n    \n    def is_instructor_approved(self):\n        \"\"\"Check if instructor is approved to access instructor features\"\"\"\n        if not self.is_instructor():\n            return True  # Non-instructors don't need approval\n        return self.instructor_approval_status == 'approved'\n    \n    def is_instructor_pending(self):\n        \"\"\"Check if instructor is pending approval\"\"\"\n        return self.is_instructor() and self.instructor_approval_status == 'pending'\n    \n    def is_instructor_rejected(self):\n        \"\"\"Check if instructor was rejected\"\"\"\n        return self.is_instructor() and self.instructor_approval_status == 'rejected'\n\n@login_manager.user_loader\ndef load_user(user_id):\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            user = conn.execute(\n                'SELECT * FROM users WHERE id = ? AND is_active = 1', (user_id,)\n            ).fetchone()\n            conn.close()\n        \n        if user:\n            profile_pic = user['profile_picture'] if 'profile_picture' in user.keys() else None\n            return User(user['id'], user['username'], user['email'], user['role'], \n                       user['full_name'], user['created_at'], user['is_active'],\n                       user['instructor_approval_status'] if user['instructor_approval_status'] else 'approved',\n                       user['approved_by'],\n                       user['approved_at'],\n                       profile_pic)\n    except sqlite3.OperationalError:\n        # Database not yet initialized\n        pass\n    return None\n\n# Role-based access control decorators\ndef admin_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if not current_user.is_authenticated or not current_user.is_admin():\n            flash('Access denied. Admin privileges required.', 'error')\n            return redirect(url_for('dashboard'))\n        return f(*args, **kwargs)\n    return decorated_function\n\ndef instructor_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if not current_user.is_authenticated:\n            flash('Access denied. Please log in.', 'error')\n            return redirect(url_for('login'))\n        \n        # Admins always have access to instructor features\n        if current_user.is_admin():\n            return f(*args, **kwargs)\n        \n        # Check if user is instructor\n        if not current_user.is_instructor():\n            flash('Access denied. Instructor privileges required.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Check if instructor is approved\n        if not current_user.is_instructor_approved():\n            flash('Your instructor account is pending approval. Please wait for admin approval.', 'warning')\n            return redirect(url_for('dashboard'))\n        \n        return f(*args, **kwargs)\n    return decorated_function\n\n# Database initialization\ndef init_db():\n    print(\"ðŸ”„ Initializing database...\")\n    with db_lock:\n        try:\n            conn = get_db_connection()\n            \n            # Users table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS users (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    username TEXT UNIQUE NOT NULL,\n                    email TEXT UNIQUE NOT NULL,\n                    password_hash TEXT NOT NULL,\n                    role TEXT NOT NULL DEFAULT 'student',\n                    full_name TEXT NOT NULL,\n                    bio TEXT,\n                    profile_image TEXT,\n                    instructor_approval_status TEXT DEFAULT 'approved',\n                    approved_by INTEGER,\n                    approved_at TIMESTAMP,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    last_login TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (approved_by) REFERENCES users (id)\n                )\n            ''')\n            \n            # Add columns if they don't exist\n            try:\n                conn.execute('ALTER TABLE users ADD COLUMN instructor_approval_status TEXT DEFAULT \"approved\"')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE users ADD COLUMN approved_by INTEGER')\n            except sqlite3.OperationalError:\n                pass\n                \n            try:\n                conn.execute('ALTER TABLE users ADD COLUMN approved_at TIMESTAMP')\n            except sqlite3.OperationalError:\n                pass\n                \n            try:\n                conn.execute('ALTER TABLE courses ADD COLUMN enrollment_key_hash TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE users ADD COLUMN instructor_screenshot TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            # Courses table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS courses (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_code TEXT UNIQUE NOT NULL,\n                    title TEXT NOT NULL,\n                    description TEXT,\n                    syllabus TEXT,\n                    instructor_id INTEGER NOT NULL,\n                    category TEXT,\n                    max_students INTEGER DEFAULT 50,\n                    start_date DATE,\n                    end_date DATE,\n                    enrollment_key_hash TEXT,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (instructor_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # Enrollments table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS enrollments (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    student_id INTEGER NOT NULL,\n                    course_id INTEGER NOT NULL,\n                    status TEXT NOT NULL DEFAULT 'pending',\n                    payment_screenshot TEXT,\n                    enrolled_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    approved_at TIMESTAMP,\n                    progress_percentage REAL DEFAULT 0,\n                    manual_progress_override REAL DEFAULT NULL,\n                    FOREIGN KEY (student_id) REFERENCES users (id),\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    UNIQUE(student_id, course_id)\n                )\n            ''')\n            \n            # Add manual_progress_override column if it doesn't exist\n            try:\n                conn.execute('ALTER TABLE enrollments ADD COLUMN manual_progress_override REAL DEFAULT NULL')\n            except sqlite3.OperationalError:\n                pass\n            \n            # Assignments table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS assignments (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    description TEXT,\n                    instructions TEXT,\n                    due_date DATETIME,\n                    max_points INTEGER DEFAULT 100,\n                    allow_late_submission BOOLEAN DEFAULT 0,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    FOREIGN KEY (course_id) REFERENCES courses (id)\n                )\n            ''')\n            \n            # Assignment submissions table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS assignment_submissions (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    assignment_id INTEGER NOT NULL,\n                    student_id INTEGER NOT NULL,\n                    submission_text TEXT,\n                    file_path TEXT,\n                    submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    grade REAL,\n                    ai_feedback TEXT,\n                    instructor_feedback TEXT,\n                    graded_at TIMESTAMP,\n                    FOREIGN KEY (assignment_id) REFERENCES assignments (id),\n                    FOREIGN KEY (student_id) REFERENCES users (id),\n                    UNIQUE(assignment_id, student_id)\n                )\n            ''')\n            \n            # Quiz questions table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS quiz_questions (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    assignment_id INTEGER NOT NULL,\n                    question_text TEXT NOT NULL,\n                    question_type TEXT NOT NULL DEFAULT 'mcq',\n                    points INTEGER DEFAULT 1,\n                    correct_answer TEXT,\n                    explanation TEXT,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    FOREIGN KEY (assignment_id) REFERENCES assignments (id)\n                )\n            ''')\n            \n            # Question options table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS question_options (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    question_id INTEGER NOT NULL,\n                    option_letter TEXT NOT NULL,\n                    option_text TEXT NOT NULL,\n                    is_correct BOOLEAN DEFAULT 0,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    FOREIGN KEY (question_id) REFERENCES quiz_questions (id)\n                )\n            ''')\n            \n            # Student MCQ answers table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS student_mcq_answers (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    submission_id INTEGER NOT NULL,\n                    question_id INTEGER NOT NULL,\n                    selected_option TEXT,\n                    is_correct BOOLEAN,\n                    points_earned REAL DEFAULT 0,\n                    answered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    FOREIGN KEY (submission_id) REFERENCES assignment_submissions (id),\n                    FOREIGN KEY (question_id) REFERENCES quiz_questions (id),\n                    UNIQUE(submission_id, question_id)\n                )\n            ''')\n            \n            # Forums table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS forums (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    description TEXT,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (course_id) REFERENCES courses (id)\n                )\n            ''')\n            \n            # Forum topics table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS forum_topics (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    forum_id INTEGER NOT NULL,\n                    user_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    content TEXT NOT NULL,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_pinned BOOLEAN DEFAULT 0,\n                    view_count INTEGER DEFAULT 0,\n                    FOREIGN KEY (forum_id) REFERENCES forums (id),\n                    FOREIGN KEY (user_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # Forum replies table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS forum_replies (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    topic_id INTEGER NOT NULL,\n                    user_id INTEGER NOT NULL,\n                    content TEXT NOT NULL,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_ai_generated BOOLEAN DEFAULT 0,\n                    FOREIGN KEY (topic_id) REFERENCES forum_topics (id),\n                    FOREIGN KEY (user_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # Chat messages table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS chat_messages (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER,\n                    sender_id INTEGER NOT NULL,\n                    recipient_id INTEGER,\n                    message TEXT NOT NULL,\n                    message_type TEXT DEFAULT 'text',\n                    file_path TEXT,\n                    file_name TEXT,\n                    file_size INTEGER DEFAULT 0,\n                    is_image BOOLEAN DEFAULT 0,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_read BOOLEAN DEFAULT 0,\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    FOREIGN KEY (sender_id) REFERENCES users (id),\n                    FOREIGN KEY (recipient_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # Direct messages table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS direct_messages (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    sender_id INTEGER NOT NULL,\n                    recipient_id INTEGER NOT NULL,\n                    message TEXT NOT NULL,\n                    message_type TEXT DEFAULT 'text',\n                    file_path TEXT,\n                    file_name TEXT,\n                    is_image BOOLEAN DEFAULT 0,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_read BOOLEAN DEFAULT 0,\n                    FOREIGN KEY (sender_id) REFERENCES users (id),\n                    FOREIGN KEY (recipient_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # File uploads table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS file_uploads (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    uploader_id INTEGER NOT NULL,\n                    file_name TEXT NOT NULL,\n                    file_path TEXT NOT NULL,\n                    file_size INTEGER,\n                    file_type TEXT,\n                    message_id INTEGER,\n                    direct_message_id INTEGER,\n                    forum_reply_id INTEGER,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    FOREIGN KEY (uploader_id) REFERENCES users (id),\n                    FOREIGN KEY (message_id) REFERENCES chat_messages (id),\n                    FOREIGN KEY (direct_message_id) REFERENCES direct_messages (id),\n                    FOREIGN KEY (forum_reply_id) REFERENCES forum_replies (id)\n                )\n            ''')\n            \n            # Notifications table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS notifications (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    user_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    message TEXT NOT NULL,\n                    type TEXT DEFAULT 'info',\n                    related_id INTEGER,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_read BOOLEAN DEFAULT 0,\n                    FOREIGN KEY (user_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # Course resources table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS course_resources (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    description TEXT,\n                    file_path TEXT,\n                    file_type TEXT,\n                    upload_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    uploaded_by INTEGER NOT NULL,\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    FOREIGN KEY (uploaded_by) REFERENCES users (id)\n                )\n            ''')\n            \n            # Course meeting links table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS course_meeting_links (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    meeting_link TEXT NOT NULL,\n                    description TEXT,\n                    scheduled_time TIMESTAMP,\n                    created_by INTEGER NOT NULL,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    FOREIGN KEY (created_by) REFERENCES users (id)\n                )\n            ''')\n            \n            # Course video playlists table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS course_video_playlists (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    video_url TEXT NOT NULL,\n                    description TEXT,\n                    thumbnail_url TEXT,\n                    duration TEXT,\n                    notes_file_path TEXT,\n                    order_index INTEGER DEFAULT 0,\n                    created_by INTEGER NOT NULL,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    FOREIGN KEY (created_by) REFERENCES users (id)\n                )\n            ''')\n            \n            # Add transcript column if needed\n            try:\n                conn.execute('ALTER TABLE course_video_playlists ADD COLUMN transcript_file_path TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            # Student video playlists table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS student_video_playlists (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    student_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    video_url TEXT NOT NULL,\n                    description TEXT,\n                    thumbnail_url TEXT,\n                    duration TEXT,\n                    order_index INTEGER DEFAULT 0,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (student_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # AI Notes table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS ai_notes (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    topic TEXT NOT NULL,\n                    content TEXT NOT NULL,\n                    pdf_path TEXT,\n                    created_by INTEGER NOT NULL,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_instructor_note BOOLEAN DEFAULT 0,\n                    sent_to_students BOOLEAN DEFAULT 0,\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    FOREIGN KEY (created_by) REFERENCES users (id)\n                )\n            ''')\n            \n            # Add media columns to forum_topics if needed\n            try:\n                conn.execute('ALTER TABLE forum_topics ADD COLUMN media_type TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE forum_topics ADD COLUMN media_path TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE forum_topics ADD COLUMN media_filename TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            # Add media columns to forum_replies if needed\n            try:\n                conn.execute('ALTER TABLE forum_replies ADD COLUMN media_type TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE forum_replies ADD COLUMN media_path TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE forum_replies ADD COLUMN media_filename TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            # Create indexes\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_users_email ON users(email)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_users_role ON users(role)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_users_approval_status ON users(instructor_approval_status)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_enrollments_student ON enrollments(student_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_enrollments_course ON enrollments(course_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_assignments_course ON assignments(course_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_submissions_assignment ON assignment_submissions(assignment_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_quiz_questions_assignment ON quiz_questions(assignment_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_question_options_question ON question_options(question_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_student_answers_submission ON student_mcq_answers(submission_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_student_answers_question ON student_mcq_answers(question_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_chat_course ON chat_messages(course_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_notifications_user ON notifications(user_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_meeting_links_course ON course_meeting_links(course_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_video_playlists_course ON course_video_playlists(course_id)')\n            \n            # Create default admin user\n            admin_exists = conn.execute('SELECT id FROM users WHERE role = \"admin\"').fetchone()\n            if not admin_exists:\n                admin_password = generate_password_hash('admin123')\n                conn.execute('''\n                    INSERT INTO users (username, email, password_hash, role, full_name, bio)\n                    VALUES (?, ?, ?, ?, ?, ?)\n                ''', ('admin', 'admin@learnnest.com', admin_password, 'admin', \n                     'System Administrator', 'Default system administrator account'))\n            \n            conn.commit()\n            conn.close()\n            print(\"âœ… Database initialized successfully!\")\n            return True\n        except Exception as e:\n            print(f\"âŒ Database initialization error: {e}\")\n            import traceback\n            traceback.print_exc()\n            return False\n\n# Routes\n@app.route('/')\ndef index():\n    if current_user.is_authenticated:\n        return redirect(url_for('dashboard'))\n    return redirect(url_for('login'))\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    if current_user.is_authenticated:\n        return redirect(url_for('dashboard'))\n    \n    if request.method == 'POST':\n        # Validate CSRF token\n        csrf_token = request.form.get('csrf_token')\n        if not validate_csrf_token(csrf_token):\n            flash('Invalid security token. Please try again.', 'error')\n            return render_template('auth/login.html')\n            \n        email = request.form['email'].lower().strip()\n        password = request.form['password']\n        remember = bool(request.form.get('remember'))\n        \n        with db_lock:\n            conn = get_db_connection()\n            user = conn.execute(\n                'SELECT * FROM users WHERE email = ? AND is_active = 1', (email,)\n            ).fetchone()\n            conn.close()\n        \n        if user and check_password_hash(user['password_hash'], password):\n            # Update last login\n            with db_lock:\n                conn = get_db_connection()\n                conn.execute(\n                    'UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = ?', (user['id'],)\n                )\n                conn.commit()\n                conn.close()\n            \n            user_obj = User(user['id'], user['username'], user['email'], user['role'], \n                          user['full_name'], user['created_at'], user['is_active'],\n                          user['instructor_approval_status'] if user['instructor_approval_status'] else 'approved',\n                          user['approved_by'],\n                          user['approved_at'])\n            login_user(user_obj, remember=remember)\n            flash(f'Welcome back, {user[\"full_name\"]}!', 'success')\n            \n            next_page = request.args.get('next')\n            return redirect(next_page) if next_page else redirect(url_for('dashboard'))\n        else:\n            flash('Invalid email or password', 'error')\n    \n    return render_template('auth/login.html')\n\n@app.route('/register', methods=['GET', 'POST'])\ndef register():\n    if current_user.is_authenticated:\n        return redirect(url_for('dashboard'))\n    \n    if request.method == 'POST':\n        # Validate CSRF token\n        csrf_token = request.form.get('csrf_token')\n        if not validate_csrf_token(csrf_token):\n            flash('Invalid security token. Please try again.', 'error')\n            return render_template('auth/register.html')\n            \n        username = request.form['username'].strip()\n        email = request.form['email'].lower().strip()\n        password = request.form['password']\n        confirm_password = request.form['confirm_password']\n        full_name = request.form['full_name'].strip()\n        role = request.form.get('role', 'student')\n        \n        # Handle instructor screenshot upload\n        screenshot_filename = None\n        if role == 'instructor' and 'instructor_screenshot' in request.files:\n            screenshot = request.files['instructor_screenshot']\n            if screenshot and screenshot.filename:\n                # Create instructor_screenshots directory if it doesn't exist\n                screenshots_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'instructor_screenshots')\n                os.makedirs(screenshots_dir, exist_ok=True)\n                \n                # Validate file type\n                allowed_extensions = {'png', 'jpg', 'jpeg', 'gif', 'webp'}\n                file_ext = screenshot.filename.rsplit('.', 1)[1].lower() if '.' in screenshot.filename else ''\n                \n                if file_ext not in allowed_extensions:\n                    flash('Invalid file type. Please upload PNG, JPG, JPEG, GIF, or WebP images only.', 'error')\n                    return render_template('auth/register.html')\n                \n                # Validate file size (max 5MB)\n                screenshot.seek(0, 2)  # Seek to end\n                file_size = screenshot.tell()\n                screenshot.seek(0)  # Reset seek position\n                \n                if file_size > 5 * 1024 * 1024:\n                    flash('File size too large. Please upload images smaller than 5MB.', 'error')\n                    return render_template('auth/register.html')\n                \n                # Generate secure filename and save\n                filename = secure_filename(f\"{username}_{datetime.now().strftime('%Y%m%d_%H%M%S')}_{screenshot.filename}\")\n                screenshot_path = os.path.join(screenshots_dir, filename)\n                \n                try:\n                    screenshot.save(screenshot_path)\n                    screenshot_filename = filename\n                except Exception as e:\n                    flash('Error saving screenshot. Please try again.', 'error')\n                    return render_template('auth/register.html')\n        \n        # Validation\n        if password != confirm_password:\n            flash('Passwords do not match', 'error')\n            return render_template('auth/register.html')\n        \n        if len(password) < 6:\n            flash('Password must be at least 6 characters long', 'error')\n            return render_template('auth/register.html')\n        \n        # Validate instructor screenshot\n        if role == 'instructor' and not screenshot_filename:\n            flash('Screenshot upload is required for instructor accounts', 'error')\n            return render_template('auth/register.html')\n        \n        with db_lock:\n            conn = get_db_connection()\n            \n            # Check if user already exists\n            existing_user = conn.execute(\n                'SELECT id FROM users WHERE email = ? OR username = ?', (email, username)\n            ).fetchone()\n            \n            if existing_user:\n                flash('User with this email or username already exists', 'error')\n                conn.close()\n                return render_template('auth/register.html')\n            \n            # Create new user\n            password_hash = generate_password_hash(password)\n            \n            # Set instructor approval status based on role\n            instructor_approval_status = 'pending' if role == 'instructor' else 'approved'\n            \n            conn.execute('''\n                INSERT INTO users (username, email, password_hash, role, full_name, instructor_approval_status, instructor_screenshot)\n                VALUES (?, ?, ?, ?, ?, ?, ?)\n            ''', (username, email, password_hash, role, full_name, instructor_approval_status, screenshot_filename))\n            \n            conn.commit()\n            conn.close()\n        \n        # Flash appropriate message based on role\n        if role == 'instructor':\n            flash('Registration successful! Your instructor account is pending admin approval. You will be notified once approved.', 'info')\n        else:\n            flash('Registration successful! Please log in.', 'success')\n        return redirect(url_for('login'))\n    \n    return render_template('auth/register.html')\n\n@app.route('/logout')\n@login_required\ndef logout():\n    logout_user()\n    flash('You have been logged out successfully.', 'info')\n    return redirect(url_for('login'))\n\n@app.route('/dashboard')\n@login_required\ndef dashboard():\n    with db_lock:\n        conn = get_db_connection()\n        \n        if current_user.is_admin():\n            # Admin dashboard data\n            stats = {\n                'total_users': conn.execute('SELECT COUNT(*) FROM users WHERE is_active = 1').fetchone()[0],\n                'total_students': conn.execute('SELECT COUNT(*) FROM users WHERE role = \"student\" AND is_active = 1').fetchone()[0],\n                'total_courses': conn.execute('SELECT COUNT(*) FROM courses WHERE is_active = 1').fetchone()[0],\n                'total_enrollments': conn.execute('SELECT COUNT(*) FROM enrollments WHERE status = \"approved\"').fetchone()[0],\n                'pending_enrollments': conn.execute('SELECT COUNT(*) FROM enrollments WHERE status = \"pending\"').fetchone()[0],\n                'pending_instructors': conn.execute('SELECT COUNT(*) FROM users WHERE role = \"instructor\" AND instructor_approval_status = \"pending\" AND is_active = 1').fetchone()[0],\n                'total_instructors': conn.execute('SELECT COUNT(*) FROM users WHERE role = \"instructor\" AND is_active = 1').fetchone()[0]\n            }\n            \n            # Recent enrollments\n            recent_enrollments = conn.execute('''\n                SELECT e.*, u.full_name as student_name, c.title as course_title\n                FROM enrollments e\n                JOIN users u ON e.student_id = u.id\n                JOIN courses c ON e.course_id = c.id\n                ORDER BY e.enrolled_at DESC\n                LIMIT 10\n            ''').fetchall()\n            \n            conn.close()\n            return render_template('admin/dashboard.html', stats=stats, recent_enrollments=recent_enrollments)\n        \n        elif current_user.is_instructor() and current_user.is_instructor_approved():\n            # Redirect to dedicated instructor dashboard only if instructor is approved\n            conn.close()\n            return redirect(url_for('instructor_dashboard'))\n        \n        else:\n            # Student dashboard data - Use COALESCE to prioritize manual progress override\n            my_enrollments_raw = conn.execute('''\n                SELECT e.*, c.title, c.course_code, c.description, u.full_name as instructor_name,\n                       COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n                FROM enrollments e\n                JOIN courses c ON e.course_id = c.id\n                JOIN users u ON c.instructor_id = u.id\n                WHERE e.student_id = ?\n                ORDER BY e.enrolled_at DESC\n            ''', (current_user.id,)).fetchall()\n            \n            # Convert Row objects to dictionaries for JSON serialization\n            my_enrollments = [dict(row) for row in my_enrollments_raw]\n            \n            # Available courses (not enrolled)\n            available_courses = conn.execute('''\n                SELECT c.*, u.full_name as instructor_name\n                FROM courses c\n                JOIN users u ON c.instructor_id = u.id\n                LEFT JOIN enrollments e ON c.id = e.course_id AND e.student_id = ?\n                WHERE c.is_active = 1 AND e.id IS NULL\n                ORDER BY c.created_at DESC\n            ''', (current_user.id,)).fetchall()\n            \n            conn.close()\n            return render_template('student/dashboard.html', enrollments=my_enrollments, available_courses=available_courses)\n\n@app.route('/update_profile', methods=['POST'])\n@login_required\ndef update_profile():\n    \"\"\"Update user profile (name and picture)\"\"\"\n    try:\n        full_name = request.form.get('full_name', '').strip()\n        \n        if not full_name:\n            flash('Name cannot be empty.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        with db_lock:\n            conn = get_db_connection()\n            \n            # Update full name\n            conn.execute('''\n                UPDATE users SET full_name = ? WHERE id = ?\n            ''', (full_name, current_user.id))\n            \n            # Handle profile picture upload\n            if 'profile_picture' in request.files:\n                file = request.files['profile_picture']\n                if file and file.filename:\n                    try:\n                        # Validate file type\n                        allowed_extensions = {'png', 'jpg', 'jpeg', 'gif', 'webp'}\n                        filename = secure_filename(file.filename)\n                        file_ext = filename.rsplit('.', 1)[-1].lower() if '.' in filename else ''\n                        \n                        if file_ext not in allowed_extensions:\n                            logging.warning(f\"Invalid file type: {file_ext}\")\n                            conn.close()\n                            flash('Invalid file type. Please upload PNG, JPG, JPEG, GIF, or WebP images only.', 'error')\n                            return redirect(url_for('dashboard'))\n                        \n                        # Create profile pictures directory\n                        profile_pics_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'profile_pictures')\n                        os.makedirs(profile_pics_dir, exist_ok=True)\n                        \n                        # Generate secure filename\n                        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n                        filename = f\"{current_user.id}_{timestamp}_{filename}\"\n                        filepath = os.path.join(profile_pics_dir, filename)\n                        \n                        # Save file\n                        file.save(filepath)\n                        logging.info(f\"Profile picture saved: {filepath}\")\n                        \n                        # Update database with relative path\n                        relative_path = os.path.join('profile_pictures', filename).replace('\\\\', '/')\n                        conn.execute('''\n                            UPDATE users SET profile_picture = ? WHERE id = ?\n                        ''', (relative_path, current_user.id))\n                    except Exception as file_error:\n                        logging.error(f\"Error processing file upload: {file_error}\")\n                        conn.close()\n                        flash('Error processing file upload. Please try again.', 'error')\n                        return redirect(url_for('dashboard'))\n            \n            conn.commit()\n            \n            # Reload the updated user data from database\n            user_data = conn.execute('SELECT * FROM users WHERE id = ?', (current_user.id,)).fetchone()\n            conn.close()\n        \n        # Update current_user object with new data\n        current_user.full_name = full_name\n        if user_data and 'profile_picture' in user_data.keys():\n            current_user.profile_picture = user_data['profile_picture']\n        \n        flash('Profile updated successfully!', 'success')\n        \n    except Exception as e:\n        logging.error(f\"Error updating profile: {e}\")\n        flash('Error updating profile. Please try again.', 'error')\n    \n    return redirect(url_for('dashboard'))\n\n# Admin instructor management routes\n@app.route('/admin/instructors')\n@admin_required\ndef admin_instructors():\n    \"\"\"Main instructor management page\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get all instructors with their approval status\n        instructors_raw = conn.execute('''\n            SELECT u.*, \n                   (SELECT full_name FROM users WHERE id = u.approved_by) as approved_by_name,\n                   (SELECT COUNT(*) FROM courses WHERE instructor_id = u.id AND is_active = 1) as course_count\n            FROM users u\n            WHERE u.role = 'instructor' AND u.is_active = 1\n            ORDER BY \n                CASE u.instructor_approval_status \n                    WHEN 'pending' THEN 1\n                    WHEN 'rejected' THEN 2\n                    WHEN 'approved' THEN 3\n                END,\n                u.created_at DESC\n        ''').fetchall()\n        \n        # Convert Row objects to dictionaries for JSON serialization\n        instructors = [dict(row) for row in instructors_raw]\n        \n        # Get counts for stats\n        stats = {\n            'total_instructors': len(instructors),\n            'pending_instructors': len([i for i in instructors if i['instructor_approval_status'] == 'pending']),\n            'approved_instructors': len([i for i in instructors if i['instructor_approval_status'] == 'approved']),\n            'rejected_instructors': len([i for i in instructors if i['instructor_approval_status'] == 'rejected'])\n        }\n        \n        conn.close()\n    \n    return render_template('admin/instructors.html', instructors=instructors, stats=stats)\n\n@app.route('/admin/instructors/pending')\n@admin_required\ndef admin_instructors_pending():\n    \"\"\"View pending instructor applications\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        pending_instructors_raw = conn.execute('''\n            SELECT u.*\n            FROM users u\n            WHERE u.role = 'instructor' \n              AND u.instructor_approval_status = 'pending' \n              AND u.is_active = 1\n            ORDER BY u.created_at ASC\n        ''').fetchall()\n        \n        # Convert Row objects to dictionaries for JSON serialization\n        pending_instructors = [dict(row) for row in pending_instructors_raw]\n        \n        conn.close()\n    \n    return render_template('admin/instructors.html', \n                         instructors=pending_instructors, \n                         view_type='pending',\n                         stats={'pending_instructors': len(pending_instructors)})\n\n@app.route('/admin/instructors/approve/<int:instructor_id>', methods=['POST'])\n@admin_required\ndef admin_approve_instructor(instructor_id):\n    \"\"\"Approve an instructor\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify instructor exists and is pending\n        instructor = conn.execute('''\n            SELECT * FROM users \n            WHERE id = ? AND role = 'instructor' AND instructor_approval_status = 'pending'\n        ''', (instructor_id,)).fetchone()\n        \n        if not instructor:\n            flash('Instructor not found or already processed.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        # Approve the instructor\n        conn.execute('''\n            UPDATE users \n            SET instructor_approval_status = 'approved',\n                approved_by = ?,\n                approved_at = CURRENT_TIMESTAMP\n            WHERE id = ?\n        ''', (current_user.id, instructor_id))\n        \n        # Create notification for the instructor\n        conn.execute('''\n            INSERT INTO notifications (user_id, title, message, type)\n            VALUES (?, ?, ?, ?)\n        ''', (instructor_id, \n              'Instructor Account Approved',\n              'Congratulations! Your instructor account has been approved. You can now create courses and access all instructor features.',\n              'success'))\n        \n        conn.commit()\n        conn.close()\n    \n    flash(f'Instructor {instructor[\"full_name\"]} has been approved successfully.', 'success')\n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/instructors/reject/<int:instructor_id>', methods=['POST'])\n@admin_required\ndef admin_reject_instructor(instructor_id):\n    \"\"\"Reject an instructor\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify instructor exists and is pending\n        instructor = conn.execute('''\n            SELECT * FROM users \n            WHERE id = ? AND role = 'instructor' AND instructor_approval_status = 'pending'\n        ''', (instructor_id,)).fetchone()\n        \n        if not instructor:\n            flash('Instructor not found or already processed.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        # Reject the instructor\n        conn.execute('''\n            UPDATE users \n            SET instructor_approval_status = 'rejected',\n                approved_by = ?,\n                approved_at = CURRENT_TIMESTAMP\n            WHERE id = ?\n        ''', (current_user.id, instructor_id))\n        \n        # Create notification for the instructor\n        conn.execute('''\n            INSERT INTO notifications (user_id, title, message, type)\n            VALUES (?, ?, ?, ?)\n        ''', (instructor_id,\n              'Instructor Application Rejected',\n              'We regret to inform you that your instructor application has been rejected. Please contact the administrator for more information.',\n              'error'))\n        \n        conn.commit()\n        conn.close()\n    \n    flash(f'Instructor {instructor[\"full_name\"]} has been rejected.', 'warning')\n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/instructors/create', methods=['POST'])\n@admin_required\ndef admin_create_instructor():\n    \"\"\"Create a new instructor account\"\"\"\n    username = request.form.get('username', '').strip().lower()\n    email = request.form.get('email', '').strip().lower()\n    full_name = request.form.get('full_name', '').strip()\n    password = request.form.get('password', '').strip()\n    \n    if not all([username, email, full_name, password]):\n        flash('All fields are required.', 'error')\n        return redirect(url_for('admin_instructors'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Check if user already exists\n        existing = conn.execute(\n            'SELECT id FROM users WHERE username = ? OR email = ?',\n            (username, email)\n        ).fetchone()\n        \n        if existing:\n            flash('Username or email already exists.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        try:\n            conn.execute('''\n                INSERT INTO users (username, email, password, full_name, role, instructor_approval_status, is_active)\n                VALUES (?, ?, ?, ?, 'instructor', 'approved', 1)\n            ''', (username, email, generate_password_hash(password), full_name))\n            \n            conn.commit()\n            flash(f'Instructor {full_name} created successfully!', 'success')\n        except Exception as e:\n            conn.rollback()\n            flash('Error creating instructor. Please try again.', 'error')\n        finally:\n            conn.close()\n    \n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/instructors/<int:instructor_id>/edit', methods=['POST'])\n@admin_required\ndef admin_edit_instructor(instructor_id):\n    \"\"\"Edit instructor details\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        instructor = conn.execute(\n            'SELECT * FROM users WHERE id = ? AND role = \"instructor\"',\n            (instructor_id,)\n        ).fetchone()\n        \n        if not instructor:\n            flash('Instructor not found.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        email = request.form.get('email', '').strip().lower()\n        full_name = request.form.get('full_name', '').strip()\n        \n        # Check if new email is already taken\n        if email != instructor['email']:\n            existing = conn.execute(\n                'SELECT id FROM users WHERE email = ? AND id != ?',\n                (email, instructor_id)\n            ).fetchone()\n            if existing:\n                flash('Email already in use.', 'error')\n                conn.close()\n                return redirect(url_for('admin_instructors'))\n        \n        try:\n            conn.execute('''\n                UPDATE users \n                SET email = ?, full_name = ?\n                WHERE id = ?\n            ''', (email, full_name, instructor_id))\n            \n            conn.commit()\n            flash(f'Instructor {full_name} updated successfully!', 'success')\n        except Exception as e:\n            conn.rollback()\n            flash('Error updating instructor.', 'error')\n        finally:\n            conn.close()\n    \n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/instructors/<int:instructor_id>/delete', methods=['POST'])\n@admin_required\ndef admin_delete_instructor(instructor_id):\n    \"\"\"Delete (deactivate) an instructor\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        instructor = conn.execute(\n            'SELECT * FROM users WHERE id = ? AND role = \"instructor\"',\n            (instructor_id,)\n        ).fetchone()\n        \n        if not instructor:\n            flash('Instructor not found.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        try:\n            conn.execute(\n                'UPDATE users SET is_active = 0 WHERE id = ?',\n                (instructor_id,)\n            )\n            conn.commit()\n            flash(f'Instructor {instructor[\"full_name\"]} has been removed.', 'success')\n        except Exception as e:\n            conn.rollback()\n            flash('Error removing instructor.', 'error')\n        finally:\n            conn.close()\n    \n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/instructors/<int:instructor_id>/toggle-block', methods=['POST'])\n@admin_required\ndef admin_toggle_instructor_block(instructor_id):\n    \"\"\"Block or unblock an instructor\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        instructor = conn.execute(\n            'SELECT * FROM users WHERE id = ? AND role = \"instructor\"',\n            (instructor_id,)\n        ).fetchone()\n        \n        if not instructor:\n            flash('Instructor not found.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        new_status = 0 if instructor['is_active'] else 1\n        action = 'unblocked' if new_status else 'blocked'\n        \n        try:\n            conn.execute(\n                'UPDATE users SET is_active = ? WHERE id = ?',\n                (new_status, instructor_id)\n            )\n            conn.commit()\n            flash(f'Instructor {instructor[\"full_name\"]} has been {action}.', 'success')\n        except Exception as e:\n            conn.rollback()\n            flash(f'Error {action} instructor.', 'error')\n        finally:\n            conn.close()\n    \n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/students')\n@login_required\n@admin_required\ndef admin_students():\n    \"\"\"View all students\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            students_raw = conn.execute('''\n                SELECT u.*, COUNT(DISTINCT e.id) as enrollment_count\n                FROM users u\n                LEFT JOIN enrollments e ON u.id = e.student_id AND e.status = 'approved'\n                WHERE u.role = 'student'\n                GROUP BY u.id\n                ORDER BY u.created_at DESC\n            ''').fetchall()\n            \n            # Convert Row objects to dictionaries for JSON serialization\n            students = [dict(row) for row in students_raw]\n            conn.close()\n        \n        return render_template('admin/students.html', students=students)\n    except Exception as e:\n        logging.error(f\"Error fetching students: {e}\")\n        flash('Error loading students', 'error')\n        return redirect(url_for('dashboard'))\n\n@app.route('/admin/student/<int:student_id>/enrollments', methods=['GET'])\n@admin_required\ndef admin_student_enrollments(student_id):\n    \"\"\"Get student's course enrollments for viewing\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            enrollments_raw = conn.execute('''\n                SELECT e.id, e.status, e.enrolled_at, e.progress_percentage,\n                       c.title, c.course_code, u.full_name as instructor_name\n                FROM enrollments e\n                JOIN courses c ON e.course_id = c.id\n                JOIN users u ON c.instructor_id = u.id\n                WHERE e.student_id = ?\n                ORDER BY e.enrolled_at DESC\n            ''', (student_id,)).fetchall()\n            \n            enrollments = [dict(row) for row in enrollments_raw]\n            conn.close()\n        \n        return jsonify({'success': True, 'enrollments': enrollments})\n    except Exception as e:\n        logging.error(f\"Error fetching enrollments: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n@app.route('/admin/students/<int:student_id>/delete', methods=['POST'])\n@login_required\n@admin_required\ndef admin_delete_student(student_id):\n    \"\"\"Delete a student account\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            student = conn.execute('SELECT * FROM users WHERE id = ? AND role = \"student\"', (student_id,)).fetchone()\n            \n            if not student:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Student not found'}), 404\n            \n            # Delete student's enrollments\n            conn.execute('DELETE FROM enrollments WHERE student_id = ?', (student_id,))\n            \n            # Delete student's notes\n            conn.execute('DELETE FROM student_notes WHERE student_id = ?', (student_id,))\n            \n            # Delete student account\n            conn.execute('DELETE FROM users WHERE id = ?', (student_id,))\n            conn.commit()\n            conn.close()\n            \n        return jsonify({'success': True, 'message': 'Student deleted successfully'})\n    except Exception as e:\n        logging.error(f\"Error deleting student: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n@app.route('/admin/students/<int:student_id>/toggle-block', methods=['POST'])\n@login_required\n@admin_required\ndef admin_toggle_student_block(student_id):\n    \"\"\"Toggle student block status\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            student = conn.execute('SELECT * FROM users WHERE id = ? AND role = \"student\"', (student_id,)).fetchone()\n            \n            if not student:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Student not found'}), 404\n            \n            # Toggle is_active status\n            new_status = 0 if student['is_active'] else 1\n            conn.execute('UPDATE users SET is_active = ? WHERE id = ?', (new_status, student_id))\n            conn.commit()\n            conn.close()\n            \n        return jsonify({'success': True, 'message': f'Student {\"unblocked\" if new_status else \"blocked\"} successfully'})\n    except Exception as e:\n        logging.error(f\"Error toggling student block: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n# INSTRUCTOR ROUTES\n@app.route('/instructor/dashboard')\n@instructor_required\ndef instructor_dashboard():\n    \"\"\"Enhanced instructor dashboard with course management\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # My courses\n        my_courses = conn.execute('''\n            SELECT c.*, \n                   COUNT(CASE WHEN e.status = 'approved' THEN 1 END) as approved_count,\n                   COUNT(CASE WHEN e.status = 'pending' THEN 1 END) as pending_count,\n                   COUNT(e.id) as total_enrollments\n            FROM courses c\n            LEFT JOIN enrollments e ON c.id = e.course_id\n            WHERE c.instructor_id = ? AND c.is_active = 1\n            GROUP BY c.id\n            ORDER BY c.created_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Pending enrollments for all my courses\n        pending_enrollments = conn.execute('''\n            SELECT e.*, u.full_name as student_name, u.email as student_email, \n                   c.title as course_title, c.course_code\n            FROM enrollments e\n            JOIN users u ON e.student_id = u.id\n            JOIN courses c ON e.course_id = c.id\n            WHERE c.instructor_id = ? AND e.status = 'pending'\n            ORDER BY e.enrolled_at ASC\n        ''', (current_user.id,)).fetchall()\n        \n        # Statistics\n        stats = {\n            'total_courses': len(my_courses),\n            'total_students': sum([course['approved_count'] for course in my_courses]),\n            'pending_enrollments': len(pending_enrollments),\n            'active_courses': len([c for c in my_courses if c['approved_count'] > 0])\n        }\n        \n        conn.close()\n    \n    return render_template('instructor/dashboard.html', \n                         courses=my_courses, \n                         pending_enrollments=pending_enrollments,\n                         stats=stats)\n\n@app.route('/instructor/courses/<int:course_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_course(course_id):\n    \"\"\"Delete a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ?\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        try:\n            # Delete related data - only from tables that exist\n            conn.execute('DELETE FROM enrollments WHERE course_id = ?', (course_id,))\n            \n            # Try to delete from optional tables if they exist\n            try:\n                conn.execute('DELETE FROM course_video_playlists WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            try:\n                conn.execute('DELETE FROM course_resources WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            try:\n                conn.execute('DELETE FROM course_meeting_links WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            try:\n                conn.execute('DELETE FROM quizzes WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            try:\n                conn.execute('DELETE FROM ai_notes WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            try:\n                conn.execute('DELETE FROM discussion_forums WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            # Delete the course itself\n            conn.execute('DELETE FROM courses WHERE id = ?', (course_id,))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Course \"{course[\"title\"]}\" has been deleted successfully.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            logging.error(f\"Error deleting course: {e}\")\n            flash('Error deleting course. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_courses'))\n\n\n@app.route('/instructor/courses')\n@instructor_required\ndef instructor_courses():\n    \"\"\"View and manage all instructor courses\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        courses = conn.execute('''\n            SELECT c.*, \n                   COUNT(CASE WHEN e.status = 'approved' THEN 1 END) as approved_count,\n                   COUNT(CASE WHEN e.status = 'pending' THEN 1 END) as pending_count\n            FROM courses c\n            LEFT JOIN enrollments e ON c.id = e.course_id\n            WHERE c.instructor_id = ? AND c.is_active = 1\n            GROUP BY c.id\n            ORDER BY c.created_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Fetch AI Notes PDFs for each course\n        courses_list = []\n        for course in courses:\n            course_dict = dict(course)\n            ai_notes = conn.execute('''\n                SELECT * FROM ai_notes \n                WHERE course_id = ? AND created_by = ? AND is_instructor_note = 1 AND pdf_path IS NOT NULL\n                ORDER BY created_at DESC LIMIT 5\n            ''', (course['id'], current_user.id)).fetchall()\n            course_dict['ai_notes'] = ai_notes\n            courses_list.append(course_dict)\n        \n        conn.close()\n    \n    return render_template('instructor/courses.html', courses=courses_list)\n\n@app.route('/instructor/courses/create', methods=['GET', 'POST'])\n@instructor_required\ndef instructor_create_course():\n    \"\"\"Create a new course with enrollment key\"\"\"\n    if request.method == 'POST':\n        # Get and validate required fields\n        course_code = request.form.get('course_code', '').strip().upper()\n        title = request.form.get('title', '').strip()\n        enrollment_key = request.form.get('enrollment_key', '').strip()\n        \n        # Validate required fields\n        if not course_code:\n            flash('Course Code is required.', 'error')\n            return render_template('instructor/create_course.html')\n        if not title:\n            flash('Course Title is required.', 'error')\n            return render_template('instructor/create_course.html')\n        if not enrollment_key:\n            flash('Enrollment Key is required.', 'error')\n            return render_template('instructor/create_course.html')\n        \n        # Get optional fields\n        description = request.form.get('description', '').strip()\n        syllabus = request.form.get('syllabus', '').strip()\n        category = request.form.get('category', '').strip()\n        max_students = int(request.form.get('max_students', 50))\n        start_date = request.form.get('start_date') or None\n        end_date = request.form.get('end_date') or None\n        \n        # Validate enrollment key\n        if len(enrollment_key) < 6:\n            flash('Enrollment key must be at least 6 characters long.', 'error')\n            return render_template('instructor/create_course.html')\n        \n        # Hash the enrollment key for security\n        enrollment_key_hash = generate_password_hash(enrollment_key)\n        \n        with db_lock:\n            conn = get_db_connection()\n            \n            # Check if course code already exists\n            existing_course = conn.execute(\n                'SELECT id FROM courses WHERE course_code = ?', (course_code,)\n            ).fetchone()\n            \n            if existing_course:\n                flash('Course code already exists. Please choose a different one.', 'error')\n                conn.close()\n                return render_template('instructor/create_course.html')\n            \n            try:\n                conn.execute('''\n                    INSERT INTO courses (\n                        course_code, title, description, syllabus, instructor_id, \n                        category, max_students, start_date, end_date, enrollment_key_hash\n                    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n                ''', (course_code, title, description, syllabus, current_user.id,\n                     category, max_students, start_date, end_date, enrollment_key_hash))\n                \n                conn.commit()\n                conn.close()\n                \n                flash(f'Course \"{title}\" created successfully!', 'success')\n                return redirect(url_for('instructor_courses'))\n                \n            except Exception as e:\n                conn.rollback()\n                conn.close()\n                flash('Error creating course. Please try again.', 'error')\n    \n    return render_template('instructor/create_course.html')\n\n@app.route('/instructor/courses/edit/<int:course_id>', methods=['GET', 'POST'])\n@instructor_required\ndef instructor_edit_course(course_id):\n    \"\"\"Edit an existing course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to current instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        if request.method == 'POST':\n            title = request.form['title'].strip()\n            description = request.form.get('description', '').strip()\n            syllabus = request.form.get('syllabus', '').strip()\n            category = request.form.get('category', '').strip()\n            max_students = int(request.form.get('max_students', 50))\n            start_date = request.form.get('start_date') or None\n            end_date = request.form.get('end_date') or None\n            \n            # Handle enrollment key update\n            enrollment_key = request.form.get('enrollment_key', '').strip()\n            if enrollment_key:\n                if len(enrollment_key) < 6:\n                    flash('Enrollment key must be at least 6 characters long.', 'error')\n                    conn.close()\n                    return render_template('instructor/edit_course.html', course=course)\n                enrollment_key_hash = generate_password_hash(enrollment_key)\n            else:\n                enrollment_key_hash = course['enrollment_key_hash']  # Keep existing\n            \n            try:\n                conn.execute('''\n                    UPDATE courses \n                    SET title = ?, description = ?, syllabus = ?, category = ?, \n                        max_students = ?, start_date = ?, end_date = ?, enrollment_key_hash = ?\n                    WHERE id = ?\n                ''', (title, description, syllabus, category, max_students, \n                     start_date, end_date, enrollment_key_hash, course_id))\n                \n                conn.commit()\n                conn.close()\n                \n                flash(f'Course \"{title}\" updated successfully!', 'success')\n                return redirect(url_for('instructor_courses'))\n                \n            except Exception as e:\n                conn.rollback()\n                conn.close()\n                flash('Error updating course. Please try again.', 'error')\n        \n        conn.close()\n    \n    return render_template('instructor/edit_course.html', course=course)\n\n@app.route('/instructor/enrollments')\n@instructor_required \ndef instructor_enrollments():\n    \"\"\"View all student enrollments for instructor's courses\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        enrollments = conn.execute('''\n            SELECT e.*, u.full_name as student_name, u.email as student_email,\n                   c.title as course_title, c.course_code,\n                   COALESCE(e.progress_percentage, 0) as progress_percentage\n            FROM enrollments e\n            JOIN users u ON e.student_id = u.id\n            JOIN courses c ON e.course_id = c.id\n            WHERE c.instructor_id = ?\n            ORDER BY \n                CASE e.status \n                    WHEN 'pending' THEN 1\n                    WHEN 'approved' THEN 2\n                    WHEN 'rejected' THEN 3\n                END,\n                e.enrolled_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Statistics\n        stats = {\n            'total_enrollments': len(enrollments),\n            'pending_enrollments': len([e for e in enrollments if e['status'] == 'pending']),\n            'approved_enrollments': len([e for e in enrollments if e['status'] == 'approved']),\n            'rejected_enrollments': len([e for e in enrollments if e['status'] == 'rejected'])\n        }\n        \n        conn.close()\n    \n    return render_template('instructor/enrollments.html', enrollments=enrollments, stats=stats)\n\n@app.route('/instructor/enrollments/approve/<int:enrollment_id>', methods=['POST'])\n@instructor_required\ndef instructor_approve_enrollment(enrollment_id):\n    \"\"\"Approve a student enrollment\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify enrollment belongs to instructor's course and is pending\n        enrollment = conn.execute('''\n            SELECT e.*, c.title as course_title, u.full_name as student_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON e.student_id = u.id\n            WHERE e.id = ? AND c.instructor_id = ? AND e.status = 'pending'\n        ''', (enrollment_id, current_user.id)).fetchone()\n        \n        if not enrollment:\n            flash('Enrollment not found or already processed.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_enrollments'))\n        \n        try:\n            # Approve the enrollment\n            conn.execute('''\n                UPDATE enrollments \n                SET status = 'approved', approved_at = CURRENT_TIMESTAMP\n                WHERE id = ?\n            ''', (enrollment_id,))\n            \n            # Create notification for the student\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (enrollment['student_id'],\n                  'Enrollment Approved',\n                  f'Great news! Your enrollment in \"{enrollment[\"course_title\"]}\" has been approved. You now have full access to the course.',\n                  'success',\n                  enrollment['course_id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Approved enrollment for {enrollment[\"student_name\"]} in {enrollment[\"course_title\"]}.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error approving enrollment. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_enrollments'))\n\n@app.route('/instructor/enrollments/reject/<int:enrollment_id>', methods=['POST'])\n@instructor_required\ndef instructor_reject_enrollment(enrollment_id):\n    \"\"\"Reject a student enrollment\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify enrollment belongs to instructor's course and is pending\n        enrollment = conn.execute('''\n            SELECT e.*, c.title as course_title, u.full_name as student_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON e.student_id = u.id\n            WHERE e.id = ? AND c.instructor_id = ? AND e.status = 'pending'\n        ''', (enrollment_id, current_user.id)).fetchone()\n        \n        if not enrollment:\n            flash('Enrollment not found or already processed.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_enrollments'))\n        \n        try:\n            # Reject the enrollment\n            conn.execute('''\n                UPDATE enrollments \n                SET status = 'rejected'\n                WHERE id = ?\n            ''', (enrollment_id,))\n            \n            # Create notification for the student\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (enrollment['student_id'],\n                  'Enrollment Not Approved',\n                  f'Your enrollment request for \"{enrollment[\"course_title\"]}\" was not approved. Please contact the instructor for more information.',\n                  'warning',\n                  enrollment['course_id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Rejected enrollment for {enrollment[\"student_name\"]} in {enrollment[\"course_title\"]}.', 'warning')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error rejecting enrollment. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_enrollments'))\n\n\n@app.route('/instructor/enrollments/block/<int:enrollment_id>', methods=['POST'])\n@instructor_required\ndef instructor_block_student(enrollment_id):\n    \"\"\"Block a student from a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify enrollment belongs to instructor's course and is approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.title as course_title, u.full_name as student_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON e.student_id = u.id\n            WHERE e.id = ? AND c.instructor_id = ? AND e.status = 'approved'\n        ''', (enrollment_id, current_user.id)).fetchone()\n        \n        if not enrollment:\n            flash('Enrollment not found or cannot be blocked.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_enrollments'))\n        \n        try:\n            # Block the enrollment\n            conn.execute('''\n                UPDATE enrollments \n                SET status = 'blocked'\n                WHERE id = ?\n            ''', (enrollment_id,))\n            \n            # Create notification for the student\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (enrollment['student_id'],\n                  'Course Access Blocked',\n                  f'Your access to \"{enrollment[\"course_title\"]}\" has been blocked by the instructor.',\n                  'warning',\n                  enrollment['course_id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Blocked {enrollment[\"student_name\"]} from {enrollment[\"course_title\"]}.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error blocking student. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_enrollments'))\n\n\n@app.route('/instructor/enrollments/remove/<int:enrollment_id>', methods=['POST'])\n@instructor_required\ndef instructor_remove_student(enrollment_id):\n    \"\"\"Remove a student from a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify enrollment belongs to instructor's course and is approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.title as course_title, u.full_name as student_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON e.student_id = u.id\n            WHERE e.id = ? AND c.instructor_id = ? AND e.status = 'approved'\n        ''', (enrollment_id, current_user.id)).fetchone()\n        \n        if not enrollment:\n            flash('Enrollment not found or cannot be removed.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_enrollments'))\n        \n        try:\n            # Delete the enrollment\n            conn.execute('DELETE FROM enrollments WHERE id = ?', (enrollment_id,))\n            \n            # Create notification for the student\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (enrollment['student_id'],\n                  'Removed from Course',\n                  f'You have been removed from \"{enrollment[\"course_title\"]}\" by the instructor.',\n                  'warning',\n                  enrollment['course_id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Removed {enrollment[\"student_name\"]} from {enrollment[\"course_title\"]}.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error removing student. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_enrollments'))\n\n\n@app.route('/instructor/enrollments/unblock/<int:enrollment_id>', methods=['POST'])\n@instructor_required\ndef instructor_unblock_student(enrollment_id):\n    \"\"\"Unblock a student from a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify enrollment belongs to instructor's course and is blocked\n        enrollment = conn.execute('''\n            SELECT e.*, c.title as course_title, u.full_name as student_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON e.student_id = u.id\n            WHERE e.id = ? AND c.instructor_id = ? AND e.status = 'blocked'\n        ''', (enrollment_id, current_user.id)).fetchone()\n        \n        if not enrollment:\n            flash('Enrollment not found or cannot be unblocked.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_enrollments'))\n        \n        try:\n            # Unblock the enrollment\n            conn.execute('''\n                UPDATE enrollments \n                SET status = 'approved'\n                WHERE id = ?\n            ''', (enrollment_id,))\n            \n            # Create notification for the student\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (enrollment['student_id'],\n                  'Course Access Restored',\n                  f'Your access to \"{enrollment[\"course_title\"]}\" has been restored by the instructor.',\n                  'success',\n                  enrollment['course_id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Unblocked {enrollment[\"student_name\"]} for {enrollment[\"course_title\"]}.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error unblocking student. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_enrollments'))\n\n# STUDENT PROGRESS MANAGEMENT ROUTES\n@app.route('/instructor/courses/<int:course_id>/students')\n@instructor_required\ndef instructor_course_students(course_id):\n    \"\"\"View and manage student progress for a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get all students enrolled in the course with their progress\n        students = conn.execute('''\n            SELECT \n                e.id as enrollment_id,\n                e.student_id,\n                u.full_name as student_name,\n                u.email as student_email,\n                e.status,\n                e.enrolled_at,\n                e.progress_percentage,\n                e.manual_progress_override,\n                COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n            FROM enrollments e\n            JOIN users u ON e.student_id = u.id\n            WHERE e.course_id = ? AND e.status = 'approved'\n            ORDER BY u.full_name\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/course_students.html', course=course, students=students)\n\n@app.route('/instructor/courses/<int:course_id>/set-progress-bulk', methods=['POST'])\n@instructor_required\ndef instructor_set_progress_bulk(course_id):\n    \"\"\"Set manual progress override for all students in a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ?\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            conn.close()\n            return jsonify({'success': False, 'error': 'Course not found or access denied'}), 403\n        \n        # Get progress value from request\n        progress = request.form.get('progress')\n        \n        if progress is None or progress == '':\n            conn.close()\n            return jsonify({'success': False, 'error': 'Please enter a progress value'}), 400\n        \n        # Validate progress value\n        try:\n            progress = float(progress)\n            if progress < 0 or progress > 100:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Progress must be between 0 and 100'}), 400\n        except ValueError:\n            conn.close()\n            return jsonify({'success': False, 'error': 'Invalid progress value'}), 400\n        \n        # Get all students in the course\n        try:\n            students = conn.execute('''\n                SELECT e.student_id, u.full_name\n                FROM enrollments e\n                JOIN users u ON e.student_id = u.id\n                WHERE e.course_id = ? AND e.status = 'approved'\n            ''', (course_id,)).fetchall()\n            \n            # Update progress for all students\n            for student in students:\n                conn.execute('''\n                    UPDATE enrollments\n                    SET manual_progress_override = ?, progress_percentage = ?\n                    WHERE course_id = ? AND student_id = ?\n                ''', (progress, progress, course_id, student['student_id']))\n                \n                # Send notification to each student\n                send_notification(\n                    student['student_id'],\n                    'Course Progress Updated',\n                    f'Your instructor has updated your progress in \"{course[\"title\"]}\" to {progress:.0f}%',\n                    'info',\n                    course_id\n                )\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({\n                'success': True, \n                'message': f'Progress set to {progress:.0f}% for all {len(students)} students',\n                'count': len(students)\n            })\n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            return jsonify({'success': False, 'error': str(e)}), 500\n\n@app.route('/instructor/courses/<int:course_id>/students/<int:student_id>/set-progress', methods=['POST'])\n@instructor_required\ndef instructor_set_student_progress(course_id, student_id):\n    \"\"\"Set manual progress override for a student\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ?\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            conn.close()\n            return jsonify({'success': False, 'error': 'Course not found or access denied'}), 403\n        \n        # Get progress value from request\n        progress = request.form.get('progress')\n        \n        if progress is None or progress == '':\n            # Clear manual override (reset to automatic calculation)\n            try:\n                conn.execute('''\n                    UPDATE enrollments\n                    SET manual_progress_override = NULL\n                    WHERE course_id = ? AND student_id = ?\n                ''', (course_id, student_id))\n                conn.commit()\n                \n                # Immediately recalculate automatic progress to get current quiz-based progress\n                auto_progress = update_student_progress(conn, student_id, course_id)\n                \n                # Get student info for notification\n                student = conn.execute('SELECT full_name FROM users WHERE id = ?', (student_id,)).fetchone()\n                \n                # Send notification to student\n                send_notification(\n                    student_id,\n                    'Course Progress Updated',\n                    f'Your progress in \"{course[\"title\"]}\" has been reset to automatic tracking ({auto_progress:.0f}%)',\n                    'info',\n                    course_id\n                )\n                \n                conn.close()\n                return jsonify({\n                    'success': True, \n                    'message': f'Manual progress cleared. Automatic progress is {auto_progress:.0f}%',\n                    'progress': auto_progress,\n                    'is_manual': False\n                })\n            except Exception as e:\n                conn.rollback()\n                conn.close()\n                return jsonify({'success': False, 'error': str(e)}), 500\n        \n        # Validate progress value\n        try:\n            progress = float(progress)\n            if progress < 0 or progress > 100:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Progress must be between 0 and 100'}), 400\n        except ValueError:\n            conn.close()\n            return jsonify({'success': False, 'error': 'Invalid progress value'}), 400\n        \n        # Set manual progress override\n        try:\n            conn.execute('''\n                UPDATE enrollments\n                SET manual_progress_override = ?, progress_percentage = ?\n                WHERE course_id = ? AND student_id = ?\n            ''', (progress, progress, course_id, student_id))\n            \n            # Get student info for notification\n            student = conn.execute('SELECT full_name FROM users WHERE id = ?', (student_id,)).fetchone()\n            \n            # Send notification to student\n            send_notification(\n                student_id,\n                'Course Progress Updated',\n                f'Your instructor has updated your progress in \"{course[\"title\"]}\" to {progress:.0f}%',\n                'info',\n                course_id\n            )\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({\n                'success': True, \n                'message': f'Progress set to {progress:.0f}% for {student[\"full_name\"]}',\n                'progress': progress,\n                'is_manual': True\n            })\n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            return jsonify({'success': False, 'error': str(e)}), 500\n\n# COURSE CONTENT MANAGEMENT ROUTES\n@app.route('/instructor/courses/<int:course_id>/content')\n@instructor_required\ndef instructor_course_content(course_id):\n    \"\"\"Manage course content - videos, notes, resources\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get course resources\n        resources = conn.execute('''\n            SELECT * FROM course_resources \n            WHERE course_id = ?\n            ORDER BY upload_date DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get meeting links\n        meeting_links = conn.execute('''\n            SELECT * FROM course_meeting_links \n            WHERE course_id = ? AND is_active = 1\n            ORDER BY created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get video playlist\n        video_playlist = conn.execute('''\n            SELECT * FROM course_video_playlists \n            WHERE course_id = ? AND is_active = 1\n            ORDER BY order_index ASC\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/course_content.html', course=course, resources=resources, \n                         meeting_links=meeting_links, video_playlist=video_playlist)\n\n@app.route('/instructor/courses/<int:course_id>/content/upload', methods=['POST'])\n@instructor_required\ndef instructor_upload_content(course_id):\n    \"\"\"Upload course content - videos, notes, resources\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        description = request.form.get('description', '').strip()\n        content_type = request.form.get('content_type', 'document')\n        \n        if 'file' in request.files:\n            file = request.files['file']\n            if file and file.filename:\n                filename = secure_filename(file.filename)\n                file_path = os.path.join(app.config['UPLOAD_FOLDER'], 'resources', f\"{course_id}_{uuid.uuid4().hex}_{filename}\")\n                file.save(file_path)\n                \n                try:\n                    conn.execute('''\n                        INSERT INTO course_resources (course_id, title, description, file_path, file_type, uploaded_by)\n                        VALUES (?, ?, ?, ?, ?, ?)\n                    ''', (course_id, title, description, file_path, content_type, current_user.id))\n                    \n                    conn.commit()\n                    flash(f'Content \"{title}\" uploaded successfully!', 'success')\n                    \n                except Exception as e:\n                    conn.rollback()\n                    flash('Error uploading content. Please try again.', 'error')\n        else:\n            flash('No file selected for upload.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n# MEETING LINKS MANAGEMENT ROUTES\n@app.route('/instructor/courses/<int:course_id>/meeting-links/add', methods=['POST'])\n@instructor_required\ndef instructor_add_meeting_link(course_id):\n    \"\"\"Add a meeting link to the course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        meeting_link = request.form.get('meeting_link', '').strip()\n        description = request.form.get('description', '').strip()\n        scheduled_time = request.form.get('scheduled_time') or None\n        \n        if not title or not meeting_link:\n            flash('Meeting title and link are required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_content', course_id=course_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO course_meeting_links (course_id, title, meeting_link, description, scheduled_time, created_by)\n                VALUES (?, ?, ?, ?, ?, ?)\n            ''', (course_id, title, meeting_link, description, scheduled_time, current_user.id))\n            \n            conn.commit()\n            flash(f'Meeting link \"{title}\" added successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error adding meeting link. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n@app.route('/instructor/courses/<int:course_id>/meeting-links/<int:link_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_meeting_link(course_id, link_id):\n    \"\"\"Delete a meeting link\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        try:\n            conn.execute('''\n                DELETE FROM course_meeting_links \n                WHERE id = ? AND course_id = ? AND created_by = ?\n            ''', (link_id, course_id, current_user.id))\n            \n            conn.commit()\n            flash('Meeting link deleted successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error deleting meeting link. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n# VIDEO PLAYLIST MANAGEMENT ROUTES\n@app.route('/instructor/courses/<int:course_id>/video-playlist/add', methods=['POST'])\n@instructor_required\ndef instructor_add_video_playlist(course_id):\n    \"\"\"Add a video to the course playlist\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        video_url = request.form.get('video_url', '').strip()\n        description = request.form.get('description', '').strip()\n        duration = request.form.get('duration', '').strip()\n        thumbnail_url = request.form.get('thumbnail_url', '').strip()\n        \n        if not title or not video_url:\n            flash('Video title and URL are required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_content', course_id=course_id))\n        \n        # Handle notes file upload with validation\n        notes_file_path = None\n        ALLOWED_NOTES_EXTENSIONS = {'pdf', 'doc', 'docx', 'txt', 'ppt', 'pptx', 'odt', 'rtf'}\n        MAX_NOTES_SIZE = 50 * 1024 * 1024  # 50MB\n        \n        if 'notes_file' in request.files:\n            notes_file = request.files['notes_file']\n            if notes_file and notes_file.filename:\n                filename = secure_filename(notes_file.filename)\n                file_ext = filename.rsplit('.', 1)[1].lower() if '.' in filename else ''\n                \n                # Validate file extension\n                if file_ext not in ALLOWED_NOTES_EXTENSIONS:\n                    flash(f'Invalid file type. Allowed: {\", \".join(ALLOWED_NOTES_EXTENSIONS)}', 'error')\n                    conn.close()\n                    return redirect(url_for('instructor_course_content', course_id=course_id))\n                \n                # Check file size\n                notes_file.seek(0, 2)  # Seek to end\n                file_size = notes_file.tell()\n                notes_file.seek(0)  # Reset to beginning\n                \n                if file_size > MAX_NOTES_SIZE:\n                    flash('Notes file too large. Maximum size is 50MB.', 'error')\n                    conn.close()\n                    return redirect(url_for('instructor_course_content', course_id=course_id))\n                \n                # Save the file\n                notes_file_path = os.path.join(app.config['UPLOAD_FOLDER'], 'resources', f\"notes_{course_id}_{uuid.uuid4().hex}_{filename}\")\n                os.makedirs(os.path.dirname(notes_file_path), exist_ok=True)\n                notes_file.save(notes_file_path)\n        \n        try:\n            # Get the next order index\n            max_order = conn.execute('''\n                SELECT MAX(order_index) FROM course_video_playlists \n                WHERE course_id = ?\n            ''', (course_id,)).fetchone()[0]\n            \n            next_order = (max_order or 0) + 1\n            \n            conn.execute('''\n                INSERT INTO course_video_playlists (course_id, title, video_url, description, duration, thumbnail_url, notes_file_path, order_index, created_by)\n                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n            ''', (course_id, title, video_url, description, duration, thumbnail_url, notes_file_path, next_order, current_user.id))\n            \n            conn.commit()\n            flash(f'Video \"{title}\" added to playlist successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error adding video to playlist. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n@app.route('/download-notes/<int:video_id>')\n@login_required\ndef download_video_notes(video_id):\n    \"\"\"Download notes for a video\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id \n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video or not video['notes_file_path']:\n            conn.close()\n            flash('Notes not found.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                flash('Access denied.', 'error')\n                return redirect(url_for('dashboard'))\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            flash('Access denied.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        stored_path = video['notes_file_path']\n        conn.close()\n        \n        # Try to find the actual file - handle incorrect paths from different systems\n        file_path = None\n        filename = os.path.basename(stored_path)\n        \n        # Try multiple possible locations\n        possible_paths = [\n            stored_path,  # Original path\n            os.path.join(app.config['UPLOAD_FOLDER'], 'resources', filename),  # Current system path\n            os.path.join('sir_rafique', 'uploads', 'resources', filename),  # Relative path\n        ]\n        \n        for path in possible_paths:\n            if os.path.exists(path):\n                file_path = path\n                break\n        \n        if not file_path:\n            logging.error(f\"Notes file not found. Tried paths: {possible_paths}\")\n            flash('Notes file not found on server. Please contact your instructor.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Send the file\n        try:\n            directory = os.path.dirname(file_path)\n            filename = os.path.basename(file_path)\n            \n            # Get original extension for proper MIME type\n            file_ext = filename.rsplit('.', 1)[1].lower() if '.' in filename else 'pdf'\n            mime_types = {\n                'pdf': 'application/pdf',\n                'doc': 'application/msword',\n                'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n                'txt': 'text/plain',\n                'ppt': 'application/vnd.ms-powerpoint',\n                'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation'\n            }\n            \n            return send_from_directory(\n                directory, \n                filename, \n                as_attachment=True,\n                mimetype=mime_types.get(file_ext, 'application/octet-stream')\n            )\n        except Exception as e:\n            logging.error(f\"Error downloading notes: {e}\")\n            flash('Unable to download notes. Please try again.', 'error')\n            return redirect(url_for('dashboard'))\n\n@app.route('/instructor/courses/<int:course_id>/content/video/<int:video_id>/edit', methods=['POST'])\n@instructor_required\ndef instructor_edit_video_playlist(course_id, video_id):\n    \"\"\"Edit a video in playlist\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify video belongs to instructor's course\n        video = conn.execute('''\n            SELECT v.* FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.course_id = ? AND c.instructor_id = ? AND v.is_active = 1\n        ''', (video_id, course_id, current_user.id)).fetchone()\n        \n        if not video:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Video not found or access denied.'}), 404\n        \n        try:\n            title = request.form.get('title', '').strip()\n            video_url = request.form.get('video_url', '').strip()\n            duration = request.form.get('duration', '').strip()\n            description = request.form.get('description', '').strip()\n            \n            if not title or not video_url:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Title and URL are required.'}), 400\n            \n            # Update the video\n            conn.execute('''\n                UPDATE course_video_playlists\n                SET title = ?, video_url = ?, duration = ?, description = ?\n                WHERE id = ? AND course_id = ? AND is_active = 1\n            ''', (title, video_url, duration or None, description or None, video_id, course_id))\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({'success': True, 'message': 'Video updated successfully!'}), 200\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            logging.error(f\"Error updating video: {e}\")\n            return jsonify({'success': False, 'message': 'Error updating video. Please try again.'}), 500\n\n@app.route('/instructor/courses/<int:course_id>/video-playlist/<int:video_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_video_playlist(course_id, video_id):\n    \"\"\"Delete a video from playlist\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        try:\n            conn.execute('''\n                DELETE FROM course_video_playlists \n                WHERE id = ? AND course_id = ? AND created_by = ?\n            ''', (video_id, course_id, current_user.id))\n            \n            conn.commit()\n            flash('Video deleted from playlist successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error deleting video. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n# STUDENT VIDEO PLAYLIST ROUTES\n@app.route('/student/my-playlist')\n@login_required\ndef student_my_playlist():\n    \"\"\"View student's personal video playlist\"\"\"\n    if not current_user.is_student():\n        flash('Access denied.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        rows = conn.execute('''\n            SELECT * FROM student_video_playlists \n            WHERE student_id = ? AND is_active = 1\n            ORDER BY order_index ASC\n        ''', (current_user.id,)).fetchall()\n        # Convert Row objects to dictionaries for JSON serialization\n        videos = [dict(row) for row in rows]\n        conn.close()\n    \n    return render_template('student/my_playlist.html', videos=videos)\n\n@app.route('/student/playlist/add', methods=['POST'])\n@login_required\ndef student_add_playlist_video():\n    \"\"\"Add video to student playlist\"\"\"\n    if not current_user.is_student():\n        return jsonify({'success': False, 'message': 'Access denied.'}), 403\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        title = request.form.get('title', '').strip()\n        video_url = request.form.get('video_url', '').strip()\n        description = request.form.get('description', '').strip()\n        duration = request.form.get('duration', '').strip()\n        \n        if not title or not video_url:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Title and URL are required.'}), 400\n        \n        try:\n            conn.execute('''\n                INSERT INTO student_video_playlists \n                (student_id, title, video_url, description, duration, order_index)\n                VALUES (?, ?, ?, ?, ?, (SELECT COUNT(*) FROM student_video_playlists WHERE student_id = ?))\n            ''', (current_user.id, title, video_url, description or None, duration or None, current_user.id))\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({'success': True, 'message': 'Video added to playlist!'}), 200\n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            logging.error(f\"Error adding playlist video: {e}\")\n            return jsonify({'success': False, 'message': 'Error adding video. Please try again.'}), 500\n\n@app.route('/student/playlist/<int:video_id>/edit', methods=['POST'])\n@login_required\ndef student_edit_playlist_video(video_id):\n    \"\"\"Edit student playlist video\"\"\"\n    if not current_user.is_student():\n        return jsonify({'success': False, 'message': 'Access denied.'}), 403\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        video = conn.execute('''\n            SELECT * FROM student_video_playlists \n            WHERE id = ? AND student_id = ? AND is_active = 1\n        ''', (video_id, current_user.id)).fetchone()\n        \n        if not video:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Video not found.'}), 404\n        \n        title = request.form.get('title', '').strip()\n        video_url = request.form.get('video_url', '').strip()\n        description = request.form.get('description', '').strip()\n        duration = request.form.get('duration', '').strip()\n        \n        if not title or not video_url:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Title and URL are required.'}), 400\n        \n        try:\n            conn.execute('''\n                UPDATE student_video_playlists\n                SET title = ?, video_url = ?, description = ?, duration = ?\n                WHERE id = ? AND student_id = ? AND is_active = 1\n            ''', (title, video_url, description or None, duration or None, video_id, current_user.id))\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({'success': True, 'message': 'Video updated successfully!'}), 200\n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            logging.error(f\"Error updating playlist video: {e}\")\n            return jsonify({'success': False, 'message': 'Error updating video.'}), 500\n\n@app.route('/student/playlist/<int:video_id>/delete', methods=['POST'])\n@login_required\ndef student_delete_playlist_video(video_id):\n    \"\"\"Delete video from student playlist\"\"\"\n    if not current_user.is_student():\n        return jsonify({'success': False, 'message': 'Access denied.'}), 403\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        try:\n            conn.execute('''\n                DELETE FROM student_video_playlists \n                WHERE id = ? AND student_id = ?\n            ''', (video_id, current_user.id))\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({'success': True, 'message': 'Video deleted!'}), 200\n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            logging.error(f\"Error deleting playlist video: {e}\")\n            return jsonify({'success': False, 'message': 'Error deleting video.'}), 500\n\n@app.route('/generate-transcript/<int:video_id>', methods=['POST'])\n@login_required\ndef generate_video_transcript(video_id):\n    \"\"\"Generate AI transcript for a video and save as PDF with watermark\"\"\"\n    try:\n        from utils.pdf_generator import generate_transcript_pdf\n    except ImportError:\n        logging.error(\"PDF generator not available\")\n        return jsonify({'success': False, 'message': 'PDF generation service not available. Please check system configuration.'}), 500\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id, c.title as course_title, c.course_code\n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Video not found.'}), 404\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Access denied.'}), 403\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Access denied.'}), 403\n        \n        try:\n            # Generate transcript using Gemini AI from actual YouTube video\n            transcript_text = gemini_ai.generate_video_transcript(\n                video['title'],\n                video['description'] or '',\n                video['duration'] or '',\n                video['video_url'] or ''\n            )\n            \n            if not transcript_text or len(transcript_text) < 10:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Failed to generate transcript. Please check your Gemini API key.'}), 500\n            \n            # Generate PDF filename\n            safe_filename = secure_filename(video['title'])\n            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n            pdf_filename = f\"transcript_{video_id}_{timestamp}.pdf\"\n            transcript_folder = os.path.join(app.config['UPLOAD_FOLDER'], 'transcripts')\n            os.makedirs(transcript_folder, exist_ok=True)\n            pdf_path = os.path.join(transcript_folder, pdf_filename)\n            \n            # Generate PDF with watermark\n            success = generate_transcript_pdf(\n                transcript_text=transcript_text,\n                video_title=video['title'],\n                course_name=f\"{video['course_code']} - {video['course_title']}\",\n                student_name=current_user.full_name,\n                output_path=pdf_path\n            )\n            \n            if success:\n                # Save relative path to database (not absolute)\n                relative_path = os.path.join('sir_rafique', 'uploads', 'transcripts', pdf_filename)\n                \n                # Update database with transcript path\n                conn.execute('''\n                    UPDATE course_video_playlists \n                    SET transcript_file_path = ?\n                    WHERE id = ?\n                ''', (relative_path, video_id))\n                conn.commit()\n                conn.close()\n                \n                logging.info(f\"Transcript generated successfully for video {video_id}\")\n                return jsonify({\n                    'success': True,\n                    'message': 'Transcript generated successfully!',\n                    'download_url': url_for('download_video_transcript', video_id=video_id)\n                })\n            else:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Error generating PDF. Please try again.'}), 500\n                \n        except ValueError as ve:\n            conn.close()\n            logging.error(f\"Gemini API Key Error: {ve}\")\n            return jsonify({'success': False, 'message': 'Gemini API is not configured. Please set GEMINI_API_KEY environment variable.'}), 500\n        except Exception as e:\n            conn.close()\n            logging.error(f\"Error generating transcript: {e}\")\n            return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500\n\n@app.route('/generate-student-notes', methods=['POST'])\n@login_required\ndef generate_student_notes_route():\n    \"\"\"Generate AI-enhanced notes from student input and save as PDF with LearnNest watermark\"\"\"\n    try:\n        from utils.pdf_generator import generate_transcript_pdf\n    except ImportError:\n        logging.error(\"PDF generator not available\")\n        return jsonify({'success': False, 'message': 'PDF generation service not available.'}), 500\n    \n    try:\n        data = request.get_json()\n        student_notes_input = data.get('topic', '').strip()\n        course_id = data.get('course_id')\n        add_watermark = data.get('add_watermark', True)  # Default to True\n        \n        if not student_notes_input or len(student_notes_input) < 3:\n            return jsonify({'success': False, 'message': 'Please enter a topic.'}), 400\n        \n        with db_lock:\n            conn = get_db_connection()\n            \n            # Get course details\n            course = conn.execute('''\n                SELECT * FROM courses WHERE id = ?\n            ''', (course_id,)).fetchone()\n            \n            if not course:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Course not found.'}), 404\n            \n            # Check student has access\n            if current_user.is_student():\n                enrollment = conn.execute('''\n                    SELECT * FROM enrollments \n                    WHERE student_id = ? AND course_id = ? AND status = 'approved'\n                ''', (current_user.id, course_id)).fetchone()\n                if not enrollment:\n                    conn.close()\n                    return jsonify({'success': False, 'message': 'Access denied.'}), 403\n            \n            # Generate enhanced notes using Gemini AI\n            enhanced_notes = gemini_ai.generate_student_notes(\n                student_notes_input,\n                course['title'],\n                course['course_code']\n            )\n            \n            if not enhanced_notes or len(enhanced_notes) < 10:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Failed to enhance notes. Please try again.'}), 500\n            \n            # Generate PDF filename\n            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n            pdf_filename = f\"student_notes_{current_user.id}_{timestamp}.pdf\"\n            notes_folder = os.path.join(app.config['UPLOAD_FOLDER'], 'student_notes')\n            os.makedirs(notes_folder, exist_ok=True)\n            pdf_path = os.path.join(notes_folder, pdf_filename)\n            \n            # Generate PDF with optional watermark\n            success = generate_transcript_pdf(\n                transcript_text=enhanced_notes,\n                video_title=f\"Study Notes - {course['title']}\",\n                course_name=f\"{course['course_code']} - {course['title']}\",\n                student_name=current_user.full_name,\n                output_path=pdf_path,\n                add_watermark=add_watermark\n            )\n            \n            if success:\n                # Save to database\n                conn.execute('''\n                    INSERT INTO student_notes (student_id, course_id, original_input, enhanced_notes, file_path, created_at)\n                    VALUES (?, ?, ?, ?, ?, ?)\n                ''', (\n                    current_user.id,\n                    course_id,\n                    student_notes_input,\n                    enhanced_notes,\n                    os.path.join('sir_rafique', 'uploads', 'student_notes', pdf_filename),\n                    datetime.now()\n                ))\n                conn.commit()\n                \n                # Get the inserted note ID\n                note_id = conn.execute('SELECT last_insert_rowid()').fetchone()[0]\n                conn.close()\n                \n                # Send notification to student\n                socketio.emit('notification', {\n                    'title': 'ðŸ“š Study Notes Generated!',\n                    'message': f'Your AI-generated study notes for \"{student_notes_input}\" are ready!',\n                    'type': 'success',\n                    'icon': 'fa-book'\n                }, to=f'user_{current_user.id}')\n                \n                logging.info(f\"Student notes generated for student {current_user.id}\")\n                return jsonify({\n                    'success': True,\n                    'message': 'Enhanced study notes generated successfully!',\n                    'note_id': note_id,\n                    'enhanced_notes': enhanced_notes,\n                    'download_url': url_for('download_student_notes', note_id=note_id)\n                })\n            else:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Error generating PDF.'}), 500\n                \n    except ValueError as ve:\n        logging.error(f\"Gemini API Key Error: {ve}\")\n        return jsonify({'success': False, 'message': 'Gemini API not configured.'}), 500\n    except Exception as e:\n        logging.error(f\"Error generating student notes: {e}\")\n        return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500\n\n@app.route('/download-student-notes/<int:note_id>')\n@login_required\ndef download_student_notes(note_id):\n    \"\"\"Download student's enhanced notes PDF\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            note = conn.execute('''\n                SELECT * FROM student_notes WHERE id = ? AND student_id = ?\n            ''', (note_id, current_user.id)).fetchone()\n            conn.close()\n        \n        if not note:\n            logging.warning(f\"Note {note_id} not found for student {current_user.id}\")\n            return jsonify({'error': 'Note not found'}), 404\n        \n        stored_path = note['file_path']\n        filename = os.path.basename(stored_path)\n        \n        # Try multiple possible locations\n        possible_paths = [\n            stored_path,  # Original path as stored\n            os.path.join(app.config['UPLOAD_FOLDER'], filename),  # In uploads folder\n            os.path.join(app.config['UPLOAD_FOLDER'], 'student_notes', filename),  # In student_notes subfolder\n            os.path.join('sir_rafique', 'uploads', filename),  # Relative path from project root\n            os.path.join('sir_rafique', 'uploads', 'student_notes', filename),  # With subfolder\n        ]\n        \n        file_path = None\n        for path in possible_paths:\n            if os.path.exists(path):\n                file_path = path\n                logging.info(f\"Found notes file at: {path}\")\n                break\n        \n        if not file_path:\n            logging.error(f\"Student notes file not found. Note ID: {note_id}, Stored path: {stored_path}, Tried paths: {possible_paths}\")\n            return jsonify({'error': 'File not found on server'}), 404\n        \n        # Send the file\n        try:\n            directory = os.path.dirname(file_path)\n            filename = os.path.basename(file_path)\n            return send_file(file_path, as_attachment=True, download_name=f\"study_notes_{note_id}.pdf\")\n        except Exception as send_error:\n            logging.error(f\"Error sending file: {send_error}\")\n            return jsonify({'error': 'Error sending file'}), 500\n            \n    except Exception as e:\n        logging.error(f\"Error downloading student notes: {e}\")\n        return jsonify({'error': 'Download error'}), 500\n\n@app.route('/api/ai-assistant', methods=['POST'])\n@login_required\ndef ai_assistant():\n    \"\"\"AI Study Assistant - Answer student questions instantly using Gemini AI with visual generation\"\"\"\n    try:\n        data = request.get_json()\n        question = data.get('question', '').strip()\n        \n        if not question or len(question) < 3:\n            return jsonify({'success': False, 'message': 'Please enter a valid question.'}), 400\n        \n        try:\n            # Use Gemini AI to answer the question with visual capability\n            result = gemini_ai.answer_student_question(question)\n            \n            # Handle both dict and string responses for backward compatibility\n            if isinstance(result, dict):\n                answer_text = result.get('answer', '')\n                needs_visual = result.get('needs_visual', False)\n                visual_prompt = result.get('visual_prompt', None)\n            else:\n                answer_text = result\n                needs_visual = False\n                visual_prompt = None\n            \n            if answer_text and \"error\" not in answer_text.lower():\n                response_data = {\n                    'success': True,\n                    'answer': answer_text,\n                    'has_visual': needs_visual\n                }\n                \n                # If visual is needed, generate it using Gemini's Imagen\n                if needs_visual and visual_prompt:\n                    try:\n                        from google import genai\n                        client = genai.Client(api_key=os.environ.get(\"GEMINI_API_KEY\"))\n                        \n                        # Generate image using Imagen 3\n                        image_response = client.models.generate_images(\n                            model='imagen-3.0-generate-001',\n                            prompt=visual_prompt,\n                            config=types.GenerateImagesConfig(\n                                number_of_images=1,\n                                aspect_ratio='1:1',\n                                safety_filter_level='block_some',\n                                person_generation='allow_adult'\n                            )\n                        )\n                        \n                        if image_response and image_response.generated_images:\n                            # Save the generated image\n                            import base64\n                            image_data = image_response.generated_images[0].image.image_bytes\n                            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n                            filename = f\"ai_visual_{current_user.id}_{timestamp}.png\"\n                            visual_folder = os.path.join(app.config['UPLOAD_FOLDER'], 'ai_visuals')\n                            os.makedirs(visual_folder, exist_ok=True)\n                            image_path = os.path.join(visual_folder, filename)\n                            \n                            with open(image_path, 'wb') as f:\n                                f.write(image_data)\n                            \n                            response_data['visual_url'] = f\"/uploads/ai_visuals/{filename}\"\n                            logging.info(f\"Generated visual for question: {question[:50]}...\")\n                    except Exception as img_error:\n                        logging.warning(f\"Could not generate visual: {img_error}\")\n                        # Continue without visual if generation fails\n                \n                logging.info(f\"AI Assistant answered question for user {current_user.id}\")\n                return jsonify(response_data)\n            else:\n                return jsonify({\n                    'success': False,\n                    'message': 'Unable to generate answer at this time. Please try again.'\n                }), 500\n                \n        except Exception as e:\n            logging.error(f\"Error in AI Assistant: {e}\")\n            return jsonify({\n                'success': False,\n                'message': 'Error processing your question. Please try again.'\n            }), 500\n            \n    except Exception as e:\n        logging.error(f\"AI Assistant request error: {e}\")\n        return jsonify({'success': False, 'message': 'Invalid request.'}), 400\n\n@app.route('/generate-notes/<int:video_id>', methods=['POST'])\n@login_required\ndef generate_video_notes_route(video_id):\n    \"\"\"Generate AI study notes for a video and save as PDF\"\"\"\n    try:\n        from utils.pdf_generator import generate_transcript_pdf\n    except ImportError:\n        logging.error(\"PDF generator not available\")\n        return jsonify({'success': False, 'message': 'PDF generation service not available. Please check system configuration.'}), 500\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id, c.title as course_title, c.course_code\n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Video not found.'}), 404\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Access denied.'}), 403\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Access denied.'}), 403\n        \n        try:\n            # Generate AI notes using Gemini AI\n            notes_text = gemini_ai.generate_video_notes(\n                video['title'],\n                video['description'] or '',\n                video['duration'] or '',\n                video['video_url'] or ''\n            )\n            \n            if not notes_text or len(notes_text) < 10:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Failed to generate notes. Please check your Gemini API key.'}), 500\n            \n            # Generate PDF filename\n            safe_filename = secure_filename(video['title'])\n            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n            pdf_filename = f\"ai_notes_{video_id}_{timestamp}.pdf\"\n            notes_folder = os.path.join(app.config['UPLOAD_FOLDER'], 'resources')\n            os.makedirs(notes_folder, exist_ok=True)\n            pdf_path = os.path.join(notes_folder, pdf_filename)\n            \n            # Generate PDF with watermark (reuse transcript PDF function with different title)\n            success = generate_transcript_pdf(\n                transcript_text=notes_text,\n                video_title=f\"Study Notes: {video['title']}\",\n                course_name=f\"{video['course_code']} - {video['course_title']}\",\n                student_name=current_user.full_name,\n                output_path=pdf_path\n            )\n            \n            if success:\n                # Save relative path to database (not absolute)\n                relative_path = os.path.join('sir_rafique', 'uploads', 'resources', pdf_filename)\n                \n                # Update database with AI notes path\n                conn.execute('''\n                    UPDATE course_video_playlists \n                    SET notes_file_path = ?\n                    WHERE id = ?\n                ''', (relative_path, video_id))\n                conn.commit()\n                conn.close()\n                \n                logging.info(f\"AI notes generated successfully for video {video_id}\")\n                return jsonify({\n                    'success': True,\n                    'message': 'AI Study Notes generated successfully!',\n                    'download_url': url_for('download_video_notes', video_id=video_id)\n                })\n            else:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Error generating PDF. Please try again.'}), 500\n                \n        except ValueError as ve:\n            conn.close()\n            logging.error(f\"Gemini API Key Error: {ve}\")\n            return jsonify({'success': False, 'message': 'Gemini API is not configured. Please set GEMINI_API_KEY environment variable.'}), 500\n        except Exception as e:\n            conn.close()\n            logging.error(f\"Error generating notes: {e}\")\n            return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500\n\n@app.route('/download-transcript/<int:video_id>')\n@login_required\ndef download_video_transcript(video_id):\n    \"\"\"Download AI-generated transcript PDF for a video\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id \n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video or not video['transcript_file_path']:\n            conn.close()\n            flash('Transcript not found. Please generate it first.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                flash('Access denied.', 'error')\n                return redirect(url_for('dashboard'))\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            flash('Access denied.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        stored_path = video['transcript_file_path']\n        conn.close()\n        \n        # Try to find the actual file - handle incorrect paths from different systems\n        file_path = None\n        filename = os.path.basename(stored_path)\n        \n        # Try multiple possible locations\n        possible_paths = [\n            stored_path,  # Original path\n            os.path.join(app.config['UPLOAD_FOLDER'], 'transcripts', filename),  # Current system path\n            os.path.join('sir_rafique', 'uploads', 'transcripts', filename),  # Relative path\n        ]\n        \n        for path in possible_paths:\n            if os.path.exists(path):\n                file_path = path\n                break\n        \n        if not file_path:\n            logging.error(f\"Transcript file not found. Tried paths: {possible_paths}\")\n            flash('Transcript file not found. Please generate it again.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Send the transcript PDF file\n        try:\n            directory = os.path.dirname(file_path)\n            filename = os.path.basename(file_path)\n            \n            # Create a clean download filename\n            safe_title = \"\".join(c for c in video['title'] if c.isalnum() or c in (' ', '-', '_')).rstrip()\n            download_filename = f\"transcript_{safe_title}.pdf\"\n            \n            return send_from_directory(\n                directory, \n                filename, \n                as_attachment=True, \n                download_name=download_filename,\n                mimetype='application/pdf'\n            )\n        except Exception as e:\n            logging.error(f\"Error downloading transcript: {e}\")\n            flash(f'Unable to download transcript. Please try again.', 'error')\n            return redirect(url_for('dashboard'))\n\n@app.route('/download-video/<int:video_id>')\n@login_required\ndef download_video(video_id):\n    \"\"\"Download YouTube video for a course using yt-dlp\"\"\"\n    import subprocess\n    import tempfile\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id \n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video:\n            conn.close()\n            flash('Video not found.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                flash('Access denied.', 'error')\n                return redirect(url_for('dashboard'))\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            flash('Access denied.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        video_url = video['video_url']\n        conn.close()\n        \n        # Render download page with embedded downloader\n        return render_template('student/video_download.html', video=video)\n\n# VIDEO DOWNLOADER ROUTES (PyTubeFix Integration)\n@app.route('/video-downloader')\n@login_required\ndef video_downloader_home():\n    \"\"\"Main video downloader page\"\"\"\n    return render_template('student/video_download.html', video=None)\n\ndef clean_youtube_url(link: str) -> str:\n    \"\"\"Cleans YouTube URL by removing tracking parameters while preserving the video ID.\"\"\"\n    from urllib.parse import urlparse, parse_qs, urlencode, urlunparse\n    \n    parsed = urlparse(link)\n    query_params = parse_qs(parsed.query)\n    \n    # Keep only the 'v' parameter (video ID) if it exists\n    if 'v' in query_params:\n        cleaned_query = urlencode({'v': query_params['v'][0]})\n        cleaned_url = urlunparse((\n            parsed.scheme,\n            parsed.netloc,\n            parsed.path,\n            parsed.params,\n            cleaned_query,\n            ''  # Remove fragment\n        ))\n        return cleaned_url\n    \n    # If no 'v' parameter, return original (might be a youtu.be short link)\n    return link\n\n@app.route('/submit', methods=['GET', 'POST'])\n@login_required\ndef submit_video_download():\n    \"\"\"Download YouTube video using PyTubeFix\"\"\"\n    try:\n        # Get link from either query parameter (GET) or form data (POST)\n        link = request.args.get('link') or request.form.get('link', '')\n        link = link.strip()\n        \n        if not link:\n            flash('Please provide a valid YouTube URL', 'error')\n            return redirect(url_for('video_downloader_home'))\n        \n        # Create downloads directory\n        downloads_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'video_downloads')\n        os.makedirs(downloads_dir, exist_ok=True)\n        \n        # Clean old downloads (keep only last 3 files)\n        existing_files = os.listdir(downloads_dir)\n        if len(existing_files) > 3:\n            for f in existing_files:\n                os.remove(os.path.join(downloads_dir, f))\n        \n        clean = clean_youtube_url(link)\n        yt = YouTube(clean)\n        \n        stream = yt.streams.get_lowest_resolution()\n        filename = f\"video_{datetime.now().strftime('%Y%m%d_%H%M%S')}.mp4\"\n        out_file = stream.download(output_path=downloads_dir, filename=filename)\n        \n        return send_from_directory(downloads_dir, filename, as_attachment=True)\n    \n    except Exception as e:\n        logging.error(f\"Error downloading video: {e}\")\n        flash(f'Error downloading video: {str(e)}', 'error')\n        return redirect(url_for('video_downloader_home'))\n\n@app.route('/submit_audio', methods=['GET', 'POST'])\n@login_required\ndef submit_audio_download():\n    \"\"\"Download YouTube audio using PyTubeFix\"\"\"\n    try:\n        # Get link from either query parameter (GET) or form data (POST)\n        link = request.args.get('link') or request.form.get('link', '')\n        link = link.strip()\n        \n        if not link:\n            flash('Please provide a valid YouTube URL', 'error')\n            return redirect(url_for('video_downloader_home'))\n        \n        # Create downloads directory\n        downloads_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'audio_downloads')\n        os.makedirs(downloads_dir, exist_ok=True)\n        \n        # Clean old downloads (keep only last 5 files)\n        existing_files = os.listdir(downloads_dir)\n        if len(existing_files) > 5:\n            for f in existing_files:\n                os.remove(os.path.join(downloads_dir, f))\n        \n        clean = clean_youtube_url(link)\n        yt = YouTube(clean)\n        \n        audio_stream = yt.streams.filter(only_audio=True).first()\n        filename = f\"audio_{datetime.now().strftime('%Y%m%d_%H%M%S')}.mp3\"\n        out_file = audio_stream.download(output_path=downloads_dir, filename=filename)\n        \n        # If ffmpeg is available, convert to proper MP3\n        # Otherwise, just rename the file\n        try:\n            import subprocess\n            final_file = out_file.replace('.mp3', '_final.mp3')\n            subprocess.run(['ffmpeg', '-y', '-i', out_file, '-c:a', 'libmp3lame', final_file], \n                         check=True, capture_output=True)\n            os.remove(out_file)\n            out_file = final_file\n            filename = os.path.basename(final_file)\n        except:\n            # ffmpeg not available, use original file\n            pass\n        \n        return send_from_directory(downloads_dir, filename, as_attachment=True)\n    \n    except Exception as e:\n        logging.error(f\"Error downloading audio: {e}\")\n        flash(f'Error downloading audio: {str(e)}', 'error')\n        return redirect(url_for('video_downloader_home'))\n\n# QUIZ SYSTEM ROUTES - API ENDPOINT FOR AI MCQ GENERATION\n@app.route('/api/generate-mcq-options', methods=['POST'])\n@login_required\ndef generate_mcq_options():\n    \"\"\"Generate MCQ options and correct answer using AI Gemini\"\"\"\n    try:\n        data = request.get_json()\n        question = data.get('question', '').strip()\n        context = data.get('context', '').strip()\n        \n        if not question or len(question) < 5:\n            return jsonify({'success': False, 'error': 'Question too short'}), 400\n        \n        # Generate MCQ options using Gemini AI\n        result = gemini_ai.generate_mcq_options(question, context)\n        \n        if result and 'options' in result:\n            return jsonify({\n                'success': True,\n                'options': {\n                    'option_a': result['options'].get('A', ''),\n                    'option_b': result['options'].get('B', ''),\n                    'option_c': result['options'].get('C', ''),\n                    'option_d': result['options'].get('D', ''),\n                    'correct_answer': result.get('correct_answer', 'A'),\n                    'explanation': result.get('explanation', '')\n                }\n            })\n        else:\n            return jsonify({'success': False, 'error': 'Failed to generate options'}), 500\n            \n    except Exception as e:\n        logging.error(f\"Error generating MCQ options: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/generate-ai', methods=['POST'])\n@instructor_required\ndef instructor_generate_ai_quiz(course_id):\n    \"\"\"Generate MCQ quiz questions using AI from a topic and save directly to database\"\"\"\n    try:\n        data = request.get_json()\n        title = data.get('title', '').strip()\n        topic = data.get('topic', '').strip()\n        num_questions = int(data.get('num_questions', 5))\n        difficulty = data.get('difficulty', 'medium')\n        \n        if not title or len(title) < 3:\n            return jsonify({'success': False, 'message': 'Please enter a quiz title.'}), 400\n        \n        if not topic or len(topic) < 3:\n            return jsonify({'success': False, 'message': 'Please enter a topic.'}), 400\n        \n        # Support up to 100 questions per quiz\n        if num_questions < 1 or num_questions > 100:\n            num_questions = min(max(num_questions, 1), 100)\n        \n        # Generate questions using Gemini AI\n        try:\n            questions = gemini_ai.generate_mcq_quiz(topic, num_questions, difficulty)\n        except ValueError as ve:\n            logging.error(f\"Gemini API configuration error: {ve}\")\n            return jsonify({'success': False, 'message': f'Configuration Error: {str(ve)}'}), 500\n        except Exception as e:\n            logging.error(f\"Error generating quiz: {e}\")\n            return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500\n        \n        if not questions or len(questions) == 0:\n            return jsonify({'success': False, 'message': 'No questions were generated. Please try a different topic or try again.'}), 500\n        \n        # Create quiz directly in database\n        with db_lock:\n            conn = get_db_connection()\n            \n            # Verify course belongs to instructor\n            course = conn.execute('SELECT * FROM courses WHERE id = ? AND instructor_id = ?', \n                                (course_id, current_user.id)).fetchone()\n            \n            if not course:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Course not found or access denied.'}), 403\n            \n            try:\n                # Create the quiz/assignment\n                total_points = len(questions)  # 1 point per question by default\n                cursor = conn.execute('''\n                    INSERT INTO assignments (course_id, title, description, instructions, max_points)\n                    VALUES (?, ?, ?, ?, ?)\n                ''', (\n                    course_id, \n                    title,\n                    f\"AI-generated quiz on {topic} ({difficulty} difficulty)\",\n                    \"Answer all multiple choice questions. Each question is worth 1 point.\",\n                    total_points\n                ))\n                \n                assignment_id = cursor.lastrowid\n                \n                # Save all generated questions\n                for q in questions:\n                    # Insert question\n                    cursor = conn.execute('''\n                        INSERT INTO quiz_questions (assignment_id, question_text, question_type, points, correct_answer, explanation)\n                        VALUES (?, ?, 'mcq', ?, ?, ?)\n                    ''', (assignment_id, q['question'], 1, q['correct_answer'], q.get('explanation', '')))\n                    \n                    question_id = cursor.lastrowid\n                    \n                    # Insert options\n                    for option_letter, option_text in q['options'].items():\n                        is_correct = (option_letter == q['correct_answer'])\n                        conn.execute('''\n                            INSERT INTO question_options (question_id, option_letter, option_text, is_correct)\n                            VALUES (?, ?, ?, ?)\n                        ''', (question_id, option_letter, option_text, is_correct))\n                \n                conn.commit()\n                \n                logging.info(f\"AI Quiz '{topic}' created with {len(questions)} questions (ID: {assignment_id})\")\n                \n                conn.close()\n                \n                return jsonify({\n                    'success': True,\n                    'message': f'Quiz created with {len(questions)} questions! You can now edit and submit to students.',\n                    'quiz_id': assignment_id,\n                    'redirect_url': url_for('instructor_edit_quiz', course_id=course_id, quiz_id=assignment_id)\n                })\n                \n            except Exception as e:\n                conn.rollback()\n                conn.close()\n                logging.error(f\"Error saving AI quiz: {e}\")\n                return jsonify({'success': False, 'message': f'Error saving quiz: {str(e)}'}), 500\n        \n    except ValueError as ve:\n        logging.error(f\"Gemini API Key Error: {ve}\")\n        return jsonify({'success': False, 'message': 'Gemini API not configured. Please set GEMINI_API_KEY.'}), 500\n    except Exception as e:\n        logging.error(f\"Error generating AI quiz: {e}\")\n        return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500\n\n@app.route('/instructor/courses/<int:course_id>/quizzes')\n@instructor_required\ndef instructor_course_quizzes(course_id):\n    \"\"\"Manage course quizzes\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get quizzes (using assignments table)\n        quizzes = conn.execute('''\n            SELECT a.*, COUNT(s.id) as submission_count\n            FROM assignments a\n            LEFT JOIN assignment_submissions s ON a.id = s.assignment_id\n            WHERE a.course_id = ?\n            GROUP BY a.id\n            ORDER BY a.created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/course_quizzes.html', course=course, quizzes=quizzes)\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/create', methods=['GET', 'POST'])\n@instructor_required\ndef instructor_create_quiz(course_id):\n    \"\"\"Create a new quiz\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        if request.method == 'POST':\n            # Validate CSRF token\n            csrf_token = request.form.get('csrf_token')\n            if not validate_csrf_token(csrf_token):\n                flash('Invalid security token. Please try again.', 'error')\n                conn.close()\n                return redirect(url_for('instructor_create_quiz', course_id=course_id))\n            \n            title = request.form.get('title', '').strip()\n            description = request.form.get('description', '').strip()\n            instructions = request.form.get('instructions', '').strip()\n            due_date = request.form.get('due_date') or None\n            max_points = int(request.form.get('max_points', 100))\n            \n            try:\n                # Create the quiz/assignment\n                cursor = conn.execute('''\n                    INSERT INTO assignments (course_id, title, description, instructions, due_date, max_points)\n                    VALUES (?, ?, ?, ?, ?, ?)\n                ''', (course_id, title, description, instructions, due_date, max_points))\n                \n                assignment_id = cursor.lastrowid\n                total_points = 0\n                \n                # Process MCQ questions\n                questions_data = {}\n                for key in request.form.keys():\n                    if key.startswith('questions[') and '][text]' in key:\n                        # Extract question number\n                        question_num = key.split('[')[1].split(']')[0]\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        questions_data[question_num]['text'] = request.form.get(key, '').strip()\n                    elif key.startswith('questions[') and '][correct]' in key:\n                        question_num = key.split('[')[1].split(']')[0]\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        questions_data[question_num]['correct'] = request.form.get(key)\n                    elif key.startswith('questions[') and '][explanation]' in key:\n                        question_num = key.split('[')[1].split(']')[0]\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        questions_data[question_num]['explanation'] = request.form.get(key, '').strip()\n                    elif key.startswith('questions[') and '][points]' in key:\n                        question_num = key.split('[')[1].split(']')[0]\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        questions_data[question_num]['points'] = int(request.form.get(key, 1))\n                    elif key.startswith('questions[') and '][option_' in key:\n                        question_num = key.split('[')[1].split(']')[0]\n                        option_letter = key.split('option_')[1].split(']')[0].upper()\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        if 'options' not in questions_data[question_num]:\n                            questions_data[question_num]['options'] = {}\n                        questions_data[question_num]['options'][option_letter] = request.form.get(key, '').strip()\n                \n                # Save questions and options\n                questions_saved = 0\n                for question_num, question_data in questions_data.items():\n                    if 'text' in question_data and question_data['text']:\n                        # Use instructor-selected correct answer\n                        correct_answer = question_data.get('correct', 'A')\n                        \n                        # Insert question with instructor-selected or AI-generated correct answer\n                        cursor = conn.execute('''\n                            INSERT INTO quiz_questions (assignment_id, question_text, question_type, points, correct_answer, explanation)\n                            VALUES (?, ?, 'mcq', ?, ?, ?)\n                        ''', (assignment_id, question_data['text'], question_data.get('points', 1), \n                             correct_answer, question_data.get('explanation', '')))\n                        \n                        question_id = cursor.lastrowid\n                        total_points += question_data.get('points', 1)\n                        questions_saved += 1\n                        \n                        # Insert options with instructor-selected correct answer\n                        for option_letter, option_text in question_data.get('options', {}).items():\n                            if option_text:\n                                is_correct = (option_letter == correct_answer)\n                                conn.execute('''\n                                    INSERT INTO question_options (question_id, option_letter, option_text, is_correct)\n                                    VALUES (?, ?, ?, ?)\n                                ''', (question_id, option_letter, option_text, is_correct))\n                \n                # Update assignment with calculated total points\n                conn.execute('''\n                    UPDATE assignments SET max_points = ? WHERE id = ?\n                ''', (total_points, assignment_id))\n                \n                conn.commit()\n                \n                if questions_saved > 0:\n                    flash(f'âœ… MCQ Quiz \"{title}\" created successfully with {questions_saved} questions and submitted to all enrolled students!', 'success')\n                    logging.info(f\"Quiz '{title}' created with {questions_saved} questions for course {course_id}\")\n                else:\n                    flash('âš ï¸ Quiz created but no questions were saved. Please add questions and try again.', 'warning')\n                \n                return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n                \n            except Exception as e:\n                conn.rollback()\n                flash('Error creating quiz. Please try again.', 'error')\n        \n        conn.close()\n    \n    return render_template('instructor/create_quiz.html', course=course)\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/<int:quiz_id>/results')\n@instructor_required\ndef instructor_quiz_results(course_id, quiz_id):\n    \"\"\"View quiz results and submissions\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course ownership and quiz\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            WHERE a.id = ? AND a.course_id = ? AND c.instructor_id = ?\n        ''', (quiz_id, course_id, current_user.id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n        \n        # Get all submissions for this quiz\n        submissions = conn.execute('''\n            SELECT s.*, u.full_name as student_name, u.username\n            FROM assignment_submissions s\n            JOIN users u ON s.student_id = u.id\n            WHERE s.assignment_id = ?\n            ORDER BY s.submitted_at DESC\n        ''', (quiz_id,)).fetchall()\n        \n        # Get basic stats\n        stats = {\n            'total_submissions': len(submissions),\n            'graded_count': len([s for s in submissions if s['grade'] is not None]),\n            'average_grade': sum(s['grade'] for s in submissions if s['grade'] is not None) / max(1, len([s for s in submissions if s['grade'] is not None])) if submissions else 0\n        }\n        \n        conn.close()\n    \n    return render_template('instructor/quiz_results.html', quiz=quiz, submissions=submissions, stats=stats)\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/<int:quiz_id>/edit', methods=['GET', 'POST'])\n@instructor_required\ndef instructor_edit_quiz(course_id, quiz_id):\n    \"\"\"Edit existing quiz\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course ownership and quiz\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            WHERE a.id = ? AND a.course_id = ? AND c.instructor_id = ?\n        ''', (quiz_id, course_id, current_user.id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n        \n        if request.method == 'POST':\n            title = request.form.get('title', '').strip()\n            description = request.form.get('description', '').strip()\n            instructions = request.form.get('instructions', '').strip()\n            due_date = request.form.get('due_date') or None\n            max_points = int(request.form.get('max_points', 100))\n            \n            try:\n                conn.execute('''\n                    UPDATE assignments \n                    SET title = ?, description = ?, instructions = ?, due_date = ?, max_points = ?\n                    WHERE id = ?\n                ''', (title, description, instructions, due_date, max_points, quiz_id))\n                \n                # Update MCQ questions if provided\n                questions = conn.execute('SELECT id FROM quiz_questions WHERE assignment_id = ?', (quiz_id,)).fetchall()\n                for idx, q in enumerate(questions):\n                    q_id = q['id']\n                    q_text = request.form.get(f'question_{idx}_text', '').strip()\n                    explanation = request.form.get(f'question_{idx}_explanation', '').strip()\n                    correct = request.form.get(f'question_{idx}_correct', 'A')\n                    \n                    if q_text:\n                        conn.execute('''\n                            UPDATE quiz_questions \n                            SET question_text = ?, explanation = ?, correct_answer = ?\n                            WHERE id = ?\n                        ''', (q_text, explanation, correct, q_id))\n                        \n                        # Update options\n                        for letter in ['A', 'B', 'C', 'D']:\n                            option_text = request.form.get(f'question_{idx}_option_{letter}', '').strip()\n                            if option_text:\n                                conn.execute('''\n                                    UPDATE question_options \n                                    SET option_text = ?, is_correct = ?\n                                    WHERE question_id = ? AND option_letter = ?\n                                ''', (option_text, (letter == correct), q_id, letter))\n                \n                conn.commit()\n                flash(f'Quiz \"{title}\" updated successfully!', 'success')\n                return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n                \n            except Exception as e:\n                conn.rollback()\n                flash('Error updating quiz. Please try again.', 'error')\n        \n        # Fetch questions for editing\n        questions = conn.execute('''\n            SELECT q.id, q.question_text, q.correct_answer, q.explanation,\n                   q.points FROM quiz_questions q\n            WHERE q.assignment_id = ?\n            ORDER BY q.id\n        ''', (quiz_id,)).fetchall()\n        \n        # Fetch options for each question\n        questions_list = []\n        for q in questions:\n            options = conn.execute('''\n                SELECT option_letter, option_text FROM question_options\n                WHERE question_id = ? ORDER BY option_letter\n            ''', (q['id'],)).fetchall()\n            questions_list.append({\n                'id': q['id'],\n                'text': q['question_text'],\n                'correct': q['correct_answer'],\n                'explanation': q['explanation'],\n                'points': q['points'],\n                'options': {opt['option_letter']: opt['option_text'] for opt in options}\n            })\n        \n        conn.close()\n    \n    return render_template('instructor/edit_quiz.html', quiz=quiz, questions=questions_list)\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/<int:quiz_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_quiz(course_id, quiz_id):\n    \"\"\"Delete a quiz and all associated data\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course ownership and quiz\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            WHERE a.id = ? AND a.course_id = ? AND c.instructor_id = ?\n        ''', (quiz_id, course_id, current_user.id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n        \n        try:\n            # Delete quiz questions first\n            conn.execute('DELETE FROM quiz_questions WHERE assignment_id = ?', (quiz_id,))\n            \n            # Delete student MCQ answers\n            conn.execute('''\n                DELETE FROM student_mcq_answers \n                WHERE submission_id IN (\n                    SELECT id FROM assignment_submissions WHERE assignment_id = ?\n                )\n            ''', (quiz_id,))\n            \n            # Delete submissions\n            conn.execute('DELETE FROM assignment_submissions WHERE assignment_id = ?', (quiz_id,))\n            \n            # Delete the quiz itself\n            conn.execute('DELETE FROM assignments WHERE id = ?', (quiz_id,))\n            \n            conn.commit()\n            flash(f'Quiz \"{quiz[\"title\"]}\" and all associated data deleted successfully.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error deleting quiz. Please try again.', 'error')\n            print(f\"Delete quiz error: {e}\")\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/<int:quiz_id>/analytics')\n@instructor_required\ndef instructor_quiz_analytics(course_id, quiz_id):\n    \"\"\"Basic quiz analytics\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course ownership and quiz\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            WHERE a.id = ? AND a.course_id = ? AND c.instructor_id = ?\n        ''', (quiz_id, course_id, current_user.id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n        \n        # Get enrollment count for completion rate\n        enrolled_students = conn.execute('''\n            SELECT COUNT(*) as count FROM enrollments \n            WHERE course_id = ? AND status = 'approved'\n        ''', (course_id,)).fetchone()['count']\n        \n        # Get submission analytics\n        submissions = conn.execute('''\n            SELECT grade FROM assignment_submissions \n            WHERE assignment_id = ? AND grade IS NOT NULL\n        ''', (quiz_id,)).fetchall()\n        \n        grades = [s['grade'] for s in submissions]\n        analytics = {\n            'enrolled_students': enrolled_students,\n            'submission_count': len(submissions),\n            'completion_rate': (len(submissions) / max(1, enrolled_students)) * 100,\n            'average_grade': sum(grades) / max(1, len(grades)) if grades else 0,\n            'highest_grade': max(grades) if grades else 0,\n            'lowest_grade': min(grades) if grades else 0,\n            'grade_distribution': {\n                'A (90-100)': len([g for g in grades if g >= 90]),\n                'B (80-89)': len([g for g in grades if 80 <= g < 90]),\n                'C (70-79)': len([g for g in grades if 70 <= g < 80]),\n                'D (60-69)': len([g for g in grades if 60 <= g < 70]),\n                'F (0-59)': len([g for g in grades if g < 60])\n            }\n        }\n        \n        conn.close()\n    \n    return render_template('instructor/quiz_analytics.html', quiz=quiz, analytics=analytics)\n\n# DISCUSSION FORUMS ROUTES\n@app.route('/instructor/courses/<int:course_id>/discussions')\n@instructor_required\ndef instructor_course_discussions(course_id):\n    \"\"\"Manage course discussion forums\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get course forums and recent topics\n        forums = conn.execute('''\n            SELECT f.*, COUNT(t.id) as topic_count\n            FROM forums f\n            LEFT JOIN forum_topics t ON f.id = t.forum_id\n            WHERE f.course_id = ? AND f.is_active = 1\n            GROUP BY f.id\n            ORDER BY f.created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get recent forum activity\n        recent_topics = conn.execute('''\n            SELECT t.*, u.full_name as author_name, f.title as forum_title,\n                   COUNT(r.id) as reply_count\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            JOIN forums f ON t.forum_id = f.id\n            LEFT JOIN forum_replies r ON t.id = r.topic_id\n            WHERE f.course_id = ?\n            GROUP BY t.id\n            ORDER BY t.created_at DESC\n            LIMIT 10\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/course_discussions.html', \n                         course=course, forums=forums, recent_topics=recent_topics)\n\n@app.route('/instructor/courses/<int:course_id>/forums/create', methods=['POST'])\n@instructor_required\ndef instructor_create_forum(course_id):\n    \"\"\"Create a new discussion forum\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        description = request.form.get('description', '').strip()\n        \n        if not title:\n            flash('Forum title is required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forums (course_id, title, description)\n                VALUES (?, ?, ?)\n            ''', (course_id, title, description))\n            \n            conn.commit()\n            flash(f'Discussion forum \"{title}\" created successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error creating forum. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_discussions', course_id=course_id))\n\n@app.route('/instructor/courses/<int:course_id>/topics/create', methods=['POST'])\n@instructor_required\ndef instructor_create_topic(course_id):\n    \"\"\"Create a new discussion topic\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        forum_id = request.form.get('forum_id')\n        title = request.form.get('title', '').strip()\n        content = request.form.get('content', '').strip()\n        is_pinned = bool(request.form.get('is_pinned'))\n        \n        if not title or not content or not forum_id:\n            flash('Topic title, content, and forum selection are required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forum_topics (forum_id, user_id, title, content, is_pinned)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (forum_id, current_user.id, title, content, is_pinned))\n            \n            conn.commit()\n            flash(f'Discussion topic \"{title}\" created successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error creating topic. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_discussions', course_id=course_id))\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/topics')\n@instructor_required\ndef instructor_forum_topics(course_id, forum_id):\n    \"\"\"View all topics in a forum\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor or admin\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND (instructor_id = ? OR ? = 1) AND is_active = 1\n        ''', (course_id, current_user.id, current_user.is_admin())).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        # Get all topics in this forum\n        topics = conn.execute('''\n            SELECT t.*, u.full_name as author_name, COUNT(r.id) as reply_count,\n                   MAX(COALESCE(r.created_at, t.created_at)) as last_activity\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            LEFT JOIN forum_replies r ON t.id = r.topic_id\n            WHERE t.forum_id = ?\n            GROUP BY t.id\n            ORDER BY t.is_pinned DESC, last_activity DESC\n        ''', (forum_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/forum_topics.html', \n                         course=course, forum=forum, topics=topics)\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/topics/<int:topic_id>')\n@instructor_required\ndef instructor_topic_detail(course_id, forum_id, topic_id):\n    \"\"\"View topic details with replies\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor or admin\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND (instructor_id = ? OR ? = 1) AND is_active = 1\n        ''', (course_id, current_user.id, current_user.is_admin())).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        # Get topic details\n        topic = conn.execute('''\n            SELECT t.*, u.full_name as author_name, u.role as author_role\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            WHERE t.id = ? AND t.forum_id = ?\n        ''', (topic_id, forum_id)).fetchone()\n        \n        if not topic:\n            flash('Topic not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_forum_topics', course_id=course_id, forum_id=forum_id))\n        \n        # Get replies\n        replies = conn.execute('''\n            SELECT r.*, u.full_name as author_name, u.role as author_role\n            FROM forum_replies r\n            JOIN users u ON r.user_id = u.id\n            WHERE r.topic_id = ?\n            ORDER BY r.created_at ASC\n        ''', (topic_id,)).fetchall()\n        \n        # Update view count\n        conn.execute('UPDATE forum_topics SET view_count = view_count + 1 WHERE id = ?', (topic_id,))\n        conn.commit()\n        \n        conn.close()\n    \n    return render_template('instructor/topic_detail.html', \n                         course=course, forum=forum, topic=topic, replies=replies)\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/edit')\n@instructor_required\ndef instructor_edit_forum(course_id, forum_id):\n    \"\"\"Edit forum form\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get forum details\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        conn.close()\n    \n    return render_template('instructor/edit_forum.html', course=course, forum=forum)\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/update', methods=['POST'])\n@instructor_required\ndef instructor_update_forum(course_id, forum_id):\n    \"\"\"Update forum details\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        description = request.form.get('description', '').strip()\n        \n        if not title:\n            flash('Forum title is required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_edit_forum', course_id=course_id, forum_id=forum_id))\n        \n        try:\n            conn.execute('''\n                UPDATE forums \n                SET title = ?, description = ?\n                WHERE id = ? AND course_id = ?\n            ''', (title, description, forum_id, course_id))\n            \n            conn.commit()\n            flash(f'Forum \"{title}\" updated successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error updating forum. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_discussions', course_id=course_id))\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_forum(course_id, forum_id):\n    \"\"\"Delete forum (soft delete)\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        try:\n            # Soft delete forum\n            conn.execute('''\n                UPDATE forums \n                SET is_active = 0\n                WHERE id = ? AND course_id = ?\n            ''', (forum_id, course_id))\n            \n            conn.commit()\n            flash('Forum deleted successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error deleting forum. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_discussions', course_id=course_id))\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/topics/<int:topic_id>/reply', methods=['POST'])\n@instructor_required\ndef instructor_create_reply(course_id, forum_id, topic_id):\n    \"\"\"Create a reply to a discussion topic\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor or admin\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND (instructor_id = ? OR ? = 1) AND is_active = 1\n        ''', (course_id, current_user.id, current_user.is_admin())).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Verify forum and topic exist\n        topic = conn.execute('''\n            SELECT t.*, f.course_id\n            FROM forum_topics t\n            JOIN forums f ON t.forum_id = f.id\n            WHERE t.id = ? AND t.forum_id = ? AND f.course_id = ? AND f.is_active = 1\n        ''', (topic_id, forum_id, course_id)).fetchone()\n        \n        if not topic:\n            flash('Topic not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        content = request.form.get('content', '').strip()\n        \n        if not content:\n            flash('Reply content is required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_topic_detail', course_id=course_id, forum_id=forum_id, topic_id=topic_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forum_replies (topic_id, user_id, content)\n                VALUES (?, ?, ?)\n            ''', (topic_id, current_user.id, content))\n            \n            conn.commit()\n            flash('Reply posted successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error posting reply. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_topic_detail', course_id=course_id, forum_id=forum_id, topic_id=topic_id))\n\n\n# STUDENT CONTENT ACCESS ROUTES\n@app.route('/student/courses/<int:course_id>')\n@login_required\ndef student_course_view(course_id):\n    \"\"\"View course content as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.*, u.full_name as instructor_name,\n                   COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get course content\n        resources = conn.execute('''\n            SELECT * FROM course_resources \n            WHERE course_id = ?\n            ORDER BY upload_date DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get meeting links\n        meeting_links = conn.execute('''\n            SELECT * FROM course_meeting_links \n            WHERE course_id = ? AND is_active = 1\n            ORDER BY created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get video playlist\n        video_playlist = conn.execute('''\n            SELECT * FROM course_video_playlists \n            WHERE course_id = ? AND is_active = 1\n            ORDER BY order_index ASC\n        ''', (course_id,)).fetchall()\n        \n        # Get quizzes\n        quizzes = conn.execute('''\n            SELECT a.*, s.grade, s.submitted_at\n            FROM assignments a\n            LEFT JOIN assignment_submissions s ON a.id = s.assignment_id AND s.student_id = ?\n            WHERE a.course_id = ?\n            ORDER BY a.created_at DESC\n        ''', (current_user.id, course_id)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/course_view.html', \n                         enrollment=enrollment, course=enrollment, resources=resources, quizzes=quizzes,\n                         meeting_links=meeting_links, video_playlist=video_playlist)\n\n# STUDENT FORUM ACCESS ROUTES\n@app.route('/student/courses/<int:course_id>/forums')\n@login_required\ndef student_course_forums(course_id):\n    \"\"\"View course forums as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.*, u.full_name as instructor_name,\n                   COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get course forums and recent topics\n        forums = conn.execute('''\n            SELECT f.*, COUNT(t.id) as topic_count\n            FROM forums f\n            LEFT JOIN forum_topics t ON f.id = t.forum_id\n            WHERE f.course_id = ? AND f.is_active = 1\n            GROUP BY f.id\n            ORDER BY f.created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get recent forum activity\n        recent_topics = conn.execute('''\n            SELECT t.*, u.full_name as author_name, f.title as forum_title,\n                   COUNT(r.id) as reply_count\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            JOIN forums f ON t.forum_id = f.id\n            LEFT JOIN forum_replies r ON t.id = r.topic_id\n            WHERE f.course_id = ?\n            GROUP BY t.id\n            ORDER BY t.created_at DESC\n            LIMIT 10\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/course_forums.html', \n                         course=enrollment, forums=forums, recent_topics=recent_topics)\n\n@app.route('/student/courses/<int:course_id>/forums/<int:forum_id>/topics')\n@login_required\ndef student_forum_topics(course_id, forum_id):\n    \"\"\"View all topics in a forum as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.*, u.full_name as instructor_name,\n                   COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        \n        # Get all topics in this forum\n        topics = conn.execute('''\n            SELECT t.*, u.full_name as author_name, COUNT(r.id) as reply_count,\n                   MAX(COALESCE(r.created_at, t.created_at)) as last_activity\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            LEFT JOIN forum_replies r ON t.id = r.topic_id\n            WHERE t.forum_id = ?\n            GROUP BY t.id\n            ORDER BY t.is_pinned DESC, last_activity DESC\n        ''', (forum_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/forum_topics.html', \n                         course=enrollment, forum=forum, topics=topics)\n\n@app.route('/student/courses/<int:course_id>/forums/<int:forum_id>/topics/<int:topic_id>')\n@login_required\ndef student_topic_detail(course_id, forum_id, topic_id):\n    \"\"\"View topic details with replies as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.*, u.full_name as instructor_name,\n                   COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        \n        # Get topic details\n        topic = conn.execute('''\n            SELECT t.*, u.full_name as author_name, u.role as author_role\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            WHERE t.id = ? AND t.forum_id = ?\n        ''', (topic_id, forum_id)).fetchone()\n        \n        if not topic:\n            flash('Topic not found.', 'error')\n            conn.close()\n            return redirect(url_for('student_forum_topics', course_id=course_id, forum_id=forum_id))\n        \n        # Get replies\n        replies = conn.execute('''\n            SELECT r.*, u.full_name as author_name, u.role as author_role\n            FROM forum_replies r\n            JOIN users u ON r.user_id = u.id\n            WHERE r.topic_id = ?\n            ORDER BY r.created_at ASC\n        ''', (topic_id,)).fetchall()\n        \n        # Update view count\n        conn.execute('UPDATE forum_topics SET view_count = view_count + 1 WHERE id = ?', (topic_id,))\n        conn.commit()\n        \n        conn.close()\n    \n    return render_template('student/topic_detail.html', \n                         course=enrollment, forum=forum, topic=topic, replies=replies)\n\n@app.route('/student/courses/<int:course_id>/forums/<int:forum_id>/topics/<int:topic_id>/reply', methods=['POST'])\n@login_required\ndef student_create_reply(course_id, forum_id, topic_id):\n    \"\"\"Create a reply to a discussion topic as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.status FROM enrollments e\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Verify forum and topic exist\n        topic = conn.execute('''\n            SELECT t.*, f.course_id\n            FROM forum_topics t\n            JOIN forums f ON t.forum_id = f.id\n            WHERE t.id = ? AND t.forum_id = ? AND f.course_id = ? AND f.is_active = 1\n        ''', (topic_id, forum_id, course_id)).fetchone()\n        \n        if not topic:\n            flash('Topic not found.', 'error')\n            conn.close()\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        \n        content = request.form.get('content', '').strip()\n        \n        if not content:\n            flash('Reply content is required.', 'error')\n            conn.close()\n            return redirect(url_for('student_topic_detail', course_id=course_id, forum_id=forum_id, topic_id=topic_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forum_replies (topic_id, user_id, content)\n                VALUES (?, ?, ?)\n            ''', (topic_id, current_user.id, content))\n            \n            conn.commit()\n            flash('Reply posted successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error posting reply. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('student_topic_detail', course_id=course_id, forum_id=forum_id, topic_id=topic_id))\n\n@app.route('/student/courses/<int:course_id>/forums/<int:forum_id>/topics/create', methods=['POST'])\n@login_required\ndef student_create_topic(course_id, forum_id):\n    \"\"\"Create a new discussion topic as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.status FROM enrollments e\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        \n        title = request.form.get('title', '').strip()\n        content = request.form.get('content', '').strip()\n        \n        if not title or not content:\n            flash('Topic title and content are required.', 'error')\n            conn.close()\n            return redirect(url_for('student_forum_topics', course_id=course_id, forum_id=forum_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forum_topics (forum_id, user_id, title, content, is_pinned)\n                VALUES (?, ?, ?, ?, 0)\n            ''', (forum_id, current_user.id, title, content))\n            \n            conn.commit()\n            flash(f'Discussion topic \"{title}\" created successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error creating topic. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('student_forum_topics', course_id=course_id, forum_id=forum_id))\n\n@app.route('/uploads/instructor_screenshots/<filename>')\n@login_required\n@admin_required\ndef instructor_screenshot(filename):\n    \"\"\"Serve instructor screenshot files (admin only)\"\"\"\n    screenshots_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'instructor_screenshots')\n    return send_from_directory(screenshots_dir, filename)\n\n@app.route('/student/courses/<int:course_id>/resource/<int:resource_id>')\n@login_required\ndef student_download_resource(course_id, resource_id):\n    \"\"\"Secure file download for enrolled students\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved in the course\n        enrollment = conn.execute('''\n            SELECT e.status FROM enrollments e\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Access denied. You are not enrolled in this course.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get the resource and verify it belongs to this course\n        resource = conn.execute('''\n            SELECT * FROM course_resources \n            WHERE id = ? AND course_id = ?\n        ''', (resource_id, course_id)).fetchone()\n        \n        conn.close()\n        \n        if not resource:\n            flash('Resource not found.', 'error')\n            return redirect(url_for('student_course_view', course_id=course_id))\n        \n        # Serve the file securely\n        try:\n            return send_from_directory(\n                os.path.dirname(resource['file_path']),\n                os.path.basename(resource['file_path']),\n                as_attachment=False\n            )\n        except FileNotFoundError:\n            flash('File not found on server.', 'error')\n            return redirect(url_for('student_course_view', course_id=course_id))\n\n@app.route('/student/quiz/<int:quiz_id>')\n@login_required\ndef student_take_quiz(quiz_id):\n    \"\"\"Take a quiz with MCQ questions\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled in the course\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title, e.status as enrollment_status\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            LEFT JOIN enrollments e ON c.id = e.course_id AND e.student_id = ?\n            WHERE a.id = ? AND e.status = 'approved'\n        ''', (current_user.id, quiz_id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Check if already submitted\n        submission = conn.execute('''\n            SELECT * FROM assignment_submissions \n            WHERE assignment_id = ? AND student_id = ?\n        ''', (quiz_id, current_user.id)).fetchone()\n        \n        # Get MCQ questions and options\n        questions = conn.execute('''\n            SELECT q.*, GROUP_CONCAT(\n                o.option_letter || '|' || o.option_text || '|' || o.is_correct, ':'\n            ) as options_data\n            FROM quiz_questions q\n            LEFT JOIN question_options o ON q.id = o.question_id\n            WHERE q.assignment_id = ?\n            GROUP BY q.id\n            ORDER BY q.id\n        ''', (quiz_id,)).fetchall()\n        \n        # Process questions and options\n        processed_questions = []\n        for question in questions:\n            question_dict = dict(question)\n            question_dict['options'] = {}\n            \n            if question['options_data']:\n                for option_data in question['options_data'].split(':'):\n                    if option_data:\n                        parts = option_data.split('|')\n                        if len(parts) >= 3:\n                            letter = parts[0]\n                            text = parts[1]\n                            is_correct = parts[2] == '1'\n                            question_dict['options'][letter] = {\n                                'text': text,\n                                'is_correct': is_correct\n                            }\n            \n            processed_questions.append(question_dict)\n        \n        # Get student's previous answers if any\n        student_answers = {}\n        if submission:\n            answers = conn.execute('''\n                SELECT question_id, selected_option \n                FROM student_mcq_answers \n                WHERE submission_id = ?\n            ''', (submission['id'],)).fetchall()\n            \n            for answer in answers:\n                student_answers[answer['question_id']] = answer['selected_option']\n        \n        conn.close()\n    \n    return render_template('student/take_quiz.html', \n                         quiz=quiz, \n                         submission=submission, \n                         questions=processed_questions,\n                         student_answers=student_answers)\n\n@app.route('/student/quiz/<int:quiz_id>/submit', methods=['POST'])\n@login_required\ndef student_submit_quiz(quiz_id):\n    \"\"\"Submit MCQ quiz answers\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify access\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title, e.status as enrollment_status\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            LEFT JOIN enrollments e ON c.id = e.course_id AND e.student_id = ?\n            WHERE a.id = ? AND e.status = 'approved'\n        ''', (current_user.id, quiz_id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get quiz questions for grading\n        questions = conn.execute('''\n            SELECT q.id, q.points, q.correct_answer\n            FROM quiz_questions q\n            WHERE q.assignment_id = ?\n            ORDER BY q.id\n        ''', (quiz_id,)).fetchall()\n        \n        try:\n            # Check if already submitted\n            existing = conn.execute('''\n                SELECT id FROM assignment_submissions \n                WHERE assignment_id = ? AND student_id = ?\n            ''', (quiz_id, current_user.id)).fetchone()\n            \n            # Calculate score from MCQ answers\n            total_score = 0\n            total_possible = 0\n            mcq_answers = []\n            \n            for question in questions:\n                question_key = f'question_{question[\"id\"]}'\n                selected_answer = request.form.get(question_key, '').strip()\n                \n                if selected_answer:\n                    is_correct = (selected_answer == question['correct_answer'])\n                    points_earned = question['points'] if is_correct else 0\n                    total_score += points_earned\n                    \n                    mcq_answers.append({\n                        'question_id': question['id'],\n                        'selected_option': selected_answer,\n                        'is_correct': is_correct,\n                        'points_earned': points_earned\n                    })\n                \n                total_possible += question['points']\n            \n            # Create submission text summary\n            submission_text = f\"MCQ Quiz Submission - {len(mcq_answers)} questions answered\"\n            \n            if existing:\n                # Update existing submission\n                conn.execute('''\n                    UPDATE assignment_submissions \n                    SET submission_text = ?, submitted_at = CURRENT_TIMESTAMP, grade = ?\n                    WHERE assignment_id = ? AND student_id = ?\n                ''', (submission_text, total_score, quiz_id, current_user.id))\n                \n                submission_id = existing['id']\n                \n                # Delete old MCQ answers\n                conn.execute('DELETE FROM student_mcq_answers WHERE submission_id = ?', (submission_id,))\n            else:\n                # Create new submission\n                cursor = conn.execute('''\n                    INSERT INTO assignment_submissions (assignment_id, student_id, submission_text, grade)\n                    VALUES (?, ?, ?, ?)\n                ''', (quiz_id, current_user.id, submission_text, total_score))\n                \n                submission_id = cursor.lastrowid\n            \n            # Save MCQ answers\n            for answer in mcq_answers:\n                conn.execute('''\n                    INSERT INTO student_mcq_answers \n                    (submission_id, question_id, selected_option, is_correct, points_earned)\n                    VALUES (?, ?, ?, ?, ?)\n                ''', (submission_id, answer['question_id'], answer['selected_option'], \n                     answer['is_correct'], answer['points_earned']))\n            \n            # Generate AI feedback\n            try:\n                ai_feedback = f\"Quiz completed! You scored {total_score}/{total_possible} ({(total_score / total_possible * 100) if total_possible > 0 else 0:.1f}%). You answered {sum(1 for ans in mcq_answers if ans['is_correct'])} out of {len(questions)} questions correctly.\"\n                \n                conn.execute('''\n                    UPDATE assignment_submissions \n                    SET ai_feedback = ?, graded_at = CURRENT_TIMESTAMP\n                    WHERE id = ?\n                ''', (ai_feedback, submission_id))\n                \n            except Exception as ai_error:\n                print(f\"AI feedback error: {ai_error}\")\n            \n            conn.commit()\n            \n            # Update student progress for this course\n            update_student_progress(conn, current_user.id, quiz['course_id'])\n            \n            percentage = (total_score / total_possible * 100) if total_possible > 0 else 0\n            flash(f'Quiz submitted successfully! Your score: {total_score}/{total_possible} ({percentage:.1f}%)', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error submitting quiz. Please try again.', 'error')\n            print(f\"Quiz submission error: {e}\")\n        \n        conn.close()\n    \n    return redirect(url_for('student_take_quiz', quiz_id=quiz_id))\n\n# RANKINGS ROUTES\n@app.route('/student/courses/<int:course_id>/rankings')\n@login_required\ndef student_course_rankings(course_id):\n    \"\"\"View course rankings based on quiz scores\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled\n        enrollment = conn.execute('''\n            SELECT * FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get rankings based on quiz scores\n        rankings = conn.execute('''\n            SELECT u.full_name, AVG(s.grade) as avg_score, COUNT(s.id) as quiz_count,\n                   RANK() OVER (ORDER BY AVG(s.grade) DESC) as rank\n            FROM users u\n            JOIN enrollments e ON u.id = e.student_id\n            JOIN assignment_submissions s ON u.id = s.student_id\n            JOIN assignments a ON s.assignment_id = a.id\n            WHERE e.course_id = ? AND e.status = 'approved' AND s.grade IS NOT NULL AND a.course_id = ?\n            GROUP BY u.id, u.full_name\n            HAVING quiz_count > 0\n            ORDER BY avg_score DESC\n        ''', (course_id, course_id)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/course_rankings.html', \n                         course=enrollment, rankings=rankings)\n\n# STUDENT ENROLLMENT ROUTES\n@app.route('/student/courses')\n@login_required\ndef student_browse_courses():\n    \"\"\"Browse available courses for enrollment\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get available courses (not already enrolled in)\n        available_courses = conn.execute('''\n            SELECT c.*, u.full_name as instructor_name,\n                   COUNT(e.id) as enrollment_count\n            FROM courses c\n            JOIN users u ON c.instructor_id = u.id\n            LEFT JOIN enrollments e ON c.id = e.course_id AND e.status = 'approved'\n            LEFT JOIN enrollments student_e ON c.id = student_e.course_id AND student_e.student_id = ?\n            WHERE c.is_active = 1 AND student_e.id IS NULL\n            GROUP BY c.id\n            ORDER BY c.created_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Get my enrollment requests\n        my_enrollments = conn.execute('''\n            SELECT e.*, c.title as course_title, c.course_code,\n                   u.full_name as instructor_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ?\n            ORDER BY e.enrolled_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/browse_courses.html', \n                         available_courses=available_courses,\n                         my_enrollments=my_enrollments)\n\n@app.route('/student/enroll', methods=['POST'])\n@login_required\ndef student_enroll():\n    \"\"\"Enroll in a course with enrollment key\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    course_code = request.form.get('course_code', '').strip().upper()\n    enrollment_key = request.form.get('enrollment_key', '').strip()\n    \n    if not course_code or not enrollment_key:\n        flash('Course code and enrollment key are required.', 'error')\n        return redirect(url_for('student_browse_courses'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Find the course\n        course = conn.execute('''\n            SELECT c.*, u.full_name as instructor_name\n            FROM courses c\n            JOIN users u ON c.instructor_id = u.id\n            WHERE c.course_code = ? AND c.is_active = 1\n        ''', (course_code,)).fetchone()\n        \n        if not course:\n            flash(f'Course with code \"{course_code}\" not found or is inactive.', 'error')\n            conn.close()\n            return redirect(url_for('student_browse_courses'))\n        \n        # Check if enrollment key is correct\n        if not course['enrollment_key_hash'] or not check_password_hash(course['enrollment_key_hash'], enrollment_key):\n            flash('Invalid enrollment key. Please check with your instructor.', 'error')\n            conn.close()\n            return redirect(url_for('student_browse_courses'))\n        \n        # Check if already enrolled\n        existing_enrollment = conn.execute('''\n            SELECT id FROM enrollments \n            WHERE student_id = ? AND course_id = ?\n        ''', (current_user.id, course['id'])).fetchone()\n        \n        if existing_enrollment:\n            flash('You have already requested enrollment for this course.', 'warning')\n            conn.close()\n            return redirect(url_for('student_browse_courses'))\n        \n        # Check course capacity\n        current_enrollments = conn.execute('''\n            SELECT COUNT(*) as count FROM enrollments \n            WHERE course_id = ? AND status = 'approved'\n        ''', (course['id'],)).fetchone()\n        \n        if current_enrollments['count'] >= course['max_students']:\n            flash('Course is full. No more enrollments accepted.', 'warning')\n            conn.close()\n            return redirect(url_for('student_browse_courses'))\n        \n        try:\n            # Create enrollment request\n            conn.execute('''\n                INSERT INTO enrollments (student_id, course_id, status)\n                VALUES (?, ?, 'pending')\n            ''', (current_user.id, course['id']))\n            \n            # Create notification for the instructor\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (course['instructor_id'],\n                  'New Enrollment Request',\n                  f'{current_user.full_name} has requested enrollment in \"{course[\"title\"]}\" ({course_code}). Please review and approve.',\n                  'info',\n                  course['id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Enrollment request submitted for \"{course[\"title\"]}\"! Your instructor ({course[\"instructor_name\"]}) will review and approve your request.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error submitting enrollment request. Please try again.', 'error')\n    \n    return redirect(url_for('student_browse_courses'))\n\n@app.route('/student/enrollments')\n@login_required\ndef student_my_enrollments():\n    \"\"\"View my enrollment status\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        enrollments = conn.execute('''\n            SELECT e.*, c.title as course_title, c.course_code, c.description,\n                   u.full_name as instructor_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ?\n            ORDER BY \n                CASE e.status \n                    WHEN 'pending' THEN 1\n                    WHEN 'approved' THEN 2\n                    WHEN 'rejected' THEN 3\n                END,\n                e.enrolled_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Statistics\n        stats = {\n            'total_enrollments': len(enrollments),\n            'pending_enrollments': len([e for e in enrollments if e['status'] == 'pending']),\n            'approved_enrollments': len([e for e in enrollments if e['status'] == 'approved']),\n            'rejected_enrollments': len([e for e in enrollments if e['status'] == 'rejected'])\n        }\n        \n        conn.close()\n    \n    return render_template('student/my_enrollments.html', \n                         enrollments=enrollments, \n                         stats=stats)\n\n# NEW FEATURE: Real-Time Discussion Forum (SMS-like messaging)\n@app.route('/course/<int:course_id>/discussion')\n@login_required\ndef course_discussion_forum(course_id):\n    \"\"\"Real-time discussion forum for course - SMS-like messaging between students and teachers\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify user has access to this course\n        course = conn.execute('SELECT * FROM courses WHERE id = ?', (course_id,)).fetchone()\n        \n        if not course:\n            flash('Course not found.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Check access\n        access = conn.execute('''\n            SELECT 1 FROM enrollments \n            WHERE student_id = ? AND course_id = ? AND status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        is_instructor = (current_user.id == course['instructor_id'])\n        \n        if not access and not is_instructor and not current_user.is_admin():\n            flash('You do not have access to this course.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get existing messages\n        messages = conn.execute('''\n            SELECT cm.*, u.full_name as sender_name, u.role as sender_role\n            FROM chat_messages cm\n            JOIN users u ON cm.sender_id = u.id\n            WHERE cm.course_id = ?\n            ORDER BY cm.created_at ASC\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('course_discussion.html', course=course, messages=messages)\n\n# Error handlers\n@app.errorhandler(404)\ndef not_found_error(error):\n    return render_template('errors/404.html'), 404\n\n@app.errorhandler(500)\ndef internal_error(error):\n    return render_template('errors/500.html'), 500\n\n# SocketIO events for real-time chat\n@socketio.on('connect')\ndef on_connect():\n    if not current_user.is_authenticated:\n        return False\n    join_room(f'user_{current_user.id}')\n    emit('status', {'msg': f'{current_user.full_name} has connected'})\n\n# NOTIFICATIONS ROUTES\n@app.route('/notifications')\n@login_required\ndef notifications():\n    \"\"\"View all notifications for current user\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        notifications = conn.execute('''\n            SELECT * FROM notifications \n            WHERE user_id = ? \n            ORDER BY created_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Mark all as read\n        conn.execute('''\n            UPDATE notifications \n            SET is_read = 1 \n            WHERE user_id = ? AND is_read = 0\n        ''', (current_user.id,))\n        \n        conn.commit()\n        conn.close()\n    \n    return render_template('notifications.html', notifications=notifications)\n\n@app.route('/api/notifications/unread-count')\n@login_required\ndef get_unread_notifications_count():\n    \"\"\"Get count of unread notifications\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            \n            result = conn.execute('''\n                SELECT COUNT(*) as count FROM notifications \n                WHERE user_id = ? AND is_read = 0\n            ''', (current_user.id,)).fetchone()\n            \n            count = result['count'] if result else 0\n            conn.close()\n        \n        return jsonify({'count': count})\n    except Exception as e:\n        print(f\"Error getting unread notifications: {e}\")\n        return jsonify({'count': 0, 'error': str(e)}), 200\n\n@app.route('/api/unread-messages/count')\n@login_required\ndef get_unread_messages_count():\n    \"\"\"Get count of unread messages in all courses\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            \n            # Count unread messages in courses where user is enrolled\n            result = conn.execute('''\n                SELECT COUNT(*) as count FROM chat_messages cm\n                JOIN enrollments e ON cm.course_id = e.course_id\n                WHERE e.student_id = ? AND cm.sender_id != ? AND cm.created_at > (\n                    SELECT COALESCE(MAX(viewed_at), '2020-01-01') FROM chat_messages\n                    WHERE course_id = cm.course_id AND sender_id = ?\n                )\n            ''', (current_user.id, current_user.id, current_user.id)).fetchone()\n            \n            count = result['count'] if result else 0\n            conn.close()\n        \n        return jsonify({'count': count})\n    except Exception as e:\n        print(f\"Error getting unread messages: {e}\")\n        return jsonify({'count': 0, 'error': str(e)}), 200\n\n@app.route('/api/generate-mcq-options', methods=['POST'])\n@instructor_required\ndef api_generate_mcq_options():\n    \"\"\"API endpoint to generate MCQ options using AI\"\"\"\n    data = request.get_json()\n    question_text = data.get('question', '').strip()\n    context = data.get('context', '').strip()\n    \n    if not question_text:\n        return jsonify({'error': 'Question text is required'}), 400\n    \n    try:\n        options = gemini_ai.generate_mcq_options(question_text, context)\n        \n        if options:\n            return jsonify({\n                'success': True,\n                'options': options\n            })\n        else:\n            return jsonify({\n                'success': False,\n                'error': 'Failed to generate options. Please try again.'\n            }), 500\n            \n    except Exception as e:\n        print(f\"Error generating MCQ options: {e}\")\n        return jsonify({\n            'success': False,\n            'error': 'An error occurred while generating options'\n        }), 500\n\n@app.route('/api/submissions/<int:submission_id>')\n@login_required\ndef api_get_submission(submission_id):\n    \"\"\"API endpoint to get detailed submission data for instructors\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get submission with student and quiz info\n        submission = conn.execute('''\n            SELECT s.*, u.full_name as student_name, u.username, u.email,\n                   a.title as quiz_title, a.course_id, c.instructor_id\n            FROM assignment_submissions s\n            JOIN users u ON s.student_id = u.id\n            JOIN assignments a ON s.assignment_id = a.id\n            JOIN courses c ON a.course_id = c.id\n            WHERE s.id = ?\n        ''', (submission_id,)).fetchone()\n        \n        if not submission:\n            conn.close()\n            return jsonify({'error': 'Submission not found'}), 404\n        \n        # Check if user has access (instructor of the course)\n        if not current_user.is_admin() and submission['instructor_id'] != current_user.id:\n            conn.close()\n            return jsonify({'error': 'Access denied'}), 403\n        \n        # Get MCQ answers\n        answers = conn.execute('''\n            SELECT ma.*, q.question_text, q.option_a, q.option_b, q.option_c, q.option_d,\n                   q.correct_answer, q.points\n            FROM student_mcq_answers ma\n            JOIN quiz_questions q ON ma.question_id = q.id\n            WHERE ma.submission_id = ?\n            ORDER BY q.id\n        ''', (submission_id,)).fetchall()\n        \n        conn.close()\n        \n        # Format response\n        response = {\n            'submission_id': submission['id'],\n            'student_name': submission['student_name'],\n            'username': submission['username'],\n            'email': submission['email'],\n            'quiz_title': submission['quiz_title'],\n            'submitted_at': submission['submitted_at'],\n            'grade': submission['grade'],\n            'ai_feedback': submission['ai_feedback'],\n            'answers': []\n        }\n        \n        for answer in answers:\n            response['answers'].append({\n                'question_id': answer['question_id'],\n                'question_text': answer['question_text'],\n                'options': {\n                    'A': answer['option_a'],\n                    'B': answer['option_b'],\n                    'C': answer['option_c'],\n                    'D': answer['option_d']\n                },\n                'selected_option': answer['selected_option'],\n                'correct_answer': answer['correct_answer'],\n                'is_correct': answer['is_correct'],\n                'points_earned': answer['points_earned'],\n                'points_possible': answer['points']\n            })\n        \n        return jsonify(response)\n\n@app.route('/notifications/<int:notification_id>/mark-read', methods=['POST'])\n@login_required  \ndef mark_notification_read(notification_id):\n    \"\"\"Mark specific notification as read\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        conn.execute('''\n            UPDATE notifications \n            SET is_read = 1 \n            WHERE id = ? AND user_id = ?\n        ''', (notification_id, current_user.id))\n        \n        conn.commit()\n        conn.close()\n    \n    return jsonify({'success': True})\n\n@app.route('/notifications/<int:notification_id>/redirect')\n@login_required\ndef handle_notification_redirect(notification_id):\n    \"\"\"Redirect user to relevant page based on notification type and mark as read\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        notification = conn.execute('''\n            SELECT * FROM notifications WHERE id = ? AND user_id = ?\n        ''', (notification_id, current_user.id)).fetchone()\n        \n        if notification:\n            conn.execute('UPDATE notifications SET is_read = 1 WHERE id = ?', (notification_id,))\n            conn.commit()\n        \n        conn.close()\n    \n    if not notification:\n        return redirect(url_for('dashboard'))\n    \n    # Route based on notification type and content\n    message_lower = notification['message'].lower()\n    course_id = notification['related_id']\n    \n    # Check what type of notification this is\n    if 'forum' in message_lower or 'discussion' in message_lower or 'topic' in message_lower:\n        # Redirect to course forums if we have a course ID\n        if course_id:\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        else:\n            return redirect(url_for('dashboard'))\n    \n    elif 'message' in message_lower or 'chat' in message_lower or 'community' in message_lower:\n        # Redirect to course discussion\n        if course_id:\n            return redirect(url_for('course_discussion_forum', course_id=course_id))\n        else:\n            return redirect(url_for('dashboard'))\n    \n    elif 'quiz' in message_lower or 'assignment' in message_lower or 'grade' in message_lower:\n        # Redirect to course page for quiz/assignment notifications\n        if course_id:\n            return redirect(url_for('student_course_view', course_id=course_id))\n        else:\n            return redirect(url_for('dashboard'))\n    \n    elif 'enrollment' in message_lower or 'course' in message_lower or 'approved' in message_lower:\n        # Redirect to course if available\n        if course_id:\n            return redirect(url_for('student_course_view', course_id=course_id))\n        else:\n            return redirect(url_for('dashboard'))\n    \n    elif 'progress' in message_lower:\n        # Redirect to course for progress updates\n        if course_id:\n            return redirect(url_for('student_course_view', course_id=course_id))\n        else:\n            return redirect(url_for('dashboard'))\n    \n    # Default fallback\n    if course_id:\n        return redirect(url_for('student_course_view', course_id=course_id))\n    \n    return redirect(url_for('dashboard'))\n\n# API ENDPOINTS FOR FETCHING MESSAGES\n@app.route('/api/course/<int:course_id>/messages')\n@login_required\ndef get_course_messages(course_id):\n    \"\"\"Get all messages for a course\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            \n            # Verify access\n            access = conn.execute('''\n                SELECT 1 FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, course_id)).fetchone()\n            \n            is_instructor = conn.execute('''\n                SELECT 1 FROM courses WHERE id = ? AND instructor_id = ?\n            ''', (course_id, current_user.id)).fetchone()\n            \n            if not (access or is_instructor or current_user.is_admin()):\n                conn.close()\n                return jsonify({'error': 'Access denied'}), 403\n            \n            messages = conn.execute('''\n                SELECT cm.*, u.full_name, u.role \n                FROM chat_messages cm\n                JOIN users u ON cm.sender_id = u.id\n                WHERE cm.course_id = ?\n                ORDER BY cm.created_at ASC\n            ''', (course_id,)).fetchall()\n            \n            conn.close()\n        \n        return jsonify({\n            'success': True,\n            'messages': [dict(m) for m in messages] if messages else []\n        })\n    except Exception as e:\n        print(f\"Error fetching course messages: {e}\")\n        return jsonify({'success': False, 'messages': [], 'error': str(e)}), 200\n\n# SOCKETIO CHAT HANDLERS\n@socketio.on('disconnect')\ndef on_disconnect():\n    if current_user.is_authenticated:\n        leave_room(f'user_{current_user.id}')\n\n@socketio.on('join_course_chat')\ndef on_join_course(data):\n    if not current_user.is_authenticated:\n        return\n    \n    course_id = data['course_id']\n    \n    # Verify user has access to this course\n    with db_lock:\n        conn = get_db_connection()\n        access = conn.execute('''\n            SELECT 1 FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            WHERE (e.student_id = ? OR c.instructor_id = ?) AND c.id = ? AND e.status = 'approved'\n        ''', (current_user.id, current_user.id, course_id)).fetchone()\n        conn.close()\n    \n    if access or current_user.is_admin():\n        join_room(f'course_{course_id}')\n        socketio.emit('status', {'msg': f'{current_user.full_name} joined the course chat'}, to=f'course_{course_id}')\n\n@socketio.on('send_course_message')\ndef handle_course_message(data):\n    if not current_user.is_authenticated:\n        return\n    \n    course_id = data['course_id']\n    message = data['message'].strip()\n    sender_role = data.get('sender_role', current_user.role)\n    \n    if not message:\n        return\n    \n    # Save message to database\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Insert message\n        conn.execute('''\n            INSERT INTO chat_messages (course_id, sender_id, message)\n            VALUES (?, ?, ?)\n        ''', (course_id, current_user.id, message))\n        \n        # Get all students in the course to send notifications\n        students = conn.execute('''\n            SELECT student_id FROM enrollments \n            WHERE course_id = ? AND status = 'approved' AND student_id != ?\n        ''', (course_id, current_user.id)).fetchall()\n        \n        conn.commit()\n        conn.close()\n    \n    # Emit message to course room\n    socketio.emit('new_course_message', {\n        'message': message,\n        'sender_name': current_user.full_name,\n        'sender_id': current_user.id,\n        'sender_role': sender_role,\n        'course_id': course_id,\n        'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n    }, to=f'course_{course_id}')\n    \n    # Send notifications to all other students in the course\n    for student in students:\n        socketio.emit('new_message_notification', {\n            'title': f'ðŸ’¬ New Message in Course',\n            'message': f'{current_user.full_name}: {message[:50]}{\"...\" if len(message) > 50 else \"\"}',\n            'type': 'info',\n            'icon': 'fa-comments',\n            'course_id': course_id,\n            'action_url': f'/discussions/{course_id}'\n        }, to=f'user_{student[\"student_id\"]}')\n\n# COMMUNITY CHAT HANDLERS\n@socketio.on('join_community_chat')\ndef on_join_community(data):\n    if not current_user.is_authenticated:\n        return\n    join_room('community_chat')\n\n@socketio.on('send_community_message')\ndef handle_community_message(data):\n    if not current_user.is_authenticated:\n        return\n    \n    message = data.get('message', '').strip()\n    sender_role = data.get('sender_role', current_user.role)\n    file_path = data.get('file_path')\n    file_name = data.get('file_name')\n    is_image = data.get('is_image', 0)\n    is_video = data.get('is_video', 0)\n    profile_picture = data.get('profile_picture', current_user.profile_picture)\n    \n    if not message:\n        return\n    \n    # Save to database\n    message_id = None\n    with db_lock:\n        conn = get_db_connection()\n        cursor = conn.execute('''\n            INSERT INTO chat_messages (course_id, sender_id, message, message_type, file_path, file_name, is_image)\n            VALUES (NULL, ?, ?, ?, ?, ?, ?)\n        ''', (current_user.id, message, 'file' if file_path else 'text', file_path, file_name, is_image or is_video))\n        message_id = cursor.lastrowid\n        conn.commit()\n        conn.close()\n    \n    socketio.emit('new_community_message', {\n        'id': message_id,\n        'message': message,\n        'sender_name': current_user.full_name,\n        'sender_id': current_user.id,\n        'sender_role': sender_role,\n        'profile_picture': profile_picture,\n        'file_path': file_path,\n        'file_name': file_name,\n        'is_image': is_image,\n        'is_video': is_video,\n        'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n    }, to='community_chat')\n\n# DIRECT MESSAGE HANDLERS (Admin/Instructor Chat)\n@socketio.on('join_direct_chat')\ndef on_join_direct_chat(data):\n    if not current_user.is_authenticated:\n        return\n    \n    recipient_id = data.get('recipient_id')\n    room = f'direct_{min(current_user.id, recipient_id)}_{max(current_user.id, recipient_id)}'\n    join_room(room)\n\n@socketio.on('send_direct_message')\ndef handle_direct_message(data):\n    if not current_user.is_authenticated:\n        return\n    \n    recipient_id = data.get('recipient_id')\n    message = data.get('message', '').strip()\n    \n    if not message or not recipient_id:\n        return\n    \n    # Save to database\n    with db_lock:\n        conn = get_db_connection()\n        conn.execute('''\n            INSERT INTO direct_messages (sender_id, recipient_id, message)\n            VALUES (?, ?, ?)\n        ''', (current_user.id, recipient_id, message))\n        conn.commit()\n        conn.close()\n    \n    room = f'direct_{min(current_user.id, recipient_id)}_{max(current_user.id, recipient_id)}'\n    socketio.emit('new_direct_message', {\n        'sender_name': current_user.full_name,\n        'sender_id': current_user.id,\n        'message': message,\n        'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n    }, to=room)\n    \n    # Send notification to recipient\n    socketio.emit('direct_message_notification', {\n        'title': f'ðŸ’Œ Direct Message from {current_user.full_name}',\n        'message': message[:50],\n        'type': 'warning',\n        'icon': 'fa-envelope'\n    }, to=f'user_{recipient_id}')\n\n# FILE UPLOAD HANDLER\n@app.route('/api/upload-chat-file', methods=['POST'])\n@login_required\ndef upload_chat_file():\n    \"\"\"Upload file to chat\"\"\"\n    try:\n        if 'file' not in request.files:\n            return jsonify({'error': 'No file provided'}), 400\n        \n        file = request.files['file']\n        course_id = request.form.get('course_id')\n        message_text = request.form.get('message', '')\n        \n        if not file.filename:\n            return jsonify({'error': 'No file selected'}), 400\n        \n        # Check file extension\n        file_ext = file.filename.rsplit('.', 1)[-1].lower()\n        if file_ext not in ALLOWED_FILE_TYPES:\n            return jsonify({'error': f'File type .{file_ext} not allowed'}), 400\n        \n        # Check file size\n        file.seek(0, 2)\n        file_size = file.tell()\n        file.seek(0)\n        \n        if file_size > MAX_CHAT_FILE_SIZE:\n            return jsonify({'error': f'File size exceeds {MAX_CHAT_FILE_SIZE / (1024*1024):.0f} MB limit'}), 400\n        \n        # Check user storage\n        with db_lock:\n            conn = get_db_connection()\n            user_storage = conn.execute('''\n                SELECT SUM(file_size) as total FROM file_uploads \n                WHERE uploader_id = ?\n            ''', (current_user.id,)).fetchone()\n            total_used = user_storage['total'] or 0\n            conn.close()\n        \n        if total_used + file_size > MAX_TOTAL_STORAGE_PER_USER:\n            return jsonify({'error': 'Storage limit exceeded (5 GB per user)'}), 400\n        \n        # Save file\n        unique_filename = f\"{current_user.id}_{uuid.uuid4().hex}_{secure_filename(file.filename)}\"\n        original_filename = file.filename\n        upload_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'chat_files')\n        filepath = os.path.join(upload_dir, unique_filename)\n        file.save(filepath)\n        \n        # Determine if image\n        is_image = file_ext in {'jpg', 'jpeg', 'png', 'gif'}\n        \n        # Save to database\n        with db_lock:\n            conn = get_db_connection()\n            conn.execute('''\n                INSERT INTO chat_messages \n                (course_id, sender_id, message, message_type, file_path, file_name, file_size, is_image)\n                VALUES (?, ?, ?, ?, ?, ?, ?, ?)\n            ''', (course_id, current_user.id, message_text or original_filename, 'file', unique_filename, original_filename, file_size, is_image))\n            \n            message_id = conn.execute('SELECT last_insert_rowid()').fetchone()[0]\n            \n            conn.execute('''\n                INSERT INTO file_uploads (uploader_id, file_name, file_path, file_size, file_type, message_id)\n                VALUES (?, ?, ?, ?, ?, ?)\n            ''', (current_user.id, original_filename, unique_filename, file_size, file_ext, message_id))\n            \n            conn.commit()\n            conn.close()\n        \n        return jsonify({\n            'success': True,\n            'file_path': f'/uploads/chat_files/{unique_filename}',\n            'file_name': original_filename,\n            'file_type': file_ext\n        })\n        \n    except Exception as e:\n        logging.error(f\"File upload error: {e}\")\n        return jsonify({'error': str(e)}), 500\n\n@app.route('/download-chat-file/<filename>')\n@login_required\ndef download_chat_file(filename):\n    \"\"\"Download uploaded chat file\"\"\"\n    try:\n        filepath = os.path.join(app.config['UPLOAD_FOLDER'], 'chat_files', filename)\n        if os.path.exists(filepath):\n            return send_from_directory(os.path.dirname(filepath), filename, as_attachment=True)\n        return jsonify({'error': 'File not found'}), 404\n    except Exception as e:\n        return jsonify({'error': str(e)}), 500\n\n@app.route('/uploads/chat_files/<filename>')\n@login_required\ndef serve_chat_file(filename):\n    \"\"\"Serve uploaded chat files\"\"\"\n    return send_from_directory(os.path.join(app.config['UPLOAD_FOLDER'], 'chat_files'), filename)\n\n# MESSAGING HUB ROUTE\n@app.route('/forum')\n@login_required\ndef messaging_hub():\n    \"\"\"Central messaging hub showing all chat options\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get user's courses if student\n        my_courses = []\n        if current_user.role == 'student':\n            my_courses = conn.execute('''\n                SELECT c.id, c.title, c.course_code \n                FROM courses c\n                JOIN enrollments e ON c.id = e.course_id\n                WHERE e.student_id = ? AND e.status = 'approved'\n                ORDER BY c.title\n            ''', (current_user.id,)).fetchall()\n        \n        # Get instructor's courses\n        instructor_courses = []\n        if current_user.is_instructor() or current_user.is_admin():\n            instructor_courses = conn.execute('''\n                SELECT id, title, course_code FROM courses \n                WHERE instructor_id = ?\n                ORDER BY title\n            ''', (current_user.id,)).fetchall()\n        \n        # Get all courses for admin\n        all_courses = []\n        if current_user.is_admin():\n            all_courses = conn.execute('''\n                SELECT c.id, c.title, c.course_code, u.full_name as instructor_name\n                FROM courses c\n                LEFT JOIN users u ON c.instructor_id = u.id\n                ORDER BY c.title\n            ''', ).fetchall()\n        \n        conn.close()\n    \n    return render_template('messaging_hub.html', \n                         my_courses=my_courses,\n                         instructor_courses=instructor_courses,\n                         all_courses=all_courses)\n\n# COMMUNITY CHAT ROUTE\n@app.route('/community-chat')\n@login_required\ndef community_chat():\n    \"\"\"Display community chat (all users)\"\"\"\n    return render_template('community_chat.html')\n\n# DIRECT MESSAGES CRUD ROUTES\n@app.route('/direct-messages')\n@login_required\ndef direct_messages_page():\n    \"\"\"Display direct messages page\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        # Get all students for instructor/admin, or instructors for students\n        if current_user.is_admin() or current_user.is_instructor():\n            users = conn.execute('''\n                SELECT DISTINCT u.id, u.full_name, u.role FROM users u\n                WHERE u.role = 'student' AND u.id != ?\n                ORDER BY u.full_name\n            ''', (current_user.id,)).fetchall()\n        else:\n            users = conn.execute('''\n                SELECT DISTINCT u.id, u.full_name, u.role FROM users u\n                WHERE (u.role = 'instructor' OR u.role = 'admin') AND u.id != ?\n                ORDER BY u.full_name\n            ''', (current_user.id,)).fetchall()\n        conn.close()\n    \n    return render_template('direct_messages.html', users=users)\n\n@app.route('/api/direct-messages/<int:user_id>')\n@login_required\ndef get_direct_messages(user_id):\n    \"\"\"Get direct messages with a specific user\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            messages = conn.execute('''\n                SELECT id, sender_id, recipient_id, message, created_at \n                FROM direct_messages \n                WHERE (sender_id = ? AND recipient_id = ?) OR (sender_id = ? AND recipient_id = ?)\n                ORDER BY created_at ASC\n                LIMIT 100\n            ''', (current_user.id, user_id, user_id, current_user.id)).fetchall()\n            \n            # Mark as read\n            conn.execute('''\n                UPDATE direct_messages SET is_read = 1 \n                WHERE recipient_id = ? AND sender_id = ? AND is_read = 0\n            ''', (current_user.id, user_id))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'messages': [dict(m) for m in messages]})\n    except Exception as e:\n        print(f\"Error loading direct messages: {e}\")\n        return jsonify({'messages': [], 'error': str(e)}), 200\n\n@app.route('/api/direct-messages/<int:message_id>', methods=['DELETE'])\n@login_required\ndef delete_direct_message(message_id):\n    \"\"\"Delete a direct message\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            # Verify ownership\n            msg = conn.execute('SELECT sender_id FROM direct_messages WHERE id = ?', (message_id,)).fetchone()\n            \n            if not msg or msg['sender_id'] != current_user.id:\n                conn.close()\n                return jsonify({'error': 'Unauthorized'}), 403\n            \n            conn.execute('DELETE FROM direct_messages WHERE id = ?', (message_id,))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        print(f\"Error deleting message: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 200\n\n@app.route('/api/direct-messages/<int:message_id>', methods=['PATCH'])\n@login_required\ndef edit_direct_message(message_id):\n    \"\"\"Edit a direct message\"\"\"\n    try:\n        data = request.get_json()\n        message = data.get('message', '').strip() if data else ''\n        \n        if not message:\n            return jsonify({'error': 'Message cannot be empty'}), 400\n        \n        with db_lock:\n            conn = get_db_connection()\n            # Verify ownership\n            msg = conn.execute('SELECT sender_id FROM direct_messages WHERE id = ?', (message_id,)).fetchone()\n            \n            if not msg or msg['sender_id'] != current_user.id:\n                conn.close()\n                return jsonify({'error': 'Unauthorized'}), 403\n            \n            conn.execute('UPDATE direct_messages SET message = ? WHERE id = ?', (message, message_id))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        print(f\"Error editing message: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 200\n\n# USER PROFILE ENDPOINTS\n@app.route('/api/profile/bio', methods=['POST'])\n@login_required\ndef update_bio():\n    \"\"\"Update user bio\"\"\"\n    try:\n        data = request.get_json()\n        bio = data.get('bio', '').strip()[:500]\n        \n        with db_lock:\n            conn = get_db_connection()\n            conn.execute('UPDATE users SET bio = ? WHERE id = ?', (bio, current_user.id))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        return jsonify({'success': False, 'error': str(e)}), 200\n\n@app.route('/api/profile/phone', methods=['POST'])\n@login_required\ndef update_phone():\n    \"\"\"Update phone number\"\"\"\n    try:\n        data = request.get_json()\n        phone = data.get('phone', '').strip()\n        \n        with db_lock:\n            conn = get_db_connection()\n            conn.execute('''INSERT OR REPLACE INTO user_profiles (user_id, phone_number)\n                VALUES (?, ?)''', (current_user.id, phone))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        return jsonify({'success': False, 'error': str(e)}), 200\n\n@app.route('/api/contacts')\n@login_required\ndef get_contacts():\n    \"\"\"Get user contacts\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            contacts = conn.execute('''SELECT u.id, u.full_name FROM contacts c\n                JOIN users u ON c.contact_id = u.id WHERE c.user_id = ?\n                ORDER BY u.full_name''', (current_user.id,)).fetchall()\n            conn.close()\n        \n        return jsonify({'contacts': [dict(c) for c in contacts]})\n    except Exception as e:\n        return jsonify({'contacts': [], 'error': str(e)}), 200\n\n@app.route('/api/messages/<int:message_id>/react', methods=['POST'])\n@login_required\ndef add_reaction(message_id):\n    \"\"\"Add emoji reaction to message\"\"\"\n    try:\n        data = request.get_json()\n        emoji = data.get('emoji', '').strip()[:2]\n        \n        if not emoji:\n            return jsonify({'error': 'Invalid emoji'}), 400\n        \n        with db_lock:\n            conn = get_db_connection()\n            conn.execute('''INSERT OR IGNORE INTO message_reactions (message_id, user_id, emoji)\n                VALUES (?, ?, ?)''', (message_id, current_user.id, emoji))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        return jsonify({'success': False}), 200\n\n# CRUD OPERATIONS FOR CHAT MESSAGES\n@app.route('/api/chat-messages/<int:message_id>', methods=['PATCH'])\n@login_required\ndef edit_chat_message(message_id):\n    \"\"\"Edit a chat message (community or course)\"\"\"\n    try:\n        data = request.get_json()\n        message = data.get('message', '').strip()\n        \n        if not message:\n            return jsonify({'error': 'Message cannot be empty'}), 400\n        \n        with db_lock:\n            conn = get_db_connection()\n            # Verify ownership\n            msg = conn.execute('SELECT sender_id FROM chat_messages WHERE id = ?', (message_id,)).fetchone()\n            \n            if not msg or msg['sender_id'] != current_user.id:\n                conn.close()\n                return jsonify({'error': 'Unauthorized'}), 403\n            \n            conn.execute('UPDATE chat_messages SET message = ? WHERE id = ?', (message, message_id))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True, 'message': message})\n    except Exception as e:\n        logging.error(f\"Error editing message: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n@app.route('/api/chat-messages/<int:message_id>', methods=['DELETE'])\n@login_required\ndef delete_chat_message(message_id):\n    \"\"\"Delete a chat message (community or course)\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            # Verify ownership\n            msg = conn.execute('SELECT sender_id FROM chat_messages WHERE id = ?', (message_id,)).fetchone()\n            \n            if not msg or msg['sender_id'] != current_user.id:\n                conn.close()\n                return jsonify({'error': 'Unauthorized'}), 403\n            \n            conn.execute('DELETE FROM chat_messages WHERE id = ?', (message_id,))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        logging.error(f\"Error deleting message: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n@socketio.on('user_typing')\ndef handle_typing(data):\n    \"\"\"Broadcast typing indicator\"\"\"\n    if not current_user.is_authenticated:\n        return\n    \n    socketio.emit('user_typing', {\n        'user_id': current_user.id,\n        'user_name': current_user.full_name,\n        'room': data.get('room')\n    }, to=data.get('room'))\n\n@socketio.on('update_status')\ndef update_status(data):\n    \"\"\"Update user online/offline status\"\"\"\n    if not current_user.is_authenticated:\n        return\n    \n    with db_lock:\n        conn = get_db_connection()\n        status = data.get('status', 'online')\n        conn.execute('''INSERT OR REPLACE INTO user_profiles (user_id, status, last_seen)\n            VALUES (?, ?, CURRENT_TIMESTAMP)''', (current_user.id, status))\n        conn.commit()\n        conn.close()\n    \n    socketio.emit('user_status_changed', {\n        'user_id': current_user.id,\n        'status': status\n    }, broadcast=True)\n\n\n@app.route('/course/<int:course_id>/ai_notes')\n@login_required\ndef ai_notes_page(course_id):\n    \"\"\"AI Notes page for instructors and students\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        course = conn.execute('SELECT * FROM courses WHERE id = ?', (course_id,)).fetchone()\n        \n        if not course:\n            conn.close()\n            flash('Course not found', 'error')\n            return redirect(url_for('dashboard'))\n        \n        if current_user.role == 'instructor':\n            if course['instructor_id'] != current_user.id:\n                conn.close()\n                flash('You do not have permission to access this course', 'error')\n                return redirect(url_for('dashboard'))\n            \n            my_notes = conn.execute('''SELECT * FROM ai_notes WHERE course_id = ? AND created_by = ? \n                AND is_instructor_note = 1 ORDER BY created_at DESC''', \n                (course_id, current_user.id)).fetchall()\n            conn.close()\n            return render_template('ai_notes_instructor.html', course=course, notes=my_notes)\n        else:\n            enrollment = conn.execute('''SELECT * FROM enrollments WHERE course_id = ? AND student_id = ? \n                AND status = 'approved' ''', (course_id, current_user.id)).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                flash('You are not enrolled in this course', 'error')\n                return redirect(url_for('dashboard'))\n            \n            instructor_notes = conn.execute('''SELECT an.*, u.full_name as instructor_name FROM ai_notes an \n                JOIN users u ON an.created_by = u.id \n                WHERE an.course_id = ? AND an.is_instructor_note = 1 AND an.sent_to_students = 1 \n                ORDER BY an.created_at DESC''', (course_id,)).fetchall()\n            my_notes = conn.execute('''SELECT * FROM ai_notes WHERE course_id = ? AND created_by = ? \n                AND is_instructor_note = 0 ORDER BY created_at DESC''', \n                (course_id, current_user.id)).fetchall()\n            conn.close()\n            return render_template('ai_notes_student.html', course=course, \n                instructor_notes=instructor_notes, my_notes=my_notes)\n\n\n@app.route('/course/<int:course_id>/ai_notes/generate', methods=['POST'])\n@login_required\n@instructor_required\ndef generate_ai_notes(course_id):\n    \"\"\"Generate AI notes for a topic\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            course = conn.execute('SELECT * FROM courses WHERE id = ? AND instructor_id = ?', \n                (course_id, current_user.id)).fetchone()\n            conn.close()\n        \n        if not course:\n            return jsonify({'success': False, 'error': 'You do not own this course'}), 403\n        \n        topic = request.form.get('topic', '').strip()\n        additional_context = request.form.get('additional_context', '').strip()\n        \n        if not topic:\n            return jsonify({'success': False, 'error': 'Topic is required'}), 400\n        \n        result = gemini_ai.generate_ai_notes(topic, current_user.full_name, additional_context)\n        \n        if result.get('success'):\n            with db_lock:\n                conn = get_db_connection()\n                conn.execute('''INSERT INTO ai_notes (course_id, topic, content, created_by, is_instructor_note)\n                    VALUES (?, ?, ?, ?, 1)''', (course_id, topic, result['content'], current_user.id))\n                note_id = conn.execute('SELECT last_insert_rowid()').fetchone()[0]\n                conn.commit()\n                conn.close()\n            \n            return jsonify({'success': True, 'note_id': note_id, 'content': result['content']})\n        else:\n            return jsonify({'success': False, 'error': result.get('error', 'Failed to generate notes')}), 500\n    \n    except Exception as e:\n        logging.error(f\"Error generating AI notes: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/course/<int:course_id>/ai_notes/<int:note_id>/edit', methods=['POST'])\n@login_required\n@instructor_required\ndef edit_ai_notes(course_id, note_id):\n    \"\"\"Edit AI notes content\"\"\"\n    try:\n        content = request.form.get('content', '').strip()\n        \n        if not content:\n            return jsonify({'success': False, 'error': 'Content is required'}), 400\n        \n        with db_lock:\n            conn = get_db_connection()\n            conn.execute('UPDATE ai_notes SET content = ? WHERE id = ? AND created_by = ? AND course_id = ?',\n                (content, note_id, current_user.id, course_id))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    \n    except Exception as e:\n        logging.error(f\"Error editing AI notes: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/course/<int:course_id>/ai_notes/<int:note_id>/create_pdf', methods=['POST'])\n@login_required\n@instructor_required\ndef create_notes_pdf(course_id, note_id):\n    \"\"\"Create PDF from AI notes\"\"\"\n    try:\n        from utils.pdf_generator import generate_notes_pdf\n        \n        with db_lock:\n            conn = get_db_connection()\n            note = conn.execute('SELECT * FROM ai_notes WHERE id = ? AND created_by = ? AND course_id = ?',\n                (note_id, current_user.id, course_id)).fetchone()\n            conn.close()\n        \n        if not note:\n            return jsonify({'success': False, 'error': 'Note not found'}), 404\n        \n        notes_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'ai_notes')\n        os.makedirs(notes_dir, exist_ok=True)\n        \n        filename = f'notes_{note_id}_{int(datetime.now().timestamp())}.pdf'\n        pdf_path = os.path.join(notes_dir, filename)\n        \n        success = generate_notes_pdf(note['content'], note['topic'], current_user.full_name, pdf_path)\n        \n        if success:\n            relative_path = f'ai_notes/{filename}'\n            \n            with db_lock:\n                conn = get_db_connection()\n                conn.execute('UPDATE ai_notes SET pdf_path = ? WHERE id = ?', (relative_path, note_id))\n                conn.commit()\n                conn.close()\n            \n            return jsonify({'success': True, 'pdf_path': relative_path})\n        else:\n            return jsonify({'success': False, 'error': 'Failed to create PDF'}), 500\n    \n    except Exception as e:\n        logging.error(f\"Error creating PDF: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/course/<int:course_id>/ai_notes/<int:note_id>/send', methods=['POST'])\n@login_required\n@instructor_required\ndef send_notes_to_students(course_id, note_id):\n    \"\"\"Send AI notes to all enrolled students\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            note = conn.execute('SELECT * FROM ai_notes WHERE id = ? AND created_by = ? AND course_id = ?',\n                (note_id, current_user.id, course_id)).fetchone()\n            \n            if not note:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Note not found'}), 404\n            \n            if not note['pdf_path']:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Please create PDF first'}), 400\n            \n            conn.execute('UPDATE ai_notes SET sent_to_students = 1 WHERE id = ?', (note_id,))\n            \n            students = conn.execute('''SELECT student_id FROM enrollments WHERE course_id = ? \n                AND status = 'approved' ''', (course_id,)).fetchall()\n            \n            for student in students:\n                conn.execute('''INSERT INTO notifications (user_id, title, message, type, related_id)\n                    VALUES (?, ?, ?, ?, ?)''',\n                    (student['student_id'], 'New AI Notes Available', \n                    f'New AI notes available for {note[\"topic\"]}', 'ai_notes', note_id))\n            \n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    \n    except Exception as e:\n        logging.error(f\"Error sending notes: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/course/<int:course_id>/ai_notes/<int:note_id>/delete', methods=['POST'])\n@login_required\ndef delete_ai_notes(course_id, note_id):\n    \"\"\"Delete AI notes\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            note = conn.execute('SELECT * FROM ai_notes WHERE id = ? AND created_by = ? AND course_id = ?',\n                (note_id, current_user.id, course_id)).fetchone()\n            \n            if not note:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Note not found'}), 404\n            \n            # Delete PDF file if it exists\n            if note['pdf_path']:\n                pdf_file = os.path.join(app.config['UPLOAD_FOLDER'], note['pdf_path'])\n                if os.path.exists(pdf_file):\n                    try:\n                        os.remove(pdf_file)\n                    except Exception as e:\n                        logging.warning(f\"Could not delete PDF file: {e}\")\n            \n            conn.execute('DELETE FROM ai_notes WHERE id = ?', (note_id,))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    \n    except Exception as e:\n        logging.error(f\"Error deleting AI notes: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/course/<int:course_id>/ai_notes/student/create', methods=['POST'])\n@login_required\ndef student_create_notes(course_id):\n    \"\"\"Student create their own AI notes\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            enrollment = conn.execute('''SELECT * FROM enrollments WHERE course_id = ? AND student_id = ? \n                AND status = 'approved' ''', (course_id, current_user.id)).fetchone()\n            conn.close()\n        \n        if not enrollment:\n            return jsonify({'success': False, 'error': 'You are not enrolled in this course'}), 403\n        \n        topic = request.form.get('topic', '').strip()\n        additional_context = request.form.get('additional_context', '').strip()\n        add_watermark = request.form.get('add_watermark') == 'on'\n        custom_watermark = request.form.get('custom_watermark', '').strip()\n        \n        if not topic:\n            return jsonify({'success': False, 'error': 'Topic is required'}), 400\n        \n        result = gemini_ai.generate_ai_notes(topic, '', additional_context)\n        \n        if result.get('success'):\n            from utils.pdf_generator import generate_notes_pdf\n            \n            with db_lock:\n                conn = get_db_connection()\n                conn.execute('''INSERT INTO ai_notes (course_id, topic, content, created_by, is_instructor_note)\n                    VALUES (?, ?, ?, ?, 0)''', (course_id, topic, result['content'], current_user.id))\n                note_id = conn.execute('SELECT last_insert_rowid()').fetchone()[0]\n                conn.commit()\n                conn.close()\n            \n            notes_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'ai_notes')\n            os.makedirs(notes_dir, exist_ok=True)\n            \n            filename = f'notes_{note_id}_{int(datetime.now().timestamp())}.pdf'\n            pdf_path = os.path.join(notes_dir, filename)\n            \n            success = generate_notes_pdf(result['content'], topic, current_user.full_name, pdf_path, \n                                        add_watermark=add_watermark, custom_watermark=custom_watermark)\n            \n            relative_path = None\n            if success:\n                relative_path = f'ai_notes/{filename}'\n                \n                with db_lock:\n                    conn = get_db_connection()\n                    conn.execute('UPDATE ai_notes SET pdf_path = ? WHERE id = ?', (relative_path, note_id))\n                    conn.commit()\n                    conn.close()\n            \n            return jsonify({'success': True, 'note_id': note_id, 'pdf_path': relative_path})\n        else:\n            return jsonify({'success': False, 'error': result.get('error', 'Failed to generate notes')}), 500\n    \n    except Exception as e:\n        logging.error(f\"Error creating student notes: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/uploads/<path:filename>')\ndef serve_upload(filename):\n    \"\"\"Serve uploaded files\"\"\"\n    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)\n\n\nif __name__ == '__main__':\n    # Initialize database before starting Flask\n    db_ready = init_db()\n    if not db_ready:\n        print(\"âš ï¸  Database initialization incomplete, but continuing with Flask startup...\")\n    \n    socketio.run(app, host='0.0.0.0', port=5000, debug=True, use_reloader=False, log_output=True, allow_unsafe_werkzeug=True)","size_bytes":269778},"ghalib/templates/student/video_download/static/css/output.css":{"content":"/*\n! tailwindcss v3.3.2 | MIT License | https://tailwindcss.com\n*/\n\n/*\n1. Prevent padding and border from affecting element width. (https://github.com/mozdevs/cssremedy/issues/4)\n2. Allow adding a border to an element by just adding a border-width. (https://github.com/tailwindcss/tailwindcss/pull/116)\n*/\n\n*,\n::before,\n::after {\n  box-sizing: border-box;\n  /* 1 */\n  border-width: 0;\n  /* 2 */\n  border-style: solid;\n  /* 2 */\n  border-color: #e5e7eb;\n  /* 2 */\n}\n\n::before,\n::after {\n  --tw-content: '';\n}\n\n/*\n1. Use a consistent sensible line-height in all browsers.\n2. Prevent adjustments of font size after orientation changes in iOS.\n3. Use a more readable tab size.\n4. Use the user's configured `sans` font-family by default.\n5. Use the user's configured `sans` font-feature-settings by default.\n6. Use the user's configured `sans` font-variation-settings by default.\n*/\n\nhtml {\n  line-height: 1.5;\n  /* 1 */\n  -webkit-text-size-adjust: 100%;\n  /* 2 */\n  -moz-tab-size: 4;\n  /* 3 */\n  -o-tab-size: 4;\n     tab-size: 4;\n  /* 3 */\n  font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, \"Noto Sans\", sans-serif, \"Apple Color Emoji\", \"Segoe UI Emoji\", \"Segoe UI Symbol\", \"Noto Color Emoji\";\n  /* 4 */\n  font-feature-settings: normal;\n  /* 5 */\n  font-variation-settings: normal;\n  /* 6 */\n}\n\n/*\n1. Remove the margin in all browsers.\n2. Inherit line-height from `html` so users can set them as a class directly on the `html` element.\n*/\n\nbody {\n  margin: 0;\n  /* 1 */\n  line-height: inherit;\n  /* 2 */\n}\n\n/*\n1. Add the correct height in Firefox.\n2. Correct the inheritance of border color in Firefox. (https://bugzilla.mozilla.org/show_bug.cgi?id=190655)\n3. Ensure horizontal rules are visible by default.\n*/\n\nhr {\n  height: 0;\n  /* 1 */\n  color: inherit;\n  /* 2 */\n  border-top-width: 1px;\n  /* 3 */\n}\n\n/*\nAdd the correct text decoration in Chrome, Edge, and Safari.\n*/\n\nabbr:where([title]) {\n  -webkit-text-decoration: underline dotted;\n          text-decoration: underline dotted;\n}\n\n/*\nRemove the default font size and weight for headings.\n*/\n\nh1,\nh2,\nh3,\nh4,\nh5,\nh6 {\n  font-size: inherit;\n  font-weight: inherit;\n}\n\n/*\nReset links to optimize for opt-in styling instead of opt-out.\n*/\n\na {\n  color: inherit;\n  text-decoration: inherit;\n}\n\n/*\nAdd the correct font weight in Edge and Safari.\n*/\n\nb,\nstrong {\n  font-weight: bolder;\n}\n\n/*\n1. Use the user's configured `mono` font family by default.\n2. Correct the odd `em` font sizing in all browsers.\n*/\n\ncode,\nkbd,\nsamp,\npre {\n  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;\n  /* 1 */\n  font-size: 1em;\n  /* 2 */\n}\n\n/*\nAdd the correct font size in all browsers.\n*/\n\nsmall {\n  font-size: 80%;\n}\n\n/*\nPrevent `sub` and `sup` elements from affecting the line height in all browsers.\n*/\n\nsub,\nsup {\n  font-size: 75%;\n  line-height: 0;\n  position: relative;\n  vertical-align: baseline;\n}\n\nsub {\n  bottom: -0.25em;\n}\n\nsup {\n  top: -0.5em;\n}\n\n/*\n1. Remove text indentation from table contents in Chrome and Safari. (https://bugs.chromium.org/p/chromium/issues/detail?id=999088, https://bugs.webkit.org/show_bug.cgi?id=201297)\n2. Correct table border color inheritance in all Chrome and Safari. (https://bugs.chromium.org/p/chromium/issues/detail?id=935729, https://bugs.webkit.org/show_bug.cgi?id=195016)\n3. Remove gaps between table borders by default.\n*/\n\ntable {\n  text-indent: 0;\n  /* 1 */\n  border-color: inherit;\n  /* 2 */\n  border-collapse: collapse;\n  /* 3 */\n}\n\n/*\n1. Change the font styles in all browsers.\n2. Remove the margin in Firefox and Safari.\n3. Remove default padding in all browsers.\n*/\n\nbutton,\ninput,\noptgroup,\nselect,\ntextarea {\n  font-family: inherit;\n  /* 1 */\n  font-size: 100%;\n  /* 1 */\n  font-weight: inherit;\n  /* 1 */\n  line-height: inherit;\n  /* 1 */\n  color: inherit;\n  /* 1 */\n  margin: 0;\n  /* 2 */\n  padding: 0;\n  /* 3 */\n}\n\n/*\nRemove the inheritance of text transform in Edge and Firefox.\n*/\n\nbutton,\nselect {\n  text-transform: none;\n}\n\n/*\n1. Correct the inability to style clickable types in iOS and Safari.\n2. Remove default button styles.\n*/\n\nbutton,\n[type='button'],\n[type='reset'],\n[type='submit'] {\n  -webkit-appearance: button;\n  /* 1 */\n  background-color: transparent;\n  /* 2 */\n  background-image: none;\n  /* 2 */\n}\n\n/*\nUse the modern Firefox focus style for all focusable elements.\n*/\n\n:-moz-focusring {\n  outline: auto;\n}\n\n/*\nRemove the additional `:invalid` styles in Firefox. (https://github.com/mozilla/gecko-dev/blob/2f9eacd9d3d995c937b4251a5557d95d494c9be1/layout/style/res/forms.css#L728-L737)\n*/\n\n:-moz-ui-invalid {\n  box-shadow: none;\n}\n\n/*\nAdd the correct vertical alignment in Chrome and Firefox.\n*/\n\nprogress {\n  vertical-align: baseline;\n}\n\n/*\nCorrect the cursor style of increment and decrement buttons in Safari.\n*/\n\n::-webkit-inner-spin-button,\n::-webkit-outer-spin-button {\n  height: auto;\n}\n\n/*\n1. Correct the odd appearance in Chrome and Safari.\n2. Correct the outline style in Safari.\n*/\n\n[type='search'] {\n  -webkit-appearance: textfield;\n  /* 1 */\n  outline-offset: -2px;\n  /* 2 */\n}\n\n/*\nRemove the inner padding in Chrome and Safari on macOS.\n*/\n\n::-webkit-search-decoration {\n  -webkit-appearance: none;\n}\n\n/*\n1. Correct the inability to style clickable types in iOS and Safari.\n2. Change font properties to `inherit` in Safari.\n*/\n\n::-webkit-file-upload-button {\n  -webkit-appearance: button;\n  /* 1 */\n  font: inherit;\n  /* 2 */\n}\n\n/*\nAdd the correct display in Chrome and Safari.\n*/\n\nsummary {\n  display: list-item;\n}\n\n/*\nRemoves the default spacing and border for appropriate elements.\n*/\n\nblockquote,\ndl,\ndd,\nh1,\nh2,\nh3,\nh4,\nh5,\nh6,\nhr,\nfigure,\np,\npre {\n  margin: 0;\n}\n\nfieldset {\n  margin: 0;\n  padding: 0;\n}\n\nlegend {\n  padding: 0;\n}\n\nol,\nul,\nmenu {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n\n/*\nPrevent resizing textareas horizontally by default.\n*/\n\ntextarea {\n  resize: vertical;\n}\n\n/*\n1. Reset the default placeholder opacity in Firefox. (https://github.com/tailwindlabs/tailwindcss/issues/3300)\n2. Set the default placeholder color to the user's configured gray 400 color.\n*/\n\ninput::-moz-placeholder, textarea::-moz-placeholder {\n  opacity: 1;\n  /* 1 */\n  color: #9ca3af;\n  /* 2 */\n}\n\ninput::placeholder,\ntextarea::placeholder {\n  opacity: 1;\n  /* 1 */\n  color: #9ca3af;\n  /* 2 */\n}\n\n/*\nSet the default cursor for buttons.\n*/\n\nbutton,\n[role=\"button\"] {\n  cursor: pointer;\n}\n\n/*\nMake sure disabled buttons don't get the pointer cursor.\n*/\n\n:disabled {\n  cursor: default;\n}\n\n/*\n1. Make replaced elements `display: block` by default. (https://github.com/mozdevs/cssremedy/issues/14)\n2. Add `vertical-align: middle` to align replaced elements more sensibly by default. (https://github.com/jensimmons/cssremedy/issues/14#issuecomment-634934210)\n   This can trigger a poorly considered lint error in some tools but is included by design.\n*/\n\nimg,\nsvg,\nvideo,\ncanvas,\naudio,\niframe,\nembed,\nobject {\n  display: block;\n  /* 1 */\n  vertical-align: middle;\n  /* 2 */\n}\n\n/*\nConstrain images and videos to the parent width and preserve their intrinsic aspect ratio. (https://github.com/mozdevs/cssremedy/issues/14)\n*/\n\nimg,\nvideo {\n  max-width: 100%;\n  height: auto;\n}\n\n/* Make elements with the HTML hidden attribute stay hidden by default */\n\n[hidden] {\n  display: none;\n}\n\n*, ::before, ::after {\n  --tw-border-spacing-x: 0;\n  --tw-border-spacing-y: 0;\n  --tw-translate-x: 0;\n  --tw-translate-y: 0;\n  --tw-rotate: 0;\n  --tw-skew-x: 0;\n  --tw-skew-y: 0;\n  --tw-scale-x: 1;\n  --tw-scale-y: 1;\n  --tw-pan-x:  ;\n  --tw-pan-y:  ;\n  --tw-pinch-zoom:  ;\n  --tw-scroll-snap-strictness: proximity;\n  --tw-gradient-from-position:  ;\n  --tw-gradient-via-position:  ;\n  --tw-gradient-to-position:  ;\n  --tw-ordinal:  ;\n  --tw-slashed-zero:  ;\n  --tw-numeric-figure:  ;\n  --tw-numeric-spacing:  ;\n  --tw-numeric-fraction:  ;\n  --tw-ring-inset:  ;\n  --tw-ring-offset-width: 0px;\n  --tw-ring-offset-color: #fff;\n  --tw-ring-color: rgb(59 130 246 / 0.5);\n  --tw-ring-offset-shadow: 0 0 #0000;\n  --tw-ring-shadow: 0 0 #0000;\n  --tw-shadow: 0 0 #0000;\n  --tw-shadow-colored: 0 0 #0000;\n  --tw-blur:  ;\n  --tw-brightness:  ;\n  --tw-contrast:  ;\n  --tw-grayscale:  ;\n  --tw-hue-rotate:  ;\n  --tw-invert:  ;\n  --tw-saturate:  ;\n  --tw-sepia:  ;\n  --tw-drop-shadow:  ;\n  --tw-backdrop-blur:  ;\n  --tw-backdrop-brightness:  ;\n  --tw-backdrop-contrast:  ;\n  --tw-backdrop-grayscale:  ;\n  --tw-backdrop-hue-rotate:  ;\n  --tw-backdrop-invert:  ;\n  --tw-backdrop-opacity:  ;\n  --tw-backdrop-saturate:  ;\n  --tw-backdrop-sepia:  ;\n}\n\n::backdrop {\n  --tw-border-spacing-x: 0;\n  --tw-border-spacing-y: 0;\n  --tw-translate-x: 0;\n  --tw-translate-y: 0;\n  --tw-rotate: 0;\n  --tw-skew-x: 0;\n  --tw-skew-y: 0;\n  --tw-scale-x: 1;\n  --tw-scale-y: 1;\n  --tw-pan-x:  ;\n  --tw-pan-y:  ;\n  --tw-pinch-zoom:  ;\n  --tw-scroll-snap-strictness: proximity;\n  --tw-gradient-from-position:  ;\n  --tw-gradient-via-position:  ;\n  --tw-gradient-to-position:  ;\n  --tw-ordinal:  ;\n  --tw-slashed-zero:  ;\n  --tw-numeric-figure:  ;\n  --tw-numeric-spacing:  ;\n  --tw-numeric-fraction:  ;\n  --tw-ring-inset:  ;\n  --tw-ring-offset-width: 0px;\n  --tw-ring-offset-color: #fff;\n  --tw-ring-color: rgb(59 130 246 / 0.5);\n  --tw-ring-offset-shadow: 0 0 #0000;\n  --tw-ring-shadow: 0 0 #0000;\n  --tw-shadow: 0 0 #0000;\n  --tw-shadow-colored: 0 0 #0000;\n  --tw-blur:  ;\n  --tw-brightness:  ;\n  --tw-contrast:  ;\n  --tw-grayscale:  ;\n  --tw-hue-rotate:  ;\n  --tw-invert:  ;\n  --tw-saturate:  ;\n  --tw-sepia:  ;\n  --tw-drop-shadow:  ;\n  --tw-backdrop-blur:  ;\n  --tw-backdrop-brightness:  ;\n  --tw-backdrop-contrast:  ;\n  --tw-backdrop-grayscale:  ;\n  --tw-backdrop-hue-rotate:  ;\n  --tw-backdrop-invert:  ;\n  --tw-backdrop-opacity:  ;\n  --tw-backdrop-saturate:  ;\n  --tw-backdrop-sepia:  ;\n}\n\n.container {\n  width: 100%;\n}\n\n@media (min-width: 640px) {\n  .container {\n    max-width: 640px;\n  }\n}\n\n@media (min-width: 768px) {\n  .container {\n    max-width: 768px;\n  }\n}\n\n@media (min-width: 1024px) {\n  .container {\n    max-width: 1024px;\n  }\n}\n\n@media (min-width: 1280px) {\n  .container {\n    max-width: 1280px;\n  }\n}\n\n@media (min-width: 1536px) {\n  .container {\n    max-width: 1536px;\n  }\n}\n\n.static {\n  position: static;\n}\n\n.mx-auto {\n  margin-left: auto;\n  margin-right: auto;\n}\n\n.mb-12 {\n  margin-bottom: 3rem;\n}\n\n.mb-4 {\n  margin-bottom: 1rem;\n}\n\n.mb-5 {\n  margin-bottom: 1.25rem;\n}\n\n.mb-8 {\n  margin-bottom: 2rem;\n}\n\n.ml-1 {\n  margin-left: 0.25rem;\n}\n\n.ml-3 {\n  margin-left: 0.75rem;\n}\n\n.mr-3 {\n  margin-right: 0.75rem;\n}\n\n.mt-4 {\n  margin-top: 1rem;\n}\n\n.flex {\n  display: flex;\n}\n\n.inline-flex {\n  display: inline-flex;\n}\n\n.h-10 {\n  height: 2.5rem;\n}\n\n.h-5 {\n  height: 1.25rem;\n}\n\n.w-1\\/2 {\n  width: 50%;\n}\n\n.w-10 {\n  width: 2.5rem;\n}\n\n.w-5 {\n  width: 1.25rem;\n}\n\n.w-full {\n  width: 100%;\n}\n\n.w-5\\/6 {\n  width: 83.333333%;\n}\n\n.flex-shrink-0 {\n  flex-shrink: 0;\n}\n\n.appearance-none {\n  -webkit-appearance: none;\n     -moz-appearance: none;\n          appearance: none;\n}\n\n.flex-col {\n  flex-direction: column;\n}\n\n.flex-wrap {\n  flex-wrap: wrap;\n}\n\n.items-center {\n  align-items: center;\n}\n\n.justify-center {\n  justify-content: center;\n}\n\n.rounded {\n  border-radius: 0.25rem;\n}\n\n.rounded-full {\n  border-radius: 9999px;\n}\n\n.border-0 {\n  border-width: 0px;\n}\n\n.border-4 {\n  border-width: 4px;\n}\n\n.border-b {\n  border-bottom-width: 1px;\n}\n\n.border-none {\n  border-style: none;\n}\n\n.border-teal-500 {\n  --tw-border-opacity: 1;\n  border-color: rgb(20 184 166 / var(--tw-border-opacity));\n}\n\n.bg-gray-800 {\n  --tw-bg-opacity: 1;\n  background-color: rgb(31 41 55 / var(--tw-bg-opacity));\n}\n\n.bg-gray-900 {\n  --tw-bg-opacity: 1;\n  background-color: rgb(17 24 39 / var(--tw-bg-opacity));\n}\n\n.bg-indigo-500 {\n  --tw-bg-opacity: 1;\n  background-color: rgb(99 102 241 / var(--tw-bg-opacity));\n}\n\n.bg-teal-500 {\n  --tw-bg-opacity: 1;\n  background-color: rgb(20 184 166 / var(--tw-bg-opacity));\n}\n\n.bg-transparent {\n  background-color: transparent;\n}\n\n.object-cover {\n  -o-object-fit: cover;\n     object-fit: cover;\n}\n\n.object-center {\n  -o-object-position: center;\n     object-position: center;\n}\n\n.p-2 {\n  padding: 0.5rem;\n}\n\n.p-5 {\n  padding: 1.25rem;\n}\n\n.px-2 {\n  padding-left: 0.5rem;\n  padding-right: 0.5rem;\n}\n\n.px-3 {\n  padding-left: 0.75rem;\n  padding-right: 0.75rem;\n}\n\n.px-5 {\n  padding-left: 1.25rem;\n  padding-right: 1.25rem;\n}\n\n.py-1 {\n  padding-top: 0.25rem;\n  padding-bottom: 0.25rem;\n}\n\n.py-2 {\n  padding-top: 0.5rem;\n  padding-bottom: 0.5rem;\n}\n\n.py-24 {\n  padding-top: 6rem;\n  padding-bottom: 6rem;\n}\n\n.py-8 {\n  padding-top: 2rem;\n  padding-bottom: 2rem;\n}\n\n.text-center {\n  text-align: center;\n}\n\n.text-2xl {\n  font-size: 1.5rem;\n  line-height: 2rem;\n}\n\n.text-3xl {\n  font-size: 1.875rem;\n  line-height: 2.25rem;\n}\n\n.text-base {\n  font-size: 1rem;\n  line-height: 1.5rem;\n}\n\n.text-sm {\n  font-size: 0.875rem;\n  line-height: 1.25rem;\n}\n\n.text-xl {\n  font-size: 1.25rem;\n  line-height: 1.75rem;\n}\n\n.font-medium {\n  font-weight: 500;\n}\n\n.leading-relaxed {\n  line-height: 1.625;\n}\n\n.leading-tight {\n  line-height: 1.25;\n}\n\n.text-gray-400 {\n  --tw-text-opacity: 1;\n  color: rgb(156 163 175 / var(--tw-text-opacity));\n}\n\n.text-gray-500 {\n  --tw-text-opacity: 1;\n  color: rgb(107 114 128 / var(--tw-text-opacity));\n}\n\n.text-gray-600 {\n  --tw-text-opacity: 1;\n  color: rgb(75 85 99 / var(--tw-text-opacity));\n}\n\n.text-gray-700 {\n  --tw-text-opacity: 1;\n  color: rgb(55 65 81 / var(--tw-text-opacity));\n}\n\n.text-gray-900 {\n  --tw-text-opacity: 1;\n  color: rgb(17 24 39 / var(--tw-text-opacity));\n}\n\n.text-white {\n  --tw-text-opacity: 1;\n  color: rgb(255 255 255 / var(--tw-text-opacity));\n}\n\n.hover\\:border-teal-700:hover {\n  --tw-border-opacity: 1;\n  border-color: rgb(15 118 110 / var(--tw-border-opacity));\n}\n\n.hover\\:bg-gray-700:hover {\n  --tw-bg-opacity: 1;\n  background-color: rgb(55 65 81 / var(--tw-bg-opacity));\n}\n\n.hover\\:bg-teal-700:hover {\n  --tw-bg-opacity: 1;\n  background-color: rgb(15 118 110 / var(--tw-bg-opacity));\n}\n\n.focus\\:outline-none:focus {\n  outline: 2px solid transparent;\n  outline-offset: 2px;\n}\n\n@media (min-width: 640px) {\n  .sm\\:ml-4 {\n    margin-left: 1rem;\n  }\n\n  .sm\\:ml-auto {\n    margin-left: auto;\n  }\n\n  .sm\\:mt-0 {\n    margin-top: 0px;\n  }\n\n  .sm\\:flex-row {\n    flex-direction: row;\n  }\n\n  .sm\\:justify-start {\n    justify-content: flex-start;\n  }\n\n  .sm\\:border-l-2 {\n    border-left-width: 2px;\n  }\n\n  .sm\\:border-gray-800 {\n    --tw-border-opacity: 1;\n    border-color: rgb(31 41 55 / var(--tw-border-opacity));\n  }\n\n  .sm\\:py-2 {\n    padding-top: 0.5rem;\n    padding-bottom: 0.5rem;\n  }\n\n  .sm\\:pl-4 {\n    padding-left: 1rem;\n  }\n\n  .sm\\:text-3xl {\n    font-size: 1.875rem;\n    line-height: 2.25rem;\n  }\n\n  .sm\\:text-4xl {\n    font-size: 2.25rem;\n    line-height: 2.5rem;\n  }\n}\n\n@media (min-width: 768px) {\n  .md\\:mb-0 {\n    margin-bottom: 0px;\n  }\n\n  .md\\:ml-auto {\n    margin-left: auto;\n  }\n\n  .md\\:mt-0 {\n    margin-top: 0px;\n  }\n\n  .md\\:w-3\\/6 {\n    width: 50%;\n  }\n\n  .md\\:w-1\\/2 {\n    width: 50%;\n  }\n\n  .md\\:flex-row {\n    flex-direction: row;\n  }\n\n  .md\\:justify-start {\n    justify-content: flex-start;\n  }\n}\n\n@media (min-width: 1024px) {\n  .lg\\:w-2\\/3 {\n    width: 66.666667%;\n  }\n\n  .lg\\:w-2\\/6 {\n    width: 33.333333%;\n  }\n\n  .lg\\:w-1\\/2 {\n    width: 50%;\n  }\n}","size_bytes":15213},"ghalib/static/css/main.css":{"content":"        :root {\n            /* iOS-Style Dark Mode Color System */\n            /* Background Colors */\n            --black: #000000;                    /* Primary background - true black */\n            --gray-50: #0D0D0D;                  /* Navigation bar background */\n            --gray-100: #1C1C1E;                 /* Secondary background - Cards/Lists */\n            --gray-200: #2C2C2E;                 /* Tertiary background - Elevated cards */\n            --gray-300: #3A3A3C;                 /* Dividers/Lines */\n            --gray-400: #48484A;                 /* Borders */\n            --gray-500: #636366;                 /* Subtle elements */\n            --gray-600: #8E8E93;                 /* Tab bar inactive */\n            --gray-700: #9999A5;                 /* Secondary text solid */\n            --gray-800: #AEAEB2;                 /* Light gray */\n            --gray-900: #C7C7CC;                 /* Lighter gray */\n            --white: #ffffff;\n            \n            /* Accent Colors - iOS Style */\n            --primary: #0A84FF;                  /* iOS Blue - Primary accent */\n            --primary-dark: #006EDC;             /* Pressed accent */\n            --success: #30D158;                  /* iOS Green */\n            --warning: #FF9F0A;                  /* iOS Orange */\n            --info: #64D2FF;                     /* iOS Cyan */\n            --danger: #FF453A;                   /* iOS Red - Destructive */\n            --accent: #BF5AF2;                   /* iOS Purple */\n            \n            /* Text Colors - iOS System */\n            --text-primary: #FFFFFF;             /* Primary text - Headings */\n            --text-secondary: #9999A5;           /* Secondary text - Descriptions (60% opacity equivalent) */\n            --text-light: #56565E;               /* Tertiary text - Labels (30% opacity equivalent) */\n            --text-disabled: #3A3A3E;            /* Quaternary text - Disabled (18% opacity equivalent) */\n            \n            /* Background & Borders */\n            --background: var(--black);\n            --card-bg: var(--gray-100);\n            --card-hover: var(--gray-200);\n            --border: var(--gray-300);\n            --border-light: var(--gray-400);\n            \n            /* Shadows - iOS Style */\n            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);\n            --shadow: 0 2px 12px rgba(0, 0, 0, 0.5);\n            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.6);\n            --shadow-lg: 0 4px 20px rgba(0, 0, 0, 0.6);\n            --shadow-xl: 0 8px 32px rgba(0, 0, 0, 0.7);\n            \n            /* Gradients - iOS Dark */\n            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);\n            --gradient-success: linear-gradient(135deg, var(--success) 0%, #28CD4B 100%);\n            --gradient-warning: linear-gradient(135deg, var(--warning) 0%, #FF8800 100%);\n            --gradient-accent: linear-gradient(135deg, var(--accent) 0%, #A646E8 100%);\n            --gradient-bg: linear-gradient(135deg, var(--black) 0%, var(--gray-50) 100%);\n            \n            /* Border Radius - iOS Style */\n            --radius-sm: 0.5rem;\n            --radius: 0.75rem;\n            --radius-md: 1rem;\n            --radius-lg: 1.25rem;\n            --radius-xl: 1.5rem;\n        }\n\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            font-family: system-ui, -apple-system, sans-serif;\n            background: linear-gradient(135deg, var(--black) 0%, var(--gray-100) 100%);\n            min-height: 100vh;\n            line-height: 1.6;\n            color: var(--text-primary);\n            margin: 0;\n            padding-top: 70px;\n        }\n\n        .navbar {\n            background-color: var(--gray-100);\n            box-shadow: var(--shadow-lg);\n            position: fixed;\n            width: 100%;\n            top: 0;\n            z-index: 1000;\n            border-bottom: 1px solid var(--border);\n        }\n\n        .navbar-content {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 1rem 5%;\n            max-width: 1400px;\n            margin: 0 auto;\n        }\n\n        .navbar-brand {\n            display: flex;\n            align-items: center;\n            gap: 0.75rem;\n            font-size: 1.5rem;\n            font-weight: 800;\n            color: var(--text-primary);\n            text-decoration: none;\n        }\n\n        .navbar-brand i {\n            font-size: 2rem;\n            color: var(--primary);\n        }\n\n        .navbar-nav {\n            display: flex;\n            list-style: none;\n            gap: 2rem;\n            margin: 0;\n            padding: 0;\n            align-items: center;\n        }\n\n        .nav-link {\n            text-decoration: none;\n            color: var(--text-secondary);\n            font-weight: 500;\n            font-size: 0.95rem;\n            padding: 0.5rem 0;\n            position: relative;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            gap: 0.5rem;\n        }\n\n        .nav-link:hover {\n            color: var(--text-primary);\n        }\n\n        .nav-link::after {\n            content: '';\n            position: absolute;\n            bottom: 0;\n            left: 0;\n            width: 0;\n            height: 2px;\n            background-color: var(--primary);\n            transition: width 0.3s ease;\n        }\n\n        .nav-link:hover::after {\n            width: 100%;\n        }\n\n        .hamburger {\n            display: none;\n            background: linear-gradient(135deg, rgba(52, 199, 89, 0.1), rgba(0, 179, 65, 0.1));\n            border: 1px solid rgba(52, 199, 89, 0.3);\n            cursor: pointer;\n            padding: 0.5rem;\n            outline: none;\n            width: 44px;\n            height: 44px;\n            border-radius: 12px;\n            transition: all 0.3s ease;\n            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);\n        }\n        \n        .hamburger:hover {\n            background: linear-gradient(135deg, rgba(52, 199, 89, 0.15), rgba(0, 179, 65, 0.15));\n            transform: scale(1.05);\n        }\n\n        .hamburger span {\n            display: block;\n            width: 22px;\n            height: 2.5px;\n            background: linear-gradient(90deg, #34C759, #00B341);\n            margin: 4px auto;\n            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);\n            border-radius: 2px;\n        }\n\n        .notifications-nav {\n            position: relative;\n        }\n\n        .notifications-link {\n            position: relative;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            width: 40px;\n            height: 40px;\n            border-radius: 50%;\n            transition: all 0.3s ease;\n            background: var(--gray-100);\n            color: var(--text-secondary);\n        }\n\n        .notifications-link:hover {\n            background: var(--gray-200);\n            color: var(--text-primary);\n        }\n\n        .notification-badge {\n            position: absolute;\n            top: -2px;\n            right: -2px;\n            background: var(--danger);\n            color: white;\n            border-radius: 50%;\n            width: 18px;\n            height: 18px;\n            font-size: 0.7rem;\n            font-weight: 600;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            animation: pulse 2s infinite;\n        }\n\n        @keyframes pulse {\n            0% { transform: scale(1); }\n            50% { transform: scale(1.1); }\n            100% { transform: scale(1); }\n        }\n\n        .btn {\n            display: inline-flex;\n            align-items: center;\n            gap: 0.5rem;\n            padding: 0.75rem 1.5rem;\n            border: none;\n            border-radius: var(--radius);\n            font-weight: 600;\n            text-decoration: none;\n            cursor: pointer;\n            transition: all 0.2s;\n            font-size: 0.9rem;\n            color: var(--white);\n        }\n\n        .btn-primary {\n            background: var(--gradient-primary);\n            color: white;\n        }\n\n        .btn-primary:hover {\n            transform: translateY(-2px);\n            box-shadow: var(--shadow-lg);\n        }\n\n        .btn-secondary {\n            background: var(--gray-200);\n            color: var(--text-primary);\n            border: 1px solid var(--border);\n        }\n\n        .btn-secondary:hover {\n            background: var(--gray-300);\n            color: var(--white);\n            transform: translateY(-2px);\n        }\n\n        .btn-success {\n            background: var(--success);\n            color: white;\n        }\n\n        .btn-warning {\n            background: var(--warning);\n            color: white;\n        }\n\n        .btn-danger {\n            background: var(--danger);\n            color: white;\n        }\n\n        .btn-sm {\n            padding: 0.5rem 1rem;\n            font-size: 0.8rem;\n        }\n\n        .container {\n            max-width: 1400px;\n            margin: 0 auto;\n            padding: 2rem;\n        }\n\n        .flash-messages {\n            margin: 1rem 0;\n        }\n\n        .flash-message {\n            padding: 1rem 1.5rem;\n            border-radius: var(--radius);\n            margin-bottom: 0.75rem;\n            display: flex;\n            align-items: center;\n            gap: 0.75rem;\n            border: 1px solid;\n            background: var(--gray-100);\n            box-shadow: var(--shadow-sm);\n        }\n\n        .flash-message.success {\n            background: rgba(48, 209, 88, 0.1);\n            color: var(--success);\n            border-color: rgba(48, 209, 88, 0.3);\n        }\n\n        .flash-message.error {\n            background: rgba(255, 69, 58, 0.1);\n            color: var(--danger);\n            border-color: rgba(255, 69, 58, 0.3);\n        }\n\n        .flash-message.warning {\n            background: rgba(255, 159, 10, 0.1);\n            color: var(--warning);\n            border-color: rgba(255, 159, 10, 0.3);\n        }\n\n        .flash-message.info {\n            background: rgba(100, 210, 255, 0.1);\n            color: var(--info);\n            border-color: rgba(100, 210, 255, 0.3);\n        }\n\n        .card {\n            background: var(--card-bg);\n            border-radius: var(--radius-lg);\n            padding: 2rem;\n            box-shadow: var(--shadow-lg);\n            margin-bottom: 2rem;\n            position: relative;\n            overflow: hidden;\n            border: 1px solid var(--border);\n            transition: all 0.3s ease;\n        }\n\n        .card:hover {\n            background: var(--card-hover);\n            box-shadow: var(--shadow-xl);\n        }\n\n        .card::before {\n            content: '';\n            position: absolute;\n            top: 0;\n            left: 0;\n            right: 0;\n            height: 4px;\n            background: var(--gradient-primary);\n        }\n\n        .page-container {\n            max-width: 1400px;\n            margin: 0 auto;\n            padding: 2rem;\n        }\n\n        .page-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 2rem;\n            padding: 2rem;\n            background: var(--card-bg);\n            border-radius: var(--radius-lg);\n            box-shadow: var(--shadow-md);\n            border: 1px solid var(--border);\n        }\n\n        .header-content h1 {\n            font-size: 2.25rem;\n            margin-bottom: 0.5rem;\n            color: var(--text-primary);\n            font-weight: 800;\n        }\n\n        .header-content p {\n            color: var(--text-secondary);\n            font-size: 1.1rem;\n        }\n\n        .header-actions {\n            display: flex;\n            gap: 1rem;\n        }\n\n        .stats-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n            gap: 1.5rem;\n            margin: 2rem 0;\n        }\n\n        .stat-card {\n            background: var(--card-bg);\n            padding: 1.5rem;\n            border-radius: var(--radius-lg);\n            box-shadow: var(--shadow-md);\n            text-align: center;\n            position: relative;\n            overflow: hidden;\n            transition: transform 0.3s ease, box-shadow 0.3s ease;\n            border: 1px solid var(--border);\n        }\n        \n        .stat-card:hover {\n            background: var(--card-hover);\n        }\n\n        .stat-card:hover {\n            transform: translateY(-5px);\n            box-shadow: var(--shadow-lg);\n        }\n\n        .stat-card::before {\n            content: '';\n            position: absolute;\n            top: 0;\n            left: 0;\n            right: 0;\n            height: 4px;\n            background: var(--gradient-primary);\n        }\n\n        .stat-number {\n            font-size: 2.5rem;\n            font-weight: 800;\n            color: var(--text-primary);\n            display: block;\n            line-height: 1;\n            margin-bottom: 0.5rem;\n        }\n\n        .stat-label {\n            color: var(--text-secondary);\n            font-weight: 600;\n            font-size: 0.9rem;\n        }\n\n        .form-group {\n            margin-bottom: 1.5rem;\n        }\n\n        .form-group label {\n            display: block;\n            margin-bottom: 0.5rem;\n            font-weight: 600;\n            color: var(--text-primary);\n        }\n\n        .form-group input,\n        .form-group select,\n        .form-group textarea {\n            width: 100%;\n            padding: 0.75rem 1rem;\n            border: 1px solid var(--border);\n            border-radius: var(--radius);\n            font-size: 1rem;\n            transition: all 0.2s;\n            color: var(--text-primary);\n            background: var(--gray-200);\n        }\n\n        .form-group input:focus,\n        .form-group select:focus,\n        .form-group textarea:focus {\n            outline: none;\n            border-color: var(--primary);\n            background: var(--gray-300);\n            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);\n        }\n\n        .form-group input::placeholder,\n        .form-group textarea::placeholder {\n            color: var(--text-light);\n        }\n\n        .empty-state {\n            text-align: center;\n            padding: 3rem 2rem;\n            color: var(--text-secondary);\n        }\n\n        .empty-state i {\n            font-size: 3rem;\n            color: var(--gray-400);\n            margin-bottom: 1rem;\n        }\n\n        .empty-state h3 {\n            color: var(--text-primary);\n            margin-bottom: 1rem;\n            font-weight: 600;\n        }\n\n        /* Mobile Menu Styles */\n        @media (max-width: 768px) {\n            .navbar-nav {\n                position: absolute;\n                top: 100%;\n                left: -100%;\n                width: 100%;\n                background-color: var(--gray-100);\n                flex-direction: column;\n                align-items: stretch;\n                padding: 1rem 0;\n                box-shadow: var(--shadow-lg);\n                transition: all 0.4s ease;\n                border-top: 1px solid var(--border);\n            }\n            \n            .navbar-nav.active {\n                left: 0;\n            }\n            \n            .navbar-nav li {\n                width: 100%;\n                text-align: left;\n            }\n            \n            .nav-link {\n                padding: 1rem 2rem;\n                display: flex;\n                width: 100%;\n                color: var(--text-primary);\n                border-bottom: 1px solid var(--gray-100);\n            }\n            \n            .nav-link:last-child {\n                border-bottom: none;\n            }\n            \n            .hamburger {\n                display: flex;\n                flex-direction: column;\n                justify-content: center;\n            }\n            \n            .hamburger.active span:nth-child(1) {\n                transform: rotate(45deg) translate(6px, 6px);\n            }\n            \n            .hamburger.active span:nth-child(2) {\n                opacity: 0;\n            }\n            \n            .hamburger.active span:nth-child(3) {\n                transform: rotate(-45deg) translate(6px, -6px);\n            }\n            \n            .page-header {\n                flex-direction: column;\n                gap: 1.5rem;\n                text-align: center;\n            }\n            \n            .header-actions {\n                width: 100%;\n                justify-content: center;\n            }\n            \n            .container,\n            .page-container {\n                padding: 1rem;\n            }\n            \n            .navbar-content {\n                padding: 1rem;\n            }\n        }\n\n        /* Tables - iOS Dark Theme */\n        table {\n            width: 100%;\n            border-collapse: collapse;\n            background: var(--card-bg);\n            border-radius: var(--radius-lg);\n            overflow: hidden;\n            box-shadow: var(--shadow);\n        }\n\n        thead {\n            background: var(--gray-200);\n        }\n\n        th {\n            padding: 1rem;\n            text-align: left;\n            font-weight: 600;\n            color: var(--text-primary);\n            border-bottom: 1px solid var(--border);\n        }\n\n        td {\n            padding: 1rem;\n            color: var(--text-secondary);\n            border-bottom: 1px solid var(--gray-300);\n        }\n\n        tbody tr {\n            transition: background 0.2s ease;\n        }\n\n        tbody tr:hover {\n            background: var(--card-hover);\n        }\n\n        tbody tr:last-child td {\n            border-bottom: none;\n        }\n\n        /* Badges - iOS Dark Theme */\n        .badge {\n            display: inline-block;\n            padding: 0.35rem 0.75rem;\n            border-radius: var(--radius);\n            font-size: 0.85rem;\n            font-weight: 600;\n            text-align: center;\n        }\n\n        .badge-primary {\n            background: rgba(10, 132, 255, 0.15);\n            color: var(--primary);\n            border: 1px solid rgba(10, 132, 255, 0.3);\n        }\n\n        .badge-success {\n            background: rgba(48, 209, 88, 0.15);\n            color: var(--success);\n            border: 1px solid rgba(48, 209, 88, 0.3);\n        }\n\n        .badge-warning {\n            background: rgba(255, 159, 10, 0.15);\n            color: var(--warning);\n            border: 1px solid rgba(255, 159, 10, 0.3);\n        }\n\n        .badge-danger {\n            background: rgba(255, 69, 58, 0.15);\n            color: var(--danger);\n            border: 1px solid rgba(255, 69, 58, 0.3);\n        }\n\n        .badge-info {\n            background: rgba(100, 210, 255, 0.15);\n            color: var(--info);\n            border: 1px solid rgba(100, 210, 255, 0.3);\n        }\n\n        .badge-secondary {\n            background: var(--gray-200);\n            color: var(--text-secondary);\n            border: 1px solid var(--border);\n        }\n\n        /* Progress Bars - iOS Dark Theme */\n        .progress {\n            background: var(--gray-200);\n            border-radius: var(--radius);\n            height: 10px;\n            overflow: hidden;\n            position: relative;\n        }\n\n        .progress-bar {\n            height: 100%;\n            background: var(--gradient-primary);\n            transition: width 0.3s ease;\n            border-radius: var(--radius);\n        }\n\n        .progress-bar.success {\n            background: var(--gradient-success);\n        }\n\n        .progress-bar.warning {\n            background: var(--gradient-warning);\n        }\n\n        .progress-bar.danger {\n            background: linear-gradient(135deg, var(--danger) 0%, #E03A31 100%);\n        }\n\n        /* List Groups - iOS Dark Theme */\n        .list-group {\n            background: var(--card-bg);\n            border-radius: var(--radius-lg);\n            overflow: hidden;\n            box-shadow: var(--shadow);\n        }\n\n        .list-group-item {\n            padding: 1rem 1.5rem;\n            color: var(--text-primary);\n            border-bottom: 1px solid var(--gray-300);\n            transition: all 0.2s ease;\n            background: transparent;\n        }\n\n        .list-group-item:hover {\n            background: var(--card-hover);\n        }\n\n        .list-group-item:last-child {\n            border-bottom: none;\n        }\n\n        .list-group-item.active {\n            background: rgba(10, 132, 255, 0.15);\n            border-left: 3px solid var(--primary);\n        }\n\n        /* Modals - iOS Dark Theme */\n        .modal {\n            background: rgba(0, 0, 0, 0.85);\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            z-index: 9999;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            backdrop-filter: blur(10px);\n        }\n\n        .modal-content {\n            background: var(--card-bg);\n            border-radius: var(--radius-lg);\n            padding: 2rem;\n            max-width: 600px;\n            width: 90%;\n            box-shadow: var(--shadow-xl);\n            border: 1px solid var(--border);\n        }\n\n        .modal-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 1.5rem;\n            padding-bottom: 1rem;\n            border-bottom: 1px solid var(--border);\n        }\n\n        .modal-header h3 {\n            color: var(--text-primary);\n            font-size: 1.5rem;\n            font-weight: 700;\n        }\n\n        .modal-body {\n            color: var(--text-secondary);\n            margin-bottom: 1.5rem;\n        }\n\n        .modal-footer {\n            display: flex;\n            gap: 1rem;\n            justify-content: flex-end;\n            padding-top: 1rem;\n            border-top: 1px solid var(--border);\n        }\n\n        /* Alerts - iOS Dark Theme */\n        .alert {\n            padding: 1rem 1.5rem;\n            border-radius: var(--radius);\n            margin-bottom: 1rem;\n            border: 1px solid;\n            display: flex;\n            align-items: center;\n            gap: 0.75rem;\n        }\n\n        .alert-success {\n            background: rgba(48, 209, 88, 0.1);\n            color: var(--success);\n            border-color: rgba(48, 209, 88, 0.3);\n        }\n\n        .alert-warning {\n            background: rgba(255, 159, 10, 0.1);\n            color: var(--warning);\n            border-color: rgba(255, 159, 10, 0.3);\n        }\n\n        .alert-danger {\n            background: rgba(255, 69, 58, 0.1);\n            color: var(--danger);\n            border-color: rgba(255, 69, 58, 0.3);\n        }\n\n        .alert-info {\n            background: rgba(100, 210, 255, 0.1);\n            color: var(--info);\n            border-color: rgba(100, 210, 255, 0.3);\n        }\n\n        /* Pagination - iOS Dark Theme */\n        .pagination {\n            display: flex;\n            gap: 0.5rem;\n            justify-content: center;\n            margin: 2rem 0;\n        }\n\n        .pagination a,\n        .pagination span {\n            padding: 0.5rem 1rem;\n            background: var(--card-bg);\n            border: 1px solid var(--border);\n            border-radius: var(--radius);\n            color: var(--text-primary);\n            text-decoration: none;\n            transition: all 0.2s ease;\n        }\n\n        .pagination a:hover {\n            background: var(--card-hover);\n            border-color: var(--primary);\n            color: var(--primary);\n        }\n\n        .pagination .active {\n            background: var(--primary);\n            border-color: var(--primary);\n            color: var(--white);\n        }\n\n        /* Breadcrumbs - iOS Dark Theme */\n        .breadcrumb {\n            display: flex;\n            gap: 0.5rem;\n            padding: 1rem;\n            background: var(--card-bg);\n            border-radius: var(--radius);\n            margin-bottom: 1rem;\n        }\n\n        .breadcrumb a {\n            color: var(--primary);\n            text-decoration: none;\n        }\n\n        .breadcrumb a:hover {\n            text-decoration: underline;\n        }\n\n        .breadcrumb-separator {\n            color: var(--text-light);\n        }\n\n        /* Video Player Container - iOS Dark Theme */\n        .video-container {\n            background: var(--black);\n            border-radius: var(--radius-lg);\n            overflow: hidden;\n            box-shadow: var(--shadow-lg);\n            position: relative;\n        }\n\n        .video-container iframe {\n            border-radius: var(--radius-lg);\n        }\n\n        /* Code Blocks - iOS Dark Theme */\n        pre, code {\n            background: var(--gray-200);\n            color: var(--text-primary);\n            border-radius: var(--radius);\n            padding: 0.25rem 0.5rem;\n            font-family: 'Courier New', monospace;\n        }\n\n        pre {\n            padding: 1rem;\n            overflow-x: auto;\n            border: 1px solid var(--border);\n        }\n\n        /* Tooltips - iOS Dark Theme */\n        .tooltip {\n            background: var(--gray-100);\n            color: var(--text-primary);\n            padding: 0.5rem 1rem;\n            border-radius: var(--radius);\n            font-size: 0.85rem;\n            box-shadow: var(--shadow-lg);\n            border: 1px solid var(--border);\n        }\n\n        /* Dropdown Menus - iOS Dark Theme */\n        .dropdown-menu {\n            background: var(--card-bg);\n            border: 1px solid var(--border);\n            border-radius: var(--radius-lg);\n            box-shadow: var(--shadow-lg);\n            padding: 0.5rem 0;\n            min-width: 200px;\n        }\n\n        .dropdown-item {\n            padding: 0.75rem 1.5rem;\n            color: var(--text-primary);\n            text-decoration: none;\n            display: block;\n            transition: all 0.2s ease;\n        }\n\n        .dropdown-item:hover {\n            background: var(--card-hover);\n            color: var(--primary);\n        }\n\n        .dropdown-divider {\n            height: 1px;\n            background: var(--border);\n            margin: 0.5rem 0;\n        }\n\n        /* Tabs - iOS Dark Theme */\n        .nav-tabs {\n            display: flex;\n            gap: 0.5rem;\n            border-bottom: 1px solid var(--border);\n            margin-bottom: 1.5rem;\n        }\n\n        .nav-tabs .nav-link {\n            padding: 0.75rem 1.5rem;\n            color: var(--text-secondary);\n            border: none;\n            border-bottom: 2px solid transparent;\n            transition: all 0.2s ease;\n            background: transparent;\n        }\n\n        .nav-tabs .nav-link:hover {\n            color: var(--text-primary);\n            border-bottom-color: var(--gray-500);\n        }\n\n        .nav-tabs .nav-link.active {\n            color: var(--primary);\n            border-bottom-color: var(--primary);\n        }\n\n        /* Utility classes */\n        .text-center { text-align: center; }\n        .text-muted { color: var(--text-secondary); }\n        .text-primary { color: var(--primary); }\n        .text-success { color: var(--success); }\n        .text-warning { color: var(--warning); }\n        .text-danger { color: var(--danger); }\n        .mb-0 { margin-bottom: 0; }\n        .mb-1 { margin-bottom: 0.5rem; }\n        .mb-2 { margin-bottom: 1rem; }\n        .mb-3 { margin-bottom: 1.5rem; }\n        .mt-2 { margin-top: 1rem; }\n        .d-flex { display: flex; }\n        .justify-between { justify-content: space-between; }\n        .align-center { align-items: center; }\n        .gap-1 { gap: 0.5rem; }\n        .gap-2 { gap: 1rem; }\n","size_bytes":27790},"static/js/main.js":{"content":"// Main JavaScript for LearnNest LMS\n// Mobile menu is handled in base.html to avoid conflicts\n\n// Flash message auto-dismiss\ndocument.addEventListener('DOMContentLoaded', function() {\n    const flashMessages = document.querySelectorAll('.flash-message');\n    \n    flashMessages.forEach(function(message) {\n        setTimeout(function() {\n            message.style.opacity = '0';\n            message.style.transform = 'translateX(100%)';\n            setTimeout(function() {\n                message.remove();\n            }, 300);\n        }, 5000);\n    });\n});\n\n// Utility function for confirming destructive actions\nfunction confirmAction(message) {\n    return confirm(message || 'Are you sure you want to proceed?');\n}\n\n// Copy to clipboard utility\nfunction copyToClipboard(text) {\n    const textarea = document.createElement('textarea');\n    textarea.value = text;\n    textarea.style.position = 'fixed';\n    textarea.style.opacity = '0';\n    document.body.appendChild(textarea);\n    textarea.select();\n    document.execCommand('copy');\n    document.body.removeChild(textarea);\n    \n    // Show feedback\n    const feedback = document.createElement('div');\n    feedback.textContent = 'Copied to clipboard!';\n    feedback.className = 'flash-message success';\n    feedback.style.position = 'fixed';\n    feedback.style.top = '20px';\n    feedback.style.right = '20px';\n    feedback.style.zIndex = '10000';\n    document.body.appendChild(feedback);\n    \n    setTimeout(function() {\n        feedback.remove();\n    }, 2000);\n}\n","size_bytes":1518},"ghalib/static/js/main.js":{"content":"// Main JavaScript for LearnNest LMS\n// Mobile menu is handled in base.html to avoid conflicts\n\n// Flash message auto-dismiss\ndocument.addEventListener('DOMContentLoaded', function() {\n    const flashMessages = document.querySelectorAll('.flash-message');\n    \n    flashMessages.forEach(function(message) {\n        setTimeout(function() {\n            message.style.opacity = '0';\n            message.style.transform = 'translateX(100%)';\n            setTimeout(function() {\n                message.remove();\n            }, 300);\n        }, 5000);\n    });\n});\n\n// Utility function for confirming destructive actions\nfunction confirmAction(message) {\n    return confirm(message || 'Are you sure you want to proceed?');\n}\n\n// Copy to clipboard utility\nfunction copyToClipboard(text) {\n    const textarea = document.createElement('textarea');\n    textarea.value = text;\n    textarea.style.position = 'fixed';\n    textarea.style.opacity = '0';\n    document.body.appendChild(textarea);\n    textarea.select();\n    document.execCommand('copy');\n    document.body.removeChild(textarea);\n    \n    // Show feedback\n    const feedback = document.createElement('div');\n    feedback.textContent = 'Copied to clipboard!';\n    feedback.className = 'flash-message success';\n    feedback.style.position = 'fixed';\n    feedback.style.top = '20px';\n    feedback.style.right = '20px';\n    feedback.style.zIndex = '10000';\n    document.body.appendChild(feedback);\n    \n    setTimeout(function() {\n        feedback.remove();\n    }, 2000);\n}\n","size_bytes":1518},"templates/student/video_download/app.py":{"content":"\nfrom flask import *\nfrom pytubefix import YouTube\nimport os\nfrom datetime import datetime\nimport shutil\n\napp = Flask(__name__)\n\ni = 0  # rotating index for file naming\n\n# Create required folders\nif not os.path.exists('audios'):\n    os.mkdir('audios')\nif not os.path.exists('videos'):\n    os.mkdir('videos')\n\n\ndef clean_url(link: str) -> str:\n    \"\"\"Cleans YouTube URL by removing ?si= and other parameters.\"\"\"\n    return link.split(\"&\")[0].split(\"?\")[0]\n\n\ndef download_audio(link):\n    global i\n\n    clean = clean_url(link)\n\n    if len(os.listdir('audios')) > 5:\n        shutil.rmtree('audios')\n        os.mkdir('audios')\n\n    yt = YouTube(clean)\n\n    audio_stream = yt.streams.filter(only_audio=True).first()\n    out_file = audio_stream.download(output_path=\"audios\", filename=f\"{i}.mp3\")\n\n    os.system(\n        f'ffmpeg -y -loop 1 -r 1 -i static/images/flyer.jpg -i audios/{i}.mp3 '\n        f'-c:a copy -shortest -c:v libx264 audios/{i}.mp4'\n    )\n\n    os.remove(out_file)\n\n    ret_file = f\"audios/{i}.mp4\"\n\n    i = (i + 1) % 5\n\n    with open(\"history.txt\", \"a\") as myfile:\n        myfile.write(f\"\\n{datetime.now().strftime('%d/%m/%y__%H:%M:%S')} --> {link}\\n\")\n\n    return ret_file\n\n\ndef download_video(link):\n    global i\n\n    clean = clean_url(link)\n\n    if len(os.listdir('videos')) > 2:\n        shutil.rmtree('videos')\n        os.mkdir('videos')\n\n    yt = YouTube(clean)\n\n    stream = yt.streams.get_lowest_resolution()\n    out_file = stream.download(output_path=\"videos\", filename=f\"{i}.mp4\")\n\n    ret_file = f\"videos/{i}.mp4\"\n\n    i = (i + 1) % 2\n\n    with open(\"history.txt\", \"a\") as myfile:\n        myfile.write(f\"\\n{datetime.now().strftime('%d/%m/%y__%H:%M:%S')} --> {link}\\n\")\n\n    return ret_file\n\n\n@app.route('/')\ndef home():\n    return render_template('index.html')\n\n\n@app.route('/submit_audio', methods=['POST'])\ndef submit_audio():\n    link = request.form.get('link')\n    path = download_audio(link)\n    return send_file(path, as_attachment=True)\n\n\n@app.route('/submit', methods=['POST'])\ndef submit():\n    link = request.form.get('link')\n    path = download_video(link)\n    return send_file(path, as_attachment=True)\n\n\nif __name__ == \"__main__\":\n    app.run(debug=False, port=5000, host=\"0.0.0.0\")\n","size_bytes":2219},"zsam/utils/pdf_generator.py":{"content":"\"\"\"\nPDF Generator with Beautiful Design for LearnNest LMS\nGenerates professional, stylish PDF documents with LearnNest branding\n\"\"\"\n\nfrom reportlab.lib.pagesizes import letter, A4\nfrom reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle\nfrom reportlab.lib.units import inch\nfrom reportlab.lib.enums import TA_CENTER, TA_LEFT, TA_JUSTIFY, TA_RIGHT\nfrom reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, PageBreak, Table, TableStyle\nfrom reportlab.lib import colors\nfrom reportlab.pdfgen import canvas\nfrom datetime import datetime\nimport os\n\n\nclass BeautifulWatermarkedCanvas(canvas.Canvas):\n    \"\"\"Custom canvas with beautiful LearnNest branding and watermark\"\"\"\n    \n    def __init__(self, *args, **kwargs):\n        canvas.Canvas.__init__(self, *args, **kwargs)\n        self.pages = []\n        \n    def showPage(self):\n        self.pages.append(dict(self.__dict__))\n        self._startPage()\n        \n    def save(self):\n        page_count = len(self.pages)\n        for page_num, page in enumerate(self.pages, start=1):\n            self.__dict__.update(page)\n            self.draw_page_design(page_num, page_count)\n            canvas.Canvas.showPage(self)\n        canvas.Canvas.save(self)\n        \n    def draw_page_design(self, page_num, total_pages):\n        \"\"\"Draw beautiful page design with watermark and branding\"\"\"\n        page_width, page_height = letter\n        \n        # Save the state\n        self.saveState()\n        \n        # === WATERMARK (Diagonal) ===\n        self.setFont(\"Helvetica-Bold\", 70)\n        self.setFillColor(colors.Color(0.95, 0.95, 0.95, alpha=0.2))\n        self.translate(page_width / 2, page_height / 2)\n        self.rotate(45)\n        watermark_text = \"LearnNest\"\n        self.drawCentredString(0, 0, watermark_text)\n        self.restoreState()\n        \n        # === HEADER DESIGN ===\n        # Gradient-like header bar (simulated with rectangles)\n        header_y = page_height - 0.4 * inch\n        \n        # Top decorative line (primary color)\n        self.setFillColor(colors.HexColor(\"#6A0066\"))\n        self.rect(0, page_height - 0.15 * inch, page_width, 0.15 * inch, fill=1, stroke=0)\n        \n        # LearnNest branding in header\n        self.setFont(\"Helvetica-Bold\", 16)\n        self.setFillColor(colors.white)\n        self.drawString(0.75 * inch, page_height - 0.12 * inch, \"LearnNest\")\n        \n        # Tagline\n        self.setFont(\"Helvetica\", 8)\n        self.setFillColor(colors.white)\n        self.drawString(0.75 * inch, page_height - 0.28 * inch, \"Empowering Learning Through AI\")\n        \n        # === FOOTER DESIGN ===\n        # Footer decorative line\n        self.setFillColor(colors.HexColor(\"#6A0066\"))\n        self.rect(0, 0.6 * inch, page_width, 0.02 * inch, fill=1, stroke=0)\n        \n        # Page number\n        self.setFont(\"Helvetica\", 10)\n        self.setFillColor(colors.HexColor(\"#6A0066\"))\n        footer_text = f\"Page {page_num} of {total_pages}\"\n        self.drawCentredString(page_width / 2, 0.4 * inch, footer_text)\n        \n        # Copyright text\n        self.setFont(\"Helvetica-Oblique\", 8)\n        self.setFillColor(colors.gray)\n        self.drawCentredString(page_width / 2, 0.25 * inch, \"Â© LearnNest Learning Management System - AI Generated Content\")\n\n\ndef generate_transcript_pdf(transcript_text, video_title, course_name, student_name, output_path):\n    \"\"\"\n    Generate a beautiful, professional PDF transcript with LearnNest branding\n    \n    Args:\n        transcript_text (str): The AI-generated transcript content\n        video_title (str): Title of the video\n        course_name (str): Name of the course\n        student_name (str): Name of the student downloading the transcript\n        output_path (str): Full path where the PDF should be saved\n    \n    Returns:\n        bool: True if successful, False otherwise\n    \"\"\"\n    try:\n        # Ensure directory exists\n        os.makedirs(os.path.dirname(output_path), exist_ok=True)\n        \n        # Create the PDF document with custom canvas\n        doc = SimpleDocTemplate(\n            output_path,\n            pagesize=letter,\n            rightMargin=0.75*inch,\n            leftMargin=0.75*inch,\n            topMargin=0.75*inch,\n            bottomMargin=0.85*inch\n        )\n        \n        # Container for the 'Flowable' objects\n        story = []\n        \n        # Define custom styles\n        styles = getSampleStyleSheet()\n        \n        # === BEAUTIFUL TITLE STYLE ===\n        title_style = ParagraphStyle(\n            'BeautifulTitle',\n            parent=styles['Heading1'],\n            fontSize=24,\n            textColor=colors.HexColor(\"#6A0066\"),\n            spaceAfter=8,\n            spaceBefore=20,\n            alignment=TA_CENTER,\n            fontName='Helvetica-Bold',\n            leading=28\n        )\n        \n        # === SUBTITLE STYLE ===\n        subtitle_style = ParagraphStyle(\n            'SubtitleStyle',\n            parent=styles['Normal'],\n            fontSize=12,\n            textColor=colors.HexColor(\"#EE4B6A\"),\n            spaceAfter=20,\n            alignment=TA_CENTER,\n            fontName='Helvetica-Oblique'\n        )\n        \n        # === INFO BOX STYLE ===\n        info_label_style = ParagraphStyle(\n            'InfoLabel',\n            parent=styles['Normal'],\n            fontSize=10,\n            textColor=colors.HexColor(\"#6A0066\"),\n            fontName='Helvetica-Bold',\n            spaceAfter=2\n        )\n        \n        info_value_style = ParagraphStyle(\n            'InfoValue',\n            parent=styles['Normal'],\n            fontSize=11,\n            textColor=colors.HexColor(\"#333333\"),\n            fontName='Helvetica',\n            spaceAfter=8\n        )\n        \n        # === HEADING STYLE ===\n        heading_style = ParagraphStyle(\n            'BeautifulHeading',\n            parent=styles['Heading2'],\n            fontSize=14,\n            textColor=colors.HexColor(\"#6A0066\"),\n            spaceAfter=12,\n            spaceBefore=18,\n            fontName='Helvetica-Bold',\n            borderPadding=8,\n            leftIndent=10\n        )\n        \n        # === BODY STYLE ===\n        body_style = ParagraphStyle(\n            'BeautifulBody',\n            parent=styles['BodyText'],\n            fontSize=11,\n            alignment=TA_JUSTIFY,\n            spaceAfter=12,\n            leading=18,\n            textColor=colors.HexColor(\"#2C3E50\"),\n            fontName='Helvetica'\n        )\n        \n        # === DOCUMENT HEADER ===\n        story.append(Spacer(1, 0.3*inch))\n        \n        # Main Title\n        title = Paragraph(f'<b>{video_title}</b>', title_style)\n        story.append(title)\n        \n        # Subtitle\n        subtitle = Paragraph('AI-Generated Video Transcript', subtitle_style)\n        story.append(subtitle)\n        \n        story.append(Spacer(1, 0.2*inch))\n        \n        # === INFORMATION BOX ===\n        # Create a beautiful info table\n        info_data = [\n            [Paragraph('<b>Student Name:</b>', info_label_style), Paragraph(student_name, info_value_style)],\n            [Paragraph('<b>Course:</b>', info_label_style), Paragraph(course_name, info_value_style)],\n            [Paragraph('<b>Generated On:</b>', info_label_style), \n             Paragraph(datetime.now().strftime(\"%B %d, %Y at %I:%M %p\"), info_value_style)]\n        ]\n        \n        info_table = Table(info_data, colWidths=[1.5*inch, 4.5*inch])\n        info_table.setStyle(TableStyle([\n            ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor(\"#F8F9FA\")),\n            ('BOX', (0, 0), (-1, -1), 1, colors.HexColor(\"#6A0066\")),\n            ('LEFTPADDING', (0, 0), (-1, -1), 15),\n            ('RIGHTPADDING', (0, 0), (-1, -1), 15),\n            ('TOPPADDING', (0, 0), (-1, -1), 10),\n            ('BOTTOMPADDING', (0, 0), (-1, -1), 10),\n            ('VALIGN', (0, 0), (-1, -1), 'TOP'),\n        ]))\n        \n        story.append(info_table)\n        story.append(Spacer(1, 0.4*inch))\n        \n        # === TRANSCRIPT CONTENT HEADER ===\n        content_header = Paragraph(\n            '<b>â”â”â”â”â”â”â”â”â”â”â”  TRANSCRIPT CONTENT  â”â”â”â”â”â”â”â”â”â”â”</b>',\n            ParagraphStyle(\n                'ContentHeader',\n                parent=styles['Normal'],\n                fontSize=12,\n                textColor=colors.HexColor(\"#6A0066\"),\n                alignment=TA_CENTER,\n                spaceAfter=20,\n                fontName='Helvetica-Bold'\n            )\n        )\n        story.append(content_header)\n        \n        # === PROCESS TRANSCRIPT TEXT ===\n        sections = transcript_text.split('\\n\\n')\n        \n        for section in sections:\n            section = section.strip()\n            if not section:\n                continue\n            \n            lines = section.split('\\n')\n            first_line = lines[0].strip()\n            \n            # Check if this is a header\n            if (first_line.isupper() and len(first_line) < 60) or \\\n               (first_line and first_line[0].isdigit() and '.' in first_line[:5]):\n                # This is a heading with decorative element\n                heading_text = f'â–¸ {first_line}'\n                heading = Paragraph(heading_text, heading_style)\n                story.append(heading)\n                \n                # Add the rest as body text\n                if len(lines) > 1:\n                    body_text = '\\n'.join(lines[1:])\n                    para = Paragraph(body_text.replace('\\n', '<br/>'), body_style)\n                    story.append(para)\n            else:\n                # Regular paragraph\n                para = Paragraph(section.replace('\\n', '<br/>'), body_style)\n                story.append(para)\n            \n            story.append(Spacer(1, 0.1*inch))\n        \n        # === FOOTER NOTE ===\n        story.append(Spacer(1, 0.4*inch))\n        \n        footer_note_style = ParagraphStyle(\n            'FooterNote',\n            parent=styles['Normal'],\n            fontSize=9,\n            textColor=colors.gray,\n            alignment=TA_CENTER,\n            fontName='Helvetica-Oblique',\n            leading=12,\n            borderWidth=1,\n            borderColor=colors.HexColor(\"#E0E0E0\"),\n            borderPadding=10,\n            backColor=colors.HexColor(\"#F8F9FA\")\n        )\n        \n        footer_note = Paragraph(\n            '<b>âš  Disclaimer:</b> This transcript was automatically generated using advanced AI technology. '\n            'While we strive for high accuracy, please cross-reference important information with the original video content. '\n            'LearnNest is committed to providing quality educational resources.',\n            footer_note_style\n        )\n        story.append(footer_note)\n        \n        # Build PDF with beautiful watermarked canvas\n        doc.build(story, canvasmaker=BeautifulWatermarkedCanvas)\n        \n        return True\n        \n    except Exception as e:\n        print(f\"Error generating beautiful PDF: {e}\")\n        return False\n","size_bytes":10938},"LearnNestGemini/weather-app-abdulwaheed/templates/student/video_download/tailwind.config.js":{"content":"/** @type {import('tailwindcss').Config} */\nmodule.exports = {\n  content: [\"./templates/*\"],\n  theme: {\n    extend: {},\n  },\n  plugins: [],\n}\n\n","size_bytes":143},"ghalib/templates/student/video_download/app.py":{"content":"\nfrom flask import *\nfrom pytubefix import YouTube\nimport os\nfrom datetime import datetime\nimport shutil\n\napp = Flask(__name__)\n\ni = 0  # rotating index for file naming\n\n# Create required folders\nif not os.path.exists('audios'):\n    os.mkdir('audios')\nif not os.path.exists('videos'):\n    os.mkdir('videos')\n\n\ndef clean_url(link: str) -> str:\n    \"\"\"Cleans YouTube URL by removing ?si= and other parameters.\"\"\"\n    return link.split(\"&\")[0].split(\"?\")[0]\n\n\ndef download_audio(link):\n    global i\n\n    clean = clean_url(link)\n\n    if len(os.listdir('audios')) > 5:\n        shutil.rmtree('audios')\n        os.mkdir('audios')\n\n    yt = YouTube(clean)\n\n    audio_stream = yt.streams.filter(only_audio=True).first()\n    out_file = audio_stream.download(output_path=\"audios\", filename=f\"{i}.mp3\")\n\n    os.system(\n        f'ffmpeg -y -loop 1 -r 1 -i static/images/flyer.jpg -i audios/{i}.mp3 '\n        f'-c:a copy -shortest -c:v libx264 audios/{i}.mp4'\n    )\n\n    os.remove(out_file)\n\n    ret_file = f\"audios/{i}.mp4\"\n\n    i = (i + 1) % 5\n\n    with open(\"history.txt\", \"a\") as myfile:\n        myfile.write(f\"\\n{datetime.now().strftime('%d/%m/%y__%H:%M:%S')} --> {link}\\n\")\n\n    return ret_file\n\n\ndef download_video(link):\n    global i\n\n    clean = clean_url(link)\n\n    if len(os.listdir('videos')) > 2:\n        shutil.rmtree('videos')\n        os.mkdir('videos')\n\n    yt = YouTube(clean)\n\n    stream = yt.streams.get_lowest_resolution()\n    out_file = stream.download(output_path=\"videos\", filename=f\"{i}.mp4\")\n\n    ret_file = f\"videos/{i}.mp4\"\n\n    i = (i + 1) % 2\n\n    with open(\"history.txt\", \"a\") as myfile:\n        myfile.write(f\"\\n{datetime.now().strftime('%d/%m/%y__%H:%M:%S')} --> {link}\\n\")\n\n    return ret_file\n\n\n@app.route('/')\ndef home():\n    return render_template('index.html')\n\n\n@app.route('/submit_audio', methods=['POST'])\ndef submit_audio():\n    link = request.form.get('link')\n    path = download_audio(link)\n    return send_file(path, as_attachment=True)\n\n\n@app.route('/submit', methods=['POST'])\ndef submit():\n    link = request.form.get('link')\n    path = download_video(link)\n    return send_file(path, as_attachment=True)\n\n\nif __name__ == \"__main__\":\n    app.run(debug=False, port=5000, host=\"0.0.0.0\")\n","size_bytes":2219},"gemini_ai.py":{"content":"# IMPORTANT: KEEP THIS COMMENT\n# Follow these instructions when using this blueprint:\n# - Note that the newest Gemini model series is \"gemini-2.5-flash\" or gemini-2.5-pro\"\n#   - do not change this unless explicitly requested by the user\n# - Sometimes the google genai SDK has occasional type errors. You might need to run to validate, at time.  \n# The SDK was recently renamed from google-generativeai to google-genai. This file reflects the new name and the new APIs.\n\nimport json\nimport logging\nimport os\nfrom google import genai\nfrom google.genai import types\n\n# This API key is from Gemini Developer API Key, not vertex AI API Key\n# Lazy client initialization to avoid crashing imports when env var is missing\n_client = None\ndef _get_client():\n    \"\"\"Get or create the Gemini client with lazy initialization\"\"\"\n    global _client\n    if _client is None:\n        api_key = os.environ.get(\"GEMINI_API_KEY\") or os.environ.get(\"GOOGLE_GENAI_API_KEY\")\n        if not api_key:\n            raise ValueError(\"GEMINI_API_KEY environment variable is not set. Please configure your Gemini API key.\")\n\n        _client = genai.Client(api_key=api_key)\n\n    return _client\n\n\ndef grade_assignment(assignment_text, rubric=\"\", max_points=100):\n    \"\"\"Grade an assignment using Gemini AI with detailed feedback\"\"\"\n    try:\n        prompt = f\"\"\"\n        Please grade this assignment and provide detailed feedback.\n        \n        Assignment Text:\n        {assignment_text}\n        \n        Grading Rubric:\n        {rubric if rubric else \"Standard academic grading criteria focusing on content accuracy, clarity, organization, and completeness.\"}\n        \n        Maximum Points: {max_points}\n        \n        Please provide your response in the following JSON format:\n        {{\n            \"grade\": <numeric_grade>,\n            \"percentage\": <percentage_score>,\n            \"feedback\": \"Detailed feedback explaining strengths and areas for improvement\",\n            \"suggestions\": \"Specific suggestions for improvement\"\n        }}\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        if response.text:\n            result = json.loads(response.text)\n            return {\n                'grade': min(float(result.get('grade', 0)), max_points),\n                'percentage': min(float(result.get('percentage', 0)), 100),\n                'feedback': result.get('feedback', 'No feedback provided'),\n                'suggestions': result.get('suggestions', 'No suggestions provided')\n            }\n        else:\n            return {\n                'grade': 0,\n                'percentage': 0,\n                'feedback': 'Unable to grade assignment automatically',\n                'suggestions': 'Please have instructor review manually'\n            }\n            \n    except Exception as e:\n        logging.error(f\"Error grading assignment: {e}\")\n        return {\n            'grade': 0,\n            'percentage': 0,\n            'feedback': 'Error occurred during automated grading',\n            'suggestions': 'Please have instructor review manually'\n        }\n\ndef generate_mcq_options(question_text, context=\"\"):\n    \"\"\"Generate 4 MCQ options for a given question using AI\"\"\"\n    try:\n        prompt = f\"\"\"\n        Generate 4 multiple choice options (A, B, C, D) for the following question.\n        Make sure one option is correct and the other three are plausible but incorrect.\n        \n        Question: {question_text}\n        {f\"Context/Topic: {context}\" if context else \"\"}\n        \n        Provide your response in the following JSON format:\n        {{\n            \"option_a\": \"First option text\",\n            \"option_b\": \"Second option text\",\n            \"option_c\": \"Third option text\",\n            \"option_d\": \"Fourth option text\",\n            \"correct_answer\": \"A\",\n            \"explanation\": \"Brief explanation of why the correct answer is right\"\n        }}\n        \n        Make the options clear, concise, and educational.\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        if response.text:\n            result = json.loads(response.text)\n            return {\n                'option_a': result.get('option_a', ''),\n                'option_b': result.get('option_b', ''),\n                'option_c': result.get('option_c', ''),\n                'option_d': result.get('option_d', ''),\n                'correct_answer': result.get('correct_answer', 'A'),\n                'explanation': result.get('explanation', '')\n            }\n        else:\n            return None\n            \n    except Exception as e:\n        logging.error(f\"Error generating MCQ options: {e}\")\n        return None\n\ndef generate_forum_response(topic_title, topic_content, existing_replies=\"\"):\n    \"\"\"Generate an AI response for forum discussions\"\"\"\n    try:\n        prompt = f\"\"\"\n        Generate a helpful and educational response to this forum discussion topic.\n        \n        Topic: {topic_title}\n        Content: {topic_content}\n        \n        Existing Replies: {existing_replies if existing_replies else \"None\"}\n        \n        Please provide a constructive, educational response that:\n        1. Addresses the main points raised\n        2. Provides additional insights or clarifications\n        3. Encourages further discussion\n        4. Maintains a supportive learning environment\n        \n        Keep the response conversational and academic in tone.\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt\n        )\n        \n        return response.text if response.text else \"Unable to generate AI response at this time.\"\n        \n    except Exception as e:\n        logging.error(f\"Error generating forum response: {e}\")\n        return \"Unable to generate AI response at this time.\"\n\ndef determine_correct_answer(question_text, options):\n    \"\"\"\n    NEW FEATURE: AI Auto-Correction for MCQ\n    Gemini AI automatically determines which option is correct based on the question and available options.\n    Instructor does NOT need to select the correct answer manually.\n    \n    Args:\n        question_text (str): The MCQ question\n        options (dict): Dictionary of options like {'A': 'text', 'B': 'text', 'C': 'text', 'D': 'text'}\n    \n    Returns:\n        str: The letter of the correct answer (A, B, C, or D)\n    \"\"\"\n    try:\n        options_text = \"\\n\".join([f\"{letter}. {text}\" for letter, text in options.items()])\n        \n        prompt = f\"\"\"\n        You are an educational AI assistant. Given the following multiple-choice question and options, \n        determine which option (A, B, C, or D) is the CORRECT answer.\n        \n        Question:\n        {question_text}\n        \n        Options:\n        {options_text}\n        \n        Analyze the question carefully and respond with ONLY the letter (A, B, C, or D) of the correct answer.\n        Do not include any explanation, just the single letter.\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt\n        )\n        \n        if response.text:\n            answer = response.text.strip().upper()\n            if answer in ['A', 'B', 'C', 'D']:\n                logging.info(f\"AI determined correct answer: {answer} for question: {question_text[:50]}...\")\n                return answer\n            else:\n                logging.warning(f\"AI response '{answer}' is not valid. Defaulting to 'A'\")\n                return 'A'\n        else:\n            logging.warning(\"No AI response received. Defaulting to 'A'\")\n            return 'A'\n            \n    except Exception as e:\n        logging.error(f\"Error determining correct answer with AI: {e}\")\n        return 'A'\n\ndef analyze_student_progress(assignment_history, participation_data):\n    \"\"\"Analyze student progress and provide recommendations\"\"\"\n    try:\n        prompt = f\"\"\"\n        Analyze this student's academic progress and provide recommendations.\n        \n        Assignment History: {assignment_history}\n        Participation Data: {participation_data}\n        \n        Please provide analysis in JSON format:\n        {{\n            \"overall_performance\": \"assessment of overall performance\",\n            \"strengths\": [\"list of strengths\"],\n            \"areas_for_improvement\": [\"list of areas to improve\"],\n            \"recommendations\": [\"specific recommendations for student\"],\n            \"engagement_level\": \"high/medium/low\"\n        }}\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        if response.text:\n            return json.loads(response.text)\n        else:\n            return {\n                \"overall_performance\": \"Unable to analyze\",\n                \"strengths\": [],\n                \"areas_for_improvement\": [],\n                \"recommendations\": [],\n                \"engagement_level\": \"unknown\"\n            }\n            \n    except Exception as e:\n        logging.error(f\"Error analyzing student progress: {e}\")\n        return {\n            \"overall_performance\": \"Analysis unavailable\",\n            \"strengths\": [],\n            \"areas_for_improvement\": [],\n            \"recommendations\": [],\n            \"engagement_level\": \"unknown\"\n        }\n\ndef generate_video_notes(video_title, video_description=\"\", video_duration=\"\", video_url=\"\"):\n    \"\"\"\n    NEW FEATURE: AI-Powered Video Notes Generation - Enhanced for Accuracy\n    Generate comprehensive, well-structured educational notes for a video using Gemini AI.\n    This creates detailed study notes with proper formatting and learning outcomes.\n    \n    Args:\n        video_title (str): The title of the video\n        video_description (str): Optional description of the video content\n        video_duration (str): Optional duration of the video\n        video_url (str): YouTube video URL for analysis\n    \n    Returns:\n        str: Comprehensive, accurately formatted study notes for the video\n    \"\"\"\n    try:\n        duration_text = f\"Video Duration: {video_duration}\" if video_duration else \"\"\n        description_text = f\"Video Description: {video_description}\" if video_description else \"\"\n        \n        prompt = f\"\"\"\n        You are a world-class educational content specialist and pedagogical expert. Your task is to create exceptionally high-quality, \n        well-structured study notes that are accurate, comprehensive, and easy to understand.\n        \n        VIDEO INFORMATION:\n        - Title: {video_title}\n        {f\"- Description: {description_text}\" if description_text else \"\"}\n        {f\"- Duration: {duration_text}\" if duration_text else \"\"}\n        {f\"- URL: {video_url}\" if video_url else \"\"}\n        \n        CREATE COMPREHENSIVE STUDY NOTES WITH THE FOLLOWING STRUCTURE:\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        1. LEARNING OBJECTIVES\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - List 5-7 specific learning outcomes students should achieve\n        - Use action verbs (understand, analyze, apply, evaluate)\n        - Make objectives measurable and clear\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        2. EXECUTIVE SUMMARY\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Provide a compelling 2-3 paragraph overview of the topic\n        - Highlight why this topic matters and its real-world applications\n        - Connect to broader educational concepts\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        3. FUNDAMENTAL CONCEPTS & DEFINITIONS\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Define key terms with clarity and precision\n        - Provide etymology or origin of important terms when relevant\n        - Use examples to illustrate each concept\n        - Bold important terminology\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        4. DETAILED CONTENT BREAKDOWN\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        Structure as:\n        - Main Topic Headings\n        - Sub-concepts with detailed explanations\n        - Real-world examples and case studies\n        - Visual descriptions (if applicable)\n        - Common misconceptions and clarifications\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        5. WORKED EXAMPLES & APPLICATIONS\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Include 3-5 concrete, well-explained examples\n        - Show step-by-step problem-solving approach\n        - Demonstrate how theory translates to practice\n        - Include both simple and complex examples\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        6. KEY FORMULAS, THEOREMS & PRINCIPLES\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - List all essential equations or principles\n        - Explain the significance of each\n        - Show how to use them in context\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        7. SUMMARY TABLE OF KEY POINTS\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        Create a structured summary with:\n        - Concept | Definition | Relevance | Example\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        8. STUDY QUESTIONS & SELF-ASSESSMENT\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - 5-8 progressive difficulty comprehension questions\n        - Include: factual recall, application, and critical thinking questions\n        - Provide answer guides or hints where helpful\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        9. COMMON ERRORS & HOW TO AVOID THEM\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Identify typical student mistakes\n        - Explain why these errors occur\n        - Provide strategies to prevent them\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        10. EXTENSION & FURTHER LEARNING\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Advanced concepts that build on this foundation\n        - Related topics worth exploring\n        - Recommended next steps in learning journey\n        \n        QUALITY REQUIREMENTS:\n        âœ“ Be exceptionally clear and accurate in all explanations\n        âœ“ Use consistent formatting and structure throughout\n        âœ“ Target audience: Advanced undergraduate/early graduate level\n        âœ“ Ensure all content is factually correct and well-researched\n        âœ“ Total length: 2000-2500 words for comprehensive coverage\n        âœ“ Use professional but accessible language\n        âœ“ Include citations or references where appropriate\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt\n        )\n        \n        if response.text and len(response.text) > 100:\n            logging.info(f\"Successfully generated comprehensive notes for video: {video_title[:50]}... ({len(response.text)} characters)\")\n            return response.text\n        else:\n            logging.warning(\"AI response too short or empty for notes generation\")\n            return f\"Study Notes for: {video_title}\\n\\nUnable to generate detailed notes at this time. Please try again later.\"\n            \n    except Exception as e:\n        logging.error(f\"Error generating video notes: {e}\")\n        return f\"Study Notes for: {video_title}\\n\\nError occurred while generating notes. Please try again later.\"\n\ndef generate_video_transcript(video_title, video_description=\"\", video_duration=\"\", video_url=\"\"):\n    \"\"\"\n    NEW FEATURE: AI-Powered Video Transcript Generation\n    Generate a comprehensive educational transcript for a video using Gemini AI.\n    This analyzes the actual YouTube video content to create detailed transcripts.\n    \n    Args:\n        video_title (str): The title of the video\n        video_description (str): Optional description of the video content\n        video_duration (str): Optional duration of the video\n        video_url (str): YouTube video URL for analysis\n    \n    Returns:\n        str: A comprehensive transcript/notes for the video\n    \"\"\"\n    try:\n        duration_text = f\"Video Duration: {video_duration}\" if video_duration else \"\"\n        description_text = f\"\\nVideo Description:\\n{video_description}\" if video_description else \"\"\n        \n        # If video URL is provided, use Gemini's video understanding\n        if video_url and ('youtube.com' in video_url or 'youtu.be' in video_url):\n            prompt = f\"\"\"\n            You are an expert educational content creator. Analyze this YouTube educational video and generate a comprehensive, \n            detailed transcript and lecture notes.\n            \n            Video Title: {video_title}\n            {description_text}\n            {duration_text}\n            Video URL: {video_url}\n            \n            Please watch/analyze the video and create a detailed educational transcript that includes:\n            \n            1. INTRODUCTION\n               - Brief overview of what the video covers\n               - Learning objectives from the actual video content\n            \n            2. MAIN CONTENT (based on actual video)\n               - Comprehensive coverage of topics discussed in the video\n               - Key concepts and definitions mentioned\n               - Important points and explanations from the lecture\n               - Examples and demonstrations shown\n               - Visual content described\n            \n            3. KEY TAKEAWAYS\n               - Summary of main points from the video\n               - Important concepts to remember\n            \n            4. TIMESTAMPS & TOPICS (if applicable)\n               - Major sections of the video with approximate timestamps\n            \n            5. ADDITIONAL RESOURCES\n               - Suggested topics for further study based on video content\n               - Related concepts mentioned in the video\n            \n            Format the transcript in a clear, professional manner with proper headings and structure.\n            Make it comprehensive enough to serve as standalone study material for students.\n            The transcript should be detailed (1000-2000 words) to provide substantial educational value.\n            \"\"\"\n        else:\n            # Fallback to title and description if no valid YouTube URL\n            prompt = f\"\"\"\n            You are an expert educational content creator. Generate a comprehensive, detailed transcript and lecture notes \n            for an educational video based on the following information:\n            \n            Video Title: {video_title}\n            {description_text}\n            {duration_text}\n            \n            Please create a detailed educational transcript that includes:\n            \n            1. INTRODUCTION\n               - Brief overview of the topic\n               - Learning objectives\n            \n            2. MAIN CONTENT\n               - Comprehensive coverage of the topic\n               - Key concepts and definitions\n               - Important points and explanations\n               - Examples where applicable\n            \n            3. KEY TAKEAWAYS\n               - Summary of main points\n               - Important concepts to remember\n            \n            4. ADDITIONAL RESOURCES\n               - Suggested topics for further study\n               - Related concepts to explore\n            \n            Format the transcript in a clear, professional manner with proper headings and structure.\n            Make it comprehensive enough to serve as standalone study material for students.\n            The transcript should be 800-1500 words to provide substantial educational value.\n            \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt\n        )\n        \n        if response.text:\n            logging.info(f\"Successfully generated transcript for video: {video_title[:50]}...\")\n            return response.text\n        else:\n            logging.warning(\"No AI response received for transcript generation\")\n            return f\"Transcript for: {video_title}\\n\\nUnable to generate detailed transcript at this time. Please try again later.\"\n            \n    except Exception as e:\n        logging.error(f\"Error generating video transcript: {e}\")\n        return f\"Transcript for: {video_title}\\n\\nError occurred while generating transcript. Please try again later.\"\n\ndef generate_student_notes(topic, course_title=\"\", course_code=\"\"):\n    \"\"\"\n    Generate professional study notes from a topic/subject using Gemini AI.\n    Creates comprehensive 2000-2500 word study material for any topic.\n    \n    Args:\n        topic (str): Student's topic/subject to create notes for\n        course_title (str): Course name for context\n        course_code (str): Course code\n    \n    Returns:\n        str: Comprehensive, well-structured study notes (2000-2500 words)\n    \"\"\"\n    try:\n        prompt = f\"\"\"\n        You are an expert academic instructor and note-taking specialist. A student has requested comprehensive study notes on a topic.\n        Your task is to create professional, well-structured, educational study material from scratch.\n        \n        TOPIC/SUBJECT:\n        {topic}\n        \n        {'COURSE: ' + course_title + ' (' + course_code + ')' if course_title else ''}\n        \n        CREATE COMPREHENSIVE, PROFESSIONAL STUDY NOTES WITH THIS STRUCTURE:\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        1. LEARNING OBJECTIVES\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - List 5-7 specific learning outcomes students should achieve\n        - Make them measurable and clear\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        2. EXECUTIVE SUMMARY\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Provide a 2-3 paragraph overview of the topic\n        - Highlight why this topic matters\n        - Connect to real-world applications\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        3. FUNDAMENTAL CONCEPTS & DEFINITIONS\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Define all key terms with clarity\n        - Use bold formatting for important terminology\n        - Provide examples for each concept\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        4. DETAILED CONTENT BREAKDOWN\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Main topic sections with subsections\n        - In-depth explanations and examples\n        - Practical applications where relevant\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        5. KEY TAKEAWAYS & SUMMARY\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - List main points to remember\n        - Create a concise summary\n        - Highlight important relationships\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        6. PRACTICE & REVIEW\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Suggest key questions for self-assessment\n        - Areas for further study\n        - Related topics to explore\n        \n        REQUIREMENTS:\n        - Total length: 2000-2500 words\n        - Professional academic tone\n        - Clear hierarchical structure with headings\n        - Rich with examples and explanations\n        - Make it suitable for printing and long-term studying\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt\n        )\n        \n        if response.text:\n            logging.info(f\"Successfully generated student notes from input\")\n            return response.text\n        else:\n            logging.warning(\"No AI response for student notes generation\")\n            return f\"Study Notes for: {topic}\\n\\nUnable to generate detailed notes at this time. Please try again later.\"\n            \n    except Exception as e:\n        logging.error(f\"Error generating student notes: {e}\")\n        return f\"Study Notes for: {topic}\\n\\nError occurred while generating notes. Please try again later.\"\n\ndef generate_mcq_quiz(topic, num_questions=5, difficulty=\"medium\"):\n    \"\"\"\n    Generate multiple-choice quiz questions from a topic using Gemini AI.\n    \n    Args:\n        topic (str): The topic/subject to create quiz questions for\n        num_questions (int): Number of questions to generate (default: 5)\n        difficulty (str): Difficulty level - 'easy', 'medium', or 'hard'\n    \n    Returns:\n        list: List of dictionaries containing questions with options and correct answers\n    \"\"\"\n    try:\n        prompt = f\"\"\"\n        You are an expert educator. Generate {num_questions} multiple-choice quiz questions about the following topic at {difficulty} difficulty level.\n        \n        TOPIC: {topic}\n        \n        For each question, provide:\n        1. A clear, unambiguous question\n        2. Four options (A, B, C, D)\n        3. The correct answer (A, B, C, or D)\n        4. Brief explanation of why the correct answer is right\n        \n        Format your response as a valid JSON array with this exact structure:\n        [\n            {{\n                \"question\": \"What is...\",\n                \"options\": {{\n                    \"A\": \"Option text\",\n                    \"B\": \"Option text\",\n                    \"C\": \"Option text\",\n                    \"D\": \"Option text\"\n                }},\n                \"correct_answer\": \"A\",\n                \"explanation\": \"This is the correct answer because...\"\n            }},\n            ...\n        ]\n        \n        Requirements:\n        - Each question must be distinct and test different concepts\n        - Options should be plausible to avoid obvious answers\n        - Explanations should be educational\n        - Ensure valid JSON format\n        - Generate exactly {num_questions} questions\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        if response.text:\n            try:\n                questions = json.loads(response.text)\n                \n                # Validate response structure\n                if not isinstance(questions, list) or len(questions) == 0:\n                    logging.error(f\"Invalid MCQ response structure: expected non-empty list, got {type(questions)}\")\n                    raise ValueError(\"AI returned invalid question format\")\n                \n                # Validate each question has required fields\n                for i, q in enumerate(questions):\n                    if not all(key in q for key in ['question', 'options', 'correct_answer']):\n                        logging.error(f\"Question {i+1} missing required fields\")\n                        raise ValueError(f\"Question {i+1} has invalid structure\")\n                \n                logging.info(f\"Successfully generated {len(questions)} MCQ questions for topic: {topic}\")\n                return questions\n                \n            except json.JSONDecodeError as je:\n                logging.error(f\"Invalid JSON response from Gemini for MCQ generation: {je}\")\n                logging.error(f\"Response text: {response.text[:500]}...\")  # Log first 500 chars for debugging\n                raise ValueError(\"AI returned malformed response. Please try again.\")\n        else:\n            logging.warning(\"No AI response received for MCQ generation\")\n            raise ValueError(\"No response from AI. Please check your API key and try again.\")\n            \n    except ValueError as ve:\n        # Re-raise ValueError with clear message for user\n        raise ve\n    except Exception as e:\n        logging.error(f\"Error generating MCQ quiz: {e}\")\n        raise Exception(f\"Failed to generate questions: {str(e)}\")\n\n\ndef generate_ai_notes(topic, teacher_name=\"\", additional_context=\"\"):\n    \"\"\"Generate comprehensive study notes on a given topic using Gemini AI\"\"\"\n    try:\n        prompt = f\"\"\"\n        Generate comprehensive study notes on: {topic}\n        {f\"Context: {additional_context}\" if additional_context else \"\"}\n        \n        Structure the notes with clear headings and organized content:\n        - Introduction\n        - Key Concepts\n        - Detailed Explanations with Examples\n        - Important Points\n        - Summary\n        \n        Provide ONLY the study notes content. Do not include any meta-instructions, commands, \n        or formatting explanations. Write directly for students to read and learn.\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt,\n        )\n        \n        if response.text:\n            content = response.text.strip()\n            \n            # Clean up common AI artifacts\n            content = content.replace('```markdown', '').replace('```', '')\n            \n            # Remove any meta-instructions or commands\n            lines = content.split('\\n')\n            cleaned_lines = []\n            skip_next = False\n            \n            for line in lines:\n                line_lower = line.lower().strip()\n                # Skip lines that look like instructions or meta-content\n                if any(phrase in line_lower for phrase in [\n                    'here is', 'here are', 'i will', 'i have', 'let me',\n                    'as requested', 'note that', 'please note',\n                    'this document', 'these notes', 'above is'\n                ]):\n                    if len(line.strip()) < 100:  # Only skip if it's a short instructional line\n                        continue\n                \n                cleaned_lines.append(line)\n            \n            content = '\\n'.join(cleaned_lines).strip()\n            \n            logging.info(f\"Successfully generated AI notes for topic: {topic}\")\n            return {\n                'success': True,\n                'content': content,\n                'topic': topic,\n                'teacher_name': teacher_name\n            }\n        else:\n            logging.warning(\"No AI response received for notes generation\")\n            return {\n                'success': False,\n                'content': '',\n                'error': 'No response from AI'\n            }\n            \n    except Exception as e:\n        logging.error(f\"Error generating AI notes: {e}\")\n        return {\n            'success': False,\n            'content': '',\n            'error': str(e)\n        }\n\ndef answer_student_question(question):\n    \"\"\"\n    Answer student questions instantly using Gemini AI with visual generation capability.\n    \n    Args:\n        question (str): The student's question\n    \n    Returns:\n        dict: Contains 'answer' text and optional 'needs_visual' flag with 'visual_prompt'\n    \"\"\"\n    try:\n        # First, determine if this question would benefit from a visual\n        analysis_prompt = f\"\"\"Analyze this student question and determine if a visual diagram, chart, or illustration would significantly help explain the concept:\n\nQUESTION: {question}\n\nRespond with JSON:\n{{\n    \"needs_visual\": true/false,\n    \"visual_type\": \"diagram/chart/illustration/none\",\n    \"visual_description\": \"Brief description of what visual to create (if needed)\"\n}}\"\"\"\n        \n        client = _get_client()\n        analysis_response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=analysis_prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        needs_visual = False\n        visual_prompt = None\n        \n        if analysis_response and analysis_response.text:\n            try:\n                analysis = json.loads(analysis_response.text)\n                needs_visual = analysis.get('needs_visual', False)\n                if needs_visual:\n                    visual_prompt = f\"Educational {analysis.get('visual_type', 'diagram')} showing {analysis.get('visual_description', question)}, clean design, clear labels, professional style\"\n            except:\n                pass\n        \n        # Now generate the text answer\n        prompt = f\"\"\"You are an expert AI Study Assistant helping students with their academic questions.\nA student has asked you the following question:\n\nQUESTION: {question}\n\nPlease provide a clear, comprehensive, and educational answer that:\n1. Directly addresses the student's question\n2. Explains concepts in an easy-to-understand manner\n3. Provides examples where helpful\n4. Is accurate and academically sound\n5. Is encouraging and supportive\n{'6. Mention that a visual diagram is being generated to help illustrate the concept' if needs_visual else ''}\n\nKeep your answer concise but thorough (200-400 words).\n\nANSWER:\"\"\"\n        \n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt\n        )\n        \n        if response and response.text:\n            logging.info(f\"AI Assistant answered question: {question[:50]}... (Visual: {needs_visual})\")\n            return {\n                'answer': response.text.strip(),\n                'needs_visual': needs_visual,\n                'visual_prompt': visual_prompt\n            }\n        else:\n            logging.warning(\"No AI response for student question\")\n            return {\n                'answer': \"I'm having trouble generating an answer right now. Please try again in a moment.\",\n                'needs_visual': False\n            }\n            \n    except Exception as e:\n        logging.error(f\"Error answering student question: {e}\")\n        return {\n            'answer': \"I encountered an error while processing your question. Please try again.\",\n            'needs_visual': False\n        }","size_bytes":38969},"ghalib/gemini_ai.py":{"content":"# IMPORTANT: KEEP THIS COMMENT\n# Follow these instructions when using this blueprint:\n# - Note that the newest Gemini model series is \"gemini-2.5-flash\" or gemini-2.5-pro\"\n#   - do not change this unless explicitly requested by the user\n# - Sometimes the google genai SDK has occasional type errors. You might need to run to validate, at time.  \n# The SDK was recently renamed from google-generativeai to google-genai. This file reflects the new name and the new APIs.\n\nimport json\nimport logging\nimport os\nfrom google import genai\nfrom google.genai import types\n\n# This API key is from Gemini Developer API Key, not vertex AI API Key\n# Lazy client initialization to avoid crashing imports when env var is missing\n_client = None\ndef _get_client():\n    \"\"\"Get or create the Gemini client with lazy initialization\"\"\"\n    global _client\n    if _client is None:\n        api_key = os.environ.get(\"GEMINI_API_KEY\") or os.environ.get(\"GOOGLE_GENAI_API_KEY\")\n        if not api_key:\n            raise ValueError(\"GEMINI_API_KEY environment variable is not set. Please configure your Gemini API key.\")\n\n        _client = genai.Client(api_key=api_key)\n\n    return _client\n\n\ndef grade_assignment(assignment_text, rubric=\"\", max_points=100):\n    \"\"\"Grade an assignment using Gemini AI with detailed feedback\"\"\"\n    try:\n        prompt = f\"\"\"\n        Please grade this assignment and provide detailed feedback.\n        \n        Assignment Text:\n        {assignment_text}\n        \n        Grading Rubric:\n        {rubric if rubric else \"Standard academic grading criteria focusing on content accuracy, clarity, organization, and completeness.\"}\n        \n        Maximum Points: {max_points}\n        \n        Please provide your response in the following JSON format:\n        {{\n            \"grade\": <numeric_grade>,\n            \"percentage\": <percentage_score>,\n            \"feedback\": \"Detailed feedback explaining strengths and areas for improvement\",\n            \"suggestions\": \"Specific suggestions for improvement\"\n        }}\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        if response.text:\n            result = json.loads(response.text)\n            return {\n                'grade': min(float(result.get('grade', 0)), max_points),\n                'percentage': min(float(result.get('percentage', 0)), 100),\n                'feedback': result.get('feedback', 'No feedback provided'),\n                'suggestions': result.get('suggestions', 'No suggestions provided')\n            }\n        else:\n            return {\n                'grade': 0,\n                'percentage': 0,\n                'feedback': 'Unable to grade assignment automatically',\n                'suggestions': 'Please have instructor review manually'\n            }\n            \n    except Exception as e:\n        logging.error(f\"Error grading assignment: {e}\")\n        return {\n            'grade': 0,\n            'percentage': 0,\n            'feedback': 'Error occurred during automated grading',\n            'suggestions': 'Please have instructor review manually'\n        }\n\ndef generate_mcq_options(question_text, context=\"\"):\n    \"\"\"Generate 4 MCQ options for a given question using AI\"\"\"\n    try:\n        prompt = f\"\"\"\n        Generate 4 multiple choice options (A, B, C, D) for the following question.\n        Make sure one option is correct and the other three are plausible but incorrect.\n        \n        Question: {question_text}\n        {f\"Context/Topic: {context}\" if context else \"\"}\n        \n        Provide your response in the following JSON format:\n        {{\n            \"option_a\": \"First option text\",\n            \"option_b\": \"Second option text\",\n            \"option_c\": \"Third option text\",\n            \"option_d\": \"Fourth option text\",\n            \"correct_answer\": \"A\",\n            \"explanation\": \"Brief explanation of why the correct answer is right\"\n        }}\n        \n        Make the options clear, concise, and educational.\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        if response.text:\n            result = json.loads(response.text)\n            return {\n                'option_a': result.get('option_a', ''),\n                'option_b': result.get('option_b', ''),\n                'option_c': result.get('option_c', ''),\n                'option_d': result.get('option_d', ''),\n                'correct_answer': result.get('correct_answer', 'A'),\n                'explanation': result.get('explanation', '')\n            }\n        else:\n            return None\n            \n    except Exception as e:\n        logging.error(f\"Error generating MCQ options: {e}\")\n        return None\n\ndef generate_forum_response(topic_title, topic_content, existing_replies=\"\"):\n    \"\"\"Generate an AI response for forum discussions\"\"\"\n    try:\n        prompt = f\"\"\"\n        Generate a helpful and educational response to this forum discussion topic.\n        \n        Topic: {topic_title}\n        Content: {topic_content}\n        \n        Existing Replies: {existing_replies if existing_replies else \"None\"}\n        \n        Please provide a constructive, educational response that:\n        1. Addresses the main points raised\n        2. Provides additional insights or clarifications\n        3. Encourages further discussion\n        4. Maintains a supportive learning environment\n        \n        Keep the response conversational and academic in tone.\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt\n        )\n        \n        return response.text if response.text else \"Unable to generate AI response at this time.\"\n        \n    except Exception as e:\n        logging.error(f\"Error generating forum response: {e}\")\n        return \"Unable to generate AI response at this time.\"\n\ndef determine_correct_answer(question_text, options):\n    \"\"\"\n    NEW FEATURE: AI Auto-Correction for MCQ\n    Gemini AI automatically determines which option is correct based on the question and available options.\n    Instructor does NOT need to select the correct answer manually.\n    \n    Args:\n        question_text (str): The MCQ question\n        options (dict): Dictionary of options like {'A': 'text', 'B': 'text', 'C': 'text', 'D': 'text'}\n    \n    Returns:\n        str: The letter of the correct answer (A, B, C, or D)\n    \"\"\"\n    try:\n        options_text = \"\\n\".join([f\"{letter}. {text}\" for letter, text in options.items()])\n        \n        prompt = f\"\"\"\n        You are an educational AI assistant. Given the following multiple-choice question and options, \n        determine which option (A, B, C, or D) is the CORRECT answer.\n        \n        Question:\n        {question_text}\n        \n        Options:\n        {options_text}\n        \n        Analyze the question carefully and respond with ONLY the letter (A, B, C, or D) of the correct answer.\n        Do not include any explanation, just the single letter.\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt\n        )\n        \n        if response.text:\n            answer = response.text.strip().upper()\n            if answer in ['A', 'B', 'C', 'D']:\n                logging.info(f\"AI determined correct answer: {answer} for question: {question_text[:50]}...\")\n                return answer\n            else:\n                logging.warning(f\"AI response '{answer}' is not valid. Defaulting to 'A'\")\n                return 'A'\n        else:\n            logging.warning(\"No AI response received. Defaulting to 'A'\")\n            return 'A'\n            \n    except Exception as e:\n        logging.error(f\"Error determining correct answer with AI: {e}\")\n        return 'A'\n\ndef analyze_student_progress(assignment_history, participation_data):\n    \"\"\"Analyze student progress and provide recommendations\"\"\"\n    try:\n        prompt = f\"\"\"\n        Analyze this student's academic progress and provide recommendations.\n        \n        Assignment History: {assignment_history}\n        Participation Data: {participation_data}\n        \n        Please provide analysis in JSON format:\n        {{\n            \"overall_performance\": \"assessment of overall performance\",\n            \"strengths\": [\"list of strengths\"],\n            \"areas_for_improvement\": [\"list of areas to improve\"],\n            \"recommendations\": [\"specific recommendations for student\"],\n            \"engagement_level\": \"high/medium/low\"\n        }}\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        if response.text:\n            return json.loads(response.text)\n        else:\n            return {\n                \"overall_performance\": \"Unable to analyze\",\n                \"strengths\": [],\n                \"areas_for_improvement\": [],\n                \"recommendations\": [],\n                \"engagement_level\": \"unknown\"\n            }\n            \n    except Exception as e:\n        logging.error(f\"Error analyzing student progress: {e}\")\n        return {\n            \"overall_performance\": \"Analysis unavailable\",\n            \"strengths\": [],\n            \"areas_for_improvement\": [],\n            \"recommendations\": [],\n            \"engagement_level\": \"unknown\"\n        }\n\ndef generate_video_notes(video_title, video_description=\"\", video_duration=\"\", video_url=\"\"):\n    \"\"\"\n    NEW FEATURE: AI-Powered Video Notes Generation - Enhanced for Accuracy\n    Generate comprehensive, well-structured educational notes for a video using Gemini AI.\n    This creates detailed study notes with proper formatting and learning outcomes.\n    \n    Args:\n        video_title (str): The title of the video\n        video_description (str): Optional description of the video content\n        video_duration (str): Optional duration of the video\n        video_url (str): YouTube video URL for analysis\n    \n    Returns:\n        str: Comprehensive, accurately formatted study notes for the video\n    \"\"\"\n    try:\n        duration_text = f\"Video Duration: {video_duration}\" if video_duration else \"\"\n        description_text = f\"Video Description: {video_description}\" if video_description else \"\"\n        \n        prompt = f\"\"\"\n        You are a world-class educational content specialist and pedagogical expert. Your task is to create exceptionally high-quality, \n        well-structured study notes that are accurate, comprehensive, and easy to understand.\n        \n        VIDEO INFORMATION:\n        - Title: {video_title}\n        {f\"- Description: {description_text}\" if description_text else \"\"}\n        {f\"- Duration: {duration_text}\" if duration_text else \"\"}\n        {f\"- URL: {video_url}\" if video_url else \"\"}\n        \n        CREATE COMPREHENSIVE STUDY NOTES WITH THE FOLLOWING STRUCTURE:\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        1. LEARNING OBJECTIVES\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - List 5-7 specific learning outcomes students should achieve\n        - Use action verbs (understand, analyze, apply, evaluate)\n        - Make objectives measurable and clear\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        2. EXECUTIVE SUMMARY\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Provide a compelling 2-3 paragraph overview of the topic\n        - Highlight why this topic matters and its real-world applications\n        - Connect to broader educational concepts\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        3. FUNDAMENTAL CONCEPTS & DEFINITIONS\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Define key terms with clarity and precision\n        - Provide etymology or origin of important terms when relevant\n        - Use examples to illustrate each concept\n        - Bold important terminology\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        4. DETAILED CONTENT BREAKDOWN\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        Structure as:\n        - Main Topic Headings\n        - Sub-concepts with detailed explanations\n        - Real-world examples and case studies\n        - Visual descriptions (if applicable)\n        - Common misconceptions and clarifications\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        5. WORKED EXAMPLES & APPLICATIONS\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Include 3-5 concrete, well-explained examples\n        - Show step-by-step problem-solving approach\n        - Demonstrate how theory translates to practice\n        - Include both simple and complex examples\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        6. KEY FORMULAS, THEOREMS & PRINCIPLES\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - List all essential equations or principles\n        - Explain the significance of each\n        - Show how to use them in context\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        7. SUMMARY TABLE OF KEY POINTS\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        Create a structured summary with:\n        - Concept | Definition | Relevance | Example\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        8. STUDY QUESTIONS & SELF-ASSESSMENT\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - 5-8 progressive difficulty comprehension questions\n        - Include: factual recall, application, and critical thinking questions\n        - Provide answer guides or hints where helpful\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        9. COMMON ERRORS & HOW TO AVOID THEM\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Identify typical student mistakes\n        - Explain why these errors occur\n        - Provide strategies to prevent them\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        10. EXTENSION & FURTHER LEARNING\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Advanced concepts that build on this foundation\n        - Related topics worth exploring\n        - Recommended next steps in learning journey\n        \n        QUALITY REQUIREMENTS:\n        âœ“ Be exceptionally clear and accurate in all explanations\n        âœ“ Use consistent formatting and structure throughout\n        âœ“ Target audience: Advanced undergraduate/early graduate level\n        âœ“ Ensure all content is factually correct and well-researched\n        âœ“ Total length: 2000-2500 words for comprehensive coverage\n        âœ“ Use professional but accessible language\n        âœ“ Include citations or references where appropriate\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt\n        )\n        \n        if response.text and len(response.text) > 100:\n            logging.info(f\"Successfully generated comprehensive notes for video: {video_title[:50]}... ({len(response.text)} characters)\")\n            return response.text\n        else:\n            logging.warning(\"AI response too short or empty for notes generation\")\n            return f\"Study Notes for: {video_title}\\n\\nUnable to generate detailed notes at this time. Please try again later.\"\n            \n    except Exception as e:\n        logging.error(f\"Error generating video notes: {e}\")\n        return f\"Study Notes for: {video_title}\\n\\nError occurred while generating notes. Please try again later.\"\n\ndef generate_video_transcript(video_title, video_description=\"\", video_duration=\"\", video_url=\"\"):\n    \"\"\"\n    NEW FEATURE: AI-Powered Video Transcript Generation\n    Generate a comprehensive educational transcript for a video using Gemini AI.\n    This analyzes the actual YouTube video content to create detailed transcripts.\n    \n    Args:\n        video_title (str): The title of the video\n        video_description (str): Optional description of the video content\n        video_duration (str): Optional duration of the video\n        video_url (str): YouTube video URL for analysis\n    \n    Returns:\n        str: A comprehensive transcript/notes for the video\n    \"\"\"\n    try:\n        duration_text = f\"Video Duration: {video_duration}\" if video_duration else \"\"\n        description_text = f\"\\nVideo Description:\\n{video_description}\" if video_description else \"\"\n        \n        # If video URL is provided, use Gemini's video understanding\n        if video_url and ('youtube.com' in video_url or 'youtu.be' in video_url):\n            prompt = f\"\"\"\n            You are an expert educational content creator. Analyze this YouTube educational video and generate a comprehensive, \n            detailed transcript and lecture notes.\n            \n            Video Title: {video_title}\n            {description_text}\n            {duration_text}\n            Video URL: {video_url}\n            \n            Please watch/analyze the video and create a detailed educational transcript that includes:\n            \n            1. INTRODUCTION\n               - Brief overview of what the video covers\n               - Learning objectives from the actual video content\n            \n            2. MAIN CONTENT (based on actual video)\n               - Comprehensive coverage of topics discussed in the video\n               - Key concepts and definitions mentioned\n               - Important points and explanations from the lecture\n               - Examples and demonstrations shown\n               - Visual content described\n            \n            3. KEY TAKEAWAYS\n               - Summary of main points from the video\n               - Important concepts to remember\n            \n            4. TIMESTAMPS & TOPICS (if applicable)\n               - Major sections of the video with approximate timestamps\n            \n            5. ADDITIONAL RESOURCES\n               - Suggested topics for further study based on video content\n               - Related concepts mentioned in the video\n            \n            Format the transcript in a clear, professional manner with proper headings and structure.\n            Make it comprehensive enough to serve as standalone study material for students.\n            The transcript should be detailed (1000-2000 words) to provide substantial educational value.\n            \"\"\"\n        else:\n            # Fallback to title and description if no valid YouTube URL\n            prompt = f\"\"\"\n            You are an expert educational content creator. Generate a comprehensive, detailed transcript and lecture notes \n            for an educational video based on the following information:\n            \n            Video Title: {video_title}\n            {description_text}\n            {duration_text}\n            \n            Please create a detailed educational transcript that includes:\n            \n            1. INTRODUCTION\n               - Brief overview of the topic\n               - Learning objectives\n            \n            2. MAIN CONTENT\n               - Comprehensive coverage of the topic\n               - Key concepts and definitions\n               - Important points and explanations\n               - Examples where applicable\n            \n            3. KEY TAKEAWAYS\n               - Summary of main points\n               - Important concepts to remember\n            \n            4. ADDITIONAL RESOURCES\n               - Suggested topics for further study\n               - Related concepts to explore\n            \n            Format the transcript in a clear, professional manner with proper headings and structure.\n            Make it comprehensive enough to serve as standalone study material for students.\n            The transcript should be 800-1500 words to provide substantial educational value.\n            \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt\n        )\n        \n        if response.text:\n            logging.info(f\"Successfully generated transcript for video: {video_title[:50]}...\")\n            return response.text\n        else:\n            logging.warning(\"No AI response received for transcript generation\")\n            return f\"Transcript for: {video_title}\\n\\nUnable to generate detailed transcript at this time. Please try again later.\"\n            \n    except Exception as e:\n        logging.error(f\"Error generating video transcript: {e}\")\n        return f\"Transcript for: {video_title}\\n\\nError occurred while generating transcript. Please try again later.\"\n\ndef generate_student_notes(topic, course_title=\"\", course_code=\"\"):\n    \"\"\"\n    Generate professional study notes from a topic/subject using Gemini AI.\n    Creates comprehensive 2000-2500 word study material for any topic.\n    \n    Args:\n        topic (str): Student's topic/subject to create notes for\n        course_title (str): Course name for context\n        course_code (str): Course code\n    \n    Returns:\n        str: Comprehensive, well-structured study notes (2000-2500 words)\n    \"\"\"\n    try:\n        prompt = f\"\"\"\n        You are an expert academic instructor and note-taking specialist. A student has requested comprehensive study notes on a topic.\n        Your task is to create professional, well-structured, educational study material from scratch.\n        \n        TOPIC/SUBJECT:\n        {topic}\n        \n        {'COURSE: ' + course_title + ' (' + course_code + ')' if course_title else ''}\n        \n        CREATE COMPREHENSIVE, PROFESSIONAL STUDY NOTES WITH THIS STRUCTURE:\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        1. LEARNING OBJECTIVES\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - List 5-7 specific learning outcomes students should achieve\n        - Make them measurable and clear\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        2. EXECUTIVE SUMMARY\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Provide a 2-3 paragraph overview of the topic\n        - Highlight why this topic matters\n        - Connect to real-world applications\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        3. FUNDAMENTAL CONCEPTS & DEFINITIONS\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Define all key terms with clarity\n        - Use bold formatting for important terminology\n        - Provide examples for each concept\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        4. DETAILED CONTENT BREAKDOWN\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Main topic sections with subsections\n        - In-depth explanations and examples\n        - Practical applications where relevant\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        5. KEY TAKEAWAYS & SUMMARY\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - List main points to remember\n        - Create a concise summary\n        - Highlight important relationships\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        6. PRACTICE & REVIEW\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Suggest key questions for self-assessment\n        - Areas for further study\n        - Related topics to explore\n        \n        REQUIREMENTS:\n        - Total length: 2000-2500 words\n        - Professional academic tone\n        - Clear hierarchical structure with headings\n        - Rich with examples and explanations\n        - Make it suitable for printing and long-term studying\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt\n        )\n        \n        if response.text:\n            logging.info(f\"Successfully generated student notes from input\")\n            return response.text\n        else:\n            logging.warning(\"No AI response for student notes generation\")\n            return f\"Study Notes for: {topic}\\n\\nUnable to generate detailed notes at this time. Please try again later.\"\n            \n    except Exception as e:\n        logging.error(f\"Error generating student notes: {e}\")\n        return f\"Study Notes for: {topic}\\n\\nError occurred while generating notes. Please try again later.\"\n\ndef generate_mcq_quiz(topic, num_questions=5, difficulty=\"medium\"):\n    \"\"\"\n    Generate multiple-choice quiz questions from a topic using Gemini AI.\n    \n    Args:\n        topic (str): The topic/subject to create quiz questions for\n        num_questions (int): Number of questions to generate (default: 5)\n        difficulty (str): Difficulty level - 'easy', 'medium', or 'hard'\n    \n    Returns:\n        list: List of dictionaries containing questions with options and correct answers\n    \"\"\"\n    try:\n        prompt = f\"\"\"\n        You are an expert educator. Generate {num_questions} multiple-choice quiz questions about the following topic at {difficulty} difficulty level.\n        \n        TOPIC: {topic}\n        \n        For each question, provide:\n        1. A clear, unambiguous question\n        2. Four options (A, B, C, D)\n        3. The correct answer (A, B, C, or D)\n        4. Brief explanation of why the correct answer is right\n        \n        Format your response as a valid JSON array with this exact structure:\n        [\n            {{\n                \"question\": \"What is...\",\n                \"options\": {{\n                    \"A\": \"Option text\",\n                    \"B\": \"Option text\",\n                    \"C\": \"Option text\",\n                    \"D\": \"Option text\"\n                }},\n                \"correct_answer\": \"A\",\n                \"explanation\": \"This is the correct answer because...\"\n            }},\n            ...\n        ]\n        \n        Requirements:\n        - Each question must be distinct and test different concepts\n        - Options should be plausible to avoid obvious answers\n        - Explanations should be educational\n        - Ensure valid JSON format\n        - Generate exactly {num_questions} questions\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        if response.text:\n            try:\n                questions = json.loads(response.text)\n                \n                # Validate response structure\n                if not isinstance(questions, list) or len(questions) == 0:\n                    logging.error(f\"Invalid MCQ response structure: expected non-empty list, got {type(questions)}\")\n                    raise ValueError(\"AI returned invalid question format\")\n                \n                # Validate each question has required fields\n                for i, q in enumerate(questions):\n                    if not all(key in q for key in ['question', 'options', 'correct_answer']):\n                        logging.error(f\"Question {i+1} missing required fields\")\n                        raise ValueError(f\"Question {i+1} has invalid structure\")\n                \n                logging.info(f\"Successfully generated {len(questions)} MCQ questions for topic: {topic}\")\n                return questions\n                \n            except json.JSONDecodeError as je:\n                logging.error(f\"Invalid JSON response from Gemini for MCQ generation: {je}\")\n                logging.error(f\"Response text: {response.text[:500]}...\")  # Log first 500 chars for debugging\n                raise ValueError(\"AI returned malformed response. Please try again.\")\n        else:\n            logging.warning(\"No AI response received for MCQ generation\")\n            raise ValueError(\"No response from AI. Please check your API key and try again.\")\n            \n    except ValueError as ve:\n        # Re-raise ValueError with clear message for user\n        raise ve\n    except Exception as e:\n        logging.error(f\"Error generating MCQ quiz: {e}\")\n        raise Exception(f\"Failed to generate questions: {str(e)}\")\n\n\ndef generate_ai_notes(topic, teacher_name=\"\", additional_context=\"\"):\n    \"\"\"Generate comprehensive study notes on a given topic using Gemini AI\"\"\"\n    try:\n        prompt = f\"\"\"\n        Generate comprehensive study notes on: {topic}\n        {f\"Context: {additional_context}\" if additional_context else \"\"}\n        \n        Structure the notes with clear headings and organized content:\n        - Introduction\n        - Key Concepts\n        - Detailed Explanations with Examples\n        - Important Points\n        - Summary\n        \n        Provide ONLY the study notes content. Do not include any meta-instructions, commands, \n        or formatting explanations. Write directly for students to read and learn.\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt,\n        )\n        \n        if response.text:\n            content = response.text.strip()\n            \n            # Clean up common AI artifacts\n            content = content.replace('```markdown', '').replace('```', '')\n            \n            # Remove any meta-instructions or commands\n            lines = content.split('\\n')\n            cleaned_lines = []\n            skip_next = False\n            \n            for line in lines:\n                line_lower = line.lower().strip()\n                # Skip lines that look like instructions or meta-content\n                if any(phrase in line_lower for phrase in [\n                    'here is', 'here are', 'i will', 'i have', 'let me',\n                    'as requested', 'note that', 'please note',\n                    'this document', 'these notes', 'above is'\n                ]):\n                    if len(line.strip()) < 100:  # Only skip if it's a short instructional line\n                        continue\n                \n                cleaned_lines.append(line)\n            \n            content = '\\n'.join(cleaned_lines).strip()\n            \n            logging.info(f\"Successfully generated AI notes for topic: {topic}\")\n            return {\n                'success': True,\n                'content': content,\n                'topic': topic,\n                'teacher_name': teacher_name\n            }\n        else:\n            logging.warning(\"No AI response received for notes generation\")\n            return {\n                'success': False,\n                'content': '',\n                'error': 'No response from AI'\n            }\n            \n    except Exception as e:\n        logging.error(f\"Error generating AI notes: {e}\")\n        return {\n            'success': False,\n            'content': '',\n            'error': str(e)\n        }\n\ndef answer_student_question(question):\n    \"\"\"\n    Answer student questions instantly using Gemini AI with visual generation capability.\n    \n    Args:\n        question (str): The student's question\n    \n    Returns:\n        dict: Contains 'answer' text and optional 'needs_visual' flag with 'visual_prompt'\n    \"\"\"\n    try:\n        # First, determine if this question would benefit from a visual\n        analysis_prompt = f\"\"\"Analyze this student question and determine if a visual diagram, chart, or illustration would significantly help explain the concept:\n\nQUESTION: {question}\n\nRespond with JSON:\n{{\n    \"needs_visual\": true/false,\n    \"visual_type\": \"diagram/chart/illustration/none\",\n    \"visual_description\": \"Brief description of what visual to create (if needed)\"\n}}\"\"\"\n        \n        client = _get_client()\n        analysis_response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=analysis_prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        needs_visual = False\n        visual_prompt = None\n        \n        if analysis_response and analysis_response.text:\n            try:\n                analysis = json.loads(analysis_response.text)\n                needs_visual = analysis.get('needs_visual', False)\n                if needs_visual:\n                    visual_prompt = f\"Educational {analysis.get('visual_type', 'diagram')} showing {analysis.get('visual_description', question)}, clean design, clear labels, professional style\"\n            except:\n                pass\n        \n        # Now generate the text answer\n        prompt = f\"\"\"You are an expert AI Study Assistant helping students with their academic questions.\nA student has asked you the following question:\n\nQUESTION: {question}\n\nPlease provide a clear, comprehensive, and educational answer that:\n1. Directly addresses the student's question\n2. Explains concepts in an easy-to-understand manner\n3. Provides examples where helpful\n4. Is accurate and academically sound\n5. Is encouraging and supportive\n{'6. Mention that a visual diagram is being generated to help illustrate the concept' if needs_visual else ''}\n\nKeep your answer concise but thorough (200-400 words).\n\nANSWER:\"\"\"\n        \n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt\n        )\n        \n        if response and response.text:\n            logging.info(f\"AI Assistant answered question: {question[:50]}... (Visual: {needs_visual})\")\n            return {\n                'answer': response.text.strip(),\n                'needs_visual': needs_visual,\n                'visual_prompt': visual_prompt\n            }\n        else:\n            logging.warning(\"No AI response for student question\")\n            return {\n                'answer': \"I'm having trouble generating an answer right now. Please try again in a moment.\",\n                'needs_visual': False\n            }\n            \n    except Exception as e:\n        logging.error(f\"Error answering student question: {e}\")\n        return {\n            'answer': \"I encountered an error while processing your question. Please try again.\",\n            'needs_visual': False\n        }","size_bytes":38969},"zsam/README.md":{"content":"# LearnNest - Learning Management System\n\nA comprehensive Flask-based Learning Management System with AI-powered features for educational institutions and online learning platforms.\n\n## Features\n\n### ðŸŽ“ Core Learning Management\n- **User Management**: Students, Instructors, and Admin roles with approval workflows\n- **Course Management**: Create and manage courses with enrollment keys\n- **Assignment System**: Traditional text submissions and multiple-choice quizzes\n- **Grading System**: AI-powered grading with detailed feedback using Google Gemini\n- **Progress Tracking**: Student progress monitoring and analytics\n- **Real-time Communication**: Socket.IO powered chat and notifications\n\n### ðŸ¤– AI-Powered Features\n- **Automated Grading**: Uses Google Gemini AI for assignment evaluation\n- **Intelligent Feedback**: Detailed AI-generated feedback and suggestions\n- **Forum Response Generation**: AI-assisted discussion forum responses\n- **Student Progress Analysis**: AI-powered learning analytics\n\n### ðŸ” Security & Administration\n- **Role-Based Access Control**: Secure permission system\n- **CSRF Protection**: Built-in security measures\n- **Session Management**: Secure user authentication\n- **File Upload Security**: Safe file handling for assignments\n- **Instructor Approval System**: Admin approval required for new instructors\n\n### ðŸ’¬ Communication Features\n- **Real-time Chat**: Socket.IO powered messaging\n- **Discussion Forums**: Course-based discussion boards\n- **Email Integration**: Flask-Mail for notifications\n- **Live Updates**: Real-time progress and grade updates\n\n## Installation & Setup\n\n### Prerequisites\n- Python 3.11 or higher\n- SQLite3 database\n- Google Gemini API key\n\n### Quick Start\n\n1. **Clone/Download the Project**\n   ```bash\n   # If you have the files, ensure they're in your project directory\n   ```\n\n2. **Install Dependencies**\n   ```bash\n   pip install -r requirements.txt\n   # Or if using uv:\n   uv sync\n   ```\n\n3. **Environment Setup**\n   Create a `.env` file in the project root:\n   ```env\n   SESSION_SECRET=your-secret-key-here\n   GOOGLE_GENAI_API_KEY=your-gemini-api-key-here\n   ```\n\n4. **Run the Application**\n   \n   **In VS Code:**\n   - Open VS Code in the project directory\n   - Open terminal (Ctrl+`)\n   - Type: `python app.py`\n   \n   **Command Line:**\n   ```bash\n   python app.py\n   ```\n\n5. **Access the Application**\n   - Open your browser to `http://localhost:5000`\n   - Register as a new user or use existing accounts\n\n## Project Structure\n\n```\nLearnNest/\nâ”œâ”€â”€ app.py                 # Main Flask application\nâ”œâ”€â”€ gemini_ai.py          # AI integration module\nâ”œâ”€â”€ learnnest.db          # SQLite database\nâ”œâ”€â”€ pyproject.toml        # Dependencies configuration\nâ”œâ”€â”€ templates/            # HTML templates (auto-created)\nâ”œâ”€â”€ static/               # CSS, JS, images (auto-created)\nâ”œâ”€â”€ uploads/              # File uploads (auto-created)\nâ”‚   â”œâ”€â”€ assignments/      # Assignment submissions\nâ”‚   â”œâ”€â”€ resources/        # Course resources\nâ”‚   â””â”€â”€ payments/         # Payment screenshots\nâ””â”€â”€ README.md            # This file\n```\n\n## Getting Started Guide\n\n### Default Admin Account\nOn first run, create an admin account through the registration form and manually set the role to 'admin' in the database.\n\n### For Instructors\n1. Register with role selection as \"Instructor\"\n2. Wait for admin approval\n3. Once approved, create courses with enrollment keys\n4. Create assignments and manage student submissions\n\n### For Students  \n1. Register as a \"Student\"\n2. Enroll in courses using enrollment keys\n3. Submit assignments and take quizzes\n4. View grades and AI feedback\n\n### For Administrators\n1. Approve/reject instructor applications\n2. Monitor all courses and users\n3. Access system-wide analytics\n4. Manage platform settings\n\n## API Integration\n\n### Google Gemini AI\nThe system uses Google Gemini for:\n- Automated assignment grading\n- Generating detailed feedback\n- Creating forum responses\n- Analyzing student progress\n\nConfigure your API key in the environment variables.\n\n## Database Schema\n\nThe application uses SQLite with the following main tables:\n- `users` - User accounts and roles\n- `courses` - Course information\n- `enrollments` - Student course enrollments\n- `assignments` - Assignment definitions\n- `assignment_submissions` - Student submissions\n- `quiz_questions` & `question_options` - MCQ system\n- `discussion_posts` - Forum system\n\n## Configuration\n\n### Environment Variables\n- `SESSION_SECRET`: Flask session secret key\n- `GOOGLE_GENAI_API_KEY`: Google Gemini API key\n- `MAIL_SERVER`: SMTP server (optional)\n- `MAIL_USERNAME`: Email username (optional)\n- `MAIL_PASSWORD`: Email password (optional)\n\n### Application Settings\n- Maximum file upload: 16MB\n- Database: SQLite with WAL mode\n- Session timeout: Configurable\n- Cache: Simple in-memory caching\n\n## Development\n\n### Running in Development Mode\n```bash\n# Set Flask environment\nexport FLASK_ENV=development\nexport FLASK_DEBUG=1\n\n# Run the application\npython app.py\n```\n\n### Adding New Features\n1. Database migrations in `init_db()` function\n2. Route handlers in `app.py`\n3. Templates in `templates/` directory\n4. Static files in `static/` directory\n\n## Troubleshooting\n\n### Common Issues\n\n**Database Lock Error:**\n- The app uses WAL mode with timeouts to prevent locks\n- Restart the application if persistent\n\n**AI Grading Not Working:**\n- Check Google Gemini API key configuration\n- Verify API quota and permissions\n- Check network connectivity\n\n**File Upload Issues:**\n- Ensure upload directories exist and are writable\n- Check file size limits (16MB max)\n- Verify secure filename handling\n\n**Socket.IO Connection Problems:**\n- Check CORS settings\n- Verify port 5000 accessibility\n- Clear browser cache and cookies\n\n### Logs and Debugging\n- Check console output for Flask debug messages\n- Database operations are logged\n- AI API errors are logged with details\n\n## Security Considerations\n\n- All passwords are hashed using Werkzeug\n- CSRF protection on all forms\n- Secure file upload handling\n- SQL injection prevention with parameterized queries\n- Session management with secure cookies\n- Role-based access control\n\n## Production Deployment\n\nFor production use:\n1. Use a production WSGI server (Gunicorn recommended)\n2. Configure proper environment variables\n3. Use PostgreSQL or MySQL instead of SQLite\n4. Set up proper logging\n5. Configure SSL/HTTPS\n6. Use a reverse proxy (Nginx recommended)\n\n## License\n\nThis project is provided as-is for educational and development purposes.\n\n## Support\n\nFor issues and questions:\n1. Check the troubleshooting section\n2. Review console logs for error details\n3. Verify all environment variables are set correctly\n4. Ensure all dependencies are installed\n\n---\n\n**Happy Learning with LearnNest! ðŸš€**","size_bytes":6830},"LearnNestGemini/weather-app-abdulwaheed/start.sh":{"content":"#!/bin/bash\ncd /home/runner/weather-app-abdulwaheed\npython3 app.py\n","size_bytes":67},"ghalib/templates/student/video_download/static/src/input.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;","size_bytes":58},"LearnNestGemini/weather-app-abdulwaheed/gemini_ai.py":{"content":"# IMPORTANT: KEEP THIS COMMENT\n# Follow these instructions when using this blueprint:\n# - Note that the newest Gemini model series is \"gemini-2.5-flash\" or gemini-2.5-pro\"\n#   - do not change this unless explicitly requested by the user\n# - Sometimes the google genai SDK has occasional type errors. You might need to run to validate, at time.  \n# The SDK was recently renamed from google-generativeai to google-genai. This file reflects the new name and the new APIs.\n\nimport json\nimport logging\nimport os\nfrom google import genai\nfrom google.genai import types\n\n# This API key is from Gemini Developer API Key, not vertex AI API Key\n# Lazy client initialization to avoid crashing imports when env var is missing\n_client = None\ndef _get_client():\n    \"\"\"Get or create the Gemini client with lazy initialization\"\"\"\n    global _client\n    if _client is None:\n        api_key = os.environ.get(\"GEMINI_API_KEY\") or os.environ.get(\"GOOGLE_GENAI_API_KEY\")\n        if not api_key:\n            raise ValueError(\"GEMINI_API_KEY environment variable is not set. Please configure your Gemini API key.\")\n\n        _client = genai.Client(api_key=api_key)\n\n    return _client\n\n\ndef grade_assignment(assignment_text, rubric=\"\", max_points=100):\n    \"\"\"Grade an assignment using Gemini AI with detailed feedback\"\"\"\n    try:\n        prompt = f\"\"\"\n        Please grade this assignment and provide detailed feedback.\n        \n        Assignment Text:\n        {assignment_text}\n        \n        Grading Rubric:\n        {rubric if rubric else \"Standard academic grading criteria focusing on content accuracy, clarity, organization, and completeness.\"}\n        \n        Maximum Points: {max_points}\n        \n        Please provide your response in the following JSON format:\n        {{\n            \"grade\": <numeric_grade>,\n            \"percentage\": <percentage_score>,\n            \"feedback\": \"Detailed feedback explaining strengths and areas for improvement\",\n            \"suggestions\": \"Specific suggestions for improvement\"\n        }}\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        if response.text:\n            result = json.loads(response.text)\n            return {\n                'grade': min(float(result.get('grade', 0)), max_points),\n                'percentage': min(float(result.get('percentage', 0)), 100),\n                'feedback': result.get('feedback', 'No feedback provided'),\n                'suggestions': result.get('suggestions', 'No suggestions provided')\n            }\n        else:\n            return {\n                'grade': 0,\n                'percentage': 0,\n                'feedback': 'Unable to grade assignment automatically',\n                'suggestions': 'Please have instructor review manually'\n            }\n            \n    except Exception as e:\n        logging.error(f\"Error grading assignment: {e}\")\n        return {\n            'grade': 0,\n            'percentage': 0,\n            'feedback': 'Error occurred during automated grading',\n            'suggestions': 'Please have instructor review manually'\n        }\n\ndef generate_mcq_options(question_text, context=\"\"):\n    \"\"\"Generate 4 MCQ options for a given question using AI\"\"\"\n    try:\n        prompt = f\"\"\"\n        Generate 4 multiple choice options (A, B, C, D) for the following question.\n        Make sure one option is correct and the other three are plausible but incorrect.\n        \n        Question: {question_text}\n        {f\"Context/Topic: {context}\" if context else \"\"}\n        \n        Provide your response in the following JSON format:\n        {{\n            \"option_a\": \"First option text\",\n            \"option_b\": \"Second option text\",\n            \"option_c\": \"Third option text\",\n            \"option_d\": \"Fourth option text\",\n            \"correct_answer\": \"A\",\n            \"explanation\": \"Brief explanation of why the correct answer is right\"\n        }}\n        \n        Make the options clear, concise, and educational.\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        if response.text:\n            result = json.loads(response.text)\n            return {\n                'option_a': result.get('option_a', ''),\n                'option_b': result.get('option_b', ''),\n                'option_c': result.get('option_c', ''),\n                'option_d': result.get('option_d', ''),\n                'correct_answer': result.get('correct_answer', 'A'),\n                'explanation': result.get('explanation', '')\n            }\n        else:\n            return None\n            \n    except Exception as e:\n        logging.error(f\"Error generating MCQ options: {e}\")\n        return None\n\ndef generate_forum_response(topic_title, topic_content, existing_replies=\"\"):\n    \"\"\"Generate an AI response for forum discussions\"\"\"\n    try:\n        prompt = f\"\"\"\n        Generate a helpful and educational response to this forum discussion topic.\n        \n        Topic: {topic_title}\n        Content: {topic_content}\n        \n        Existing Replies: {existing_replies if existing_replies else \"None\"}\n        \n        Please provide a constructive, educational response that:\n        1. Addresses the main points raised\n        2. Provides additional insights or clarifications\n        3. Encourages further discussion\n        4. Maintains a supportive learning environment\n        \n        Keep the response conversational and academic in tone.\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt\n        )\n        \n        return response.text if response.text else \"Unable to generate AI response at this time.\"\n        \n    except Exception as e:\n        logging.error(f\"Error generating forum response: {e}\")\n        return \"Unable to generate AI response at this time.\"\n\ndef determine_correct_answer(question_text, options):\n    \"\"\"\n    NEW FEATURE: AI Auto-Correction for MCQ\n    Gemini AI automatically determines which option is correct based on the question and available options.\n    Instructor does NOT need to select the correct answer manually.\n    \n    Args:\n        question_text (str): The MCQ question\n        options (dict): Dictionary of options like {'A': 'text', 'B': 'text', 'C': 'text', 'D': 'text'}\n    \n    Returns:\n        str: The letter of the correct answer (A, B, C, or D)\n    \"\"\"\n    try:\n        options_text = \"\\n\".join([f\"{letter}. {text}\" for letter, text in options.items()])\n        \n        prompt = f\"\"\"\n        You are an educational AI assistant. Given the following multiple-choice question and options, \n        determine which option (A, B, C, or D) is the CORRECT answer.\n        \n        Question:\n        {question_text}\n        \n        Options:\n        {options_text}\n        \n        Analyze the question carefully and respond with ONLY the letter (A, B, C, or D) of the correct answer.\n        Do not include any explanation, just the single letter.\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt\n        )\n        \n        if response.text:\n            answer = response.text.strip().upper()\n            if answer in ['A', 'B', 'C', 'D']:\n                logging.info(f\"AI determined correct answer: {answer} for question: {question_text[:50]}...\")\n                return answer\n            else:\n                logging.warning(f\"AI response '{answer}' is not valid. Defaulting to 'A'\")\n                return 'A'\n        else:\n            logging.warning(\"No AI response received. Defaulting to 'A'\")\n            return 'A'\n            \n    except Exception as e:\n        logging.error(f\"Error determining correct answer with AI: {e}\")\n        return 'A'\n\ndef analyze_student_progress(assignment_history, participation_data):\n    \"\"\"Analyze student progress and provide recommendations\"\"\"\n    try:\n        prompt = f\"\"\"\n        Analyze this student's academic progress and provide recommendations.\n        \n        Assignment History: {assignment_history}\n        Participation Data: {participation_data}\n        \n        Please provide analysis in JSON format:\n        {{\n            \"overall_performance\": \"assessment of overall performance\",\n            \"strengths\": [\"list of strengths\"],\n            \"areas_for_improvement\": [\"list of areas to improve\"],\n            \"recommendations\": [\"specific recommendations for student\"],\n            \"engagement_level\": \"high/medium/low\"\n        }}\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        if response.text:\n            return json.loads(response.text)\n        else:\n            return {\n                \"overall_performance\": \"Unable to analyze\",\n                \"strengths\": [],\n                \"areas_for_improvement\": [],\n                \"recommendations\": [],\n                \"engagement_level\": \"unknown\"\n            }\n            \n    except Exception as e:\n        logging.error(f\"Error analyzing student progress: {e}\")\n        return {\n            \"overall_performance\": \"Analysis unavailable\",\n            \"strengths\": [],\n            \"areas_for_improvement\": [],\n            \"recommendations\": [],\n            \"engagement_level\": \"unknown\"\n        }\n\ndef generate_video_notes(video_title, video_description=\"\", video_duration=\"\", video_url=\"\"):\n    \"\"\"\n    NEW FEATURE: AI-Powered Video Notes Generation - Enhanced for Accuracy\n    Generate comprehensive, well-structured educational notes for a video using Gemini AI.\n    This creates detailed study notes with proper formatting and learning outcomes.\n    \n    Args:\n        video_title (str): The title of the video\n        video_description (str): Optional description of the video content\n        video_duration (str): Optional duration of the video\n        video_url (str): YouTube video URL for analysis\n    \n    Returns:\n        str: Comprehensive, accurately formatted study notes for the video\n    \"\"\"\n    try:\n        duration_text = f\"Video Duration: {video_duration}\" if video_duration else \"\"\n        description_text = f\"Video Description: {video_description}\" if video_description else \"\"\n        \n        prompt = f\"\"\"\n        You are a world-class educational content specialist and pedagogical expert. Your task is to create exceptionally high-quality, \n        well-structured study notes that are accurate, comprehensive, and easy to understand.\n        \n        VIDEO INFORMATION:\n        - Title: {video_title}\n        {f\"- Description: {description_text}\" if description_text else \"\"}\n        {f\"- Duration: {duration_text}\" if duration_text else \"\"}\n        {f\"- URL: {video_url}\" if video_url else \"\"}\n        \n        CREATE COMPREHENSIVE STUDY NOTES WITH THE FOLLOWING STRUCTURE:\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        1. LEARNING OBJECTIVES\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - List 5-7 specific learning outcomes students should achieve\n        - Use action verbs (understand, analyze, apply, evaluate)\n        - Make objectives measurable and clear\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        2. EXECUTIVE SUMMARY\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Provide a compelling 2-3 paragraph overview of the topic\n        - Highlight why this topic matters and its real-world applications\n        - Connect to broader educational concepts\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        3. FUNDAMENTAL CONCEPTS & DEFINITIONS\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Define key terms with clarity and precision\n        - Provide etymology or origin of important terms when relevant\n        - Use examples to illustrate each concept\n        - Bold important terminology\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        4. DETAILED CONTENT BREAKDOWN\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        Structure as:\n        - Main Topic Headings\n        - Sub-concepts with detailed explanations\n        - Real-world examples and case studies\n        - Visual descriptions (if applicable)\n        - Common misconceptions and clarifications\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        5. WORKED EXAMPLES & APPLICATIONS\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Include 3-5 concrete, well-explained examples\n        - Show step-by-step problem-solving approach\n        - Demonstrate how theory translates to practice\n        - Include both simple and complex examples\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        6. KEY FORMULAS, THEOREMS & PRINCIPLES\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - List all essential equations or principles\n        - Explain the significance of each\n        - Show how to use them in context\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        7. SUMMARY TABLE OF KEY POINTS\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        Create a structured summary with:\n        - Concept | Definition | Relevance | Example\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        8. STUDY QUESTIONS & SELF-ASSESSMENT\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - 5-8 progressive difficulty comprehension questions\n        - Include: factual recall, application, and critical thinking questions\n        - Provide answer guides or hints where helpful\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        9. COMMON ERRORS & HOW TO AVOID THEM\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Identify typical student mistakes\n        - Explain why these errors occur\n        - Provide strategies to prevent them\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        10. EXTENSION & FURTHER LEARNING\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Advanced concepts that build on this foundation\n        - Related topics worth exploring\n        - Recommended next steps in learning journey\n        \n        QUALITY REQUIREMENTS:\n        âœ“ Be exceptionally clear and accurate in all explanations\n        âœ“ Use consistent formatting and structure throughout\n        âœ“ Target audience: Advanced undergraduate/early graduate level\n        âœ“ Ensure all content is factually correct and well-researched\n        âœ“ Total length: 2000-2500 words for comprehensive coverage\n        âœ“ Use professional but accessible language\n        âœ“ Include citations or references where appropriate\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt\n        )\n        \n        if response.text and len(response.text) > 100:\n            logging.info(f\"Successfully generated comprehensive notes for video: {video_title[:50]}... ({len(response.text)} characters)\")\n            return response.text\n        else:\n            logging.warning(\"AI response too short or empty for notes generation\")\n            return f\"Study Notes for: {video_title}\\n\\nUnable to generate detailed notes at this time. Please try again later.\"\n            \n    except Exception as e:\n        logging.error(f\"Error generating video notes: {e}\")\n        return f\"Study Notes for: {video_title}\\n\\nError occurred while generating notes. Please try again later.\"\n\ndef generate_video_transcript(video_title, video_description=\"\", video_duration=\"\", video_url=\"\"):\n    \"\"\"\n    NEW FEATURE: AI-Powered Video Transcript Generation\n    Generate a comprehensive educational transcript for a video using Gemini AI.\n    This analyzes the actual YouTube video content to create detailed transcripts.\n    \n    Args:\n        video_title (str): The title of the video\n        video_description (str): Optional description of the video content\n        video_duration (str): Optional duration of the video\n        video_url (str): YouTube video URL for analysis\n    \n    Returns:\n        str: A comprehensive transcript/notes for the video\n    \"\"\"\n    try:\n        duration_text = f\"Video Duration: {video_duration}\" if video_duration else \"\"\n        description_text = f\"\\nVideo Description:\\n{video_description}\" if video_description else \"\"\n        \n        # If video URL is provided, use Gemini's video understanding\n        if video_url and ('youtube.com' in video_url or 'youtu.be' in video_url):\n            prompt = f\"\"\"\n            You are an expert educational content creator. Analyze this YouTube educational video and generate a comprehensive, \n            detailed transcript and lecture notes.\n            \n            Video Title: {video_title}\n            {description_text}\n            {duration_text}\n            Video URL: {video_url}\n            \n            Please watch/analyze the video and create a detailed educational transcript that includes:\n            \n            1. INTRODUCTION\n               - Brief overview of what the video covers\n               - Learning objectives from the actual video content\n            \n            2. MAIN CONTENT (based on actual video)\n               - Comprehensive coverage of topics discussed in the video\n               - Key concepts and definitions mentioned\n               - Important points and explanations from the lecture\n               - Examples and demonstrations shown\n               - Visual content described\n            \n            3. KEY TAKEAWAYS\n               - Summary of main points from the video\n               - Important concepts to remember\n            \n            4. TIMESTAMPS & TOPICS (if applicable)\n               - Major sections of the video with approximate timestamps\n            \n            5. ADDITIONAL RESOURCES\n               - Suggested topics for further study based on video content\n               - Related concepts mentioned in the video\n            \n            Format the transcript in a clear, professional manner with proper headings and structure.\n            Make it comprehensive enough to serve as standalone study material for students.\n            The transcript should be detailed (1000-2000 words) to provide substantial educational value.\n            \"\"\"\n        else:\n            # Fallback to title and description if no valid YouTube URL\n            prompt = f\"\"\"\n            You are an expert educational content creator. Generate a comprehensive, detailed transcript and lecture notes \n            for an educational video based on the following information:\n            \n            Video Title: {video_title}\n            {description_text}\n            {duration_text}\n            \n            Please create a detailed educational transcript that includes:\n            \n            1. INTRODUCTION\n               - Brief overview of the topic\n               - Learning objectives\n            \n            2. MAIN CONTENT\n               - Comprehensive coverage of the topic\n               - Key concepts and definitions\n               - Important points and explanations\n               - Examples where applicable\n            \n            3. KEY TAKEAWAYS\n               - Summary of main points\n               - Important concepts to remember\n            \n            4. ADDITIONAL RESOURCES\n               - Suggested topics for further study\n               - Related concepts to explore\n            \n            Format the transcript in a clear, professional manner with proper headings and structure.\n            Make it comprehensive enough to serve as standalone study material for students.\n            The transcript should be 800-1500 words to provide substantial educational value.\n            \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt\n        )\n        \n        if response.text:\n            logging.info(f\"Successfully generated transcript for video: {video_title[:50]}...\")\n            return response.text\n        else:\n            logging.warning(\"No AI response received for transcript generation\")\n            return f\"Transcript for: {video_title}\\n\\nUnable to generate detailed transcript at this time. Please try again later.\"\n            \n    except Exception as e:\n        logging.error(f\"Error generating video transcript: {e}\")\n        return f\"Transcript for: {video_title}\\n\\nError occurred while generating transcript. Please try again later.\"\n\ndef generate_student_notes(topic, course_title=\"\", course_code=\"\"):\n    \"\"\"\n    Generate professional study notes from a topic/subject using Gemini AI.\n    Creates comprehensive 2000-2500 word study material for any topic.\n    \n    Args:\n        topic (str): Student's topic/subject to create notes for\n        course_title (str): Course name for context\n        course_code (str): Course code\n    \n    Returns:\n        str: Comprehensive, well-structured study notes (2000-2500 words)\n    \"\"\"\n    try:\n        prompt = f\"\"\"\n        You are an expert academic instructor and note-taking specialist. A student has requested comprehensive study notes on a topic.\n        Your task is to create professional, well-structured, educational study material from scratch.\n        \n        TOPIC/SUBJECT:\n        {topic}\n        \n        {'COURSE: ' + course_title + ' (' + course_code + ')' if course_title else ''}\n        \n        CREATE COMPREHENSIVE, PROFESSIONAL STUDY NOTES WITH THIS STRUCTURE:\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        1. LEARNING OBJECTIVES\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - List 5-7 specific learning outcomes students should achieve\n        - Make them measurable and clear\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        2. EXECUTIVE SUMMARY\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Provide a 2-3 paragraph overview of the topic\n        - Highlight why this topic matters\n        - Connect to real-world applications\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        3. FUNDAMENTAL CONCEPTS & DEFINITIONS\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Define all key terms with clarity\n        - Use bold formatting for important terminology\n        - Provide examples for each concept\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        4. DETAILED CONTENT BREAKDOWN\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Main topic sections with subsections\n        - In-depth explanations and examples\n        - Practical applications where relevant\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        5. KEY TAKEAWAYS & SUMMARY\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - List main points to remember\n        - Create a concise summary\n        - Highlight important relationships\n        \n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        6. PRACTICE & REVIEW\n        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n        - Suggest key questions for self-assessment\n        - Areas for further study\n        - Related topics to explore\n        \n        REQUIREMENTS:\n        - Total length: 2000-2500 words\n        - Professional academic tone\n        - Clear hierarchical structure with headings\n        - Rich with examples and explanations\n        - Make it suitable for printing and long-term studying\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt\n        )\n        \n        if response.text:\n            logging.info(f\"Successfully generated student notes from input\")\n            return response.text\n        else:\n            logging.warning(\"No AI response for student notes generation\")\n            return f\"Study Notes for: {topic}\\n\\nUnable to generate detailed notes at this time. Please try again later.\"\n            \n    except Exception as e:\n        logging.error(f\"Error generating student notes: {e}\")\n        return f\"Study Notes for: {topic}\\n\\nError occurred while generating notes. Please try again later.\"\n\ndef generate_mcq_quiz(topic, num_questions=5, difficulty=\"medium\"):\n    \"\"\"\n    Generate multiple-choice quiz questions from a topic using Gemini AI.\n    \n    Args:\n        topic (str): The topic/subject to create quiz questions for\n        num_questions (int): Number of questions to generate (default: 5)\n        difficulty (str): Difficulty level - 'easy', 'medium', or 'hard'\n    \n    Returns:\n        list: List of dictionaries containing questions with options and correct answers\n    \"\"\"\n    try:\n        prompt = f\"\"\"\n        You are an expert educator. Generate {num_questions} multiple-choice quiz questions about the following topic at {difficulty} difficulty level.\n        \n        TOPIC: {topic}\n        \n        For each question, provide:\n        1. A clear, unambiguous question\n        2. Four options (A, B, C, D)\n        3. The correct answer (A, B, C, or D)\n        4. Brief explanation of why the correct answer is right\n        \n        Format your response as a valid JSON array with this exact structure:\n        [\n            {{\n                \"question\": \"What is...\",\n                \"options\": {{\n                    \"A\": \"Option text\",\n                    \"B\": \"Option text\",\n                    \"C\": \"Option text\",\n                    \"D\": \"Option text\"\n                }},\n                \"correct_answer\": \"A\",\n                \"explanation\": \"This is the correct answer because...\"\n            }},\n            ...\n        ]\n        \n        Requirements:\n        - Each question must be distinct and test different concepts\n        - Options should be plausible to avoid obvious answers\n        - Explanations should be educational\n        - Ensure valid JSON format\n        - Generate exactly {num_questions} questions\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        if response.text:\n            try:\n                questions = json.loads(response.text)\n                \n                # Validate response structure\n                if not isinstance(questions, list) or len(questions) == 0:\n                    logging.error(f\"Invalid MCQ response structure: expected non-empty list, got {type(questions)}\")\n                    raise ValueError(\"AI returned invalid question format\")\n                \n                # Validate each question has required fields\n                for i, q in enumerate(questions):\n                    if not all(key in q for key in ['question', 'options', 'correct_answer']):\n                        logging.error(f\"Question {i+1} missing required fields\")\n                        raise ValueError(f\"Question {i+1} has invalid structure\")\n                \n                logging.info(f\"Successfully generated {len(questions)} MCQ questions for topic: {topic}\")\n                return questions\n                \n            except json.JSONDecodeError as je:\n                logging.error(f\"Invalid JSON response from Gemini for MCQ generation: {je}\")\n                logging.error(f\"Response text: {response.text[:500]}...\")  # Log first 500 chars for debugging\n                raise ValueError(\"AI returned malformed response. Please try again.\")\n        else:\n            logging.warning(\"No AI response received for MCQ generation\")\n            raise ValueError(\"No response from AI. Please check your API key and try again.\")\n            \n    except ValueError as ve:\n        # Re-raise ValueError with clear message for user\n        raise ve\n    except Exception as e:\n        logging.error(f\"Error generating MCQ quiz: {e}\")\n        raise Exception(f\"Failed to generate questions: {str(e)}\")\n\n\ndef generate_ai_notes(topic, teacher_name=\"\", additional_context=\"\"):\n    \"\"\"Generate comprehensive study notes on a given topic using Gemini AI\"\"\"\n    try:\n        prompt = f\"\"\"\n        Generate comprehensive study notes on: {topic}\n        {f\"Context: {additional_context}\" if additional_context else \"\"}\n        \n        Structure the notes with clear headings and organized content:\n        - Introduction\n        - Key Concepts\n        - Detailed Explanations with Examples\n        - Important Points\n        - Summary\n        \n        Provide ONLY the study notes content. Do not include any meta-instructions, commands, \n        or formatting explanations. Write directly for students to read and learn.\n        \"\"\"\n        \n        client = _get_client()\n        response = client.models.generate_content(\n            model=\"gemini-2.5-pro\",\n            contents=prompt,\n        )\n        \n        if response.text:\n            content = response.text.strip()\n            \n            # Clean up common AI artifacts\n            content = content.replace('```markdown', '').replace('```', '')\n            \n            # Remove any meta-instructions or commands\n            lines = content.split('\\n')\n            cleaned_lines = []\n            skip_next = False\n            \n            for line in lines:\n                line_lower = line.lower().strip()\n                # Skip lines that look like instructions or meta-content\n                if any(phrase in line_lower for phrase in [\n                    'here is', 'here are', 'i will', 'i have', 'let me',\n                    'as requested', 'note that', 'please note',\n                    'this document', 'these notes', 'above is'\n                ]):\n                    if len(line.strip()) < 100:  # Only skip if it's a short instructional line\n                        continue\n                \n                cleaned_lines.append(line)\n            \n            content = '\\n'.join(cleaned_lines).strip()\n            \n            logging.info(f\"Successfully generated AI notes for topic: {topic}\")\n            return {\n                'success': True,\n                'content': content,\n                'topic': topic,\n                'teacher_name': teacher_name\n            }\n        else:\n            logging.warning(\"No AI response received for notes generation\")\n            return {\n                'success': False,\n                'content': '',\n                'error': 'No response from AI'\n            }\n            \n    except Exception as e:\n        logging.error(f\"Error generating AI notes: {e}\")\n        return {\n            'success': False,\n            'content': '',\n            'error': str(e)\n        }\n\ndef answer_student_question(question):\n    \"\"\"\n    Answer student questions instantly using Gemini AI with visual generation capability.\n    \n    Args:\n        question (str): The student's question\n    \n    Returns:\n        dict: Contains 'answer' text and optional 'needs_visual' flag with 'visual_prompt'\n    \"\"\"\n    try:\n        # First, determine if this question would benefit from a visual\n        analysis_prompt = f\"\"\"Analyze this student question and determine if a visual diagram, chart, or illustration would significantly help explain the concept:\n\nQUESTION: {question}\n\nRespond with JSON:\n{{\n    \"needs_visual\": true/false,\n    \"visual_type\": \"diagram/chart/illustration/none\",\n    \"visual_description\": \"Brief description of what visual to create (if needed)\"\n}}\"\"\"\n        \n        client = _get_client()\n        analysis_response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=analysis_prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        needs_visual = False\n        visual_prompt = None\n        \n        if analysis_response and analysis_response.text:\n            try:\n                analysis = json.loads(analysis_response.text)\n                needs_visual = analysis.get('needs_visual', False)\n                if needs_visual:\n                    visual_prompt = f\"Educational {analysis.get('visual_type', 'diagram')} showing {analysis.get('visual_description', question)}, clean design, clear labels, professional style\"\n            except:\n                pass\n        \n        # Now generate the text answer\n        prompt = f\"\"\"You are an expert AI Study Assistant helping students with their academic questions.\nA student has asked you the following question:\n\nQUESTION: {question}\n\nPlease provide a clear, comprehensive, and educational answer that:\n1. Directly addresses the student's question\n2. Explains concepts in an easy-to-understand manner\n3. Provides examples where helpful\n4. Is accurate and academically sound\n5. Is encouraging and supportive\n{'6. Mention that a visual diagram is being generated to help illustrate the concept' if needs_visual else ''}\n\nKeep your answer concise but thorough (200-400 words).\n\nANSWER:\"\"\"\n        \n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt\n        )\n        \n        if response and response.text:\n            logging.info(f\"AI Assistant answered question: {question[:50]}... (Visual: {needs_visual})\")\n            return {\n                'answer': response.text.strip(),\n                'needs_visual': needs_visual,\n                'visual_prompt': visual_prompt\n            }\n        else:\n            logging.warning(\"No AI response for student question\")\n            return {\n                'answer': \"I'm having trouble generating an answer right now. Please try again in a moment.\",\n                'needs_visual': False\n            }\n            \n    except Exception as e:\n        logging.error(f\"Error answering student question: {e}\")\n        return {\n            'answer': \"I encountered an error while processing your question. Please try again.\",\n            'needs_visual': False\n        }","size_bytes":38969},"zsam/app.py":{"content":"import os\nimport sqlite3\nimport logging\nfrom datetime import datetime, timedelta\nfrom functools import wraps\nfrom werkzeug.security import generate_password_hash, check_password_hash\nfrom werkzeug.utils import secure_filename\nfrom flask import Flask, render_template, request, redirect, url_for, flash, jsonify, session, send_from_directory\nfrom flask_login import LoginManager, UserMixin, login_user, login_required, logout_user, current_user\nfrom flask_socketio import SocketIO, emit, join_room, leave_room, rooms\nfrom flask_caching import Cache\nfrom flask_mail import Mail, Message\nfrom threading import Lock\nimport json\nimport uuid\nfrom dotenv import load_dotenv\nimport gemini_ai\n\n# Load environment variables\nload_dotenv()\n\n# Initialize Flask app\napp = Flask(__name__)\napp.config['SECRET_KEY'] = os.environ.get('SESSION_SECRET') or 'dev-secret-key-change-in-production'\napp.config['UPLOAD_FOLDER'] = os.path.join(os.getcwd(), 'sir_rafique', 'uploads')  # Use relative path for Replit\napp.config['MAX_CONTENT_LENGTH'] = None  # No file size limit for videos\n\n# Database configuration\nDATABASE = os.path.join(os.getcwd(), 'sir_rafique', 'learnnest.db')\n\n# Initialize extensions\nlogin_manager = LoginManager()\nlogin_manager.init_app(app)\nlogin_manager.login_view = 'login'  # type: ignore\nlogin_manager.login_message = 'Please log in to access this page.'\n\nsocketio = SocketIO(app, cors_allowed_origins=\"*\", async_mode='threading')\n\n# Initialize caching\ncache = Cache(app, config={'CACHE_TYPE': 'simple'})\n\n# Initialize mail\nmail = Mail(app)\n\n# Register custom Jinja filters and globals\n@app.template_filter('nl2br')\ndef nl2br_filter(s):\n    \"\"\"Convert newlines to HTML line breaks\"\"\"\n    if s is None:\n        return ''\n    return str(s).replace('\\n', '<br>\\n')\n\n# Add custom Jinja2 global functions\n@app.template_global()\ndef max_func(*args):\n    \"\"\"Max function for Jinja2 templates\"\"\"\n    return max(args)\n\n@app.template_global()\ndef min_func(*args):\n    \"\"\"Min function for Jinja2 templates\"\"\"\n    return min(args)\n\n# CSRF protection helpers\nimport secrets\nimport hashlib\n\ndef generate_csrf_token():\n    \"\"\"Generate a CSRF token for forms\"\"\"\n    token = secrets.token_urlsafe(32)\n    session['csrf_token'] = token\n    return token\n\ndef validate_csrf_token(token):\n    \"\"\"Validate CSRF token\"\"\"\n    if not token or token != session.get('csrf_token'):\n        return False\n    return True\n\n@app.context_processor\ndef inject_csrf_token():\n    \"\"\"Make CSRF token available in all templates\"\"\"\n    if 'csrf_token' not in session:\n        session['csrf_token'] = secrets.token_urlsafe(32)\n    return dict(csrf_token=session['csrf_token'])\n\n# Thread lock for database operations\ndb_lock = Lock()\n\n# Create uploads directory\nos.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'assignments'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'resources'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'payments'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'instructor_screenshots'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'transcripts'), exist_ok=True)\n\n# Database connection helper\ndef get_db_connection():\n    conn = sqlite3.connect(DATABASE, timeout=30)\n    conn.execute('PRAGMA journal_mode=WAL;')\n    conn.execute('PRAGMA synchronous=NORMAL;')\n    conn.execute('PRAGMA cache_size=10000;')\n    conn.execute('PRAGMA temp_store=MEMORY;')\n    conn.row_factory = sqlite3.Row\n    return conn\n\ndef update_student_progress(conn, student_id, course_id):\n    \"\"\"\n    Calculate and update student progress for a course based on quiz completions\n    Progress = (Number of Submitted Quizzes / Total Quizzes) * 100\n    \"\"\"\n    try:\n        # Get total number of quizzes for this course\n        total_quizzes = conn.execute('''\n            SELECT COUNT(*) as count\n            FROM assignments\n            WHERE course_id = ? AND assignment_type = 'quiz' AND is_active = 1\n        ''', (course_id,)).fetchone()['count']\n        \n        if total_quizzes == 0:\n            # No quizzes, set progress to 0\n            progress = 0\n        else:\n            # Get number of submitted quizzes by student\n            submitted_quizzes = conn.execute('''\n                SELECT COUNT(DISTINCT a.id) as count\n                FROM assignments a\n                INNER JOIN assignment_submissions sub ON a.id = sub.assignment_id\n                WHERE a.course_id = ? \n                AND a.assignment_type = 'quiz'\n                AND a.is_active = 1\n                AND sub.student_id = ?\n            ''', (course_id, student_id)).fetchone()['count']\n            \n            # Calculate progress percentage\n            progress = (submitted_quizzes / total_quizzes) * 100\n        \n        # Update enrollment progress\n        conn.execute('''\n            UPDATE enrollments\n            SET progress_percentage = ?\n            WHERE student_id = ? AND course_id = ?\n        ''', (progress, student_id, course_id))\n        \n        conn.commit()\n        \n        return progress\n        \n    except Exception as e:\n        print(f\"Error updating student progress: {e}\")\n        return 0\n\n# User class for Flask-Login\nclass User(UserMixin):\n    def __init__(self, id, username, email, role, full_name, created_at, active_status=True, \n                 instructor_approval_status='approved', approved_by=None, approved_at=None):\n        self.id = id\n        self.username = username\n        self.email = email\n        self.role = role\n        self.full_name = full_name\n        self.created_at = created_at\n        self._is_active = active_status\n        self.instructor_approval_status = instructor_approval_status\n        self.approved_by = approved_by\n        self.approved_at = approved_at\n\n    def get_id(self):\n        return str(self.id)\n\n    def is_admin(self):\n        return self.role == 'admin'\n    \n    def is_instructor(self):\n        return self.role == 'instructor'\n    \n    def is_student(self):\n        return self.role == 'student'\n    \n    def is_instructor_approved(self):\n        \"\"\"Check if instructor is approved to access instructor features\"\"\"\n        if not self.is_instructor():\n            return True  # Non-instructors don't need approval\n        return self.instructor_approval_status == 'approved'\n    \n    def is_instructor_pending(self):\n        \"\"\"Check if instructor is pending approval\"\"\"\n        return self.is_instructor() and self.instructor_approval_status == 'pending'\n    \n    def is_instructor_rejected(self):\n        \"\"\"Check if instructor was rejected\"\"\"\n        return self.is_instructor() and self.instructor_approval_status == 'rejected'\n\n@login_manager.user_loader\ndef load_user(user_id):\n    with db_lock:\n        conn = get_db_connection()\n        user = conn.execute(\n            'SELECT * FROM users WHERE id = ? AND is_active = 1', (user_id,)\n        ).fetchone()\n        conn.close()\n    \n    if user:\n        return User(user['id'], user['username'], user['email'], user['role'], \n                   user['full_name'], user['created_at'], user['is_active'],\n                   user['instructor_approval_status'] if user['instructor_approval_status'] else 'approved',\n                   user['approved_by'],\n                   user['approved_at'])\n    return None\n\n# Role-based access control decorators\ndef admin_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if not current_user.is_authenticated or not current_user.is_admin():\n            flash('Access denied. Admin privileges required.', 'error')\n            return redirect(url_for('dashboard'))\n        return f(*args, **kwargs)\n    return decorated_function\n\ndef instructor_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if not current_user.is_authenticated:\n            flash('Access denied. Please log in.', 'error')\n            return redirect(url_for('login'))\n        \n        # Admins always have access to instructor features\n        if current_user.is_admin():\n            return f(*args, **kwargs)\n        \n        # Check if user is instructor\n        if not current_user.is_instructor():\n            flash('Access denied. Instructor privileges required.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Check if instructor is approved\n        if not current_user.is_instructor_approved():\n            flash('Your instructor account is pending approval. Please wait for admin approval.', 'warning')\n            return redirect(url_for('dashboard'))\n        \n        return f(*args, **kwargs)\n    return decorated_function\n\n# Database initialization\ndef init_db():\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Users table\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS users (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                username TEXT UNIQUE NOT NULL,\n                email TEXT UNIQUE NOT NULL,\n                password_hash TEXT NOT NULL,\n                role TEXT NOT NULL DEFAULT 'student',\n                full_name TEXT NOT NULL,\n                bio TEXT,\n                profile_image TEXT,\n                instructor_approval_status TEXT DEFAULT 'approved',\n                approved_by INTEGER,\n                approved_at TIMESTAMP,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                last_login TIMESTAMP,\n                is_active BOOLEAN DEFAULT 1,\n                FOREIGN KEY (approved_by) REFERENCES users (id)\n            )\n        ''')\n        \n        # Add new columns to existing tables (migrations)\n        try:\n            conn.execute('ALTER TABLE users ADD COLUMN instructor_approval_status TEXT DEFAULT \"approved\"')\n        except sqlite3.OperationalError:\n            pass  # Column already exists\n        \n        try:\n            conn.execute('ALTER TABLE users ADD COLUMN approved_by INTEGER')\n        except sqlite3.OperationalError:\n            pass  # Column already exists\n            \n        try:\n            conn.execute('ALTER TABLE users ADD COLUMN approved_at TIMESTAMP')\n        except sqlite3.OperationalError:\n            pass  # Column already exists\n            \n        try:\n            conn.execute('ALTER TABLE courses ADD COLUMN enrollment_key_hash TEXT')\n        except sqlite3.OperationalError:\n            pass  # Column already exists\n        \n        try:\n            conn.execute('ALTER TABLE users ADD COLUMN instructor_screenshot TEXT')\n        except sqlite3.OperationalError:\n            pass  # Column already exists\n        \n        # Courses table\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS courses (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                course_code TEXT UNIQUE NOT NULL,\n                title TEXT NOT NULL,\n                description TEXT,\n                syllabus TEXT,\n                instructor_id INTEGER NOT NULL,\n                category TEXT,\n                max_students INTEGER DEFAULT 50,\n                start_date DATE,\n                end_date DATE,\n                enrollment_key_hash TEXT,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                is_active BOOLEAN DEFAULT 1,\n                FOREIGN KEY (instructor_id) REFERENCES users (id)\n            )\n        ''')\n        \n        # Enrollments table\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS enrollments (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                student_id INTEGER NOT NULL,\n                course_id INTEGER NOT NULL,\n                status TEXT NOT NULL DEFAULT 'pending',\n                payment_screenshot TEXT,\n                enrolled_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                approved_at TIMESTAMP,\n                progress_percentage REAL DEFAULT 0,\n                FOREIGN KEY (student_id) REFERENCES users (id),\n                FOREIGN KEY (course_id) REFERENCES courses (id),\n                UNIQUE(student_id, course_id)\n            )\n        ''')\n        \n        # Assignments table\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS assignments (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                course_id INTEGER NOT NULL,\n                title TEXT NOT NULL,\n                description TEXT,\n                instructions TEXT,\n                due_date DATETIME,\n                max_points INTEGER DEFAULT 100,\n                allow_late_submission BOOLEAN DEFAULT 0,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                FOREIGN KEY (course_id) REFERENCES courses (id)\n            )\n        ''')\n        \n        # Assignment submissions table\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS assignment_submissions (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                assignment_id INTEGER NOT NULL,\n                student_id INTEGER NOT NULL,\n                submission_text TEXT,\n                file_path TEXT,\n                submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                grade REAL,\n                ai_feedback TEXT,\n                instructor_feedback TEXT,\n                graded_at TIMESTAMP,\n                FOREIGN KEY (assignment_id) REFERENCES assignments (id),\n                FOREIGN KEY (student_id) REFERENCES users (id),\n                UNIQUE(assignment_id, student_id)\n            )\n        ''')\n        \n        # Quiz questions table for MCQ\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS quiz_questions (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                assignment_id INTEGER NOT NULL,\n                question_text TEXT NOT NULL,\n                question_type TEXT NOT NULL DEFAULT 'mcq',\n                points INTEGER DEFAULT 1,\n                correct_answer TEXT,\n                explanation TEXT,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                FOREIGN KEY (assignment_id) REFERENCES assignments (id)\n            )\n        ''')\n        \n        # Question options table for ABCD choices\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS question_options (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                question_id INTEGER NOT NULL,\n                option_letter TEXT NOT NULL,\n                option_text TEXT NOT NULL,\n                is_correct BOOLEAN DEFAULT 0,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                FOREIGN KEY (question_id) REFERENCES quiz_questions (id)\n            )\n        ''')\n        \n        # Student MCQ answers table\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS student_mcq_answers (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                submission_id INTEGER NOT NULL,\n                question_id INTEGER NOT NULL,\n                selected_option TEXT,\n                is_correct BOOLEAN,\n                points_earned REAL DEFAULT 0,\n                answered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                FOREIGN KEY (submission_id) REFERENCES assignment_submissions (id),\n                FOREIGN KEY (question_id) REFERENCES quiz_questions (id),\n                UNIQUE(submission_id, question_id)\n            )\n        ''')\n        \n        # Forums table\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS forums (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                course_id INTEGER NOT NULL,\n                title TEXT NOT NULL,\n                description TEXT,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                is_active BOOLEAN DEFAULT 1,\n                FOREIGN KEY (course_id) REFERENCES courses (id)\n            )\n        ''')\n        \n        # Forum topics table\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS forum_topics (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                forum_id INTEGER NOT NULL,\n                user_id INTEGER NOT NULL,\n                title TEXT NOT NULL,\n                content TEXT NOT NULL,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                is_pinned BOOLEAN DEFAULT 0,\n                view_count INTEGER DEFAULT 0,\n                FOREIGN KEY (forum_id) REFERENCES forums (id),\n                FOREIGN KEY (user_id) REFERENCES users (id)\n            )\n        ''')\n        \n        # Forum replies table\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS forum_replies (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                topic_id INTEGER NOT NULL,\n                user_id INTEGER NOT NULL,\n                content TEXT NOT NULL,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                is_ai_generated BOOLEAN DEFAULT 0,\n                FOREIGN KEY (topic_id) REFERENCES forum_topics (id),\n                FOREIGN KEY (user_id) REFERENCES users (id)\n            )\n        ''')\n        \n        # Chat messages table\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS chat_messages (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                course_id INTEGER,\n                sender_id INTEGER NOT NULL,\n                recipient_id INTEGER,\n                message TEXT NOT NULL,\n                message_type TEXT DEFAULT 'text',\n                file_path TEXT,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                is_read BOOLEAN DEFAULT 0,\n                FOREIGN KEY (course_id) REFERENCES courses (id),\n                FOREIGN KEY (sender_id) REFERENCES users (id),\n                FOREIGN KEY (recipient_id) REFERENCES users (id)\n            )\n        ''')\n        \n        # Notifications table\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS notifications (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                user_id INTEGER NOT NULL,\n                title TEXT NOT NULL,\n                message TEXT NOT NULL,\n                type TEXT DEFAULT 'info',\n                related_id INTEGER,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                is_read BOOLEAN DEFAULT 0,\n                FOREIGN KEY (user_id) REFERENCES users (id)\n            )\n        ''')\n        \n        # Course resources table\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS course_resources (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                course_id INTEGER NOT NULL,\n                title TEXT NOT NULL,\n                description TEXT,\n                file_path TEXT,\n                file_type TEXT,\n                upload_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                uploaded_by INTEGER NOT NULL,\n                FOREIGN KEY (course_id) REFERENCES courses (id),\n                FOREIGN KEY (uploaded_by) REFERENCES users (id)\n            )\n        ''')\n        \n        # Course meeting links table\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS course_meeting_links (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                course_id INTEGER NOT NULL,\n                title TEXT NOT NULL,\n                meeting_link TEXT NOT NULL,\n                description TEXT,\n                scheduled_time TIMESTAMP,\n                created_by INTEGER NOT NULL,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                is_active BOOLEAN DEFAULT 1,\n                FOREIGN KEY (course_id) REFERENCES courses (id),\n                FOREIGN KEY (created_by) REFERENCES users (id)\n            )\n        ''')\n        \n        # Course video playlists table\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS course_video_playlists (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                course_id INTEGER NOT NULL,\n                title TEXT NOT NULL,\n                video_url TEXT NOT NULL,\n                description TEXT,\n                thumbnail_url TEXT,\n                duration TEXT,\n                notes_file_path TEXT,\n                order_index INTEGER DEFAULT 0,\n                created_by INTEGER NOT NULL,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                is_active BOOLEAN DEFAULT 1,\n                FOREIGN KEY (course_id) REFERENCES courses (id),\n                FOREIGN KEY (created_by) REFERENCES users (id)\n            )\n        ''')\n        \n        # Add notes_file_path column to existing table if it doesn't exist\n        try:\n            conn.execute('ALTER TABLE course_video_playlists ADD COLUMN notes_file_path TEXT')\n        except sqlite3.OperationalError:\n            pass  # Column already exists\n        \n        # Add transcript_file_path column for AI-generated transcripts\n        try:\n            conn.execute('ALTER TABLE course_video_playlists ADD COLUMN transcript_file_path TEXT')\n        except sqlite3.OperationalError:\n            pass  # Column already exists\n        \n        # Create indexes for better performance\n        conn.execute('CREATE INDEX IF NOT EXISTS idx_users_email ON users(email)')\n        conn.execute('CREATE INDEX IF NOT EXISTS idx_users_role ON users(role)')\n        conn.execute('CREATE INDEX IF NOT EXISTS idx_users_approval_status ON users(instructor_approval_status)')\n        conn.execute('CREATE INDEX IF NOT EXISTS idx_enrollments_student ON enrollments(student_id)')\n        conn.execute('CREATE INDEX IF NOT EXISTS idx_enrollments_course ON enrollments(course_id)')\n        conn.execute('CREATE INDEX IF NOT EXISTS idx_assignments_course ON assignments(course_id)')\n        conn.execute('CREATE INDEX IF NOT EXISTS idx_submissions_assignment ON assignment_submissions(assignment_id)')\n        conn.execute('CREATE INDEX IF NOT EXISTS idx_quiz_questions_assignment ON quiz_questions(assignment_id)')\n        conn.execute('CREATE INDEX IF NOT EXISTS idx_question_options_question ON question_options(question_id)')\n        conn.execute('CREATE INDEX IF NOT EXISTS idx_student_answers_submission ON student_mcq_answers(submission_id)')\n        conn.execute('CREATE INDEX IF NOT EXISTS idx_student_answers_question ON student_mcq_answers(question_id)')\n        conn.execute('CREATE INDEX IF NOT EXISTS idx_chat_course ON chat_messages(course_id)')\n        conn.execute('CREATE INDEX IF NOT EXISTS idx_notifications_user ON notifications(user_id)')\n        conn.execute('CREATE INDEX IF NOT EXISTS idx_meeting_links_course ON course_meeting_links(course_id)')\n        conn.execute('CREATE INDEX IF NOT EXISTS idx_video_playlists_course ON course_video_playlists(course_id)')\n        \n        # Create default admin user if not exists\n        admin_exists = conn.execute('SELECT id FROM users WHERE role = \"admin\"').fetchone()\n        if not admin_exists:\n            admin_password = generate_password_hash('admin123')\n            conn.execute('''\n                INSERT INTO users (username, email, password_hash, role, full_name, bio)\n                VALUES (?, ?, ?, ?, ?, ?)\n            ''', ('admin', 'admin@learnnest.com', admin_password, 'admin', \n                 'System Administrator', 'Default system administrator account'))\n        \n        conn.commit()\n        conn.close()\n    \n    print(\"Database initialized successfully!\")\n\n# Routes\n@app.route('/')\ndef index():\n    if current_user.is_authenticated:\n        return redirect(url_for('dashboard'))\n    return redirect(url_for('login'))\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    if current_user.is_authenticated:\n        return redirect(url_for('dashboard'))\n    \n    if request.method == 'POST':\n        # Validate CSRF token\n        csrf_token = request.form.get('csrf_token')\n        if not validate_csrf_token(csrf_token):\n            flash('Invalid security token. Please try again.', 'error')\n            return render_template('auth/login.html')\n            \n        email = request.form['email'].lower().strip()\n        password = request.form['password']\n        remember = bool(request.form.get('remember'))\n        \n        with db_lock:\n            conn = get_db_connection()\n            user = conn.execute(\n                'SELECT * FROM users WHERE email = ? AND is_active = 1', (email,)\n            ).fetchone()\n            conn.close()\n        \n        if user and check_password_hash(user['password_hash'], password):\n            # Update last login\n            with db_lock:\n                conn = get_db_connection()\n                conn.execute(\n                    'UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = ?', (user['id'],)\n                )\n                conn.commit()\n                conn.close()\n            \n            user_obj = User(user['id'], user['username'], user['email'], user['role'], \n                          user['full_name'], user['created_at'], user['is_active'],\n                          user['instructor_approval_status'] if user['instructor_approval_status'] else 'approved',\n                          user['approved_by'],\n                          user['approved_at'])\n            login_user(user_obj, remember=remember)\n            flash(f'Welcome back, {user[\"full_name\"]}!', 'success')\n            \n            next_page = request.args.get('next')\n            return redirect(next_page) if next_page else redirect(url_for('dashboard'))\n        else:\n            flash('Invalid email or password', 'error')\n    \n    return render_template('auth/login.html')\n\n@app.route('/register', methods=['GET', 'POST'])\ndef register():\n    if current_user.is_authenticated:\n        return redirect(url_for('dashboard'))\n    \n    if request.method == 'POST':\n        # Validate CSRF token\n        csrf_token = request.form.get('csrf_token')\n        if not validate_csrf_token(csrf_token):\n            flash('Invalid security token. Please try again.', 'error')\n            return render_template('auth/register.html')\n            \n        username = request.form['username'].strip()\n        email = request.form['email'].lower().strip()\n        password = request.form['password']\n        confirm_password = request.form['confirm_password']\n        full_name = request.form['full_name'].strip()\n        role = request.form.get('role', 'student')\n        \n        # Handle instructor screenshot upload\n        screenshot_filename = None\n        if role == 'instructor' and 'instructor_screenshot' in request.files:\n            screenshot = request.files['instructor_screenshot']\n            if screenshot and screenshot.filename:\n                # Create instructor_screenshots directory if it doesn't exist\n                screenshots_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'instructor_screenshots')\n                os.makedirs(screenshots_dir, exist_ok=True)\n                \n                # Validate file type\n                allowed_extensions = {'png', 'jpg', 'jpeg', 'gif', 'webp'}\n                file_ext = screenshot.filename.rsplit('.', 1)[1].lower() if '.' in screenshot.filename else ''\n                \n                if file_ext not in allowed_extensions:\n                    flash('Invalid file type. Please upload PNG, JPG, JPEG, GIF, or WebP images only.', 'error')\n                    return render_template('auth/register.html')\n                \n                # Validate file size (max 5MB)\n                screenshot.seek(0, 2)  # Seek to end\n                file_size = screenshot.tell()\n                screenshot.seek(0)  # Reset seek position\n                \n                if file_size > 5 * 1024 * 1024:\n                    flash('File size too large. Please upload images smaller than 5MB.', 'error')\n                    return render_template('auth/register.html')\n                \n                # Generate secure filename and save\n                filename = secure_filename(f\"{username}_{datetime.now().strftime('%Y%m%d_%H%M%S')}_{screenshot.filename}\")\n                screenshot_path = os.path.join(screenshots_dir, filename)\n                \n                try:\n                    screenshot.save(screenshot_path)\n                    screenshot_filename = filename\n                except Exception as e:\n                    flash('Error saving screenshot. Please try again.', 'error')\n                    return render_template('auth/register.html')\n        \n        # Validation\n        if password != confirm_password:\n            flash('Passwords do not match', 'error')\n            return render_template('auth/register.html')\n        \n        if len(password) < 6:\n            flash('Password must be at least 6 characters long', 'error')\n            return render_template('auth/register.html')\n        \n        # Validate instructor screenshot\n        if role == 'instructor' and not screenshot_filename:\n            flash('Screenshot upload is required for instructor accounts', 'error')\n            return render_template('auth/register.html')\n        \n        with db_lock:\n            conn = get_db_connection()\n            \n            # Check if user already exists\n            existing_user = conn.execute(\n                'SELECT id FROM users WHERE email = ? OR username = ?', (email, username)\n            ).fetchone()\n            \n            if existing_user:\n                flash('User with this email or username already exists', 'error')\n                conn.close()\n                return render_template('auth/register.html')\n            \n            # Create new user\n            password_hash = generate_password_hash(password)\n            \n            # Set instructor approval status based on role\n            instructor_approval_status = 'pending' if role == 'instructor' else 'approved'\n            \n            conn.execute('''\n                INSERT INTO users (username, email, password_hash, role, full_name, instructor_approval_status, instructor_screenshot)\n                VALUES (?, ?, ?, ?, ?, ?, ?)\n            ''', (username, email, password_hash, role, full_name, instructor_approval_status, screenshot_filename))\n            \n            conn.commit()\n            conn.close()\n        \n        # Flash appropriate message based on role\n        if role == 'instructor':\n            flash('Registration successful! Your instructor account is pending admin approval. You will be notified once approved.', 'info')\n        else:\n            flash('Registration successful! Please log in.', 'success')\n        return redirect(url_for('login'))\n    \n    return render_template('auth/register.html')\n\n@app.route('/logout')\n@login_required\ndef logout():\n    logout_user()\n    flash('You have been logged out successfully.', 'info')\n    return redirect(url_for('login'))\n\n@app.route('/dashboard')\n@login_required\ndef dashboard():\n    with db_lock:\n        conn = get_db_connection()\n        \n        if current_user.is_admin():\n            # Admin dashboard data\n            stats = {\n                'total_users': conn.execute('SELECT COUNT(*) FROM users WHERE is_active = 1').fetchone()[0],\n                'total_courses': conn.execute('SELECT COUNT(*) FROM courses WHERE is_active = 1').fetchone()[0],\n                'total_enrollments': conn.execute('SELECT COUNT(*) FROM enrollments WHERE status = \"approved\"').fetchone()[0],\n                'pending_enrollments': conn.execute('SELECT COUNT(*) FROM enrollments WHERE status = \"pending\"').fetchone()[0],\n                'pending_instructors': conn.execute('SELECT COUNT(*) FROM users WHERE role = \"instructor\" AND instructor_approval_status = \"pending\" AND is_active = 1').fetchone()[0],\n                'total_instructors': conn.execute('SELECT COUNT(*) FROM users WHERE role = \"instructor\" AND is_active = 1').fetchone()[0]\n            }\n            \n            # Recent enrollments\n            recent_enrollments = conn.execute('''\n                SELECT e.*, u.full_name as student_name, c.title as course_title\n                FROM enrollments e\n                JOIN users u ON e.student_id = u.id\n                JOIN courses c ON e.course_id = c.id\n                ORDER BY e.enrolled_at DESC\n                LIMIT 10\n            ''').fetchall()\n            \n            conn.close()\n            return render_template('admin/dashboard.html', stats=stats, recent_enrollments=recent_enrollments)\n        \n        elif current_user.is_instructor() and current_user.is_instructor_approved():\n            # Redirect to dedicated instructor dashboard only if instructor is approved\n            conn.close()\n            return redirect(url_for('instructor_dashboard'))\n        \n        else:\n            # Student dashboard data\n            my_enrollments = conn.execute('''\n                SELECT e.*, c.title, c.course_code, c.description, u.full_name as instructor_name\n                FROM enrollments e\n                JOIN courses c ON e.course_id = c.id\n                JOIN users u ON c.instructor_id = u.id\n                WHERE e.student_id = ?\n                ORDER BY e.enrolled_at DESC\n            ''', (current_user.id,)).fetchall()\n            \n            # Available courses (not enrolled)\n            available_courses = conn.execute('''\n                SELECT c.*, u.full_name as instructor_name\n                FROM courses c\n                JOIN users u ON c.instructor_id = u.id\n                LEFT JOIN enrollments e ON c.id = e.course_id AND e.student_id = ?\n                WHERE c.is_active = 1 AND e.id IS NULL\n                ORDER BY c.created_at DESC\n            ''', (current_user.id,)).fetchall()\n            \n            conn.close()\n            return render_template('student/dashboard.html', enrollments=my_enrollments, available_courses=available_courses)\n\n# Admin instructor management routes\n@app.route('/admin/instructors')\n@admin_required\ndef admin_instructors():\n    \"\"\"Main instructor management page\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get all instructors with their approval status\n        instructors = conn.execute('''\n            SELECT u.*, \n                   (SELECT full_name FROM users WHERE id = u.approved_by) as approved_by_name,\n                   (SELECT COUNT(*) FROM courses WHERE instructor_id = u.id AND is_active = 1) as course_count\n            FROM users u\n            WHERE u.role = 'instructor' AND u.is_active = 1\n            ORDER BY \n                CASE u.instructor_approval_status \n                    WHEN 'pending' THEN 1\n                    WHEN 'rejected' THEN 2\n                    WHEN 'approved' THEN 3\n                END,\n                u.created_at DESC\n        ''').fetchall()\n        \n        # Get counts for stats\n        stats = {\n            'total_instructors': len(instructors),\n            'pending_instructors': len([i for i in instructors if i['instructor_approval_status'] == 'pending']),\n            'approved_instructors': len([i for i in instructors if i['instructor_approval_status'] == 'approved']),\n            'rejected_instructors': len([i for i in instructors if i['instructor_approval_status'] == 'rejected'])\n        }\n        \n        conn.close()\n    \n    return render_template('admin/instructors.html', instructors=instructors, stats=stats)\n\n@app.route('/admin/instructors/pending')\n@admin_required\ndef admin_instructors_pending():\n    \"\"\"View pending instructor applications\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        pending_instructors = conn.execute('''\n            SELECT u.*\n            FROM users u\n            WHERE u.role = 'instructor' \n              AND u.instructor_approval_status = 'pending' \n              AND u.is_active = 1\n            ORDER BY u.created_at ASC\n        ''').fetchall()\n        \n        conn.close()\n    \n    return render_template('admin/instructors.html', \n                         instructors=pending_instructors, \n                         view_type='pending',\n                         stats={'pending_instructors': len(pending_instructors)})\n\n@app.route('/admin/instructors/approve/<int:instructor_id>', methods=['POST'])\n@admin_required\ndef admin_approve_instructor(instructor_id):\n    \"\"\"Approve an instructor\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify instructor exists and is pending\n        instructor = conn.execute('''\n            SELECT * FROM users \n            WHERE id = ? AND role = 'instructor' AND instructor_approval_status = 'pending'\n        ''', (instructor_id,)).fetchone()\n        \n        if not instructor:\n            flash('Instructor not found or already processed.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        # Approve the instructor\n        conn.execute('''\n            UPDATE users \n            SET instructor_approval_status = 'approved',\n                approved_by = ?,\n                approved_at = CURRENT_TIMESTAMP\n            WHERE id = ?\n        ''', (current_user.id, instructor_id))\n        \n        # Create notification for the instructor\n        conn.execute('''\n            INSERT INTO notifications (user_id, title, message, type)\n            VALUES (?, ?, ?, ?)\n        ''', (instructor_id, \n              'Instructor Account Approved',\n              'Congratulations! Your instructor account has been approved. You can now create courses and access all instructor features.',\n              'success'))\n        \n        conn.commit()\n        conn.close()\n    \n    flash(f'Instructor {instructor[\"full_name\"]} has been approved successfully.', 'success')\n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/instructors/reject/<int:instructor_id>', methods=['POST'])\n@admin_required\ndef admin_reject_instructor(instructor_id):\n    \"\"\"Reject an instructor\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify instructor exists and is pending\n        instructor = conn.execute('''\n            SELECT * FROM users \n            WHERE id = ? AND role = 'instructor' AND instructor_approval_status = 'pending'\n        ''', (instructor_id,)).fetchone()\n        \n        if not instructor:\n            flash('Instructor not found or already processed.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        # Reject the instructor\n        conn.execute('''\n            UPDATE users \n            SET instructor_approval_status = 'rejected',\n                approved_by = ?,\n                approved_at = CURRENT_TIMESTAMP\n            WHERE id = ?\n        ''', (current_user.id, instructor_id))\n        \n        # Create notification for the instructor\n        conn.execute('''\n            INSERT INTO notifications (user_id, title, message, type)\n            VALUES (?, ?, ?, ?)\n        ''', (instructor_id,\n              'Instructor Application Rejected',\n              'We regret to inform you that your instructor application has been rejected. Please contact the administrator for more information.',\n              'error'))\n        \n        conn.commit()\n        conn.close()\n    \n    flash(f'Instructor {instructor[\"full_name\"]} has been rejected.', 'warning')\n    return redirect(url_for('admin_instructors'))\n\n# INSTRUCTOR ROUTES\n@app.route('/instructor/dashboard')\n@instructor_required\ndef instructor_dashboard():\n    \"\"\"Enhanced instructor dashboard with course management\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # My courses\n        my_courses = conn.execute('''\n            SELECT c.*, \n                   COUNT(CASE WHEN e.status = 'approved' THEN 1 END) as approved_count,\n                   COUNT(CASE WHEN e.status = 'pending' THEN 1 END) as pending_count,\n                   COUNT(e.id) as total_enrollments\n            FROM courses c\n            LEFT JOIN enrollments e ON c.id = e.course_id\n            WHERE c.instructor_id = ? AND c.is_active = 1\n            GROUP BY c.id\n            ORDER BY c.created_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Pending enrollments for all my courses\n        pending_enrollments = conn.execute('''\n            SELECT e.*, u.full_name as student_name, u.email as student_email, \n                   c.title as course_title, c.course_code\n            FROM enrollments e\n            JOIN users u ON e.student_id = u.id\n            JOIN courses c ON e.course_id = c.id\n            WHERE c.instructor_id = ? AND e.status = 'pending'\n            ORDER BY e.enrolled_at ASC\n        ''', (current_user.id,)).fetchall()\n        \n        # Statistics\n        stats = {\n            'total_courses': len(my_courses),\n            'total_students': sum([course['approved_count'] for course in my_courses]),\n            'pending_enrollments': len(pending_enrollments),\n            'active_courses': len([c for c in my_courses if c['approved_count'] > 0])\n        }\n        \n        conn.close()\n    \n    return render_template('instructor/dashboard.html', \n                         courses=my_courses, \n                         pending_enrollments=pending_enrollments,\n                         stats=stats)\n\n@app.route('/instructor/courses')\n@instructor_required\ndef instructor_courses():\n    \"\"\"View and manage all instructor courses\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        courses = conn.execute('''\n            SELECT c.*, \n                   COUNT(CASE WHEN e.status = 'approved' THEN 1 END) as approved_count,\n                   COUNT(CASE WHEN e.status = 'pending' THEN 1 END) as pending_count\n            FROM courses c\n            LEFT JOIN enrollments e ON c.id = e.course_id\n            WHERE c.instructor_id = ? AND c.is_active = 1\n            GROUP BY c.id\n            ORDER BY c.created_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/courses.html', courses=courses)\n\n@app.route('/instructor/courses/create', methods=['GET', 'POST'])\n@instructor_required\ndef instructor_create_course():\n    \"\"\"Create a new course with enrollment key\"\"\"\n    if request.method == 'POST':\n        course_code = request.form['course_code'].strip().upper()\n        title = request.form['title'].strip()\n        description = request.form.get('description', '').strip()\n        syllabus = request.form.get('syllabus', '').strip()\n        category = request.form.get('category', '').strip()\n        max_students = int(request.form.get('max_students', 50))\n        start_date = request.form.get('start_date') or None\n        end_date = request.form.get('end_date') or None\n        enrollment_key = request.form['enrollment_key'].strip()\n        \n        # Validate enrollment key\n        if len(enrollment_key) < 6:\n            flash('Enrollment key must be at least 6 characters long.', 'error')\n            return render_template('instructor/create_course.html')\n        \n        # Hash the enrollment key for security\n        enrollment_key_hash = generate_password_hash(enrollment_key)\n        \n        with db_lock:\n            conn = get_db_connection()\n            \n            # Check if course code already exists\n            existing_course = conn.execute(\n                'SELECT id FROM courses WHERE course_code = ?', (course_code,)\n            ).fetchone()\n            \n            if existing_course:\n                flash('Course code already exists. Please choose a different one.', 'error')\n                conn.close()\n                return render_template('instructor/create_course.html')\n            \n            try:\n                conn.execute('''\n                    INSERT INTO courses (\n                        course_code, title, description, syllabus, instructor_id, \n                        category, max_students, start_date, end_date, enrollment_key_hash\n                    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n                ''', (course_code, title, description, syllabus, current_user.id,\n                     category, max_students, start_date, end_date, enrollment_key_hash))\n                \n                conn.commit()\n                conn.close()\n                \n                flash(f'Course \"{title}\" created successfully!', 'success')\n                return redirect(url_for('instructor_courses'))\n                \n            except Exception as e:\n                conn.rollback()\n                conn.close()\n                flash('Error creating course. Please try again.', 'error')\n    \n    return render_template('instructor/create_course.html')\n\n@app.route('/instructor/courses/edit/<int:course_id>', methods=['GET', 'POST'])\n@instructor_required\ndef instructor_edit_course(course_id):\n    \"\"\"Edit an existing course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to current instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        if request.method == 'POST':\n            title = request.form['title'].strip()\n            description = request.form.get('description', '').strip()\n            syllabus = request.form.get('syllabus', '').strip()\n            category = request.form.get('category', '').strip()\n            max_students = int(request.form.get('max_students', 50))\n            start_date = request.form.get('start_date') or None\n            end_date = request.form.get('end_date') or None\n            \n            # Handle enrollment key update\n            enrollment_key = request.form.get('enrollment_key', '').strip()\n            if enrollment_key:\n                if len(enrollment_key) < 6:\n                    flash('Enrollment key must be at least 6 characters long.', 'error')\n                    conn.close()\n                    return render_template('instructor/edit_course.html', course=course)\n                enrollment_key_hash = generate_password_hash(enrollment_key)\n            else:\n                enrollment_key_hash = course['enrollment_key_hash']  # Keep existing\n            \n            try:\n                conn.execute('''\n                    UPDATE courses \n                    SET title = ?, description = ?, syllabus = ?, category = ?, \n                        max_students = ?, start_date = ?, end_date = ?, enrollment_key_hash = ?\n                    WHERE id = ?\n                ''', (title, description, syllabus, category, max_students, \n                     start_date, end_date, enrollment_key_hash, course_id))\n                \n                conn.commit()\n                conn.close()\n                \n                flash(f'Course \"{title}\" updated successfully!', 'success')\n                return redirect(url_for('instructor_courses'))\n                \n            except Exception as e:\n                conn.rollback()\n                conn.close()\n                flash('Error updating course. Please try again.', 'error')\n        \n        conn.close()\n    \n    return render_template('instructor/edit_course.html', course=course)\n\n@app.route('/instructor/enrollments')\n@instructor_required \ndef instructor_enrollments():\n    \"\"\"View all student enrollments for instructor's courses\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        enrollments = conn.execute('''\n            SELECT e.*, u.full_name as student_name, u.email as student_email,\n                   c.title as course_title, c.course_code\n            FROM enrollments e\n            JOIN users u ON e.student_id = u.id\n            JOIN courses c ON e.course_id = c.id\n            WHERE c.instructor_id = ?\n            ORDER BY \n                CASE e.status \n                    WHEN 'pending' THEN 1\n                    WHEN 'approved' THEN 2\n                    WHEN 'rejected' THEN 3\n                END,\n                e.enrolled_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Statistics\n        stats = {\n            'total_enrollments': len(enrollments),\n            'pending_enrollments': len([e for e in enrollments if e['status'] == 'pending']),\n            'approved_enrollments': len([e for e in enrollments if e['status'] == 'approved']),\n            'rejected_enrollments': len([e for e in enrollments if e['status'] == 'rejected'])\n        }\n        \n        conn.close()\n    \n    return render_template('instructor/enrollments.html', enrollments=enrollments, stats=stats)\n\n@app.route('/instructor/enrollments/approve/<int:enrollment_id>', methods=['POST'])\n@instructor_required\ndef instructor_approve_enrollment(enrollment_id):\n    \"\"\"Approve a student enrollment\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify enrollment belongs to instructor's course and is pending\n        enrollment = conn.execute('''\n            SELECT e.*, c.title as course_title, u.full_name as student_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON e.student_id = u.id\n            WHERE e.id = ? AND c.instructor_id = ? AND e.status = 'pending'\n        ''', (enrollment_id, current_user.id)).fetchone()\n        \n        if not enrollment:\n            flash('Enrollment not found or already processed.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_enrollments'))\n        \n        try:\n            # Approve the enrollment\n            conn.execute('''\n                UPDATE enrollments \n                SET status = 'approved', approved_at = CURRENT_TIMESTAMP\n                WHERE id = ?\n            ''', (enrollment_id,))\n            \n            # Create notification for the student\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (enrollment['student_id'],\n                  'Enrollment Approved',\n                  f'Great news! Your enrollment in \"{enrollment[\"course_title\"]}\" has been approved. You now have full access to the course.',\n                  'success',\n                  enrollment['course_id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Approved enrollment for {enrollment[\"student_name\"]} in {enrollment[\"course_title\"]}.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error approving enrollment. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_enrollments'))\n\n@app.route('/instructor/enrollments/reject/<int:enrollment_id>', methods=['POST'])\n@instructor_required\ndef instructor_reject_enrollment(enrollment_id):\n    \"\"\"Reject a student enrollment\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify enrollment belongs to instructor's course and is pending\n        enrollment = conn.execute('''\n            SELECT e.*, c.title as course_title, u.full_name as student_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON e.student_id = u.id\n            WHERE e.id = ? AND c.instructor_id = ? AND e.status = 'pending'\n        ''', (enrollment_id, current_user.id)).fetchone()\n        \n        if not enrollment:\n            flash('Enrollment not found or already processed.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_enrollments'))\n        \n        try:\n            # Reject the enrollment\n            conn.execute('''\n                UPDATE enrollments \n                SET status = 'rejected'\n                WHERE id = ?\n            ''', (enrollment_id,))\n            \n            # Create notification for the student\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (enrollment['student_id'],\n                  'Enrollment Not Approved',\n                  f'Your enrollment request for \"{enrollment[\"course_title\"]}\" was not approved. Please contact the instructor for more information.',\n                  'warning',\n                  enrollment['course_id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Rejected enrollment for {enrollment[\"student_name\"]} in {enrollment[\"course_title\"]}.', 'warning')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error rejecting enrollment. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_enrollments'))\n\n# COURSE CONTENT MANAGEMENT ROUTES\n@app.route('/instructor/courses/<int:course_id>/content')\n@instructor_required\ndef instructor_course_content(course_id):\n    \"\"\"Manage course content - videos, notes, resources\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get course resources\n        resources = conn.execute('''\n            SELECT * FROM course_resources \n            WHERE course_id = ?\n            ORDER BY upload_date DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get meeting links\n        meeting_links = conn.execute('''\n            SELECT * FROM course_meeting_links \n            WHERE course_id = ? AND is_active = 1\n            ORDER BY created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get video playlist\n        video_playlist = conn.execute('''\n            SELECT * FROM course_video_playlists \n            WHERE course_id = ? AND is_active = 1\n            ORDER BY order_index ASC\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/course_content.html', course=course, resources=resources, \n                         meeting_links=meeting_links, video_playlist=video_playlist)\n\n@app.route('/instructor/courses/<int:course_id>/content/upload', methods=['POST'])\n@instructor_required\ndef instructor_upload_content(course_id):\n    \"\"\"Upload course content - videos, notes, resources\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        description = request.form.get('description', '').strip()\n        content_type = request.form.get('content_type', 'document')\n        \n        if 'file' in request.files:\n            file = request.files['file']\n            if file and file.filename:\n                filename = secure_filename(file.filename)\n                file_path = os.path.join(app.config['UPLOAD_FOLDER'], 'resources', f\"{course_id}_{uuid.uuid4().hex}_{filename}\")\n                file.save(file_path)\n                \n                try:\n                    conn.execute('''\n                        INSERT INTO course_resources (course_id, title, description, file_path, file_type, uploaded_by)\n                        VALUES (?, ?, ?, ?, ?, ?)\n                    ''', (course_id, title, description, file_path, content_type, current_user.id))\n                    \n                    conn.commit()\n                    flash(f'Content \"{title}\" uploaded successfully!', 'success')\n                    \n                except Exception as e:\n                    conn.rollback()\n                    flash('Error uploading content. Please try again.', 'error')\n        else:\n            flash('No file selected for upload.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n# MEETING LINKS MANAGEMENT ROUTES\n@app.route('/instructor/courses/<int:course_id>/meeting-links/add', methods=['POST'])\n@instructor_required\ndef instructor_add_meeting_link(course_id):\n    \"\"\"Add a meeting link to the course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        meeting_link = request.form.get('meeting_link', '').strip()\n        description = request.form.get('description', '').strip()\n        scheduled_time = request.form.get('scheduled_time') or None\n        \n        if not title or not meeting_link:\n            flash('Meeting title and link are required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_content', course_id=course_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO course_meeting_links (course_id, title, meeting_link, description, scheduled_time, created_by)\n                VALUES (?, ?, ?, ?, ?, ?)\n            ''', (course_id, title, meeting_link, description, scheduled_time, current_user.id))\n            \n            conn.commit()\n            flash(f'Meeting link \"{title}\" added successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error adding meeting link. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n@app.route('/instructor/courses/<int:course_id>/meeting-links/<int:link_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_meeting_link(course_id, link_id):\n    \"\"\"Delete a meeting link\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        try:\n            conn.execute('''\n                DELETE FROM course_meeting_links \n                WHERE id = ? AND course_id = ? AND created_by = ?\n            ''', (link_id, course_id, current_user.id))\n            \n            conn.commit()\n            flash('Meeting link deleted successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error deleting meeting link. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n# VIDEO PLAYLIST MANAGEMENT ROUTES\n@app.route('/instructor/courses/<int:course_id>/video-playlist/add', methods=['POST'])\n@instructor_required\ndef instructor_add_video_playlist(course_id):\n    \"\"\"Add a video to the course playlist\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        video_url = request.form.get('video_url', '').strip()\n        description = request.form.get('description', '').strip()\n        duration = request.form.get('duration', '').strip()\n        thumbnail_url = request.form.get('thumbnail_url', '').strip()\n        \n        if not title or not video_url:\n            flash('Video title and URL are required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_content', course_id=course_id))\n        \n        # Handle notes file upload with validation\n        notes_file_path = None\n        ALLOWED_NOTES_EXTENSIONS = {'pdf', 'doc', 'docx', 'txt', 'ppt', 'pptx', 'odt', 'rtf'}\n        MAX_NOTES_SIZE = 50 * 1024 * 1024  # 50MB\n        \n        if 'notes_file' in request.files:\n            notes_file = request.files['notes_file']\n            if notes_file and notes_file.filename:\n                filename = secure_filename(notes_file.filename)\n                file_ext = filename.rsplit('.', 1)[1].lower() if '.' in filename else ''\n                \n                # Validate file extension\n                if file_ext not in ALLOWED_NOTES_EXTENSIONS:\n                    flash(f'Invalid file type. Allowed: {\", \".join(ALLOWED_NOTES_EXTENSIONS)}', 'error')\n                    conn.close()\n                    return redirect(url_for('instructor_course_content', course_id=course_id))\n                \n                # Check file size\n                notes_file.seek(0, 2)  # Seek to end\n                file_size = notes_file.tell()\n                notes_file.seek(0)  # Reset to beginning\n                \n                if file_size > MAX_NOTES_SIZE:\n                    flash('Notes file too large. Maximum size is 50MB.', 'error')\n                    conn.close()\n                    return redirect(url_for('instructor_course_content', course_id=course_id))\n                \n                # Save the file\n                notes_file_path = os.path.join(app.config['UPLOAD_FOLDER'], 'resources', f\"notes_{course_id}_{uuid.uuid4().hex}_{filename}\")\n                os.makedirs(os.path.dirname(notes_file_path), exist_ok=True)\n                notes_file.save(notes_file_path)\n        \n        try:\n            # Get the next order index\n            max_order = conn.execute('''\n                SELECT MAX(order_index) FROM course_video_playlists \n                WHERE course_id = ?\n            ''', (course_id,)).fetchone()[0]\n            \n            next_order = (max_order or 0) + 1\n            \n            conn.execute('''\n                INSERT INTO course_video_playlists (course_id, title, video_url, description, duration, thumbnail_url, notes_file_path, order_index, created_by)\n                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n            ''', (course_id, title, video_url, description, duration, thumbnail_url, notes_file_path, next_order, current_user.id))\n            \n            conn.commit()\n            flash(f'Video \"{title}\" added to playlist successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error adding video to playlist. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n@app.route('/download-notes/<int:video_id>')\n@login_required\ndef download_video_notes(video_id):\n    \"\"\"Download notes for a video\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id \n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video or not video['notes_file_path']:\n            conn.close()\n            flash('Notes not found.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                flash('Access denied.', 'error')\n                return redirect(url_for('dashboard'))\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            flash('Access denied.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        stored_path = video['notes_file_path']\n        conn.close()\n        \n        # Try to find the actual file - handle incorrect paths from different systems\n        file_path = None\n        filename = os.path.basename(stored_path)\n        \n        # Try multiple possible locations\n        possible_paths = [\n            stored_path,  # Original path\n            os.path.join(app.config['UPLOAD_FOLDER'], 'resources', filename),  # Current system path\n            os.path.join('sir_rafique', 'uploads', 'resources', filename),  # Relative path\n        ]\n        \n        for path in possible_paths:\n            if os.path.exists(path):\n                file_path = path\n                break\n        \n        if not file_path:\n            logging.error(f\"Notes file not found. Tried paths: {possible_paths}\")\n            flash('Notes file not found on server. Please contact your instructor.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Send the file\n        try:\n            directory = os.path.dirname(file_path)\n            filename = os.path.basename(file_path)\n            \n            # Get original extension for proper MIME type\n            file_ext = filename.rsplit('.', 1)[1].lower() if '.' in filename else 'pdf'\n            mime_types = {\n                'pdf': 'application/pdf',\n                'doc': 'application/msword',\n                'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n                'txt': 'text/plain',\n                'ppt': 'application/vnd.ms-powerpoint',\n                'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation'\n            }\n            \n            return send_from_directory(\n                directory, \n                filename, \n                as_attachment=True,\n                mimetype=mime_types.get(file_ext, 'application/octet-stream')\n            )\n        except Exception as e:\n            logging.error(f\"Error downloading notes: {e}\")\n            flash('Unable to download notes. Please try again.', 'error')\n            return redirect(url_for('dashboard'))\n\n@app.route('/instructor/courses/<int:course_id>/video-playlist/<int:video_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_video_playlist(course_id, video_id):\n    \"\"\"Delete a video from playlist\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        try:\n            conn.execute('''\n                DELETE FROM course_video_playlists \n                WHERE id = ? AND course_id = ? AND created_by = ?\n            ''', (video_id, course_id, current_user.id))\n            \n            conn.commit()\n            flash('Video deleted from playlist successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error deleting video. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n@app.route('/generate-transcript/<int:video_id>', methods=['POST'])\n@login_required\ndef generate_video_transcript(video_id):\n    \"\"\"Generate AI transcript for a video and save as PDF with watermark\"\"\"\n    from utils.pdf_generator import generate_transcript_pdf\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id, c.title as course_title, c.course_code\n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Video not found.'}), 404\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Access denied.'}), 403\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Access denied.'}), 403\n        \n        try:\n            # Generate transcript using Gemini AI from actual YouTube video\n            transcript_text = gemini_ai.generate_video_transcript(\n                video['title'],\n                video['description'] or '',\n                video['duration'] or '',\n                video['video_url'] or ''\n            )\n            \n            # Generate PDF filename\n            safe_filename = secure_filename(video['title'])\n            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n            pdf_filename = f\"transcript_{video_id}_{timestamp}.pdf\"\n            transcript_folder = os.path.join(app.config['UPLOAD_FOLDER'], 'transcripts')\n            os.makedirs(transcript_folder, exist_ok=True)\n            pdf_path = os.path.join(transcript_folder, pdf_filename)\n            \n            # Generate PDF with watermark\n            success = generate_transcript_pdf(\n                transcript_text=transcript_text,\n                video_title=video['title'],\n                course_name=f\"{video['course_code']} - {video['course_title']}\",\n                student_name=current_user.full_name,\n                output_path=pdf_path\n            )\n            \n            if success:\n                # Save relative path to database (not absolute)\n                relative_path = os.path.join('sir_rafique', 'uploads', 'transcripts', pdf_filename)\n                \n                # Update database with transcript path\n                conn.execute('''\n                    UPDATE course_video_playlists \n                    SET transcript_file_path = ?\n                    WHERE id = ?\n                ''', (relative_path, video_id))\n                conn.commit()\n                conn.close()\n                \n                return jsonify({\n                    'success': True,\n                    'message': 'Transcript generated successfully!',\n                    'download_url': url_for('download_video_transcript', video_id=video_id)\n                })\n            else:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Error generating PDF.'}), 500\n                \n        except Exception as e:\n            conn.close()\n            logging.error(f\"Error generating transcript: {e}\")\n            return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500\n\n@app.route('/download-transcript/<int:video_id>')\n@login_required\ndef download_video_transcript(video_id):\n    \"\"\"Download AI-generated transcript PDF for a video\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id \n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video or not video['transcript_file_path']:\n            conn.close()\n            flash('Transcript not found. Please generate it first.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                flash('Access denied.', 'error')\n                return redirect(url_for('dashboard'))\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            flash('Access denied.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        stored_path = video['transcript_file_path']\n        conn.close()\n        \n        # Try to find the actual file - handle incorrect paths from different systems\n        file_path = None\n        filename = os.path.basename(stored_path)\n        \n        # Try multiple possible locations\n        possible_paths = [\n            stored_path,  # Original path\n            os.path.join(app.config['UPLOAD_FOLDER'], 'transcripts', filename),  # Current system path\n            os.path.join('sir_rafique', 'uploads', 'transcripts', filename),  # Relative path\n        ]\n        \n        for path in possible_paths:\n            if os.path.exists(path):\n                file_path = path\n                break\n        \n        if not file_path:\n            logging.error(f\"Transcript file not found. Tried paths: {possible_paths}\")\n            flash('Transcript file not found. Please generate it again.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Send the transcript PDF file\n        try:\n            directory = os.path.dirname(file_path)\n            filename = os.path.basename(file_path)\n            \n            # Create a clean download filename\n            safe_title = \"\".join(c for c in video['title'] if c.isalnum() or c in (' ', '-', '_')).rstrip()\n            download_filename = f\"transcript_{safe_title}.pdf\"\n            \n            return send_from_directory(\n                directory, \n                filename, \n                as_attachment=True, \n                download_name=download_filename,\n                mimetype='application/pdf'\n            )\n        except Exception as e:\n            logging.error(f\"Error downloading transcript: {e}\")\n            flash(f'Unable to download transcript. Please try again.', 'error')\n            return redirect(url_for('dashboard'))\n\n# QUIZ SYSTEM ROUTES\n@app.route('/instructor/courses/<int:course_id>/quizzes')\n@instructor_required\ndef instructor_course_quizzes(course_id):\n    \"\"\"Manage course quizzes\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get quizzes (using assignments table)\n        quizzes = conn.execute('''\n            SELECT a.*, COUNT(s.id) as submission_count\n            FROM assignments a\n            LEFT JOIN assignment_submissions s ON a.id = s.assignment_id\n            WHERE a.course_id = ?\n            GROUP BY a.id\n            ORDER BY a.created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/course_quizzes.html', course=course, quizzes=quizzes)\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/create', methods=['GET', 'POST'])\n@instructor_required\ndef instructor_create_quiz(course_id):\n    \"\"\"Create a new quiz\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        if request.method == 'POST':\n            # Validate CSRF token\n            csrf_token = request.form.get('csrf_token')\n            if not validate_csrf_token(csrf_token):\n                flash('Invalid security token. Please try again.', 'error')\n                conn.close()\n                return redirect(url_for('instructor_create_quiz', course_id=course_id))\n            \n            title = request.form.get('title', '').strip()\n            description = request.form.get('description', '').strip()\n            instructions = request.form.get('instructions', '').strip()\n            due_date = request.form.get('due_date') or None\n            max_points = int(request.form.get('max_points', 100))\n            \n            try:\n                # Create the quiz/assignment\n                cursor = conn.execute('''\n                    INSERT INTO assignments (course_id, title, description, instructions, due_date, max_points)\n                    VALUES (?, ?, ?, ?, ?, ?)\n                ''', (course_id, title, description, instructions, due_date, max_points))\n                \n                assignment_id = cursor.lastrowid\n                total_points = 0\n                \n                # Process MCQ questions\n                questions_data = {}\n                for key in request.form.keys():\n                    if key.startswith('questions[') and '][text]' in key:\n                        # Extract question number\n                        question_num = key.split('[')[1].split(']')[0]\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        questions_data[question_num]['text'] = request.form.get(key, '').strip()\n                    elif key.startswith('questions[') and '][correct]' in key:\n                        question_num = key.split('[')[1].split(']')[0]\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        questions_data[question_num]['correct'] = request.form.get(key)\n                    elif key.startswith('questions[') and '][explanation]' in key:\n                        question_num = key.split('[')[1].split(']')[0]\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        questions_data[question_num]['explanation'] = request.form.get(key, '').strip()\n                    elif key.startswith('questions[') and '][points]' in key:\n                        question_num = key.split('[')[1].split(']')[0]\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        questions_data[question_num]['points'] = int(request.form.get(key, 1))\n                    elif key.startswith('questions[') and '][option_' in key:\n                        question_num = key.split('[')[1].split(']')[0]\n                        option_letter = key.split('option_')[1].split(']')[0].upper()\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        if 'options' not in questions_data[question_num]:\n                            questions_data[question_num]['options'] = {}\n                        questions_data[question_num]['options'][option_letter] = request.form.get(key, '').strip()\n                \n                # Save questions and options\n                for question_num, question_data in questions_data.items():\n                    if 'text' in question_data and question_data['text']:\n                        # NEW FEATURE: AI AUTO-CORRECTION\n                        # Use Gemini AI to determine correct answer instead of instructor selecting it\n                        options = question_data.get('options', {})\n                        if options:\n                            ai_correct_answer = gemini_ai.determine_correct_answer(question_data['text'], options)\n                        else:\n                            ai_correct_answer = 'A'  # Fallback\n                        \n                        # Insert question with AI-determined correct answer\n                        cursor = conn.execute('''\n                            INSERT INTO quiz_questions (assignment_id, question_text, question_type, points, correct_answer, explanation)\n                            VALUES (?, ?, 'mcq', ?, ?, ?)\n                        ''', (assignment_id, question_data['text'], question_data.get('points', 1), \n                             ai_correct_answer, question_data.get('explanation', '')))\n                        \n                        question_id = cursor.lastrowid\n                        total_points += question_data.get('points', 1)\n                        \n                        # Insert options with AI-determined correct answer\n                        for option_letter, option_text in question_data.get('options', {}).items():\n                            if option_text:\n                                is_correct = (option_letter == ai_correct_answer)\n                                conn.execute('''\n                                    INSERT INTO question_options (question_id, option_letter, option_text, is_correct)\n                                    VALUES (?, ?, ?, ?)\n                                ''', (question_id, option_letter, option_text, is_correct))\n                \n                # Update assignment with calculated total points\n                conn.execute('''\n                    UPDATE assignments SET max_points = ? WHERE id = ?\n                ''', (total_points, assignment_id))\n                \n                conn.commit()\n                flash(f'MCQ Quiz \"{title}\" created successfully with {len(questions_data)} questions!', 'success')\n                return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n                \n            except Exception as e:\n                conn.rollback()\n                flash('Error creating quiz. Please try again.', 'error')\n        \n        conn.close()\n    \n    return render_template('instructor/create_quiz.html', course=course)\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/<int:quiz_id>/results')\n@instructor_required\ndef instructor_quiz_results(course_id, quiz_id):\n    \"\"\"View quiz results and submissions\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course ownership and quiz\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            WHERE a.id = ? AND a.course_id = ? AND c.instructor_id = ?\n        ''', (quiz_id, course_id, current_user.id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n        \n        # Get all submissions for this quiz\n        submissions = conn.execute('''\n            SELECT s.*, u.full_name as student_name, u.username\n            FROM assignment_submissions s\n            JOIN users u ON s.student_id = u.id\n            WHERE s.assignment_id = ?\n            ORDER BY s.submitted_at DESC\n        ''', (quiz_id,)).fetchall()\n        \n        # Get basic stats\n        stats = {\n            'total_submissions': len(submissions),\n            'graded_count': len([s for s in submissions if s['grade'] is not None]),\n            'average_grade': sum(s['grade'] for s in submissions if s['grade'] is not None) / max(1, len([s for s in submissions if s['grade'] is not None])) if submissions else 0\n        }\n        \n        conn.close()\n    \n    return render_template('instructor/quiz_results.html', quiz=quiz, submissions=submissions, stats=stats)\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/<int:quiz_id>/edit', methods=['GET', 'POST'])\n@instructor_required\ndef instructor_edit_quiz(course_id, quiz_id):\n    \"\"\"Edit existing quiz\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course ownership and quiz\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            WHERE a.id = ? AND a.course_id = ? AND c.instructor_id = ?\n        ''', (quiz_id, course_id, current_user.id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n        \n        if request.method == 'POST':\n            title = request.form.get('title', '').strip()\n            description = request.form.get('description', '').strip()\n            instructions = request.form.get('instructions', '').strip()\n            due_date = request.form.get('due_date') or None\n            max_points = int(request.form.get('max_points', 100))\n            \n            try:\n                conn.execute('''\n                    UPDATE assignments \n                    SET title = ?, description = ?, instructions = ?, due_date = ?, max_points = ?\n                    WHERE id = ?\n                ''', (title, description, instructions, due_date, max_points, quiz_id))\n                \n                conn.commit()\n                flash(f'Quiz \"{title}\" updated successfully!', 'success')\n                return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n                \n            except Exception as e:\n                conn.rollback()\n                flash('Error updating quiz. Please try again.', 'error')\n        \n        conn.close()\n    \n    return render_template('instructor/edit_quiz.html', quiz=quiz)\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/<int:quiz_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_quiz(course_id, quiz_id):\n    \"\"\"Delete a quiz and all associated data\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course ownership and quiz\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            WHERE a.id = ? AND a.course_id = ? AND c.instructor_id = ?\n        ''', (quiz_id, course_id, current_user.id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n        \n        try:\n            # Delete quiz questions first\n            conn.execute('DELETE FROM quiz_questions WHERE assignment_id = ?', (quiz_id,))\n            \n            # Delete student MCQ answers\n            conn.execute('''\n                DELETE FROM student_mcq_answers \n                WHERE submission_id IN (\n                    SELECT id FROM assignment_submissions WHERE assignment_id = ?\n                )\n            ''', (quiz_id,))\n            \n            # Delete submissions\n            conn.execute('DELETE FROM assignment_submissions WHERE assignment_id = ?', (quiz_id,))\n            \n            # Delete the quiz itself\n            conn.execute('DELETE FROM assignments WHERE id = ?', (quiz_id,))\n            \n            conn.commit()\n            flash(f'Quiz \"{quiz[\"title\"]}\" and all associated data deleted successfully.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error deleting quiz. Please try again.', 'error')\n            print(f\"Delete quiz error: {e}\")\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/<int:quiz_id>/analytics')\n@instructor_required\ndef instructor_quiz_analytics(course_id, quiz_id):\n    \"\"\"Basic quiz analytics\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course ownership and quiz\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            WHERE a.id = ? AND a.course_id = ? AND c.instructor_id = ?\n        ''', (quiz_id, course_id, current_user.id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n        \n        # Get enrollment count for completion rate\n        enrolled_students = conn.execute('''\n            SELECT COUNT(*) as count FROM enrollments \n            WHERE course_id = ? AND status = 'approved'\n        ''', (course_id,)).fetchone()['count']\n        \n        # Get submission analytics\n        submissions = conn.execute('''\n            SELECT grade FROM assignment_submissions \n            WHERE assignment_id = ? AND grade IS NOT NULL\n        ''', (quiz_id,)).fetchall()\n        \n        grades = [s['grade'] for s in submissions]\n        analytics = {\n            'enrolled_students': enrolled_students,\n            'submission_count': len(submissions),\n            'completion_rate': (len(submissions) / max(1, enrolled_students)) * 100,\n            'average_grade': sum(grades) / max(1, len(grades)) if grades else 0,\n            'highest_grade': max(grades) if grades else 0,\n            'lowest_grade': min(grades) if grades else 0,\n            'grade_distribution': {\n                'A (90-100)': len([g for g in grades if g >= 90]),\n                'B (80-89)': len([g for g in grades if 80 <= g < 90]),\n                'C (70-79)': len([g for g in grades if 70 <= g < 80]),\n                'D (60-69)': len([g for g in grades if 60 <= g < 70]),\n                'F (0-59)': len([g for g in grades if g < 60])\n            }\n        }\n        \n        conn.close()\n    \n    return render_template('instructor/quiz_analytics.html', quiz=quiz, analytics=analytics)\n\n# DISCUSSION FORUMS ROUTES\n@app.route('/instructor/courses/<int:course_id>/discussions')\n@instructor_required\ndef instructor_course_discussions(course_id):\n    \"\"\"Manage course discussion forums\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get course forums and recent topics\n        forums = conn.execute('''\n            SELECT f.*, COUNT(t.id) as topic_count\n            FROM forums f\n            LEFT JOIN forum_topics t ON f.id = t.forum_id\n            WHERE f.course_id = ? AND f.is_active = 1\n            GROUP BY f.id\n            ORDER BY f.created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get recent forum activity\n        recent_topics = conn.execute('''\n            SELECT t.*, u.full_name as author_name, f.title as forum_title,\n                   COUNT(r.id) as reply_count\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            JOIN forums f ON t.forum_id = f.id\n            LEFT JOIN forum_replies r ON t.id = r.topic_id\n            WHERE f.course_id = ?\n            GROUP BY t.id\n            ORDER BY t.created_at DESC\n            LIMIT 10\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/course_discussions.html', \n                         course=course, forums=forums, recent_topics=recent_topics)\n\n@app.route('/instructor/courses/<int:course_id>/forums/create', methods=['POST'])\n@instructor_required\ndef instructor_create_forum(course_id):\n    \"\"\"Create a new discussion forum\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        description = request.form.get('description', '').strip()\n        \n        if not title:\n            flash('Forum title is required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forums (course_id, title, description)\n                VALUES (?, ?, ?)\n            ''', (course_id, title, description))\n            \n            conn.commit()\n            flash(f'Discussion forum \"{title}\" created successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error creating forum. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_discussions', course_id=course_id))\n\n@app.route('/instructor/courses/<int:course_id>/topics/create', methods=['POST'])\n@instructor_required\ndef instructor_create_topic(course_id):\n    \"\"\"Create a new discussion topic\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        forum_id = request.form.get('forum_id')\n        title = request.form.get('title', '').strip()\n        content = request.form.get('content', '').strip()\n        is_pinned = bool(request.form.get('is_pinned'))\n        \n        if not title or not content or not forum_id:\n            flash('Topic title, content, and forum selection are required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forum_topics (forum_id, user_id, title, content, is_pinned)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (forum_id, current_user.id, title, content, is_pinned))\n            \n            conn.commit()\n            flash(f'Discussion topic \"{title}\" created successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error creating topic. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_discussions', course_id=course_id))\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/topics')\n@instructor_required\ndef instructor_forum_topics(course_id, forum_id):\n    \"\"\"View all topics in a forum\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor or admin\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND (instructor_id = ? OR ? = 1) AND is_active = 1\n        ''', (course_id, current_user.id, current_user.is_admin())).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        # Get all topics in this forum\n        topics = conn.execute('''\n            SELECT t.*, u.full_name as author_name, COUNT(r.id) as reply_count,\n                   MAX(COALESCE(r.created_at, t.created_at)) as last_activity\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            LEFT JOIN forum_replies r ON t.id = r.topic_id\n            WHERE t.forum_id = ?\n            GROUP BY t.id\n            ORDER BY t.is_pinned DESC, last_activity DESC\n        ''', (forum_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/forum_topics.html', \n                         course=course, forum=forum, topics=topics)\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/topics/<int:topic_id>')\n@instructor_required\ndef instructor_topic_detail(course_id, forum_id, topic_id):\n    \"\"\"View topic details with replies\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor or admin\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND (instructor_id = ? OR ? = 1) AND is_active = 1\n        ''', (course_id, current_user.id, current_user.is_admin())).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        # Get topic details\n        topic = conn.execute('''\n            SELECT t.*, u.full_name as author_name, u.role as author_role\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            WHERE t.id = ? AND t.forum_id = ?\n        ''', (topic_id, forum_id)).fetchone()\n        \n        if not topic:\n            flash('Topic not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_forum_topics', course_id=course_id, forum_id=forum_id))\n        \n        # Get replies\n        replies = conn.execute('''\n            SELECT r.*, u.full_name as author_name, u.role as author_role\n            FROM forum_replies r\n            JOIN users u ON r.user_id = u.id\n            WHERE r.topic_id = ?\n            ORDER BY r.created_at ASC\n        ''', (topic_id,)).fetchall()\n        \n        # Update view count\n        conn.execute('UPDATE forum_topics SET view_count = view_count + 1 WHERE id = ?', (topic_id,))\n        conn.commit()\n        \n        conn.close()\n    \n    return render_template('instructor/topic_detail.html', \n                         course=course, forum=forum, topic=topic, replies=replies)\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/edit')\n@instructor_required\ndef instructor_edit_forum(course_id, forum_id):\n    \"\"\"Edit forum form\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get forum details\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        conn.close()\n    \n    return render_template('instructor/edit_forum.html', course=course, forum=forum)\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/update', methods=['POST'])\n@instructor_required\ndef instructor_update_forum(course_id, forum_id):\n    \"\"\"Update forum details\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        description = request.form.get('description', '').strip()\n        \n        if not title:\n            flash('Forum title is required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_edit_forum', course_id=course_id, forum_id=forum_id))\n        \n        try:\n            conn.execute('''\n                UPDATE forums \n                SET title = ?, description = ?\n                WHERE id = ? AND course_id = ?\n            ''', (title, description, forum_id, course_id))\n            \n            conn.commit()\n            flash(f'Forum \"{title}\" updated successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error updating forum. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_discussions', course_id=course_id))\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_forum(course_id, forum_id):\n    \"\"\"Delete forum (soft delete)\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        try:\n            # Soft delete forum\n            conn.execute('''\n                UPDATE forums \n                SET is_active = 0\n                WHERE id = ? AND course_id = ?\n            ''', (forum_id, course_id))\n            \n            conn.commit()\n            flash('Forum deleted successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error deleting forum. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_discussions', course_id=course_id))\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/topics/<int:topic_id>/reply', methods=['POST'])\n@instructor_required\ndef instructor_create_reply(course_id, forum_id, topic_id):\n    \"\"\"Create a reply to a discussion topic\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor or admin\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND (instructor_id = ? OR ? = 1) AND is_active = 1\n        ''', (course_id, current_user.id, current_user.is_admin())).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Verify forum and topic exist\n        topic = conn.execute('''\n            SELECT t.*, f.course_id\n            FROM forum_topics t\n            JOIN forums f ON t.forum_id = f.id\n            WHERE t.id = ? AND t.forum_id = ? AND f.course_id = ? AND f.is_active = 1\n        ''', (topic_id, forum_id, course_id)).fetchone()\n        \n        if not topic:\n            flash('Topic not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        content = request.form.get('content', '').strip()\n        \n        if not content:\n            flash('Reply content is required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_topic_detail', course_id=course_id, forum_id=forum_id, topic_id=topic_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forum_replies (topic_id, user_id, content)\n                VALUES (?, ?, ?)\n            ''', (topic_id, current_user.id, content))\n            \n            conn.commit()\n            flash('Reply posted successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error posting reply. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_topic_detail', course_id=course_id, forum_id=forum_id, topic_id=topic_id))\n\n\n# STUDENT CONTENT ACCESS ROUTES\n@app.route('/student/courses/<int:course_id>')\n@login_required\ndef student_course_view(course_id):\n    \"\"\"View course content as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.*, u.full_name as instructor_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get course content\n        resources = conn.execute('''\n            SELECT * FROM course_resources \n            WHERE course_id = ?\n            ORDER BY upload_date DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get meeting links\n        meeting_links = conn.execute('''\n            SELECT * FROM course_meeting_links \n            WHERE course_id = ? AND is_active = 1\n            ORDER BY created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get video playlist\n        video_playlist = conn.execute('''\n            SELECT * FROM course_video_playlists \n            WHERE course_id = ? AND is_active = 1\n            ORDER BY order_index ASC\n        ''', (course_id,)).fetchall()\n        \n        # Get quizzes\n        quizzes = conn.execute('''\n            SELECT a.*, s.grade, s.submitted_at\n            FROM assignments a\n            LEFT JOIN assignment_submissions s ON a.id = s.assignment_id AND s.student_id = ?\n            WHERE a.course_id = ?\n            ORDER BY a.created_at DESC\n        ''', (current_user.id, course_id)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/course_view.html', \n                         course=enrollment, resources=resources, quizzes=quizzes,\n                         meeting_links=meeting_links, video_playlist=video_playlist)\n\n# STUDENT FORUM ACCESS ROUTES\n@app.route('/student/courses/<int:course_id>/forums')\n@login_required\ndef student_course_forums(course_id):\n    \"\"\"View course forums as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.*, u.full_name as instructor_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get course forums and recent topics\n        forums = conn.execute('''\n            SELECT f.*, COUNT(t.id) as topic_count\n            FROM forums f\n            LEFT JOIN forum_topics t ON f.id = t.forum_id\n            WHERE f.course_id = ? AND f.is_active = 1\n            GROUP BY f.id\n            ORDER BY f.created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get recent forum activity\n        recent_topics = conn.execute('''\n            SELECT t.*, u.full_name as author_name, f.title as forum_title,\n                   COUNT(r.id) as reply_count\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            JOIN forums f ON t.forum_id = f.id\n            LEFT JOIN forum_replies r ON t.id = r.topic_id\n            WHERE f.course_id = ?\n            GROUP BY t.id\n            ORDER BY t.created_at DESC\n            LIMIT 10\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/course_forums.html', \n                         course=enrollment, forums=forums, recent_topics=recent_topics)\n\n@app.route('/student/courses/<int:course_id>/forums/<int:forum_id>/topics')\n@login_required\ndef student_forum_topics(course_id, forum_id):\n    \"\"\"View all topics in a forum as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.*, u.full_name as instructor_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        \n        # Get all topics in this forum\n        topics = conn.execute('''\n            SELECT t.*, u.full_name as author_name, COUNT(r.id) as reply_count,\n                   MAX(COALESCE(r.created_at, t.created_at)) as last_activity\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            LEFT JOIN forum_replies r ON t.id = r.topic_id\n            WHERE t.forum_id = ?\n            GROUP BY t.id\n            ORDER BY t.is_pinned DESC, last_activity DESC\n        ''', (forum_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/forum_topics.html', \n                         course=enrollment, forum=forum, topics=topics)\n\n@app.route('/student/courses/<int:course_id>/forums/<int:forum_id>/topics/<int:topic_id>')\n@login_required\ndef student_topic_detail(course_id, forum_id, topic_id):\n    \"\"\"View topic details with replies as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.*, u.full_name as instructor_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        \n        # Get topic details\n        topic = conn.execute('''\n            SELECT t.*, u.full_name as author_name, u.role as author_role\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            WHERE t.id = ? AND t.forum_id = ?\n        ''', (topic_id, forum_id)).fetchone()\n        \n        if not topic:\n            flash('Topic not found.', 'error')\n            conn.close()\n            return redirect(url_for('student_forum_topics', course_id=course_id, forum_id=forum_id))\n        \n        # Get replies\n        replies = conn.execute('''\n            SELECT r.*, u.full_name as author_name, u.role as author_role\n            FROM forum_replies r\n            JOIN users u ON r.user_id = u.id\n            WHERE r.topic_id = ?\n            ORDER BY r.created_at ASC\n        ''', (topic_id,)).fetchall()\n        \n        # Update view count\n        conn.execute('UPDATE forum_topics SET view_count = view_count + 1 WHERE id = ?', (topic_id,))\n        conn.commit()\n        \n        conn.close()\n    \n    return render_template('student/topic_detail.html', \n                         course=enrollment, forum=forum, topic=topic, replies=replies)\n\n@app.route('/student/courses/<int:course_id>/forums/<int:forum_id>/topics/<int:topic_id>/reply', methods=['POST'])\n@login_required\ndef student_create_reply(course_id, forum_id, topic_id):\n    \"\"\"Create a reply to a discussion topic as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.status FROM enrollments e\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Verify forum and topic exist\n        topic = conn.execute('''\n            SELECT t.*, f.course_id\n            FROM forum_topics t\n            JOIN forums f ON t.forum_id = f.id\n            WHERE t.id = ? AND t.forum_id = ? AND f.course_id = ? AND f.is_active = 1\n        ''', (topic_id, forum_id, course_id)).fetchone()\n        \n        if not topic:\n            flash('Topic not found.', 'error')\n            conn.close()\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        \n        content = request.form.get('content', '').strip()\n        \n        if not content:\n            flash('Reply content is required.', 'error')\n            conn.close()\n            return redirect(url_for('student_topic_detail', course_id=course_id, forum_id=forum_id, topic_id=topic_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forum_replies (topic_id, user_id, content)\n                VALUES (?, ?, ?)\n            ''', (topic_id, current_user.id, content))\n            \n            conn.commit()\n            flash('Reply posted successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error posting reply. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('student_topic_detail', course_id=course_id, forum_id=forum_id, topic_id=topic_id))\n\n@app.route('/student/courses/<int:course_id>/forums/<int:forum_id>/topics/create', methods=['POST'])\n@login_required\ndef student_create_topic(course_id, forum_id):\n    \"\"\"Create a new discussion topic as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.status FROM enrollments e\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        \n        title = request.form.get('title', '').strip()\n        content = request.form.get('content', '').strip()\n        \n        if not title or not content:\n            flash('Topic title and content are required.', 'error')\n            conn.close()\n            return redirect(url_for('student_forum_topics', course_id=course_id, forum_id=forum_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forum_topics (forum_id, user_id, title, content, is_pinned)\n                VALUES (?, ?, ?, ?, 0)\n            ''', (forum_id, current_user.id, title, content))\n            \n            conn.commit()\n            flash(f'Discussion topic \"{title}\" created successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error creating topic. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('student_forum_topics', course_id=course_id, forum_id=forum_id))\n\n@app.route('/uploads/instructor_screenshots/<filename>')\n@login_required\n@admin_required\ndef instructor_screenshot(filename):\n    \"\"\"Serve instructor screenshot files (admin only)\"\"\"\n    screenshots_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'instructor_screenshots')\n    return send_from_directory(screenshots_dir, filename)\n\n@app.route('/student/courses/<int:course_id>/resource/<int:resource_id>')\n@login_required\ndef student_download_resource(course_id, resource_id):\n    \"\"\"Secure file download for enrolled students\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved in the course\n        enrollment = conn.execute('''\n            SELECT e.status FROM enrollments e\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Access denied. You are not enrolled in this course.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get the resource and verify it belongs to this course\n        resource = conn.execute('''\n            SELECT * FROM course_resources \n            WHERE id = ? AND course_id = ?\n        ''', (resource_id, course_id)).fetchone()\n        \n        conn.close()\n        \n        if not resource:\n            flash('Resource not found.', 'error')\n            return redirect(url_for('student_course_view', course_id=course_id))\n        \n        # Serve the file securely\n        try:\n            return send_from_directory(\n                os.path.dirname(resource['file_path']),\n                os.path.basename(resource['file_path']),\n                as_attachment=False\n            )\n        except FileNotFoundError:\n            flash('File not found on server.', 'error')\n            return redirect(url_for('student_course_view', course_id=course_id))\n\n@app.route('/student/quiz/<int:quiz_id>')\n@login_required\ndef student_take_quiz(quiz_id):\n    \"\"\"Take a quiz with MCQ questions\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled in the course\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title, e.status as enrollment_status\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            LEFT JOIN enrollments e ON c.id = e.course_id AND e.student_id = ?\n            WHERE a.id = ? AND e.status = 'approved'\n        ''', (current_user.id, quiz_id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Check if already submitted\n        submission = conn.execute('''\n            SELECT * FROM assignment_submissions \n            WHERE assignment_id = ? AND student_id = ?\n        ''', (quiz_id, current_user.id)).fetchone()\n        \n        # Get MCQ questions and options\n        questions = conn.execute('''\n            SELECT q.*, GROUP_CONCAT(\n                o.option_letter || '|' || o.option_text || '|' || o.is_correct, ':'\n            ) as options_data\n            FROM quiz_questions q\n            LEFT JOIN question_options o ON q.id = o.question_id\n            WHERE q.assignment_id = ?\n            GROUP BY q.id\n            ORDER BY q.id\n        ''', (quiz_id,)).fetchall()\n        \n        # Process questions and options\n        processed_questions = []\n        for question in questions:\n            question_dict = dict(question)\n            question_dict['options'] = {}\n            \n            if question['options_data']:\n                for option_data in question['options_data'].split(':'):\n                    if option_data:\n                        parts = option_data.split('|')\n                        if len(parts) >= 3:\n                            letter = parts[0]\n                            text = parts[1]\n                            is_correct = parts[2] == '1'\n                            question_dict['options'][letter] = {\n                                'text': text,\n                                'is_correct': is_correct\n                            }\n            \n            processed_questions.append(question_dict)\n        \n        # Get student's previous answers if any\n        student_answers = {}\n        if submission:\n            answers = conn.execute('''\n                SELECT question_id, selected_option \n                FROM student_mcq_answers \n                WHERE submission_id = ?\n            ''', (submission['id'],)).fetchall()\n            \n            for answer in answers:\n                student_answers[answer['question_id']] = answer['selected_option']\n        \n        conn.close()\n    \n    return render_template('student/take_quiz.html', \n                         quiz=quiz, \n                         submission=submission, \n                         questions=processed_questions,\n                         student_answers=student_answers)\n\n@app.route('/student/quiz/<int:quiz_id>/submit', methods=['POST'])\n@login_required\ndef student_submit_quiz(quiz_id):\n    \"\"\"Submit MCQ quiz answers\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify access\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title, e.status as enrollment_status\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            LEFT JOIN enrollments e ON c.id = e.course_id AND e.student_id = ?\n            WHERE a.id = ? AND e.status = 'approved'\n        ''', (current_user.id, quiz_id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get quiz questions for grading\n        questions = conn.execute('''\n            SELECT q.id, q.points, q.correct_answer\n            FROM quiz_questions q\n            WHERE q.assignment_id = ?\n            ORDER BY q.id\n        ''', (quiz_id,)).fetchall()\n        \n        try:\n            # Check if already submitted\n            existing = conn.execute('''\n                SELECT id FROM assignment_submissions \n                WHERE assignment_id = ? AND student_id = ?\n            ''', (quiz_id, current_user.id)).fetchone()\n            \n            # Calculate score from MCQ answers\n            total_score = 0\n            total_possible = 0\n            mcq_answers = []\n            \n            for question in questions:\n                question_key = f'question_{question[\"id\"]}'\n                selected_answer = request.form.get(question_key, '').strip()\n                \n                if selected_answer:\n                    is_correct = (selected_answer == question['correct_answer'])\n                    points_earned = question['points'] if is_correct else 0\n                    total_score += points_earned\n                    \n                    mcq_answers.append({\n                        'question_id': question['id'],\n                        'selected_option': selected_answer,\n                        'is_correct': is_correct,\n                        'points_earned': points_earned\n                    })\n                \n                total_possible += question['points']\n            \n            # Create submission text summary\n            submission_text = f\"MCQ Quiz Submission - {len(mcq_answers)} questions answered\"\n            \n            if existing:\n                # Update existing submission\n                conn.execute('''\n                    UPDATE assignment_submissions \n                    SET submission_text = ?, submitted_at = CURRENT_TIMESTAMP, grade = ?\n                    WHERE assignment_id = ? AND student_id = ?\n                ''', (submission_text, total_score, quiz_id, current_user.id))\n                \n                submission_id = existing['id']\n                \n                # Delete old MCQ answers\n                conn.execute('DELETE FROM student_mcq_answers WHERE submission_id = ?', (submission_id,))\n            else:\n                # Create new submission\n                cursor = conn.execute('''\n                    INSERT INTO assignment_submissions (assignment_id, student_id, submission_text, grade)\n                    VALUES (?, ?, ?, ?)\n                ''', (quiz_id, current_user.id, submission_text, total_score))\n                \n                submission_id = cursor.lastrowid\n            \n            # Save MCQ answers\n            for answer in mcq_answers:\n                conn.execute('''\n                    INSERT INTO student_mcq_answers \n                    (submission_id, question_id, selected_option, is_correct, points_earned)\n                    VALUES (?, ?, ?, ?, ?)\n                ''', (submission_id, answer['question_id'], answer['selected_option'], \n                     answer['is_correct'], answer['points_earned']))\n            \n            # Generate AI feedback\n            try:\n                ai_feedback = f\"Quiz completed! You scored {total_score}/{total_possible} ({(total_score / total_possible * 100) if total_possible > 0 else 0:.1f}%). You answered {sum(1 for ans in mcq_answers if ans['is_correct'])} out of {len(questions)} questions correctly.\"\n                \n                conn.execute('''\n                    UPDATE assignment_submissions \n                    SET ai_feedback = ?, graded_at = CURRENT_TIMESTAMP\n                    WHERE id = ?\n                ''', (ai_feedback, submission_id))\n                \n            except Exception as ai_error:\n                print(f\"AI feedback error: {ai_error}\")\n            \n            conn.commit()\n            \n            # Update student progress for this course\n            update_student_progress(conn, current_user.id, quiz['course_id'])\n            \n            percentage = (total_score / total_possible * 100) if total_possible > 0 else 0\n            flash(f'Quiz submitted successfully! Your score: {total_score}/{total_possible} ({percentage:.1f}%)', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error submitting quiz. Please try again.', 'error')\n            print(f\"Quiz submission error: {e}\")\n        \n        conn.close()\n    \n    return redirect(url_for('student_take_quiz', quiz_id=quiz_id))\n\n# RANKINGS ROUTES\n@app.route('/student/courses/<int:course_id>/rankings')\n@login_required\ndef student_course_rankings(course_id):\n    \"\"\"View course rankings based on quiz scores\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled\n        enrollment = conn.execute('''\n            SELECT * FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get rankings based on quiz scores\n        rankings = conn.execute('''\n            SELECT u.full_name, AVG(s.grade) as avg_score, COUNT(s.id) as quiz_count,\n                   RANK() OVER (ORDER BY AVG(s.grade) DESC) as rank\n            FROM users u\n            JOIN enrollments e ON u.id = e.student_id\n            JOIN assignment_submissions s ON u.id = s.student_id\n            JOIN assignments a ON s.assignment_id = a.id\n            WHERE e.course_id = ? AND e.status = 'approved' AND s.grade IS NOT NULL AND a.course_id = ?\n            GROUP BY u.id, u.full_name\n            HAVING quiz_count > 0\n            ORDER BY avg_score DESC\n        ''', (course_id, course_id)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/course_rankings.html', \n                         course=enrollment, rankings=rankings)\n\n# STUDENT ENROLLMENT ROUTES\n@app.route('/student/courses')\n@login_required\ndef student_browse_courses():\n    \"\"\"Browse available courses for enrollment\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get available courses (not already enrolled in)\n        available_courses = conn.execute('''\n            SELECT c.*, u.full_name as instructor_name,\n                   COUNT(e.id) as enrollment_count\n            FROM courses c\n            JOIN users u ON c.instructor_id = u.id\n            LEFT JOIN enrollments e ON c.id = e.course_id AND e.status = 'approved'\n            LEFT JOIN enrollments student_e ON c.id = student_e.course_id AND student_e.student_id = ?\n            WHERE c.is_active = 1 AND student_e.id IS NULL\n            GROUP BY c.id\n            ORDER BY c.created_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Get my enrollment requests\n        my_enrollments = conn.execute('''\n            SELECT e.*, c.title as course_title, c.course_code,\n                   u.full_name as instructor_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ?\n            ORDER BY e.enrolled_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/browse_courses.html', \n                         available_courses=available_courses,\n                         my_enrollments=my_enrollments)\n\n@app.route('/student/enroll', methods=['POST'])\n@login_required\ndef student_enroll():\n    \"\"\"Enroll in a course with enrollment key\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    course_code = request.form.get('course_code', '').strip().upper()\n    enrollment_key = request.form.get('enrollment_key', '').strip()\n    \n    if not course_code or not enrollment_key:\n        flash('Course code and enrollment key are required.', 'error')\n        return redirect(url_for('student_browse_courses'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Find the course\n        course = conn.execute('''\n            SELECT c.*, u.full_name as instructor_name\n            FROM courses c\n            JOIN users u ON c.instructor_id = u.id\n            WHERE c.course_code = ? AND c.is_active = 1\n        ''', (course_code,)).fetchone()\n        \n        if not course:\n            flash(f'Course with code \"{course_code}\" not found or is inactive.', 'error')\n            conn.close()\n            return redirect(url_for('student_browse_courses'))\n        \n        # Check if enrollment key is correct\n        if not course['enrollment_key_hash'] or not check_password_hash(course['enrollment_key_hash'], enrollment_key):\n            flash('Invalid enrollment key. Please check with your instructor.', 'error')\n            conn.close()\n            return redirect(url_for('student_browse_courses'))\n        \n        # Check if already enrolled\n        existing_enrollment = conn.execute('''\n            SELECT id FROM enrollments \n            WHERE student_id = ? AND course_id = ?\n        ''', (current_user.id, course['id'])).fetchone()\n        \n        if existing_enrollment:\n            flash('You have already requested enrollment for this course.', 'warning')\n            conn.close()\n            return redirect(url_for('student_browse_courses'))\n        \n        # Check course capacity\n        current_enrollments = conn.execute('''\n            SELECT COUNT(*) as count FROM enrollments \n            WHERE course_id = ? AND status = 'approved'\n        ''', (course['id'],)).fetchone()\n        \n        if current_enrollments['count'] >= course['max_students']:\n            flash('Course is full. No more enrollments accepted.', 'warning')\n            conn.close()\n            return redirect(url_for('student_browse_courses'))\n        \n        try:\n            # Create enrollment request\n            conn.execute('''\n                INSERT INTO enrollments (student_id, course_id, status)\n                VALUES (?, ?, 'pending')\n            ''', (current_user.id, course['id']))\n            \n            # Create notification for the instructor\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (course['instructor_id'],\n                  'New Enrollment Request',\n                  f'{current_user.full_name} has requested enrollment in \"{course[\"title\"]}\" ({course_code}). Please review and approve.',\n                  'info',\n                  course['id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Enrollment request submitted for \"{course[\"title\"]}\"! Your instructor ({course[\"instructor_name\"]}) will review and approve your request.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error submitting enrollment request. Please try again.', 'error')\n    \n    return redirect(url_for('student_browse_courses'))\n\n@app.route('/student/enrollments')\n@login_required\ndef student_my_enrollments():\n    \"\"\"View my enrollment status\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        enrollments = conn.execute('''\n            SELECT e.*, c.title as course_title, c.course_code, c.description,\n                   u.full_name as instructor_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ?\n            ORDER BY \n                CASE e.status \n                    WHEN 'pending' THEN 1\n                    WHEN 'approved' THEN 2\n                    WHEN 'rejected' THEN 3\n                END,\n                e.enrolled_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Statistics\n        stats = {\n            'total_enrollments': len(enrollments),\n            'pending_enrollments': len([e for e in enrollments if e['status'] == 'pending']),\n            'approved_enrollments': len([e for e in enrollments if e['status'] == 'approved']),\n            'rejected_enrollments': len([e for e in enrollments if e['status'] == 'rejected'])\n        }\n        \n        conn.close()\n    \n    return render_template('student/my_enrollments.html', \n                         enrollments=enrollments, \n                         stats=stats)\n\n# NEW FEATURE: Real-Time Discussion Forum (SMS-like messaging)\n@app.route('/course/<int:course_id>/discussion')\n@login_required\ndef course_discussion_forum(course_id):\n    \"\"\"Real-time discussion forum for course - SMS-like messaging between students and teachers\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify user has access to this course\n        course = conn.execute('SELECT * FROM courses WHERE id = ?', (course_id,)).fetchone()\n        \n        if not course:\n            flash('Course not found.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Check access\n        access = conn.execute('''\n            SELECT 1 FROM enrollments \n            WHERE student_id = ? AND course_id = ? AND status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        is_instructor = (current_user.id == course['instructor_id'])\n        \n        if not access and not is_instructor and not current_user.is_admin():\n            flash('You do not have access to this course.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get existing messages\n        messages = conn.execute('''\n            SELECT cm.*, u.full_name as sender_name, u.role as sender_role\n            FROM chat_messages cm\n            JOIN users u ON cm.sender_id = u.id\n            WHERE cm.course_id = ?\n            ORDER BY cm.created_at ASC\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('course_discussion.html', course=course, messages=messages)\n\n# Error handlers\n@app.errorhandler(404)\ndef not_found_error(error):\n    return render_template('errors/404.html'), 404\n\n@app.errorhandler(500)\ndef internal_error(error):\n    return render_template('errors/500.html'), 500\n\n# SocketIO events for real-time chat\n@socketio.on('connect')\ndef on_connect():\n    if not current_user.is_authenticated:\n        return False\n    join_room(f'user_{current_user.id}')\n    emit('status', {'msg': f'{current_user.full_name} has connected'})\n\n# NOTIFICATIONS ROUTES\n@app.route('/notifications')\n@login_required\ndef notifications():\n    \"\"\"View all notifications for current user\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        notifications = conn.execute('''\n            SELECT * FROM notifications \n            WHERE user_id = ? \n            ORDER BY created_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Mark all as read\n        conn.execute('''\n            UPDATE notifications \n            SET is_read = 1 \n            WHERE user_id = ? AND is_read = 0\n        ''', (current_user.id,))\n        \n        conn.commit()\n        conn.close()\n    \n    return render_template('notifications.html', notifications=notifications)\n\n@app.route('/api/notifications/unread-count')\n@login_required\ndef get_unread_notifications_count():\n    \"\"\"Get count of unread notifications\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        count = conn.execute('''\n            SELECT COUNT(*) as count FROM notifications \n            WHERE user_id = ? AND is_read = 0\n        ''', (current_user.id,)).fetchone()['count']\n        \n        conn.close()\n    \n    return jsonify({'count': count})\n\n@app.route('/api/generate-mcq-options', methods=['POST'])\n@instructor_required\ndef api_generate_mcq_options():\n    \"\"\"API endpoint to generate MCQ options using AI\"\"\"\n    data = request.get_json()\n    question_text = data.get('question', '').strip()\n    context = data.get('context', '').strip()\n    \n    if not question_text:\n        return jsonify({'error': 'Question text is required'}), 400\n    \n    try:\n        options = gemini_ai.generate_mcq_options(question_text, context)\n        \n        if options:\n            return jsonify({\n                'success': True,\n                'options': options\n            })\n        else:\n            return jsonify({\n                'success': False,\n                'error': 'Failed to generate options. Please try again.'\n            }), 500\n            \n    except Exception as e:\n        print(f\"Error generating MCQ options: {e}\")\n        return jsonify({\n            'success': False,\n            'error': 'An error occurred while generating options'\n        }), 500\n\n@app.route('/api/submissions/<int:submission_id>')\n@login_required\ndef api_get_submission(submission_id):\n    \"\"\"API endpoint to get detailed submission data for instructors\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get submission with student and quiz info\n        submission = conn.execute('''\n            SELECT s.*, u.full_name as student_name, u.username, u.email,\n                   a.title as quiz_title, a.course_id, c.instructor_id\n            FROM assignment_submissions s\n            JOIN users u ON s.student_id = u.id\n            JOIN assignments a ON s.assignment_id = a.id\n            JOIN courses c ON a.course_id = c.id\n            WHERE s.id = ?\n        ''', (submission_id,)).fetchone()\n        \n        if not submission:\n            conn.close()\n            return jsonify({'error': 'Submission not found'}), 404\n        \n        # Check if user has access (instructor of the course)\n        if not current_user.is_admin() and submission['instructor_id'] != current_user.id:\n            conn.close()\n            return jsonify({'error': 'Access denied'}), 403\n        \n        # Get MCQ answers\n        answers = conn.execute('''\n            SELECT ma.*, q.question_text, q.option_a, q.option_b, q.option_c, q.option_d,\n                   q.correct_answer, q.points\n            FROM student_mcq_answers ma\n            JOIN quiz_questions q ON ma.question_id = q.id\n            WHERE ma.submission_id = ?\n            ORDER BY q.id\n        ''', (submission_id,)).fetchall()\n        \n        conn.close()\n        \n        # Format response\n        response = {\n            'submission_id': submission['id'],\n            'student_name': submission['student_name'],\n            'username': submission['username'],\n            'email': submission['email'],\n            'quiz_title': submission['quiz_title'],\n            'submitted_at': submission['submitted_at'],\n            'grade': submission['grade'],\n            'ai_feedback': submission['ai_feedback'],\n            'answers': []\n        }\n        \n        for answer in answers:\n            response['answers'].append({\n                'question_id': answer['question_id'],\n                'question_text': answer['question_text'],\n                'options': {\n                    'A': answer['option_a'],\n                    'B': answer['option_b'],\n                    'C': answer['option_c'],\n                    'D': answer['option_d']\n                },\n                'selected_option': answer['selected_option'],\n                'correct_answer': answer['correct_answer'],\n                'is_correct': answer['is_correct'],\n                'points_earned': answer['points_earned'],\n                'points_possible': answer['points']\n            })\n        \n        return jsonify(response)\n\n@app.route('/notifications/<int:notification_id>/mark-read', methods=['POST'])\n@login_required  \ndef mark_notification_read(notification_id):\n    \"\"\"Mark specific notification as read\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        conn.execute('''\n            UPDATE notifications \n            SET is_read = 1 \n            WHERE id = ? AND user_id = ?\n        ''', (notification_id, current_user.id))\n        \n        conn.commit()\n        conn.close()\n    \n    return jsonify({'success': True})\n\n# SOCKETIO CHAT HANDLERS\n@socketio.on('disconnect')\ndef on_disconnect():\n    if current_user.is_authenticated:\n        leave_room(f'user_{current_user.id}')\n\n@socketio.on('join_course_chat')\ndef on_join_course(data):\n    if not current_user.is_authenticated:\n        return\n    \n    course_id = data['course_id']\n    \n    # Verify user has access to this course\n    with db_lock:\n        conn = get_db_connection()\n        access = conn.execute('''\n            SELECT 1 FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            WHERE (e.student_id = ? OR c.instructor_id = ?) AND c.id = ? AND e.status = 'approved'\n        ''', (current_user.id, current_user.id, course_id)).fetchone()\n        conn.close()\n    \n    if access or current_user.is_admin():\n        join_room(f'course_{course_id}')\n        socketio.emit('status', {'msg': f'{current_user.full_name} joined the course chat'}, to=f'course_{course_id}')\n\n@socketio.on('send_course_message')\ndef handle_course_message(data):\n    if not current_user.is_authenticated:\n        return\n    \n    course_id = data['course_id']\n    message = data['message'].strip()\n    sender_role = data.get('sender_role', current_user.role)\n    \n    if not message:\n        return\n    \n    # Save message to database\n    with db_lock:\n        conn = get_db_connection()\n        conn.execute('''\n            INSERT INTO chat_messages (course_id, sender_id, message)\n            VALUES (?, ?, ?)\n        ''', (course_id, current_user.id, message))\n        conn.commit()\n        conn.close()\n    \n    # Emit message to course room\n    socketio.emit('new_course_message', {\n        'message': message,\n        'sender_name': current_user.full_name,\n        'sender_id': current_user.id,\n        'sender_role': sender_role,\n        'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n    }, to=f'course_{course_id}')\n\nif __name__ == '__main__':\n    init_db()\n    socketio.run(app, host='0.0.0.0', port=5000, debug=True, use_reloader=False, log_output=True)","size_bytes":149895},"LearnNestGemini/weather-app-abdulwaheed/static/css/main.css":{"content":"        :root {\n            /* iOS-Style Dark Mode Color System */\n            /* Background Colors */\n            --black: #000000;                    /* Primary background - true black */\n            --gray-50: #0D0D0D;                  /* Navigation bar background */\n            --gray-100: #1C1C1E;                 /* Secondary background - Cards/Lists */\n            --gray-200: #2C2C2E;                 /* Tertiary background - Elevated cards */\n            --gray-300: #3A3A3C;                 /* Dividers/Lines */\n            --gray-400: #48484A;                 /* Borders */\n            --gray-500: #636366;                 /* Subtle elements */\n            --gray-600: #8E8E93;                 /* Tab bar inactive */\n            --gray-700: #9999A5;                 /* Secondary text solid */\n            --gray-800: #AEAEB2;                 /* Light gray */\n            --gray-900: #C7C7CC;                 /* Lighter gray */\n            --white: #ffffff;\n            \n            /* Accent Colors - iOS Style */\n            --primary: #0A84FF;                  /* iOS Blue - Primary accent */\n            --primary-dark: #006EDC;             /* Pressed accent */\n            --success: #30D158;                  /* iOS Green */\n            --warning: #FF9F0A;                  /* iOS Orange */\n            --info: #64D2FF;                     /* iOS Cyan */\n            --danger: #FF453A;                   /* iOS Red - Destructive */\n            --accent: #BF5AF2;                   /* iOS Purple */\n            \n            /* Text Colors - iOS System */\n            --text-primary: #FFFFFF;             /* Primary text - Headings */\n            --text-secondary: #9999A5;           /* Secondary text - Descriptions (60% opacity equivalent) */\n            --text-light: #56565E;               /* Tertiary text - Labels (30% opacity equivalent) */\n            --text-disabled: #3A3A3E;            /* Quaternary text - Disabled (18% opacity equivalent) */\n            \n            /* Background & Borders */\n            --background: var(--black);\n            --card-bg: var(--gray-100);\n            --card-hover: var(--gray-200);\n            --border: var(--gray-300);\n            --border-light: var(--gray-400);\n            \n            /* Shadows - iOS Style */\n            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);\n            --shadow: 0 2px 12px rgba(0, 0, 0, 0.5);\n            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.6);\n            --shadow-lg: 0 4px 20px rgba(0, 0, 0, 0.6);\n            --shadow-xl: 0 8px 32px rgba(0, 0, 0, 0.7);\n            \n            /* Gradients - iOS Dark */\n            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);\n            --gradient-success: linear-gradient(135deg, var(--success) 0%, #28CD4B 100%);\n            --gradient-warning: linear-gradient(135deg, var(--warning) 0%, #FF8800 100%);\n            --gradient-accent: linear-gradient(135deg, var(--accent) 0%, #A646E8 100%);\n            --gradient-bg: linear-gradient(135deg, var(--black) 0%, var(--gray-50) 100%);\n            \n            /* Border Radius - iOS Style */\n            --radius-sm: 0.5rem;\n            --radius: 0.75rem;\n            --radius-md: 1rem;\n            --radius-lg: 1.25rem;\n            --radius-xl: 1.5rem;\n        }\n\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            font-family: system-ui, -apple-system, sans-serif;\n            background: linear-gradient(135deg, var(--black) 0%, var(--gray-100) 100%);\n            min-height: 100vh;\n            line-height: 1.6;\n            color: var(--text-primary);\n            margin: 0;\n            padding-top: 70px;\n        }\n\n        .navbar {\n            background-color: var(--gray-100);\n            box-shadow: var(--shadow-lg);\n            position: fixed;\n            width: 100%;\n            top: 0;\n            z-index: 1000;\n            border-bottom: 1px solid var(--border);\n        }\n\n        .navbar-content {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 1rem 5%;\n            max-width: 1400px;\n            margin: 0 auto;\n        }\n\n        .navbar-brand {\n            display: flex;\n            align-items: center;\n            gap: 0.75rem;\n            font-size: 1.5rem;\n            font-weight: 800;\n            color: var(--text-primary);\n            text-decoration: none;\n        }\n\n        .navbar-brand i {\n            font-size: 2rem;\n            color: var(--primary);\n        }\n\n        .navbar-nav {\n            display: flex;\n            list-style: none;\n            gap: 2rem;\n            margin: 0;\n            padding: 0;\n            align-items: center;\n        }\n\n        .nav-link {\n            text-decoration: none;\n            color: var(--text-secondary);\n            font-weight: 500;\n            font-size: 0.95rem;\n            padding: 0.5rem 0;\n            position: relative;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            gap: 0.5rem;\n        }\n\n        .nav-link:hover {\n            color: var(--text-primary);\n        }\n\n        .nav-link::after {\n            content: '';\n            position: absolute;\n            bottom: 0;\n            left: 0;\n            width: 0;\n            height: 2px;\n            background-color: var(--primary);\n            transition: width 0.3s ease;\n        }\n\n        .nav-link:hover::after {\n            width: 100%;\n        }\n\n        .hamburger {\n            display: none;\n            background: linear-gradient(135deg, rgba(52, 199, 89, 0.1), rgba(0, 179, 65, 0.1));\n            border: 1px solid rgba(52, 199, 89, 0.3);\n            cursor: pointer;\n            padding: 0.5rem;\n            outline: none;\n            width: 44px;\n            height: 44px;\n            border-radius: 12px;\n            transition: all 0.3s ease;\n            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);\n        }\n        \n        .hamburger:hover {\n            background: linear-gradient(135deg, rgba(52, 199, 89, 0.15), rgba(0, 179, 65, 0.15));\n            transform: scale(1.05);\n        }\n\n        .hamburger span {\n            display: block;\n            width: 22px;\n            height: 2.5px;\n            background: linear-gradient(90deg, #34C759, #00B341);\n            margin: 4px auto;\n            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);\n            border-radius: 2px;\n        }\n\n        .notifications-nav {\n            position: relative;\n        }\n\n        .notifications-link {\n            position: relative;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            width: 40px;\n            height: 40px;\n            border-radius: 50%;\n            transition: all 0.3s ease;\n            background: var(--gray-100);\n            color: var(--text-secondary);\n        }\n\n        .notifications-link:hover {\n            background: var(--gray-200);\n            color: var(--text-primary);\n        }\n\n        .notification-badge {\n            position: absolute;\n            top: -2px;\n            right: -2px;\n            background: var(--danger);\n            color: white;\n            border-radius: 50%;\n            width: 18px;\n            height: 18px;\n            font-size: 0.7rem;\n            font-weight: 600;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            animation: pulse 2s infinite;\n        }\n\n        @keyframes pulse {\n            0% { transform: scale(1); }\n            50% { transform: scale(1.1); }\n            100% { transform: scale(1); }\n        }\n\n        .btn {\n            display: inline-flex;\n            align-items: center;\n            gap: 0.5rem;\n            padding: 0.75rem 1.5rem;\n            border: none;\n            border-radius: var(--radius);\n            font-weight: 600;\n            text-decoration: none;\n            cursor: pointer;\n            transition: all 0.2s;\n            font-size: 0.9rem;\n            color: var(--white);\n        }\n\n        .btn-primary {\n            background: var(--gradient-primary);\n            color: white;\n        }\n\n        .btn-primary:hover {\n            transform: translateY(-2px);\n            box-shadow: var(--shadow-lg);\n        }\n\n        .btn-secondary {\n            background: var(--gray-200);\n            color: var(--text-primary);\n            border: 1px solid var(--border);\n        }\n\n        .btn-secondary:hover {\n            background: var(--gray-300);\n            color: var(--white);\n            transform: translateY(-2px);\n        }\n\n        .btn-success {\n            background: var(--success);\n            color: white;\n        }\n\n        .btn-warning {\n            background: var(--warning);\n            color: white;\n        }\n\n        .btn-danger {\n            background: var(--danger);\n            color: white;\n        }\n\n        .btn-sm {\n            padding: 0.5rem 1rem;\n            font-size: 0.8rem;\n        }\n\n        .container {\n            max-width: 1400px;\n            margin: 0 auto;\n            padding: 2rem;\n        }\n\n        .flash-messages {\n            margin: 1rem 0;\n        }\n\n        .flash-message {\n            padding: 1rem 1.5rem;\n            border-radius: var(--radius);\n            margin-bottom: 0.75rem;\n            display: flex;\n            align-items: center;\n            gap: 0.75rem;\n            border: 1px solid;\n            background: var(--gray-100);\n            box-shadow: var(--shadow-sm);\n        }\n\n        .flash-message.success {\n            background: rgba(48, 209, 88, 0.1);\n            color: var(--success);\n            border-color: rgba(48, 209, 88, 0.3);\n        }\n\n        .flash-message.error {\n            background: rgba(255, 69, 58, 0.1);\n            color: var(--danger);\n            border-color: rgba(255, 69, 58, 0.3);\n        }\n\n        .flash-message.warning {\n            background: rgba(255, 159, 10, 0.1);\n            color: var(--warning);\n            border-color: rgba(255, 159, 10, 0.3);\n        }\n\n        .flash-message.info {\n            background: rgba(100, 210, 255, 0.1);\n            color: var(--info);\n            border-color: rgba(100, 210, 255, 0.3);\n        }\n\n        .card {\n            background: var(--card-bg);\n            border-radius: var(--radius-lg);\n            padding: 2rem;\n            box-shadow: var(--shadow-lg);\n            margin-bottom: 2rem;\n            position: relative;\n            overflow: hidden;\n            border: 1px solid var(--border);\n            transition: all 0.3s ease;\n        }\n\n        .card:hover {\n            background: var(--card-hover);\n            box-shadow: var(--shadow-xl);\n        }\n\n        .card::before {\n            content: '';\n            position: absolute;\n            top: 0;\n            left: 0;\n            right: 0;\n            height: 4px;\n            background: var(--gradient-primary);\n        }\n\n        .page-container {\n            max-width: 1400px;\n            margin: 0 auto;\n            padding: 2rem;\n        }\n\n        .page-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 2rem;\n            padding: 2rem;\n            background: var(--card-bg);\n            border-radius: var(--radius-lg);\n            box-shadow: var(--shadow-md);\n            border: 1px solid var(--border);\n        }\n\n        .header-content h1 {\n            font-size: 2.25rem;\n            margin-bottom: 0.5rem;\n            color: var(--text-primary);\n            font-weight: 800;\n        }\n\n        .header-content p {\n            color: var(--text-secondary);\n            font-size: 1.1rem;\n        }\n\n        .header-actions {\n            display: flex;\n            gap: 1rem;\n        }\n\n        .stats-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n            gap: 1.5rem;\n            margin: 2rem 0;\n        }\n\n        .stat-card {\n            background: var(--card-bg);\n            padding: 1.5rem;\n            border-radius: var(--radius-lg);\n            box-shadow: var(--shadow-md);\n            text-align: center;\n            position: relative;\n            overflow: hidden;\n            transition: transform 0.3s ease, box-shadow 0.3s ease;\n            border: 1px solid var(--border);\n        }\n        \n        .stat-card:hover {\n            background: var(--card-hover);\n        }\n\n        .stat-card:hover {\n            transform: translateY(-5px);\n            box-shadow: var(--shadow-lg);\n        }\n\n        .stat-card::before {\n            content: '';\n            position: absolute;\n            top: 0;\n            left: 0;\n            right: 0;\n            height: 4px;\n            background: var(--gradient-primary);\n        }\n\n        .stat-number {\n            font-size: 2.5rem;\n            font-weight: 800;\n            color: var(--text-primary);\n            display: block;\n            line-height: 1;\n            margin-bottom: 0.5rem;\n        }\n\n        .stat-label {\n            color: var(--text-secondary);\n            font-weight: 600;\n            font-size: 0.9rem;\n        }\n\n        .form-group {\n            margin-bottom: 1.5rem;\n        }\n\n        .form-group label {\n            display: block;\n            margin-bottom: 0.5rem;\n            font-weight: 600;\n            color: var(--text-primary);\n        }\n\n        .form-group input,\n        .form-group select,\n        .form-group textarea {\n            width: 100%;\n            padding: 0.75rem 1rem;\n            border: 1px solid var(--border);\n            border-radius: var(--radius);\n            font-size: 1rem;\n            transition: all 0.2s;\n            color: var(--text-primary);\n            background: var(--gray-200);\n        }\n\n        .form-group input:focus,\n        .form-group select:focus,\n        .form-group textarea:focus {\n            outline: none;\n            border-color: var(--primary);\n            background: var(--gray-300);\n            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);\n        }\n\n        .form-group input::placeholder,\n        .form-group textarea::placeholder {\n            color: var(--text-light);\n        }\n\n        .empty-state {\n            text-align: center;\n            padding: 3rem 2rem;\n            color: var(--text-secondary);\n        }\n\n        .empty-state i {\n            font-size: 3rem;\n            color: var(--gray-400);\n            margin-bottom: 1rem;\n        }\n\n        .empty-state h3 {\n            color: var(--text-primary);\n            margin-bottom: 1rem;\n            font-weight: 600;\n        }\n\n        /* Mobile Menu Styles */\n        @media (max-width: 768px) {\n            .navbar-nav {\n                position: absolute;\n                top: 100%;\n                left: -100%;\n                width: 100%;\n                background-color: var(--gray-100);\n                flex-direction: column;\n                align-items: stretch;\n                padding: 1rem 0;\n                box-shadow: var(--shadow-lg);\n                transition: all 0.4s ease;\n                border-top: 1px solid var(--border);\n            }\n            \n            .navbar-nav.active {\n                left: 0;\n            }\n            \n            .navbar-nav li {\n                width: 100%;\n                text-align: left;\n            }\n            \n            .nav-link {\n                padding: 1rem 2rem;\n                display: flex;\n                width: 100%;\n                color: var(--text-primary);\n                border-bottom: 1px solid var(--gray-100);\n            }\n            \n            .nav-link:last-child {\n                border-bottom: none;\n            }\n            \n            .hamburger {\n                display: flex;\n                flex-direction: column;\n                justify-content: center;\n            }\n            \n            .hamburger.active span:nth-child(1) {\n                transform: rotate(45deg) translate(6px, 6px);\n            }\n            \n            .hamburger.active span:nth-child(2) {\n                opacity: 0;\n            }\n            \n            .hamburger.active span:nth-child(3) {\n                transform: rotate(-45deg) translate(6px, -6px);\n            }\n            \n            .page-header {\n                flex-direction: column;\n                gap: 1.5rem;\n                text-align: center;\n            }\n            \n            .header-actions {\n                width: 100%;\n                justify-content: center;\n            }\n            \n            .container,\n            .page-container {\n                padding: 1rem;\n            }\n            \n            .navbar-content {\n                padding: 1rem;\n            }\n        }\n\n        /* Tables - iOS Dark Theme */\n        table {\n            width: 100%;\n            border-collapse: collapse;\n            background: var(--card-bg);\n            border-radius: var(--radius-lg);\n            overflow: hidden;\n            box-shadow: var(--shadow);\n        }\n\n        thead {\n            background: var(--gray-200);\n        }\n\n        th {\n            padding: 1rem;\n            text-align: left;\n            font-weight: 600;\n            color: var(--text-primary);\n            border-bottom: 1px solid var(--border);\n        }\n\n        td {\n            padding: 1rem;\n            color: var(--text-secondary);\n            border-bottom: 1px solid var(--gray-300);\n        }\n\n        tbody tr {\n            transition: background 0.2s ease;\n        }\n\n        tbody tr:hover {\n            background: var(--card-hover);\n        }\n\n        tbody tr:last-child td {\n            border-bottom: none;\n        }\n\n        /* Badges - iOS Dark Theme */\n        .badge {\n            display: inline-block;\n            padding: 0.35rem 0.75rem;\n            border-radius: var(--radius);\n            font-size: 0.85rem;\n            font-weight: 600;\n            text-align: center;\n        }\n\n        .badge-primary {\n            background: rgba(10, 132, 255, 0.15);\n            color: var(--primary);\n            border: 1px solid rgba(10, 132, 255, 0.3);\n        }\n\n        .badge-success {\n            background: rgba(48, 209, 88, 0.15);\n            color: var(--success);\n            border: 1px solid rgba(48, 209, 88, 0.3);\n        }\n\n        .badge-warning {\n            background: rgba(255, 159, 10, 0.15);\n            color: var(--warning);\n            border: 1px solid rgba(255, 159, 10, 0.3);\n        }\n\n        .badge-danger {\n            background: rgba(255, 69, 58, 0.15);\n            color: var(--danger);\n            border: 1px solid rgba(255, 69, 58, 0.3);\n        }\n\n        .badge-info {\n            background: rgba(100, 210, 255, 0.15);\n            color: var(--info);\n            border: 1px solid rgba(100, 210, 255, 0.3);\n        }\n\n        .badge-secondary {\n            background: var(--gray-200);\n            color: var(--text-secondary);\n            border: 1px solid var(--border);\n        }\n\n        /* Progress Bars - iOS Dark Theme */\n        .progress {\n            background: var(--gray-200);\n            border-radius: var(--radius);\n            height: 10px;\n            overflow: hidden;\n            position: relative;\n        }\n\n        .progress-bar {\n            height: 100%;\n            background: var(--gradient-primary);\n            transition: width 0.3s ease;\n            border-radius: var(--radius);\n        }\n\n        .progress-bar.success {\n            background: var(--gradient-success);\n        }\n\n        .progress-bar.warning {\n            background: var(--gradient-warning);\n        }\n\n        .progress-bar.danger {\n            background: linear-gradient(135deg, var(--danger) 0%, #E03A31 100%);\n        }\n\n        /* List Groups - iOS Dark Theme */\n        .list-group {\n            background: var(--card-bg);\n            border-radius: var(--radius-lg);\n            overflow: hidden;\n            box-shadow: var(--shadow);\n        }\n\n        .list-group-item {\n            padding: 1rem 1.5rem;\n            color: var(--text-primary);\n            border-bottom: 1px solid var(--gray-300);\n            transition: all 0.2s ease;\n            background: transparent;\n        }\n\n        .list-group-item:hover {\n            background: var(--card-hover);\n        }\n\n        .list-group-item:last-child {\n            border-bottom: none;\n        }\n\n        .list-group-item.active {\n            background: rgba(10, 132, 255, 0.15);\n            border-left: 3px solid var(--primary);\n        }\n\n        /* Modals - iOS Dark Theme */\n        .modal {\n            background: rgba(0, 0, 0, 0.85);\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            z-index: 9999;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            backdrop-filter: blur(10px);\n        }\n\n        .modal-content {\n            background: var(--card-bg);\n            border-radius: var(--radius-lg);\n            padding: 2rem;\n            max-width: 600px;\n            width: 90%;\n            box-shadow: var(--shadow-xl);\n            border: 1px solid var(--border);\n        }\n\n        .modal-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 1.5rem;\n            padding-bottom: 1rem;\n            border-bottom: 1px solid var(--border);\n        }\n\n        .modal-header h3 {\n            color: var(--text-primary);\n            font-size: 1.5rem;\n            font-weight: 700;\n        }\n\n        .modal-body {\n            color: var(--text-secondary);\n            margin-bottom: 1.5rem;\n        }\n\n        .modal-footer {\n            display: flex;\n            gap: 1rem;\n            justify-content: flex-end;\n            padding-top: 1rem;\n            border-top: 1px solid var(--border);\n        }\n\n        /* Alerts - iOS Dark Theme */\n        .alert {\n            padding: 1rem 1.5rem;\n            border-radius: var(--radius);\n            margin-bottom: 1rem;\n            border: 1px solid;\n            display: flex;\n            align-items: center;\n            gap: 0.75rem;\n        }\n\n        .alert-success {\n            background: rgba(48, 209, 88, 0.1);\n            color: var(--success);\n            border-color: rgba(48, 209, 88, 0.3);\n        }\n\n        .alert-warning {\n            background: rgba(255, 159, 10, 0.1);\n            color: var(--warning);\n            border-color: rgba(255, 159, 10, 0.3);\n        }\n\n        .alert-danger {\n            background: rgba(255, 69, 58, 0.1);\n            color: var(--danger);\n            border-color: rgba(255, 69, 58, 0.3);\n        }\n\n        .alert-info {\n            background: rgba(100, 210, 255, 0.1);\n            color: var(--info);\n            border-color: rgba(100, 210, 255, 0.3);\n        }\n\n        /* Pagination - iOS Dark Theme */\n        .pagination {\n            display: flex;\n            gap: 0.5rem;\n            justify-content: center;\n            margin: 2rem 0;\n        }\n\n        .pagination a,\n        .pagination span {\n            padding: 0.5rem 1rem;\n            background: var(--card-bg);\n            border: 1px solid var(--border);\n            border-radius: var(--radius);\n            color: var(--text-primary);\n            text-decoration: none;\n            transition: all 0.2s ease;\n        }\n\n        .pagination a:hover {\n            background: var(--card-hover);\n            border-color: var(--primary);\n            color: var(--primary);\n        }\n\n        .pagination .active {\n            background: var(--primary);\n            border-color: var(--primary);\n            color: var(--white);\n        }\n\n        /* Breadcrumbs - iOS Dark Theme */\n        .breadcrumb {\n            display: flex;\n            gap: 0.5rem;\n            padding: 1rem;\n            background: var(--card-bg);\n            border-radius: var(--radius);\n            margin-bottom: 1rem;\n        }\n\n        .breadcrumb a {\n            color: var(--primary);\n            text-decoration: none;\n        }\n\n        .breadcrumb a:hover {\n            text-decoration: underline;\n        }\n\n        .breadcrumb-separator {\n            color: var(--text-light);\n        }\n\n        /* Video Player Container - iOS Dark Theme */\n        .video-container {\n            background: var(--black);\n            border-radius: var(--radius-lg);\n            overflow: hidden;\n            box-shadow: var(--shadow-lg);\n            position: relative;\n        }\n\n        .video-container iframe {\n            border-radius: var(--radius-lg);\n        }\n\n        /* Code Blocks - iOS Dark Theme */\n        pre, code {\n            background: var(--gray-200);\n            color: var(--text-primary);\n            border-radius: var(--radius);\n            padding: 0.25rem 0.5rem;\n            font-family: 'Courier New', monospace;\n        }\n\n        pre {\n            padding: 1rem;\n            overflow-x: auto;\n            border: 1px solid var(--border);\n        }\n\n        /* Tooltips - iOS Dark Theme */\n        .tooltip {\n            background: var(--gray-100);\n            color: var(--text-primary);\n            padding: 0.5rem 1rem;\n            border-radius: var(--radius);\n            font-size: 0.85rem;\n            box-shadow: var(--shadow-lg);\n            border: 1px solid var(--border);\n        }\n\n        /* Dropdown Menus - iOS Dark Theme */\n        .dropdown-menu {\n            background: var(--card-bg);\n            border: 1px solid var(--border);\n            border-radius: var(--radius-lg);\n            box-shadow: var(--shadow-lg);\n            padding: 0.5rem 0;\n            min-width: 200px;\n        }\n\n        .dropdown-item {\n            padding: 0.75rem 1.5rem;\n            color: var(--text-primary);\n            text-decoration: none;\n            display: block;\n            transition: all 0.2s ease;\n        }\n\n        .dropdown-item:hover {\n            background: var(--card-hover);\n            color: var(--primary);\n        }\n\n        .dropdown-divider {\n            height: 1px;\n            background: var(--border);\n            margin: 0.5rem 0;\n        }\n\n        /* Tabs - iOS Dark Theme */\n        .nav-tabs {\n            display: flex;\n            gap: 0.5rem;\n            border-bottom: 1px solid var(--border);\n            margin-bottom: 1.5rem;\n        }\n\n        .nav-tabs .nav-link {\n            padding: 0.75rem 1.5rem;\n            color: var(--text-secondary);\n            border: none;\n            border-bottom: 2px solid transparent;\n            transition: all 0.2s ease;\n            background: transparent;\n        }\n\n        .nav-tabs .nav-link:hover {\n            color: var(--text-primary);\n            border-bottom-color: var(--gray-500);\n        }\n\n        .nav-tabs .nav-link.active {\n            color: var(--primary);\n            border-bottom-color: var(--primary);\n        }\n\n        /* Utility classes */\n        .text-center { text-align: center; }\n        .text-muted { color: var(--text-secondary); }\n        .text-primary { color: var(--primary); }\n        .text-success { color: var(--success); }\n        .text-warning { color: var(--warning); }\n        .text-danger { color: var(--danger); }\n        .mb-0 { margin-bottom: 0; }\n        .mb-1 { margin-bottom: 0.5rem; }\n        .mb-2 { margin-bottom: 1rem; }\n        .mb-3 { margin-bottom: 1.5rem; }\n        .mt-2 { margin-top: 1rem; }\n        .d-flex { display: flex; }\n        .justify-between { justify-content: space-between; }\n        .align-center { align-items: center; }\n        .gap-1 { gap: 0.5rem; }\n        .gap-2 { gap: 1rem; }\n","size_bytes":27790},"ghalib/pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"eventlet>=0.40.3\",\n    \"flask>=3.1.2\",\n    \"flask-caching>=2.3.1\",\n    \"flask-login>=0.6.3\",\n    \"flask-mail>=0.10.0\",\n    \"flask-socketio>=5.5.1\",\n    \"google-genai>=1.36.0\",\n    \"gunicorn>=23.0.0\",\n    \"nltk>=3.9.1\",\n    \"numpy>=2.3.3\",\n    \"pandas>=2.3.2\",\n    \"pillow>=11.3.0\",\n    \"pypdf2>=3.0.1\",\n    \"python-dotenv>=1.1.1\",\n    \"pytubefix>=10.3.5\",\n    \"reportlab>=4.4.5\",\n    \"sift-stack-py>=0.8.5\",\n    \"werkzeug>=3.1.3\",\n    \"yt-dlp>=2024.12.23\",\n]\n","size_bytes":606},"static/js/dashboard.js":{"content":"<script>\nfunction enrollInCourse(courseCode, courseTitle) {\n    document.getElementById('modalCourseTitle').textContent = courseTitle;\n    document.getElementById('modalCourseCode').textContent = courseCode;\n    document.getElementById('modalCourseCodeInput').value = courseCode;\n    document.getElementById('modalEnrollmentKey').value = '';\n    document.getElementById('enrollmentModal').style.display = 'block';\n    document.getElementById('modalEnrollmentKey').focus();\n}\n\nfunction closeEnrollmentModal() {\n    document.getElementById('enrollmentModal').style.display = 'none';\n}\n\nfunction viewCourseDetails(courseId) {\n    window.location.href = '{{ url_for(\"student_browse_courses\") }}#course-' + courseId;\n}\n\n// Set current date\ndocument.addEventListener('DOMContentLoaded', function() {\n    const now = new Date();\n    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };\n    document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);\n    \n    // Initialize progress animations\n    initializeProgressAnimations();\n});\n\n// Function to initialize progress animations\nfunction initializeProgressAnimations() {\n    const progressBars = document.querySelectorAll('.progress-fill');\n    \n    progressBars.forEach(bar => {\n        // Add a slight delay to make the animation more noticeable\n        setTimeout(() => {\n            const width = bar.style.width;\n            bar.style.width = '0%';\n            \n            // Animate to the actual width\n            setTimeout(() => {\n                bar.style.width = width;\n            }, 300);\n        }, 500);\n    });\n}\n\n// Function to simulate progress update\nfunction simulateProgressUpdate(courseCode, newProgress) {\n    const courseItems = document.querySelectorAll('.course-item');\n    \n    courseItems.forEach(item => {\n        const codeElement = item.querySelector('.course-code');\n        if (codeElement && codeElement.textContent === courseCode) {\n            const progressFill = item.querySelector('.progress-fill');\n            const progressPercentage = item.querySelector('.progress-percentage');\n            \n            if (progressFill) {\n                progressFill.style.width = `${newProgress}%`;\n                \n                // Add a glow effect\n                progressFill.style.animation = 'progress-glow 1s ease';\n                \n                // Remove animation after it completes\n                setTimeout(() => {\n                    progressFill.style.animation = '';\n                }, 1000);\n            }\n        }\n    });\n}\n\n// Close modal when clicking outside\nwindow.addEventListener('click', function(event) {\n    const modal = document.getElementById('enrollmentModal');\n    if (event.target === modal) {\n        closeEnrollmentModal();\n    }\n});\n\n// Close modal on escape key\ndocument.addEventListener('keydown', function(event) {\n    if (event.key === 'Escape') {\n        closeEnrollmentModal();\n    }\n});\n\n// Demo function to show progress animation (remove in production)\nfunction demoProgressAnimation() {\n    setTimeout(() => {\n        simulateProgressUpdate('CS101', 75);\n    }, 2000);\n    \n    setTimeout(() => {\n        simulateProgressUpdate('MATH201', 45);\n    }, 4000);\n}\n\n// Initialize demo on page load (remove in production)\ndocument.addEventListener('DOMContentLoaded', function() {\n    // Uncomment the line below to see demo progress animations\n    // demoProgressAnimation();\n});\n</script>\n","size_bytes":3479},"ghalib/app.py":{"content":"import os\nimport sqlite3\nimport logging\nfrom datetime import datetime, timedelta\nfrom functools import wraps\nfrom werkzeug.security import generate_password_hash, check_password_hash\nfrom werkzeug.utils import secure_filename\nfrom flask import Flask, render_template, request, redirect, url_for, flash, jsonify, session, send_from_directory, send_file\nfrom flask_login import LoginManager, UserMixin, login_user, login_required, logout_user, current_user\nfrom flask_socketio import SocketIO, emit, join_room, leave_room, rooms\nfrom flask_caching import Cache\nfrom flask_mail import Mail, Message\nfrom threading import Lock\nimport json\nimport uuid\nfrom dotenv import load_dotenv\nimport gemini_ai\nfrom pytubefix import YouTube\nimport shutil\n\n# Load environment variables\nload_dotenv()\n\n# Initialize Flask app\napp = Flask(__name__)\napp.config['SECRET_KEY'] = os.environ.get('SESSION_SECRET') or 'dev-secret-key-change-in-production'\n# Use paths relative to the app file location\nBASE_DIR = os.path.dirname(os.path.abspath(__file__))\napp.config['UPLOAD_FOLDER'] = os.path.join(BASE_DIR, 'sir_rafique', 'uploads')\napp.config['MAX_CONTENT_LENGTH'] = None  # No file size limit for videos\n\n# Database configuration\nDATABASE = os.path.join(BASE_DIR, 'sir_rafique', 'learnnest.db')\n\n# Initialize extensions\nlogin_manager = LoginManager()\nlogin_manager.init_app(app)\nlogin_manager.login_view = 'login'  # type: ignore\nlogin_manager.login_message = 'Please log in to access this page.'\n\nsocketio = SocketIO(app, cors_allowed_origins=\"*\", async_mode='threading')\n\n# Initialize caching\ncache = Cache(app, config={'CACHE_TYPE': 'simple'})\n\n# Initialize mail\nmail = Mail(app)\n\n# Register custom Jinja filters and globals\n@app.template_filter('nl2br')\ndef nl2br_filter(s):\n    \"\"\"Convert newlines to HTML line breaks\"\"\"\n    if s is None:\n        return ''\n    return str(s).replace('\\n', '<br>\\n')\n\n# Add custom Jinja2 global functions\n@app.template_global()\ndef max_func(*args):\n    \"\"\"Max function for Jinja2 templates\"\"\"\n    return max(args)\n\n@app.template_global()\ndef min_func(*args):\n    \"\"\"Min function for Jinja2 templates\"\"\"\n    return min(args)\n\n# CSRF protection helpers\nimport secrets\nimport hashlib\n\ndef generate_csrf_token():\n    \"\"\"Generate a CSRF token for forms\"\"\"\n    token = secrets.token_urlsafe(32)\n    session['csrf_token'] = token\n    return token\n\ndef validate_csrf_token(token):\n    \"\"\"Validate CSRF token\"\"\"\n    if not token or token != session.get('csrf_token'):\n        return False\n    return True\n\n@app.context_processor\ndef inject_csrf_token():\n    \"\"\"Make CSRF token available in all templates\"\"\"\n    if 'csrf_token' not in session:\n        session['csrf_token'] = secrets.token_urlsafe(32)\n    return dict(csrf_token=session['csrf_token'])\n\n# Thread lock for database operations\ndb_lock = Lock()\n\n# Create uploads directory\nos.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'assignments'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'resources'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'payments'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'instructor_screenshots'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'transcripts'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'chat_files'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'chat_images'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'direct_messages'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'forum_media'), exist_ok=True)\nos.makedirs(os.path.join(app.config['UPLOAD_FOLDER'], 'profile_pictures'), exist_ok=True)\n\n# File size limits (in bytes)\nMAX_CHAT_FILE_SIZE = 100 * 1024 * 1024  # 100 MB per file\nMAX_TOTAL_STORAGE_PER_USER = 5 * 1024 * 1024 * 1024  # 5 GB per user\nALLOWED_FILE_TYPES = {\n    'pdf', 'doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx', 'txt', \n    'jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg',\n    'zip', 'rar', '7z', 'tar', 'gz',\n    'mp4', 'mov', 'avi', 'mkv', 'webm', 'flv',\n    'mp3', 'wav', 'ogg', 'm4a',\n    'csv', 'json', 'xml', 'html', 'css', 'js', 'py', 'java', 'cpp', 'c', 'h'\n}\n\n# Database connection helper\ndef get_db_connection():\n    conn = sqlite3.connect(DATABASE, timeout=30)\n    conn.execute('PRAGMA journal_mode=WAL;')\n    conn.execute('PRAGMA synchronous=NORMAL;')\n    conn.execute('PRAGMA cache_size=10000;')\n    conn.execute('PRAGMA temp_store=MEMORY;')\n    conn.row_factory = sqlite3.Row\n    return conn\n\ndef send_notification(user_id, title, message, notification_type='info', related_id=None):\n    \"\"\"Helper function to send notifications to students\"\"\"\n    try:\n        conn = get_db_connection()\n        conn.execute('''\n            INSERT INTO notifications (user_id, title, message, type, related_id, created_at)\n            VALUES (?, ?, ?, ?, ?, ?)\n        ''', (user_id, title, message, notification_type, related_id, datetime.now()))\n        conn.commit()\n        conn.close()\n        \n        # Emit real-time notification via SocketIO\n        socketio.emit('notification', {\n            'title': title,\n            'message': message,\n            'type': notification_type\n        }, to=f'user_{user_id}')\n        \n        return True\n    except Exception as e:\n        logging.error(f\"Error sending notification: {e}\")\n        return False\n\ndef update_student_progress(conn, student_id, course_id):\n    \"\"\"\n    Calculate and update student progress for a course based on quiz completions\n    Progress = (Number of Submitted Quizzes / Total Quizzes) * 100\n    Note: If manual_progress_override is set by instructor, automatic progress is still calculated and stored\n          but the manual override value takes precedence for display\n    \"\"\"\n    try:\n        # Check if instructor has set manual progress override\n        enrollment = conn.execute('''\n            SELECT manual_progress_override\n            FROM enrollments\n            WHERE student_id = ? AND course_id = ?\n        ''', (student_id, course_id)).fetchone()\n        \n        has_manual_override = enrollment and enrollment['manual_progress_override'] is not None\n        \n        # Get total number of quizzes for this course\n        total_quizzes = conn.execute('''\n            SELECT COUNT(*) as count\n            FROM assignments\n            WHERE course_id = ? AND assignment_type = 'quiz' AND is_active = 1\n        ''', (course_id,)).fetchone()['count']\n        \n        if total_quizzes == 0:\n            # No quizzes, set progress to 0\n            auto_progress = 0\n        else:\n            # Get number of submitted quizzes by student\n            submitted_quizzes = conn.execute('''\n                SELECT COUNT(DISTINCT a.id) as count\n                FROM assignments a\n                INNER JOIN assignment_submissions sub ON a.id = sub.assignment_id\n                WHERE a.course_id = ? \n                AND a.assignment_type = 'quiz'\n                AND a.is_active = 1\n                AND sub.student_id = ?\n            ''', (course_id, student_id)).fetchone()['count']\n            \n            # Calculate progress percentage\n            auto_progress = (submitted_quizzes / total_quizzes) * 100\n        \n        # Always update progress_percentage with automatic calculation\n        # This keeps it in sync even when manual override is active\n        conn.execute('''\n            UPDATE enrollments\n            SET progress_percentage = ?\n            WHERE student_id = ? AND course_id = ?\n        ''', (auto_progress, student_id, course_id))\n        \n        conn.commit()\n        \n        # Return manual override if set, otherwise return automatic progress\n        if has_manual_override:\n            return enrollment['manual_progress_override']\n        else:\n            return auto_progress\n        \n    except Exception as e:\n        print(f\"Error updating student progress: {e}\")\n        return 0\n\n# User class for Flask-Login\nclass User(UserMixin):\n    def __init__(self, id, username, email, role, full_name, created_at, active_status=True, \n                 instructor_approval_status='approved', approved_by=None, approved_at=None, profile_picture=None):\n        self.id = id\n        self.username = username\n        self.email = email\n        self.role = role\n        self.full_name = full_name\n        self.created_at = created_at\n        self._is_active = active_status\n        self.instructor_approval_status = instructor_approval_status\n        self.approved_by = approved_by\n        self.approved_at = approved_at\n        self.profile_picture = profile_picture\n\n    def get_id(self):\n        return str(self.id)\n\n    def is_admin(self):\n        return self.role == 'admin'\n    \n    def is_instructor(self):\n        return self.role == 'instructor'\n    \n    def is_student(self):\n        return self.role == 'student'\n    \n    def is_instructor_approved(self):\n        \"\"\"Check if instructor is approved to access instructor features\"\"\"\n        if not self.is_instructor():\n            return True  # Non-instructors don't need approval\n        return self.instructor_approval_status == 'approved'\n    \n    def is_instructor_pending(self):\n        \"\"\"Check if instructor is pending approval\"\"\"\n        return self.is_instructor() and self.instructor_approval_status == 'pending'\n    \n    def is_instructor_rejected(self):\n        \"\"\"Check if instructor was rejected\"\"\"\n        return self.is_instructor() and self.instructor_approval_status == 'rejected'\n\n@login_manager.user_loader\ndef load_user(user_id):\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            user = conn.execute(\n                'SELECT * FROM users WHERE id = ? AND is_active = 1', (user_id,)\n            ).fetchone()\n            conn.close()\n        \n        if user:\n            profile_pic = user['profile_picture'] if 'profile_picture' in user.keys() else None\n            return User(user['id'], user['username'], user['email'], user['role'], \n                       user['full_name'], user['created_at'], user['is_active'],\n                       user['instructor_approval_status'] if user['instructor_approval_status'] else 'approved',\n                       user['approved_by'],\n                       user['approved_at'],\n                       profile_pic)\n    except sqlite3.OperationalError:\n        # Database not yet initialized\n        pass\n    return None\n\n# Role-based access control decorators\ndef admin_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if not current_user.is_authenticated or not current_user.is_admin():\n            flash('Access denied. Admin privileges required.', 'error')\n            return redirect(url_for('dashboard'))\n        return f(*args, **kwargs)\n    return decorated_function\n\ndef instructor_required(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if not current_user.is_authenticated:\n            flash('Access denied. Please log in.', 'error')\n            return redirect(url_for('login'))\n        \n        # Admins always have access to instructor features\n        if current_user.is_admin():\n            return f(*args, **kwargs)\n        \n        # Check if user is instructor\n        if not current_user.is_instructor():\n            flash('Access denied. Instructor privileges required.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Check if instructor is approved\n        if not current_user.is_instructor_approved():\n            flash('Your instructor account is pending approval. Please wait for admin approval.', 'warning')\n            return redirect(url_for('dashboard'))\n        \n        return f(*args, **kwargs)\n    return decorated_function\n\n# Database initialization\ndef init_db():\n    print(\"ðŸ”„ Initializing database...\")\n    with db_lock:\n        try:\n            conn = get_db_connection()\n            \n            # Users table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS users (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    username TEXT UNIQUE NOT NULL,\n                    email TEXT UNIQUE NOT NULL,\n                    password_hash TEXT NOT NULL,\n                    role TEXT NOT NULL DEFAULT 'student',\n                    full_name TEXT NOT NULL,\n                    bio TEXT,\n                    profile_image TEXT,\n                    instructor_approval_status TEXT DEFAULT 'approved',\n                    approved_by INTEGER,\n                    approved_at TIMESTAMP,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    last_login TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (approved_by) REFERENCES users (id)\n                )\n            ''')\n            \n            # Add columns if they don't exist\n            try:\n                conn.execute('ALTER TABLE users ADD COLUMN instructor_approval_status TEXT DEFAULT \"approved\"')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE users ADD COLUMN approved_by INTEGER')\n            except sqlite3.OperationalError:\n                pass\n                \n            try:\n                conn.execute('ALTER TABLE users ADD COLUMN approved_at TIMESTAMP')\n            except sqlite3.OperationalError:\n                pass\n                \n            try:\n                conn.execute('ALTER TABLE courses ADD COLUMN enrollment_key_hash TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE users ADD COLUMN instructor_screenshot TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            # Courses table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS courses (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_code TEXT UNIQUE NOT NULL,\n                    title TEXT NOT NULL,\n                    description TEXT,\n                    syllabus TEXT,\n                    instructor_id INTEGER NOT NULL,\n                    category TEXT,\n                    max_students INTEGER DEFAULT 50,\n                    start_date DATE,\n                    end_date DATE,\n                    enrollment_key_hash TEXT,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (instructor_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # Enrollments table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS enrollments (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    student_id INTEGER NOT NULL,\n                    course_id INTEGER NOT NULL,\n                    status TEXT NOT NULL DEFAULT 'pending',\n                    payment_screenshot TEXT,\n                    enrolled_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    approved_at TIMESTAMP,\n                    progress_percentage REAL DEFAULT 0,\n                    manual_progress_override REAL DEFAULT NULL,\n                    FOREIGN KEY (student_id) REFERENCES users (id),\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    UNIQUE(student_id, course_id)\n                )\n            ''')\n            \n            # Add manual_progress_override column if it doesn't exist\n            try:\n                conn.execute('ALTER TABLE enrollments ADD COLUMN manual_progress_override REAL DEFAULT NULL')\n            except sqlite3.OperationalError:\n                pass\n            \n            # Assignments table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS assignments (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    description TEXT,\n                    instructions TEXT,\n                    due_date DATETIME,\n                    max_points INTEGER DEFAULT 100,\n                    allow_late_submission BOOLEAN DEFAULT 0,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    FOREIGN KEY (course_id) REFERENCES courses (id)\n                )\n            ''')\n            \n            # Assignment submissions table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS assignment_submissions (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    assignment_id INTEGER NOT NULL,\n                    student_id INTEGER NOT NULL,\n                    submission_text TEXT,\n                    file_path TEXT,\n                    submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    grade REAL,\n                    ai_feedback TEXT,\n                    instructor_feedback TEXT,\n                    graded_at TIMESTAMP,\n                    FOREIGN KEY (assignment_id) REFERENCES assignments (id),\n                    FOREIGN KEY (student_id) REFERENCES users (id),\n                    UNIQUE(assignment_id, student_id)\n                )\n            ''')\n            \n            # Quiz questions table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS quiz_questions (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    assignment_id INTEGER NOT NULL,\n                    question_text TEXT NOT NULL,\n                    question_type TEXT NOT NULL DEFAULT 'mcq',\n                    points INTEGER DEFAULT 1,\n                    correct_answer TEXT,\n                    explanation TEXT,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    FOREIGN KEY (assignment_id) REFERENCES assignments (id)\n                )\n            ''')\n            \n            # Question options table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS question_options (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    question_id INTEGER NOT NULL,\n                    option_letter TEXT NOT NULL,\n                    option_text TEXT NOT NULL,\n                    is_correct BOOLEAN DEFAULT 0,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    FOREIGN KEY (question_id) REFERENCES quiz_questions (id)\n                )\n            ''')\n            \n            # Student MCQ answers table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS student_mcq_answers (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    submission_id INTEGER NOT NULL,\n                    question_id INTEGER NOT NULL,\n                    selected_option TEXT,\n                    is_correct BOOLEAN,\n                    points_earned REAL DEFAULT 0,\n                    answered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    FOREIGN KEY (submission_id) REFERENCES assignment_submissions (id),\n                    FOREIGN KEY (question_id) REFERENCES quiz_questions (id),\n                    UNIQUE(submission_id, question_id)\n                )\n            ''')\n            \n            # Forums table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS forums (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    description TEXT,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (course_id) REFERENCES courses (id)\n                )\n            ''')\n            \n            # Forum topics table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS forum_topics (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    forum_id INTEGER NOT NULL,\n                    user_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    content TEXT NOT NULL,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_pinned BOOLEAN DEFAULT 0,\n                    view_count INTEGER DEFAULT 0,\n                    FOREIGN KEY (forum_id) REFERENCES forums (id),\n                    FOREIGN KEY (user_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # Forum replies table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS forum_replies (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    topic_id INTEGER NOT NULL,\n                    user_id INTEGER NOT NULL,\n                    content TEXT NOT NULL,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_ai_generated BOOLEAN DEFAULT 0,\n                    FOREIGN KEY (topic_id) REFERENCES forum_topics (id),\n                    FOREIGN KEY (user_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # Chat messages table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS chat_messages (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER,\n                    sender_id INTEGER NOT NULL,\n                    recipient_id INTEGER,\n                    message TEXT NOT NULL,\n                    message_type TEXT DEFAULT 'text',\n                    file_path TEXT,\n                    file_name TEXT,\n                    file_size INTEGER DEFAULT 0,\n                    is_image BOOLEAN DEFAULT 0,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_read BOOLEAN DEFAULT 0,\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    FOREIGN KEY (sender_id) REFERENCES users (id),\n                    FOREIGN KEY (recipient_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # Direct messages table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS direct_messages (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    sender_id INTEGER NOT NULL,\n                    recipient_id INTEGER NOT NULL,\n                    message TEXT NOT NULL,\n                    message_type TEXT DEFAULT 'text',\n                    file_path TEXT,\n                    file_name TEXT,\n                    is_image BOOLEAN DEFAULT 0,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_read BOOLEAN DEFAULT 0,\n                    FOREIGN KEY (sender_id) REFERENCES users (id),\n                    FOREIGN KEY (recipient_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # File uploads table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS file_uploads (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    uploader_id INTEGER NOT NULL,\n                    file_name TEXT NOT NULL,\n                    file_path TEXT NOT NULL,\n                    file_size INTEGER,\n                    file_type TEXT,\n                    message_id INTEGER,\n                    direct_message_id INTEGER,\n                    forum_reply_id INTEGER,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    FOREIGN KEY (uploader_id) REFERENCES users (id),\n                    FOREIGN KEY (message_id) REFERENCES chat_messages (id),\n                    FOREIGN KEY (direct_message_id) REFERENCES direct_messages (id),\n                    FOREIGN KEY (forum_reply_id) REFERENCES forum_replies (id)\n                )\n            ''')\n            \n            # Notifications table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS notifications (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    user_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    message TEXT NOT NULL,\n                    type TEXT DEFAULT 'info',\n                    related_id INTEGER,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_read BOOLEAN DEFAULT 0,\n                    FOREIGN KEY (user_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # Course resources table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS course_resources (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    description TEXT,\n                    file_path TEXT,\n                    file_type TEXT,\n                    upload_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    uploaded_by INTEGER NOT NULL,\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    FOREIGN KEY (uploaded_by) REFERENCES users (id)\n                )\n            ''')\n            \n            # Course meeting links table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS course_meeting_links (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    meeting_link TEXT NOT NULL,\n                    description TEXT,\n                    scheduled_time TIMESTAMP,\n                    created_by INTEGER NOT NULL,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    FOREIGN KEY (created_by) REFERENCES users (id)\n                )\n            ''')\n            \n            # Course video playlists table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS course_video_playlists (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    video_url TEXT NOT NULL,\n                    description TEXT,\n                    thumbnail_url TEXT,\n                    duration TEXT,\n                    notes_file_path TEXT,\n                    order_index INTEGER DEFAULT 0,\n                    created_by INTEGER NOT NULL,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    FOREIGN KEY (created_by) REFERENCES users (id)\n                )\n            ''')\n            \n            # Add transcript column if needed\n            try:\n                conn.execute('ALTER TABLE course_video_playlists ADD COLUMN transcript_file_path TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            # Student video playlists table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS student_video_playlists (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    student_id INTEGER NOT NULL,\n                    title TEXT NOT NULL,\n                    video_url TEXT NOT NULL,\n                    description TEXT,\n                    thumbnail_url TEXT,\n                    duration TEXT,\n                    order_index INTEGER DEFAULT 0,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_active BOOLEAN DEFAULT 1,\n                    FOREIGN KEY (student_id) REFERENCES users (id)\n                )\n            ''')\n            \n            # AI Notes table\n            conn.execute('''\n                CREATE TABLE IF NOT EXISTS ai_notes (\n                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n                    course_id INTEGER NOT NULL,\n                    topic TEXT NOT NULL,\n                    content TEXT NOT NULL,\n                    pdf_path TEXT,\n                    created_by INTEGER NOT NULL,\n                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    is_instructor_note BOOLEAN DEFAULT 0,\n                    sent_to_students BOOLEAN DEFAULT 0,\n                    FOREIGN KEY (course_id) REFERENCES courses (id),\n                    FOREIGN KEY (created_by) REFERENCES users (id)\n                )\n            ''')\n            \n            # Add media columns to forum_topics if needed\n            try:\n                conn.execute('ALTER TABLE forum_topics ADD COLUMN media_type TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE forum_topics ADD COLUMN media_path TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE forum_topics ADD COLUMN media_filename TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            # Add media columns to forum_replies if needed\n            try:\n                conn.execute('ALTER TABLE forum_replies ADD COLUMN media_type TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE forum_replies ADD COLUMN media_path TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            try:\n                conn.execute('ALTER TABLE forum_replies ADD COLUMN media_filename TEXT')\n            except sqlite3.OperationalError:\n                pass\n            \n            # Create indexes\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_users_email ON users(email)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_users_role ON users(role)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_users_approval_status ON users(instructor_approval_status)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_enrollments_student ON enrollments(student_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_enrollments_course ON enrollments(course_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_assignments_course ON assignments(course_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_submissions_assignment ON assignment_submissions(assignment_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_quiz_questions_assignment ON quiz_questions(assignment_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_question_options_question ON question_options(question_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_student_answers_submission ON student_mcq_answers(submission_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_student_answers_question ON student_mcq_answers(question_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_chat_course ON chat_messages(course_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_notifications_user ON notifications(user_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_meeting_links_course ON course_meeting_links(course_id)')\n            conn.execute('CREATE INDEX IF NOT EXISTS idx_video_playlists_course ON course_video_playlists(course_id)')\n            \n            # Create default admin user\n            admin_exists = conn.execute('SELECT id FROM users WHERE role = \"admin\"').fetchone()\n            if not admin_exists:\n                admin_password = generate_password_hash('admin123')\n                conn.execute('''\n                    INSERT INTO users (username, email, password_hash, role, full_name, bio)\n                    VALUES (?, ?, ?, ?, ?, ?)\n                ''', ('admin', 'admin@learnnest.com', admin_password, 'admin', \n                     'System Administrator', 'Default system administrator account'))\n            \n            conn.commit()\n            conn.close()\n            print(\"âœ… Database initialized successfully!\")\n            return True\n        except Exception as e:\n            print(f\"âŒ Database initialization error: {e}\")\n            import traceback\n            traceback.print_exc()\n            return False\n\n# Routes\n@app.route('/')\ndef index():\n    if current_user.is_authenticated:\n        return redirect(url_for('dashboard'))\n    return redirect(url_for('login'))\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    if current_user.is_authenticated:\n        return redirect(url_for('dashboard'))\n    \n    if request.method == 'POST':\n        # Validate CSRF token\n        csrf_token = request.form.get('csrf_token')\n        if not validate_csrf_token(csrf_token):\n            flash('Invalid security token. Please try again.', 'error')\n            return render_template('auth/login.html')\n            \n        email = request.form['email'].lower().strip()\n        password = request.form['password']\n        remember = bool(request.form.get('remember'))\n        \n        with db_lock:\n            conn = get_db_connection()\n            user = conn.execute(\n                'SELECT * FROM users WHERE email = ? AND is_active = 1', (email,)\n            ).fetchone()\n            conn.close()\n        \n        if user and check_password_hash(user['password_hash'], password):\n            # Update last login\n            with db_lock:\n                conn = get_db_connection()\n                conn.execute(\n                    'UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = ?', (user['id'],)\n                )\n                conn.commit()\n                conn.close()\n            \n            user_obj = User(user['id'], user['username'], user['email'], user['role'], \n                          user['full_name'], user['created_at'], user['is_active'],\n                          user['instructor_approval_status'] if user['instructor_approval_status'] else 'approved',\n                          user['approved_by'],\n                          user['approved_at'])\n            login_user(user_obj, remember=remember)\n            flash(f'Welcome back, {user[\"full_name\"]}!', 'success')\n            \n            next_page = request.args.get('next')\n            return redirect(next_page) if next_page else redirect(url_for('dashboard'))\n        else:\n            flash('Invalid email or password', 'error')\n    \n    return render_template('auth/login.html')\n\n@app.route('/register', methods=['GET', 'POST'])\ndef register():\n    if current_user.is_authenticated:\n        return redirect(url_for('dashboard'))\n    \n    if request.method == 'POST':\n        # Validate CSRF token\n        csrf_token = request.form.get('csrf_token')\n        if not validate_csrf_token(csrf_token):\n            flash('Invalid security token. Please try again.', 'error')\n            return render_template('auth/register.html')\n            \n        username = request.form['username'].strip()\n        email = request.form['email'].lower().strip()\n        password = request.form['password']\n        confirm_password = request.form['confirm_password']\n        full_name = request.form['full_name'].strip()\n        role = request.form.get('role', 'student')\n        \n        # Handle instructor screenshot upload\n        screenshot_filename = None\n        if role == 'instructor' and 'instructor_screenshot' in request.files:\n            screenshot = request.files['instructor_screenshot']\n            if screenshot and screenshot.filename:\n                # Create instructor_screenshots directory if it doesn't exist\n                screenshots_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'instructor_screenshots')\n                os.makedirs(screenshots_dir, exist_ok=True)\n                \n                # Validate file type\n                allowed_extensions = {'png', 'jpg', 'jpeg', 'gif', 'webp'}\n                file_ext = screenshot.filename.rsplit('.', 1)[1].lower() if '.' in screenshot.filename else ''\n                \n                if file_ext not in allowed_extensions:\n                    flash('Invalid file type. Please upload PNG, JPG, JPEG, GIF, or WebP images only.', 'error')\n                    return render_template('auth/register.html')\n                \n                # Validate file size (max 5MB)\n                screenshot.seek(0, 2)  # Seek to end\n                file_size = screenshot.tell()\n                screenshot.seek(0)  # Reset seek position\n                \n                if file_size > 5 * 1024 * 1024:\n                    flash('File size too large. Please upload images smaller than 5MB.', 'error')\n                    return render_template('auth/register.html')\n                \n                # Generate secure filename and save\n                filename = secure_filename(f\"{username}_{datetime.now().strftime('%Y%m%d_%H%M%S')}_{screenshot.filename}\")\n                screenshot_path = os.path.join(screenshots_dir, filename)\n                \n                try:\n                    screenshot.save(screenshot_path)\n                    screenshot_filename = filename\n                except Exception as e:\n                    flash('Error saving screenshot. Please try again.', 'error')\n                    return render_template('auth/register.html')\n        \n        # Validation\n        if password != confirm_password:\n            flash('Passwords do not match', 'error')\n            return render_template('auth/register.html')\n        \n        if len(password) < 6:\n            flash('Password must be at least 6 characters long', 'error')\n            return render_template('auth/register.html')\n        \n        # Validate instructor screenshot\n        if role == 'instructor' and not screenshot_filename:\n            flash('Screenshot upload is required for instructor accounts', 'error')\n            return render_template('auth/register.html')\n        \n        with db_lock:\n            conn = get_db_connection()\n            \n            # Check if user already exists\n            existing_user = conn.execute(\n                'SELECT id FROM users WHERE email = ? OR username = ?', (email, username)\n            ).fetchone()\n            \n            if existing_user:\n                flash('User with this email or username already exists', 'error')\n                conn.close()\n                return render_template('auth/register.html')\n            \n            # Create new user\n            password_hash = generate_password_hash(password)\n            \n            # Set instructor approval status based on role\n            instructor_approval_status = 'pending' if role == 'instructor' else 'approved'\n            \n            conn.execute('''\n                INSERT INTO users (username, email, password_hash, role, full_name, instructor_approval_status, instructor_screenshot)\n                VALUES (?, ?, ?, ?, ?, ?, ?)\n            ''', (username, email, password_hash, role, full_name, instructor_approval_status, screenshot_filename))\n            \n            conn.commit()\n            conn.close()\n        \n        # Flash appropriate message based on role\n        if role == 'instructor':\n            flash('Registration successful! Your instructor account is pending admin approval. You will be notified once approved.', 'info')\n        else:\n            flash('Registration successful! Please log in.', 'success')\n        return redirect(url_for('login'))\n    \n    return render_template('auth/register.html')\n\n@app.route('/logout')\n@login_required\ndef logout():\n    logout_user()\n    flash('You have been logged out successfully.', 'info')\n    return redirect(url_for('login'))\n\n@app.route('/dashboard')\n@login_required\ndef dashboard():\n    with db_lock:\n        conn = get_db_connection()\n        \n        if current_user.is_admin():\n            # Admin dashboard data\n            stats = {\n                'total_users': conn.execute('SELECT COUNT(*) FROM users WHERE is_active = 1').fetchone()[0],\n                'total_students': conn.execute('SELECT COUNT(*) FROM users WHERE role = \"student\" AND is_active = 1').fetchone()[0],\n                'total_courses': conn.execute('SELECT COUNT(*) FROM courses WHERE is_active = 1').fetchone()[0],\n                'total_enrollments': conn.execute('SELECT COUNT(*) FROM enrollments WHERE status = \"approved\"').fetchone()[0],\n                'pending_enrollments': conn.execute('SELECT COUNT(*) FROM enrollments WHERE status = \"pending\"').fetchone()[0],\n                'pending_instructors': conn.execute('SELECT COUNT(*) FROM users WHERE role = \"instructor\" AND instructor_approval_status = \"pending\" AND is_active = 1').fetchone()[0],\n                'total_instructors': conn.execute('SELECT COUNT(*) FROM users WHERE role = \"instructor\" AND is_active = 1').fetchone()[0]\n            }\n            \n            # Recent enrollments\n            recent_enrollments = conn.execute('''\n                SELECT e.*, u.full_name as student_name, c.title as course_title\n                FROM enrollments e\n                JOIN users u ON e.student_id = u.id\n                JOIN courses c ON e.course_id = c.id\n                ORDER BY e.enrolled_at DESC\n                LIMIT 10\n            ''').fetchall()\n            \n            conn.close()\n            return render_template('admin/dashboard.html', stats=stats, recent_enrollments=recent_enrollments)\n        \n        elif current_user.is_instructor() and current_user.is_instructor_approved():\n            # Redirect to dedicated instructor dashboard only if instructor is approved\n            conn.close()\n            return redirect(url_for('instructor_dashboard'))\n        \n        else:\n            # Student dashboard data - Use COALESCE to prioritize manual progress override\n            my_enrollments_raw = conn.execute('''\n                SELECT e.*, c.title, c.course_code, c.description, u.full_name as instructor_name,\n                       COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n                FROM enrollments e\n                JOIN courses c ON e.course_id = c.id\n                JOIN users u ON c.instructor_id = u.id\n                WHERE e.student_id = ?\n                ORDER BY e.enrolled_at DESC\n            ''', (current_user.id,)).fetchall()\n            \n            # Convert Row objects to dictionaries for JSON serialization\n            my_enrollments = [dict(row) for row in my_enrollments_raw]\n            \n            # Available courses (not enrolled)\n            available_courses = conn.execute('''\n                SELECT c.*, u.full_name as instructor_name\n                FROM courses c\n                JOIN users u ON c.instructor_id = u.id\n                LEFT JOIN enrollments e ON c.id = e.course_id AND e.student_id = ?\n                WHERE c.is_active = 1 AND e.id IS NULL\n                ORDER BY c.created_at DESC\n            ''', (current_user.id,)).fetchall()\n            \n            conn.close()\n            return render_template('student/dashboard.html', enrollments=my_enrollments, available_courses=available_courses)\n\n@app.route('/update_profile', methods=['POST'])\n@login_required\ndef update_profile():\n    \"\"\"Update user profile (name and picture)\"\"\"\n    try:\n        full_name = request.form.get('full_name', '').strip()\n        \n        if not full_name:\n            flash('Name cannot be empty.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        with db_lock:\n            conn = get_db_connection()\n            \n            # Update full name\n            conn.execute('''\n                UPDATE users SET full_name = ? WHERE id = ?\n            ''', (full_name, current_user.id))\n            \n            # Handle profile picture upload\n            if 'profile_picture' in request.files:\n                file = request.files['profile_picture']\n                if file and file.filename:\n                    try:\n                        # Validate file type\n                        allowed_extensions = {'png', 'jpg', 'jpeg', 'gif', 'webp'}\n                        filename = secure_filename(file.filename)\n                        file_ext = filename.rsplit('.', 1)[-1].lower() if '.' in filename else ''\n                        \n                        if file_ext not in allowed_extensions:\n                            logging.warning(f\"Invalid file type: {file_ext}\")\n                            conn.close()\n                            flash('Invalid file type. Please upload PNG, JPG, JPEG, GIF, or WebP images only.', 'error')\n                            return redirect(url_for('dashboard'))\n                        \n                        # Create profile pictures directory\n                        profile_pics_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'profile_pictures')\n                        os.makedirs(profile_pics_dir, exist_ok=True)\n                        \n                        # Generate secure filename\n                        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n                        filename = f\"{current_user.id}_{timestamp}_{filename}\"\n                        filepath = os.path.join(profile_pics_dir, filename)\n                        \n                        # Save file\n                        file.save(filepath)\n                        logging.info(f\"Profile picture saved: {filepath}\")\n                        \n                        # Update database with relative path\n                        relative_path = os.path.join('profile_pictures', filename).replace('\\\\', '/')\n                        conn.execute('''\n                            UPDATE users SET profile_picture = ? WHERE id = ?\n                        ''', (relative_path, current_user.id))\n                    except Exception as file_error:\n                        logging.error(f\"Error processing file upload: {file_error}\")\n                        conn.close()\n                        flash('Error processing file upload. Please try again.', 'error')\n                        return redirect(url_for('dashboard'))\n            \n            conn.commit()\n            \n            # Reload the updated user data from database\n            user_data = conn.execute('SELECT * FROM users WHERE id = ?', (current_user.id,)).fetchone()\n            conn.close()\n        \n        # Update current_user object with new data\n        current_user.full_name = full_name\n        if user_data and 'profile_picture' in user_data.keys():\n            current_user.profile_picture = user_data['profile_picture']\n        \n        flash('Profile updated successfully!', 'success')\n        \n    except Exception as e:\n        logging.error(f\"Error updating profile: {e}\")\n        flash('Error updating profile. Please try again.', 'error')\n    \n    return redirect(url_for('dashboard'))\n\n# Admin instructor management routes\n@app.route('/admin/instructors')\n@admin_required\ndef admin_instructors():\n    \"\"\"Main instructor management page\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get all instructors with their approval status\n        instructors_raw = conn.execute('''\n            SELECT u.*, \n                   (SELECT full_name FROM users WHERE id = u.approved_by) as approved_by_name,\n                   (SELECT COUNT(*) FROM courses WHERE instructor_id = u.id AND is_active = 1) as course_count\n            FROM users u\n            WHERE u.role = 'instructor' AND u.is_active = 1\n            ORDER BY \n                CASE u.instructor_approval_status \n                    WHEN 'pending' THEN 1\n                    WHEN 'rejected' THEN 2\n                    WHEN 'approved' THEN 3\n                END,\n                u.created_at DESC\n        ''').fetchall()\n        \n        # Convert Row objects to dictionaries for JSON serialization\n        instructors = [dict(row) for row in instructors_raw]\n        \n        # Get counts for stats\n        stats = {\n            'total_instructors': len(instructors),\n            'pending_instructors': len([i for i in instructors if i['instructor_approval_status'] == 'pending']),\n            'approved_instructors': len([i for i in instructors if i['instructor_approval_status'] == 'approved']),\n            'rejected_instructors': len([i for i in instructors if i['instructor_approval_status'] == 'rejected'])\n        }\n        \n        conn.close()\n    \n    return render_template('admin/instructors.html', instructors=instructors, stats=stats)\n\n@app.route('/admin/instructors/pending')\n@admin_required\ndef admin_instructors_pending():\n    \"\"\"View pending instructor applications\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        pending_instructors_raw = conn.execute('''\n            SELECT u.*\n            FROM users u\n            WHERE u.role = 'instructor' \n              AND u.instructor_approval_status = 'pending' \n              AND u.is_active = 1\n            ORDER BY u.created_at ASC\n        ''').fetchall()\n        \n        # Convert Row objects to dictionaries for JSON serialization\n        pending_instructors = [dict(row) for row in pending_instructors_raw]\n        \n        conn.close()\n    \n    return render_template('admin/instructors.html', \n                         instructors=pending_instructors, \n                         view_type='pending',\n                         stats={'pending_instructors': len(pending_instructors)})\n\n@app.route('/admin/instructors/approve/<int:instructor_id>', methods=['POST'])\n@admin_required\ndef admin_approve_instructor(instructor_id):\n    \"\"\"Approve an instructor\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify instructor exists and is pending\n        instructor = conn.execute('''\n            SELECT * FROM users \n            WHERE id = ? AND role = 'instructor' AND instructor_approval_status = 'pending'\n        ''', (instructor_id,)).fetchone()\n        \n        if not instructor:\n            flash('Instructor not found or already processed.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        # Approve the instructor\n        conn.execute('''\n            UPDATE users \n            SET instructor_approval_status = 'approved',\n                approved_by = ?,\n                approved_at = CURRENT_TIMESTAMP\n            WHERE id = ?\n        ''', (current_user.id, instructor_id))\n        \n        # Create notification for the instructor\n        conn.execute('''\n            INSERT INTO notifications (user_id, title, message, type)\n            VALUES (?, ?, ?, ?)\n        ''', (instructor_id, \n              'Instructor Account Approved',\n              'Congratulations! Your instructor account has been approved. You can now create courses and access all instructor features.',\n              'success'))\n        \n        conn.commit()\n        conn.close()\n    \n    flash(f'Instructor {instructor[\"full_name\"]} has been approved successfully.', 'success')\n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/instructors/reject/<int:instructor_id>', methods=['POST'])\n@admin_required\ndef admin_reject_instructor(instructor_id):\n    \"\"\"Reject an instructor\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify instructor exists and is pending\n        instructor = conn.execute('''\n            SELECT * FROM users \n            WHERE id = ? AND role = 'instructor' AND instructor_approval_status = 'pending'\n        ''', (instructor_id,)).fetchone()\n        \n        if not instructor:\n            flash('Instructor not found or already processed.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        # Reject the instructor\n        conn.execute('''\n            UPDATE users \n            SET instructor_approval_status = 'rejected',\n                approved_by = ?,\n                approved_at = CURRENT_TIMESTAMP\n            WHERE id = ?\n        ''', (current_user.id, instructor_id))\n        \n        # Create notification for the instructor\n        conn.execute('''\n            INSERT INTO notifications (user_id, title, message, type)\n            VALUES (?, ?, ?, ?)\n        ''', (instructor_id,\n              'Instructor Application Rejected',\n              'We regret to inform you that your instructor application has been rejected. Please contact the administrator for more information.',\n              'error'))\n        \n        conn.commit()\n        conn.close()\n    \n    flash(f'Instructor {instructor[\"full_name\"]} has been rejected.', 'warning')\n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/instructors/create', methods=['POST'])\n@admin_required\ndef admin_create_instructor():\n    \"\"\"Create a new instructor account\"\"\"\n    username = request.form.get('username', '').strip().lower()\n    email = request.form.get('email', '').strip().lower()\n    full_name = request.form.get('full_name', '').strip()\n    password = request.form.get('password', '').strip()\n    \n    if not all([username, email, full_name, password]):\n        flash('All fields are required.', 'error')\n        return redirect(url_for('admin_instructors'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Check if user already exists\n        existing = conn.execute(\n            'SELECT id FROM users WHERE username = ? OR email = ?',\n            (username, email)\n        ).fetchone()\n        \n        if existing:\n            flash('Username or email already exists.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        try:\n            conn.execute('''\n                INSERT INTO users (username, email, password, full_name, role, instructor_approval_status, is_active)\n                VALUES (?, ?, ?, ?, 'instructor', 'approved', 1)\n            ''', (username, email, generate_password_hash(password), full_name))\n            \n            conn.commit()\n            flash(f'Instructor {full_name} created successfully!', 'success')\n        except Exception as e:\n            conn.rollback()\n            flash('Error creating instructor. Please try again.', 'error')\n        finally:\n            conn.close()\n    \n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/instructors/<int:instructor_id>/edit', methods=['POST'])\n@admin_required\ndef admin_edit_instructor(instructor_id):\n    \"\"\"Edit instructor details\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        instructor = conn.execute(\n            'SELECT * FROM users WHERE id = ? AND role = \"instructor\"',\n            (instructor_id,)\n        ).fetchone()\n        \n        if not instructor:\n            flash('Instructor not found.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        email = request.form.get('email', '').strip().lower()\n        full_name = request.form.get('full_name', '').strip()\n        \n        # Check if new email is already taken\n        if email != instructor['email']:\n            existing = conn.execute(\n                'SELECT id FROM users WHERE email = ? AND id != ?',\n                (email, instructor_id)\n            ).fetchone()\n            if existing:\n                flash('Email already in use.', 'error')\n                conn.close()\n                return redirect(url_for('admin_instructors'))\n        \n        try:\n            conn.execute('''\n                UPDATE users \n                SET email = ?, full_name = ?\n                WHERE id = ?\n            ''', (email, full_name, instructor_id))\n            \n            conn.commit()\n            flash(f'Instructor {full_name} updated successfully!', 'success')\n        except Exception as e:\n            conn.rollback()\n            flash('Error updating instructor.', 'error')\n        finally:\n            conn.close()\n    \n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/instructors/<int:instructor_id>/delete', methods=['POST'])\n@admin_required\ndef admin_delete_instructor(instructor_id):\n    \"\"\"Delete (deactivate) an instructor\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        instructor = conn.execute(\n            'SELECT * FROM users WHERE id = ? AND role = \"instructor\"',\n            (instructor_id,)\n        ).fetchone()\n        \n        if not instructor:\n            flash('Instructor not found.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        try:\n            conn.execute(\n                'UPDATE users SET is_active = 0 WHERE id = ?',\n                (instructor_id,)\n            )\n            conn.commit()\n            flash(f'Instructor {instructor[\"full_name\"]} has been removed.', 'success')\n        except Exception as e:\n            conn.rollback()\n            flash('Error removing instructor.', 'error')\n        finally:\n            conn.close()\n    \n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/instructors/<int:instructor_id>/toggle-block', methods=['POST'])\n@admin_required\ndef admin_toggle_instructor_block(instructor_id):\n    \"\"\"Block or unblock an instructor\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        instructor = conn.execute(\n            'SELECT * FROM users WHERE id = ? AND role = \"instructor\"',\n            (instructor_id,)\n        ).fetchone()\n        \n        if not instructor:\n            flash('Instructor not found.', 'error')\n            conn.close()\n            return redirect(url_for('admin_instructors'))\n        \n        new_status = 0 if instructor['is_active'] else 1\n        action = 'unblocked' if new_status else 'blocked'\n        \n        try:\n            conn.execute(\n                'UPDATE users SET is_active = ? WHERE id = ?',\n                (new_status, instructor_id)\n            )\n            conn.commit()\n            flash(f'Instructor {instructor[\"full_name\"]} has been {action}.', 'success')\n        except Exception as e:\n            conn.rollback()\n            flash(f'Error {action} instructor.', 'error')\n        finally:\n            conn.close()\n    \n    return redirect(url_for('admin_instructors'))\n\n@app.route('/admin/students')\n@login_required\n@admin_required\ndef admin_students():\n    \"\"\"View all students\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            students_raw = conn.execute('''\n                SELECT u.*, COUNT(DISTINCT e.id) as enrollment_count\n                FROM users u\n                LEFT JOIN enrollments e ON u.id = e.student_id AND e.status = 'approved'\n                WHERE u.role = 'student'\n                GROUP BY u.id\n                ORDER BY u.created_at DESC\n            ''').fetchall()\n            \n            # Convert Row objects to dictionaries for JSON serialization\n            students = [dict(row) for row in students_raw]\n            conn.close()\n        \n        return render_template('admin/students.html', students=students)\n    except Exception as e:\n        logging.error(f\"Error fetching students: {e}\")\n        flash('Error loading students', 'error')\n        return redirect(url_for('dashboard'))\n\n@app.route('/admin/student/<int:student_id>/enrollments', methods=['GET'])\n@admin_required\ndef admin_student_enrollments(student_id):\n    \"\"\"Get student's course enrollments for viewing\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            enrollments_raw = conn.execute('''\n                SELECT e.id, e.status, e.enrolled_at, e.progress_percentage,\n                       c.title, c.course_code, u.full_name as instructor_name\n                FROM enrollments e\n                JOIN courses c ON e.course_id = c.id\n                JOIN users u ON c.instructor_id = u.id\n                WHERE e.student_id = ?\n                ORDER BY e.enrolled_at DESC\n            ''', (student_id,)).fetchall()\n            \n            enrollments = [dict(row) for row in enrollments_raw]\n            conn.close()\n        \n        return jsonify({'success': True, 'enrollments': enrollments})\n    except Exception as e:\n        logging.error(f\"Error fetching enrollments: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n@app.route('/admin/students/<int:student_id>/delete', methods=['POST'])\n@login_required\n@admin_required\ndef admin_delete_student(student_id):\n    \"\"\"Delete a student account\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            student = conn.execute('SELECT * FROM users WHERE id = ? AND role = \"student\"', (student_id,)).fetchone()\n            \n            if not student:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Student not found'}), 404\n            \n            # Delete student's enrollments\n            conn.execute('DELETE FROM enrollments WHERE student_id = ?', (student_id,))\n            \n            # Delete student's notes\n            conn.execute('DELETE FROM student_notes WHERE student_id = ?', (student_id,))\n            \n            # Delete student account\n            conn.execute('DELETE FROM users WHERE id = ?', (student_id,))\n            conn.commit()\n            conn.close()\n            \n        return jsonify({'success': True, 'message': 'Student deleted successfully'})\n    except Exception as e:\n        logging.error(f\"Error deleting student: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n@app.route('/admin/students/<int:student_id>/toggle-block', methods=['POST'])\n@login_required\n@admin_required\ndef admin_toggle_student_block(student_id):\n    \"\"\"Toggle student block status\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            student = conn.execute('SELECT * FROM users WHERE id = ? AND role = \"student\"', (student_id,)).fetchone()\n            \n            if not student:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Student not found'}), 404\n            \n            # Toggle is_active status\n            new_status = 0 if student['is_active'] else 1\n            conn.execute('UPDATE users SET is_active = ? WHERE id = ?', (new_status, student_id))\n            conn.commit()\n            conn.close()\n            \n        return jsonify({'success': True, 'message': f'Student {\"unblocked\" if new_status else \"blocked\"} successfully'})\n    except Exception as e:\n        logging.error(f\"Error toggling student block: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n# INSTRUCTOR ROUTES\n@app.route('/instructor/dashboard')\n@instructor_required\ndef instructor_dashboard():\n    \"\"\"Enhanced instructor dashboard with course management\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # My courses\n        my_courses = conn.execute('''\n            SELECT c.*, \n                   COUNT(CASE WHEN e.status = 'approved' THEN 1 END) as approved_count,\n                   COUNT(CASE WHEN e.status = 'pending' THEN 1 END) as pending_count,\n                   COUNT(e.id) as total_enrollments\n            FROM courses c\n            LEFT JOIN enrollments e ON c.id = e.course_id\n            WHERE c.instructor_id = ? AND c.is_active = 1\n            GROUP BY c.id\n            ORDER BY c.created_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Pending enrollments for all my courses\n        pending_enrollments = conn.execute('''\n            SELECT e.*, u.full_name as student_name, u.email as student_email, \n                   c.title as course_title, c.course_code\n            FROM enrollments e\n            JOIN users u ON e.student_id = u.id\n            JOIN courses c ON e.course_id = c.id\n            WHERE c.instructor_id = ? AND e.status = 'pending'\n            ORDER BY e.enrolled_at ASC\n        ''', (current_user.id,)).fetchall()\n        \n        # Statistics\n        stats = {\n            'total_courses': len(my_courses),\n            'total_students': sum([course['approved_count'] for course in my_courses]),\n            'pending_enrollments': len(pending_enrollments),\n            'active_courses': len([c for c in my_courses if c['approved_count'] > 0])\n        }\n        \n        conn.close()\n    \n    return render_template('instructor/dashboard.html', \n                         courses=my_courses, \n                         pending_enrollments=pending_enrollments,\n                         stats=stats)\n\n@app.route('/instructor/courses/<int:course_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_course(course_id):\n    \"\"\"Delete a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ?\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        try:\n            # Delete related data - only from tables that exist\n            conn.execute('DELETE FROM enrollments WHERE course_id = ?', (course_id,))\n            \n            # Try to delete from optional tables if they exist\n            try:\n                conn.execute('DELETE FROM course_video_playlists WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            try:\n                conn.execute('DELETE FROM course_resources WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            try:\n                conn.execute('DELETE FROM course_meeting_links WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            try:\n                conn.execute('DELETE FROM quizzes WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            try:\n                conn.execute('DELETE FROM ai_notes WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            try:\n                conn.execute('DELETE FROM discussion_forums WHERE course_id = ?', (course_id,))\n            except:\n                pass\n            \n            # Delete the course itself\n            conn.execute('DELETE FROM courses WHERE id = ?', (course_id,))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Course \"{course[\"title\"]}\" has been deleted successfully.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            logging.error(f\"Error deleting course: {e}\")\n            flash('Error deleting course. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_courses'))\n\n\n@app.route('/instructor/courses')\n@instructor_required\ndef instructor_courses():\n    \"\"\"View and manage all instructor courses\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        courses = conn.execute('''\n            SELECT c.*, \n                   COUNT(CASE WHEN e.status = 'approved' THEN 1 END) as approved_count,\n                   COUNT(CASE WHEN e.status = 'pending' THEN 1 END) as pending_count\n            FROM courses c\n            LEFT JOIN enrollments e ON c.id = e.course_id\n            WHERE c.instructor_id = ? AND c.is_active = 1\n            GROUP BY c.id\n            ORDER BY c.created_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Fetch AI Notes PDFs for each course\n        courses_list = []\n        for course in courses:\n            course_dict = dict(course)\n            ai_notes = conn.execute('''\n                SELECT * FROM ai_notes \n                WHERE course_id = ? AND created_by = ? AND is_instructor_note = 1 AND pdf_path IS NOT NULL\n                ORDER BY created_at DESC LIMIT 5\n            ''', (course['id'], current_user.id)).fetchall()\n            course_dict['ai_notes'] = ai_notes\n            courses_list.append(course_dict)\n        \n        conn.close()\n    \n    return render_template('instructor/courses.html', courses=courses_list)\n\n@app.route('/instructor/courses/create', methods=['GET', 'POST'])\n@instructor_required\ndef instructor_create_course():\n    \"\"\"Create a new course with enrollment key\"\"\"\n    if request.method == 'POST':\n        # Get and validate required fields\n        course_code = request.form.get('course_code', '').strip().upper()\n        title = request.form.get('title', '').strip()\n        enrollment_key = request.form.get('enrollment_key', '').strip()\n        \n        # Validate required fields\n        if not course_code:\n            flash('Course Code is required.', 'error')\n            return render_template('instructor/create_course.html')\n        if not title:\n            flash('Course Title is required.', 'error')\n            return render_template('instructor/create_course.html')\n        if not enrollment_key:\n            flash('Enrollment Key is required.', 'error')\n            return render_template('instructor/create_course.html')\n        \n        # Get optional fields\n        description = request.form.get('description', '').strip()\n        syllabus = request.form.get('syllabus', '').strip()\n        category = request.form.get('category', '').strip()\n        max_students = int(request.form.get('max_students', 50))\n        start_date = request.form.get('start_date') or None\n        end_date = request.form.get('end_date') or None\n        \n        # Validate enrollment key\n        if len(enrollment_key) < 6:\n            flash('Enrollment key must be at least 6 characters long.', 'error')\n            return render_template('instructor/create_course.html')\n        \n        # Hash the enrollment key for security\n        enrollment_key_hash = generate_password_hash(enrollment_key)\n        \n        with db_lock:\n            conn = get_db_connection()\n            \n            # Check if course code already exists\n            existing_course = conn.execute(\n                'SELECT id FROM courses WHERE course_code = ?', (course_code,)\n            ).fetchone()\n            \n            if existing_course:\n                flash('Course code already exists. Please choose a different one.', 'error')\n                conn.close()\n                return render_template('instructor/create_course.html')\n            \n            try:\n                conn.execute('''\n                    INSERT INTO courses (\n                        course_code, title, description, syllabus, instructor_id, \n                        category, max_students, start_date, end_date, enrollment_key_hash\n                    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n                ''', (course_code, title, description, syllabus, current_user.id,\n                     category, max_students, start_date, end_date, enrollment_key_hash))\n                \n                conn.commit()\n                conn.close()\n                \n                flash(f'Course \"{title}\" created successfully!', 'success')\n                return redirect(url_for('instructor_courses'))\n                \n            except Exception as e:\n                conn.rollback()\n                conn.close()\n                flash('Error creating course. Please try again.', 'error')\n    \n    return render_template('instructor/create_course.html')\n\n@app.route('/instructor/courses/edit/<int:course_id>', methods=['GET', 'POST'])\n@instructor_required\ndef instructor_edit_course(course_id):\n    \"\"\"Edit an existing course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to current instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        if request.method == 'POST':\n            title = request.form['title'].strip()\n            description = request.form.get('description', '').strip()\n            syllabus = request.form.get('syllabus', '').strip()\n            category = request.form.get('category', '').strip()\n            max_students = int(request.form.get('max_students', 50))\n            start_date = request.form.get('start_date') or None\n            end_date = request.form.get('end_date') or None\n            \n            # Handle enrollment key update\n            enrollment_key = request.form.get('enrollment_key', '').strip()\n            if enrollment_key:\n                if len(enrollment_key) < 6:\n                    flash('Enrollment key must be at least 6 characters long.', 'error')\n                    conn.close()\n                    return render_template('instructor/edit_course.html', course=course)\n                enrollment_key_hash = generate_password_hash(enrollment_key)\n            else:\n                enrollment_key_hash = course['enrollment_key_hash']  # Keep existing\n            \n            try:\n                conn.execute('''\n                    UPDATE courses \n                    SET title = ?, description = ?, syllabus = ?, category = ?, \n                        max_students = ?, start_date = ?, end_date = ?, enrollment_key_hash = ?\n                    WHERE id = ?\n                ''', (title, description, syllabus, category, max_students, \n                     start_date, end_date, enrollment_key_hash, course_id))\n                \n                conn.commit()\n                conn.close()\n                \n                flash(f'Course \"{title}\" updated successfully!', 'success')\n                return redirect(url_for('instructor_courses'))\n                \n            except Exception as e:\n                conn.rollback()\n                conn.close()\n                flash('Error updating course. Please try again.', 'error')\n        \n        conn.close()\n    \n    return render_template('instructor/edit_course.html', course=course)\n\n@app.route('/instructor/enrollments')\n@instructor_required \ndef instructor_enrollments():\n    \"\"\"View all student enrollments for instructor's courses\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        enrollments = conn.execute('''\n            SELECT e.*, u.full_name as student_name, u.email as student_email,\n                   c.title as course_title, c.course_code,\n                   COALESCE(e.progress_percentage, 0) as progress_percentage\n            FROM enrollments e\n            JOIN users u ON e.student_id = u.id\n            JOIN courses c ON e.course_id = c.id\n            WHERE c.instructor_id = ?\n            ORDER BY \n                CASE e.status \n                    WHEN 'pending' THEN 1\n                    WHEN 'approved' THEN 2\n                    WHEN 'rejected' THEN 3\n                END,\n                e.enrolled_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Statistics\n        stats = {\n            'total_enrollments': len(enrollments),\n            'pending_enrollments': len([e for e in enrollments if e['status'] == 'pending']),\n            'approved_enrollments': len([e for e in enrollments if e['status'] == 'approved']),\n            'rejected_enrollments': len([e for e in enrollments if e['status'] == 'rejected'])\n        }\n        \n        conn.close()\n    \n    return render_template('instructor/enrollments.html', enrollments=enrollments, stats=stats)\n\n@app.route('/instructor/enrollments/approve/<int:enrollment_id>', methods=['POST'])\n@instructor_required\ndef instructor_approve_enrollment(enrollment_id):\n    \"\"\"Approve a student enrollment\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify enrollment belongs to instructor's course and is pending\n        enrollment = conn.execute('''\n            SELECT e.*, c.title as course_title, u.full_name as student_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON e.student_id = u.id\n            WHERE e.id = ? AND c.instructor_id = ? AND e.status = 'pending'\n        ''', (enrollment_id, current_user.id)).fetchone()\n        \n        if not enrollment:\n            flash('Enrollment not found or already processed.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_enrollments'))\n        \n        try:\n            # Approve the enrollment\n            conn.execute('''\n                UPDATE enrollments \n                SET status = 'approved', approved_at = CURRENT_TIMESTAMP\n                WHERE id = ?\n            ''', (enrollment_id,))\n            \n            # Create notification for the student\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (enrollment['student_id'],\n                  'Enrollment Approved',\n                  f'Great news! Your enrollment in \"{enrollment[\"course_title\"]}\" has been approved. You now have full access to the course.',\n                  'success',\n                  enrollment['course_id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Approved enrollment for {enrollment[\"student_name\"]} in {enrollment[\"course_title\"]}.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error approving enrollment. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_enrollments'))\n\n@app.route('/instructor/enrollments/reject/<int:enrollment_id>', methods=['POST'])\n@instructor_required\ndef instructor_reject_enrollment(enrollment_id):\n    \"\"\"Reject a student enrollment\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify enrollment belongs to instructor's course and is pending\n        enrollment = conn.execute('''\n            SELECT e.*, c.title as course_title, u.full_name as student_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON e.student_id = u.id\n            WHERE e.id = ? AND c.instructor_id = ? AND e.status = 'pending'\n        ''', (enrollment_id, current_user.id)).fetchone()\n        \n        if not enrollment:\n            flash('Enrollment not found or already processed.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_enrollments'))\n        \n        try:\n            # Reject the enrollment\n            conn.execute('''\n                UPDATE enrollments \n                SET status = 'rejected'\n                WHERE id = ?\n            ''', (enrollment_id,))\n            \n            # Create notification for the student\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (enrollment['student_id'],\n                  'Enrollment Not Approved',\n                  f'Your enrollment request for \"{enrollment[\"course_title\"]}\" was not approved. Please contact the instructor for more information.',\n                  'warning',\n                  enrollment['course_id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Rejected enrollment for {enrollment[\"student_name\"]} in {enrollment[\"course_title\"]}.', 'warning')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error rejecting enrollment. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_enrollments'))\n\n\n@app.route('/instructor/enrollments/block/<int:enrollment_id>', methods=['POST'])\n@instructor_required\ndef instructor_block_student(enrollment_id):\n    \"\"\"Block a student from a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify enrollment belongs to instructor's course and is approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.title as course_title, u.full_name as student_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON e.student_id = u.id\n            WHERE e.id = ? AND c.instructor_id = ? AND e.status = 'approved'\n        ''', (enrollment_id, current_user.id)).fetchone()\n        \n        if not enrollment:\n            flash('Enrollment not found or cannot be blocked.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_enrollments'))\n        \n        try:\n            # Block the enrollment\n            conn.execute('''\n                UPDATE enrollments \n                SET status = 'blocked'\n                WHERE id = ?\n            ''', (enrollment_id,))\n            \n            # Create notification for the student\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (enrollment['student_id'],\n                  'Course Access Blocked',\n                  f'Your access to \"{enrollment[\"course_title\"]}\" has been blocked by the instructor.',\n                  'warning',\n                  enrollment['course_id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Blocked {enrollment[\"student_name\"]} from {enrollment[\"course_title\"]}.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error blocking student. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_enrollments'))\n\n\n@app.route('/instructor/enrollments/remove/<int:enrollment_id>', methods=['POST'])\n@instructor_required\ndef instructor_remove_student(enrollment_id):\n    \"\"\"Remove a student from a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify enrollment belongs to instructor's course and is approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.title as course_title, u.full_name as student_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON e.student_id = u.id\n            WHERE e.id = ? AND c.instructor_id = ? AND e.status = 'approved'\n        ''', (enrollment_id, current_user.id)).fetchone()\n        \n        if not enrollment:\n            flash('Enrollment not found or cannot be removed.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_enrollments'))\n        \n        try:\n            # Delete the enrollment\n            conn.execute('DELETE FROM enrollments WHERE id = ?', (enrollment_id,))\n            \n            # Create notification for the student\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (enrollment['student_id'],\n                  'Removed from Course',\n                  f'You have been removed from \"{enrollment[\"course_title\"]}\" by the instructor.',\n                  'warning',\n                  enrollment['course_id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Removed {enrollment[\"student_name\"]} from {enrollment[\"course_title\"]}.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error removing student. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_enrollments'))\n\n\n@app.route('/instructor/enrollments/unblock/<int:enrollment_id>', methods=['POST'])\n@instructor_required\ndef instructor_unblock_student(enrollment_id):\n    \"\"\"Unblock a student from a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify enrollment belongs to instructor's course and is blocked\n        enrollment = conn.execute('''\n            SELECT e.*, c.title as course_title, u.full_name as student_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON e.student_id = u.id\n            WHERE e.id = ? AND c.instructor_id = ? AND e.status = 'blocked'\n        ''', (enrollment_id, current_user.id)).fetchone()\n        \n        if not enrollment:\n            flash('Enrollment not found or cannot be unblocked.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_enrollments'))\n        \n        try:\n            # Unblock the enrollment\n            conn.execute('''\n                UPDATE enrollments \n                SET status = 'approved'\n                WHERE id = ?\n            ''', (enrollment_id,))\n            \n            # Create notification for the student\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (enrollment['student_id'],\n                  'Course Access Restored',\n                  f'Your access to \"{enrollment[\"course_title\"]}\" has been restored by the instructor.',\n                  'success',\n                  enrollment['course_id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Unblocked {enrollment[\"student_name\"]} for {enrollment[\"course_title\"]}.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error unblocking student. Please try again.', 'error')\n    \n    return redirect(url_for('instructor_enrollments'))\n\n# STUDENT PROGRESS MANAGEMENT ROUTES\n@app.route('/instructor/courses/<int:course_id>/students')\n@instructor_required\ndef instructor_course_students(course_id):\n    \"\"\"View and manage student progress for a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get all students enrolled in the course with their progress\n        students = conn.execute('''\n            SELECT \n                e.id as enrollment_id,\n                e.student_id,\n                u.full_name as student_name,\n                u.email as student_email,\n                e.status,\n                e.enrolled_at,\n                e.progress_percentage,\n                e.manual_progress_override,\n                COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n            FROM enrollments e\n            JOIN users u ON e.student_id = u.id\n            WHERE e.course_id = ? AND e.status = 'approved'\n            ORDER BY u.full_name\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/course_students.html', course=course, students=students)\n\n@app.route('/instructor/courses/<int:course_id>/set-progress-bulk', methods=['POST'])\n@instructor_required\ndef instructor_set_progress_bulk(course_id):\n    \"\"\"Set manual progress override for all students in a course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ?\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            conn.close()\n            return jsonify({'success': False, 'error': 'Course not found or access denied'}), 403\n        \n        # Get progress value from request\n        progress = request.form.get('progress')\n        \n        if progress is None or progress == '':\n            conn.close()\n            return jsonify({'success': False, 'error': 'Please enter a progress value'}), 400\n        \n        # Validate progress value\n        try:\n            progress = float(progress)\n            if progress < 0 or progress > 100:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Progress must be between 0 and 100'}), 400\n        except ValueError:\n            conn.close()\n            return jsonify({'success': False, 'error': 'Invalid progress value'}), 400\n        \n        # Get all students in the course\n        try:\n            students = conn.execute('''\n                SELECT e.student_id, u.full_name\n                FROM enrollments e\n                JOIN users u ON e.student_id = u.id\n                WHERE e.course_id = ? AND e.status = 'approved'\n            ''', (course_id,)).fetchall()\n            \n            # Update progress for all students\n            for student in students:\n                conn.execute('''\n                    UPDATE enrollments\n                    SET manual_progress_override = ?, progress_percentage = ?\n                    WHERE course_id = ? AND student_id = ?\n                ''', (progress, progress, course_id, student['student_id']))\n                \n                # Send notification to each student\n                send_notification(\n                    student['student_id'],\n                    'Course Progress Updated',\n                    f'Your instructor has updated your progress in \"{course[\"title\"]}\" to {progress:.0f}%',\n                    'info',\n                    course_id\n                )\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({\n                'success': True, \n                'message': f'Progress set to {progress:.0f}% for all {len(students)} students',\n                'count': len(students)\n            })\n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            return jsonify({'success': False, 'error': str(e)}), 500\n\n@app.route('/instructor/courses/<int:course_id>/students/<int:student_id>/set-progress', methods=['POST'])\n@instructor_required\ndef instructor_set_student_progress(course_id, student_id):\n    \"\"\"Set manual progress override for a student\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ?\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            conn.close()\n            return jsonify({'success': False, 'error': 'Course not found or access denied'}), 403\n        \n        # Get progress value from request\n        progress = request.form.get('progress')\n        \n        if progress is None or progress == '':\n            # Clear manual override (reset to automatic calculation)\n            try:\n                conn.execute('''\n                    UPDATE enrollments\n                    SET manual_progress_override = NULL\n                    WHERE course_id = ? AND student_id = ?\n                ''', (course_id, student_id))\n                conn.commit()\n                \n                # Immediately recalculate automatic progress to get current quiz-based progress\n                auto_progress = update_student_progress(conn, student_id, course_id)\n                \n                # Get student info for notification\n                student = conn.execute('SELECT full_name FROM users WHERE id = ?', (student_id,)).fetchone()\n                \n                # Send notification to student\n                send_notification(\n                    student_id,\n                    'Course Progress Updated',\n                    f'Your progress in \"{course[\"title\"]}\" has been reset to automatic tracking ({auto_progress:.0f}%)',\n                    'info',\n                    course_id\n                )\n                \n                conn.close()\n                return jsonify({\n                    'success': True, \n                    'message': f'Manual progress cleared. Automatic progress is {auto_progress:.0f}%',\n                    'progress': auto_progress,\n                    'is_manual': False\n                })\n            except Exception as e:\n                conn.rollback()\n                conn.close()\n                return jsonify({'success': False, 'error': str(e)}), 500\n        \n        # Validate progress value\n        try:\n            progress = float(progress)\n            if progress < 0 or progress > 100:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Progress must be between 0 and 100'}), 400\n        except ValueError:\n            conn.close()\n            return jsonify({'success': False, 'error': 'Invalid progress value'}), 400\n        \n        # Set manual progress override\n        try:\n            conn.execute('''\n                UPDATE enrollments\n                SET manual_progress_override = ?, progress_percentage = ?\n                WHERE course_id = ? AND student_id = ?\n            ''', (progress, progress, course_id, student_id))\n            \n            # Get student info for notification\n            student = conn.execute('SELECT full_name FROM users WHERE id = ?', (student_id,)).fetchone()\n            \n            # Send notification to student\n            send_notification(\n                student_id,\n                'Course Progress Updated',\n                f'Your instructor has updated your progress in \"{course[\"title\"]}\" to {progress:.0f}%',\n                'info',\n                course_id\n            )\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({\n                'success': True, \n                'message': f'Progress set to {progress:.0f}% for {student[\"full_name\"]}',\n                'progress': progress,\n                'is_manual': True\n            })\n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            return jsonify({'success': False, 'error': str(e)}), 500\n\n# COURSE CONTENT MANAGEMENT ROUTES\n@app.route('/instructor/courses/<int:course_id>/content')\n@instructor_required\ndef instructor_course_content(course_id):\n    \"\"\"Manage course content - videos, notes, resources\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get course resources\n        resources = conn.execute('''\n            SELECT * FROM course_resources \n            WHERE course_id = ?\n            ORDER BY upload_date DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get meeting links\n        meeting_links = conn.execute('''\n            SELECT * FROM course_meeting_links \n            WHERE course_id = ? AND is_active = 1\n            ORDER BY created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get video playlist\n        video_playlist = conn.execute('''\n            SELECT * FROM course_video_playlists \n            WHERE course_id = ? AND is_active = 1\n            ORDER BY order_index ASC\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/course_content.html', course=course, resources=resources, \n                         meeting_links=meeting_links, video_playlist=video_playlist)\n\n@app.route('/instructor/courses/<int:course_id>/content/upload', methods=['POST'])\n@instructor_required\ndef instructor_upload_content(course_id):\n    \"\"\"Upload course content - videos, notes, resources\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        description = request.form.get('description', '').strip()\n        content_type = request.form.get('content_type', 'document')\n        \n        if 'file' in request.files:\n            file = request.files['file']\n            if file and file.filename:\n                filename = secure_filename(file.filename)\n                file_path = os.path.join(app.config['UPLOAD_FOLDER'], 'resources', f\"{course_id}_{uuid.uuid4().hex}_{filename}\")\n                file.save(file_path)\n                \n                try:\n                    conn.execute('''\n                        INSERT INTO course_resources (course_id, title, description, file_path, file_type, uploaded_by)\n                        VALUES (?, ?, ?, ?, ?, ?)\n                    ''', (course_id, title, description, file_path, content_type, current_user.id))\n                    \n                    conn.commit()\n                    flash(f'Content \"{title}\" uploaded successfully!', 'success')\n                    \n                except Exception as e:\n                    conn.rollback()\n                    flash('Error uploading content. Please try again.', 'error')\n        else:\n            flash('No file selected for upload.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n# MEETING LINKS MANAGEMENT ROUTES\n@app.route('/instructor/courses/<int:course_id>/meeting-links/add', methods=['POST'])\n@instructor_required\ndef instructor_add_meeting_link(course_id):\n    \"\"\"Add a meeting link to the course\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        meeting_link = request.form.get('meeting_link', '').strip()\n        description = request.form.get('description', '').strip()\n        scheduled_time = request.form.get('scheduled_time') or None\n        \n        if not title or not meeting_link:\n            flash('Meeting title and link are required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_content', course_id=course_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO course_meeting_links (course_id, title, meeting_link, description, scheduled_time, created_by)\n                VALUES (?, ?, ?, ?, ?, ?)\n            ''', (course_id, title, meeting_link, description, scheduled_time, current_user.id))\n            \n            conn.commit()\n            flash(f'Meeting link \"{title}\" added successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error adding meeting link. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n@app.route('/instructor/courses/<int:course_id>/meeting-links/<int:link_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_meeting_link(course_id, link_id):\n    \"\"\"Delete a meeting link\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        try:\n            conn.execute('''\n                DELETE FROM course_meeting_links \n                WHERE id = ? AND course_id = ? AND created_by = ?\n            ''', (link_id, course_id, current_user.id))\n            \n            conn.commit()\n            flash('Meeting link deleted successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error deleting meeting link. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n# VIDEO PLAYLIST MANAGEMENT ROUTES\n@app.route('/instructor/courses/<int:course_id>/video-playlist/add', methods=['POST'])\n@instructor_required\ndef instructor_add_video_playlist(course_id):\n    \"\"\"Add a video to the course playlist\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        video_url = request.form.get('video_url', '').strip()\n        description = request.form.get('description', '').strip()\n        duration = request.form.get('duration', '').strip()\n        thumbnail_url = request.form.get('thumbnail_url', '').strip()\n        \n        if not title or not video_url:\n            flash('Video title and URL are required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_content', course_id=course_id))\n        \n        # Handle notes file upload with validation\n        notes_file_path = None\n        ALLOWED_NOTES_EXTENSIONS = {'pdf', 'doc', 'docx', 'txt', 'ppt', 'pptx', 'odt', 'rtf'}\n        MAX_NOTES_SIZE = 50 * 1024 * 1024  # 50MB\n        \n        if 'notes_file' in request.files:\n            notes_file = request.files['notes_file']\n            if notes_file and notes_file.filename:\n                filename = secure_filename(notes_file.filename)\n                file_ext = filename.rsplit('.', 1)[1].lower() if '.' in filename else ''\n                \n                # Validate file extension\n                if file_ext not in ALLOWED_NOTES_EXTENSIONS:\n                    flash(f'Invalid file type. Allowed: {\", \".join(ALLOWED_NOTES_EXTENSIONS)}', 'error')\n                    conn.close()\n                    return redirect(url_for('instructor_course_content', course_id=course_id))\n                \n                # Check file size\n                notes_file.seek(0, 2)  # Seek to end\n                file_size = notes_file.tell()\n                notes_file.seek(0)  # Reset to beginning\n                \n                if file_size > MAX_NOTES_SIZE:\n                    flash('Notes file too large. Maximum size is 50MB.', 'error')\n                    conn.close()\n                    return redirect(url_for('instructor_course_content', course_id=course_id))\n                \n                # Save the file\n                notes_file_path = os.path.join(app.config['UPLOAD_FOLDER'], 'resources', f\"notes_{course_id}_{uuid.uuid4().hex}_{filename}\")\n                os.makedirs(os.path.dirname(notes_file_path), exist_ok=True)\n                notes_file.save(notes_file_path)\n        \n        try:\n            # Get the next order index\n            max_order = conn.execute('''\n                SELECT MAX(order_index) FROM course_video_playlists \n                WHERE course_id = ?\n            ''', (course_id,)).fetchone()[0]\n            \n            next_order = (max_order or 0) + 1\n            \n            conn.execute('''\n                INSERT INTO course_video_playlists (course_id, title, video_url, description, duration, thumbnail_url, notes_file_path, order_index, created_by)\n                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n            ''', (course_id, title, video_url, description, duration, thumbnail_url, notes_file_path, next_order, current_user.id))\n            \n            conn.commit()\n            flash(f'Video \"{title}\" added to playlist successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error adding video to playlist. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n@app.route('/download-notes/<int:video_id>')\n@login_required\ndef download_video_notes(video_id):\n    \"\"\"Download notes for a video\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id \n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video or not video['notes_file_path']:\n            conn.close()\n            flash('Notes not found.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                flash('Access denied.', 'error')\n                return redirect(url_for('dashboard'))\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            flash('Access denied.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        stored_path = video['notes_file_path']\n        conn.close()\n        \n        # Try to find the actual file - handle incorrect paths from different systems\n        file_path = None\n        filename = os.path.basename(stored_path)\n        \n        # Try multiple possible locations\n        possible_paths = [\n            stored_path,  # Original path\n            os.path.join(app.config['UPLOAD_FOLDER'], 'resources', filename),  # Current system path\n            os.path.join('sir_rafique', 'uploads', 'resources', filename),  # Relative path\n        ]\n        \n        for path in possible_paths:\n            if os.path.exists(path):\n                file_path = path\n                break\n        \n        if not file_path:\n            logging.error(f\"Notes file not found. Tried paths: {possible_paths}\")\n            flash('Notes file not found on server. Please contact your instructor.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Send the file\n        try:\n            directory = os.path.dirname(file_path)\n            filename = os.path.basename(file_path)\n            \n            # Get original extension for proper MIME type\n            file_ext = filename.rsplit('.', 1)[1].lower() if '.' in filename else 'pdf'\n            mime_types = {\n                'pdf': 'application/pdf',\n                'doc': 'application/msword',\n                'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n                'txt': 'text/plain',\n                'ppt': 'application/vnd.ms-powerpoint',\n                'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation'\n            }\n            \n            return send_from_directory(\n                directory, \n                filename, \n                as_attachment=True,\n                mimetype=mime_types.get(file_ext, 'application/octet-stream')\n            )\n        except Exception as e:\n            logging.error(f\"Error downloading notes: {e}\")\n            flash('Unable to download notes. Please try again.', 'error')\n            return redirect(url_for('dashboard'))\n\n@app.route('/instructor/courses/<int:course_id>/content/video/<int:video_id>/edit', methods=['POST'])\n@instructor_required\ndef instructor_edit_video_playlist(course_id, video_id):\n    \"\"\"Edit a video in playlist\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify video belongs to instructor's course\n        video = conn.execute('''\n            SELECT v.* FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.course_id = ? AND c.instructor_id = ? AND v.is_active = 1\n        ''', (video_id, course_id, current_user.id)).fetchone()\n        \n        if not video:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Video not found or access denied.'}), 404\n        \n        try:\n            title = request.form.get('title', '').strip()\n            video_url = request.form.get('video_url', '').strip()\n            duration = request.form.get('duration', '').strip()\n            description = request.form.get('description', '').strip()\n            \n            if not title or not video_url:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Title and URL are required.'}), 400\n            \n            # Update the video\n            conn.execute('''\n                UPDATE course_video_playlists\n                SET title = ?, video_url = ?, duration = ?, description = ?\n                WHERE id = ? AND course_id = ? AND is_active = 1\n            ''', (title, video_url, duration or None, description or None, video_id, course_id))\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({'success': True, 'message': 'Video updated successfully!'}), 200\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            logging.error(f\"Error updating video: {e}\")\n            return jsonify({'success': False, 'message': 'Error updating video. Please try again.'}), 500\n\n@app.route('/instructor/courses/<int:course_id>/video-playlist/<int:video_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_video_playlist(course_id, video_id):\n    \"\"\"Delete a video from playlist\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        try:\n            conn.execute('''\n                DELETE FROM course_video_playlists \n                WHERE id = ? AND course_id = ? AND created_by = ?\n            ''', (video_id, course_id, current_user.id))\n            \n            conn.commit()\n            flash('Video deleted from playlist successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error deleting video. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_content', course_id=course_id))\n\n# STUDENT VIDEO PLAYLIST ROUTES\n@app.route('/student/my-playlist')\n@login_required\ndef student_my_playlist():\n    \"\"\"View student's personal video playlist\"\"\"\n    if not current_user.is_student():\n        flash('Access denied.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        rows = conn.execute('''\n            SELECT * FROM student_video_playlists \n            WHERE student_id = ? AND is_active = 1\n            ORDER BY order_index ASC\n        ''', (current_user.id,)).fetchall()\n        # Convert Row objects to dictionaries for JSON serialization\n        videos = [dict(row) for row in rows]\n        conn.close()\n    \n    return render_template('student/my_playlist.html', videos=videos)\n\n@app.route('/student/playlist/add', methods=['POST'])\n@login_required\ndef student_add_playlist_video():\n    \"\"\"Add video to student playlist\"\"\"\n    if not current_user.is_student():\n        return jsonify({'success': False, 'message': 'Access denied.'}), 403\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        title = request.form.get('title', '').strip()\n        video_url = request.form.get('video_url', '').strip()\n        description = request.form.get('description', '').strip()\n        duration = request.form.get('duration', '').strip()\n        \n        if not title or not video_url:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Title and URL are required.'}), 400\n        \n        try:\n            conn.execute('''\n                INSERT INTO student_video_playlists \n                (student_id, title, video_url, description, duration, order_index)\n                VALUES (?, ?, ?, ?, ?, (SELECT COUNT(*) FROM student_video_playlists WHERE student_id = ?))\n            ''', (current_user.id, title, video_url, description or None, duration or None, current_user.id))\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({'success': True, 'message': 'Video added to playlist!'}), 200\n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            logging.error(f\"Error adding playlist video: {e}\")\n            return jsonify({'success': False, 'message': 'Error adding video. Please try again.'}), 500\n\n@app.route('/student/playlist/<int:video_id>/edit', methods=['POST'])\n@login_required\ndef student_edit_playlist_video(video_id):\n    \"\"\"Edit student playlist video\"\"\"\n    if not current_user.is_student():\n        return jsonify({'success': False, 'message': 'Access denied.'}), 403\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        video = conn.execute('''\n            SELECT * FROM student_video_playlists \n            WHERE id = ? AND student_id = ? AND is_active = 1\n        ''', (video_id, current_user.id)).fetchone()\n        \n        if not video:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Video not found.'}), 404\n        \n        title = request.form.get('title', '').strip()\n        video_url = request.form.get('video_url', '').strip()\n        description = request.form.get('description', '').strip()\n        duration = request.form.get('duration', '').strip()\n        \n        if not title or not video_url:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Title and URL are required.'}), 400\n        \n        try:\n            conn.execute('''\n                UPDATE student_video_playlists\n                SET title = ?, video_url = ?, description = ?, duration = ?\n                WHERE id = ? AND student_id = ? AND is_active = 1\n            ''', (title, video_url, description or None, duration or None, video_id, current_user.id))\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({'success': True, 'message': 'Video updated successfully!'}), 200\n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            logging.error(f\"Error updating playlist video: {e}\")\n            return jsonify({'success': False, 'message': 'Error updating video.'}), 500\n\n@app.route('/student/playlist/<int:video_id>/delete', methods=['POST'])\n@login_required\ndef student_delete_playlist_video(video_id):\n    \"\"\"Delete video from student playlist\"\"\"\n    if not current_user.is_student():\n        return jsonify({'success': False, 'message': 'Access denied.'}), 403\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        try:\n            conn.execute('''\n                DELETE FROM student_video_playlists \n                WHERE id = ? AND student_id = ?\n            ''', (video_id, current_user.id))\n            \n            conn.commit()\n            conn.close()\n            \n            return jsonify({'success': True, 'message': 'Video deleted!'}), 200\n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            logging.error(f\"Error deleting playlist video: {e}\")\n            return jsonify({'success': False, 'message': 'Error deleting video.'}), 500\n\n@app.route('/generate-transcript/<int:video_id>', methods=['POST'])\n@login_required\ndef generate_video_transcript(video_id):\n    \"\"\"Generate AI transcript for a video and save as PDF with watermark\"\"\"\n    try:\n        from utils.pdf_generator import generate_transcript_pdf\n    except ImportError:\n        logging.error(\"PDF generator not available\")\n        return jsonify({'success': False, 'message': 'PDF generation service not available. Please check system configuration.'}), 500\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id, c.title as course_title, c.course_code\n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Video not found.'}), 404\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Access denied.'}), 403\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Access denied.'}), 403\n        \n        try:\n            # Generate transcript using Gemini AI from actual YouTube video\n            transcript_text = gemini_ai.generate_video_transcript(\n                video['title'],\n                video['description'] or '',\n                video['duration'] or '',\n                video['video_url'] or ''\n            )\n            \n            if not transcript_text or len(transcript_text) < 10:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Failed to generate transcript. Please check your Gemini API key.'}), 500\n            \n            # Generate PDF filename\n            safe_filename = secure_filename(video['title'])\n            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n            pdf_filename = f\"transcript_{video_id}_{timestamp}.pdf\"\n            transcript_folder = os.path.join(app.config['UPLOAD_FOLDER'], 'transcripts')\n            os.makedirs(transcript_folder, exist_ok=True)\n            pdf_path = os.path.join(transcript_folder, pdf_filename)\n            \n            # Generate PDF with watermark\n            success = generate_transcript_pdf(\n                transcript_text=transcript_text,\n                video_title=video['title'],\n                course_name=f\"{video['course_code']} - {video['course_title']}\",\n                student_name=current_user.full_name,\n                output_path=pdf_path\n            )\n            \n            if success:\n                # Save relative path to database (not absolute)\n                relative_path = os.path.join('sir_rafique', 'uploads', 'transcripts', pdf_filename)\n                \n                # Update database with transcript path\n                conn.execute('''\n                    UPDATE course_video_playlists \n                    SET transcript_file_path = ?\n                    WHERE id = ?\n                ''', (relative_path, video_id))\n                conn.commit()\n                conn.close()\n                \n                logging.info(f\"Transcript generated successfully for video {video_id}\")\n                return jsonify({\n                    'success': True,\n                    'message': 'Transcript generated successfully!',\n                    'download_url': url_for('download_video_transcript', video_id=video_id)\n                })\n            else:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Error generating PDF. Please try again.'}), 500\n                \n        except ValueError as ve:\n            conn.close()\n            logging.error(f\"Gemini API Key Error: {ve}\")\n            return jsonify({'success': False, 'message': 'Gemini API is not configured. Please set GEMINI_API_KEY environment variable.'}), 500\n        except Exception as e:\n            conn.close()\n            logging.error(f\"Error generating transcript: {e}\")\n            return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500\n\n@app.route('/generate-student-notes', methods=['POST'])\n@login_required\ndef generate_student_notes_route():\n    \"\"\"Generate AI-enhanced notes from student input and save as PDF with LearnNest watermark\"\"\"\n    try:\n        from utils.pdf_generator import generate_transcript_pdf\n    except ImportError:\n        logging.error(\"PDF generator not available\")\n        return jsonify({'success': False, 'message': 'PDF generation service not available.'}), 500\n    \n    try:\n        data = request.get_json()\n        student_notes_input = data.get('topic', '').strip()\n        course_id = data.get('course_id')\n        add_watermark = data.get('add_watermark', True)  # Default to True\n        \n        if not student_notes_input or len(student_notes_input) < 3:\n            return jsonify({'success': False, 'message': 'Please enter a topic.'}), 400\n        \n        with db_lock:\n            conn = get_db_connection()\n            \n            # Get course details\n            course = conn.execute('''\n                SELECT * FROM courses WHERE id = ?\n            ''', (course_id,)).fetchone()\n            \n            if not course:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Course not found.'}), 404\n            \n            # Check student has access\n            if current_user.is_student():\n                enrollment = conn.execute('''\n                    SELECT * FROM enrollments \n                    WHERE student_id = ? AND course_id = ? AND status = 'approved'\n                ''', (current_user.id, course_id)).fetchone()\n                if not enrollment:\n                    conn.close()\n                    return jsonify({'success': False, 'message': 'Access denied.'}), 403\n            \n            # Generate enhanced notes using Gemini AI\n            enhanced_notes = gemini_ai.generate_student_notes(\n                student_notes_input,\n                course['title'],\n                course['course_code']\n            )\n            \n            if not enhanced_notes or len(enhanced_notes) < 10:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Failed to enhance notes. Please try again.'}), 500\n            \n            # Generate PDF filename\n            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n            pdf_filename = f\"student_notes_{current_user.id}_{timestamp}.pdf\"\n            notes_folder = os.path.join(app.config['UPLOAD_FOLDER'], 'student_notes')\n            os.makedirs(notes_folder, exist_ok=True)\n            pdf_path = os.path.join(notes_folder, pdf_filename)\n            \n            # Generate PDF with optional watermark\n            success = generate_transcript_pdf(\n                transcript_text=enhanced_notes,\n                video_title=f\"Study Notes - {course['title']}\",\n                course_name=f\"{course['course_code']} - {course['title']}\",\n                student_name=current_user.full_name,\n                output_path=pdf_path,\n                add_watermark=add_watermark\n            )\n            \n            if success:\n                # Save to database\n                conn.execute('''\n                    INSERT INTO student_notes (student_id, course_id, original_input, enhanced_notes, file_path, created_at)\n                    VALUES (?, ?, ?, ?, ?, ?)\n                ''', (\n                    current_user.id,\n                    course_id,\n                    student_notes_input,\n                    enhanced_notes,\n                    os.path.join('sir_rafique', 'uploads', 'student_notes', pdf_filename),\n                    datetime.now()\n                ))\n                conn.commit()\n                \n                # Get the inserted note ID\n                note_id = conn.execute('SELECT last_insert_rowid()').fetchone()[0]\n                conn.close()\n                \n                # Send notification to student\n                socketio.emit('notification', {\n                    'title': 'ðŸ“š Study Notes Generated!',\n                    'message': f'Your AI-generated study notes for \"{student_notes_input}\" are ready!',\n                    'type': 'success',\n                    'icon': 'fa-book'\n                }, to=f'user_{current_user.id}')\n                \n                logging.info(f\"Student notes generated for student {current_user.id}\")\n                return jsonify({\n                    'success': True,\n                    'message': 'Enhanced study notes generated successfully!',\n                    'note_id': note_id,\n                    'enhanced_notes': enhanced_notes,\n                    'download_url': url_for('download_student_notes', note_id=note_id)\n                })\n            else:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Error generating PDF.'}), 500\n                \n    except ValueError as ve:\n        logging.error(f\"Gemini API Key Error: {ve}\")\n        return jsonify({'success': False, 'message': 'Gemini API not configured.'}), 500\n    except Exception as e:\n        logging.error(f\"Error generating student notes: {e}\")\n        return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500\n\n@app.route('/download-student-notes/<int:note_id>')\n@login_required\ndef download_student_notes(note_id):\n    \"\"\"Download student's enhanced notes PDF\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            note = conn.execute('''\n                SELECT * FROM student_notes WHERE id = ? AND student_id = ?\n            ''', (note_id, current_user.id)).fetchone()\n            conn.close()\n        \n        if not note:\n            logging.warning(f\"Note {note_id} not found for student {current_user.id}\")\n            return jsonify({'error': 'Note not found'}), 404\n        \n        stored_path = note['file_path']\n        filename = os.path.basename(stored_path)\n        \n        # Try multiple possible locations\n        possible_paths = [\n            stored_path,  # Original path as stored\n            os.path.join(app.config['UPLOAD_FOLDER'], filename),  # In uploads folder\n            os.path.join(app.config['UPLOAD_FOLDER'], 'student_notes', filename),  # In student_notes subfolder\n            os.path.join('sir_rafique', 'uploads', filename),  # Relative path from project root\n            os.path.join('sir_rafique', 'uploads', 'student_notes', filename),  # With subfolder\n        ]\n        \n        file_path = None\n        for path in possible_paths:\n            if os.path.exists(path):\n                file_path = path\n                logging.info(f\"Found notes file at: {path}\")\n                break\n        \n        if not file_path:\n            logging.error(f\"Student notes file not found. Note ID: {note_id}, Stored path: {stored_path}, Tried paths: {possible_paths}\")\n            return jsonify({'error': 'File not found on server'}), 404\n        \n        # Send the file\n        try:\n            directory = os.path.dirname(file_path)\n            filename = os.path.basename(file_path)\n            return send_file(file_path, as_attachment=True, download_name=f\"study_notes_{note_id}.pdf\")\n        except Exception as send_error:\n            logging.error(f\"Error sending file: {send_error}\")\n            return jsonify({'error': 'Error sending file'}), 500\n            \n    except Exception as e:\n        logging.error(f\"Error downloading student notes: {e}\")\n        return jsonify({'error': 'Download error'}), 500\n\n@app.route('/api/ai-assistant', methods=['POST'])\n@login_required\ndef ai_assistant():\n    \"\"\"AI Study Assistant - Answer student questions instantly using Gemini AI with visual generation\"\"\"\n    try:\n        data = request.get_json()\n        question = data.get('question', '').strip()\n        \n        if not question or len(question) < 3:\n            return jsonify({'success': False, 'message': 'Please enter a valid question.'}), 400\n        \n        try:\n            # Use Gemini AI to answer the question with visual capability\n            result = gemini_ai.answer_student_question(question)\n            \n            # Handle both dict and string responses for backward compatibility\n            if isinstance(result, dict):\n                answer_text = result.get('answer', '')\n                needs_visual = result.get('needs_visual', False)\n                visual_prompt = result.get('visual_prompt', None)\n            else:\n                answer_text = result\n                needs_visual = False\n                visual_prompt = None\n            \n            if answer_text and \"error\" not in answer_text.lower():\n                response_data = {\n                    'success': True,\n                    'answer': answer_text,\n                    'has_visual': needs_visual\n                }\n                \n                # If visual is needed, generate it using Gemini's Imagen\n                if needs_visual and visual_prompt:\n                    try:\n                        from google import genai\n                        client = genai.Client(api_key=os.environ.get(\"GEMINI_API_KEY\"))\n                        \n                        # Generate image using Imagen 3\n                        image_response = client.models.generate_images(\n                            model='imagen-3.0-generate-001',\n                            prompt=visual_prompt,\n                            config=types.GenerateImagesConfig(\n                                number_of_images=1,\n                                aspect_ratio='1:1',\n                                safety_filter_level='block_some',\n                                person_generation='allow_adult'\n                            )\n                        )\n                        \n                        if image_response and image_response.generated_images:\n                            # Save the generated image\n                            import base64\n                            image_data = image_response.generated_images[0].image.image_bytes\n                            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n                            filename = f\"ai_visual_{current_user.id}_{timestamp}.png\"\n                            visual_folder = os.path.join(app.config['UPLOAD_FOLDER'], 'ai_visuals')\n                            os.makedirs(visual_folder, exist_ok=True)\n                            image_path = os.path.join(visual_folder, filename)\n                            \n                            with open(image_path, 'wb') as f:\n                                f.write(image_data)\n                            \n                            response_data['visual_url'] = f\"/uploads/ai_visuals/{filename}\"\n                            logging.info(f\"Generated visual for question: {question[:50]}...\")\n                    except Exception as img_error:\n                        logging.warning(f\"Could not generate visual: {img_error}\")\n                        # Continue without visual if generation fails\n                \n                logging.info(f\"AI Assistant answered question for user {current_user.id}\")\n                return jsonify(response_data)\n            else:\n                return jsonify({\n                    'success': False,\n                    'message': 'Unable to generate answer at this time. Please try again.'\n                }), 500\n                \n        except Exception as e:\n            logging.error(f\"Error in AI Assistant: {e}\")\n            return jsonify({\n                'success': False,\n                'message': 'Error processing your question. Please try again.'\n            }), 500\n            \n    except Exception as e:\n        logging.error(f\"AI Assistant request error: {e}\")\n        return jsonify({'success': False, 'message': 'Invalid request.'}), 400\n\n@app.route('/generate-notes/<int:video_id>', methods=['POST'])\n@login_required\ndef generate_video_notes_route(video_id):\n    \"\"\"Generate AI study notes for a video and save as PDF\"\"\"\n    try:\n        from utils.pdf_generator import generate_transcript_pdf\n    except ImportError:\n        logging.error(\"PDF generator not available\")\n        return jsonify({'success': False, 'message': 'PDF generation service not available. Please check system configuration.'}), 500\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id, c.title as course_title, c.course_code\n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Video not found.'}), 404\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Access denied.'}), 403\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            return jsonify({'success': False, 'message': 'Access denied.'}), 403\n        \n        try:\n            # Generate AI notes using Gemini AI\n            notes_text = gemini_ai.generate_video_notes(\n                video['title'],\n                video['description'] or '',\n                video['duration'] or '',\n                video['video_url'] or ''\n            )\n            \n            if not notes_text or len(notes_text) < 10:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Failed to generate notes. Please check your Gemini API key.'}), 500\n            \n            # Generate PDF filename\n            safe_filename = secure_filename(video['title'])\n            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n            pdf_filename = f\"ai_notes_{video_id}_{timestamp}.pdf\"\n            notes_folder = os.path.join(app.config['UPLOAD_FOLDER'], 'resources')\n            os.makedirs(notes_folder, exist_ok=True)\n            pdf_path = os.path.join(notes_folder, pdf_filename)\n            \n            # Generate PDF with watermark (reuse transcript PDF function with different title)\n            success = generate_transcript_pdf(\n                transcript_text=notes_text,\n                video_title=f\"Study Notes: {video['title']}\",\n                course_name=f\"{video['course_code']} - {video['course_title']}\",\n                student_name=current_user.full_name,\n                output_path=pdf_path\n            )\n            \n            if success:\n                # Save relative path to database (not absolute)\n                relative_path = os.path.join('sir_rafique', 'uploads', 'resources', pdf_filename)\n                \n                # Update database with AI notes path\n                conn.execute('''\n                    UPDATE course_video_playlists \n                    SET notes_file_path = ?\n                    WHERE id = ?\n                ''', (relative_path, video_id))\n                conn.commit()\n                conn.close()\n                \n                logging.info(f\"AI notes generated successfully for video {video_id}\")\n                return jsonify({\n                    'success': True,\n                    'message': 'AI Study Notes generated successfully!',\n                    'download_url': url_for('download_video_notes', video_id=video_id)\n                })\n            else:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Error generating PDF. Please try again.'}), 500\n                \n        except ValueError as ve:\n            conn.close()\n            logging.error(f\"Gemini API Key Error: {ve}\")\n            return jsonify({'success': False, 'message': 'Gemini API is not configured. Please set GEMINI_API_KEY environment variable.'}), 500\n        except Exception as e:\n            conn.close()\n            logging.error(f\"Error generating notes: {e}\")\n            return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500\n\n@app.route('/download-transcript/<int:video_id>')\n@login_required\ndef download_video_transcript(video_id):\n    \"\"\"Download AI-generated transcript PDF for a video\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id \n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video or not video['transcript_file_path']:\n            conn.close()\n            flash('Transcript not found. Please generate it first.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                flash('Access denied.', 'error')\n                return redirect(url_for('dashboard'))\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            flash('Access denied.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        stored_path = video['transcript_file_path']\n        conn.close()\n        \n        # Try to find the actual file - handle incorrect paths from different systems\n        file_path = None\n        filename = os.path.basename(stored_path)\n        \n        # Try multiple possible locations\n        possible_paths = [\n            stored_path,  # Original path\n            os.path.join(app.config['UPLOAD_FOLDER'], 'transcripts', filename),  # Current system path\n            os.path.join('sir_rafique', 'uploads', 'transcripts', filename),  # Relative path\n        ]\n        \n        for path in possible_paths:\n            if os.path.exists(path):\n                file_path = path\n                break\n        \n        if not file_path:\n            logging.error(f\"Transcript file not found. Tried paths: {possible_paths}\")\n            flash('Transcript file not found. Please generate it again.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Send the transcript PDF file\n        try:\n            directory = os.path.dirname(file_path)\n            filename = os.path.basename(file_path)\n            \n            # Create a clean download filename\n            safe_title = \"\".join(c for c in video['title'] if c.isalnum() or c in (' ', '-', '_')).rstrip()\n            download_filename = f\"transcript_{safe_title}.pdf\"\n            \n            return send_from_directory(\n                directory, \n                filename, \n                as_attachment=True, \n                download_name=download_filename,\n                mimetype='application/pdf'\n            )\n        except Exception as e:\n            logging.error(f\"Error downloading transcript: {e}\")\n            flash(f'Unable to download transcript. Please try again.', 'error')\n            return redirect(url_for('dashboard'))\n\n@app.route('/download-video/<int:video_id>')\n@login_required\ndef download_video(video_id):\n    \"\"\"Download YouTube video for a course using yt-dlp\"\"\"\n    import subprocess\n    import tempfile\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get video details\n        video = conn.execute('''\n            SELECT v.*, c.instructor_id \n            FROM course_video_playlists v\n            JOIN courses c ON v.course_id = c.id\n            WHERE v.id = ? AND v.is_active = 1\n        ''', (video_id,)).fetchone()\n        \n        if not video:\n            conn.close()\n            flash('Video not found.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        # Check if user has access (instructor or enrolled student)\n        if current_user.is_student():\n            enrollment = conn.execute('''\n                SELECT * FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, video['course_id'])).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                flash('Access denied.', 'error')\n                return redirect(url_for('dashboard'))\n        elif current_user.is_instructor() and video['instructor_id'] != current_user.id:\n            conn.close()\n            flash('Access denied.', 'error')\n            return redirect(url_for('dashboard'))\n        \n        video_url = video['video_url']\n        conn.close()\n        \n        # Render download page with embedded downloader\n        return render_template('student/video_download.html', video=video)\n\n# VIDEO DOWNLOADER ROUTES (PyTubeFix Integration)\n@app.route('/video-downloader')\n@login_required\ndef video_downloader_home():\n    \"\"\"Main video downloader page\"\"\"\n    return render_template('student/video_download.html', video=None)\n\ndef clean_youtube_url(link: str) -> str:\n    \"\"\"Cleans YouTube URL by removing tracking parameters while preserving the video ID.\"\"\"\n    from urllib.parse import urlparse, parse_qs, urlencode, urlunparse\n    \n    parsed = urlparse(link)\n    query_params = parse_qs(parsed.query)\n    \n    # Keep only the 'v' parameter (video ID) if it exists\n    if 'v' in query_params:\n        cleaned_query = urlencode({'v': query_params['v'][0]})\n        cleaned_url = urlunparse((\n            parsed.scheme,\n            parsed.netloc,\n            parsed.path,\n            parsed.params,\n            cleaned_query,\n            ''  # Remove fragment\n        ))\n        return cleaned_url\n    \n    # If no 'v' parameter, return original (might be a youtu.be short link)\n    return link\n\n@app.route('/submit', methods=['GET', 'POST'])\n@login_required\ndef submit_video_download():\n    \"\"\"Download YouTube video using PyTubeFix\"\"\"\n    try:\n        # Get link from either query parameter (GET) or form data (POST)\n        link = request.args.get('link') or request.form.get('link', '')\n        link = link.strip()\n        \n        if not link:\n            flash('Please provide a valid YouTube URL', 'error')\n            return redirect(url_for('video_downloader_home'))\n        \n        # Create downloads directory\n        downloads_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'video_downloads')\n        os.makedirs(downloads_dir, exist_ok=True)\n        \n        # Clean old downloads (keep only last 3 files)\n        existing_files = os.listdir(downloads_dir)\n        if len(existing_files) > 3:\n            for f in existing_files:\n                os.remove(os.path.join(downloads_dir, f))\n        \n        clean = clean_youtube_url(link)\n        yt = YouTube(clean)\n        \n        stream = yt.streams.get_lowest_resolution()\n        filename = f\"video_{datetime.now().strftime('%Y%m%d_%H%M%S')}.mp4\"\n        out_file = stream.download(output_path=downloads_dir, filename=filename)\n        \n        return send_from_directory(downloads_dir, filename, as_attachment=True)\n    \n    except Exception as e:\n        logging.error(f\"Error downloading video: {e}\")\n        flash(f'Error downloading video: {str(e)}', 'error')\n        return redirect(url_for('video_downloader_home'))\n\n@app.route('/submit_audio', methods=['GET', 'POST'])\n@login_required\ndef submit_audio_download():\n    \"\"\"Download YouTube audio using PyTubeFix\"\"\"\n    try:\n        # Get link from either query parameter (GET) or form data (POST)\n        link = request.args.get('link') or request.form.get('link', '')\n        link = link.strip()\n        \n        if not link:\n            flash('Please provide a valid YouTube URL', 'error')\n            return redirect(url_for('video_downloader_home'))\n        \n        # Create downloads directory\n        downloads_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'audio_downloads')\n        os.makedirs(downloads_dir, exist_ok=True)\n        \n        # Clean old downloads (keep only last 5 files)\n        existing_files = os.listdir(downloads_dir)\n        if len(existing_files) > 5:\n            for f in existing_files:\n                os.remove(os.path.join(downloads_dir, f))\n        \n        clean = clean_youtube_url(link)\n        yt = YouTube(clean)\n        \n        audio_stream = yt.streams.filter(only_audio=True).first()\n        filename = f\"audio_{datetime.now().strftime('%Y%m%d_%H%M%S')}.mp3\"\n        out_file = audio_stream.download(output_path=downloads_dir, filename=filename)\n        \n        # If ffmpeg is available, convert to proper MP3\n        # Otherwise, just rename the file\n        try:\n            import subprocess\n            final_file = out_file.replace('.mp3', '_final.mp3')\n            subprocess.run(['ffmpeg', '-y', '-i', out_file, '-c:a', 'libmp3lame', final_file], \n                         check=True, capture_output=True)\n            os.remove(out_file)\n            out_file = final_file\n            filename = os.path.basename(final_file)\n        except:\n            # ffmpeg not available, use original file\n            pass\n        \n        return send_from_directory(downloads_dir, filename, as_attachment=True)\n    \n    except Exception as e:\n        logging.error(f\"Error downloading audio: {e}\")\n        flash(f'Error downloading audio: {str(e)}', 'error')\n        return redirect(url_for('video_downloader_home'))\n\n# QUIZ SYSTEM ROUTES - API ENDPOINT FOR AI MCQ GENERATION\n@app.route('/api/generate-mcq-options', methods=['POST'])\n@login_required\ndef generate_mcq_options():\n    \"\"\"Generate MCQ options and correct answer using AI Gemini\"\"\"\n    try:\n        data = request.get_json()\n        question = data.get('question', '').strip()\n        context = data.get('context', '').strip()\n        \n        if not question or len(question) < 5:\n            return jsonify({'success': False, 'error': 'Question too short'}), 400\n        \n        # Generate MCQ options using Gemini AI\n        result = gemini_ai.generate_mcq_options(question, context)\n        \n        if result and 'options' in result:\n            return jsonify({\n                'success': True,\n                'options': {\n                    'option_a': result['options'].get('A', ''),\n                    'option_b': result['options'].get('B', ''),\n                    'option_c': result['options'].get('C', ''),\n                    'option_d': result['options'].get('D', ''),\n                    'correct_answer': result.get('correct_answer', 'A'),\n                    'explanation': result.get('explanation', '')\n                }\n            })\n        else:\n            return jsonify({'success': False, 'error': 'Failed to generate options'}), 500\n            \n    except Exception as e:\n        logging.error(f\"Error generating MCQ options: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/generate-ai', methods=['POST'])\n@instructor_required\ndef instructor_generate_ai_quiz(course_id):\n    \"\"\"Generate MCQ quiz questions using AI from a topic and save directly to database\"\"\"\n    try:\n        data = request.get_json()\n        title = data.get('title', '').strip()\n        topic = data.get('topic', '').strip()\n        num_questions = int(data.get('num_questions', 5))\n        difficulty = data.get('difficulty', 'medium')\n        \n        if not title or len(title) < 3:\n            return jsonify({'success': False, 'message': 'Please enter a quiz title.'}), 400\n        \n        if not topic or len(topic) < 3:\n            return jsonify({'success': False, 'message': 'Please enter a topic.'}), 400\n        \n        # Support up to 100 questions per quiz\n        if num_questions < 1 or num_questions > 100:\n            num_questions = min(max(num_questions, 1), 100)\n        \n        # Generate questions using Gemini AI\n        try:\n            questions = gemini_ai.generate_mcq_quiz(topic, num_questions, difficulty)\n        except ValueError as ve:\n            logging.error(f\"Gemini API configuration error: {ve}\")\n            return jsonify({'success': False, 'message': f'Configuration Error: {str(ve)}'}), 500\n        except Exception as e:\n            logging.error(f\"Error generating quiz: {e}\")\n            return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500\n        \n        if not questions or len(questions) == 0:\n            return jsonify({'success': False, 'message': 'No questions were generated. Please try a different topic or try again.'}), 500\n        \n        # Create quiz directly in database\n        with db_lock:\n            conn = get_db_connection()\n            \n            # Verify course belongs to instructor\n            course = conn.execute('SELECT * FROM courses WHERE id = ? AND instructor_id = ?', \n                                (course_id, current_user.id)).fetchone()\n            \n            if not course:\n                conn.close()\n                return jsonify({'success': False, 'message': 'Course not found or access denied.'}), 403\n            \n            try:\n                # Create the quiz/assignment\n                total_points = len(questions)  # 1 point per question by default\n                cursor = conn.execute('''\n                    INSERT INTO assignments (course_id, title, description, instructions, max_points)\n                    VALUES (?, ?, ?, ?, ?)\n                ''', (\n                    course_id, \n                    title,\n                    f\"AI-generated quiz on {topic} ({difficulty} difficulty)\",\n                    \"Answer all multiple choice questions. Each question is worth 1 point.\",\n                    total_points\n                ))\n                \n                assignment_id = cursor.lastrowid\n                \n                # Save all generated questions\n                for q in questions:\n                    # Insert question\n                    cursor = conn.execute('''\n                        INSERT INTO quiz_questions (assignment_id, question_text, question_type, points, correct_answer, explanation)\n                        VALUES (?, ?, 'mcq', ?, ?, ?)\n                    ''', (assignment_id, q['question'], 1, q['correct_answer'], q.get('explanation', '')))\n                    \n                    question_id = cursor.lastrowid\n                    \n                    # Insert options\n                    for option_letter, option_text in q['options'].items():\n                        is_correct = (option_letter == q['correct_answer'])\n                        conn.execute('''\n                            INSERT INTO question_options (question_id, option_letter, option_text, is_correct)\n                            VALUES (?, ?, ?, ?)\n                        ''', (question_id, option_letter, option_text, is_correct))\n                \n                conn.commit()\n                \n                logging.info(f\"AI Quiz '{topic}' created with {len(questions)} questions (ID: {assignment_id})\")\n                \n                conn.close()\n                \n                return jsonify({\n                    'success': True,\n                    'message': f'Quiz created with {len(questions)} questions! You can now edit and submit to students.',\n                    'quiz_id': assignment_id,\n                    'redirect_url': url_for('instructor_edit_quiz', course_id=course_id, quiz_id=assignment_id)\n                })\n                \n            except Exception as e:\n                conn.rollback()\n                conn.close()\n                logging.error(f\"Error saving AI quiz: {e}\")\n                return jsonify({'success': False, 'message': f'Error saving quiz: {str(e)}'}), 500\n        \n    except ValueError as ve:\n        logging.error(f\"Gemini API Key Error: {ve}\")\n        return jsonify({'success': False, 'message': 'Gemini API not configured. Please set GEMINI_API_KEY.'}), 500\n    except Exception as e:\n        logging.error(f\"Error generating AI quiz: {e}\")\n        return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500\n\n@app.route('/instructor/courses/<int:course_id>/quizzes')\n@instructor_required\ndef instructor_course_quizzes(course_id):\n    \"\"\"Manage course quizzes\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get quizzes (using assignments table)\n        quizzes = conn.execute('''\n            SELECT a.*, COUNT(s.id) as submission_count\n            FROM assignments a\n            LEFT JOIN assignment_submissions s ON a.id = s.assignment_id\n            WHERE a.course_id = ?\n            GROUP BY a.id\n            ORDER BY a.created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/course_quizzes.html', course=course, quizzes=quizzes)\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/create', methods=['GET', 'POST'])\n@instructor_required\ndef instructor_create_quiz(course_id):\n    \"\"\"Create a new quiz\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        if request.method == 'POST':\n            # Validate CSRF token\n            csrf_token = request.form.get('csrf_token')\n            if not validate_csrf_token(csrf_token):\n                flash('Invalid security token. Please try again.', 'error')\n                conn.close()\n                return redirect(url_for('instructor_create_quiz', course_id=course_id))\n            \n            title = request.form.get('title', '').strip()\n            description = request.form.get('description', '').strip()\n            instructions = request.form.get('instructions', '').strip()\n            due_date = request.form.get('due_date') or None\n            max_points = int(request.form.get('max_points', 100))\n            \n            try:\n                # Create the quiz/assignment\n                cursor = conn.execute('''\n                    INSERT INTO assignments (course_id, title, description, instructions, due_date, max_points)\n                    VALUES (?, ?, ?, ?, ?, ?)\n                ''', (course_id, title, description, instructions, due_date, max_points))\n                \n                assignment_id = cursor.lastrowid\n                total_points = 0\n                \n                # Process MCQ questions\n                questions_data = {}\n                for key in request.form.keys():\n                    if key.startswith('questions[') and '][text]' in key:\n                        # Extract question number\n                        question_num = key.split('[')[1].split(']')[0]\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        questions_data[question_num]['text'] = request.form.get(key, '').strip()\n                    elif key.startswith('questions[') and '][correct]' in key:\n                        question_num = key.split('[')[1].split(']')[0]\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        questions_data[question_num]['correct'] = request.form.get(key)\n                    elif key.startswith('questions[') and '][explanation]' in key:\n                        question_num = key.split('[')[1].split(']')[0]\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        questions_data[question_num]['explanation'] = request.form.get(key, '').strip()\n                    elif key.startswith('questions[') and '][points]' in key:\n                        question_num = key.split('[')[1].split(']')[0]\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        questions_data[question_num]['points'] = int(request.form.get(key, 1))\n                    elif key.startswith('questions[') and '][option_' in key:\n                        question_num = key.split('[')[1].split(']')[0]\n                        option_letter = key.split('option_')[1].split(']')[0].upper()\n                        if question_num not in questions_data:\n                            questions_data[question_num] = {}\n                        if 'options' not in questions_data[question_num]:\n                            questions_data[question_num]['options'] = {}\n                        questions_data[question_num]['options'][option_letter] = request.form.get(key, '').strip()\n                \n                # Save questions and options\n                questions_saved = 0\n                for question_num, question_data in questions_data.items():\n                    if 'text' in question_data and question_data['text']:\n                        # Use instructor-selected correct answer\n                        correct_answer = question_data.get('correct', 'A')\n                        \n                        # Insert question with instructor-selected or AI-generated correct answer\n                        cursor = conn.execute('''\n                            INSERT INTO quiz_questions (assignment_id, question_text, question_type, points, correct_answer, explanation)\n                            VALUES (?, ?, 'mcq', ?, ?, ?)\n                        ''', (assignment_id, question_data['text'], question_data.get('points', 1), \n                             correct_answer, question_data.get('explanation', '')))\n                        \n                        question_id = cursor.lastrowid\n                        total_points += question_data.get('points', 1)\n                        questions_saved += 1\n                        \n                        # Insert options with instructor-selected correct answer\n                        for option_letter, option_text in question_data.get('options', {}).items():\n                            if option_text:\n                                is_correct = (option_letter == correct_answer)\n                                conn.execute('''\n                                    INSERT INTO question_options (question_id, option_letter, option_text, is_correct)\n                                    VALUES (?, ?, ?, ?)\n                                ''', (question_id, option_letter, option_text, is_correct))\n                \n                # Update assignment with calculated total points\n                conn.execute('''\n                    UPDATE assignments SET max_points = ? WHERE id = ?\n                ''', (total_points, assignment_id))\n                \n                conn.commit()\n                \n                if questions_saved > 0:\n                    flash(f'âœ… MCQ Quiz \"{title}\" created successfully with {questions_saved} questions and submitted to all enrolled students!', 'success')\n                    logging.info(f\"Quiz '{title}' created with {questions_saved} questions for course {course_id}\")\n                else:\n                    flash('âš ï¸ Quiz created but no questions were saved. Please add questions and try again.', 'warning')\n                \n                return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n                \n            except Exception as e:\n                conn.rollback()\n                flash('Error creating quiz. Please try again.', 'error')\n        \n        conn.close()\n    \n    return render_template('instructor/create_quiz.html', course=course)\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/<int:quiz_id>/results')\n@instructor_required\ndef instructor_quiz_results(course_id, quiz_id):\n    \"\"\"View quiz results and submissions\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course ownership and quiz\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            WHERE a.id = ? AND a.course_id = ? AND c.instructor_id = ?\n        ''', (quiz_id, course_id, current_user.id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n        \n        # Get all submissions for this quiz\n        submissions = conn.execute('''\n            SELECT s.*, u.full_name as student_name, u.username\n            FROM assignment_submissions s\n            JOIN users u ON s.student_id = u.id\n            WHERE s.assignment_id = ?\n            ORDER BY s.submitted_at DESC\n        ''', (quiz_id,)).fetchall()\n        \n        # Get basic stats\n        stats = {\n            'total_submissions': len(submissions),\n            'graded_count': len([s for s in submissions if s['grade'] is not None]),\n            'average_grade': sum(s['grade'] for s in submissions if s['grade'] is not None) / max(1, len([s for s in submissions if s['grade'] is not None])) if submissions else 0\n        }\n        \n        conn.close()\n    \n    return render_template('instructor/quiz_results.html', quiz=quiz, submissions=submissions, stats=stats)\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/<int:quiz_id>/edit', methods=['GET', 'POST'])\n@instructor_required\ndef instructor_edit_quiz(course_id, quiz_id):\n    \"\"\"Edit existing quiz\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course ownership and quiz\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            WHERE a.id = ? AND a.course_id = ? AND c.instructor_id = ?\n        ''', (quiz_id, course_id, current_user.id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n        \n        if request.method == 'POST':\n            title = request.form.get('title', '').strip()\n            description = request.form.get('description', '').strip()\n            instructions = request.form.get('instructions', '').strip()\n            due_date = request.form.get('due_date') or None\n            max_points = int(request.form.get('max_points', 100))\n            \n            try:\n                conn.execute('''\n                    UPDATE assignments \n                    SET title = ?, description = ?, instructions = ?, due_date = ?, max_points = ?\n                    WHERE id = ?\n                ''', (title, description, instructions, due_date, max_points, quiz_id))\n                \n                # Update MCQ questions if provided\n                questions = conn.execute('SELECT id FROM quiz_questions WHERE assignment_id = ?', (quiz_id,)).fetchall()\n                for idx, q in enumerate(questions):\n                    q_id = q['id']\n                    q_text = request.form.get(f'question_{idx}_text', '').strip()\n                    explanation = request.form.get(f'question_{idx}_explanation', '').strip()\n                    correct = request.form.get(f'question_{idx}_correct', 'A')\n                    \n                    if q_text:\n                        conn.execute('''\n                            UPDATE quiz_questions \n                            SET question_text = ?, explanation = ?, correct_answer = ?\n                            WHERE id = ?\n                        ''', (q_text, explanation, correct, q_id))\n                        \n                        # Update options\n                        for letter in ['A', 'B', 'C', 'D']:\n                            option_text = request.form.get(f'question_{idx}_option_{letter}', '').strip()\n                            if option_text:\n                                conn.execute('''\n                                    UPDATE question_options \n                                    SET option_text = ?, is_correct = ?\n                                    WHERE question_id = ? AND option_letter = ?\n                                ''', (option_text, (letter == correct), q_id, letter))\n                \n                conn.commit()\n                flash(f'Quiz \"{title}\" updated successfully!', 'success')\n                return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n                \n            except Exception as e:\n                conn.rollback()\n                flash('Error updating quiz. Please try again.', 'error')\n        \n        # Fetch questions for editing\n        questions = conn.execute('''\n            SELECT q.id, q.question_text, q.correct_answer, q.explanation,\n                   q.points FROM quiz_questions q\n            WHERE q.assignment_id = ?\n            ORDER BY q.id\n        ''', (quiz_id,)).fetchall()\n        \n        # Fetch options for each question\n        questions_list = []\n        for q in questions:\n            options = conn.execute('''\n                SELECT option_letter, option_text FROM question_options\n                WHERE question_id = ? ORDER BY option_letter\n            ''', (q['id'],)).fetchall()\n            questions_list.append({\n                'id': q['id'],\n                'text': q['question_text'],\n                'correct': q['correct_answer'],\n                'explanation': q['explanation'],\n                'points': q['points'],\n                'options': {opt['option_letter']: opt['option_text'] for opt in options}\n            })\n        \n        conn.close()\n    \n    return render_template('instructor/edit_quiz.html', quiz=quiz, questions=questions_list)\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/<int:quiz_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_quiz(course_id, quiz_id):\n    \"\"\"Delete a quiz and all associated data\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course ownership and quiz\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            WHERE a.id = ? AND a.course_id = ? AND c.instructor_id = ?\n        ''', (quiz_id, course_id, current_user.id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n        \n        try:\n            # Delete quiz questions first\n            conn.execute('DELETE FROM quiz_questions WHERE assignment_id = ?', (quiz_id,))\n            \n            # Delete student MCQ answers\n            conn.execute('''\n                DELETE FROM student_mcq_answers \n                WHERE submission_id IN (\n                    SELECT id FROM assignment_submissions WHERE assignment_id = ?\n                )\n            ''', (quiz_id,))\n            \n            # Delete submissions\n            conn.execute('DELETE FROM assignment_submissions WHERE assignment_id = ?', (quiz_id,))\n            \n            # Delete the quiz itself\n            conn.execute('DELETE FROM assignments WHERE id = ?', (quiz_id,))\n            \n            conn.commit()\n            flash(f'Quiz \"{quiz[\"title\"]}\" and all associated data deleted successfully.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error deleting quiz. Please try again.', 'error')\n            print(f\"Delete quiz error: {e}\")\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n\n@app.route('/instructor/courses/<int:course_id>/quizzes/<int:quiz_id>/analytics')\n@instructor_required\ndef instructor_quiz_analytics(course_id, quiz_id):\n    \"\"\"Basic quiz analytics\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course ownership and quiz\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            WHERE a.id = ? AND a.course_id = ? AND c.instructor_id = ?\n        ''', (quiz_id, course_id, current_user.id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_quizzes', course_id=course_id))\n        \n        # Get enrollment count for completion rate\n        enrolled_students = conn.execute('''\n            SELECT COUNT(*) as count FROM enrollments \n            WHERE course_id = ? AND status = 'approved'\n        ''', (course_id,)).fetchone()['count']\n        \n        # Get submission analytics\n        submissions = conn.execute('''\n            SELECT grade FROM assignment_submissions \n            WHERE assignment_id = ? AND grade IS NOT NULL\n        ''', (quiz_id,)).fetchall()\n        \n        grades = [s['grade'] for s in submissions]\n        analytics = {\n            'enrolled_students': enrolled_students,\n            'submission_count': len(submissions),\n            'completion_rate': (len(submissions) / max(1, enrolled_students)) * 100,\n            'average_grade': sum(grades) / max(1, len(grades)) if grades else 0,\n            'highest_grade': max(grades) if grades else 0,\n            'lowest_grade': min(grades) if grades else 0,\n            'grade_distribution': {\n                'A (90-100)': len([g for g in grades if g >= 90]),\n                'B (80-89)': len([g for g in grades if 80 <= g < 90]),\n                'C (70-79)': len([g for g in grades if 70 <= g < 80]),\n                'D (60-69)': len([g for g in grades if 60 <= g < 70]),\n                'F (0-59)': len([g for g in grades if g < 60])\n            }\n        }\n        \n        conn.close()\n    \n    return render_template('instructor/quiz_analytics.html', quiz=quiz, analytics=analytics)\n\n# DISCUSSION FORUMS ROUTES\n@app.route('/instructor/courses/<int:course_id>/discussions')\n@instructor_required\ndef instructor_course_discussions(course_id):\n    \"\"\"Manage course discussion forums\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get course forums and recent topics\n        forums = conn.execute('''\n            SELECT f.*, COUNT(t.id) as topic_count\n            FROM forums f\n            LEFT JOIN forum_topics t ON f.id = t.forum_id\n            WHERE f.course_id = ? AND f.is_active = 1\n            GROUP BY f.id\n            ORDER BY f.created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get recent forum activity\n        recent_topics = conn.execute('''\n            SELECT t.*, u.full_name as author_name, f.title as forum_title,\n                   COUNT(r.id) as reply_count\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            JOIN forums f ON t.forum_id = f.id\n            LEFT JOIN forum_replies r ON t.id = r.topic_id\n            WHERE f.course_id = ?\n            GROUP BY t.id\n            ORDER BY t.created_at DESC\n            LIMIT 10\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/course_discussions.html', \n                         course=course, forums=forums, recent_topics=recent_topics)\n\n@app.route('/instructor/courses/<int:course_id>/forums/create', methods=['POST'])\n@instructor_required\ndef instructor_create_forum(course_id):\n    \"\"\"Create a new discussion forum\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        description = request.form.get('description', '').strip()\n        \n        if not title:\n            flash('Forum title is required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forums (course_id, title, description)\n                VALUES (?, ?, ?)\n            ''', (course_id, title, description))\n            \n            conn.commit()\n            flash(f'Discussion forum \"{title}\" created successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error creating forum. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_discussions', course_id=course_id))\n\n@app.route('/instructor/courses/<int:course_id>/topics/create', methods=['POST'])\n@instructor_required\ndef instructor_create_topic(course_id):\n    \"\"\"Create a new discussion topic\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        forum_id = request.form.get('forum_id')\n        title = request.form.get('title', '').strip()\n        content = request.form.get('content', '').strip()\n        is_pinned = bool(request.form.get('is_pinned'))\n        \n        if not title or not content or not forum_id:\n            flash('Topic title, content, and forum selection are required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forum_topics (forum_id, user_id, title, content, is_pinned)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (forum_id, current_user.id, title, content, is_pinned))\n            \n            conn.commit()\n            flash(f'Discussion topic \"{title}\" created successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error creating topic. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_discussions', course_id=course_id))\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/topics')\n@instructor_required\ndef instructor_forum_topics(course_id, forum_id):\n    \"\"\"View all topics in a forum\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor or admin\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND (instructor_id = ? OR ? = 1) AND is_active = 1\n        ''', (course_id, current_user.id, current_user.is_admin())).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        # Get all topics in this forum\n        topics = conn.execute('''\n            SELECT t.*, u.full_name as author_name, COUNT(r.id) as reply_count,\n                   MAX(COALESCE(r.created_at, t.created_at)) as last_activity\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            LEFT JOIN forum_replies r ON t.id = r.topic_id\n            WHERE t.forum_id = ?\n            GROUP BY t.id\n            ORDER BY t.is_pinned DESC, last_activity DESC\n        ''', (forum_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('instructor/forum_topics.html', \n                         course=course, forum=forum, topics=topics)\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/topics/<int:topic_id>')\n@instructor_required\ndef instructor_topic_detail(course_id, forum_id, topic_id):\n    \"\"\"View topic details with replies\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor or admin\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND (instructor_id = ? OR ? = 1) AND is_active = 1\n        ''', (course_id, current_user.id, current_user.is_admin())).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        # Get topic details\n        topic = conn.execute('''\n            SELECT t.*, u.full_name as author_name, u.role as author_role\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            WHERE t.id = ? AND t.forum_id = ?\n        ''', (topic_id, forum_id)).fetchone()\n        \n        if not topic:\n            flash('Topic not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_forum_topics', course_id=course_id, forum_id=forum_id))\n        \n        # Get replies\n        replies = conn.execute('''\n            SELECT r.*, u.full_name as author_name, u.role as author_role\n            FROM forum_replies r\n            JOIN users u ON r.user_id = u.id\n            WHERE r.topic_id = ?\n            ORDER BY r.created_at ASC\n        ''', (topic_id,)).fetchall()\n        \n        # Update view count\n        conn.execute('UPDATE forum_topics SET view_count = view_count + 1 WHERE id = ?', (topic_id,))\n        conn.commit()\n        \n        conn.close()\n    \n    return render_template('instructor/topic_detail.html', \n                         course=course, forum=forum, topic=topic, replies=replies)\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/edit')\n@instructor_required\ndef instructor_edit_forum(course_id, forum_id):\n    \"\"\"Edit forum form\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Get forum details\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        conn.close()\n    \n    return render_template('instructor/edit_forum.html', course=course, forum=forum)\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/update', methods=['POST'])\n@instructor_required\ndef instructor_update_forum(course_id, forum_id):\n    \"\"\"Update forum details\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        title = request.form.get('title', '').strip()\n        description = request.form.get('description', '').strip()\n        \n        if not title:\n            flash('Forum title is required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_edit_forum', course_id=course_id, forum_id=forum_id))\n        \n        try:\n            conn.execute('''\n                UPDATE forums \n                SET title = ?, description = ?\n                WHERE id = ? AND course_id = ?\n            ''', (title, description, forum_id, course_id))\n            \n            conn.commit()\n            flash(f'Forum \"{title}\" updated successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error updating forum. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_discussions', course_id=course_id))\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/delete', methods=['POST'])\n@instructor_required\ndef instructor_delete_forum(course_id, forum_id):\n    \"\"\"Delete forum (soft delete)\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND instructor_id = ? AND is_active = 1\n        ''', (course_id, current_user.id)).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        try:\n            # Soft delete forum\n            conn.execute('''\n                UPDATE forums \n                SET is_active = 0\n                WHERE id = ? AND course_id = ?\n            ''', (forum_id, course_id))\n            \n            conn.commit()\n            flash('Forum deleted successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error deleting forum. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_course_discussions', course_id=course_id))\n\n\n@app.route('/instructor/courses/<int:course_id>/forums/<int:forum_id>/topics/<int:topic_id>/reply', methods=['POST'])\n@instructor_required\ndef instructor_create_reply(course_id, forum_id, topic_id):\n    \"\"\"Create a reply to a discussion topic\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify course belongs to instructor or admin\n        course = conn.execute('''\n            SELECT * FROM courses \n            WHERE id = ? AND (instructor_id = ? OR ? = 1) AND is_active = 1\n        ''', (course_id, current_user.id, current_user.is_admin())).fetchone()\n        \n        if not course:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_courses'))\n        \n        # Verify forum and topic exist\n        topic = conn.execute('''\n            SELECT t.*, f.course_id\n            FROM forum_topics t\n            JOIN forums f ON t.forum_id = f.id\n            WHERE t.id = ? AND t.forum_id = ? AND f.course_id = ? AND f.is_active = 1\n        ''', (topic_id, forum_id, course_id)).fetchone()\n        \n        if not topic:\n            flash('Topic not found.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_course_discussions', course_id=course_id))\n        \n        content = request.form.get('content', '').strip()\n        \n        if not content:\n            flash('Reply content is required.', 'error')\n            conn.close()\n            return redirect(url_for('instructor_topic_detail', course_id=course_id, forum_id=forum_id, topic_id=topic_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forum_replies (topic_id, user_id, content)\n                VALUES (?, ?, ?)\n            ''', (topic_id, current_user.id, content))\n            \n            conn.commit()\n            flash('Reply posted successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error posting reply. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('instructor_topic_detail', course_id=course_id, forum_id=forum_id, topic_id=topic_id))\n\n\n# STUDENT CONTENT ACCESS ROUTES\n@app.route('/student/courses/<int:course_id>')\n@login_required\ndef student_course_view(course_id):\n    \"\"\"View course content as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.*, u.full_name as instructor_name,\n                   COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get course content\n        resources = conn.execute('''\n            SELECT * FROM course_resources \n            WHERE course_id = ?\n            ORDER BY upload_date DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get meeting links\n        meeting_links = conn.execute('''\n            SELECT * FROM course_meeting_links \n            WHERE course_id = ? AND is_active = 1\n            ORDER BY created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get video playlist\n        video_playlist = conn.execute('''\n            SELECT * FROM course_video_playlists \n            WHERE course_id = ? AND is_active = 1\n            ORDER BY order_index ASC\n        ''', (course_id,)).fetchall()\n        \n        # Get quizzes\n        quizzes = conn.execute('''\n            SELECT a.*, s.grade, s.submitted_at\n            FROM assignments a\n            LEFT JOIN assignment_submissions s ON a.id = s.assignment_id AND s.student_id = ?\n            WHERE a.course_id = ?\n            ORDER BY a.created_at DESC\n        ''', (current_user.id, course_id)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/course_view.html', \n                         enrollment=enrollment, course=enrollment, resources=resources, quizzes=quizzes,\n                         meeting_links=meeting_links, video_playlist=video_playlist)\n\n# STUDENT FORUM ACCESS ROUTES\n@app.route('/student/courses/<int:course_id>/forums')\n@login_required\ndef student_course_forums(course_id):\n    \"\"\"View course forums as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.*, u.full_name as instructor_name,\n                   COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get course forums and recent topics\n        forums = conn.execute('''\n            SELECT f.*, COUNT(t.id) as topic_count\n            FROM forums f\n            LEFT JOIN forum_topics t ON f.id = t.forum_id\n            WHERE f.course_id = ? AND f.is_active = 1\n            GROUP BY f.id\n            ORDER BY f.created_at DESC\n        ''', (course_id,)).fetchall()\n        \n        # Get recent forum activity\n        recent_topics = conn.execute('''\n            SELECT t.*, u.full_name as author_name, f.title as forum_title,\n                   COUNT(r.id) as reply_count\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            JOIN forums f ON t.forum_id = f.id\n            LEFT JOIN forum_replies r ON t.id = r.topic_id\n            WHERE f.course_id = ?\n            GROUP BY t.id\n            ORDER BY t.created_at DESC\n            LIMIT 10\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/course_forums.html', \n                         course=enrollment, forums=forums, recent_topics=recent_topics)\n\n@app.route('/student/courses/<int:course_id>/forums/<int:forum_id>/topics')\n@login_required\ndef student_forum_topics(course_id, forum_id):\n    \"\"\"View all topics in a forum as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.*, u.full_name as instructor_name,\n                   COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        \n        # Get all topics in this forum\n        topics = conn.execute('''\n            SELECT t.*, u.full_name as author_name, COUNT(r.id) as reply_count,\n                   MAX(COALESCE(r.created_at, t.created_at)) as last_activity\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            LEFT JOIN forum_replies r ON t.id = r.topic_id\n            WHERE t.forum_id = ?\n            GROUP BY t.id\n            ORDER BY t.is_pinned DESC, last_activity DESC\n        ''', (forum_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/forum_topics.html', \n                         course=enrollment, forum=forum, topics=topics)\n\n@app.route('/student/courses/<int:course_id>/forums/<int:forum_id>/topics/<int:topic_id>')\n@login_required\ndef student_topic_detail(course_id, forum_id, topic_id):\n    \"\"\"View topic details with replies as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.*, c.*, u.full_name as instructor_name,\n                   COALESCE(e.manual_progress_override, e.progress_percentage) as display_progress\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found.', 'error')\n            conn.close()\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        \n        # Get topic details\n        topic = conn.execute('''\n            SELECT t.*, u.full_name as author_name, u.role as author_role\n            FROM forum_topics t\n            JOIN users u ON t.user_id = u.id\n            WHERE t.id = ? AND t.forum_id = ?\n        ''', (topic_id, forum_id)).fetchone()\n        \n        if not topic:\n            flash('Topic not found.', 'error')\n            conn.close()\n            return redirect(url_for('student_forum_topics', course_id=course_id, forum_id=forum_id))\n        \n        # Get replies\n        replies = conn.execute('''\n            SELECT r.*, u.full_name as author_name, u.role as author_role\n            FROM forum_replies r\n            JOIN users u ON r.user_id = u.id\n            WHERE r.topic_id = ?\n            ORDER BY r.created_at ASC\n        ''', (topic_id,)).fetchall()\n        \n        # Update view count\n        conn.execute('UPDATE forum_topics SET view_count = view_count + 1 WHERE id = ?', (topic_id,))\n        conn.commit()\n        \n        conn.close()\n    \n    return render_template('student/topic_detail.html', \n                         course=enrollment, forum=forum, topic=topic, replies=replies)\n\n@app.route('/student/courses/<int:course_id>/forums/<int:forum_id>/topics/<int:topic_id>/reply', methods=['POST'])\n@login_required\ndef student_create_reply(course_id, forum_id, topic_id):\n    \"\"\"Create a reply to a discussion topic as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.status FROM enrollments e\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Verify forum and topic exist\n        topic = conn.execute('''\n            SELECT t.*, f.course_id\n            FROM forum_topics t\n            JOIN forums f ON t.forum_id = f.id\n            WHERE t.id = ? AND t.forum_id = ? AND f.course_id = ? AND f.is_active = 1\n        ''', (topic_id, forum_id, course_id)).fetchone()\n        \n        if not topic:\n            flash('Topic not found.', 'error')\n            conn.close()\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        \n        content = request.form.get('content', '').strip()\n        \n        if not content:\n            flash('Reply content is required.', 'error')\n            conn.close()\n            return redirect(url_for('student_topic_detail', course_id=course_id, forum_id=forum_id, topic_id=topic_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forum_replies (topic_id, user_id, content)\n                VALUES (?, ?, ?)\n            ''', (topic_id, current_user.id, content))\n            \n            conn.commit()\n            flash('Reply posted successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error posting reply. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('student_topic_detail', course_id=course_id, forum_id=forum_id, topic_id=topic_id))\n\n@app.route('/student/courses/<int:course_id>/forums/<int:forum_id>/topics/create', methods=['POST'])\n@login_required\ndef student_create_topic(course_id, forum_id):\n    \"\"\"Create a new discussion topic as student\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved\n        enrollment = conn.execute('''\n            SELECT e.status FROM enrollments e\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Verify forum belongs to this course\n        forum = conn.execute('''\n            SELECT * FROM forums \n            WHERE id = ? AND course_id = ? AND is_active = 1\n        ''', (forum_id, course_id)).fetchone()\n        \n        if not forum:\n            flash('Forum not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        \n        title = request.form.get('title', '').strip()\n        content = request.form.get('content', '').strip()\n        \n        if not title or not content:\n            flash('Topic title and content are required.', 'error')\n            conn.close()\n            return redirect(url_for('student_forum_topics', course_id=course_id, forum_id=forum_id))\n        \n        try:\n            conn.execute('''\n                INSERT INTO forum_topics (forum_id, user_id, title, content, is_pinned)\n                VALUES (?, ?, ?, ?, 0)\n            ''', (forum_id, current_user.id, title, content))\n            \n            conn.commit()\n            flash(f'Discussion topic \"{title}\" created successfully!', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error creating topic. Please try again.', 'error')\n        \n        conn.close()\n    \n    return redirect(url_for('student_forum_topics', course_id=course_id, forum_id=forum_id))\n\n@app.route('/uploads/instructor_screenshots/<filename>')\n@login_required\n@admin_required\ndef instructor_screenshot(filename):\n    \"\"\"Serve instructor screenshot files (admin only)\"\"\"\n    screenshots_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'instructor_screenshots')\n    return send_from_directory(screenshots_dir, filename)\n\n@app.route('/student/courses/<int:course_id>/resource/<int:resource_id>')\n@login_required\ndef student_download_resource(course_id, resource_id):\n    \"\"\"Secure file download for enrolled students\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled and approved in the course\n        enrollment = conn.execute('''\n            SELECT e.status FROM enrollments e\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Access denied. You are not enrolled in this course.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get the resource and verify it belongs to this course\n        resource = conn.execute('''\n            SELECT * FROM course_resources \n            WHERE id = ? AND course_id = ?\n        ''', (resource_id, course_id)).fetchone()\n        \n        conn.close()\n        \n        if not resource:\n            flash('Resource not found.', 'error')\n            return redirect(url_for('student_course_view', course_id=course_id))\n        \n        # Serve the file securely\n        try:\n            return send_from_directory(\n                os.path.dirname(resource['file_path']),\n                os.path.basename(resource['file_path']),\n                as_attachment=False\n            )\n        except FileNotFoundError:\n            flash('File not found on server.', 'error')\n            return redirect(url_for('student_course_view', course_id=course_id))\n\n@app.route('/student/quiz/<int:quiz_id>')\n@login_required\ndef student_take_quiz(quiz_id):\n    \"\"\"Take a quiz with MCQ questions\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled in the course\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title, e.status as enrollment_status\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            LEFT JOIN enrollments e ON c.id = e.course_id AND e.student_id = ?\n            WHERE a.id = ? AND e.status = 'approved'\n        ''', (current_user.id, quiz_id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Check if already submitted\n        submission = conn.execute('''\n            SELECT * FROM assignment_submissions \n            WHERE assignment_id = ? AND student_id = ?\n        ''', (quiz_id, current_user.id)).fetchone()\n        \n        # Get MCQ questions and options\n        questions = conn.execute('''\n            SELECT q.*, GROUP_CONCAT(\n                o.option_letter || '|' || o.option_text || '|' || o.is_correct, ':'\n            ) as options_data\n            FROM quiz_questions q\n            LEFT JOIN question_options o ON q.id = o.question_id\n            WHERE q.assignment_id = ?\n            GROUP BY q.id\n            ORDER BY q.id\n        ''', (quiz_id,)).fetchall()\n        \n        # Process questions and options\n        processed_questions = []\n        for question in questions:\n            question_dict = dict(question)\n            question_dict['options'] = {}\n            \n            if question['options_data']:\n                for option_data in question['options_data'].split(':'):\n                    if option_data:\n                        parts = option_data.split('|')\n                        if len(parts) >= 3:\n                            letter = parts[0]\n                            text = parts[1]\n                            is_correct = parts[2] == '1'\n                            question_dict['options'][letter] = {\n                                'text': text,\n                                'is_correct': is_correct\n                            }\n            \n            processed_questions.append(question_dict)\n        \n        # Get student's previous answers if any\n        student_answers = {}\n        if submission:\n            answers = conn.execute('''\n                SELECT question_id, selected_option \n                FROM student_mcq_answers \n                WHERE submission_id = ?\n            ''', (submission['id'],)).fetchall()\n            \n            for answer in answers:\n                student_answers[answer['question_id']] = answer['selected_option']\n        \n        conn.close()\n    \n    return render_template('student/take_quiz.html', \n                         quiz=quiz, \n                         submission=submission, \n                         questions=processed_questions,\n                         student_answers=student_answers)\n\n@app.route('/student/quiz/<int:quiz_id>/submit', methods=['POST'])\n@login_required\ndef student_submit_quiz(quiz_id):\n    \"\"\"Submit MCQ quiz answers\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify access\n        quiz = conn.execute('''\n            SELECT a.*, c.title as course_title, e.status as enrollment_status\n            FROM assignments a\n            JOIN courses c ON a.course_id = c.id\n            LEFT JOIN enrollments e ON c.id = e.course_id AND e.student_id = ?\n            WHERE a.id = ? AND e.status = 'approved'\n        ''', (current_user.id, quiz_id)).fetchone()\n        \n        if not quiz:\n            flash('Quiz not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get quiz questions for grading\n        questions = conn.execute('''\n            SELECT q.id, q.points, q.correct_answer\n            FROM quiz_questions q\n            WHERE q.assignment_id = ?\n            ORDER BY q.id\n        ''', (quiz_id,)).fetchall()\n        \n        try:\n            # Check if already submitted\n            existing = conn.execute('''\n                SELECT id FROM assignment_submissions \n                WHERE assignment_id = ? AND student_id = ?\n            ''', (quiz_id, current_user.id)).fetchone()\n            \n            # Calculate score from MCQ answers\n            total_score = 0\n            total_possible = 0\n            mcq_answers = []\n            \n            for question in questions:\n                question_key = f'question_{question[\"id\"]}'\n                selected_answer = request.form.get(question_key, '').strip()\n                \n                if selected_answer:\n                    is_correct = (selected_answer == question['correct_answer'])\n                    points_earned = question['points'] if is_correct else 0\n                    total_score += points_earned\n                    \n                    mcq_answers.append({\n                        'question_id': question['id'],\n                        'selected_option': selected_answer,\n                        'is_correct': is_correct,\n                        'points_earned': points_earned\n                    })\n                \n                total_possible += question['points']\n            \n            # Create submission text summary\n            submission_text = f\"MCQ Quiz Submission - {len(mcq_answers)} questions answered\"\n            \n            if existing:\n                # Update existing submission\n                conn.execute('''\n                    UPDATE assignment_submissions \n                    SET submission_text = ?, submitted_at = CURRENT_TIMESTAMP, grade = ?\n                    WHERE assignment_id = ? AND student_id = ?\n                ''', (submission_text, total_score, quiz_id, current_user.id))\n                \n                submission_id = existing['id']\n                \n                # Delete old MCQ answers\n                conn.execute('DELETE FROM student_mcq_answers WHERE submission_id = ?', (submission_id,))\n            else:\n                # Create new submission\n                cursor = conn.execute('''\n                    INSERT INTO assignment_submissions (assignment_id, student_id, submission_text, grade)\n                    VALUES (?, ?, ?, ?)\n                ''', (quiz_id, current_user.id, submission_text, total_score))\n                \n                submission_id = cursor.lastrowid\n            \n            # Save MCQ answers\n            for answer in mcq_answers:\n                conn.execute('''\n                    INSERT INTO student_mcq_answers \n                    (submission_id, question_id, selected_option, is_correct, points_earned)\n                    VALUES (?, ?, ?, ?, ?)\n                ''', (submission_id, answer['question_id'], answer['selected_option'], \n                     answer['is_correct'], answer['points_earned']))\n            \n            # Generate AI feedback\n            try:\n                ai_feedback = f\"Quiz completed! You scored {total_score}/{total_possible} ({(total_score / total_possible * 100) if total_possible > 0 else 0:.1f}%). You answered {sum(1 for ans in mcq_answers if ans['is_correct'])} out of {len(questions)} questions correctly.\"\n                \n                conn.execute('''\n                    UPDATE assignment_submissions \n                    SET ai_feedback = ?, graded_at = CURRENT_TIMESTAMP\n                    WHERE id = ?\n                ''', (ai_feedback, submission_id))\n                \n            except Exception as ai_error:\n                print(f\"AI feedback error: {ai_error}\")\n            \n            conn.commit()\n            \n            # Update student progress for this course\n            update_student_progress(conn, current_user.id, quiz['course_id'])\n            \n            percentage = (total_score / total_possible * 100) if total_possible > 0 else 0\n            flash(f'Quiz submitted successfully! Your score: {total_score}/{total_possible} ({percentage:.1f}%)', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            flash('Error submitting quiz. Please try again.', 'error')\n            print(f\"Quiz submission error: {e}\")\n        \n        conn.close()\n    \n    return redirect(url_for('student_take_quiz', quiz_id=quiz_id))\n\n# RANKINGS ROUTES\n@app.route('/student/courses/<int:course_id>/rankings')\n@login_required\ndef student_course_rankings(course_id):\n    \"\"\"View course rankings based on quiz scores\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify student is enrolled\n        enrollment = conn.execute('''\n            SELECT * FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            WHERE e.student_id = ? AND e.course_id = ? AND e.status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        if not enrollment:\n            flash('Course not found or access denied.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get rankings based on quiz scores\n        rankings = conn.execute('''\n            SELECT u.full_name, AVG(s.grade) as avg_score, COUNT(s.id) as quiz_count,\n                   RANK() OVER (ORDER BY AVG(s.grade) DESC) as rank\n            FROM users u\n            JOIN enrollments e ON u.id = e.student_id\n            JOIN assignment_submissions s ON u.id = s.student_id\n            JOIN assignments a ON s.assignment_id = a.id\n            WHERE e.course_id = ? AND e.status = 'approved' AND s.grade IS NOT NULL AND a.course_id = ?\n            GROUP BY u.id, u.full_name\n            HAVING quiz_count > 0\n            ORDER BY avg_score DESC\n        ''', (course_id, course_id)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/course_rankings.html', \n                         course=enrollment, rankings=rankings)\n\n# STUDENT ENROLLMENT ROUTES\n@app.route('/student/courses')\n@login_required\ndef student_browse_courses():\n    \"\"\"Browse available courses for enrollment\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get available courses (not already enrolled in)\n        available_courses = conn.execute('''\n            SELECT c.*, u.full_name as instructor_name,\n                   COUNT(e.id) as enrollment_count\n            FROM courses c\n            JOIN users u ON c.instructor_id = u.id\n            LEFT JOIN enrollments e ON c.id = e.course_id AND e.status = 'approved'\n            LEFT JOIN enrollments student_e ON c.id = student_e.course_id AND student_e.student_id = ?\n            WHERE c.is_active = 1 AND student_e.id IS NULL\n            GROUP BY c.id\n            ORDER BY c.created_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Get my enrollment requests\n        my_enrollments = conn.execute('''\n            SELECT e.*, c.title as course_title, c.course_code,\n                   u.full_name as instructor_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ?\n            ORDER BY e.enrolled_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('student/browse_courses.html', \n                         available_courses=available_courses,\n                         my_enrollments=my_enrollments)\n\n@app.route('/student/enroll', methods=['POST'])\n@login_required\ndef student_enroll():\n    \"\"\"Enroll in a course with enrollment key\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    course_code = request.form.get('course_code', '').strip().upper()\n    enrollment_key = request.form.get('enrollment_key', '').strip()\n    \n    if not course_code or not enrollment_key:\n        flash('Course code and enrollment key are required.', 'error')\n        return redirect(url_for('student_browse_courses'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        # Find the course\n        course = conn.execute('''\n            SELECT c.*, u.full_name as instructor_name\n            FROM courses c\n            JOIN users u ON c.instructor_id = u.id\n            WHERE c.course_code = ? AND c.is_active = 1\n        ''', (course_code,)).fetchone()\n        \n        if not course:\n            flash(f'Course with code \"{course_code}\" not found or is inactive.', 'error')\n            conn.close()\n            return redirect(url_for('student_browse_courses'))\n        \n        # Check if enrollment key is correct\n        if not course['enrollment_key_hash'] or not check_password_hash(course['enrollment_key_hash'], enrollment_key):\n            flash('Invalid enrollment key. Please check with your instructor.', 'error')\n            conn.close()\n            return redirect(url_for('student_browse_courses'))\n        \n        # Check if already enrolled\n        existing_enrollment = conn.execute('''\n            SELECT id FROM enrollments \n            WHERE student_id = ? AND course_id = ?\n        ''', (current_user.id, course['id'])).fetchone()\n        \n        if existing_enrollment:\n            flash('You have already requested enrollment for this course.', 'warning')\n            conn.close()\n            return redirect(url_for('student_browse_courses'))\n        \n        # Check course capacity\n        current_enrollments = conn.execute('''\n            SELECT COUNT(*) as count FROM enrollments \n            WHERE course_id = ? AND status = 'approved'\n        ''', (course['id'],)).fetchone()\n        \n        if current_enrollments['count'] >= course['max_students']:\n            flash('Course is full. No more enrollments accepted.', 'warning')\n            conn.close()\n            return redirect(url_for('student_browse_courses'))\n        \n        try:\n            # Create enrollment request\n            conn.execute('''\n                INSERT INTO enrollments (student_id, course_id, status)\n                VALUES (?, ?, 'pending')\n            ''', (current_user.id, course['id']))\n            \n            # Create notification for the instructor\n            conn.execute('''\n                INSERT INTO notifications (user_id, title, message, type, related_id)\n                VALUES (?, ?, ?, ?, ?)\n            ''', (course['instructor_id'],\n                  'New Enrollment Request',\n                  f'{current_user.full_name} has requested enrollment in \"{course[\"title\"]}\" ({course_code}). Please review and approve.',\n                  'info',\n                  course['id']))\n            \n            conn.commit()\n            conn.close()\n            \n            flash(f'Enrollment request submitted for \"{course[\"title\"]}\"! Your instructor ({course[\"instructor_name\"]}) will review and approve your request.', 'success')\n            \n        except Exception as e:\n            conn.rollback()\n            conn.close()\n            flash('Error submitting enrollment request. Please try again.', 'error')\n    \n    return redirect(url_for('student_browse_courses'))\n\n@app.route('/student/enrollments')\n@login_required\ndef student_my_enrollments():\n    \"\"\"View my enrollment status\"\"\"\n    if not current_user.is_student():\n        flash('Access denied. Student account required.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    with db_lock:\n        conn = get_db_connection()\n        \n        enrollments = conn.execute('''\n            SELECT e.*, c.title as course_title, c.course_code, c.description,\n                   u.full_name as instructor_name\n            FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            JOIN users u ON c.instructor_id = u.id\n            WHERE e.student_id = ?\n            ORDER BY \n                CASE e.status \n                    WHEN 'pending' THEN 1\n                    WHEN 'approved' THEN 2\n                    WHEN 'rejected' THEN 3\n                END,\n                e.enrolled_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Statistics\n        stats = {\n            'total_enrollments': len(enrollments),\n            'pending_enrollments': len([e for e in enrollments if e['status'] == 'pending']),\n            'approved_enrollments': len([e for e in enrollments if e['status'] == 'approved']),\n            'rejected_enrollments': len([e for e in enrollments if e['status'] == 'rejected'])\n        }\n        \n        conn.close()\n    \n    return render_template('student/my_enrollments.html', \n                         enrollments=enrollments, \n                         stats=stats)\n\n# NEW FEATURE: Real-Time Discussion Forum (SMS-like messaging)\n@app.route('/course/<int:course_id>/discussion')\n@login_required\ndef course_discussion_forum(course_id):\n    \"\"\"Real-time discussion forum for course - SMS-like messaging between students and teachers\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Verify user has access to this course\n        course = conn.execute('SELECT * FROM courses WHERE id = ?', (course_id,)).fetchone()\n        \n        if not course:\n            flash('Course not found.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Check access\n        access = conn.execute('''\n            SELECT 1 FROM enrollments \n            WHERE student_id = ? AND course_id = ? AND status = 'approved'\n        ''', (current_user.id, course_id)).fetchone()\n        \n        is_instructor = (current_user.id == course['instructor_id'])\n        \n        if not access and not is_instructor and not current_user.is_admin():\n            flash('You do not have access to this course.', 'error')\n            conn.close()\n            return redirect(url_for('dashboard'))\n        \n        # Get existing messages\n        messages = conn.execute('''\n            SELECT cm.*, u.full_name as sender_name, u.role as sender_role\n            FROM chat_messages cm\n            JOIN users u ON cm.sender_id = u.id\n            WHERE cm.course_id = ?\n            ORDER BY cm.created_at ASC\n        ''', (course_id,)).fetchall()\n        \n        conn.close()\n    \n    return render_template('course_discussion.html', course=course, messages=messages)\n\n# Error handlers\n@app.errorhandler(404)\ndef not_found_error(error):\n    return render_template('errors/404.html'), 404\n\n@app.errorhandler(500)\ndef internal_error(error):\n    return render_template('errors/500.html'), 500\n\n# SocketIO events for real-time chat\n@socketio.on('connect')\ndef on_connect():\n    if not current_user.is_authenticated:\n        return False\n    join_room(f'user_{current_user.id}')\n    emit('status', {'msg': f'{current_user.full_name} has connected'})\n\n# NOTIFICATIONS ROUTES\n@app.route('/notifications')\n@login_required\ndef notifications():\n    \"\"\"View all notifications for current user\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        notifications = conn.execute('''\n            SELECT * FROM notifications \n            WHERE user_id = ? \n            ORDER BY created_at DESC\n        ''', (current_user.id,)).fetchall()\n        \n        # Mark all as read\n        conn.execute('''\n            UPDATE notifications \n            SET is_read = 1 \n            WHERE user_id = ? AND is_read = 0\n        ''', (current_user.id,))\n        \n        conn.commit()\n        conn.close()\n    \n    return render_template('notifications.html', notifications=notifications)\n\n@app.route('/api/notifications/unread-count')\n@login_required\ndef get_unread_notifications_count():\n    \"\"\"Get count of unread notifications\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            \n            result = conn.execute('''\n                SELECT COUNT(*) as count FROM notifications \n                WHERE user_id = ? AND is_read = 0\n            ''', (current_user.id,)).fetchone()\n            \n            count = result['count'] if result else 0\n            conn.close()\n        \n        return jsonify({'count': count})\n    except Exception as e:\n        print(f\"Error getting unread notifications: {e}\")\n        return jsonify({'count': 0, 'error': str(e)}), 200\n\n@app.route('/api/unread-messages/count')\n@login_required\ndef get_unread_messages_count():\n    \"\"\"Get count of unread messages in all courses\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            \n            # Count unread messages in courses where user is enrolled\n            result = conn.execute('''\n                SELECT COUNT(*) as count FROM chat_messages cm\n                JOIN enrollments e ON cm.course_id = e.course_id\n                WHERE e.student_id = ? AND cm.sender_id != ? AND cm.created_at > (\n                    SELECT COALESCE(MAX(viewed_at), '2020-01-01') FROM chat_messages\n                    WHERE course_id = cm.course_id AND sender_id = ?\n                )\n            ''', (current_user.id, current_user.id, current_user.id)).fetchone()\n            \n            count = result['count'] if result else 0\n            conn.close()\n        \n        return jsonify({'count': count})\n    except Exception as e:\n        print(f\"Error getting unread messages: {e}\")\n        return jsonify({'count': 0, 'error': str(e)}), 200\n\n@app.route('/api/generate-mcq-options', methods=['POST'])\n@instructor_required\ndef api_generate_mcq_options():\n    \"\"\"API endpoint to generate MCQ options using AI\"\"\"\n    data = request.get_json()\n    question_text = data.get('question', '').strip()\n    context = data.get('context', '').strip()\n    \n    if not question_text:\n        return jsonify({'error': 'Question text is required'}), 400\n    \n    try:\n        options = gemini_ai.generate_mcq_options(question_text, context)\n        \n        if options:\n            return jsonify({\n                'success': True,\n                'options': options\n            })\n        else:\n            return jsonify({\n                'success': False,\n                'error': 'Failed to generate options. Please try again.'\n            }), 500\n            \n    except Exception as e:\n        print(f\"Error generating MCQ options: {e}\")\n        return jsonify({\n            'success': False,\n            'error': 'An error occurred while generating options'\n        }), 500\n\n@app.route('/api/submissions/<int:submission_id>')\n@login_required\ndef api_get_submission(submission_id):\n    \"\"\"API endpoint to get detailed submission data for instructors\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get submission with student and quiz info\n        submission = conn.execute('''\n            SELECT s.*, u.full_name as student_name, u.username, u.email,\n                   a.title as quiz_title, a.course_id, c.instructor_id\n            FROM assignment_submissions s\n            JOIN users u ON s.student_id = u.id\n            JOIN assignments a ON s.assignment_id = a.id\n            JOIN courses c ON a.course_id = c.id\n            WHERE s.id = ?\n        ''', (submission_id,)).fetchone()\n        \n        if not submission:\n            conn.close()\n            return jsonify({'error': 'Submission not found'}), 404\n        \n        # Check if user has access (instructor of the course)\n        if not current_user.is_admin() and submission['instructor_id'] != current_user.id:\n            conn.close()\n            return jsonify({'error': 'Access denied'}), 403\n        \n        # Get MCQ answers\n        answers = conn.execute('''\n            SELECT ma.*, q.question_text, q.option_a, q.option_b, q.option_c, q.option_d,\n                   q.correct_answer, q.points\n            FROM student_mcq_answers ma\n            JOIN quiz_questions q ON ma.question_id = q.id\n            WHERE ma.submission_id = ?\n            ORDER BY q.id\n        ''', (submission_id,)).fetchall()\n        \n        conn.close()\n        \n        # Format response\n        response = {\n            'submission_id': submission['id'],\n            'student_name': submission['student_name'],\n            'username': submission['username'],\n            'email': submission['email'],\n            'quiz_title': submission['quiz_title'],\n            'submitted_at': submission['submitted_at'],\n            'grade': submission['grade'],\n            'ai_feedback': submission['ai_feedback'],\n            'answers': []\n        }\n        \n        for answer in answers:\n            response['answers'].append({\n                'question_id': answer['question_id'],\n                'question_text': answer['question_text'],\n                'options': {\n                    'A': answer['option_a'],\n                    'B': answer['option_b'],\n                    'C': answer['option_c'],\n                    'D': answer['option_d']\n                },\n                'selected_option': answer['selected_option'],\n                'correct_answer': answer['correct_answer'],\n                'is_correct': answer['is_correct'],\n                'points_earned': answer['points_earned'],\n                'points_possible': answer['points']\n            })\n        \n        return jsonify(response)\n\n@app.route('/notifications/<int:notification_id>/mark-read', methods=['POST'])\n@login_required  \ndef mark_notification_read(notification_id):\n    \"\"\"Mark specific notification as read\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        conn.execute('''\n            UPDATE notifications \n            SET is_read = 1 \n            WHERE id = ? AND user_id = ?\n        ''', (notification_id, current_user.id))\n        \n        conn.commit()\n        conn.close()\n    \n    return jsonify({'success': True})\n\n@app.route('/notifications/<int:notification_id>/redirect')\n@login_required\ndef handle_notification_redirect(notification_id):\n    \"\"\"Redirect user to relevant page based on notification type and mark as read\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        notification = conn.execute('''\n            SELECT * FROM notifications WHERE id = ? AND user_id = ?\n        ''', (notification_id, current_user.id)).fetchone()\n        \n        if notification:\n            conn.execute('UPDATE notifications SET is_read = 1 WHERE id = ?', (notification_id,))\n            conn.commit()\n        \n        conn.close()\n    \n    if not notification:\n        return redirect(url_for('dashboard'))\n    \n    # Route based on notification type and content\n    message_lower = notification['message'].lower()\n    course_id = notification['related_id']\n    \n    # Check what type of notification this is\n    if 'forum' in message_lower or 'discussion' in message_lower or 'topic' in message_lower:\n        # Redirect to course forums if we have a course ID\n        if course_id:\n            return redirect(url_for('student_course_forums', course_id=course_id))\n        else:\n            return redirect(url_for('dashboard'))\n    \n    elif 'message' in message_lower or 'chat' in message_lower or 'community' in message_lower:\n        # Redirect to course discussion\n        if course_id:\n            return redirect(url_for('course_discussion_forum', course_id=course_id))\n        else:\n            return redirect(url_for('dashboard'))\n    \n    elif 'quiz' in message_lower or 'assignment' in message_lower or 'grade' in message_lower:\n        # Redirect to course page for quiz/assignment notifications\n        if course_id:\n            return redirect(url_for('student_course_view', course_id=course_id))\n        else:\n            return redirect(url_for('dashboard'))\n    \n    elif 'enrollment' in message_lower or 'course' in message_lower or 'approved' in message_lower:\n        # Redirect to course if available\n        if course_id:\n            return redirect(url_for('student_course_view', course_id=course_id))\n        else:\n            return redirect(url_for('dashboard'))\n    \n    elif 'progress' in message_lower:\n        # Redirect to course for progress updates\n        if course_id:\n            return redirect(url_for('student_course_view', course_id=course_id))\n        else:\n            return redirect(url_for('dashboard'))\n    \n    # Default fallback\n    if course_id:\n        return redirect(url_for('student_course_view', course_id=course_id))\n    \n    return redirect(url_for('dashboard'))\n\n# API ENDPOINTS FOR FETCHING MESSAGES\n@app.route('/api/course/<int:course_id>/messages')\n@login_required\ndef get_course_messages(course_id):\n    \"\"\"Get all messages for a course\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            \n            # Verify access\n            access = conn.execute('''\n                SELECT 1 FROM enrollments \n                WHERE student_id = ? AND course_id = ? AND status = 'approved'\n            ''', (current_user.id, course_id)).fetchone()\n            \n            is_instructor = conn.execute('''\n                SELECT 1 FROM courses WHERE id = ? AND instructor_id = ?\n            ''', (course_id, current_user.id)).fetchone()\n            \n            if not (access or is_instructor or current_user.is_admin()):\n                conn.close()\n                return jsonify({'error': 'Access denied'}), 403\n            \n            messages = conn.execute('''\n                SELECT cm.*, u.full_name, u.role \n                FROM chat_messages cm\n                JOIN users u ON cm.sender_id = u.id\n                WHERE cm.course_id = ?\n                ORDER BY cm.created_at ASC\n            ''', (course_id,)).fetchall()\n            \n            conn.close()\n        \n        return jsonify({\n            'success': True,\n            'messages': [dict(m) for m in messages] if messages else []\n        })\n    except Exception as e:\n        print(f\"Error fetching course messages: {e}\")\n        return jsonify({'success': False, 'messages': [], 'error': str(e)}), 200\n\n# SOCKETIO CHAT HANDLERS\n@socketio.on('disconnect')\ndef on_disconnect():\n    if current_user.is_authenticated:\n        leave_room(f'user_{current_user.id}')\n\n@socketio.on('join_course_chat')\ndef on_join_course(data):\n    if not current_user.is_authenticated:\n        return\n    \n    course_id = data['course_id']\n    \n    # Verify user has access to this course\n    with db_lock:\n        conn = get_db_connection()\n        access = conn.execute('''\n            SELECT 1 FROM enrollments e\n            JOIN courses c ON e.course_id = c.id\n            WHERE (e.student_id = ? OR c.instructor_id = ?) AND c.id = ? AND e.status = 'approved'\n        ''', (current_user.id, current_user.id, course_id)).fetchone()\n        conn.close()\n    \n    if access or current_user.is_admin():\n        join_room(f'course_{course_id}')\n        socketio.emit('status', {'msg': f'{current_user.full_name} joined the course chat'}, to=f'course_{course_id}')\n\n@socketio.on('send_course_message')\ndef handle_course_message(data):\n    if not current_user.is_authenticated:\n        return\n    \n    course_id = data['course_id']\n    message = data['message'].strip()\n    sender_role = data.get('sender_role', current_user.role)\n    \n    if not message:\n        return\n    \n    # Save message to database\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Insert message\n        conn.execute('''\n            INSERT INTO chat_messages (course_id, sender_id, message)\n            VALUES (?, ?, ?)\n        ''', (course_id, current_user.id, message))\n        \n        # Get all students in the course to send notifications\n        students = conn.execute('''\n            SELECT student_id FROM enrollments \n            WHERE course_id = ? AND status = 'approved' AND student_id != ?\n        ''', (course_id, current_user.id)).fetchall()\n        \n        conn.commit()\n        conn.close()\n    \n    # Emit message to course room\n    socketio.emit('new_course_message', {\n        'message': message,\n        'sender_name': current_user.full_name,\n        'sender_id': current_user.id,\n        'sender_role': sender_role,\n        'course_id': course_id,\n        'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n    }, to=f'course_{course_id}')\n    \n    # Send notifications to all other students in the course\n    for student in students:\n        socketio.emit('new_message_notification', {\n            'title': f'ðŸ’¬ New Message in Course',\n            'message': f'{current_user.full_name}: {message[:50]}{\"...\" if len(message) > 50 else \"\"}',\n            'type': 'info',\n            'icon': 'fa-comments',\n            'course_id': course_id,\n            'action_url': f'/discussions/{course_id}'\n        }, to=f'user_{student[\"student_id\"]}')\n\n# COMMUNITY CHAT HANDLERS\n@socketio.on('join_community_chat')\ndef on_join_community(data):\n    if not current_user.is_authenticated:\n        return\n    join_room('community_chat')\n\n@socketio.on('send_community_message')\ndef handle_community_message(data):\n    if not current_user.is_authenticated:\n        return\n    \n    message = data.get('message', '').strip()\n    sender_role = data.get('sender_role', current_user.role)\n    file_path = data.get('file_path')\n    file_name = data.get('file_name')\n    is_image = data.get('is_image', 0)\n    is_video = data.get('is_video', 0)\n    profile_picture = data.get('profile_picture', current_user.profile_picture)\n    \n    if not message:\n        return\n    \n    # Save to database\n    message_id = None\n    with db_lock:\n        conn = get_db_connection()\n        cursor = conn.execute('''\n            INSERT INTO chat_messages (course_id, sender_id, message, message_type, file_path, file_name, is_image)\n            VALUES (NULL, ?, ?, ?, ?, ?, ?)\n        ''', (current_user.id, message, 'file' if file_path else 'text', file_path, file_name, is_image or is_video))\n        message_id = cursor.lastrowid\n        conn.commit()\n        conn.close()\n    \n    socketio.emit('new_community_message', {\n        'id': message_id,\n        'message': message,\n        'sender_name': current_user.full_name,\n        'sender_id': current_user.id,\n        'sender_role': sender_role,\n        'profile_picture': profile_picture,\n        'file_path': file_path,\n        'file_name': file_name,\n        'is_image': is_image,\n        'is_video': is_video,\n        'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n    }, to='community_chat')\n\n# DIRECT MESSAGE HANDLERS (Admin/Instructor Chat)\n@socketio.on('join_direct_chat')\ndef on_join_direct_chat(data):\n    if not current_user.is_authenticated:\n        return\n    \n    recipient_id = data.get('recipient_id')\n    room = f'direct_{min(current_user.id, recipient_id)}_{max(current_user.id, recipient_id)}'\n    join_room(room)\n\n@socketio.on('send_direct_message')\ndef handle_direct_message(data):\n    if not current_user.is_authenticated:\n        return\n    \n    recipient_id = data.get('recipient_id')\n    message = data.get('message', '').strip()\n    \n    if not message or not recipient_id:\n        return\n    \n    # Save to database\n    with db_lock:\n        conn = get_db_connection()\n        conn.execute('''\n            INSERT INTO direct_messages (sender_id, recipient_id, message)\n            VALUES (?, ?, ?)\n        ''', (current_user.id, recipient_id, message))\n        conn.commit()\n        conn.close()\n    \n    room = f'direct_{min(current_user.id, recipient_id)}_{max(current_user.id, recipient_id)}'\n    socketio.emit('new_direct_message', {\n        'sender_name': current_user.full_name,\n        'sender_id': current_user.id,\n        'message': message,\n        'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n    }, to=room)\n    \n    # Send notification to recipient\n    socketio.emit('direct_message_notification', {\n        'title': f'ðŸ’Œ Direct Message from {current_user.full_name}',\n        'message': message[:50],\n        'type': 'warning',\n        'icon': 'fa-envelope'\n    }, to=f'user_{recipient_id}')\n\n# FILE UPLOAD HANDLER\n@app.route('/api/upload-chat-file', methods=['POST'])\n@login_required\ndef upload_chat_file():\n    \"\"\"Upload file to chat\"\"\"\n    try:\n        if 'file' not in request.files:\n            return jsonify({'error': 'No file provided'}), 400\n        \n        file = request.files['file']\n        course_id = request.form.get('course_id')\n        message_text = request.form.get('message', '')\n        \n        if not file.filename:\n            return jsonify({'error': 'No file selected'}), 400\n        \n        # Check file extension\n        file_ext = file.filename.rsplit('.', 1)[-1].lower()\n        if file_ext not in ALLOWED_FILE_TYPES:\n            return jsonify({'error': f'File type .{file_ext} not allowed'}), 400\n        \n        # Check file size\n        file.seek(0, 2)\n        file_size = file.tell()\n        file.seek(0)\n        \n        if file_size > MAX_CHAT_FILE_SIZE:\n            return jsonify({'error': f'File size exceeds {MAX_CHAT_FILE_SIZE / (1024*1024):.0f} MB limit'}), 400\n        \n        # Check user storage\n        with db_lock:\n            conn = get_db_connection()\n            user_storage = conn.execute('''\n                SELECT SUM(file_size) as total FROM file_uploads \n                WHERE uploader_id = ?\n            ''', (current_user.id,)).fetchone()\n            total_used = user_storage['total'] or 0\n            conn.close()\n        \n        if total_used + file_size > MAX_TOTAL_STORAGE_PER_USER:\n            return jsonify({'error': 'Storage limit exceeded (5 GB per user)'}), 400\n        \n        # Save file\n        unique_filename = f\"{current_user.id}_{uuid.uuid4().hex}_{secure_filename(file.filename)}\"\n        original_filename = file.filename\n        upload_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'chat_files')\n        filepath = os.path.join(upload_dir, unique_filename)\n        file.save(filepath)\n        \n        # Determine if image\n        is_image = file_ext in {'jpg', 'jpeg', 'png', 'gif'}\n        \n        # Save to database\n        with db_lock:\n            conn = get_db_connection()\n            conn.execute('''\n                INSERT INTO chat_messages \n                (course_id, sender_id, message, message_type, file_path, file_name, file_size, is_image)\n                VALUES (?, ?, ?, ?, ?, ?, ?, ?)\n            ''', (course_id, current_user.id, message_text or original_filename, 'file', unique_filename, original_filename, file_size, is_image))\n            \n            message_id = conn.execute('SELECT last_insert_rowid()').fetchone()[0]\n            \n            conn.execute('''\n                INSERT INTO file_uploads (uploader_id, file_name, file_path, file_size, file_type, message_id)\n                VALUES (?, ?, ?, ?, ?, ?)\n            ''', (current_user.id, original_filename, unique_filename, file_size, file_ext, message_id))\n            \n            conn.commit()\n            conn.close()\n        \n        return jsonify({\n            'success': True,\n            'file_path': f'/uploads/chat_files/{unique_filename}',\n            'file_name': original_filename,\n            'file_type': file_ext\n        })\n        \n    except Exception as e:\n        logging.error(f\"File upload error: {e}\")\n        return jsonify({'error': str(e)}), 500\n\n@app.route('/download-chat-file/<filename>')\n@login_required\ndef download_chat_file(filename):\n    \"\"\"Download uploaded chat file\"\"\"\n    try:\n        filepath = os.path.join(app.config['UPLOAD_FOLDER'], 'chat_files', filename)\n        if os.path.exists(filepath):\n            return send_from_directory(os.path.dirname(filepath), filename, as_attachment=True)\n        return jsonify({'error': 'File not found'}), 404\n    except Exception as e:\n        return jsonify({'error': str(e)}), 500\n\n@app.route('/uploads/chat_files/<filename>')\n@login_required\ndef serve_chat_file(filename):\n    \"\"\"Serve uploaded chat files\"\"\"\n    return send_from_directory(os.path.join(app.config['UPLOAD_FOLDER'], 'chat_files'), filename)\n\n# MESSAGING HUB ROUTE\n@app.route('/forum')\n@login_required\ndef messaging_hub():\n    \"\"\"Central messaging hub showing all chat options\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        \n        # Get user's courses if student\n        my_courses = []\n        if current_user.role == 'student':\n            my_courses = conn.execute('''\n                SELECT c.id, c.title, c.course_code \n                FROM courses c\n                JOIN enrollments e ON c.id = e.course_id\n                WHERE e.student_id = ? AND e.status = 'approved'\n                ORDER BY c.title\n            ''', (current_user.id,)).fetchall()\n        \n        # Get instructor's courses\n        instructor_courses = []\n        if current_user.is_instructor() or current_user.is_admin():\n            instructor_courses = conn.execute('''\n                SELECT id, title, course_code FROM courses \n                WHERE instructor_id = ?\n                ORDER BY title\n            ''', (current_user.id,)).fetchall()\n        \n        # Get all courses for admin\n        all_courses = []\n        if current_user.is_admin():\n            all_courses = conn.execute('''\n                SELECT c.id, c.title, c.course_code, u.full_name as instructor_name\n                FROM courses c\n                LEFT JOIN users u ON c.instructor_id = u.id\n                ORDER BY c.title\n            ''', ).fetchall()\n        \n        conn.close()\n    \n    return render_template('messaging_hub.html', \n                         my_courses=my_courses,\n                         instructor_courses=instructor_courses,\n                         all_courses=all_courses)\n\n# COMMUNITY CHAT ROUTE\n@app.route('/community-chat')\n@login_required\ndef community_chat():\n    \"\"\"Display community chat (all users)\"\"\"\n    return render_template('community_chat.html')\n\n# DIRECT MESSAGES CRUD ROUTES\n@app.route('/direct-messages')\n@login_required\ndef direct_messages_page():\n    \"\"\"Display direct messages page\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        # Get all students for instructor/admin, or instructors for students\n        if current_user.is_admin() or current_user.is_instructor():\n            users = conn.execute('''\n                SELECT DISTINCT u.id, u.full_name, u.role FROM users u\n                WHERE u.role = 'student' AND u.id != ?\n                ORDER BY u.full_name\n            ''', (current_user.id,)).fetchall()\n        else:\n            users = conn.execute('''\n                SELECT DISTINCT u.id, u.full_name, u.role FROM users u\n                WHERE (u.role = 'instructor' OR u.role = 'admin') AND u.id != ?\n                ORDER BY u.full_name\n            ''', (current_user.id,)).fetchall()\n        conn.close()\n    \n    return render_template('direct_messages.html', users=users)\n\n@app.route('/api/direct-messages/<int:user_id>')\n@login_required\ndef get_direct_messages(user_id):\n    \"\"\"Get direct messages with a specific user\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            messages = conn.execute('''\n                SELECT id, sender_id, recipient_id, message, created_at \n                FROM direct_messages \n                WHERE (sender_id = ? AND recipient_id = ?) OR (sender_id = ? AND recipient_id = ?)\n                ORDER BY created_at ASC\n                LIMIT 100\n            ''', (current_user.id, user_id, user_id, current_user.id)).fetchall()\n            \n            # Mark as read\n            conn.execute('''\n                UPDATE direct_messages SET is_read = 1 \n                WHERE recipient_id = ? AND sender_id = ? AND is_read = 0\n            ''', (current_user.id, user_id))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'messages': [dict(m) for m in messages]})\n    except Exception as e:\n        print(f\"Error loading direct messages: {e}\")\n        return jsonify({'messages': [], 'error': str(e)}), 200\n\n@app.route('/api/direct-messages/<int:message_id>', methods=['DELETE'])\n@login_required\ndef delete_direct_message(message_id):\n    \"\"\"Delete a direct message\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            # Verify ownership\n            msg = conn.execute('SELECT sender_id FROM direct_messages WHERE id = ?', (message_id,)).fetchone()\n            \n            if not msg or msg['sender_id'] != current_user.id:\n                conn.close()\n                return jsonify({'error': 'Unauthorized'}), 403\n            \n            conn.execute('DELETE FROM direct_messages WHERE id = ?', (message_id,))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        print(f\"Error deleting message: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 200\n\n@app.route('/api/direct-messages/<int:message_id>', methods=['PATCH'])\n@login_required\ndef edit_direct_message(message_id):\n    \"\"\"Edit a direct message\"\"\"\n    try:\n        data = request.get_json()\n        message = data.get('message', '').strip() if data else ''\n        \n        if not message:\n            return jsonify({'error': 'Message cannot be empty'}), 400\n        \n        with db_lock:\n            conn = get_db_connection()\n            # Verify ownership\n            msg = conn.execute('SELECT sender_id FROM direct_messages WHERE id = ?', (message_id,)).fetchone()\n            \n            if not msg or msg['sender_id'] != current_user.id:\n                conn.close()\n                return jsonify({'error': 'Unauthorized'}), 403\n            \n            conn.execute('UPDATE direct_messages SET message = ? WHERE id = ?', (message, message_id))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        print(f\"Error editing message: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 200\n\n# USER PROFILE ENDPOINTS\n@app.route('/api/profile/bio', methods=['POST'])\n@login_required\ndef update_bio():\n    \"\"\"Update user bio\"\"\"\n    try:\n        data = request.get_json()\n        bio = data.get('bio', '').strip()[:500]\n        \n        with db_lock:\n            conn = get_db_connection()\n            conn.execute('UPDATE users SET bio = ? WHERE id = ?', (bio, current_user.id))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        return jsonify({'success': False, 'error': str(e)}), 200\n\n@app.route('/api/profile/phone', methods=['POST'])\n@login_required\ndef update_phone():\n    \"\"\"Update phone number\"\"\"\n    try:\n        data = request.get_json()\n        phone = data.get('phone', '').strip()\n        \n        with db_lock:\n            conn = get_db_connection()\n            conn.execute('''INSERT OR REPLACE INTO user_profiles (user_id, phone_number)\n                VALUES (?, ?)''', (current_user.id, phone))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        return jsonify({'success': False, 'error': str(e)}), 200\n\n@app.route('/api/contacts')\n@login_required\ndef get_contacts():\n    \"\"\"Get user contacts\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            contacts = conn.execute('''SELECT u.id, u.full_name FROM contacts c\n                JOIN users u ON c.contact_id = u.id WHERE c.user_id = ?\n                ORDER BY u.full_name''', (current_user.id,)).fetchall()\n            conn.close()\n        \n        return jsonify({'contacts': [dict(c) for c in contacts]})\n    except Exception as e:\n        return jsonify({'contacts': [], 'error': str(e)}), 200\n\n@app.route('/api/messages/<int:message_id>/react', methods=['POST'])\n@login_required\ndef add_reaction(message_id):\n    \"\"\"Add emoji reaction to message\"\"\"\n    try:\n        data = request.get_json()\n        emoji = data.get('emoji', '').strip()[:2]\n        \n        if not emoji:\n            return jsonify({'error': 'Invalid emoji'}), 400\n        \n        with db_lock:\n            conn = get_db_connection()\n            conn.execute('''INSERT OR IGNORE INTO message_reactions (message_id, user_id, emoji)\n                VALUES (?, ?, ?)''', (message_id, current_user.id, emoji))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        return jsonify({'success': False}), 200\n\n# CRUD OPERATIONS FOR CHAT MESSAGES\n@app.route('/api/chat-messages/<int:message_id>', methods=['PATCH'])\n@login_required\ndef edit_chat_message(message_id):\n    \"\"\"Edit a chat message (community or course)\"\"\"\n    try:\n        data = request.get_json()\n        message = data.get('message', '').strip()\n        \n        if not message:\n            return jsonify({'error': 'Message cannot be empty'}), 400\n        \n        with db_lock:\n            conn = get_db_connection()\n            # Verify ownership\n            msg = conn.execute('SELECT sender_id FROM chat_messages WHERE id = ?', (message_id,)).fetchone()\n            \n            if not msg or msg['sender_id'] != current_user.id:\n                conn.close()\n                return jsonify({'error': 'Unauthorized'}), 403\n            \n            conn.execute('UPDATE chat_messages SET message = ? WHERE id = ?', (message, message_id))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True, 'message': message})\n    except Exception as e:\n        logging.error(f\"Error editing message: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n@app.route('/api/chat-messages/<int:message_id>', methods=['DELETE'])\n@login_required\ndef delete_chat_message(message_id):\n    \"\"\"Delete a chat message (community or course)\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            # Verify ownership\n            msg = conn.execute('SELECT sender_id FROM chat_messages WHERE id = ?', (message_id,)).fetchone()\n            \n            if not msg or msg['sender_id'] != current_user.id:\n                conn.close()\n                return jsonify({'error': 'Unauthorized'}), 403\n            \n            conn.execute('DELETE FROM chat_messages WHERE id = ?', (message_id,))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    except Exception as e:\n        logging.error(f\"Error deleting message: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n@socketio.on('user_typing')\ndef handle_typing(data):\n    \"\"\"Broadcast typing indicator\"\"\"\n    if not current_user.is_authenticated:\n        return\n    \n    socketio.emit('user_typing', {\n        'user_id': current_user.id,\n        'user_name': current_user.full_name,\n        'room': data.get('room')\n    }, to=data.get('room'))\n\n@socketio.on('update_status')\ndef update_status(data):\n    \"\"\"Update user online/offline status\"\"\"\n    if not current_user.is_authenticated:\n        return\n    \n    with db_lock:\n        conn = get_db_connection()\n        status = data.get('status', 'online')\n        conn.execute('''INSERT OR REPLACE INTO user_profiles (user_id, status, last_seen)\n            VALUES (?, ?, CURRENT_TIMESTAMP)''', (current_user.id, status))\n        conn.commit()\n        conn.close()\n    \n    socketio.emit('user_status_changed', {\n        'user_id': current_user.id,\n        'status': status\n    }, broadcast=True)\n\n\n@app.route('/course/<int:course_id>/ai_notes')\n@login_required\ndef ai_notes_page(course_id):\n    \"\"\"AI Notes page for instructors and students\"\"\"\n    with db_lock:\n        conn = get_db_connection()\n        course = conn.execute('SELECT * FROM courses WHERE id = ?', (course_id,)).fetchone()\n        \n        if not course:\n            conn.close()\n            flash('Course not found', 'error')\n            return redirect(url_for('dashboard'))\n        \n        if current_user.role == 'instructor':\n            if course['instructor_id'] != current_user.id:\n                conn.close()\n                flash('You do not have permission to access this course', 'error')\n                return redirect(url_for('dashboard'))\n            \n            my_notes = conn.execute('''SELECT * FROM ai_notes WHERE course_id = ? AND created_by = ? \n                AND is_instructor_note = 1 ORDER BY created_at DESC''', \n                (course_id, current_user.id)).fetchall()\n            conn.close()\n            return render_template('ai_notes_instructor.html', course=course, notes=my_notes)\n        else:\n            enrollment = conn.execute('''SELECT * FROM enrollments WHERE course_id = ? AND student_id = ? \n                AND status = 'approved' ''', (course_id, current_user.id)).fetchone()\n            \n            if not enrollment:\n                conn.close()\n                flash('You are not enrolled in this course', 'error')\n                return redirect(url_for('dashboard'))\n            \n            instructor_notes = conn.execute('''SELECT an.*, u.full_name as instructor_name FROM ai_notes an \n                JOIN users u ON an.created_by = u.id \n                WHERE an.course_id = ? AND an.is_instructor_note = 1 AND an.sent_to_students = 1 \n                ORDER BY an.created_at DESC''', (course_id,)).fetchall()\n            my_notes = conn.execute('''SELECT * FROM ai_notes WHERE course_id = ? AND created_by = ? \n                AND is_instructor_note = 0 ORDER BY created_at DESC''', \n                (course_id, current_user.id)).fetchall()\n            conn.close()\n            return render_template('ai_notes_student.html', course=course, \n                instructor_notes=instructor_notes, my_notes=my_notes)\n\n\n@app.route('/course/<int:course_id>/ai_notes/generate', methods=['POST'])\n@login_required\n@instructor_required\ndef generate_ai_notes(course_id):\n    \"\"\"Generate AI notes for a topic\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            course = conn.execute('SELECT * FROM courses WHERE id = ? AND instructor_id = ?', \n                (course_id, current_user.id)).fetchone()\n            conn.close()\n        \n        if not course:\n            return jsonify({'success': False, 'error': 'You do not own this course'}), 403\n        \n        topic = request.form.get('topic', '').strip()\n        additional_context = request.form.get('additional_context', '').strip()\n        \n        if not topic:\n            return jsonify({'success': False, 'error': 'Topic is required'}), 400\n        \n        result = gemini_ai.generate_ai_notes(topic, current_user.full_name, additional_context)\n        \n        if result.get('success'):\n            with db_lock:\n                conn = get_db_connection()\n                conn.execute('''INSERT INTO ai_notes (course_id, topic, content, created_by, is_instructor_note)\n                    VALUES (?, ?, ?, ?, 1)''', (course_id, topic, result['content'], current_user.id))\n                note_id = conn.execute('SELECT last_insert_rowid()').fetchone()[0]\n                conn.commit()\n                conn.close()\n            \n            return jsonify({'success': True, 'note_id': note_id, 'content': result['content']})\n        else:\n            return jsonify({'success': False, 'error': result.get('error', 'Failed to generate notes')}), 500\n    \n    except Exception as e:\n        logging.error(f\"Error generating AI notes: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/course/<int:course_id>/ai_notes/<int:note_id>/edit', methods=['POST'])\n@login_required\n@instructor_required\ndef edit_ai_notes(course_id, note_id):\n    \"\"\"Edit AI notes content\"\"\"\n    try:\n        content = request.form.get('content', '').strip()\n        \n        if not content:\n            return jsonify({'success': False, 'error': 'Content is required'}), 400\n        \n        with db_lock:\n            conn = get_db_connection()\n            conn.execute('UPDATE ai_notes SET content = ? WHERE id = ? AND created_by = ? AND course_id = ?',\n                (content, note_id, current_user.id, course_id))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    \n    except Exception as e:\n        logging.error(f\"Error editing AI notes: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/course/<int:course_id>/ai_notes/<int:note_id>/create_pdf', methods=['POST'])\n@login_required\n@instructor_required\ndef create_notes_pdf(course_id, note_id):\n    \"\"\"Create PDF from AI notes\"\"\"\n    try:\n        from utils.pdf_generator import generate_notes_pdf\n        \n        with db_lock:\n            conn = get_db_connection()\n            note = conn.execute('SELECT * FROM ai_notes WHERE id = ? AND created_by = ? AND course_id = ?',\n                (note_id, current_user.id, course_id)).fetchone()\n            conn.close()\n        \n        if not note:\n            return jsonify({'success': False, 'error': 'Note not found'}), 404\n        \n        notes_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'ai_notes')\n        os.makedirs(notes_dir, exist_ok=True)\n        \n        filename = f'notes_{note_id}_{int(datetime.now().timestamp())}.pdf'\n        pdf_path = os.path.join(notes_dir, filename)\n        \n        success = generate_notes_pdf(note['content'], note['topic'], current_user.full_name, pdf_path)\n        \n        if success:\n            relative_path = f'ai_notes/{filename}'\n            \n            with db_lock:\n                conn = get_db_connection()\n                conn.execute('UPDATE ai_notes SET pdf_path = ? WHERE id = ?', (relative_path, note_id))\n                conn.commit()\n                conn.close()\n            \n            return jsonify({'success': True, 'pdf_path': relative_path})\n        else:\n            return jsonify({'success': False, 'error': 'Failed to create PDF'}), 500\n    \n    except Exception as e:\n        logging.error(f\"Error creating PDF: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/course/<int:course_id>/ai_notes/<int:note_id>/send', methods=['POST'])\n@login_required\n@instructor_required\ndef send_notes_to_students(course_id, note_id):\n    \"\"\"Send AI notes to all enrolled students\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            note = conn.execute('SELECT * FROM ai_notes WHERE id = ? AND created_by = ? AND course_id = ?',\n                (note_id, current_user.id, course_id)).fetchone()\n            \n            if not note:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Note not found'}), 404\n            \n            if not note['pdf_path']:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Please create PDF first'}), 400\n            \n            conn.execute('UPDATE ai_notes SET sent_to_students = 1 WHERE id = ?', (note_id,))\n            \n            students = conn.execute('''SELECT student_id FROM enrollments WHERE course_id = ? \n                AND status = 'approved' ''', (course_id,)).fetchall()\n            \n            for student in students:\n                conn.execute('''INSERT INTO notifications (user_id, title, message, type, related_id)\n                    VALUES (?, ?, ?, ?, ?)''',\n                    (student['student_id'], 'New AI Notes Available', \n                    f'New AI notes available for {note[\"topic\"]}', 'ai_notes', note_id))\n            \n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    \n    except Exception as e:\n        logging.error(f\"Error sending notes: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/course/<int:course_id>/ai_notes/<int:note_id>/delete', methods=['POST'])\n@login_required\ndef delete_ai_notes(course_id, note_id):\n    \"\"\"Delete AI notes\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            note = conn.execute('SELECT * FROM ai_notes WHERE id = ? AND created_by = ? AND course_id = ?',\n                (note_id, current_user.id, course_id)).fetchone()\n            \n            if not note:\n                conn.close()\n                return jsonify({'success': False, 'error': 'Note not found'}), 404\n            \n            # Delete PDF file if it exists\n            if note['pdf_path']:\n                pdf_file = os.path.join(app.config['UPLOAD_FOLDER'], note['pdf_path'])\n                if os.path.exists(pdf_file):\n                    try:\n                        os.remove(pdf_file)\n                    except Exception as e:\n                        logging.warning(f\"Could not delete PDF file: {e}\")\n            \n            conn.execute('DELETE FROM ai_notes WHERE id = ?', (note_id,))\n            conn.commit()\n            conn.close()\n        \n        return jsonify({'success': True})\n    \n    except Exception as e:\n        logging.error(f\"Error deleting AI notes: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/course/<int:course_id>/ai_notes/student/create', methods=['POST'])\n@login_required\ndef student_create_notes(course_id):\n    \"\"\"Student create their own AI notes\"\"\"\n    try:\n        with db_lock:\n            conn = get_db_connection()\n            enrollment = conn.execute('''SELECT * FROM enrollments WHERE course_id = ? AND student_id = ? \n                AND status = 'approved' ''', (course_id, current_user.id)).fetchone()\n            conn.close()\n        \n        if not enrollment:\n            return jsonify({'success': False, 'error': 'You are not enrolled in this course'}), 403\n        \n        topic = request.form.get('topic', '').strip()\n        additional_context = request.form.get('additional_context', '').strip()\n        add_watermark = request.form.get('add_watermark') == 'on'\n        custom_watermark = request.form.get('custom_watermark', '').strip()\n        \n        if not topic:\n            return jsonify({'success': False, 'error': 'Topic is required'}), 400\n        \n        result = gemini_ai.generate_ai_notes(topic, '', additional_context)\n        \n        if result.get('success'):\n            from utils.pdf_generator import generate_notes_pdf\n            \n            with db_lock:\n                conn = get_db_connection()\n                conn.execute('''INSERT INTO ai_notes (course_id, topic, content, created_by, is_instructor_note)\n                    VALUES (?, ?, ?, ?, 0)''', (course_id, topic, result['content'], current_user.id))\n                note_id = conn.execute('SELECT last_insert_rowid()').fetchone()[0]\n                conn.commit()\n                conn.close()\n            \n            notes_dir = os.path.join(app.config['UPLOAD_FOLDER'], 'ai_notes')\n            os.makedirs(notes_dir, exist_ok=True)\n            \n            filename = f'notes_{note_id}_{int(datetime.now().timestamp())}.pdf'\n            pdf_path = os.path.join(notes_dir, filename)\n            \n            success = generate_notes_pdf(result['content'], topic, current_user.full_name, pdf_path, \n                                        add_watermark=add_watermark, custom_watermark=custom_watermark)\n            \n            relative_path = None\n            if success:\n                relative_path = f'ai_notes/{filename}'\n                \n                with db_lock:\n                    conn = get_db_connection()\n                    conn.execute('UPDATE ai_notes SET pdf_path = ? WHERE id = ?', (relative_path, note_id))\n                    conn.commit()\n                    conn.close()\n            \n            return jsonify({'success': True, 'note_id': note_id, 'pdf_path': relative_path})\n        else:\n            return jsonify({'success': False, 'error': result.get('error', 'Failed to generate notes')}), 500\n    \n    except Exception as e:\n        logging.error(f\"Error creating student notes: {e}\")\n        return jsonify({'success': False, 'error': str(e)}), 500\n\n\n@app.route('/uploads/<path:filename>')\ndef serve_upload(filename):\n    \"\"\"Serve uploaded files\"\"\"\n    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)\n\n\nif __name__ == '__main__':\n    # Initialize database before starting Flask\n    db_ready = init_db()\n    if not db_ready:\n        print(\"âš ï¸  Database initialization incomplete, but continuing with Flask startup...\")\n    \n    socketio.run(app, host='0.0.0.0', port=5000, debug=True, use_reloader=False, log_output=True, allow_unsafe_werkzeug=True)","size_bytes":269778},"static/css/main.css":{"content":"        :root {\n            /* iOS-Style Dark Mode Color System */\n            /* Background Colors */\n            --black: #000000;                    /* Primary background - true black */\n            --gray-50: #0D0D0D;                  /* Navigation bar background */\n            --gray-100: #1C1C1E;                 /* Secondary background - Cards/Lists */\n            --gray-200: #2C2C2E;                 /* Tertiary background - Elevated cards */\n            --gray-300: #3A3A3C;                 /* Dividers/Lines */\n            --gray-400: #48484A;                 /* Borders */\n            --gray-500: #636366;                 /* Subtle elements */\n            --gray-600: #8E8E93;                 /* Tab bar inactive */\n            --gray-700: #9999A5;                 /* Secondary text solid */\n            --gray-800: #AEAEB2;                 /* Light gray */\n            --gray-900: #C7C7CC;                 /* Lighter gray */\n            --white: #ffffff;\n            \n            /* Accent Colors - iOS Style */\n            --primary: #0A84FF;                  /* iOS Blue - Primary accent */\n            --primary-dark: #006EDC;             /* Pressed accent */\n            --success: #30D158;                  /* iOS Green */\n            --warning: #FF9F0A;                  /* iOS Orange */\n            --info: #64D2FF;                     /* iOS Cyan */\n            --danger: #FF453A;                   /* iOS Red - Destructive */\n            --accent: #BF5AF2;                   /* iOS Purple */\n            \n            /* Text Colors - iOS System */\n            --text-primary: #FFFFFF;             /* Primary text - Headings */\n            --text-secondary: #9999A5;           /* Secondary text - Descriptions (60% opacity equivalent) */\n            --text-light: #56565E;               /* Tertiary text - Labels (30% opacity equivalent) */\n            --text-disabled: #3A3A3E;            /* Quaternary text - Disabled (18% opacity equivalent) */\n            \n            /* Background & Borders */\n            --background: var(--black);\n            --card-bg: var(--gray-100);\n            --card-hover: var(--gray-200);\n            --border: var(--gray-300);\n            --border-light: var(--gray-400);\n            \n            /* Shadows - iOS Style */\n            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);\n            --shadow: 0 2px 12px rgba(0, 0, 0, 0.5);\n            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.6);\n            --shadow-lg: 0 4px 20px rgba(0, 0, 0, 0.6);\n            --shadow-xl: 0 8px 32px rgba(0, 0, 0, 0.7);\n            \n            /* Gradients - iOS Dark */\n            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);\n            --gradient-success: linear-gradient(135deg, var(--success) 0%, #28CD4B 100%);\n            --gradient-warning: linear-gradient(135deg, var(--warning) 0%, #FF8800 100%);\n            --gradient-accent: linear-gradient(135deg, var(--accent) 0%, #A646E8 100%);\n            --gradient-bg: linear-gradient(135deg, var(--black) 0%, var(--gray-50) 100%);\n            \n            /* Border Radius - iOS Style */\n            --radius-sm: 0.5rem;\n            --radius: 0.75rem;\n            --radius-md: 1rem;\n            --radius-lg: 1.25rem;\n            --radius-xl: 1.5rem;\n        }\n\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            font-family: system-ui, -apple-system, sans-serif;\n            background: linear-gradient(135deg, var(--black) 0%, var(--gray-100) 100%);\n            min-height: 100vh;\n            line-height: 1.6;\n            color: var(--text-primary);\n            margin: 0;\n            padding-top: 70px;\n        }\n\n        .navbar {\n            background-color: var(--gray-100);\n            box-shadow: var(--shadow-lg);\n            position: fixed;\n            width: 100%;\n            top: 0;\n            z-index: 1000;\n            border-bottom: 1px solid var(--border);\n        }\n\n        .navbar-content {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 1rem 5%;\n            max-width: 1400px;\n            margin: 0 auto;\n        }\n\n        .navbar-brand {\n            display: flex;\n            align-items: center;\n            gap: 0.75rem;\n            font-size: 1.5rem;\n            font-weight: 800;\n            color: var(--text-primary);\n            text-decoration: none;\n        }\n\n        .navbar-brand i {\n            font-size: 2rem;\n            color: var(--primary);\n        }\n\n        .navbar-nav {\n            display: flex;\n            list-style: none;\n            gap: 2rem;\n            margin: 0;\n            padding: 0;\n            align-items: center;\n        }\n\n        .nav-link {\n            text-decoration: none;\n            color: var(--text-secondary);\n            font-weight: 500;\n            font-size: 0.95rem;\n            padding: 0.5rem 0;\n            position: relative;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            gap: 0.5rem;\n        }\n\n        .nav-link:hover {\n            color: var(--text-primary);\n        }\n\n        .nav-link::after {\n            content: '';\n            position: absolute;\n            bottom: 0;\n            left: 0;\n            width: 0;\n            height: 2px;\n            background-color: var(--primary);\n            transition: width 0.3s ease;\n        }\n\n        .nav-link:hover::after {\n            width: 100%;\n        }\n\n        .hamburger {\n            display: none;\n            background: linear-gradient(135deg, rgba(52, 199, 89, 0.1), rgba(0, 179, 65, 0.1));\n            border: 1px solid rgba(52, 199, 89, 0.3);\n            cursor: pointer;\n            padding: 0.5rem;\n            outline: none;\n            width: 44px;\n            height: 44px;\n            border-radius: 12px;\n            transition: all 0.3s ease;\n            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);\n        }\n        \n        .hamburger:hover {\n            background: linear-gradient(135deg, rgba(52, 199, 89, 0.15), rgba(0, 179, 65, 0.15));\n            transform: scale(1.05);\n        }\n\n        .hamburger span {\n            display: block;\n            width: 22px;\n            height: 2.5px;\n            background: linear-gradient(90deg, #34C759, #00B341);\n            margin: 4px auto;\n            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);\n            border-radius: 2px;\n        }\n\n        .notifications-nav {\n            position: relative;\n        }\n\n        .notifications-link {\n            position: relative;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            width: 40px;\n            height: 40px;\n            border-radius: 50%;\n            transition: all 0.3s ease;\n            background: var(--gray-100);\n            color: var(--text-secondary);\n        }\n\n        .notifications-link:hover {\n            background: var(--gray-200);\n            color: var(--text-primary);\n        }\n\n        .notification-badge {\n            position: absolute;\n            top: -2px;\n            right: -2px;\n            background: var(--danger);\n            color: white;\n            border-radius: 50%;\n            width: 18px;\n            height: 18px;\n            font-size: 0.7rem;\n            font-weight: 600;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            animation: pulse 2s infinite;\n        }\n\n        @keyframes pulse {\n            0% { transform: scale(1); }\n            50% { transform: scale(1.1); }\n            100% { transform: scale(1); }\n        }\n\n        .btn {\n            display: inline-flex;\n            align-items: center;\n            gap: 0.5rem;\n            padding: 0.75rem 1.5rem;\n            border: none;\n            border-radius: var(--radius);\n            font-weight: 600;\n            text-decoration: none;\n            cursor: pointer;\n            transition: all 0.2s;\n            font-size: 0.9rem;\n            color: var(--white);\n        }\n\n        .btn-primary {\n            background: var(--gradient-primary);\n            color: white;\n        }\n\n        .btn-primary:hover {\n            transform: translateY(-2px);\n            box-shadow: var(--shadow-lg);\n        }\n\n        .btn-secondary {\n            background: var(--gray-200);\n            color: var(--text-primary);\n            border: 1px solid var(--border);\n        }\n\n        .btn-secondary:hover {\n            background: var(--gray-300);\n            color: var(--white);\n            transform: translateY(-2px);\n        }\n\n        .btn-success {\n            background: var(--success);\n            color: white;\n        }\n\n        .btn-warning {\n            background: var(--warning);\n            color: white;\n        }\n\n        .btn-danger {\n            background: var(--danger);\n            color: white;\n        }\n\n        .btn-sm {\n            padding: 0.5rem 1rem;\n            font-size: 0.8rem;\n        }\n\n        .container {\n            max-width: 1400px;\n            margin: 0 auto;\n            padding: 2rem;\n        }\n\n        .flash-messages {\n            margin: 1rem 0;\n        }\n\n        .flash-message {\n            padding: 1rem 1.5rem;\n            border-radius: var(--radius);\n            margin-bottom: 0.75rem;\n            display: flex;\n            align-items: center;\n            gap: 0.75rem;\n            border: 1px solid;\n            background: var(--gray-100);\n            box-shadow: var(--shadow-sm);\n        }\n\n        .flash-message.success {\n            background: rgba(48, 209, 88, 0.1);\n            color: var(--success);\n            border-color: rgba(48, 209, 88, 0.3);\n        }\n\n        .flash-message.error {\n            background: rgba(255, 69, 58, 0.1);\n            color: var(--danger);\n            border-color: rgba(255, 69, 58, 0.3);\n        }\n\n        .flash-message.warning {\n            background: rgba(255, 159, 10, 0.1);\n            color: var(--warning);\n            border-color: rgba(255, 159, 10, 0.3);\n        }\n\n        .flash-message.info {\n            background: rgba(100, 210, 255, 0.1);\n            color: var(--info);\n            border-color: rgba(100, 210, 255, 0.3);\n        }\n\n        .card {\n            background: var(--card-bg);\n            border-radius: var(--radius-lg);\n            padding: 2rem;\n            box-shadow: var(--shadow-lg);\n            margin-bottom: 2rem;\n            position: relative;\n            overflow: hidden;\n            border: 1px solid var(--border);\n            transition: all 0.3s ease;\n        }\n\n        .card:hover {\n            background: var(--card-hover);\n            box-shadow: var(--shadow-xl);\n        }\n\n        .card::before {\n            content: '';\n            position: absolute;\n            top: 0;\n            left: 0;\n            right: 0;\n            height: 4px;\n            background: var(--gradient-primary);\n        }\n\n        .page-container {\n            max-width: 1400px;\n            margin: 0 auto;\n            padding: 2rem;\n        }\n\n        .page-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 2rem;\n            padding: 2rem;\n            background: var(--card-bg);\n            border-radius: var(--radius-lg);\n            box-shadow: var(--shadow-md);\n            border: 1px solid var(--border);\n        }\n\n        .header-content h1 {\n            font-size: 2.25rem;\n            margin-bottom: 0.5rem;\n            color: var(--text-primary);\n            font-weight: 800;\n        }\n\n        .header-content p {\n            color: var(--text-secondary);\n            font-size: 1.1rem;\n        }\n\n        .header-actions {\n            display: flex;\n            gap: 1rem;\n        }\n\n        .stats-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n            gap: 1.5rem;\n            margin: 2rem 0;\n        }\n\n        .stat-card {\n            background: var(--card-bg);\n            padding: 1.5rem;\n            border-radius: var(--radius-lg);\n            box-shadow: var(--shadow-md);\n            text-align: center;\n            position: relative;\n            overflow: hidden;\n            transition: transform 0.3s ease, box-shadow 0.3s ease;\n            border: 1px solid var(--border);\n        }\n        \n        .stat-card:hover {\n            background: var(--card-hover);\n        }\n\n        .stat-card:hover {\n            transform: translateY(-5px);\n            box-shadow: var(--shadow-lg);\n        }\n\n        .stat-card::before {\n            content: '';\n            position: absolute;\n            top: 0;\n            left: 0;\n            right: 0;\n            height: 4px;\n            background: var(--gradient-primary);\n        }\n\n        .stat-number {\n            font-size: 2.5rem;\n            font-weight: 800;\n            color: var(--text-primary);\n            display: block;\n            line-height: 1;\n            margin-bottom: 0.5rem;\n        }\n\n        .stat-label {\n            color: var(--text-secondary);\n            font-weight: 600;\n            font-size: 0.9rem;\n        }\n\n        .form-group {\n            margin-bottom: 1.5rem;\n        }\n\n        .form-group label {\n            display: block;\n            margin-bottom: 0.5rem;\n            font-weight: 600;\n            color: var(--text-primary);\n        }\n\n        .form-group input,\n        .form-group select,\n        .form-group textarea {\n            width: 100%;\n            padding: 0.75rem 1rem;\n            border: 1px solid var(--border);\n            border-radius: var(--radius);\n            font-size: 1rem;\n            transition: all 0.2s;\n            color: var(--text-primary);\n            background: var(--gray-200);\n        }\n\n        .form-group input:focus,\n        .form-group select:focus,\n        .form-group textarea:focus {\n            outline: none;\n            border-color: var(--primary);\n            background: var(--gray-300);\n            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);\n        }\n\n        .form-group input::placeholder,\n        .form-group textarea::placeholder {\n            color: var(--text-light);\n        }\n\n        .empty-state {\n            text-align: center;\n            padding: 3rem 2rem;\n            color: var(--text-secondary);\n        }\n\n        .empty-state i {\n            font-size: 3rem;\n            color: var(--gray-400);\n            margin-bottom: 1rem;\n        }\n\n        .empty-state h3 {\n            color: var(--text-primary);\n            margin-bottom: 1rem;\n            font-weight: 600;\n        }\n\n        /* Mobile Menu Styles */\n        @media (max-width: 768px) {\n            .navbar-nav {\n                position: absolute;\n                top: 100%;\n                left: -100%;\n                width: 100%;\n                background-color: var(--gray-100);\n                flex-direction: column;\n                align-items: stretch;\n                padding: 1rem 0;\n                box-shadow: var(--shadow-lg);\n                transition: all 0.4s ease;\n                border-top: 1px solid var(--border);\n            }\n            \n            .navbar-nav.active {\n                left: 0;\n            }\n            \n            .navbar-nav li {\n                width: 100%;\n                text-align: left;\n            }\n            \n            .nav-link {\n                padding: 1rem 2rem;\n                display: flex;\n                width: 100%;\n                color: var(--text-primary);\n                border-bottom: 1px solid var(--gray-100);\n            }\n            \n            .nav-link:last-child {\n                border-bottom: none;\n            }\n            \n            .hamburger {\n                display: flex;\n                flex-direction: column;\n                justify-content: center;\n            }\n            \n            .hamburger.active span:nth-child(1) {\n                transform: rotate(45deg) translate(6px, 6px);\n            }\n            \n            .hamburger.active span:nth-child(2) {\n                opacity: 0;\n            }\n            \n            .hamburger.active span:nth-child(3) {\n                transform: rotate(-45deg) translate(6px, -6px);\n            }\n            \n            .page-header {\n                flex-direction: column;\n                gap: 1.5rem;\n                text-align: center;\n            }\n            \n            .header-actions {\n                width: 100%;\n                justify-content: center;\n            }\n            \n            .container,\n            .page-container {\n                padding: 1rem;\n            }\n            \n            .navbar-content {\n                padding: 1rem;\n            }\n        }\n\n        /* Tables - iOS Dark Theme */\n        table {\n            width: 100%;\n            border-collapse: collapse;\n            background: var(--card-bg);\n            border-radius: var(--radius-lg);\n            overflow: hidden;\n            box-shadow: var(--shadow);\n        }\n\n        thead {\n            background: var(--gray-200);\n        }\n\n        th {\n            padding: 1rem;\n            text-align: left;\n            font-weight: 600;\n            color: var(--text-primary);\n            border-bottom: 1px solid var(--border);\n        }\n\n        td {\n            padding: 1rem;\n            color: var(--text-secondary);\n            border-bottom: 1px solid var(--gray-300);\n        }\n\n        tbody tr {\n            transition: background 0.2s ease;\n        }\n\n        tbody tr:hover {\n            background: var(--card-hover);\n        }\n\n        tbody tr:last-child td {\n            border-bottom: none;\n        }\n\n        /* Badges - iOS Dark Theme */\n        .badge {\n            display: inline-block;\n            padding: 0.35rem 0.75rem;\n            border-radius: var(--radius);\n            font-size: 0.85rem;\n            font-weight: 600;\n            text-align: center;\n        }\n\n        .badge-primary {\n            background: rgba(10, 132, 255, 0.15);\n            color: var(--primary);\n            border: 1px solid rgba(10, 132, 255, 0.3);\n        }\n\n        .badge-success {\n            background: rgba(48, 209, 88, 0.15);\n            color: var(--success);\n            border: 1px solid rgba(48, 209, 88, 0.3);\n        }\n\n        .badge-warning {\n            background: rgba(255, 159, 10, 0.15);\n            color: var(--warning);\n            border: 1px solid rgba(255, 159, 10, 0.3);\n        }\n\n        .badge-danger {\n            background: rgba(255, 69, 58, 0.15);\n            color: var(--danger);\n            border: 1px solid rgba(255, 69, 58, 0.3);\n        }\n\n        .badge-info {\n            background: rgba(100, 210, 255, 0.15);\n            color: var(--info);\n            border: 1px solid rgba(100, 210, 255, 0.3);\n        }\n\n        .badge-secondary {\n            background: var(--gray-200);\n            color: var(--text-secondary);\n            border: 1px solid var(--border);\n        }\n\n        /* Progress Bars - iOS Dark Theme */\n        .progress {\n            background: var(--gray-200);\n            border-radius: var(--radius);\n            height: 10px;\n            overflow: hidden;\n            position: relative;\n        }\n\n        .progress-bar {\n            height: 100%;\n            background: var(--gradient-primary);\n            transition: width 0.3s ease;\n            border-radius: var(--radius);\n        }\n\n        .progress-bar.success {\n            background: var(--gradient-success);\n        }\n\n        .progress-bar.warning {\n            background: var(--gradient-warning);\n        }\n\n        .progress-bar.danger {\n            background: linear-gradient(135deg, var(--danger) 0%, #E03A31 100%);\n        }\n\n        /* List Groups - iOS Dark Theme */\n        .list-group {\n            background: var(--card-bg);\n            border-radius: var(--radius-lg);\n            overflow: hidden;\n            box-shadow: var(--shadow);\n        }\n\n        .list-group-item {\n            padding: 1rem 1.5rem;\n            color: var(--text-primary);\n            border-bottom: 1px solid var(--gray-300);\n            transition: all 0.2s ease;\n            background: transparent;\n        }\n\n        .list-group-item:hover {\n            background: var(--card-hover);\n        }\n\n        .list-group-item:last-child {\n            border-bottom: none;\n        }\n\n        .list-group-item.active {\n            background: rgba(10, 132, 255, 0.15);\n            border-left: 3px solid var(--primary);\n        }\n\n        /* Modals - iOS Dark Theme */\n        .modal {\n            background: rgba(0, 0, 0, 0.85);\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            z-index: 9999;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            backdrop-filter: blur(10px);\n        }\n\n        .modal-content {\n            background: var(--card-bg);\n            border-radius: var(--radius-lg);\n            padding: 2rem;\n            max-width: 600px;\n            width: 90%;\n            box-shadow: var(--shadow-xl);\n            border: 1px solid var(--border);\n        }\n\n        .modal-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 1.5rem;\n            padding-bottom: 1rem;\n            border-bottom: 1px solid var(--border);\n        }\n\n        .modal-header h3 {\n            color: var(--text-primary);\n            font-size: 1.5rem;\n            font-weight: 700;\n        }\n\n        .modal-body {\n            color: var(--text-secondary);\n            margin-bottom: 1.5rem;\n        }\n\n        .modal-footer {\n            display: flex;\n            gap: 1rem;\n            justify-content: flex-end;\n            padding-top: 1rem;\n            border-top: 1px solid var(--border);\n        }\n\n        /* Alerts - iOS Dark Theme */\n        .alert {\n            padding: 1rem 1.5rem;\n            border-radius: var(--radius);\n            margin-bottom: 1rem;\n            border: 1px solid;\n            display: flex;\n            align-items: center;\n            gap: 0.75rem;\n        }\n\n        .alert-success {\n            background: rgba(48, 209, 88, 0.1);\n            color: var(--success);\n            border-color: rgba(48, 209, 88, 0.3);\n        }\n\n        .alert-warning {\n            background: rgba(255, 159, 10, 0.1);\n            color: var(--warning);\n            border-color: rgba(255, 159, 10, 0.3);\n        }\n\n        .alert-danger {\n            background: rgba(255, 69, 58, 0.1);\n            color: var(--danger);\n            border-color: rgba(255, 69, 58, 0.3);\n        }\n\n        .alert-info {\n            background: rgba(100, 210, 255, 0.1);\n            color: var(--info);\n            border-color: rgba(100, 210, 255, 0.3);\n        }\n\n        /* Pagination - iOS Dark Theme */\n        .pagination {\n            display: flex;\n            gap: 0.5rem;\n            justify-content: center;\n            margin: 2rem 0;\n        }\n\n        .pagination a,\n        .pagination span {\n            padding: 0.5rem 1rem;\n            background: var(--card-bg);\n            border: 1px solid var(--border);\n            border-radius: var(--radius);\n            color: var(--text-primary);\n            text-decoration: none;\n            transition: all 0.2s ease;\n        }\n\n        .pagination a:hover {\n            background: var(--card-hover);\n            border-color: var(--primary);\n            color: var(--primary);\n        }\n\n        .pagination .active {\n            background: var(--primary);\n            border-color: var(--primary);\n            color: var(--white);\n        }\n\n        /* Breadcrumbs - iOS Dark Theme */\n        .breadcrumb {\n            display: flex;\n            gap: 0.5rem;\n            padding: 1rem;\n            background: var(--card-bg);\n            border-radius: var(--radius);\n            margin-bottom: 1rem;\n        }\n\n        .breadcrumb a {\n            color: var(--primary);\n            text-decoration: none;\n        }\n\n        .breadcrumb a:hover {\n            text-decoration: underline;\n        }\n\n        .breadcrumb-separator {\n            color: var(--text-light);\n        }\n\n        /* Video Player Container - iOS Dark Theme */\n        .video-container {\n            background: var(--black);\n            border-radius: var(--radius-lg);\n            overflow: hidden;\n            box-shadow: var(--shadow-lg);\n            position: relative;\n        }\n\n        .video-container iframe {\n            border-radius: var(--radius-lg);\n        }\n\n        /* Code Blocks - iOS Dark Theme */\n        pre, code {\n            background: var(--gray-200);\n            color: var(--text-primary);\n            border-radius: var(--radius);\n            padding: 0.25rem 0.5rem;\n            font-family: 'Courier New', monospace;\n        }\n\n        pre {\n            padding: 1rem;\n            overflow-x: auto;\n            border: 1px solid var(--border);\n        }\n\n        /* Tooltips - iOS Dark Theme */\n        .tooltip {\n            background: var(--gray-100);\n            color: var(--text-primary);\n            padding: 0.5rem 1rem;\n            border-radius: var(--radius);\n            font-size: 0.85rem;\n            box-shadow: var(--shadow-lg);\n            border: 1px solid var(--border);\n        }\n\n        /* Dropdown Menus - iOS Dark Theme */\n        .dropdown-menu {\n            background: var(--card-bg);\n            border: 1px solid var(--border);\n            border-radius: var(--radius-lg);\n            box-shadow: var(--shadow-lg);\n            padding: 0.5rem 0;\n            min-width: 200px;\n        }\n\n        .dropdown-item {\n            padding: 0.75rem 1.5rem;\n            color: var(--text-primary);\n            text-decoration: none;\n            display: block;\n            transition: all 0.2s ease;\n        }\n\n        .dropdown-item:hover {\n            background: var(--card-hover);\n            color: var(--primary);\n        }\n\n        .dropdown-divider {\n            height: 1px;\n            background: var(--border);\n            margin: 0.5rem 0;\n        }\n\n        /* Tabs - iOS Dark Theme */\n        .nav-tabs {\n            display: flex;\n            gap: 0.5rem;\n            border-bottom: 1px solid var(--border);\n            margin-bottom: 1.5rem;\n        }\n\n        .nav-tabs .nav-link {\n            padding: 0.75rem 1.5rem;\n            color: var(--text-secondary);\n            border: none;\n            border-bottom: 2px solid transparent;\n            transition: all 0.2s ease;\n            background: transparent;\n        }\n\n        .nav-tabs .nav-link:hover {\n            color: var(--text-primary);\n            border-bottom-color: var(--gray-500);\n        }\n\n        .nav-tabs .nav-link.active {\n            color: var(--primary);\n            border-bottom-color: var(--primary);\n        }\n\n        /* Utility classes */\n        .text-center { text-align: center; }\n        .text-muted { color: var(--text-secondary); }\n        .text-primary { color: var(--primary); }\n        .text-success { color: var(--success); }\n        .text-warning { color: var(--warning); }\n        .text-danger { color: var(--danger); }\n        .mb-0 { margin-bottom: 0; }\n        .mb-1 { margin-bottom: 0.5rem; }\n        .mb-2 { margin-bottom: 1rem; }\n        .mb-3 { margin-bottom: 1.5rem; }\n        .mt-2 { margin-top: 1rem; }\n        .d-flex { display: flex; }\n        .justify-between { justify-content: space-between; }\n        .align-center { align-items: center; }\n        .gap-1 { gap: 0.5rem; }\n        .gap-2 { gap: 1rem; }\n","size_bytes":27790},"zsam/utils/__init__.py":{"content":"# Utils package for LearnNest LMS\n","size_bytes":34},"utils/__init__.py":{"content":"# Utils package for LearnNest LMS\n","size_bytes":34},"ghalib/utils/__init__.py":{"content":"# Utils package for LearnNest LMS\n","size_bytes":34},"LearnNestGemini/weather-app-abdulwaheed/utils/pdf_generator.py":{"content":"\"\"\"\nPDF Generator with Beautiful Design for LearnNest LMS\nGenerates professional, stylish PDF documents with LearnNest branding\nSupports Unicode languages: English, Arabic, Urdu, Sindhi, and more\n\"\"\"\n\nfrom reportlab.lib.pagesizes import letter, A4\nfrom reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle\nfrom reportlab.lib.units import inch\nfrom reportlab.lib.enums import TA_CENTER, TA_LEFT, TA_JUSTIFY, TA_RIGHT\nfrom reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, PageBreak, Table, TableStyle\nfrom reportlab.lib import colors\nfrom reportlab.pdfgen import canvas\nfrom reportlab.pdfbase import pdfmetrics\nfrom reportlab.pdfbase.ttfonts import TTFont\nfrom datetime import datetime\nimport os\n\n# Register Unicode fonts for multi-language support\ntry:\n    # Get the absolute path to fonts directory\n    FONTS_DIR = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'static', 'fonts')\n    \n    # Register Noto Sans (for Latin, numbers, symbols)\n    noto_sans_path = os.path.join(FONTS_DIR, 'NotoSans.ttf')\n    if os.path.exists(noto_sans_path):\n        pdfmetrics.registerFont(TTFont('NotoSans', noto_sans_path))\n    \n    # Register Noto Sans Arabic (for Arabic, Urdu, Sindhi)\n    noto_arabic_path = os.path.join(FONTS_DIR, 'NotoSansArabic.ttf')\n    if os.path.exists(noto_arabic_path):\n        pdfmetrics.registerFont(TTFont('NotoSansArabic', noto_arabic_path))\n    \n    UNICODE_FONTS_AVAILABLE = True\nexcept Exception as e:\n    print(f\"Warning: Could not register Unicode fonts: {e}\")\n    UNICODE_FONTS_AVAILABLE = False\n\ndef get_font_for_text(text):\n    \"\"\"\n    Detect if text contains Arabic/Urdu/Sindhi characters and return appropriate font\n    \"\"\"\n    if not UNICODE_FONTS_AVAILABLE:\n        return 'Helvetica'\n    \n    # Check for Arabic/Urdu/Sindhi characters (Unicode range)\n    for char in text:\n        if '\\u0600' <= char <= '\\u06FF' or '\\u0750' <= char <= '\\u077F':\n            return 'NotoSansArabic'\n    \n    # Default to NotoSans for better Unicode support (including math symbols)\n    return 'NotoSans'\n\n\nclass BeautifulWatermarkedCanvas(canvas.Canvas):\n    \"\"\"Custom canvas with beautiful LearnNest branding and watermark\"\"\"\n    \n    def __init__(self, *args, add_watermark=True, custom_watermark=None, **kwargs):\n        canvas.Canvas.__init__(self, *args, **kwargs)\n        self.pages = []\n        self.add_watermark = add_watermark\n        self.custom_watermark = custom_watermark\n        \n    def showPage(self):\n        self.pages.append(dict(self.__dict__))\n        self._startPage()\n        \n    def save(self):\n        page_count = len(self.pages)\n        for page_num, page in enumerate(self.pages, start=1):\n            self.__dict__.update(page)\n            self.draw_page_design(page_num, page_count)\n            canvas.Canvas.showPage(self)\n        canvas.Canvas.save(self)\n        \n    def draw_page_design(self, page_num, total_pages):\n        \"\"\"Draw beautiful page design with watermark and branding - Enhanced with modern design\"\"\"\n        page_width, page_height = letter\n        \n        # Save the state\n        self.saveState()\n        \n        # === ENHANCED WATERMARK (Diagonal) ===\n        if self.add_watermark:\n            watermark_font = 'NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica-Bold'\n            try:\n                self.setFont(watermark_font, 80)\n            except:\n                self.setFont('Helvetica-Bold', 80)\n            \n            # Blue watermark with transparency\n            self.setFillColor(colors.HexColor(\"#0A84FF\"), alpha=0.12)\n            self.translate(page_width / 2, page_height / 2)\n            self.rotate(48)\n            watermark_text = \"LearnNest\"\n            self.drawCentredString(0, 0, watermark_text)\n            self.restoreState()\n            self.saveState()\n        \n        # === CUSTOM WATERMARK (Diagonal) - Student's Personal Watermark ===\n        if self.custom_watermark:\n            watermark_font = 'NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica-Bold'\n            try:\n                self.setFont(watermark_font, 60)\n            except:\n                self.setFont('Helvetica-Bold', 60)\n            \n            # Student's custom watermark in white with transparency\n            self.setFillColor(colors.white, alpha=0.08)\n            self.translate(page_width / 2, page_height / 2 - 100)\n            self.rotate(48)\n            self.drawCentredString(0, 0, self.custom_watermark)\n            self.restoreState()\n            self.saveState()\n        \n        # === PREMIUM HEADER DESIGN ===\n        # Gradient-effect header (dark to light purple)\n        self.setFillColor(colors.HexColor(\"#1a0033\"))\n        self.rect(0, page_height - 0.18 * inch, page_width, 0.18 * inch, fill=1, stroke=0)\n        \n        # Accent line\n        self.setFillColor(colors.HexColor(\"#00d4ff\"))\n        self.rect(0, page_height - 0.2 * inch, page_width, 0.02 * inch, fill=1, stroke=0)\n        \n        # LearnNest branding with modern font\n        brand_font = 'NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica-Bold'\n        try:\n            self.setFont(brand_font, 16)\n        except:\n            self.setFont('Helvetica-Bold', 16)\n        self.setFillColor(colors.white)\n        self.drawString(0.75 * inch, page_height - 0.14 * inch, \"LearnNest\")\n        \n        # Tagline with sky blue accent\n        try:\n            self.setFont('NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica', 8)\n        except:\n            self.setFont('Helvetica', 8)\n        self.setFillColor(colors.HexColor(\"#00d4ff\"))\n        self.drawString(0.75 * inch, page_height - 0.32 * inch, \"Empowering Learning Through AI\")\n        \n        # === PREMIUM FOOTER DESIGN ===\n        # Footer gradient bar\n        self.setFillColor(colors.HexColor(\"#1a0033\"))\n        self.rect(0, 0, page_width, 0.55 * inch, fill=1, stroke=0)\n        \n        # Sky blue accent line\n        self.setFillColor(colors.HexColor(\"#00d4ff\"))\n        self.rect(0, 0.55 * inch, page_width, 0.02 * inch, fill=1, stroke=0)\n        \n        # Page number with modern styling\n        try:\n            self.setFont('NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica', 10)\n        except:\n            self.setFont('Helvetica', 10)\n        self.setFillColor(colors.white)\n        footer_text = f\"Page {page_num} of {total_pages}\"\n        self.drawCentredString(page_width / 2, 0.35 * inch, footer_text)\n        \n        # Copyright text with sky blue\n        try:\n            self.setFont('NotoSans' if UNICODE_FONTS_AVAILABLE else 'Helvetica', 7)\n        except:\n            self.setFont('Helvetica', 7)\n        self.setFillColor(colors.HexColor(\"#00d4ff\"))\n        self.drawCentredString(page_width / 2, 0.2 * inch, \"Â© LearnNest LMS - AI Generated Content\")\n\n\ndef generate_transcript_pdf(transcript_text, video_title, course_name, student_name, output_path, add_watermark=True, custom_watermark=None):\n    \"\"\"\n    Generate a stunning, professional PDF transcript with LearnNest branding and modern design\n    \n    Args:\n        transcript_text (str): The AI-generated transcript content\n        video_title (str): Title of the video\n        course_name (str): Name of the course\n        student_name (str): Name of the student downloading the transcript\n        output_path (str): Full path where the PDF should be saved\n        add_watermark (bool): Whether to add LearnNest watermark (default: True)\n    \n    Returns:\n        bool: True if successful, False otherwise\n    \"\"\"\n    try:\n        # Ensure directory exists\n        os.makedirs(os.path.dirname(output_path), exist_ok=True)\n        \n        # Create the PDF document with custom canvas and enhanced margins\n        doc = SimpleDocTemplate(\n            output_path,\n            pagesize=letter,\n            rightMargin=0.8*inch,\n            leftMargin=0.8*inch,\n            topMargin=1.0*inch,\n            bottomMargin=1.0*inch\n        )\n        \n        # Container for the 'Flowable' objects\n        story = []\n        \n        # Define custom styles\n        styles = getSampleStyleSheet()\n        \n        # Detect language for font selection\n        content_font = get_font_for_text(transcript_text + video_title)\n        \n        # === STUNNING TITLE STYLE ===\n        title_style = ParagraphStyle(\n            'BeautifulTitle',\n            parent=styles['Heading1'],\n            fontSize=28,\n            textColor=colors.HexColor(\"#1a0033\"),\n            spaceAfter=12,\n            spaceBefore=6,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=32,\n            borderPadding=12,\n            borderColor=colors.HexColor(\"#00d4ff\"),\n            borderWidth=0.5\n        )\n        \n        # === MODERN SUBTITLE STYLE ===\n        subtitle_style = ParagraphStyle(\n            'SubtitleStyle',\n            parent=styles['Normal'],\n            fontSize=13,\n            textColor=colors.HexColor(\"#555555\"),\n            spaceAfter=24,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=16\n        )\n        \n        # === INFO BOX STYLE ===\n        info_label_style = ParagraphStyle(\n            'InfoLabel',\n            parent=styles['Normal'],\n            fontSize=10,\n            textColor=colors.HexColor(\"#00d4ff\"),\n            fontName=content_font,\n            spaceAfter=2\n        )\n        \n        info_value_style = ParagraphStyle(\n            'InfoValue',\n            parent=styles['Normal'],\n            fontSize=11,\n            textColor=colors.HexColor(\"#1a0033\"),\n            fontName=content_font,\n            spaceAfter=8\n        )\n        \n        # === VVIP PROFESSIONAL HEADING STYLE (CENTERED) ===\n        heading_style = ParagraphStyle(\n            'VVIPHeading',\n            parent=styles['Heading2'],\n            fontSize=16,\n            textColor=colors.HexColor(\"#FFFFFF\"),\n            spaceAfter=16,\n            spaceBefore=20,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            borderPadding=12,\n            borderColor=colors.HexColor(\"#0A84FF\"),\n            borderWidth=2,\n            backColor=colors.HexColor(\"#1a0033\"),\n            leading=20,\n            borderRadius=8\n        )\n        \n        # === PREMIUM BODY STYLE ===\n        body_style = ParagraphStyle(\n            'BeautifulBody',\n            parent=styles['BodyText'],\n            fontSize=10.5,\n            alignment=TA_JUSTIFY,\n            spaceAfter=12,\n            leading=20,\n            textColor=colors.HexColor(\"#1a1a1a\"),\n            fontName=content_font,\n            borderPadding=6\n        )\n        \n        # === DOCUMENT HEADER ===\n        story.append(Spacer(1, 0.2*inch))\n        \n        # Main Title with modern styling\n        title = Paragraph(f'<b>{video_title}</b>', title_style)\n        story.append(title)\n        \n        # Document Type Subtitle\n        subtitle_text = 'Study Notes & Transcript'\n        if 'Study Notes' in video_title or 'notes' in video_title.lower():\n            subtitle_text = 'AI-Generated Study Notes'\n        elif 'transcript' in video_title.lower():\n            subtitle_text = 'AI-Generated Transcript'\n        \n        subtitle = Paragraph(subtitle_text, subtitle_style)\n        story.append(subtitle)\n        \n        story.append(Spacer(1, 0.25*inch))\n        \n        # === INFORMATION BOX ===\n        # Create a beautiful info table\n        info_data = [\n            [Paragraph('<b>Student Name:</b>', info_label_style), Paragraph(student_name, info_value_style)],\n            [Paragraph('<b>Course:</b>', info_label_style), Paragraph(course_name, info_value_style)],\n            [Paragraph('<b>Generated On:</b>', info_label_style), \n             Paragraph(datetime.now().strftime(\"%B %d, %Y at %I:%M %p\"), info_value_style)]\n        ]\n        \n        info_table = Table(info_data, colWidths=[1.5*inch, 4.5*inch])\n        info_table.setStyle(TableStyle([\n            ('BACKGROUND', (0, 0), (0, -1), colors.HexColor(\"#e6f7ff\")),\n            ('BACKGROUND', (1, 0), (-1, -1), colors.HexColor(\"#f0f8ff\")),\n            ('BOX', (0, 0), (-1, -1), 1.5, colors.HexColor(\"#00d4ff\")),\n            ('LEFTPADDING', (0, 0), (-1, -1), 12),\n            ('RIGHTPADDING', (0, 0), (-1, -1), 12),\n            ('TOPPADDING', (0, 0), (-1, -1), 12),\n            ('BOTTOMPADDING', (0, 0), (-1, -1), 12),\n            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),\n            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),\n            ('FONTNAME', (0, 0), (-1, -1), content_font),\n            ('FONTSIZE', (0, 0), (-1, -1), 10),\n            ('ROWBACKGROUNDS', (0, 0), (-1, -1), [colors.white, colors.HexColor(\"#f0f8ff\")]),\n        ]))\n        \n        story.append(info_table)\n        story.append(Spacer(1, 0.4*inch))\n        \n        # === CONTENT DIVIDER ===\n        story.append(Spacer(1, 0.15*inch))\n        \n        # === TRANSCRIPT CONTENT HEADER ===\n        content_header = Paragraph(\n            '<b>ðŸ“š  CONTENT  ðŸ“š</b>',\n            ParagraphStyle(\n                'ContentHeader',\n                parent=styles['Normal'],\n                fontSize=13,\n                textColor=colors.HexColor(\"#FFFFFF\"),\n                alignment=TA_CENTER,\n                spaceAfter=20,\n                fontName=content_font,\n                borderColor=colors.HexColor(\"#00d4ff\"),\n                borderWidth=1.5,\n                backColor=colors.HexColor(\"#1a0033\"),\n                borderPadding=8,\n                leading=16\n            )\n        )\n        story.append(content_header)\n        story.append(Spacer(1, 0.15*inch))\n        \n        # === PROCESS TRANSCRIPT TEXT ===\n        sections = transcript_text.split('\\n\\n')\n        \n        for section in sections:\n            section = section.strip()\n            if not section:\n                continue\n            \n            lines = section.split('\\n')\n            first_line = lines[0].strip()\n            \n            # Check if this is a header\n            if (first_line.isupper() and len(first_line) < 60) or \\\n               (first_line and first_line[0].isdigit() and '.' in first_line[:5]):\n                # This is a VVIP heading - centered with elegant decorations\n                heading_text = f'âœ¦  {first_line}  âœ¦'\n                heading = Paragraph(heading_text, heading_style)\n                story.append(heading)\n                \n                # Add the rest as body text\n                if len(lines) > 1:\n                    body_text = '\\n'.join(lines[1:])\n                    para = Paragraph(body_text.replace('\\n', '<br/>'), body_style)\n                    story.append(para)\n            else:\n                # Regular paragraph\n                para = Paragraph(section.replace('\\n', '<br/>'), body_style)\n                story.append(para)\n            \n            story.append(Spacer(1, 0.1*inch))\n        \n        # === FOOTER NOTE ===\n        story.append(Spacer(1, 0.4*inch))\n        \n        # === PREMIUM FOOTER NOTE ===\n        story.append(Spacer(1, 0.4*inch))\n        \n        footer_note_style = ParagraphStyle(\n            'FooterNote',\n            parent=styles['Normal'],\n            fontSize=9,\n            textColor=colors.HexColor(\"#1a1a1a\"),\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=14,\n            borderWidth=2,\n            borderColor=colors.HexColor(\"#00d4ff\"),\n            borderPadding=12,\n            backColor=colors.HexColor(\"#e6f7ff\")\n        )\n        \n        footer_note = Paragraph(\n            '<b>âœ“ Quality Assurance:</b> This document was generated using advanced Gemini AI technology. '\n            'For best results, cross-reference key concepts with original video content. '\n            '<br/><b>ðŸŽ“ Use This For:</b> Study reference, exam preparation, knowledge review, and learning reinforcement.'\n            '<br/><i>LearnNest - Empowering Learning Through AI Technology</i>',\n            footer_note_style\n        )\n        story.append(footer_note)\n        \n        # Build PDF with beautiful watermarked canvas\n        def make_canvas(*args, **kwargs):\n            return BeautifulWatermarkedCanvas(*args, add_watermark=add_watermark, custom_watermark=custom_watermark, **kwargs)\n        \n        doc.build(story, canvasmaker=make_canvas)\n        \n        return True\n        \n    except Exception as e:\n        print(f\"Error generating beautiful PDF: {e}\")\n        return False\n\n\ndef generate_notes_pdf(notes_content, topic, teacher_name, output_path, add_watermark=True, custom_watermark=None):\n    \"\"\"\n    Generate a stunning, professional PDF for AI-generated notes with LearnNest branding\n    \n    Args:\n        notes_content (str): The AI-generated notes content (can be markdown formatted)\n        topic (str): The topic/subject of the notes\n        teacher_name (str): Name of the instructor/teacher\n        output_path (str): Full path where the PDF should be saved\n        add_watermark (bool): Whether to add LearnNest watermark (default: True)\n        custom_watermark (str): Custom watermark text from student (optional)\n    \n    Returns:\n        bool: True if successful, False otherwise\n    \"\"\"\n    try:\n        # Ensure directory exists\n        os.makedirs(os.path.dirname(output_path), exist_ok=True)\n        \n        # Create the PDF document with custom canvas\n        doc = SimpleDocTemplate(\n            output_path,\n            pagesize=letter,\n            rightMargin=0.8*inch,\n            leftMargin=0.8*inch,\n            topMargin=1.0*inch,\n            bottomMargin=1.0*inch\n        )\n        \n        # Container for the 'Flowable' objects\n        story = []\n        \n        # Define custom styles\n        styles = getSampleStyleSheet()\n        \n        # Detect language for font selection\n        content_font = get_font_for_text(notes_content + topic)\n        \n        # === TITLE STYLE ===\n        title_style = ParagraphStyle(\n            'NotesTitle',\n            parent=styles['Heading1'],\n            fontSize=28,\n            textColor=colors.HexColor(\"#1a0033\"),\n            spaceAfter=12,\n            spaceBefore=6,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=32,\n            borderPadding=12,\n            borderColor=colors.HexColor(\"#00d4ff\"),\n            borderWidth=0.5\n        )\n        \n        # === SUBTITLE STYLE ===\n        subtitle_style = ParagraphStyle(\n            'NotesSubtitle',\n            parent=styles['Normal'],\n            fontSize=13,\n            textColor=colors.HexColor(\"#555555\"),\n            spaceAfter=20,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=16\n        )\n        \n        # === TEACHER NAME STYLE ===\n        teacher_style = ParagraphStyle(\n            'TeacherName',\n            parent=styles['Normal'],\n            fontSize=14,\n            textColor=colors.HexColor(\"#00d4ff\"),\n            spaceAfter=24,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=16\n        )\n        \n        # === VVIP HEADING STYLE (CENTERED) ===\n        heading_style = ParagraphStyle(\n            'VVIPNotesHeading',\n            parent=styles['Heading2'],\n            fontSize=16,\n            textColor=colors.HexColor(\"#FFFFFF\"),\n            spaceAfter=16,\n            spaceBefore=20,\n            alignment=TA_CENTER,\n            fontName=content_font,\n            borderPadding=12,\n            borderColor=colors.HexColor(\"#0A84FF\"),\n            borderWidth=2,\n            backColor=colors.HexColor(\"#1a0033\"),\n            leading=20,\n            borderRadius=8\n        )\n        \n        # === BODY STYLE ===\n        body_style = ParagraphStyle(\n            'NotesBody',\n            parent=styles['BodyText'],\n            fontSize=10.5,\n            alignment=TA_JUSTIFY,\n            spaceAfter=12,\n            leading=20,\n            textColor=colors.HexColor(\"#1a1a1a\"),\n            fontName=content_font,\n            borderPadding=6\n        )\n        \n        # === DOCUMENT HEADER ===\n        story.append(Spacer(1, 0.2*inch))\n        \n        # Main Title\n        title = Paragraph(f'<b>{topic}</b>', title_style)\n        story.append(title)\n        \n        # Subtitle\n        subtitle = Paragraph('AI-Generated Study Notes', subtitle_style)\n        story.append(subtitle)\n        \n        # Teacher Name\n        if teacher_name:\n            teacher_para = Paragraph(f'<b>By: {teacher_name}</b>', teacher_style)\n            story.append(teacher_para)\n        \n        story.append(Spacer(1, 0.3*inch))\n        \n        # === INFO BOX ===\n        info_data = [\n            [Paragraph('<b>Generated On:</b>', subtitle_style), \n             Paragraph(datetime.now().strftime(\"%B %d, %Y at %I:%M %p\"), subtitle_style)]\n        ]\n        \n        info_table = Table(info_data, colWidths=[1.5*inch, 4.5*inch])\n        info_table.setStyle(TableStyle([\n            ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor(\"#e6f7ff\")),\n            ('BOX', (0, 0), (-1, -1), 1.5, colors.HexColor(\"#00d4ff\")),\n            ('LEFTPADDING', (0, 0), (-1, -1), 12),\n            ('RIGHTPADDING', (0, 0), (-1, -1), 12),\n            ('TOPPADDING', (0, 0), (-1, -1), 10),\n            ('BOTTOMPADDING', (0, 0), (-1, -1), 10),\n            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),\n            ('FONTNAME', (0, 0), (-1, -1), content_font),\n        ]))\n        \n        story.append(info_table)\n        story.append(Spacer(1, 0.4*inch))\n        \n        # === CONTENT DIVIDER ===\n        content_header = Paragraph(\n            '<b>ðŸ“š  STUDY NOTES  ðŸ“š</b>',\n            ParagraphStyle(\n                'ContentHeader',\n                parent=styles['Normal'],\n                fontSize=13,\n                textColor=colors.HexColor(\"#FFFFFF\"),\n                alignment=TA_CENTER,\n                spaceAfter=20,\n                fontName=content_font,\n                borderColor=colors.HexColor(\"#00d4ff\"),\n                borderWidth=1.5,\n                backColor=colors.HexColor(\"#1a0033\"),\n                borderPadding=8,\n                leading=16\n            )\n        )\n        story.append(content_header)\n        story.append(Spacer(1, 0.15*inch))\n        \n        # === PROCESS NOTES CONTENT ===\n        # Handle markdown-style formatting\n        sections = notes_content.split('\\n\\n')\n        \n        for section in sections:\n            section = section.strip()\n            if not section:\n                continue\n            \n            lines = section.split('\\n')\n            first_line = lines[0].strip()\n            \n            # Check for markdown headers\n            if first_line.startswith('# '):\n                heading_text = f'âœ¦  {first_line[2:]}  âœ¦'\n                heading = Paragraph(heading_text, heading_style)\n                story.append(heading)\n                \n                if len(lines) > 1:\n                    body_text = '\\n'.join(lines[1:])\n                    para = Paragraph(body_text.replace('\\n', '<br/>'), body_style)\n                    story.append(para)\n            elif first_line.startswith('## '):\n                heading_text = f'âœ¦  {first_line[3:]}  âœ¦'\n                heading = Paragraph(heading_text, heading_style)\n                story.append(heading)\n                \n                if len(lines) > 1:\n                    body_text = '\\n'.join(lines[1:])\n                    para = Paragraph(body_text.replace('\\n', '<br/>'), body_style)\n                    story.append(para)\n            elif first_line.startswith('### '):\n                heading_text = f'âœ¦  {first_line[4:]}  âœ¦'\n                heading = Paragraph(heading_text, heading_style)\n                story.append(heading)\n                \n                if len(lines) > 1:\n                    body_text = '\\n'.join(lines[1:])\n                    para = Paragraph(body_text.replace('\\n', '<br/>'), body_style)\n                    story.append(para)\n            else:\n                # Process regular content with bold markers - properly handle markdown\n                content = section\n                # Replace **text** with <b>text</b>\n                import re\n                content = re.sub(r'\\*\\*(.+?)\\*\\*', r'<b>\\1</b>', content)\n                # Escape any remaining asterisks\n                content = content.replace('*', 'â€¢')\n                para = Paragraph(content.replace('\\n', '<br/>'), body_style)\n                story.append(para)\n            \n            story.append(Spacer(1, 0.1*inch))\n        \n        # === FOOTER NOTE ===\n        story.append(Spacer(1, 0.4*inch))\n        \n        footer_note_style = ParagraphStyle(\n            'FooterNote',\n            parent=styles['Normal'],\n            fontSize=9,\n            textColor=colors.HexColor(\"#1a1a1a\"),\n            alignment=TA_CENTER,\n            fontName=content_font,\n            leading=14,\n            borderWidth=2,\n            borderColor=colors.HexColor(\"#00d4ff\"),\n            borderPadding=12,\n            backColor=colors.HexColor(\"#e6f7ff\")\n        )\n        \n        footer_note = Paragraph(\n            '<b>âœ“ AI-Generated Content:</b> These notes were created using advanced Gemini AI technology. '\n            'Review and supplement with additional resources for comprehensive understanding. '\n            '<br/><b>ðŸŽ“ Use This For:</b> Study reference, exam preparation, concept review, and knowledge reinforcement.'\n            '<br/><i>LearnNest - Empowering Learning Through AI Technology</i>',\n            footer_note_style\n        )\n        story.append(footer_note)\n        \n        # Build PDF with beautiful watermarked canvas\n        def make_canvas(*args, **kwargs):\n            return BeautifulWatermarkedCanvas(*args, add_watermark=add_watermark, custom_watermark=custom_watermark, **kwargs)\n        \n        doc.build(story, canvasmaker=make_canvas)\n        \n        return True\n        \n    except Exception as e:\n        print(f\"Error generating notes PDF: {e}\")\n        return False\n","size_bytes":25870},"pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"eventlet>=0.40.3\",\n    \"flask>=3.1.2\",\n    \"flask-caching>=2.3.1\",\n    \"flask-login>=0.6.3\",\n    \"flask-mail>=0.10.0\",\n    \"flask-socketio>=5.5.1\",\n    \"google-genai>=1.36.0\",\n    \"gunicorn>=23.0.0\",\n    \"nltk>=3.9.1\",\n    \"numpy>=2.3.3\",\n    \"pandas>=2.3.2\",\n    \"pillow>=11.3.0\",\n    \"pypdf2>=3.0.1\",\n    \"python-dotenv>=1.1.1\",\n    \"pytubefix>=10.3.5\",\n    \"reportlab>=4.4.5\",\n    \"sift-stack-py>=0.8.5\",\n    \"werkzeug>=3.1.3\",\n    \"yt-dlp>=2024.12.23\",\n]\n","size_bytes":606},"ghalib/templates/student/video_download/tailwind.config.js":{"content":"/** @type {import('tailwindcss').Config} */\nmodule.exports = {\n  content: [\"./templates/*\"],\n  theme: {\n    extend: {},\n  },\n  plugins: [],\n}\n\n","size_bytes":143},"LearnNestGemini/weather-app-abdulwaheed/utils/__init__.py":{"content":"# Utils package for LearnNest LMS\n","size_bytes":34},"LearnNestGemini/weather-app-abdulwaheed/templates/student/video_download/static/css/output.css":{"content":"/*\n! tailwindcss v3.3.2 | MIT License | https://tailwindcss.com\n*/\n\n/*\n1. Prevent padding and border from affecting element width. (https://github.com/mozdevs/cssremedy/issues/4)\n2. Allow adding a border to an element by just adding a border-width. (https://github.com/tailwindcss/tailwindcss/pull/116)\n*/\n\n*,\n::before,\n::after {\n  box-sizing: border-box;\n  /* 1 */\n  border-width: 0;\n  /* 2 */\n  border-style: solid;\n  /* 2 */\n  border-color: #e5e7eb;\n  /* 2 */\n}\n\n::before,\n::after {\n  --tw-content: '';\n}\n\n/*\n1. Use a consistent sensible line-height in all browsers.\n2. Prevent adjustments of font size after orientation changes in iOS.\n3. Use a more readable tab size.\n4. Use the user's configured `sans` font-family by default.\n5. Use the user's configured `sans` font-feature-settings by default.\n6. Use the user's configured `sans` font-variation-settings by default.\n*/\n\nhtml {\n  line-height: 1.5;\n  /* 1 */\n  -webkit-text-size-adjust: 100%;\n  /* 2 */\n  -moz-tab-size: 4;\n  /* 3 */\n  -o-tab-size: 4;\n     tab-size: 4;\n  /* 3 */\n  font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, \"Noto Sans\", sans-serif, \"Apple Color Emoji\", \"Segoe UI Emoji\", \"Segoe UI Symbol\", \"Noto Color Emoji\";\n  /* 4 */\n  font-feature-settings: normal;\n  /* 5 */\n  font-variation-settings: normal;\n  /* 6 */\n}\n\n/*\n1. Remove the margin in all browsers.\n2. Inherit line-height from `html` so users can set them as a class directly on the `html` element.\n*/\n\nbody {\n  margin: 0;\n  /* 1 */\n  line-height: inherit;\n  /* 2 */\n}\n\n/*\n1. Add the correct height in Firefox.\n2. Correct the inheritance of border color in Firefox. (https://bugzilla.mozilla.org/show_bug.cgi?id=190655)\n3. Ensure horizontal rules are visible by default.\n*/\n\nhr {\n  height: 0;\n  /* 1 */\n  color: inherit;\n  /* 2 */\n  border-top-width: 1px;\n  /* 3 */\n}\n\n/*\nAdd the correct text decoration in Chrome, Edge, and Safari.\n*/\n\nabbr:where([title]) {\n  -webkit-text-decoration: underline dotted;\n          text-decoration: underline dotted;\n}\n\n/*\nRemove the default font size and weight for headings.\n*/\n\nh1,\nh2,\nh3,\nh4,\nh5,\nh6 {\n  font-size: inherit;\n  font-weight: inherit;\n}\n\n/*\nReset links to optimize for opt-in styling instead of opt-out.\n*/\n\na {\n  color: inherit;\n  text-decoration: inherit;\n}\n\n/*\nAdd the correct font weight in Edge and Safari.\n*/\n\nb,\nstrong {\n  font-weight: bolder;\n}\n\n/*\n1. Use the user's configured `mono` font family by default.\n2. Correct the odd `em` font sizing in all browsers.\n*/\n\ncode,\nkbd,\nsamp,\npre {\n  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;\n  /* 1 */\n  font-size: 1em;\n  /* 2 */\n}\n\n/*\nAdd the correct font size in all browsers.\n*/\n\nsmall {\n  font-size: 80%;\n}\n\n/*\nPrevent `sub` and `sup` elements from affecting the line height in all browsers.\n*/\n\nsub,\nsup {\n  font-size: 75%;\n  line-height: 0;\n  position: relative;\n  vertical-align: baseline;\n}\n\nsub {\n  bottom: -0.25em;\n}\n\nsup {\n  top: -0.5em;\n}\n\n/*\n1. Remove text indentation from table contents in Chrome and Safari. (https://bugs.chromium.org/p/chromium/issues/detail?id=999088, https://bugs.webkit.org/show_bug.cgi?id=201297)\n2. Correct table border color inheritance in all Chrome and Safari. (https://bugs.chromium.org/p/chromium/issues/detail?id=935729, https://bugs.webkit.org/show_bug.cgi?id=195016)\n3. Remove gaps between table borders by default.\n*/\n\ntable {\n  text-indent: 0;\n  /* 1 */\n  border-color: inherit;\n  /* 2 */\n  border-collapse: collapse;\n  /* 3 */\n}\n\n/*\n1. Change the font styles in all browsers.\n2. Remove the margin in Firefox and Safari.\n3. Remove default padding in all browsers.\n*/\n\nbutton,\ninput,\noptgroup,\nselect,\ntextarea {\n  font-family: inherit;\n  /* 1 */\n  font-size: 100%;\n  /* 1 */\n  font-weight: inherit;\n  /* 1 */\n  line-height: inherit;\n  /* 1 */\n  color: inherit;\n  /* 1 */\n  margin: 0;\n  /* 2 */\n  padding: 0;\n  /* 3 */\n}\n\n/*\nRemove the inheritance of text transform in Edge and Firefox.\n*/\n\nbutton,\nselect {\n  text-transform: none;\n}\n\n/*\n1. Correct the inability to style clickable types in iOS and Safari.\n2. Remove default button styles.\n*/\n\nbutton,\n[type='button'],\n[type='reset'],\n[type='submit'] {\n  -webkit-appearance: button;\n  /* 1 */\n  background-color: transparent;\n  /* 2 */\n  background-image: none;\n  /* 2 */\n}\n\n/*\nUse the modern Firefox focus style for all focusable elements.\n*/\n\n:-moz-focusring {\n  outline: auto;\n}\n\n/*\nRemove the additional `:invalid` styles in Firefox. (https://github.com/mozilla/gecko-dev/blob/2f9eacd9d3d995c937b4251a5557d95d494c9be1/layout/style/res/forms.css#L728-L737)\n*/\n\n:-moz-ui-invalid {\n  box-shadow: none;\n}\n\n/*\nAdd the correct vertical alignment in Chrome and Firefox.\n*/\n\nprogress {\n  vertical-align: baseline;\n}\n\n/*\nCorrect the cursor style of increment and decrement buttons in Safari.\n*/\n\n::-webkit-inner-spin-button,\n::-webkit-outer-spin-button {\n  height: auto;\n}\n\n/*\n1. Correct the odd appearance in Chrome and Safari.\n2. Correct the outline style in Safari.\n*/\n\n[type='search'] {\n  -webkit-appearance: textfield;\n  /* 1 */\n  outline-offset: -2px;\n  /* 2 */\n}\n\n/*\nRemove the inner padding in Chrome and Safari on macOS.\n*/\n\n::-webkit-search-decoration {\n  -webkit-appearance: none;\n}\n\n/*\n1. Correct the inability to style clickable types in iOS and Safari.\n2. Change font properties to `inherit` in Safari.\n*/\n\n::-webkit-file-upload-button {\n  -webkit-appearance: button;\n  /* 1 */\n  font: inherit;\n  /* 2 */\n}\n\n/*\nAdd the correct display in Chrome and Safari.\n*/\n\nsummary {\n  display: list-item;\n}\n\n/*\nRemoves the default spacing and border for appropriate elements.\n*/\n\nblockquote,\ndl,\ndd,\nh1,\nh2,\nh3,\nh4,\nh5,\nh6,\nhr,\nfigure,\np,\npre {\n  margin: 0;\n}\n\nfieldset {\n  margin: 0;\n  padding: 0;\n}\n\nlegend {\n  padding: 0;\n}\n\nol,\nul,\nmenu {\n  list-style: none;\n  margin: 0;\n  padding: 0;\n}\n\n/*\nPrevent resizing textareas horizontally by default.\n*/\n\ntextarea {\n  resize: vertical;\n}\n\n/*\n1. Reset the default placeholder opacity in Firefox. (https://github.com/tailwindlabs/tailwindcss/issues/3300)\n2. Set the default placeholder color to the user's configured gray 400 color.\n*/\n\ninput::-moz-placeholder, textarea::-moz-placeholder {\n  opacity: 1;\n  /* 1 */\n  color: #9ca3af;\n  /* 2 */\n}\n\ninput::placeholder,\ntextarea::placeholder {\n  opacity: 1;\n  /* 1 */\n  color: #9ca3af;\n  /* 2 */\n}\n\n/*\nSet the default cursor for buttons.\n*/\n\nbutton,\n[role=\"button\"] {\n  cursor: pointer;\n}\n\n/*\nMake sure disabled buttons don't get the pointer cursor.\n*/\n\n:disabled {\n  cursor: default;\n}\n\n/*\n1. Make replaced elements `display: block` by default. (https://github.com/mozdevs/cssremedy/issues/14)\n2. Add `vertical-align: middle` to align replaced elements more sensibly by default. (https://github.com/jensimmons/cssremedy/issues/14#issuecomment-634934210)\n   This can trigger a poorly considered lint error in some tools but is included by design.\n*/\n\nimg,\nsvg,\nvideo,\ncanvas,\naudio,\niframe,\nembed,\nobject {\n  display: block;\n  /* 1 */\n  vertical-align: middle;\n  /* 2 */\n}\n\n/*\nConstrain images and videos to the parent width and preserve their intrinsic aspect ratio. (https://github.com/mozdevs/cssremedy/issues/14)\n*/\n\nimg,\nvideo {\n  max-width: 100%;\n  height: auto;\n}\n\n/* Make elements with the HTML hidden attribute stay hidden by default */\n\n[hidden] {\n  display: none;\n}\n\n*, ::before, ::after {\n  --tw-border-spacing-x: 0;\n  --tw-border-spacing-y: 0;\n  --tw-translate-x: 0;\n  --tw-translate-y: 0;\n  --tw-rotate: 0;\n  --tw-skew-x: 0;\n  --tw-skew-y: 0;\n  --tw-scale-x: 1;\n  --tw-scale-y: 1;\n  --tw-pan-x:  ;\n  --tw-pan-y:  ;\n  --tw-pinch-zoom:  ;\n  --tw-scroll-snap-strictness: proximity;\n  --tw-gradient-from-position:  ;\n  --tw-gradient-via-position:  ;\n  --tw-gradient-to-position:  ;\n  --tw-ordinal:  ;\n  --tw-slashed-zero:  ;\n  --tw-numeric-figure:  ;\n  --tw-numeric-spacing:  ;\n  --tw-numeric-fraction:  ;\n  --tw-ring-inset:  ;\n  --tw-ring-offset-width: 0px;\n  --tw-ring-offset-color: #fff;\n  --tw-ring-color: rgb(59 130 246 / 0.5);\n  --tw-ring-offset-shadow: 0 0 #0000;\n  --tw-ring-shadow: 0 0 #0000;\n  --tw-shadow: 0 0 #0000;\n  --tw-shadow-colored: 0 0 #0000;\n  --tw-blur:  ;\n  --tw-brightness:  ;\n  --tw-contrast:  ;\n  --tw-grayscale:  ;\n  --tw-hue-rotate:  ;\n  --tw-invert:  ;\n  --tw-saturate:  ;\n  --tw-sepia:  ;\n  --tw-drop-shadow:  ;\n  --tw-backdrop-blur:  ;\n  --tw-backdrop-brightness:  ;\n  --tw-backdrop-contrast:  ;\n  --tw-backdrop-grayscale:  ;\n  --tw-backdrop-hue-rotate:  ;\n  --tw-backdrop-invert:  ;\n  --tw-backdrop-opacity:  ;\n  --tw-backdrop-saturate:  ;\n  --tw-backdrop-sepia:  ;\n}\n\n::backdrop {\n  --tw-border-spacing-x: 0;\n  --tw-border-spacing-y: 0;\n  --tw-translate-x: 0;\n  --tw-translate-y: 0;\n  --tw-rotate: 0;\n  --tw-skew-x: 0;\n  --tw-skew-y: 0;\n  --tw-scale-x: 1;\n  --tw-scale-y: 1;\n  --tw-pan-x:  ;\n  --tw-pan-y:  ;\n  --tw-pinch-zoom:  ;\n  --tw-scroll-snap-strictness: proximity;\n  --tw-gradient-from-position:  ;\n  --tw-gradient-via-position:  ;\n  --tw-gradient-to-position:  ;\n  --tw-ordinal:  ;\n  --tw-slashed-zero:  ;\n  --tw-numeric-figure:  ;\n  --tw-numeric-spacing:  ;\n  --tw-numeric-fraction:  ;\n  --tw-ring-inset:  ;\n  --tw-ring-offset-width: 0px;\n  --tw-ring-offset-color: #fff;\n  --tw-ring-color: rgb(59 130 246 / 0.5);\n  --tw-ring-offset-shadow: 0 0 #0000;\n  --tw-ring-shadow: 0 0 #0000;\n  --tw-shadow: 0 0 #0000;\n  --tw-shadow-colored: 0 0 #0000;\n  --tw-blur:  ;\n  --tw-brightness:  ;\n  --tw-contrast:  ;\n  --tw-grayscale:  ;\n  --tw-hue-rotate:  ;\n  --tw-invert:  ;\n  --tw-saturate:  ;\n  --tw-sepia:  ;\n  --tw-drop-shadow:  ;\n  --tw-backdrop-blur:  ;\n  --tw-backdrop-brightness:  ;\n  --tw-backdrop-contrast:  ;\n  --tw-backdrop-grayscale:  ;\n  --tw-backdrop-hue-rotate:  ;\n  --tw-backdrop-invert:  ;\n  --tw-backdrop-opacity:  ;\n  --tw-backdrop-saturate:  ;\n  --tw-backdrop-sepia:  ;\n}\n\n.container {\n  width: 100%;\n}\n\n@media (min-width: 640px) {\n  .container {\n    max-width: 640px;\n  }\n}\n\n@media (min-width: 768px) {\n  .container {\n    max-width: 768px;\n  }\n}\n\n@media (min-width: 1024px) {\n  .container {\n    max-width: 1024px;\n  }\n}\n\n@media (min-width: 1280px) {\n  .container {\n    max-width: 1280px;\n  }\n}\n\n@media (min-width: 1536px) {\n  .container {\n    max-width: 1536px;\n  }\n}\n\n.static {\n  position: static;\n}\n\n.mx-auto {\n  margin-left: auto;\n  margin-right: auto;\n}\n\n.mb-12 {\n  margin-bottom: 3rem;\n}\n\n.mb-4 {\n  margin-bottom: 1rem;\n}\n\n.mb-5 {\n  margin-bottom: 1.25rem;\n}\n\n.mb-8 {\n  margin-bottom: 2rem;\n}\n\n.ml-1 {\n  margin-left: 0.25rem;\n}\n\n.ml-3 {\n  margin-left: 0.75rem;\n}\n\n.mr-3 {\n  margin-right: 0.75rem;\n}\n\n.mt-4 {\n  margin-top: 1rem;\n}\n\n.flex {\n  display: flex;\n}\n\n.inline-flex {\n  display: inline-flex;\n}\n\n.h-10 {\n  height: 2.5rem;\n}\n\n.h-5 {\n  height: 1.25rem;\n}\n\n.w-1\\/2 {\n  width: 50%;\n}\n\n.w-10 {\n  width: 2.5rem;\n}\n\n.w-5 {\n  width: 1.25rem;\n}\n\n.w-full {\n  width: 100%;\n}\n\n.w-5\\/6 {\n  width: 83.333333%;\n}\n\n.flex-shrink-0 {\n  flex-shrink: 0;\n}\n\n.appearance-none {\n  -webkit-appearance: none;\n     -moz-appearance: none;\n          appearance: none;\n}\n\n.flex-col {\n  flex-direction: column;\n}\n\n.flex-wrap {\n  flex-wrap: wrap;\n}\n\n.items-center {\n  align-items: center;\n}\n\n.justify-center {\n  justify-content: center;\n}\n\n.rounded {\n  border-radius: 0.25rem;\n}\n\n.rounded-full {\n  border-radius: 9999px;\n}\n\n.border-0 {\n  border-width: 0px;\n}\n\n.border-4 {\n  border-width: 4px;\n}\n\n.border-b {\n  border-bottom-width: 1px;\n}\n\n.border-none {\n  border-style: none;\n}\n\n.border-teal-500 {\n  --tw-border-opacity: 1;\n  border-color: rgb(20 184 166 / var(--tw-border-opacity));\n}\n\n.bg-gray-800 {\n  --tw-bg-opacity: 1;\n  background-color: rgb(31 41 55 / var(--tw-bg-opacity));\n}\n\n.bg-gray-900 {\n  --tw-bg-opacity: 1;\n  background-color: rgb(17 24 39 / var(--tw-bg-opacity));\n}\n\n.bg-indigo-500 {\n  --tw-bg-opacity: 1;\n  background-color: rgb(99 102 241 / var(--tw-bg-opacity));\n}\n\n.bg-teal-500 {\n  --tw-bg-opacity: 1;\n  background-color: rgb(20 184 166 / var(--tw-bg-opacity));\n}\n\n.bg-transparent {\n  background-color: transparent;\n}\n\n.object-cover {\n  -o-object-fit: cover;\n     object-fit: cover;\n}\n\n.object-center {\n  -o-object-position: center;\n     object-position: center;\n}\n\n.p-2 {\n  padding: 0.5rem;\n}\n\n.p-5 {\n  padding: 1.25rem;\n}\n\n.px-2 {\n  padding-left: 0.5rem;\n  padding-right: 0.5rem;\n}\n\n.px-3 {\n  padding-left: 0.75rem;\n  padding-right: 0.75rem;\n}\n\n.px-5 {\n  padding-left: 1.25rem;\n  padding-right: 1.25rem;\n}\n\n.py-1 {\n  padding-top: 0.25rem;\n  padding-bottom: 0.25rem;\n}\n\n.py-2 {\n  padding-top: 0.5rem;\n  padding-bottom: 0.5rem;\n}\n\n.py-24 {\n  padding-top: 6rem;\n  padding-bottom: 6rem;\n}\n\n.py-8 {\n  padding-top: 2rem;\n  padding-bottom: 2rem;\n}\n\n.text-center {\n  text-align: center;\n}\n\n.text-2xl {\n  font-size: 1.5rem;\n  line-height: 2rem;\n}\n\n.text-3xl {\n  font-size: 1.875rem;\n  line-height: 2.25rem;\n}\n\n.text-base {\n  font-size: 1rem;\n  line-height: 1.5rem;\n}\n\n.text-sm {\n  font-size: 0.875rem;\n  line-height: 1.25rem;\n}\n\n.text-xl {\n  font-size: 1.25rem;\n  line-height: 1.75rem;\n}\n\n.font-medium {\n  font-weight: 500;\n}\n\n.leading-relaxed {\n  line-height: 1.625;\n}\n\n.leading-tight {\n  line-height: 1.25;\n}\n\n.text-gray-400 {\n  --tw-text-opacity: 1;\n  color: rgb(156 163 175 / var(--tw-text-opacity));\n}\n\n.text-gray-500 {\n  --tw-text-opacity: 1;\n  color: rgb(107 114 128 / var(--tw-text-opacity));\n}\n\n.text-gray-600 {\n  --tw-text-opacity: 1;\n  color: rgb(75 85 99 / var(--tw-text-opacity));\n}\n\n.text-gray-700 {\n  --tw-text-opacity: 1;\n  color: rgb(55 65 81 / var(--tw-text-opacity));\n}\n\n.text-gray-900 {\n  --tw-text-opacity: 1;\n  color: rgb(17 24 39 / var(--tw-text-opacity));\n}\n\n.text-white {\n  --tw-text-opacity: 1;\n  color: rgb(255 255 255 / var(--tw-text-opacity));\n}\n\n.hover\\:border-teal-700:hover {\n  --tw-border-opacity: 1;\n  border-color: rgb(15 118 110 / var(--tw-border-opacity));\n}\n\n.hover\\:bg-gray-700:hover {\n  --tw-bg-opacity: 1;\n  background-color: rgb(55 65 81 / var(--tw-bg-opacity));\n}\n\n.hover\\:bg-teal-700:hover {\n  --tw-bg-opacity: 1;\n  background-color: rgb(15 118 110 / var(--tw-bg-opacity));\n}\n\n.focus\\:outline-none:focus {\n  outline: 2px solid transparent;\n  outline-offset: 2px;\n}\n\n@media (min-width: 640px) {\n  .sm\\:ml-4 {\n    margin-left: 1rem;\n  }\n\n  .sm\\:ml-auto {\n    margin-left: auto;\n  }\n\n  .sm\\:mt-0 {\n    margin-top: 0px;\n  }\n\n  .sm\\:flex-row {\n    flex-direction: row;\n  }\n\n  .sm\\:justify-start {\n    justify-content: flex-start;\n  }\n\n  .sm\\:border-l-2 {\n    border-left-width: 2px;\n  }\n\n  .sm\\:border-gray-800 {\n    --tw-border-opacity: 1;\n    border-color: rgb(31 41 55 / var(--tw-border-opacity));\n  }\n\n  .sm\\:py-2 {\n    padding-top: 0.5rem;\n    padding-bottom: 0.5rem;\n  }\n\n  .sm\\:pl-4 {\n    padding-left: 1rem;\n  }\n\n  .sm\\:text-3xl {\n    font-size: 1.875rem;\n    line-height: 2.25rem;\n  }\n\n  .sm\\:text-4xl {\n    font-size: 2.25rem;\n    line-height: 2.5rem;\n  }\n}\n\n@media (min-width: 768px) {\n  .md\\:mb-0 {\n    margin-bottom: 0px;\n  }\n\n  .md\\:ml-auto {\n    margin-left: auto;\n  }\n\n  .md\\:mt-0 {\n    margin-top: 0px;\n  }\n\n  .md\\:w-3\\/6 {\n    width: 50%;\n  }\n\n  .md\\:w-1\\/2 {\n    width: 50%;\n  }\n\n  .md\\:flex-row {\n    flex-direction: row;\n  }\n\n  .md\\:justify-start {\n    justify-content: flex-start;\n  }\n}\n\n@media (min-width: 1024px) {\n  .lg\\:w-2\\/3 {\n    width: 66.666667%;\n  }\n\n  .lg\\:w-2\\/6 {\n    width: 33.333333%;\n  }\n\n  .lg\\:w-1\\/2 {\n    width: 50%;\n  }\n}","size_bytes":15213},"LearnNestGemini/weather-app-abdulwaheed/static/js/main.js":{"content":"// Main JavaScript for LearnNest LMS\n// Mobile menu is handled in base.html to avoid conflicts\n\n// Flash message auto-dismiss\ndocument.addEventListener('DOMContentLoaded', function() {\n    const flashMessages = document.querySelectorAll('.flash-message');\n    \n    flashMessages.forEach(function(message) {\n        setTimeout(function() {\n            message.style.opacity = '0';\n            message.style.transform = 'translateX(100%)';\n            setTimeout(function() {\n                message.remove();\n            }, 300);\n        }, 5000);\n    });\n});\n\n// Utility function for confirming destructive actions\nfunction confirmAction(message) {\n    return confirm(message || 'Are you sure you want to proceed?');\n}\n\n// Copy to clipboard utility\nfunction copyToClipboard(text) {\n    const textarea = document.createElement('textarea');\n    textarea.value = text;\n    textarea.style.position = 'fixed';\n    textarea.style.opacity = '0';\n    document.body.appendChild(textarea);\n    textarea.select();\n    document.execCommand('copy');\n    document.body.removeChild(textarea);\n    \n    // Show feedback\n    const feedback = document.createElement('div');\n    feedback.textContent = 'Copied to clipboard!';\n    feedback.className = 'flash-message success';\n    feedback.style.position = 'fixed';\n    feedback.style.top = '20px';\n    feedback.style.right = '20px';\n    feedback.style.zIndex = '10000';\n    document.body.appendChild(feedback);\n    \n    setTimeout(function() {\n        feedback.remove();\n    }, 2000);\n}\n","size_bytes":1518},"templates/student/video_download/app.sh":{"content":"python app.py\n","size_bytes":14},"ghalib/static/js/dashboard.js":{"content":"<script>\nfunction enrollInCourse(courseCode, courseTitle) {\n    document.getElementById('modalCourseTitle').textContent = courseTitle;\n    document.getElementById('modalCourseCode').textContent = courseCode;\n    document.getElementById('modalCourseCodeInput').value = courseCode;\n    document.getElementById('modalEnrollmentKey').value = '';\n    document.getElementById('enrollmentModal').style.display = 'block';\n    document.getElementById('modalEnrollmentKey').focus();\n}\n\nfunction closeEnrollmentModal() {\n    document.getElementById('enrollmentModal').style.display = 'none';\n}\n\nfunction viewCourseDetails(courseId) {\n    window.location.href = '{{ url_for(\"student_browse_courses\") }}#course-' + courseId;\n}\n\n// Set current date\ndocument.addEventListener('DOMContentLoaded', function() {\n    const now = new Date();\n    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };\n    document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);\n    \n    // Initialize progress animations\n    initializeProgressAnimations();\n});\n\n// Function to initialize progress animations\nfunction initializeProgressAnimations() {\n    const progressBars = document.querySelectorAll('.progress-fill');\n    \n    progressBars.forEach(bar => {\n        // Add a slight delay to make the animation more noticeable\n        setTimeout(() => {\n            const width = bar.style.width;\n            bar.style.width = '0%';\n            \n            // Animate to the actual width\n            setTimeout(() => {\n                bar.style.width = width;\n            }, 300);\n        }, 500);\n    });\n}\n\n// Function to simulate progress update\nfunction simulateProgressUpdate(courseCode, newProgress) {\n    const courseItems = document.querySelectorAll('.course-item');\n    \n    courseItems.forEach(item => {\n        const codeElement = item.querySelector('.course-code');\n        if (codeElement && codeElement.textContent === courseCode) {\n            const progressFill = item.querySelector('.progress-fill');\n            const progressPercentage = item.querySelector('.progress-percentage');\n            \n            if (progressFill) {\n                progressFill.style.width = `${newProgress}%`;\n                \n                // Add a glow effect\n                progressFill.style.animation = 'progress-glow 1s ease';\n                \n                // Remove animation after it completes\n                setTimeout(() => {\n                    progressFill.style.animation = '';\n                }, 1000);\n            }\n        }\n    });\n}\n\n// Close modal when clicking outside\nwindow.addEventListener('click', function(event) {\n    const modal = document.getElementById('enrollmentModal');\n    if (event.target === modal) {\n        closeEnrollmentModal();\n    }\n});\n\n// Close modal on escape key\ndocument.addEventListener('keydown', function(event) {\n    if (event.key === 'Escape') {\n        closeEnrollmentModal();\n    }\n});\n\n// Demo function to show progress animation (remove in production)\nfunction demoProgressAnimation() {\n    setTimeout(() => {\n        simulateProgressUpdate('CS101', 75);\n    }, 2000);\n    \n    setTimeout(() => {\n        simulateProgressUpdate('MATH201', 45);\n    }, 4000);\n}\n\n// Initialize demo on page load (remove in production)\ndocument.addEventListener('DOMContentLoaded', function() {\n    // Uncomment the line below to see demo progress animations\n    // demoProgressAnimation();\n});\n</script>\n","size_bytes":3479},"templates/student/video_download/static/src/input.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;","size_bytes":58}},"version":2}