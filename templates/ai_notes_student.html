{% extends "base.html" %}

{% block title %}AI Notes - {{ course.course_name }}{% endblock %}

{% block styles %}
<style>
/* Dark Theme for AI Notes */
body {
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0f0f23 100%);
    min-height: 100vh;
}

.container-fluid {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

/* Animated Background */
.ai-notes-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    overflow: hidden;
    pointer-events: none;
}

.ai-notes-bg::before {
    content: '';
    position: absolute;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(10, 132, 255, 0.03) 1px, transparent 1px);
    background-size: 50px 50px;
    animation: gridMove 20s linear infinite;
}

@keyframes gridMove {
    0% { transform: translate(0, 0); }
    100% { transform: translate(50px, 50px); }
}

/* Page Header */
.page-header {
    position: relative;
    z-index: 1;
    text-align: center;
    margin-bottom: 3rem;
    padding: 2rem;
    background: linear-gradient(135deg, rgba(10, 132, 255, 0.1), rgba(0, 212, 255, 0.1));
    border-radius: 20px;
    border: 2px solid rgba(10, 132, 255, 0.3);
    box-shadow: 0 0 40px rgba(10, 132, 255, 0.2);
}

.page-header h2 {
    color: #0A84FF;
    font-size: 2.5rem;
    font-weight: 800;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 0 0 20px rgba(10, 132, 255, 0.5);
}

.course-subtitle {
    color: rgba(255, 255, 255, 0.7);
    font-size: 1.1rem;
    margin-top: 0.5rem;
}

/* Dark Card Styles */
.dark-card {
    position: relative;
    z-index: 1;
    background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(15, 15, 35, 0.95));
    border-radius: 20px;
    border: 2px solid rgba(10, 132, 255, 0.3);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(10, 132, 255, 0.1);
    margin-bottom: 2rem;
    overflow: hidden;
    transition: all 0.4s ease;
}

.dark-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.7), 0 0 30px rgba(10, 132, 255, 0.3);
    border-color: rgba(10, 132, 255, 0.5);
}

.card-header {
    background: linear-gradient(135deg, #0A84FF, #00d4ff) !important;
    padding: 1.5rem !important;
    border-bottom: none !important;
    position: relative;
    overflow: hidden;
}

.card-header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.card-header h5 {
    margin: 0 !important;
    color: #0a0a0a !important;
    font-weight: 800 !important;
    font-size: 1.4rem !important;
    text-transform: uppercase;
    letter-spacing: 1px;
    position: relative;
    z-index: 1;
}

.card-body {
    padding: 2rem !important;
    background: rgba(10, 10, 10, 0.5);
}

/* Form Styling */
.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    color: #0A84FF;
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 0.75rem;
    display: block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-control {
    background: rgba(0, 0, 0, 0.5) !important;
    border: 2px solid rgba(10, 132, 255, 0.3) !important;
    border-radius: 12px !important;
    color: #ffffff !important;
    padding: 1rem !important;
    font-size: 1rem !important;
    transition: all 0.3s ease;
}

.form-control:focus {
    background: rgba(0, 0, 0, 0.7) !important;
    border-color: #0A84FF !important;
    box-shadow: 0 0 20px rgba(10, 132, 255, 0.3) !important;
    color: #ffffff !important;
}

.form-control::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

/* Watermark Checkbox */
.watermark-option {
    background: rgba(10, 132, 255, 0.05);
    border: 2px dashed rgba(10, 132, 255, 0.3);
    border-radius: 12px;
    padding: 1.25rem;
    margin-top: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
}

.watermark-option:hover {
    background: rgba(10, 132, 255, 0.1);
    border-color: rgba(10, 132, 255, 0.5);
}

.watermark-checkbox {
    width: 24px !important;
    height: 24px !important;
    cursor: pointer;
    accent-color: #0A84FF;
}

.watermark-label {
    cursor: pointer;
    color: #ffffff;
    font-weight: 600;
    font-size: 1.05rem;
    margin: 0;
    flex: 1;
}

.watermark-icon {
    color: #0A84FF;
    font-size: 1.5rem;
}

.watermark-description {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9rem;
    margin-top: 0.5rem;
    padding-left: 2.5rem;
}

/* Green Button Styles */
.btn-generate {
    background: linear-gradient(135deg, #0A84FF, #00cc6a) !important;
    color: #0a0a0a !important;
    border: none !important;
    padding: 1.2rem 3rem !important;
    font-weight: 800 !important;
    font-size: 1.1rem !important;
    border-radius: 15px !important;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    cursor: pointer;
    transition: all 0.4s ease;
    box-shadow: 0 5px 25px rgba(10, 132, 255, 0.4);
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    position: relative;
    overflow: hidden;
}

.btn-generate::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.btn-generate:hover::before {
    width: 300px;
    height: 300px;
}

.btn-generate:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 10px 40px rgba(10, 132, 255, 0.6);
    background: linear-gradient(135deg, #00ffaa, #0A84FF) !important;
}

.btn-generate i {
    font-size: 1.3rem;
    position: relative;
    z-index: 1;
}

.btn-generate span {
    position: relative;
    z-index: 1;
}

.btn-download {
    background: linear-gradient(135deg, #00d4ff, #0099cc) !important;
    color: #ffffff !important;
    border: none !important;
    padding: 0.85rem 1.75rem !important;
    font-weight: 700 !important;
    font-size: 1rem !important;
    border-radius: 10px !important;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(0, 212, 255, 0.5);
    cursor: pointer;
    white-space: nowrap;
}

.btn-download:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 30px rgba(0, 212, 255, 0.7);
    background: linear-gradient(135deg, #00e5ff, #00aadd) !important;
}

.btn-delete {
    background: linear-gradient(135deg, #ff4757, #e84118) !important;
    color: #ffffff !important;
    border: none !important;
    padding: 0.75rem 1.5rem !important;
    font-weight: 700 !important;
    border-radius: 10px !important;
    transition: all 0.3s ease;
    box-shadow: 0 3px 15px rgba(255, 71, 87, 0.4);
}

.btn-delete:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(255, 71, 87, 0.6);
}

/* Loading Status */
#generatingStatus {
    background: rgba(10, 132, 255, 0.1);
    border: 2px solid rgba(10, 132, 255, 0.3);
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 1.5rem;
    text-align: center;
    color: #0A84FF;
    font-weight: 600;
}

.spinner-border {
    border-color: #0A84FF !important;
    border-right-color: transparent !important;
}

/* Notes Grid */
.notes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 2rem;
    margin-top: 1.5rem;
}

.note-card {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(26, 26, 46, 0.8));
    border: 2px solid rgba(10, 132, 255, 0.2);
    border-radius: 15px;
    padding: 1.5rem;
    transition: all 0.4s ease;
    position: relative;
    overflow: hidden;
}

.note-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #0A84FF, #00d4ff);
}

.note-card:hover {
    transform: translateY(-5px);
    border-color: rgba(10, 132, 255, 0.5);
    box-shadow: 0 10px 30px rgba(10, 132, 255, 0.3);
}

.note-title {
    color: #0A84FF;
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 1rem;
}

.note-meta {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.note-instructor {
    color: #00d4ff;
    font-weight: 600;
    margin-top: 0.5rem;
}

.note-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.5rem;
    flex-wrap: wrap;
    align-items: center;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: rgba(255, 255, 255, 0.5);
}

.empty-state i {
    font-size: 4rem;
    color: rgba(10, 132, 255, 0.3);
    margin-bottom: 1rem;
}

/* Download Progress Indicator */
.download-progress {
    margin-top: 0.75rem;
    width: 100%;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #0A84FF 0%, #FFFFFF 100%);
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(10, 132, 255, 0.5);
}

.progress-text {
    text-align: center;
    font-size: 0.85rem;
    color: #0A84FF;
    font-weight: 700;
}

/* Responsive */
@media (max-width: 768px) {
    .page-header h2 {
        font-size: 1.8rem;
    }
    
    .notes-grid {
        grid-template-columns: 1fr;
    }
    
    .btn-generate {
        padding: 1rem 2rem !important;
        font-size: 1rem !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="ai-notes-bg"></div>

<div class="container-fluid">
    <div class="page-header">
        <h2>‚ú® AI STUDY NOTES GENERATOR ‚ú®</h2>
        <p class="course-subtitle">{{ course.course_name }}</p>
    </div>

    <!-- Create Notes Section -->
    <div class="dark-card">
        <div class="card-header">
            <h5>üöÄ Create Your Own AI-Powered Notes</h5>
        </div>
        <div class="card-body">
            <form id="createNotesForm">
                <div class="form-group">
                    <label for="topic"><i class="fas fa-lightbulb"></i> Topic / Subject</label>
                    <input type="text" class="form-control" id="topic" name="topic" 
                           placeholder="e.g., Machine Learning Basics, Quantum Physics..." required>
                </div>
                
                <div class="form-group">
                    <label for="additional_context"><i class="fas fa-edit"></i> Additional Details (Optional)</label>
                    <textarea class="form-control" id="additional_context" name="additional_context" rows="4"
                              placeholder="Add specific points, questions, or context you want the AI to focus on..."></textarea>
                </div>
                
                <div class="watermark-option">
                    <input type="checkbox" class="watermark-checkbox" id="add_watermark" name="add_watermark" checked>
                    <label class="watermark-label" for="add_watermark">
                        <i class="fas fa-certificate watermark-icon"></i>
                        <strong>Add LearnNest Watermark</strong>
                    </label>
                </div>
                <p class="watermark-description">
                    <i class="fas fa-info-circle"></i> Adds a professional LearnNest watermark to authenticate your PDF notes
                </p>
                
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label for="custom_watermark"><i class="fas fa-signature"></i> Your Custom Watermark (Optional)</label>
                    <input type="text" class="form-control" id="custom_watermark" name="custom_watermark" 
                           placeholder="e.g., Your Name, ID, or Custom Text" maxlength="50">
                    <small style="color: rgba(255, 255, 255, 0.7); display: block; margin-top: 0.5rem;">
                        <i class="fas fa-lightbulb"></i> Add your personal watermark to make these notes uniquely yours!
                    </small>
                </div>
                
                <button type="submit" class="btn-generate">
                    <i class="fas fa-magic"></i>
                    <span>Generate AI Notes</span>
                </button>
            </form>
            
            <div id="generatingStatus" style="display:none;">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Generating...</span>
                </div>
                <p style="margin-top: 1rem; margin-bottom: 0;">ü§ñ AI is crafting your personalized notes... Please wait.</p>
            </div>
        </div>
    </div>

    <!-- Instructor Notes Section -->
    <div class="dark-card">
        <div class="card-header" style="background: linear-gradient(135deg, #00d4ff, #0099cc) !important;">
            <h5>üë®‚Äçüè´ Notes from Instructor</h5>
        </div>
        <div class="card-body">
            {% if instructor_notes %}
                <div class="notes-grid">
                    {% for note in instructor_notes %}
                    <div class="note-card">
                        <div class="note-title">{{ note.topic }}</div>
                        <p class="note-instructor">üë®‚Äçüè´ By: {{ note.instructor_name }}</p>
                        <p class="note-meta">
                            <i class="fas fa-calendar"></i> {{ note.created_at }}
                        </p>
                        <div class="note-actions">
                            {% if note.pdf_path %}
                            <a href="/uploads/{{ note.pdf_path }}" target="_blank" class="btn-download" style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-eye"></i> Open PDF
                            </a>
                            <a href="/uploads/{{ note.pdf_path }}" download="{{ note.topic }}.pdf" class="btn-download" style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; background: linear-gradient(135deg, #00cc6a, #00994f) !important;">
                                <i class="fas fa-download"></i> Download
                            </a>
                            {% else %}
                            <span style="color: rgba(255,255,255,0.5); font-style: italic;">PDF not available</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>No notes from instructor yet</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- My Personal Notes Section -->
    <div class="dark-card">
        <div class="card-header">
            <h5>üìö My Personal AI Notes</h5>
        </div>
        <div class="card-body">
            {% if my_notes %}
                <div class="notes-grid">
                    {% for note in my_notes %}
                    <div class="note-card">
                        <div class="note-title">{{ note.topic }}</div>
                        <p class="note-meta">
                            <i class="fas fa-calendar"></i> Created: {{ note.created_at }}
                        </p>
                        <div class="note-actions">
                            {% if note.pdf_path %}
                            <a href="/uploads/{{ note.pdf_path }}" target="_blank" class="btn-download" style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-eye"></i> Open PDF
                            </a>
                            <a href="/uploads/{{ note.pdf_path }}" download="{{ note.topic }}.pdf" class="btn-download" style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; background: linear-gradient(135deg, #00cc6a, #00994f) !important;">
                                <i class="fas fa-download"></i> Download
                            </a>
                            {% else %}
                            <span style="color: rgba(255,255,255,0.5); font-style: italic;">PDF not generated yet</span>
                            {% endif %}
                            <button class="btn-delete" onclick="deleteNote({{ note.id }})">
                                <i class="fas fa-trash-alt"></i> Delete
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-book-open"></i>
                    <p>You haven't created any notes yet. Start generating!</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.getElementById('createNotesForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const addWatermark = document.getElementById('add_watermark').checked;
    
    document.getElementById('generatingStatus').style.display = 'block';
    
    try {
        const response = await fetch('/course/{{ course.id }}/ai_notes/student/create', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ Notes generated successfully! Your PDF is ready.');
            location.reload();
        } else {
            alert('‚ùå Error: ' + result.error);
        }
    } catch (error) {
        alert('‚ùå Error generating notes: ' + error);
    } finally {
        document.getElementById('generatingStatus').style.display = 'none';
    }
});

async function downloadWithProgress(event, url, filename, progressId) {
    event.preventDefault();
    
    const progressContainer = document.getElementById(progressId);
    const progressFill = progressContainer.querySelector('.progress-fill');
    const progressText = progressContainer.querySelector('.progress-text');
    
    progressContainer.style.display = 'block';
    
    try {
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error('Download failed');
        }
        
        const contentLength = response.headers.get('content-length');
        
        // If no content-length or streaming not supported, fallback to direct download
        if (!contentLength || !response.body) {
            window.location.href = url;
            progressContainer.style.display = 'none';
            return;
        }
        
        const total = parseInt(contentLength, 10);
        const reader = response.body.getReader();
        const chunks = [];
        let receivedLength = 0;
        
        while(true) {
            const {done, value} = await reader.read();
            
            if (done) break;
            
            chunks.push(value);
            receivedLength += value.length;
            
            const percentage = Math.round((receivedLength / total) * 100);
            progressFill.style.width = percentage + '%';
            progressText.textContent = percentage + '%';
        }
        
        // Create blob and trigger download
        const blob = new Blob(chunks);
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        setTimeout(() => {
            window.URL.revokeObjectURL(downloadUrl);
            document.body.removeChild(a);
            progressContainer.style.display = 'none';
            progressFill.style.width = '0%';
            progressText.textContent = '0%';
        }, 2000);
        
    } catch (error) {
        console.error('Download error:', error);
        // Fallback to direct download on error
        window.location.href = url;
        progressContainer.style.display = 'none';
    }
}

async function deleteNote(noteId) {
    if (confirm('üóëÔ∏è Are you sure you want to delete this note? This action cannot be undone.')) {
        try {
            const response = await fetch('/course/{{ course.id }}/ai_notes/' + noteId + '/delete', {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('‚úÖ Note deleted successfully!');
                location.reload();
            } else {
                alert('‚ùå Error: ' + (result.error || 'Failed to delete note'));
            }
        } catch (error) {
            alert('‚ùå Error deleting note: ' + error);
        }
    }
}

function viewPDF(pdfPath, title) {
    // Create modal for PDF viewer
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
    `;
    
    const container = document.createElement('div');
    container.style.cssText = `
        width: 95%;
        height: 95%;
        background: white;
        border-radius: 15px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        overflow: hidden;
    `;
    
    const header = document.createElement('div');
    header.style.cssText = `
        background: linear-gradient(135deg, #0A84FF, #00d4ff);
        color: white;
        padding: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        font-size: 1.2rem;
    `;
    header.innerHTML = `
        <span>üìÑ ${title}</span>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <a href="${pdfPath}" download style="background: rgba(255,255,255,0.2); border: none; color: white; cursor: pointer; font-size: 1rem; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-weight: 600;">‚¨áÔ∏è Download</a>
            <button onclick="this.closest('[data-pdf-modal]').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; cursor: pointer; font-size: 1.5rem; width: 40px; height: 40px; border-radius: 50%;">‚úï</button>
        </div>
    `;
    
    const viewer = document.createElement('div');
    viewer.style.cssText = `
        flex: 1;
        border: none;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        background: #f0f0f0;
    `;
    
    // Try to embed PDF using object tag (more reliable than iframe)
    viewer.innerHTML = `
        <object data="${pdfPath}" type="application/pdf" style="flex: 1; width: 100%; height: 100%; border: none;">
            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; text-align: center;">
                <p style="font-size: 1.2rem; color: #333; margin-bottom: 1rem;">üìÑ PDF Preview</p>
                <p style="color: #666; margin-bottom: 2rem;">Unable to preview PDF in browser</p>
                <a href="${pdfPath}" download style="background: linear-gradient(135deg, #0A84FF, #00d4ff); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600; border: none; cursor: pointer;">
                    ‚¨áÔ∏è Download PDF Instead
                </a>
            </div>
        </object>
    `;
    
    container.appendChild(header);
    container.appendChild(viewer);
    modal.appendChild(container);
    modal.setAttribute('data-pdf-modal', 'true');
    
    // Close on background click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
    
    // Close on Escape key
    const closeModal = function(e) {
        if (e.key === 'Escape') {
            const pdfModal = document.querySelector('[data-pdf-modal]');
            if (pdfModal) pdfModal.remove();
        }
    };
    document.addEventListener('keydown', closeModal);
    
    document.body.appendChild(modal);
}
</script>
{% endblock %}
